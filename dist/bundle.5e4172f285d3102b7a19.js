(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}};t.d({},{o:()=>pv});var e={};t.r(e),t.d(e,{LY2:()=>Z,WMw:()=>f,Mig:()=>_c,m7l:()=>Bl,Xcj:()=>md,BbS:()=>Qc,SJI:()=>Jc,mTL:()=>Hc,_Li:()=>d,N$j:()=>Da,ZzF:()=>gi,DvJ:()=>gh,TlE:()=>Hs,u9r:()=>cn,ROQ:()=>lh,YT8:()=>tc,uWy:()=>ot,SUY:()=>qc,Ilk:()=>Ds,yxD:()=>Gl,A5E:()=>Pd,Ox3:()=>Tc,ehD:()=>u,TOt:()=>bh,dSO:()=>tt,USm:()=>Yi,pBf:()=>Je,hH6:()=>Nl,a$l:()=>Zs,VzW:()=>wt,Wl3:()=>c,ZAu:()=>Qr,cLu:()=>xt,QRU:()=>Dc,vpT:()=>ra,kB5:()=>ha,_C8:()=>xl,Syv:()=>Ee,NMF:()=>Le,z8B:()=>La,x12:()=>Ya,nls:()=>Va,blk:()=>Qa,ejS:()=>Ja,rnI:()=>Ie,wem:()=>ct,D1R:()=>ut,qyh:()=>dt,aNw:()=>zl,Zp0:()=>Pc,lLk:()=>Il,YKA:()=>_e,RsA:()=>i,F5T:()=>zs,M8C:()=>ei,yGw:()=>Hi,Kj0:()=>Cn,vBJ:()=>Os,YBo:()=>fl,xoR:()=>ul,EJi:()=>dl,Wid:()=>cl,IKL:()=>pl,OoA:()=>rt,TyD:()=>at,aH4:()=>lt,YLQ:()=>ht,bdR:()=>m,dUE:()=>Ll,Tme:()=>us,iKG:()=>Sc,cPb:()=>Nn,_12:()=>tl,cek:()=>bc,woe:()=>oh,UY4:()=>th,iUV:()=>ud,_fP:()=>ui,iLg:()=>Al,KC9:()=>Oe,aoB:()=>Pt,UCm:()=>Et,rpg:()=>nt,xsS:()=>oa,OdW:()=>za,TUv:()=>Ra,aLr:()=>Bi,xo$:()=>nl,$V:()=>bd,PMe:()=>wc,jyi:()=>Ma,xeV:()=>la,QmN:()=>s,IOt:()=>je,dpR:()=>jl,z$h:()=>De,UlW:()=>Re,WXh:()=>rl,ywz:()=>pt,FM8:()=>ii,Pa4:()=>pi,yC1:()=>kl,CP7:()=>sa,Uk6:()=>al,knz:()=>Fe});const i={LEFT:0,MIDDLE:1,RIGHT:2,ROTATE:0,DOLLY:1,PAN:2},s={ROTATE:0,PAN:1,DOLLY_PAN:2,DOLLY_ROTATE:3},n=0,o=1,r=2,a=1,h=2,l=3,c=0,d=1,u=2,p=0,m=1,f=2,g=3,y=4,v=5,w=100,x=101,b=102,S=103,M=104,T=200,_=201,E=202,L=203,C=204,A=205,P=206,k=207,B=208,R=209,D=210,I=0,F=1,z=2,O=3,N=4,W=5,H=6,U=7,V=0,G=1,j=2,q=0,$=1,X=2,Y=3,Z=4,K=5,J=301,Q=302,tt=303,et=304,it=306,st=307,nt=1e3,ot=1001,rt=1002,at=1003,ht=1004,lt=1005,ct=1006,dt=1007,ut=1008,pt=1009,mt=1010,ft=1011,gt=1012,yt=1013,vt=1014,wt=1015,xt=1016,bt=1017,St=1018,Mt=1019,Tt=1020,_t=1021,Et=1022,Lt=1023,Ct=1024,At=1025,Pt=Lt,kt=1026,Bt=1027,Rt=1028,Dt=1029,It=1030,Ft=1031,zt=1032,Ot=1033,Nt=33776,Wt=33777,Ht=33778,Ut=33779,Vt=35840,Gt=35841,jt=35842,qt=35843,$t=36196,Xt=37492,Yt=37496,Zt=37808,Kt=37809,Jt=37810,Qt=37811,te=37812,ee=37813,ie=37814,se=37815,ne=37816,oe=37817,re=37818,ae=37819,he=37820,le=37821,ce=36492,de=37840,ue=37841,pe=37842,me=37843,fe=37844,ge=37845,ye=37846,ve=37847,we=37848,xe=37849,be=37850,Se=37851,Me=37852,Te=37853,_e=2201,Ee=2300,Le=2301,Ce=2302,Ae=2400,Pe=2401,ke=2402,Be=2500,Re=1,De=2,Ie=3e3,Fe=3001,ze=3007,Oe=3002,Ne=3003,We=3004,He=3005,Ue=3006,Ve=3200,Ge=3201,je=0,qe=1,$e=7680,Xe=519,Ye=35044,Ze=35048,Ke="300 es";function Je(){}Object.assign(Je.prototype,{addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});const i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)},hasEventListener:function(t,e){if(void 0===this._listeners)return!1;const i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)},removeEventListener:function(t,e){if(void 0===this._listeners)return;const i=this._listeners[t];if(void 0!==i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}},dispatchEvent:function(t){if(void 0===this._listeners)return;const e=this._listeners[t.type];if(void 0!==e){t.target=this;const i=e.slice(0);for(let e=0,s=i.length;e<s;e++)i[e].call(this,t)}}});const Qe=[];for(let t=0;t<256;t++)Qe[t]=(t<16?"0":"")+t.toString(16);let ti=1234567;const ei={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0;return(Qe[255&t]+Qe[t>>8&255]+Qe[t>>16&255]+Qe[t>>24&255]+"-"+Qe[255&e]+Qe[e>>8&255]+"-"+Qe[e>>16&15|64]+Qe[e>>24&255]+"-"+Qe[63&i|128]+Qe[i>>8&255]+"-"+Qe[i>>16&255]+Qe[i>>24&255]+Qe[255&s]+Qe[s>>8&255]+Qe[s>>16&255]+Qe[s>>24&255]).toUpperCase()},clamp:function(t,e,i){return Math.max(e,Math.min(i,t))},euclideanModulo:function(t,e){return(t%e+e)%e},mapLinear:function(t,e,i,s,n){return s+(t-e)*(n-s)/(i-e)},lerp:function(t,e,i){return(1-i)*t+i*e},smoothstep:function(t,e,i){return t<=e?0:t>=i?1:(t=(t-e)/(i-e))*t*(3-2*t)},smootherstep:function(t,e,i){return t<=e?0:t>=i?1:(t=(t-e)/(i-e))*t*t*(t*(6*t-15)+10)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},seededRandom:function(t){return void 0!==t&&(ti=t%2147483647),ti=16807*ti%2147483647,(ti-1)/2147483646},degToRad:function(t){return t*ei.DEG2RAD},radToDeg:function(t){return t*ei.RAD2DEG},isPowerOfTwo:function(t){return 0==(t&t-1)&&0!==t},ceilPowerOfTwo:function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))},floorPowerOfTwo:function(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))},setQuaternionFromProperEuler:function(t,e,i,s,n){const o=Math.cos,r=Math.sin,a=o(i/2),h=r(i/2),l=o((e+s)/2),c=r((e+s)/2),d=o((e-s)/2),u=r((e-s)/2),p=o((s-e)/2),m=r((s-e)/2);switch(n){case"XYX":t.set(a*c,h*d,h*u,a*l);break;case"YZY":t.set(h*u,a*c,h*d,a*l);break;case"ZXZ":t.set(h*d,h*u,a*c,a*l);break;case"XZX":t.set(a*c,h*m,h*p,a*l);break;case"YXY":t.set(h*p,a*c,h*m,a*l);break;case"ZYZ":t.set(h*m,h*p,a*c,a*l);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+n)}}};class ii{constructor(t=0,e=0){Object.defineProperty(this,"isVector2",{value:!0}),this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this)}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this)}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,i=this.y,s=t.elements;return this.x=s[0]*e+s[3]*i+s[6],this.y=s[1]*e+s[4]*i+s[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y;return e*e+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e,i){return void 0!==i&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const i=Math.cos(e),s=Math.sin(e),n=this.x-t.x,o=this.y-t.y;return this.x=n*i-o*s+t.x,this.y=n*s+o*i+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}}class si{constructor(){Object.defineProperty(this,"isMatrix3",{value:!0}),this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}set(t,e,i,s,n,o,r,a,h){const l=this.elements;return l[0]=t,l[1]=s,l[2]=r,l[3]=e,l[4]=n,l[5]=a,l[6]=i,l[7]=o,l[8]=h,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}clone(){return(new this.constructor).fromArray(this.elements)}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],this}extractBasis(t,e,i){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,s=e.elements,n=this.elements,o=i[0],r=i[3],a=i[6],h=i[1],l=i[4],c=i[7],d=i[2],u=i[5],p=i[8],m=s[0],f=s[3],g=s[6],y=s[1],v=s[4],w=s[7],x=s[2],b=s[5],S=s[8];return n[0]=o*m+r*y+a*x,n[3]=o*f+r*v+a*b,n[6]=o*g+r*w+a*S,n[1]=h*m+l*y+c*x,n[4]=h*f+l*v+c*b,n[7]=h*g+l*w+c*S,n[2]=d*m+u*y+p*x,n[5]=d*f+u*v+p*b,n[8]=d*g+u*w+p*S,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[1],s=t[2],n=t[3],o=t[4],r=t[5],a=t[6],h=t[7],l=t[8];return e*o*l-e*r*h-i*n*l+i*r*a+s*n*h-s*o*a}invert(){const t=this.elements,e=t[0],i=t[1],s=t[2],n=t[3],o=t[4],r=t[5],a=t[6],h=t[7],l=t[8],c=l*o-r*h,d=r*a-l*n,u=h*n-o*a,p=e*c+i*d+s*u;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const m=1/p;return t[0]=c*m,t[1]=(s*h-l*i)*m,t[2]=(r*i-s*o)*m,t[3]=d*m,t[4]=(l*e-s*a)*m,t[5]=(s*n-r*e)*m,t[6]=u*m,t[7]=(i*a-h*e)*m,t[8]=(o*e-i*n)*m,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).copy(this).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,i,s,n,o,r){const a=Math.cos(n),h=Math.sin(n);return this.set(i*a,i*h,-i*(a*o+h*r)+o+t,-s*h,s*a,-s*(-h*o+a*r)+r+e,0,0,1),this}scale(t,e){const i=this.elements;return i[0]*=t,i[3]*=t,i[6]*=t,i[1]*=e,i[4]*=e,i[7]*=e,this}rotate(t){const e=Math.cos(t),i=Math.sin(t),s=this.elements,n=s[0],o=s[3],r=s[6],a=s[1],h=s[4],l=s[7];return s[0]=e*n+i*a,s[3]=e*o+i*h,s[6]=e*r+i*l,s[1]=-i*n+e*a,s[4]=-i*o+e*h,s[7]=-i*r+e*l,this}translate(t,e){const i=this.elements;return i[0]+=t*i[2],i[3]+=t*i[5],i[6]+=t*i[8],i[1]+=e*i[2],i[4]+=e*i[5],i[7]+=e*i[8],this}equals(t){const e=this.elements,i=t.elements;for(let t=0;t<9;t++)if(e[t]!==i[t])return!1;return!0}fromArray(t,e=0){for(let i=0;i<9;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t}}let ni;const oi={getDataURL:function(t){if(/^data:/i.test(t.src))return t.src;if("undefined"==typeof HTMLCanvasElement)return t.src;let e;if(t instanceof HTMLCanvasElement)e=t;else{void 0===ni&&(ni=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")),ni.width=t.width,ni.height=t.height;const i=ni.getContext("2d");t instanceof ImageData?i.putImageData(t,0,0):i.drawImage(t,0,0,t.width,t.height),e=ni}return e.width>2048||e.height>2048?e.toDataURL("image/jpeg",.6):e.toDataURL("image/png")}};let ri=0;function ai(t=ai.DEFAULT_IMAGE,e=ai.DEFAULT_MAPPING,i=ot,s=ot,n=ct,o=ut,r=Lt,a=pt,h=1,l=Ie){Object.defineProperty(this,"id",{value:ri++}),this.uuid=ei.generateUUID(),this.name="",this.image=t,this.mipmaps=[],this.mapping=e,this.wrapS=i,this.wrapT=s,this.magFilter=n,this.minFilter=o,this.anisotropy=h,this.format=r,this.internalFormat=null,this.type=a,this.offset=new ii(0,0),this.repeat=new ii(1,1),this.center=new ii(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new si,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=l,this.version=0,this.onUpdate=null}function hi(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?oi.getDataURL(t):t.data?{data:Array.prototype.slice.call(t.data),width:t.width,height:t.height,type:t.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}ai.DEFAULT_IMAGE=void 0,ai.DEFAULT_MAPPING=300,ai.prototype=Object.assign(Object.create(Je.prototype),{constructor:ai,isTexture:!0,updateMatrix:function(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.name=t.name,this.image=t.image,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.encoding=t.encoding,this},toJSON:function(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.textures[this.uuid])return t.textures[this.uuid];const i={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,type:this.type,encoding:this.encoding,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};if(void 0!==this.image){const s=this.image;if(void 0===s.uuid&&(s.uuid=ei.generateUUID()),!e&&void 0===t.images[s.uuid]){let e;if(Array.isArray(s)){e=[];for(let t=0,i=s.length;t<i;t++)s[t].isDataTexture?e.push(hi(s[t].image)):e.push(hi(s[t]))}else e=hi(s);t.images[s.uuid]={uuid:s.uuid,url:e}}i.image=s.uuid}return e||(t.textures[this.uuid]=i),i},dispose:function(){this.dispatchEvent({type:"dispose"})},transformUv:function(t){if(300!==this.mapping)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case nt:t.x=t.x-Math.floor(t.x);break;case ot:t.x=t.x<0?0:1;break;case rt:1===Math.abs(Math.floor(t.x)%2)?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x)}if(t.y<0||t.y>1)switch(this.wrapT){case nt:t.y=t.y-Math.floor(t.y);break;case ot:t.y=t.y<0?0:1;break;case rt:1===Math.abs(Math.floor(t.y)%2)?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y)}return this.flipY&&(t.y=1-t.y),t}}),Object.defineProperty(ai.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}});class li{constructor(t=0,e=0,i=0,s=1){Object.defineProperty(this,"isVector4",{value:!0}),this.x=t,this.y=e,this.z=i,this.w=s}get width(){return this.z}set width(t){this.z=t}get height(){return this.w}set height(t){this.w=t}set(t,e,i,s){return this.x=t,this.y=e,this.z=i,this.w=s,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this)}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this)}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){const e=this.x,i=this.y,s=this.z,n=this.w,o=t.elements;return this.x=o[0]*e+o[4]*i+o[8]*s+o[12]*n,this.y=o[1]*e+o[5]*i+o[9]*s+o[13]*n,this.z=o[2]*e+o[6]*i+o[10]*s+o[14]*n,this.w=o[3]*e+o[7]*i+o[11]*s+o[15]*n,this}divideScalar(t){return this.multiplyScalar(1/t)}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);const e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}setAxisAngleFromRotationMatrix(t){let e,i,s,n;const o=.01,r=.1,a=t.elements,h=a[0],l=a[4],c=a[8],d=a[1],u=a[5],p=a[9],m=a[2],f=a[6],g=a[10];if(Math.abs(l-d)<o&&Math.abs(c-m)<o&&Math.abs(p-f)<o){if(Math.abs(l+d)<r&&Math.abs(c+m)<r&&Math.abs(p+f)<r&&Math.abs(h+u+g-3)<r)return this.set(1,0,0,0),this;e=Math.PI;const t=(h+1)/2,a=(u+1)/2,y=(g+1)/2,v=(l+d)/4,w=(c+m)/4,x=(p+f)/4;return t>a&&t>y?t<o?(i=0,s=.707106781,n=.707106781):(i=Math.sqrt(t),s=v/i,n=w/i):a>y?a<o?(i=.707106781,s=0,n=.707106781):(s=Math.sqrt(a),i=v/s,n=x/s):y<o?(i=.707106781,s=.707106781,n=0):(n=Math.sqrt(y),i=w/n,s=x/n),this.set(i,s,n,e),this}let y=Math.sqrt((f-p)*(f-p)+(c-m)*(c-m)+(d-l)*(d-l));return Math.abs(y)<.001&&(y=1),this.x=(f-p)/y,this.y=(c-m)/y,this.z=(d-l)/y,this.w=Math.acos((h+u+g-1)/2),this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this.w=Math.max(t.w,Math.min(e.w,this.w)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this.w=Math.max(t,Math.min(e,this.w)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this.w=t.w+(e.w-t.w)*i,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}fromBufferAttribute(t,e,i){return void 0!==i&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}}function ci(t,e,i){this.width=t,this.height=e,this.scissor=new li(0,0,t,e),this.scissorTest=!1,this.viewport=new li(0,0,t,e),i=i||{},this.texture=new ai(void 0,i.mapping,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.encoding),this.texture.image={},this.texture.image.width=t,this.texture.image.height=e,this.texture.generateMipmaps=void 0!==i.generateMipmaps&&i.generateMipmaps,this.texture.minFilter=void 0!==i.minFilter?i.minFilter:ct,this.depthBuffer=void 0===i.depthBuffer||i.depthBuffer,this.stencilBuffer=void 0!==i.stencilBuffer&&i.stencilBuffer,this.depthTexture=void 0!==i.depthTexture?i.depthTexture:null}function di(t,e,i){ci.call(this,t,e,i),this.samples=4}ci.prototype=Object.assign(Object.create(Je.prototype),{constructor:ci,isWebGLRenderTarget:!0,setSize:function(t,e){this.width===t&&this.height===e||(this.width=t,this.height=e,this.texture.image.width=t,this.texture.image.height=e,this.dispose()),this.viewport.set(0,0,t,e),this.scissor.set(0,0,t,e)},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.width=t.width,this.height=t.height,this.viewport.copy(t.viewport),this.texture=t.texture.clone(),this.depthBuffer=t.depthBuffer,this.stencilBuffer=t.stencilBuffer,this.depthTexture=t.depthTexture,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),di.prototype=Object.assign(Object.create(ci.prototype),{constructor:di,isWebGLMultisampleRenderTarget:!0,copy:function(t){return ci.prototype.copy.call(this,t),this.samples=t.samples,this}});class ui{constructor(t=0,e=0,i=0,s=1){Object.defineProperty(this,"isQuaternion",{value:!0}),this._x=t,this._y=e,this._z=i,this._w=s}static slerp(t,e,i,s){return i.copy(t).slerp(e,s)}static slerpFlat(t,e,i,s,n,o,r){let a=i[s+0],h=i[s+1],l=i[s+2],c=i[s+3];const d=n[o+0],u=n[o+1],p=n[o+2],m=n[o+3];if(c!==m||a!==d||h!==u||l!==p){let t=1-r;const e=a*d+h*u+l*p+c*m,i=e>=0?1:-1,s=1-e*e;if(s>Number.EPSILON){const n=Math.sqrt(s),o=Math.atan2(n,e*i);t=Math.sin(t*o)/n,r=Math.sin(r*o)/n}const n=r*i;if(a=a*t+d*n,h=h*t+u*n,l=l*t+p*n,c=c*t+m*n,t===1-r){const t=1/Math.sqrt(a*a+h*h+l*l+c*c);a*=t,h*=t,l*=t,c*=t}}t[e]=a,t[e+1]=h,t[e+2]=l,t[e+3]=c}static multiplyQuaternionsFlat(t,e,i,s,n,o){const r=i[s],a=i[s+1],h=i[s+2],l=i[s+3],c=n[o],d=n[o+1],u=n[o+2],p=n[o+3];return t[e]=r*p+l*c+a*u-h*d,t[e+1]=a*p+l*d+h*c-r*u,t[e+2]=h*p+l*u+r*d-a*c,t[e+3]=l*p-r*c-a*d-h*u,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,i,s){return this._x=t,this._y=e,this._z=i,this._w=s,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e){if(!t||!t.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");const i=t._x,s=t._y,n=t._z,o=t._order,r=Math.cos,a=Math.sin,h=r(i/2),l=r(s/2),c=r(n/2),d=a(i/2),u=a(s/2),p=a(n/2);switch(o){case"XYZ":this._x=d*l*c+h*u*p,this._y=h*u*c-d*l*p,this._z=h*l*p+d*u*c,this._w=h*l*c-d*u*p;break;case"YXZ":this._x=d*l*c+h*u*p,this._y=h*u*c-d*l*p,this._z=h*l*p-d*u*c,this._w=h*l*c+d*u*p;break;case"ZXY":this._x=d*l*c-h*u*p,this._y=h*u*c+d*l*p,this._z=h*l*p+d*u*c,this._w=h*l*c-d*u*p;break;case"ZYX":this._x=d*l*c-h*u*p,this._y=h*u*c+d*l*p,this._z=h*l*p-d*u*c,this._w=h*l*c+d*u*p;break;case"YZX":this._x=d*l*c+h*u*p,this._y=h*u*c+d*l*p,this._z=h*l*p-d*u*c,this._w=h*l*c-d*u*p;break;case"XZY":this._x=d*l*c-h*u*p,this._y=h*u*c-d*l*p,this._z=h*l*p+d*u*c,this._w=h*l*c+d*u*p;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+o)}return!1!==e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const i=e/2,s=Math.sin(i);return this._x=t.x*s,this._y=t.y*s,this._z=t.z*s,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,i=e[0],s=e[4],n=e[8],o=e[1],r=e[5],a=e[9],h=e[2],l=e[6],c=e[10],d=i+r+c;if(d>0){const t=.5/Math.sqrt(d+1);this._w=.25/t,this._x=(l-a)*t,this._y=(n-h)*t,this._z=(o-s)*t}else if(i>r&&i>c){const t=2*Math.sqrt(1+i-r-c);this._w=(l-a)/t,this._x=.25*t,this._y=(s+o)/t,this._z=(n+h)/t}else if(r>c){const t=2*Math.sqrt(1+r-i-c);this._w=(n-h)/t,this._x=(s+o)/t,this._y=.25*t,this._z=(a+l)/t}else{const t=2*Math.sqrt(1+c-i-r);this._w=(o-s)/t,this._x=(n+h)/t,this._y=(a+l)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let i=t.dot(e)+1;return i<1e-6?(i=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=i):(this._x=0,this._y=-t.z,this._z=t.y,this._w=i)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=i),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(ei.clamp(this.dot(t),-1,1)))}rotateTowards(t,e){const i=this.angleTo(t);if(0===i)return this;const s=Math.min(1,e/i);return this.slerp(t,s),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t,e){return void 0!==e?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(t,e)):this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const i=t._x,s=t._y,n=t._z,o=t._w,r=e._x,a=e._y,h=e._z,l=e._w;return this._x=i*l+o*r+s*h-n*a,this._y=s*l+o*a+n*r-i*h,this._z=n*l+o*h+i*a-s*r,this._w=o*l-i*r-s*a-n*h,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const i=this._x,s=this._y,n=this._z,o=this._w;let r=o*t._w+i*t._x+s*t._y+n*t._z;if(r<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,r=-r):this.copy(t),r>=1)return this._w=o,this._x=i,this._y=s,this._z=n,this;const a=1-r*r;if(a<=Number.EPSILON){const t=1-e;return this._w=t*o+e*this._w,this._x=t*i+e*this._x,this._y=t*s+e*this._y,this._z=t*n+e*this._z,this.normalize(),this._onChangeCallback(),this}const h=Math.sqrt(a),l=Math.atan2(h,r),c=Math.sin((1-e)*l)/h,d=Math.sin(e*l)/h;return this._w=o*c+this._w*d,this._x=i*c+this._x*d,this._y=s*c+this._y*d,this._z=n*c+this._z*d,this._onChangeCallback(),this}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}}class pi{constructor(t=0,e=0,i=0){Object.defineProperty(this,"isVector3",{value:!0}),this.x=t,this.y=e,this.z=i}set(t,e,i){return void 0===i&&(i=this.z),this.x=t,this.y=e,this.z=i,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t,e){return void 0!==e?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(t,e)):(this.x*=t.x,this.y*=t.y,this.z*=t.z,this)}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return t&&t.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(fi.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(fi.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,i=this.y,s=this.z,n=t.elements;return this.x=n[0]*e+n[3]*i+n[6]*s,this.y=n[1]*e+n[4]*i+n[7]*s,this.z=n[2]*e+n[5]*i+n[8]*s,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,i=this.y,s=this.z,n=t.elements,o=1/(n[3]*e+n[7]*i+n[11]*s+n[15]);return this.x=(n[0]*e+n[4]*i+n[8]*s+n[12])*o,this.y=(n[1]*e+n[5]*i+n[9]*s+n[13])*o,this.z=(n[2]*e+n[6]*i+n[10]*s+n[14])*o,this}applyQuaternion(t){const e=this.x,i=this.y,s=this.z,n=t.x,o=t.y,r=t.z,a=t.w,h=a*e+o*s-r*i,l=a*i+r*e-n*s,c=a*s+n*i-o*e,d=-n*e-o*i-r*s;return this.x=h*a+d*-n+l*-r-c*-o,this.y=l*a+d*-o+c*-n-h*-r,this.z=c*a+d*-r+h*-o-l*-n,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,i=this.y,s=this.z,n=t.elements;return this.x=n[0]*e+n[4]*i+n[8]*s,this.y=n[1]*e+n[5]*i+n[9]*s,this.z=n[2]*e+n[6]*i+n[10]*s,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this}cross(t,e){return void 0!==e?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(t,e)):this.crossVectors(this,t)}crossVectors(t,e){const i=t.x,s=t.y,n=t.z,o=e.x,r=e.y,a=e.z;return this.x=s*a-n*r,this.y=n*o-i*a,this.z=i*r-s*o,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const i=t.dot(this)/e;return this.copy(t).multiplyScalar(i)}projectOnPlane(t){return mi.copy(this).projectOnVector(t),this.sub(mi)}reflect(t){return this.sub(mi.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const i=this.dot(t)/e;return Math.acos(ei.clamp(i,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y,s=this.z-t.z;return e*e+i*i+s*s}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,i){const s=Math.sin(e)*t;return this.x=s*Math.sin(i),this.y=Math.cos(e)*t,this.z=s*Math.cos(i),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,i){return this.x=t*Math.sin(e),this.y=i,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),i=this.setFromMatrixColumn(t,1).length(),s=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=i,this.z=s,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e,i){return void 0!==i&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}}const mi=new pi,fi=new ui;class gi{constructor(t,e){Object.defineProperty(this,"isBox3",{value:!0}),this.min=void 0!==t?t:new pi(1/0,1/0,1/0),this.max=void 0!==e?e:new pi(-1/0,-1/0,-1/0)}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){let e=1/0,i=1/0,s=1/0,n=-1/0,o=-1/0,r=-1/0;for(let a=0,h=t.length;a<h;a+=3){const h=t[a],l=t[a+1],c=t[a+2];h<e&&(e=h),l<i&&(i=l),c<s&&(s=c),h>n&&(n=h),l>o&&(o=l),c>r&&(r=c)}return this.min.set(e,i,s),this.max.set(n,o,r),this}setFromBufferAttribute(t){let e=1/0,i=1/0,s=1/0,n=-1/0,o=-1/0,r=-1/0;for(let a=0,h=t.count;a<h;a++){const h=t.getX(a),l=t.getY(a),c=t.getZ(a);h<e&&(e=h),l<i&&(i=l),c<s&&(s=c),h>n&&(n=h),l>o&&(o=l),c>r&&(r=c)}return this.min.set(e,i,s),this.max.set(n,o,r),this}setFromPoints(t){this.makeEmpty();for(let e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const i=wi.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}setFromObject(t){return this.makeEmpty(),this.expandByObject(t)}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return void 0===t&&(console.warn("THREE.Box3: .getCenter() target is now required"),t=new pi),this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return void 0===t&&(console.warn("THREE.Box3: .getSize() target is now required"),t=new pi),this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t){t.updateWorldMatrix(!1,!1);const e=t.geometry;void 0!==e&&(null===e.boundingBox&&e.computeBoundingBox(),xi.copy(e.boundingBox),xi.applyMatrix4(t.matrixWorld),this.union(xi));const i=t.children;for(let t=0,e=i.length;t<e;t++)this.expandByObject(i[t]);return this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y||t.z<this.min.z||t.z>this.max.z)}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return void 0===e&&(console.warn("THREE.Box3: .getParameter() target is now required"),e=new pi),e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}intersectsSphere(t){return this.clampPoint(t.center,wi),wi.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,i;return t.normal.x>0?(e=t.normal.x*this.min.x,i=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,i=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,i+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,i+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,i+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,i+=t.normal.z*this.min.z),e<=-t.constant&&i>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(Li),Ci.subVectors(this.max,Li),bi.subVectors(t.a,Li),Si.subVectors(t.b,Li),Mi.subVectors(t.c,Li),Ti.subVectors(Si,bi),_i.subVectors(Mi,Si),Ei.subVectors(bi,Mi);let e=[0,-Ti.z,Ti.y,0,-_i.z,_i.y,0,-Ei.z,Ei.y,Ti.z,0,-Ti.x,_i.z,0,-_i.x,Ei.z,0,-Ei.x,-Ti.y,Ti.x,0,-_i.y,_i.x,0,-Ei.y,Ei.x,0];return!!yi(e,bi,Si,Mi,Ci)&&(e=[1,0,0,0,1,0,0,0,1],!!yi(e,bi,Si,Mi,Ci)&&(Ai.crossVectors(Ti,_i),e=[Ai.x,Ai.y,Ai.z],yi(e,bi,Si,Mi,Ci)))}clampPoint(t,e){return void 0===e&&(console.warn("THREE.Box3: .clampPoint() target is now required"),e=new pi),e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return wi.copy(t).clamp(this.min,this.max).sub(t).length()}getBoundingSphere(t){return void 0===t&&console.error("THREE.Box3: .getBoundingSphere() target is now required"),this.getCenter(t.center),t.radius=.5*this.getSize(wi).length(),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()||(vi[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),vi[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),vi[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),vi[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),vi[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),vi[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),vi[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),vi[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(vi)),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}function yi(t,e,i,s,n){for(let o=0,r=t.length-3;o<=r;o+=3){Pi.fromArray(t,o);const r=n.x*Math.abs(Pi.x)+n.y*Math.abs(Pi.y)+n.z*Math.abs(Pi.z),a=e.dot(Pi),h=i.dot(Pi),l=s.dot(Pi);if(Math.max(-Math.max(a,h,l),Math.min(a,h,l))>r)return!1}return!0}const vi=[new pi,new pi,new pi,new pi,new pi,new pi,new pi,new pi],wi=new pi,xi=new gi,bi=new pi,Si=new pi,Mi=new pi,Ti=new pi,_i=new pi,Ei=new pi,Li=new pi,Ci=new pi,Ai=new pi,Pi=new pi,ki=new gi;class Bi{constructor(t,e){this.center=void 0!==t?t:new pi,this.radius=void 0!==e?e:-1}set(t,e){return this.center.copy(t),this.radius=e,this}setFromPoints(t,e){const i=this.center;void 0!==e?i.copy(e):ki.setFromPoints(t).getCenter(i);let s=0;for(let e=0,n=t.length;e<n;e++)s=Math.max(s,i.distanceToSquared(t[e]));return this.radius=Math.sqrt(s),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}intersectsBox(t){return t.intersectsSphere(this)}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}clampPoint(t,e){const i=this.center.distanceToSquared(t);return void 0===e&&(console.warn("THREE.Sphere: .clampPoint() target is now required"),e=new pi),e.copy(t),i>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}getBoundingBox(t){return void 0===t&&(console.warn("THREE.Sphere: .getBoundingBox() target is now required"),t=new gi),this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}}const Ri=new pi,Di=new pi,Ii=new pi,Fi=new pi,zi=new pi,Oi=new pi,Ni=new pi;class Wi{constructor(t,e){this.origin=void 0!==t?t:new pi,this.direction=void 0!==e?e:new pi(0,0,-1)}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this}at(t,e){return void 0===e&&(console.warn("THREE.Ray: .at() target is now required"),e=new pi),e.copy(this.direction).multiplyScalar(t).add(this.origin)}lookAt(t){return this.direction.copy(t).sub(this.origin).normalize(),this}recast(t){return this.origin.copy(this.at(t,Ri)),this}closestPointToPoint(t,e){void 0===e&&(console.warn("THREE.Ray: .closestPointToPoint() target is now required"),e=new pi),e.subVectors(t,this.origin);const i=e.dot(this.direction);return i<0?e.copy(this.origin):e.copy(this.direction).multiplyScalar(i).add(this.origin)}distanceToPoint(t){return Math.sqrt(this.distanceSqToPoint(t))}distanceSqToPoint(t){const e=Ri.subVectors(t,this.origin).dot(this.direction);return e<0?this.origin.distanceToSquared(t):(Ri.copy(this.direction).multiplyScalar(e).add(this.origin),Ri.distanceToSquared(t))}distanceSqToSegment(t,e,i,s){Di.copy(t).add(e).multiplyScalar(.5),Ii.copy(e).sub(t).normalize(),Fi.copy(this.origin).sub(Di);const n=.5*t.distanceTo(e),o=-this.direction.dot(Ii),r=Fi.dot(this.direction),a=-Fi.dot(Ii),h=Fi.lengthSq(),l=Math.abs(1-o*o);let c,d,u,p;if(l>0)if(c=o*a-r,d=o*r-a,p=n*l,c>=0)if(d>=-p)if(d<=p){const t=1/l;c*=t,d*=t,u=c*(c+o*d+2*r)+d*(o*c+d+2*a)+h}else d=n,c=Math.max(0,-(o*d+r)),u=-c*c+d*(d+2*a)+h;else d=-n,c=Math.max(0,-(o*d+r)),u=-c*c+d*(d+2*a)+h;else d<=-p?(c=Math.max(0,-(-o*n+r)),d=c>0?-n:Math.min(Math.max(-n,-a),n),u=-c*c+d*(d+2*a)+h):d<=p?(c=0,d=Math.min(Math.max(-n,-a),n),u=d*(d+2*a)+h):(c=Math.max(0,-(o*n+r)),d=c>0?n:Math.min(Math.max(-n,-a),n),u=-c*c+d*(d+2*a)+h);else d=o>0?-n:n,c=Math.max(0,-(o*d+r)),u=-c*c+d*(d+2*a)+h;return i&&i.copy(this.direction).multiplyScalar(c).add(this.origin),s&&s.copy(Ii).multiplyScalar(d).add(Di),u}intersectSphere(t,e){Ri.subVectors(t.center,this.origin);const i=Ri.dot(this.direction),s=Ri.dot(Ri)-i*i,n=t.radius*t.radius;if(s>n)return null;const o=Math.sqrt(n-s),r=i-o,a=i+o;return r<0&&a<0?null:r<0?this.at(a,e):this.at(r,e)}intersectsSphere(t){return this.distanceSqToPoint(t.center)<=t.radius*t.radius}distanceToPlane(t){const e=t.normal.dot(this.direction);if(0===e)return 0===t.distanceToPoint(this.origin)?0:null;const i=-(this.origin.dot(t.normal)+t.constant)/e;return i>=0?i:null}intersectPlane(t,e){const i=this.distanceToPlane(t);return null===i?null:this.at(i,e)}intersectsPlane(t){const e=t.distanceToPoint(this.origin);return 0===e||t.normal.dot(this.direction)*e<0}intersectBox(t,e){let i,s,n,o,r,a;const h=1/this.direction.x,l=1/this.direction.y,c=1/this.direction.z,d=this.origin;return h>=0?(i=(t.min.x-d.x)*h,s=(t.max.x-d.x)*h):(i=(t.max.x-d.x)*h,s=(t.min.x-d.x)*h),l>=0?(n=(t.min.y-d.y)*l,o=(t.max.y-d.y)*l):(n=(t.max.y-d.y)*l,o=(t.min.y-d.y)*l),i>o||n>s?null:((n>i||i!=i)&&(i=n),(o<s||s!=s)&&(s=o),c>=0?(r=(t.min.z-d.z)*c,a=(t.max.z-d.z)*c):(r=(t.max.z-d.z)*c,a=(t.min.z-d.z)*c),i>a||r>s?null:((r>i||i!=i)&&(i=r),(a<s||s!=s)&&(s=a),s<0?null:this.at(i>=0?i:s,e)))}intersectsBox(t){return null!==this.intersectBox(t,Ri)}intersectTriangle(t,e,i,s,n){zi.subVectors(e,t),Oi.subVectors(i,t),Ni.crossVectors(zi,Oi);let o,r=this.direction.dot(Ni);if(r>0){if(s)return null;o=1}else{if(!(r<0))return null;o=-1,r=-r}Fi.subVectors(this.origin,t);const a=o*this.direction.dot(Oi.crossVectors(Fi,Oi));if(a<0)return null;const h=o*this.direction.dot(zi.cross(Fi));if(h<0)return null;if(a+h>r)return null;const l=-o*Fi.dot(Ni);return l<0?null:this.at(l/r,n)}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}}class Hi{constructor(){Object.defineProperty(this,"isMatrix4",{value:!0}),this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}set(t,e,i,s,n,o,r,a,h,l,c,d,u,p,m,f){const g=this.elements;return g[0]=t,g[4]=e,g[8]=i,g[12]=s,g[1]=n,g[5]=o,g[9]=r,g[13]=a,g[2]=h,g[6]=l,g[10]=c,g[14]=d,g[3]=u,g[7]=p,g[11]=m,g[15]=f,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Hi).fromArray(this.elements)}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],this}copyPosition(t){const e=this.elements,i=t.elements;return e[12]=i[12],e[13]=i[13],e[14]=i[14],this}extractBasis(t,e,i){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(t,e,i){return this.set(t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,i=t.elements,s=1/Ui.setFromMatrixColumn(t,0).length(),n=1/Ui.setFromMatrixColumn(t,1).length(),o=1/Ui.setFromMatrixColumn(t,2).length();return e[0]=i[0]*s,e[1]=i[1]*s,e[2]=i[2]*s,e[3]=0,e[4]=i[4]*n,e[5]=i[5]*n,e[6]=i[6]*n,e[7]=0,e[8]=i[8]*o,e[9]=i[9]*o,e[10]=i[10]*o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){t&&t.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");const e=this.elements,i=t.x,s=t.y,n=t.z,o=Math.cos(i),r=Math.sin(i),a=Math.cos(s),h=Math.sin(s),l=Math.cos(n),c=Math.sin(n);if("XYZ"===t.order){const t=o*l,i=o*c,s=r*l,n=r*c;e[0]=a*l,e[4]=-a*c,e[8]=h,e[1]=i+s*h,e[5]=t-n*h,e[9]=-r*a,e[2]=n-t*h,e[6]=s+i*h,e[10]=o*a}else if("YXZ"===t.order){const t=a*l,i=a*c,s=h*l,n=h*c;e[0]=t+n*r,e[4]=s*r-i,e[8]=o*h,e[1]=o*c,e[5]=o*l,e[9]=-r,e[2]=i*r-s,e[6]=n+t*r,e[10]=o*a}else if("ZXY"===t.order){const t=a*l,i=a*c,s=h*l,n=h*c;e[0]=t-n*r,e[4]=-o*c,e[8]=s+i*r,e[1]=i+s*r,e[5]=o*l,e[9]=n-t*r,e[2]=-o*h,e[6]=r,e[10]=o*a}else if("ZYX"===t.order){const t=o*l,i=o*c,s=r*l,n=r*c;e[0]=a*l,e[4]=s*h-i,e[8]=t*h+n,e[1]=a*c,e[5]=n*h+t,e[9]=i*h-s,e[2]=-h,e[6]=r*a,e[10]=o*a}else if("YZX"===t.order){const t=o*a,i=o*h,s=r*a,n=r*h;e[0]=a*l,e[4]=n-t*c,e[8]=s*c+i,e[1]=c,e[5]=o*l,e[9]=-r*l,e[2]=-h*l,e[6]=i*c+s,e[10]=t-n*c}else if("XZY"===t.order){const t=o*a,i=o*h,s=r*a,n=r*h;e[0]=a*l,e[4]=-c,e[8]=h*l,e[1]=t*c+n,e[5]=o*l,e[9]=i*c-s,e[2]=s*c-i,e[6]=r*l,e[10]=n*c+t}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(Gi,t,ji)}lookAt(t,e,i){const s=this.elements;return Xi.subVectors(t,e),0===Xi.lengthSq()&&(Xi.z=1),Xi.normalize(),qi.crossVectors(i,Xi),0===qi.lengthSq()&&(1===Math.abs(i.z)?Xi.x+=1e-4:Xi.z+=1e-4,Xi.normalize(),qi.crossVectors(i,Xi)),qi.normalize(),$i.crossVectors(Xi,qi),s[0]=qi.x,s[4]=$i.x,s[8]=Xi.x,s[1]=qi.y,s[5]=$i.y,s[9]=Xi.y,s[2]=qi.z,s[6]=$i.z,s[10]=Xi.z,this}multiply(t,e){return void 0!==e?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(t,e)):this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,s=e.elements,n=this.elements,o=i[0],r=i[4],a=i[8],h=i[12],l=i[1],c=i[5],d=i[9],u=i[13],p=i[2],m=i[6],f=i[10],g=i[14],y=i[3],v=i[7],w=i[11],x=i[15],b=s[0],S=s[4],M=s[8],T=s[12],_=s[1],E=s[5],L=s[9],C=s[13],A=s[2],P=s[6],k=s[10],B=s[14],R=s[3],D=s[7],I=s[11],F=s[15];return n[0]=o*b+r*_+a*A+h*R,n[4]=o*S+r*E+a*P+h*D,n[8]=o*M+r*L+a*k+h*I,n[12]=o*T+r*C+a*B+h*F,n[1]=l*b+c*_+d*A+u*R,n[5]=l*S+c*E+d*P+u*D,n[9]=l*M+c*L+d*k+u*I,n[13]=l*T+c*C+d*B+u*F,n[2]=p*b+m*_+f*A+g*R,n[6]=p*S+m*E+f*P+g*D,n[10]=p*M+m*L+f*k+g*I,n[14]=p*T+m*C+f*B+g*F,n[3]=y*b+v*_+w*A+x*R,n[7]=y*S+v*E+w*P+x*D,n[11]=y*M+v*L+w*k+x*I,n[15]=y*T+v*C+w*B+x*F,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[4],s=t[8],n=t[12],o=t[1],r=t[5],a=t[9],h=t[13],l=t[2],c=t[6],d=t[10],u=t[14];return t[3]*(+n*a*c-s*h*c-n*r*d+i*h*d+s*r*u-i*a*u)+t[7]*(+e*a*u-e*h*d+n*o*d-s*o*u+s*h*l-n*a*l)+t[11]*(+e*h*c-e*r*u-n*o*c+i*o*u+n*r*l-i*h*l)+t[15]*(-s*r*l-e*a*c+e*r*d+s*o*c-i*o*d+i*a*l)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,i){const s=this.elements;return t.isVector3?(s[12]=t.x,s[13]=t.y,s[14]=t.z):(s[12]=t,s[13]=e,s[14]=i),this}invert(){const t=this.elements,e=t[0],i=t[1],s=t[2],n=t[3],o=t[4],r=t[5],a=t[6],h=t[7],l=t[8],c=t[9],d=t[10],u=t[11],p=t[12],m=t[13],f=t[14],g=t[15],y=c*f*h-m*d*h+m*a*u-r*f*u-c*a*g+r*d*g,v=p*d*h-l*f*h-p*a*u+o*f*u+l*a*g-o*d*g,w=l*m*h-p*c*h+p*r*u-o*m*u-l*r*g+o*c*g,x=p*c*a-l*m*a-p*r*d+o*m*d+l*r*f-o*c*f,b=e*y+i*v+s*w+n*x;if(0===b)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const S=1/b;return t[0]=y*S,t[1]=(m*d*n-c*f*n-m*s*u+i*f*u+c*s*g-i*d*g)*S,t[2]=(r*f*n-m*a*n+m*s*h-i*f*h-r*s*g+i*a*g)*S,t[3]=(c*a*n-r*d*n-c*s*h+i*d*h+r*s*u-i*a*u)*S,t[4]=v*S,t[5]=(l*f*n-p*d*n+p*s*u-e*f*u-l*s*g+e*d*g)*S,t[6]=(p*a*n-o*f*n-p*s*h+e*f*h+o*s*g-e*a*g)*S,t[7]=(o*d*n-l*a*n+l*s*h-e*d*h-o*s*u+e*a*u)*S,t[8]=w*S,t[9]=(p*c*n-l*m*n-p*i*u+e*m*u+l*i*g-e*c*g)*S,t[10]=(o*m*n-p*r*n+p*i*h-e*m*h-o*i*g+e*r*g)*S,t[11]=(l*r*n-o*c*n-l*i*h+e*c*h+o*i*u-e*r*u)*S,t[12]=x*S,t[13]=(l*m*s-p*c*s+p*i*d-e*m*d-l*i*f+e*c*f)*S,t[14]=(p*r*s-o*m*s-p*i*a+e*m*a+o*i*f-e*r*f)*S,t[15]=(o*c*s-l*r*s+l*i*a-e*c*a-o*i*d+e*r*d)*S,this}scale(t){const e=this.elements,i=t.x,s=t.y,n=t.z;return e[0]*=i,e[4]*=s,e[8]*=n,e[1]*=i,e[5]*=s,e[9]*=n,e[2]*=i,e[6]*=s,e[10]*=n,e[3]*=i,e[7]*=s,e[11]*=n,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],s=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,i,s))}makeTranslation(t,e,i){return this.set(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),i=Math.sin(t);return this.set(1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const i=Math.cos(e),s=Math.sin(e),n=1-i,o=t.x,r=t.y,a=t.z,h=n*o,l=n*r;return this.set(h*o+i,h*r-s*a,h*a+s*r,0,h*r+s*a,l*r+i,l*a-s*o,0,h*a-s*r,l*a+s*o,n*a*a+i,0,0,0,0,1),this}makeScale(t,e,i){return this.set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1),this}makeShear(t,e,i){return this.set(1,e,i,0,t,1,i,0,t,e,1,0,0,0,0,1),this}compose(t,e,i){const s=this.elements,n=e._x,o=e._y,r=e._z,a=e._w,h=n+n,l=o+o,c=r+r,d=n*h,u=n*l,p=n*c,m=o*l,f=o*c,g=r*c,y=a*h,v=a*l,w=a*c,x=i.x,b=i.y,S=i.z;return s[0]=(1-(m+g))*x,s[1]=(u+w)*x,s[2]=(p-v)*x,s[3]=0,s[4]=(u-w)*b,s[5]=(1-(d+g))*b,s[6]=(f+y)*b,s[7]=0,s[8]=(p+v)*S,s[9]=(f-y)*S,s[10]=(1-(d+m))*S,s[11]=0,s[12]=t.x,s[13]=t.y,s[14]=t.z,s[15]=1,this}decompose(t,e,i){const s=this.elements;let n=Ui.set(s[0],s[1],s[2]).length();const o=Ui.set(s[4],s[5],s[6]).length(),r=Ui.set(s[8],s[9],s[10]).length();this.determinant()<0&&(n=-n),t.x=s[12],t.y=s[13],t.z=s[14],Vi.copy(this);const a=1/n,h=1/o,l=1/r;return Vi.elements[0]*=a,Vi.elements[1]*=a,Vi.elements[2]*=a,Vi.elements[4]*=h,Vi.elements[5]*=h,Vi.elements[6]*=h,Vi.elements[8]*=l,Vi.elements[9]*=l,Vi.elements[10]*=l,e.setFromRotationMatrix(Vi),i.x=n,i.y=o,i.z=r,this}makePerspective(t,e,i,s,n,o){void 0===o&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");const r=this.elements,a=2*n/(e-t),h=2*n/(i-s),l=(e+t)/(e-t),c=(i+s)/(i-s),d=-(o+n)/(o-n),u=-2*o*n/(o-n);return r[0]=a,r[4]=0,r[8]=l,r[12]=0,r[1]=0,r[5]=h,r[9]=c,r[13]=0,r[2]=0,r[6]=0,r[10]=d,r[14]=u,r[3]=0,r[7]=0,r[11]=-1,r[15]=0,this}makeOrthographic(t,e,i,s,n,o){const r=this.elements,a=1/(e-t),h=1/(i-s),l=1/(o-n),c=(e+t)*a,d=(i+s)*h,u=(o+n)*l;return r[0]=2*a,r[4]=0,r[8]=0,r[12]=-c,r[1]=0,r[5]=2*h,r[9]=0,r[13]=-d,r[2]=0,r[6]=0,r[10]=-2*l,r[14]=-u,r[3]=0,r[7]=0,r[11]=0,r[15]=1,this}equals(t){const e=this.elements,i=t.elements;for(let t=0;t<16;t++)if(e[t]!==i[t])return!1;return!0}fromArray(t,e=0){for(let i=0;i<16;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t[e+9]=i[9],t[e+10]=i[10],t[e+11]=i[11],t[e+12]=i[12],t[e+13]=i[13],t[e+14]=i[14],t[e+15]=i[15],t}}const Ui=new pi,Vi=new Hi,Gi=new pi(0,0,0),ji=new pi(1,1,1),qi=new pi,$i=new pi,Xi=new pi;class Yi{constructor(t=0,e=0,i=0,s=Yi.DefaultOrder){Object.defineProperty(this,"isEuler",{value:!0}),this._x=t,this._y=e,this._z=i,this._order=s}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,i,s){return this._x=t,this._y=e,this._z=i,this._order=s||this._order,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e,i){const s=ei.clamp,n=t.elements,o=n[0],r=n[4],a=n[8],h=n[1],l=n[5],c=n[9],d=n[2],u=n[6],p=n[10];switch(e=e||this._order){case"XYZ":this._y=Math.asin(s(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-c,p),this._z=Math.atan2(-r,o)):(this._x=Math.atan2(u,l),this._z=0);break;case"YXZ":this._x=Math.asin(-s(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(a,p),this._z=Math.atan2(h,l)):(this._y=Math.atan2(-d,o),this._z=0);break;case"ZXY":this._x=Math.asin(s(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(-d,p),this._z=Math.atan2(-r,l)):(this._y=0,this._z=Math.atan2(h,o));break;case"ZYX":this._y=Math.asin(-s(d,-1,1)),Math.abs(d)<.9999999?(this._x=Math.atan2(u,p),this._z=Math.atan2(h,o)):(this._x=0,this._z=Math.atan2(-r,l));break;case"YZX":this._z=Math.asin(s(h,-1,1)),Math.abs(h)<.9999999?(this._x=Math.atan2(-c,l),this._y=Math.atan2(-d,o)):(this._x=0,this._y=Math.atan2(a,p));break;case"XZY":this._z=Math.asin(-s(r,-1,1)),Math.abs(r)<.9999999?(this._x=Math.atan2(u,l),this._y=Math.atan2(a,o)):(this._x=Math.atan2(-c,p),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this._order=e,!1!==i&&this._onChangeCallback(),this}setFromQuaternion(t,e,i){return Zi.makeRotationFromQuaternion(t),this.setFromRotationMatrix(Zi,e,i)}setFromVector3(t,e){return this.set(t.x,t.y,t.z,e||this._order)}reorder(t){return Ki.setFromEuler(this),this.setFromQuaternion(Ki,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}toVector3(t){return t?t.set(this._x,this._y,this._z):new pi(this._x,this._y,this._z)}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}}Yi.DefaultOrder="XYZ",Yi.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];const Zi=new Hi,Ki=new ui;class Ji{constructor(){this.mask=1}set(t){this.mask=1<<t|0}enable(t){this.mask|=1<<t|0}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t|0}disable(t){this.mask&=~(1<<t|0)}disableAll(){this.mask=0}test(t){return 0!=(this.mask&t.mask)}}let Qi=0;const ts=new pi,es=new ui,is=new Hi,ss=new pi,ns=new pi,os=new pi,rs=new ui,as=new pi(1,0,0),hs=new pi(0,1,0),ls=new pi(0,0,1),cs={type:"added"},ds={type:"removed"};function us(){Object.defineProperty(this,"id",{value:Qi++}),this.uuid=ei.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=us.DefaultUp.clone();const t=new pi,e=new Yi,i=new ui,s=new pi(1,1,1);e._onChange((function(){i.setFromEuler(e,!1)})),i._onChange((function(){e.setFromQuaternion(i,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:s},modelViewMatrix:{value:new Hi},normalMatrix:{value:new si}}),this.matrix=new Hi,this.matrixWorld=new Hi,this.matrixAutoUpdate=us.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new Ji,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}us.DefaultUp=new pi(0,1,0),us.DefaultMatrixAutoUpdate=!0,us.prototype=Object.assign(Object.create(Je.prototype),{constructor:us,isObject3D:!0,onBeforeRender:function(){},onAfterRender:function(){},applyMatrix4:function(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)},applyQuaternion:function(t){return this.quaternion.premultiply(t),this},setRotationFromAxisAngle:function(t,e){this.quaternion.setFromAxisAngle(t,e)},setRotationFromEuler:function(t){this.quaternion.setFromEuler(t,!0)},setRotationFromMatrix:function(t){this.quaternion.setFromRotationMatrix(t)},setRotationFromQuaternion:function(t){this.quaternion.copy(t)},rotateOnAxis:function(t,e){return es.setFromAxisAngle(t,e),this.quaternion.multiply(es),this},rotateOnWorldAxis:function(t,e){return es.setFromAxisAngle(t,e),this.quaternion.premultiply(es),this},rotateX:function(t){return this.rotateOnAxis(as,t)},rotateY:function(t){return this.rotateOnAxis(hs,t)},rotateZ:function(t){return this.rotateOnAxis(ls,t)},translateOnAxis:function(t,e){return ts.copy(t).applyQuaternion(this.quaternion),this.position.add(ts.multiplyScalar(e)),this},translateX:function(t){return this.translateOnAxis(as,t)},translateY:function(t){return this.translateOnAxis(hs,t)},translateZ:function(t){return this.translateOnAxis(ls,t)},localToWorld:function(t){return t.applyMatrix4(this.matrixWorld)},worldToLocal:function(t){return t.applyMatrix4(is.copy(this.matrixWorld).invert())},lookAt:function(t,e,i){t.isVector3?ss.copy(t):ss.set(t,e,i);const s=this.parent;this.updateWorldMatrix(!0,!1),ns.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?is.lookAt(ns,ss,this.up):is.lookAt(ss,ns,this.up),this.quaternion.setFromRotationMatrix(is),s&&(is.extractRotation(s.matrixWorld),es.setFromRotationMatrix(is),this.quaternion.premultiply(es.invert()))},add:function(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(null!==t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t),t.dispatchEvent(cs)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)},remove:function(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}const e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(ds)),this},clear:function(){for(let t=0;t<this.children.length;t++){const e=this.children[t];e.parent=null,e.dispatchEvent(ds)}return this.children.length=0,this},attach:function(t){return this.updateWorldMatrix(!0,!1),is.copy(this.matrixWorld).invert(),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),is.multiply(t.parent.matrixWorld)),t.applyMatrix4(is),t.updateWorldMatrix(!1,!1),this.add(t),this},getObjectById:function(t){return this.getObjectByProperty("id",t)},getObjectByName:function(t){return this.getObjectByProperty("name",t)},getObjectByProperty:function(t,e){if(this[t]===e)return this;for(let i=0,s=this.children.length;i<s;i++){const s=this.children[i].getObjectByProperty(t,e);if(void 0!==s)return s}},getWorldPosition:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldPosition() target is now required"),t=new pi),this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldQuaternion() target is now required"),t=new ui),this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(ns,t,os),t},getWorldScale:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldScale() target is now required"),t=new pi),this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(ns,rs,t),t},getWorldDirection:function(t){void 0===t&&(console.warn("THREE.Object3D: .getWorldDirection() target is now required"),t=new pi),this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()},raycast:function(){},traverse:function(t){t(this);const e=this.children;for(let i=0,s=e.length;i<s;i++)e[i].traverse(t)},traverseVisible:function(t){if(!1===this.visible)return;t(this);const e=this.children;for(let i=0,s=e.length;i<s;i++)e[i].traverseVisible(t)},traverseAncestors:function(t){const e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let i=0,s=e.length;i<s;i++)e[i].updateMatrixWorld(t)},updateWorldMatrix:function(t,e){const i=this.parent;if(!0===t&&null!==i&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===e){const t=this.children;for(let e=0,i=t.length;e<i;e++)t[e].updateWorldMatrix(!1,!0)}},toJSON:function(t){const e=void 0===t||"string"==typeof t,i={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{}},i.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});const s={};function n(e,i){return void 0===e[i.uuid]&&(e[i.uuid]=i.toJSON(t)),i.uuid}if(s.uuid=this.uuid,s.type=this.type,""!==this.name&&(s.name=this.name),!0===this.castShadow&&(s.castShadow=!0),!0===this.receiveShadow&&(s.receiveShadow=!0),!1===this.visible&&(s.visible=!1),!1===this.frustumCulled&&(s.frustumCulled=!1),0!==this.renderOrder&&(s.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(s.userData=this.userData),s.layers=this.layers.mask,s.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(s.matrixAutoUpdate=!1),this.isInstancedMesh&&(s.type="InstancedMesh",s.count=this.count,s.instanceMatrix=this.instanceMatrix.toJSON()),this.isMesh||this.isLine||this.isPoints){s.geometry=n(t.geometries,this.geometry);const e=this.geometry.parameters;if(void 0!==e&&void 0!==e.shapes){const i=e.shapes;if(Array.isArray(i))for(let e=0,s=i.length;e<s;e++){const s=i[e];n(t.shapes,s)}else n(t.shapes,i)}}if(this.isSkinnedMesh&&(s.bindMode=this.bindMode,s.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(n(t.skeletons,this.skeleton),s.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const e=[];for(let i=0,s=this.material.length;i<s;i++)e.push(n(t.materials,this.material[i]));s.material=e}else s.material=n(t.materials,this.material);if(this.children.length>0){s.children=[];for(let e=0;e<this.children.length;e++)s.children.push(this.children[e].toJSON(t).object)}if(this.animations.length>0){s.animations=[];for(let e=0;e<this.animations.length;e++){const i=this.animations[e];s.animations.push(n(t.animations,i))}}if(e){const e=o(t.geometries),s=o(t.materials),n=o(t.textures),r=o(t.images),a=o(t.shapes),h=o(t.skeletons),l=o(t.animations);e.length>0&&(i.geometries=e),s.length>0&&(i.materials=s),n.length>0&&(i.textures=n),r.length>0&&(i.images=r),a.length>0&&(i.shapes=a),h.length>0&&(i.skeletons=h),l.length>0&&(i.animations=l)}return i.object=s,i;function o(t){const e=[];for(const i in t){const s=t[i];delete s.metadata,e.push(s)}return e}},clone:function(t){return(new this.constructor).copy(this,t)},copy:function(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let e=0;e<t.children.length;e++){const i=t.children[e];this.add(i.clone())}return this}});const ps=new pi,ms=new pi,fs=new si;class gs{constructor(t,e){Object.defineProperty(this,"isPlane",{value:!0}),this.normal=void 0!==t?t:new pi(1,0,0),this.constant=void 0!==e?e:0}set(t,e){return this.normal.copy(t),this.constant=e,this}setComponents(t,e,i,s){return this.normal.set(t,e,i),this.constant=s,this}setFromNormalAndCoplanarPoint(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this}setFromCoplanarPoints(t,e,i){const s=ps.subVectors(i,e).cross(ms.subVectors(t,e)).normalize();return this.setFromNormalAndCoplanarPoint(s,t),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.normal.copy(t.normal),this.constant=t.constant,this}normalize(){const t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(t){return this.normal.dot(t)+this.constant}distanceToSphere(t){return this.distanceToPoint(t.center)-t.radius}projectPoint(t,e){return void 0===e&&(console.warn("THREE.Plane: .projectPoint() target is now required"),e=new pi),e.copy(this.normal).multiplyScalar(-this.distanceToPoint(t)).add(t)}intersectLine(t,e){void 0===e&&(console.warn("THREE.Plane: .intersectLine() target is now required"),e=new pi);const i=t.delta(ps),s=this.normal.dot(i);if(0===s)return 0===this.distanceToPoint(t.start)?e.copy(t.start):void 0;const n=-(t.start.dot(this.normal)+this.constant)/s;return n<0||n>1?void 0:e.copy(i).multiplyScalar(n).add(t.start)}intersectsLine(t){const e=this.distanceToPoint(t.start),i=this.distanceToPoint(t.end);return e<0&&i>0||i<0&&e>0}intersectsBox(t){return t.intersectsPlane(this)}intersectsSphere(t){return t.intersectsPlane(this)}coplanarPoint(t){return void 0===t&&(console.warn("THREE.Plane: .coplanarPoint() target is now required"),t=new pi),t.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(t,e){const i=e||fs.getNormalMatrix(t),s=this.coplanarPoint(ps).applyMatrix4(t),n=this.normal.applyMatrix3(i).normalize();return this.constant=-s.dot(n),this}translate(t){return this.constant-=t.dot(this.normal),this}equals(t){return t.normal.equals(this.normal)&&t.constant===this.constant}}const ys=new pi,vs=new pi,ws=new pi,xs=new pi,bs=new pi,Ss=new pi,Ms=new pi,Ts=new pi,_s=new pi,Es=new pi;class Ls{constructor(t,e,i){this.a=void 0!==t?t:new pi,this.b=void 0!==e?e:new pi,this.c=void 0!==i?i:new pi}static getNormal(t,e,i,s){void 0===s&&(console.warn("THREE.Triangle: .getNormal() target is now required"),s=new pi),s.subVectors(i,e),ys.subVectors(t,e),s.cross(ys);const n=s.lengthSq();return n>0?s.multiplyScalar(1/Math.sqrt(n)):s.set(0,0,0)}static getBarycoord(t,e,i,s,n){ys.subVectors(s,e),vs.subVectors(i,e),ws.subVectors(t,e);const o=ys.dot(ys),r=ys.dot(vs),a=ys.dot(ws),h=vs.dot(vs),l=vs.dot(ws),c=o*h-r*r;if(void 0===n&&(console.warn("THREE.Triangle: .getBarycoord() target is now required"),n=new pi),0===c)return n.set(-2,-1,-1);const d=1/c,u=(h*a-r*l)*d,p=(o*l-r*a)*d;return n.set(1-u-p,p,u)}static containsPoint(t,e,i,s){return this.getBarycoord(t,e,i,s,xs),xs.x>=0&&xs.y>=0&&xs.x+xs.y<=1}static getUV(t,e,i,s,n,o,r,a){return this.getBarycoord(t,e,i,s,xs),a.set(0,0),a.addScaledVector(n,xs.x),a.addScaledVector(o,xs.y),a.addScaledVector(r,xs.z),a}static isFrontFacing(t,e,i,s){return ys.subVectors(i,e),vs.subVectors(t,e),ys.cross(vs).dot(s)<0}set(t,e,i){return this.a.copy(t),this.b.copy(e),this.c.copy(i),this}setFromPointsAndIndices(t,e,i,s){return this.a.copy(t[e]),this.b.copy(t[i]),this.c.copy(t[s]),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this}getArea(){return ys.subVectors(this.c,this.b),vs.subVectors(this.a,this.b),.5*ys.cross(vs).length()}getMidpoint(t){return void 0===t&&(console.warn("THREE.Triangle: .getMidpoint() target is now required"),t=new pi),t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(t){return Ls.getNormal(this.a,this.b,this.c,t)}getPlane(t){return void 0===t&&(console.warn("THREE.Triangle: .getPlane() target is now required"),t=new gs),t.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(t,e){return Ls.getBarycoord(t,this.a,this.b,this.c,e)}getUV(t,e,i,s,n){return Ls.getUV(t,this.a,this.b,this.c,e,i,s,n)}containsPoint(t){return Ls.containsPoint(t,this.a,this.b,this.c)}isFrontFacing(t){return Ls.isFrontFacing(this.a,this.b,this.c,t)}intersectsBox(t){return t.intersectsTriangle(this)}closestPointToPoint(t,e){void 0===e&&(console.warn("THREE.Triangle: .closestPointToPoint() target is now required"),e=new pi);const i=this.a,s=this.b,n=this.c;let o,r;bs.subVectors(s,i),Ss.subVectors(n,i),Ts.subVectors(t,i);const a=bs.dot(Ts),h=Ss.dot(Ts);if(a<=0&&h<=0)return e.copy(i);_s.subVectors(t,s);const l=bs.dot(_s),c=Ss.dot(_s);if(l>=0&&c<=l)return e.copy(s);const d=a*c-l*h;if(d<=0&&a>=0&&l<=0)return o=a/(a-l),e.copy(i).addScaledVector(bs,o);Es.subVectors(t,n);const u=bs.dot(Es),p=Ss.dot(Es);if(p>=0&&u<=p)return e.copy(n);const m=u*h-a*p;if(m<=0&&h>=0&&p<=0)return r=h/(h-p),e.copy(i).addScaledVector(Ss,r);const f=l*p-u*c;if(f<=0&&c-l>=0&&u-p>=0)return Ms.subVectors(n,s),r=(c-l)/(c-l+(u-p)),e.copy(s).addScaledVector(Ms,r);const g=1/(f+m+d);return o=m*g,r=d*g,e.copy(i).addScaledVector(bs,o).addScaledVector(Ss,r)}equals(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}const Cs={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},As={h:0,s:0,l:0},Ps={h:0,s:0,l:0};function ks(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+6*(e-t)*(2/3-i):t}function Bs(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function Rs(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}class Ds{constructor(t,e,i){return Object.defineProperty(this,"isColor",{value:!0}),void 0===e&&void 0===i?this.set(t):this.setRGB(t,e,i)}set(t){return t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t),this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,this}setRGB(t,e,i){return this.r=t,this.g=e,this.b=i,this}setHSL(t,e,i){if(t=ei.euclideanModulo(t,1),e=ei.clamp(e,0,1),i=ei.clamp(i,0,1),0===e)this.r=this.g=this.b=i;else{const s=i<=.5?i*(1+e):i+e-i*e,n=2*i-s;this.r=ks(n,s,t+1/3),this.g=ks(n,s,t),this.b=ks(n,s,t-1/3)}return this}setStyle(t){function e(e){void 0!==e&&parseFloat(e)<1&&console.warn("THREE.Color: Alpha component of "+t+" will be ignored.")}let i;if(i=/^((?:rgb|hsl)a?)\(\s*([^\)]*)\)/.exec(t)){let t;const s=i[1],n=i[2];switch(s){case"rgb":case"rgba":if(t=/^(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return this.r=Math.min(255,parseInt(t[1],10))/255,this.g=Math.min(255,parseInt(t[2],10))/255,this.b=Math.min(255,parseInt(t[3],10))/255,e(t[4]),this;if(t=/^(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return this.r=Math.min(100,parseInt(t[1],10))/100,this.g=Math.min(100,parseInt(t[2],10))/100,this.b=Math.min(100,parseInt(t[3],10))/100,e(t[4]),this;break;case"hsl":case"hsla":if(t=/^(\d*\.?\d+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n)){const i=parseFloat(t[1])/360,s=parseInt(t[2],10)/100,n=parseInt(t[3],10)/100;return e(t[4]),this.setHSL(i,s,n)}}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(t)){const t=i[1],e=t.length;if(3===e)return this.r=parseInt(t.charAt(0)+t.charAt(0),16)/255,this.g=parseInt(t.charAt(1)+t.charAt(1),16)/255,this.b=parseInt(t.charAt(2)+t.charAt(2),16)/255,this;if(6===e)return this.r=parseInt(t.charAt(0)+t.charAt(1),16)/255,this.g=parseInt(t.charAt(2)+t.charAt(3),16)/255,this.b=parseInt(t.charAt(4)+t.charAt(5),16)/255,this}return t&&t.length>0?this.setColorName(t):this}setColorName(t){const e=Cs[t];return void 0!==e?this.setHex(e):console.warn("THREE.Color: Unknown color "+t),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copyGammaToLinear(t,e=2){return this.r=Math.pow(t.r,e),this.g=Math.pow(t.g,e),this.b=Math.pow(t.b,e),this}copyLinearToGamma(t,e=2){const i=e>0?1/e:1;return this.r=Math.pow(t.r,i),this.g=Math.pow(t.g,i),this.b=Math.pow(t.b,i),this}convertGammaToLinear(t){return this.copyGammaToLinear(this,t),this}convertLinearToGamma(t){return this.copyLinearToGamma(this,t),this}copySRGBToLinear(t){return this.r=Bs(t.r),this.g=Bs(t.g),this.b=Bs(t.b),this}copyLinearToSRGB(t){return this.r=Rs(t.r),this.g=Rs(t.g),this.b=Rs(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0}getHexString(){return("000000"+this.getHex().toString(16)).slice(-6)}getHSL(t){void 0===t&&(console.warn("THREE.Color: .getHSL() target is now required"),t={h:0,s:0,l:0});const e=this.r,i=this.g,s=this.b,n=Math.max(e,i,s),o=Math.min(e,i,s);let r,a;const h=(o+n)/2;if(o===n)r=0,a=0;else{const t=n-o;switch(a=h<=.5?t/(n+o):t/(2-n-o),n){case e:r=(i-s)/t+(i<s?6:0);break;case i:r=(s-e)/t+2;break;case s:r=(e-i)/t+4}r/=6}return t.h=r,t.s=a,t.l=h,t}getStyle(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"}offsetHSL(t,e,i){return this.getHSL(As),As.h+=t,As.s+=e,As.l+=i,this.setHSL(As.h,As.s,As.l),this}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpHSL(t,e){this.getHSL(As),t.getHSL(Ps);const i=ei.lerp(As.h,Ps.h,e),s=ei.lerp(As.s,Ps.s,e),n=ei.lerp(As.l,Ps.l,e);return this.setHSL(i,s,n),this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),!0===t.normalized&&(this.r/=255,this.g/=255,this.b/=255),this}toJSON(){return this.getHex()}}Ds.NAMES=Cs,Ds.prototype.r=1,Ds.prototype.g=1,Ds.prototype.b=1;class Is{constructor(t,e,i,s,n,o=0){this.a=t,this.b=e,this.c=i,this.normal=s&&s.isVector3?s:new pi,this.vertexNormals=Array.isArray(s)?s:[],this.color=n&&n.isColor?n:new Ds,this.vertexColors=Array.isArray(n)?n:[],this.materialIndex=o}clone(){return(new this.constructor).copy(this)}copy(t){this.a=t.a,this.b=t.b,this.c=t.c,this.normal.copy(t.normal),this.color.copy(t.color),this.materialIndex=t.materialIndex;for(let e=0,i=t.vertexNormals.length;e<i;e++)this.vertexNormals[e]=t.vertexNormals[e].clone();for(let e=0,i=t.vertexColors.length;e<i;e++)this.vertexColors[e]=t.vertexColors[e].clone();return this}}let Fs=0;function zs(){Object.defineProperty(this,"id",{value:Fs++}),this.uuid=ei.generateUUID(),this.name="",this.type="Material",this.fog=!0,this.blending=m,this.side=c,this.flatShading=!1,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.blendSrc=C,this.blendDst=A,this.blendEquation=w,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=O,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=Xe,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=$e,this.stencilZFail=$e,this.stencilZPass=$e,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaTest=0,this.premultipliedAlpha=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0}function Os(t){zs.call(this),this.type="MeshBasicMaterial",this.color=new Ds(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=V,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.setValues(t)}zs.prototype=Object.assign(Object.create(Je.prototype),{constructor:zs,isMaterial:!0,onBeforeCompile:function(){},customProgramCacheKey:function(){return this.onBeforeCompile.toString()},setValues:function(t){if(void 0!==t)for(const e in t){const i=t[e];if(void 0===i){console.warn("THREE.Material: '"+e+"' parameter is undefined.");continue}if("shading"===e){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=1===i;continue}const s=this[e];void 0!==s?s&&s.isColor?s.set(i):s&&s.isVector3&&i&&i.isVector3?s.copy(i):this[e]=i:console.warn("THREE."+this.type+": '"+e+"' is not a property of this material.")}},toJSON:function(t){const e=void 0===t||"string"==typeof t;e&&(t={textures:{},images:{}});const i={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};function s(t){const e=[];for(const i in t){const s=t[i];delete s.metadata,e.push(s)}return e}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),this.sheen&&this.sheen.isColor&&(i.sheen=this.sheen.getHex()),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),this.emissiveIntensity&&1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearcoat&&(i.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(t).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(t).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(t).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(t).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(t).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(t).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(t).uuid),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(t).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(t).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(t).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(t).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(t).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(t).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(t).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(t).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(t).uuid,i.reflectivity=this.reflectivity,i.refractionRatio=this.refractionRatio,void 0!==this.combine&&(i.combine=this.combine),void 0!==this.envMapIntensity&&(i.envMapIntensity=this.envMapIntensity)),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(t).uuid),void 0!==this.size&&(i.size=this.size),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),this.blending!==m&&(i.blending=this.blending),!0===this.flatShading&&(i.flatShading=this.flatShading),this.side!==c&&(i.side=this.side),this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=this.transparent),i.depthFunc=this.depthFunc,i.depthTest=this.depthTest,i.depthWrite=this.depthWrite,i.stencilWrite=this.stencilWrite,i.stencilWriteMask=this.stencilWriteMask,i.stencilFunc=this.stencilFunc,i.stencilRef=this.stencilRef,i.stencilFuncMask=this.stencilFuncMask,i.stencilFail=this.stencilFail,i.stencilZFail=this.stencilZFail,i.stencilZPass=this.stencilZPass,this.rotation&&0!==this.rotation&&(i.rotation=this.rotation),!0===this.polygonOffset&&(i.polygonOffset=!0),0!==this.polygonOffsetFactor&&(i.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(i.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth&&1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(i.wireframe=this.wireframe),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.morphTargets&&(i.morphTargets=!0),!0===this.morphNormals&&(i.morphNormals=!0),!0===this.skinning&&(i.skinning=!0),!1===this.visible&&(i.visible=!1),!1===this.toneMapped&&(i.toneMapped=!1),"{}"!==JSON.stringify(this.userData)&&(i.userData=this.userData),e){const e=s(t.textures),n=s(t.images);e.length>0&&(i.textures=e),n.length>0&&(i.images=n)}return i},clone:function(){return(new this.constructor).copy(this)},copy:function(t){this.name=t.name,this.fog=t.fog,this.blending=t.blending,this.side=t.side,this.flatShading=t.flatShading,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.stencilWriteMask=t.stencilWriteMask,this.stencilFunc=t.stencilFunc,this.stencilRef=t.stencilRef,this.stencilFuncMask=t.stencilFuncMask,this.stencilFail=t.stencilFail,this.stencilZFail=t.stencilZFail,this.stencilZPass=t.stencilZPass,this.stencilWrite=t.stencilWrite;const e=t.clippingPlanes;let i=null;if(null!==e){const t=e.length;i=new Array(t);for(let s=0;s!==t;++s)i[s]=e[s].clone()}return this.clippingPlanes=i,this.clipIntersection=t.clipIntersection,this.clipShadows=t.clipShadows,this.shadowSide=t.shadowSide,this.colorWrite=t.colorWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.dithering=t.dithering,this.alphaTest=t.alphaTest,this.premultipliedAlpha=t.premultipliedAlpha,this.visible=t.visible,this.toneMapped=t.toneMapped,this.userData=JSON.parse(JSON.stringify(t.userData)),this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Object.defineProperty(zs.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}}),Os.prototype=Object.create(zs.prototype),Os.prototype.constructor=Os,Os.prototype.isMeshBasicMaterial=!0,Os.prototype.copy=function(t){return zs.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this};const Ns=new pi,Ws=new ii;function Hs(t,e,i){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.name="",this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=!0===i,this.usage=Ye,this.updateRange={offset:0,count:-1},this.version=0}function Us(t,e,i){Hs.call(this,new Int8Array(t),e,i)}function Vs(t,e,i){Hs.call(this,new Uint8Array(t),e,i)}function Gs(t,e,i){Hs.call(this,new Uint8ClampedArray(t),e,i)}function js(t,e,i){Hs.call(this,new Int16Array(t),e,i)}function qs(t,e,i){Hs.call(this,new Uint16Array(t),e,i)}function $s(t,e,i){Hs.call(this,new Int32Array(t),e,i)}function Xs(t,e,i){Hs.call(this,new Uint32Array(t),e,i)}function Ys(t,e,i){Hs.call(this,new Uint16Array(t),e,i)}function Zs(t,e,i){Hs.call(this,new Float32Array(t),e,i)}function Ks(t,e,i){Hs.call(this,new Float64Array(t),e,i)}Object.defineProperty(Hs.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}}),Object.assign(Hs.prototype,{isBufferAttribute:!0,onUploadCallback:function(){},setUsage:function(t){return this.usage=t,this},copy:function(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.usage=t.usage,this},copyAt:function(t,e,i){t*=this.itemSize,i*=e.itemSize;for(let s=0,n=this.itemSize;s<n;s++)this.array[t+s]=e.array[i+s];return this},copyArray:function(t){return this.array.set(t),this},copyColorsArray:function(t){const e=this.array;let i=0;for(let s=0,n=t.length;s<n;s++){let n=t[s];void 0===n&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",s),n=new Ds),e[i++]=n.r,e[i++]=n.g,e[i++]=n.b}return this},copyVector2sArray:function(t){const e=this.array;let i=0;for(let s=0,n=t.length;s<n;s++){let n=t[s];void 0===n&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",s),n=new ii),e[i++]=n.x,e[i++]=n.y}return this},copyVector3sArray:function(t){const e=this.array;let i=0;for(let s=0,n=t.length;s<n;s++){let n=t[s];void 0===n&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",s),n=new pi),e[i++]=n.x,e[i++]=n.y,e[i++]=n.z}return this},copyVector4sArray:function(t){const e=this.array;let i=0;for(let s=0,n=t.length;s<n;s++){let n=t[s];void 0===n&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",s),n=new li),e[i++]=n.x,e[i++]=n.y,e[i++]=n.z,e[i++]=n.w}return this},applyMatrix3:function(t){if(2===this.itemSize)for(let e=0,i=this.count;e<i;e++)Ws.fromBufferAttribute(this,e),Ws.applyMatrix3(t),this.setXY(e,Ws.x,Ws.y);else if(3===this.itemSize)for(let e=0,i=this.count;e<i;e++)Ns.fromBufferAttribute(this,e),Ns.applyMatrix3(t),this.setXYZ(e,Ns.x,Ns.y,Ns.z);return this},applyMatrix4:function(t){for(let e=0,i=this.count;e<i;e++)Ns.x=this.getX(e),Ns.y=this.getY(e),Ns.z=this.getZ(e),Ns.applyMatrix4(t),this.setXYZ(e,Ns.x,Ns.y,Ns.z);return this},applyNormalMatrix:function(t){for(let e=0,i=this.count;e<i;e++)Ns.x=this.getX(e),Ns.y=this.getY(e),Ns.z=this.getZ(e),Ns.applyNormalMatrix(t),this.setXYZ(e,Ns.x,Ns.y,Ns.z);return this},transformDirection:function(t){for(let e=0,i=this.count;e<i;e++)Ns.x=this.getX(e),Ns.y=this.getY(e),Ns.z=this.getZ(e),Ns.transformDirection(t),this.setXYZ(e,Ns.x,Ns.y,Ns.z);return this},set:function(t,e=0){return this.array.set(t,e),this},getX:function(t){return this.array[t*this.itemSize]},setX:function(t,e){return this.array[t*this.itemSize]=e,this},getY:function(t){return this.array[t*this.itemSize+1]},setY:function(t,e){return this.array[t*this.itemSize+1]=e,this},getZ:function(t){return this.array[t*this.itemSize+2]},setZ:function(t,e){return this.array[t*this.itemSize+2]=e,this},getW:function(t){return this.array[t*this.itemSize+3]},setW:function(t,e){return this.array[t*this.itemSize+3]=e,this},setXY:function(t,e,i){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this},setXYZ:function(t,e,i,s){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=s,this},setXYZW:function(t,e,i,s,n){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=s,this.array[t+3]=n,this},onUpload:function(t){return this.onUploadCallback=t,this},clone:function(){return new this.constructor(this.array,this.itemSize).copy(this)},toJSON:function(){return{itemSize:this.itemSize,type:this.array.constructor.name,array:Array.prototype.slice.call(this.array),normalized:this.normalized}}}),Us.prototype=Object.create(Hs.prototype),Us.prototype.constructor=Us,Vs.prototype=Object.create(Hs.prototype),Vs.prototype.constructor=Vs,Gs.prototype=Object.create(Hs.prototype),Gs.prototype.constructor=Gs,js.prototype=Object.create(Hs.prototype),js.prototype.constructor=js,qs.prototype=Object.create(Hs.prototype),qs.prototype.constructor=qs,$s.prototype=Object.create(Hs.prototype),$s.prototype.constructor=$s,Xs.prototype=Object.create(Hs.prototype),Xs.prototype.constructor=Xs,Ys.prototype=Object.create(Hs.prototype),Ys.prototype.constructor=Ys,Ys.prototype.isFloat16BufferAttribute=!0,Zs.prototype=Object.create(Hs.prototype),Zs.prototype.constructor=Zs,Ks.prototype=Object.create(Hs.prototype),Ks.prototype.constructor=Ks;class Js{constructor(){this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}computeGroups(t){const e=[];let i,s,n;const o=t.faces;for(s=0;s<o.length;s++){const t=o[s];t.materialIndex!==n&&(n=t.materialIndex,void 0!==i&&(i.count=3*s-i.start,e.push(i)),i={start:3*s,materialIndex:n})}void 0!==i&&(i.count=3*s-i.start,e.push(i)),this.groups=e}fromGeometry(t){const e=t.faces,i=t.vertices,s=t.faceVertexUvs,n=s[0]&&s[0].length>0,o=s[1]&&s[1].length>0,r=t.morphTargets,a=r.length;let h;if(a>0){h=[];for(let t=0;t<a;t++)h[t]={name:r[t].name,data:[]};this.morphTargets.position=h}const l=t.morphNormals,c=l.length;let d;if(c>0){d=[];for(let t=0;t<c;t++)d[t]={name:l[t].name,data:[]};this.morphTargets.normal=d}const u=t.skinIndices,p=t.skinWeights,m=u.length===i.length,f=p.length===i.length;i.length>0&&0===e.length&&console.error("THREE.DirectGeometry: Faceless geometries are not supported.");for(let t=0;t<e.length;t++){const g=e[t];this.vertices.push(i[g.a],i[g.b],i[g.c]);const y=g.vertexNormals;if(3===y.length)this.normals.push(y[0],y[1],y[2]);else{const t=g.normal;this.normals.push(t,t,t)}const v=g.vertexColors;if(3===v.length)this.colors.push(v[0],v[1],v[2]);else{const t=g.color;this.colors.push(t,t,t)}if(!0===n){const e=s[0][t];void 0!==e?this.uvs.push(e[0],e[1],e[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",t),this.uvs.push(new ii,new ii,new ii))}if(!0===o){const e=s[1][t];void 0!==e?this.uvs2.push(e[0],e[1],e[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",t),this.uvs2.push(new ii,new ii,new ii))}for(let t=0;t<a;t++){const e=r[t].vertices;h[t].data.push(e[g.a],e[g.b],e[g.c])}for(let e=0;e<c;e++){const i=l[e].vertexNormals[t];d[e].data.push(i.a,i.b,i.c)}m&&this.skinIndices.push(u[g.a],u[g.b],u[g.c]),f&&this.skinWeights.push(p[g.a],p[g.b],p[g.c])}return this.computeGroups(t),this.verticesNeedUpdate=t.verticesNeedUpdate,this.normalsNeedUpdate=t.normalsNeedUpdate,this.colorsNeedUpdate=t.colorsNeedUpdate,this.uvsNeedUpdate=t.uvsNeedUpdate,this.groupsNeedUpdate=t.groupsNeedUpdate,null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),this}}function Qs(t){if(0===t.length)return-1/0;let e=t[0];for(let i=1,s=t.length;i<s;++i)t[i]>e&&(e=t[i]);return e}const tn={Int8Array,Uint8Array,Uint8ClampedArray:"undefined"!=typeof Uint8ClampedArray?Uint8ClampedArray:Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array};function en(t,e){return new tn[t](e)}let sn=1;const nn=new Hi,on=new us,rn=new pi,an=new gi,hn=new gi,ln=new pi;function cn(){Object.defineProperty(this,"id",{value:sn+=2}),this.uuid=ei.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}cn.prototype=Object.assign(Object.create(Je.prototype),{constructor:cn,isBufferGeometry:!0,getIndex:function(){return this.index},setIndex:function(t){return Array.isArray(t)?this.index=new(Qs(t)>65535?Xs:qs)(t,1):this.index=t,this},getAttribute:function(t){return this.attributes[t]},setAttribute:function(t,e){return this.attributes[t]=e,this},deleteAttribute:function(t){return delete this.attributes[t],this},hasAttribute:function(t){return void 0!==this.attributes[t]},addGroup:function(t,e,i=0){this.groups.push({start:t,count:e,materialIndex:i})},clearGroups:function(){this.groups=[]},setDrawRange:function(t,e){this.drawRange.start=t,this.drawRange.count=e},applyMatrix4:function(t){const e=this.attributes.position;void 0!==e&&(e.applyMatrix4(t),e.needsUpdate=!0);const i=this.attributes.normal;if(void 0!==i){const e=(new si).getNormalMatrix(t);i.applyNormalMatrix(e),i.needsUpdate=!0}const s=this.attributes.tangent;return void 0!==s&&(s.transformDirection(t),s.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},rotateX:function(t){return nn.makeRotationX(t),this.applyMatrix4(nn),this},rotateY:function(t){return nn.makeRotationY(t),this.applyMatrix4(nn),this},rotateZ:function(t){return nn.makeRotationZ(t),this.applyMatrix4(nn),this},translate:function(t,e,i){return nn.makeTranslation(t,e,i),this.applyMatrix4(nn),this},scale:function(t,e,i){return nn.makeScale(t,e,i),this.applyMatrix4(nn),this},lookAt:function(t){return on.lookAt(t),on.updateMatrix(),this.applyMatrix4(on.matrix),this},center:function(){return this.computeBoundingBox(),this.boundingBox.getCenter(rn).negate(),this.translate(rn.x,rn.y,rn.z),this},setFromObject:function(t){const e=t.geometry;if(t.isPoints||t.isLine){const t=new Zs(3*e.vertices.length,3),i=new Zs(3*e.colors.length,3);if(this.setAttribute("position",t.copyVector3sArray(e.vertices)),this.setAttribute("color",i.copyColorsArray(e.colors)),e.lineDistances&&e.lineDistances.length===e.vertices.length){const t=new Zs(e.lineDistances.length,1);this.setAttribute("lineDistance",t.copyArray(e.lineDistances))}null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone())}else t.isMesh&&e&&e.isGeometry&&this.fromGeometry(e);return this},setFromPoints:function(t){const e=[];for(let i=0,s=t.length;i<s;i++){const s=t[i];e.push(s.x,s.y,s.z||0)}return this.setAttribute("position",new Zs(e,3)),this},updateFromObject:function(t){let e=t.geometry;if(t.isMesh){let t=e.__directGeometry;if(!0===e.elementsNeedUpdate&&(t=void 0,e.elementsNeedUpdate=!1),void 0===t)return this.fromGeometry(e);t.verticesNeedUpdate=e.verticesNeedUpdate,t.normalsNeedUpdate=e.normalsNeedUpdate,t.colorsNeedUpdate=e.colorsNeedUpdate,t.uvsNeedUpdate=e.uvsNeedUpdate,t.groupsNeedUpdate=e.groupsNeedUpdate,e.verticesNeedUpdate=!1,e.normalsNeedUpdate=!1,e.colorsNeedUpdate=!1,e.uvsNeedUpdate=!1,e.groupsNeedUpdate=!1,e=t}if(!0===e.verticesNeedUpdate){const t=this.attributes.position;void 0!==t&&(t.copyVector3sArray(e.vertices),t.needsUpdate=!0),e.verticesNeedUpdate=!1}if(!0===e.normalsNeedUpdate){const t=this.attributes.normal;void 0!==t&&(t.copyVector3sArray(e.normals),t.needsUpdate=!0),e.normalsNeedUpdate=!1}if(!0===e.colorsNeedUpdate){const t=this.attributes.color;void 0!==t&&(t.copyColorsArray(e.colors),t.needsUpdate=!0),e.colorsNeedUpdate=!1}if(e.uvsNeedUpdate){const t=this.attributes.uv;void 0!==t&&(t.copyVector2sArray(e.uvs),t.needsUpdate=!0),e.uvsNeedUpdate=!1}if(e.lineDistancesNeedUpdate){const t=this.attributes.lineDistance;void 0!==t&&(t.copyArray(e.lineDistances),t.needsUpdate=!0),e.lineDistancesNeedUpdate=!1}return e.groupsNeedUpdate&&(e.computeGroups(t.geometry),this.groups=e.groups,e.groupsNeedUpdate=!1),this},fromGeometry:function(t){return t.__directGeometry=(new Js).fromGeometry(t),this.fromDirectGeometry(t.__directGeometry)},fromDirectGeometry:function(t){const e=new Float32Array(3*t.vertices.length);if(this.setAttribute("position",new Hs(e,3).copyVector3sArray(t.vertices)),t.normals.length>0){const e=new Float32Array(3*t.normals.length);this.setAttribute("normal",new Hs(e,3).copyVector3sArray(t.normals))}if(t.colors.length>0){const e=new Float32Array(3*t.colors.length);this.setAttribute("color",new Hs(e,3).copyColorsArray(t.colors))}if(t.uvs.length>0){const e=new Float32Array(2*t.uvs.length);this.setAttribute("uv",new Hs(e,2).copyVector2sArray(t.uvs))}if(t.uvs2.length>0){const e=new Float32Array(2*t.uvs2.length);this.setAttribute("uv2",new Hs(e,2).copyVector2sArray(t.uvs2))}this.groups=t.groups;for(const e in t.morphTargets){const i=[],s=t.morphTargets[e];for(let t=0,e=s.length;t<e;t++){const e=s[t],n=new Zs(3*e.data.length,3);n.name=e.name,i.push(n.copyVector3sArray(e.data))}this.morphAttributes[e]=i}if(t.skinIndices.length>0){const e=new Zs(4*t.skinIndices.length,4);this.setAttribute("skinIndex",e.copyVector4sArray(t.skinIndices))}if(t.skinWeights.length>0){const e=new Zs(4*t.skinWeights.length,4);this.setAttribute("skinWeight",e.copyVector4sArray(t.skinWeights))}return null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),this},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new gi);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingBox.set(new pi(-1/0,-1/0,-1/0),new pi(1/0,1/0,1/0));if(void 0!==t){if(this.boundingBox.setFromBufferAttribute(t),e)for(let t=0,i=e.length;t<i;t++){const i=e[t];an.setFromBufferAttribute(i),this.morphTargetsRelative?(ln.addVectors(this.boundingBox.min,an.min),this.boundingBox.expandByPoint(ln),ln.addVectors(this.boundingBox.max,an.max),this.boundingBox.expandByPoint(ln)):(this.boundingBox.expandByPoint(an.min),this.boundingBox.expandByPoint(an.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new Bi);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingSphere.set(new pi,1/0);if(t){const i=this.boundingSphere.center;if(an.setFromBufferAttribute(t),e)for(let t=0,i=e.length;t<i;t++){const i=e[t];hn.setFromBufferAttribute(i),this.morphTargetsRelative?(ln.addVectors(an.min,hn.min),an.expandByPoint(ln),ln.addVectors(an.max,hn.max),an.expandByPoint(ln)):(an.expandByPoint(hn.min),an.expandByPoint(hn.max))}an.getCenter(i);let s=0;for(let e=0,n=t.count;e<n;e++)ln.fromBufferAttribute(t,e),s=Math.max(s,i.distanceToSquared(ln));if(e)for(let n=0,o=e.length;n<o;n++){const o=e[n],r=this.morphTargetsRelative;for(let e=0,n=o.count;e<n;e++)ln.fromBufferAttribute(o,e),r&&(rn.fromBufferAttribute(t,e),ln.add(rn)),s=Math.max(s,i.distanceToSquared(ln))}this.boundingSphere.radius=Math.sqrt(s),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}},computeFaceNormals:function(){},computeVertexNormals:function(){const t=this.index,e=this.getAttribute("position");if(void 0!==e){let i=this.getAttribute("normal");if(void 0===i)i=new Hs(new Float32Array(3*e.count),3),this.setAttribute("normal",i);else for(let t=0,e=i.count;t<e;t++)i.setXYZ(t,0,0,0);const s=new pi,n=new pi,o=new pi,r=new pi,a=new pi,h=new pi,l=new pi,c=new pi;if(t)for(let d=0,u=t.count;d<u;d+=3){const u=t.getX(d+0),p=t.getX(d+1),m=t.getX(d+2);s.fromBufferAttribute(e,u),n.fromBufferAttribute(e,p),o.fromBufferAttribute(e,m),l.subVectors(o,n),c.subVectors(s,n),l.cross(c),r.fromBufferAttribute(i,u),a.fromBufferAttribute(i,p),h.fromBufferAttribute(i,m),r.add(l),a.add(l),h.add(l),i.setXYZ(u,r.x,r.y,r.z),i.setXYZ(p,a.x,a.y,a.z),i.setXYZ(m,h.x,h.y,h.z)}else for(let t=0,r=e.count;t<r;t+=3)s.fromBufferAttribute(e,t+0),n.fromBufferAttribute(e,t+1),o.fromBufferAttribute(e,t+2),l.subVectors(o,n),c.subVectors(s,n),l.cross(c),i.setXYZ(t+0,l.x,l.y,l.z),i.setXYZ(t+1,l.x,l.y,l.z),i.setXYZ(t+2,l.x,l.y,l.z);this.normalizeNormals(),i.needsUpdate=!0}},merge:function(t,e){if(!t||!t.isBufferGeometry)return void console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",t);void 0===e&&(e=0,console.warn("THREE.BufferGeometry.merge(): Overwriting original geometry, starting at offset=0. Use BufferGeometryUtils.mergeBufferGeometries() for lossless merge."));const i=this.attributes;for(const s in i){if(void 0===t.attributes[s])continue;const n=i[s].array,o=t.attributes[s],r=o.array,a=o.itemSize*e,h=Math.min(r.length,n.length-a);for(let t=0,e=a;t<h;t++,e++)n[e]=r[t]}return this},normalizeNormals:function(){const t=this.attributes.normal;for(let e=0,i=t.count;e<i;e++)ln.fromBufferAttribute(t,e),ln.normalize(),t.setXYZ(e,ln.x,ln.y,ln.z)},toNonIndexed:function(){function t(t,e){const i=t.array,s=t.itemSize,n=t.normalized,o=new i.constructor(e.length*s);let r=0,a=0;for(let t=0,n=e.length;t<n;t++){r=e[t]*s;for(let t=0;t<s;t++)o[a++]=i[r++]}return new Hs(o,s,n)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): Geometry is already non-indexed."),this;const e=new cn,i=this.index.array,s=this.attributes;for(const n in s){const o=t(s[n],i);e.setAttribute(n,o)}const n=this.morphAttributes;for(const s in n){const o=[],r=n[s];for(let e=0,s=r.length;e<s;e++){const s=t(r[e],i);o.push(s)}e.morphAttributes[s]=o}e.morphTargetsRelative=this.morphTargetsRelative;const o=this.groups;for(let t=0,i=o.length;t<i;t++){const i=o[t];e.addGroup(i.start,i.count,i.materialIndex)}return e},toJSON:function(){const t={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),Object.keys(this.userData).length>0&&(t.userData=this.userData),void 0!==this.parameters){const e=this.parameters;for(const i in e)void 0!==e[i]&&(t[i]=e[i]);return t}t.data={attributes:{}};const e=this.index;null!==e&&(t.data.index={type:e.array.constructor.name,array:Array.prototype.slice.call(e.array)});const i=this.attributes;for(const e in i){const s=i[e],n=s.toJSON(t.data);""!==s.name&&(n.name=s.name),t.data.attributes[e]=n}const s={};let n=!1;for(const e in this.morphAttributes){const i=this.morphAttributes[e],o=[];for(let e=0,s=i.length;e<s;e++){const s=i[e],n=s.toJSON(t.data);""!==s.name&&(n.name=s.name),o.push(n)}o.length>0&&(s[e]=o,n=!0)}n&&(t.data.morphAttributes=s,t.data.morphTargetsRelative=this.morphTargetsRelative);const o=this.groups;o.length>0&&(t.data.groups=JSON.parse(JSON.stringify(o)));const r=this.boundingSphere;return null!==r&&(t.data.boundingSphere={center:r.center.toArray(),radius:r.radius}),t},clone:function(){return(new cn).copy(this)},copy:function(t){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const e={};this.name=t.name;const i=t.index;null!==i&&this.setIndex(i.clone(e));const s=t.attributes;for(const t in s){const i=s[t];this.setAttribute(t,i.clone(e))}const n=t.morphAttributes;for(const t in n){const i=[],s=n[t];for(let t=0,n=s.length;t<n;t++)i.push(s[t].clone(e));this.morphAttributes[t]=i}this.morphTargetsRelative=t.morphTargetsRelative;const o=t.groups;for(let t=0,e=o.length;t<e;t++){const e=o[t];this.addGroup(e.start,e.count,e.materialIndex)}const r=t.boundingBox;null!==r&&(this.boundingBox=r.clone());const a=t.boundingSphere;return null!==a&&(this.boundingSphere=a.clone()),this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,this.userData=t.userData,this},dispose:function(){this.dispatchEvent({type:"dispose"})}});const dn=new Hi,un=new Wi,pn=new Bi,mn=new pi,fn=new pi,gn=new pi,yn=new pi,vn=new pi,wn=new pi,xn=new pi,bn=new pi,Sn=new pi,Mn=new ii,Tn=new ii,_n=new ii,En=new pi,Ln=new pi;function Cn(t=new cn,e=new Os){us.call(this),this.type="Mesh",this.geometry=t,this.material=e,this.updateMorphTargets()}function An(t,e,i,s,n,o,r,a){let h;if(h=e.side===d?s.intersectTriangle(r,o,n,!0,a):s.intersectTriangle(n,o,r,e.side!==u,a),null===h)return null;Ln.copy(a),Ln.applyMatrix4(t.matrixWorld);const l=i.ray.origin.distanceTo(Ln);return l<i.near||l>i.far?null:{distance:l,point:Ln.clone(),object:t}}function Pn(t,e,i,s,n,o,r,a,h,l,c,d){mn.fromBufferAttribute(n,l),fn.fromBufferAttribute(n,c),gn.fromBufferAttribute(n,d);const u=t.morphTargetInfluences;if(e.morphTargets&&o&&u){xn.set(0,0,0),bn.set(0,0,0),Sn.set(0,0,0);for(let t=0,e=o.length;t<e;t++){const e=u[t],i=o[t];0!==e&&(yn.fromBufferAttribute(i,l),vn.fromBufferAttribute(i,c),wn.fromBufferAttribute(i,d),r?(xn.addScaledVector(yn,e),bn.addScaledVector(vn,e),Sn.addScaledVector(wn,e)):(xn.addScaledVector(yn.sub(mn),e),bn.addScaledVector(vn.sub(fn),e),Sn.addScaledVector(wn.sub(gn),e)))}mn.add(xn),fn.add(bn),gn.add(Sn)}t.isSkinnedMesh&&(t.boneTransform(l,mn),t.boneTransform(c,fn),t.boneTransform(d,gn));const p=An(t,e,i,s,mn,fn,gn,En);if(p){a&&(Mn.fromBufferAttribute(a,l),Tn.fromBufferAttribute(a,c),_n.fromBufferAttribute(a,d),p.uv=Ls.getUV(En,mn,fn,gn,Mn,Tn,_n,new ii)),h&&(Mn.fromBufferAttribute(h,l),Tn.fromBufferAttribute(h,c),_n.fromBufferAttribute(h,d),p.uv2=Ls.getUV(En,mn,fn,gn,Mn,Tn,_n,new ii));const t=new Is(l,c,d);Ls.getNormal(mn,fn,gn,t.normal),p.face=t}return p}Cn.prototype=Object.assign(Object.create(us.prototype),{constructor:Cn,isMesh:!0,copy:function(t){return us.prototype.copy.call(this,t),void 0!==t.morphTargetInfluences&&(this.morphTargetInfluences=t.morphTargetInfluences.slice()),void 0!==t.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},t.morphTargetDictionary)),this.material=t.material,this.geometry=t.geometry,this},updateMorphTargets:function(){const t=this.geometry;if(t.isBufferGeometry){const e=t.morphAttributes,i=Object.keys(e);if(i.length>0){const t=e[i[0]];if(void 0!==t){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=t.length;e<i;e++){const i=t[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}else{const e=t.morphTargets;void 0!==e&&e.length>0&&console.error("THREE.Mesh.updateMorphTargets() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}},raycast:function(t,e){const i=this.geometry,s=this.material,n=this.matrixWorld;if(void 0===s)return;if(null===i.boundingSphere&&i.computeBoundingSphere(),pn.copy(i.boundingSphere),pn.applyMatrix4(n),!1===t.ray.intersectsSphere(pn))return;if(dn.copy(n).invert(),un.copy(t.ray).applyMatrix4(dn),null!==i.boundingBox&&!1===un.intersectsBox(i.boundingBox))return;let o;if(i.isBufferGeometry){const n=i.index,r=i.attributes.position,a=i.morphAttributes.position,h=i.morphTargetsRelative,l=i.attributes.uv,c=i.attributes.uv2,d=i.groups,u=i.drawRange;if(null!==n)if(Array.isArray(s))for(let i=0,p=d.length;i<p;i++){const p=d[i],m=s[p.materialIndex];for(let i=Math.max(p.start,u.start),s=Math.min(p.start+p.count,u.start+u.count);i<s;i+=3){const s=n.getX(i),d=n.getX(i+1),u=n.getX(i+2);o=Pn(this,m,t,un,r,a,h,l,c,s,d,u),o&&(o.faceIndex=Math.floor(i/3),o.face.materialIndex=p.materialIndex,e.push(o))}}else for(let i=Math.max(0,u.start),d=Math.min(n.count,u.start+u.count);i<d;i+=3){const d=n.getX(i),u=n.getX(i+1),p=n.getX(i+2);o=Pn(this,s,t,un,r,a,h,l,c,d,u,p),o&&(o.faceIndex=Math.floor(i/3),e.push(o))}else if(void 0!==r)if(Array.isArray(s))for(let i=0,n=d.length;i<n;i++){const n=d[i],p=s[n.materialIndex];for(let i=Math.max(n.start,u.start),s=Math.min(n.start+n.count,u.start+u.count);i<s;i+=3)o=Pn(this,p,t,un,r,a,h,l,c,i,i+1,i+2),o&&(o.faceIndex=Math.floor(i/3),o.face.materialIndex=n.materialIndex,e.push(o))}else for(let i=Math.max(0,u.start),n=Math.min(r.count,u.start+u.count);i<n;i+=3)o=Pn(this,s,t,un,r,a,h,l,c,i,i+1,i+2),o&&(o.faceIndex=Math.floor(i/3),e.push(o))}else if(i.isGeometry){const n=Array.isArray(s),r=i.vertices,a=i.faces;let h;const l=i.faceVertexUvs[0];l.length>0&&(h=l);for(let i=0,l=a.length;i<l;i++){const l=a[i],c=n?s[l.materialIndex]:s;if(void 0===c)continue;const d=r[l.a],u=r[l.b],p=r[l.c];if(o=An(this,c,t,un,d,u,p,En),o){if(h&&h[i]){const t=h[i];Mn.copy(t[0]),Tn.copy(t[1]),_n.copy(t[2]),o.uv=Ls.getUV(En,d,u,p,Mn,Tn,_n,new ii)}o.face=l,o.faceIndex=i,e.push(o)}}}}});class kn extends cn{constructor(t=1,e=1,i=1,s=1,n=1,o=1){super(),this.type="BoxBufferGeometry",this.parameters={width:t,height:e,depth:i,widthSegments:s,heightSegments:n,depthSegments:o};const r=this;s=Math.floor(s),n=Math.floor(n),o=Math.floor(o);const a=[],h=[],l=[],c=[];let d=0,u=0;function p(t,e,i,s,n,o,p,m,f,g,y){const v=o/f,w=p/g,x=o/2,b=p/2,S=m/2,M=f+1,T=g+1;let _=0,E=0;const L=new pi;for(let o=0;o<T;o++){const r=o*w-b;for(let a=0;a<M;a++){const d=a*v-x;L[t]=d*s,L[e]=r*n,L[i]=S,h.push(L.x,L.y,L.z),L[t]=0,L[e]=0,L[i]=m>0?1:-1,l.push(L.x,L.y,L.z),c.push(a/f),c.push(1-o/g),_+=1}}for(let t=0;t<g;t++)for(let e=0;e<f;e++){const i=d+e+M*t,s=d+e+M*(t+1),n=d+(e+1)+M*(t+1),o=d+(e+1)+M*t;a.push(i,s,o),a.push(s,n,o),E+=6}r.addGroup(u,E,y),u+=E,d+=_}p("z","y","x",-1,-1,i,e,t,o,n,0),p("z","y","x",1,-1,i,e,-t,o,n,1),p("x","z","y",1,1,t,i,e,s,o,2),p("x","z","y",1,-1,t,i,-e,s,o,3),p("x","y","z",1,-1,t,e,i,s,n,4),p("x","y","z",-1,-1,t,e,-i,s,n,5),this.setIndex(a),this.setAttribute("position",new Zs(h,3)),this.setAttribute("normal",new Zs(l,3)),this.setAttribute("uv",new Zs(c,2))}}function Bn(t){const e={};for(const i in t){e[i]={};for(const s in t[i]){const n=t[i][s];n&&(n.isColor||n.isMatrix3||n.isMatrix4||n.isVector2||n.isVector3||n.isVector4||n.isTexture)?e[i][s]=n.clone():Array.isArray(n)?e[i][s]=n.slice():e[i][s]=n}}return e}function Rn(t){const e={};for(let i=0;i<t.length;i++){const s=Bn(t[i]);for(const t in s)e[t]=s[t]}return e}const Dn={clone:Bn,merge:Rn};var In="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",Fn="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}";function zn(t){zs.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader=In,this.fragmentShader=Fn,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==t&&(void 0!==t.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(t))}function On(){us.call(this),this.type="Camera",this.matrixWorldInverse=new Hi,this.projectionMatrix=new Hi,this.projectionMatrixInverse=new Hi}function Nn(t=50,e=1,i=.1,s=2e3){On.call(this),this.type="PerspectiveCamera",this.fov=t,this.zoom=1,this.near=i,this.far=s,this.focus=10,this.aspect=e,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}zn.prototype=Object.create(zs.prototype),zn.prototype.constructor=zn,zn.prototype.isShaderMaterial=!0,zn.prototype.copy=function(t){return zs.prototype.copy.call(this,t),this.fragmentShader=t.fragmentShader,this.vertexShader=t.vertexShader,this.uniforms=Bn(t.uniforms),this.defines=Object.assign({},t.defines),this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.lights=t.lights,this.clipping=t.clipping,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this.extensions=Object.assign({},t.extensions),this.glslVersion=t.glslVersion,this},zn.prototype.toJSON=function(t){const e=zs.prototype.toJSON.call(this,t);e.glslVersion=this.glslVersion,e.uniforms={};for(const i in this.uniforms){const s=this.uniforms[i].value;s&&s.isTexture?e.uniforms[i]={type:"t",value:s.toJSON(t).uuid}:s&&s.isColor?e.uniforms[i]={type:"c",value:s.getHex()}:s&&s.isVector2?e.uniforms[i]={type:"v2",value:s.toArray()}:s&&s.isVector3?e.uniforms[i]={type:"v3",value:s.toArray()}:s&&s.isVector4?e.uniforms[i]={type:"v4",value:s.toArray()}:s&&s.isMatrix3?e.uniforms[i]={type:"m3",value:s.toArray()}:s&&s.isMatrix4?e.uniforms[i]={type:"m4",value:s.toArray()}:e.uniforms[i]={value:s}}Object.keys(this.defines).length>0&&(e.defines=this.defines),e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader;const i={};for(const t in this.extensions)!0===this.extensions[t]&&(i[t]=!0);return Object.keys(i).length>0&&(e.extensions=i),e},On.prototype=Object.assign(Object.create(us.prototype),{constructor:On,isCamera:!0,copy:function(t,e){return us.prototype.copy.call(this,t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this},getWorldDirection:function(t){void 0===t&&(console.warn("THREE.Camera: .getWorldDirection() target is now required"),t=new pi),this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(-e[8],-e[9],-e[10]).normalize()},updateMatrixWorld:function(t){us.prototype.updateMatrixWorld.call(this,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()},updateWorldMatrix:function(t,e){us.prototype.updateWorldMatrix.call(this,t,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()},clone:function(){return(new this.constructor).copy(this)}}),Nn.prototype=Object.assign(Object.create(On.prototype),{constructor:Nn,isPerspectiveCamera:!0,copy:function(t,e){return On.prototype.copy.call(this,t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=null===t.view?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this},setFocalLength:function(t){const e=.5*this.getFilmHeight()/t;this.fov=2*ei.RAD2DEG*Math.atan(e),this.updateProjectionMatrix()},getFocalLength:function(){const t=Math.tan(.5*ei.DEG2RAD*this.fov);return.5*this.getFilmHeight()/t},getEffectiveFOV:function(){return 2*ei.RAD2DEG*Math.atan(Math.tan(.5*ei.DEG2RAD*this.fov)/this.zoom)},getFilmWidth:function(){return this.filmGauge*Math.min(this.aspect,1)},getFilmHeight:function(){return this.filmGauge/Math.max(this.aspect,1)},setViewOffset:function(t,e,i,s,n,o){this.aspect=t/e,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=s,this.view.width=n,this.view.height=o,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){const t=this.near;let e=t*Math.tan(.5*ei.DEG2RAD*this.fov)/this.zoom,i=2*e,s=this.aspect*i,n=-.5*s;const o=this.view;if(null!==this.view&&this.view.enabled){const t=o.fullWidth,r=o.fullHeight;n+=o.offsetX*s/t,e-=o.offsetY*i/r,s*=o.width/t,i*=o.height/r}const r=this.filmOffset;0!==r&&(n+=t*r/this.getFilmWidth()),this.projectionMatrix.makePerspective(n,n+s,e,e-i,t,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()},toJSON:function(t){const e=us.prototype.toJSON.call(this,t);return e.object.fov=this.fov,e.object.zoom=this.zoom,e.object.near=this.near,e.object.far=this.far,e.object.focus=this.focus,e.object.aspect=this.aspect,null!==this.view&&(e.object.view=Object.assign({},this.view)),e.object.filmGauge=this.filmGauge,e.object.filmOffset=this.filmOffset,e}});const Wn=90;function Hn(t,e,i){if(us.call(this),this.type="CubeCamera",!0!==i.isWebGLCubeRenderTarget)return void console.error("THREE.CubeCamera: The constructor now expects an instance of WebGLCubeRenderTarget as third parameter.");this.renderTarget=i;const s=new Nn(Wn,1,t,e);s.layers=this.layers,s.up.set(0,-1,0),s.lookAt(new pi(1,0,0)),this.add(s);const n=new Nn(Wn,1,t,e);n.layers=this.layers,n.up.set(0,-1,0),n.lookAt(new pi(-1,0,0)),this.add(n);const o=new Nn(Wn,1,t,e);o.layers=this.layers,o.up.set(0,0,1),o.lookAt(new pi(0,1,0)),this.add(o);const r=new Nn(Wn,1,t,e);r.layers=this.layers,r.up.set(0,0,-1),r.lookAt(new pi(0,-1,0)),this.add(r);const a=new Nn(Wn,1,t,e);a.layers=this.layers,a.up.set(0,-1,0),a.lookAt(new pi(0,0,1)),this.add(a);const h=new Nn(Wn,1,t,e);h.layers=this.layers,h.up.set(0,-1,0),h.lookAt(new pi(0,0,-1)),this.add(h),this.update=function(t,e){null===this.parent&&this.updateMatrixWorld();const l=t.xr.enabled,c=t.getRenderTarget();t.xr.enabled=!1;const d=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,t.setRenderTarget(i,0),t.render(e,s),t.setRenderTarget(i,1),t.render(e,n),t.setRenderTarget(i,2),t.render(e,o),t.setRenderTarget(i,3),t.render(e,r),t.setRenderTarget(i,4),t.render(e,a),i.texture.generateMipmaps=d,t.setRenderTarget(i,5),t.render(e,h),t.setRenderTarget(c),t.xr.enabled=l}}function Un(t,e,i,s,n,o,r,a,h,l){t=void 0!==t?t:[],e=void 0!==e?e:J,r=void 0!==r?r:Et,ai.call(this,t,e,i,s,n,o,r,a,h,l),this.flipY=!1,this._needsFlipEnvMap=!0}function Vn(t,e,i){Number.isInteger(e)&&(console.warn("THREE.WebGLCubeRenderTarget: constructor signature is now WebGLCubeRenderTarget( size, options )"),e=i),ci.call(this,t,t,e),e=e||{},this.texture=new Un(void 0,e.mapping,e.wrapS,e.wrapT,e.magFilter,e.minFilter,e.format,e.type,e.anisotropy,e.encoding),this.texture._needsFlipEnvMap=!1}function Gn(t,e,i,s,n,o,r,a,h,l,c,d){ai.call(this,null,o,r,a,h,l,s,n,c,d),this.image={data:t||null,width:e||1,height:i||1},this.magFilter=void 0!==h?h:at,this.minFilter=void 0!==l?l:at,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}Hn.prototype=Object.create(us.prototype),Hn.prototype.constructor=Hn,Un.prototype=Object.create(ai.prototype),Un.prototype.constructor=Un,Un.prototype.isCubeTexture=!0,Object.defineProperty(Un.prototype,"images",{get:function(){return this.image},set:function(t){this.image=t}}),Vn.prototype=Object.create(ci.prototype),Vn.prototype.constructor=Vn,Vn.prototype.isWebGLCubeRenderTarget=!0,Vn.prototype.fromEquirectangularTexture=function(t,e){this.texture.type=e.type,this.texture.format=Lt,this.texture.encoding=e.encoding,this.texture.generateMipmaps=e.generateMipmaps,this.texture.minFilter=e.minFilter,this.texture.magFilter=e.magFilter;const i={tEquirect:{value:null}},s="\n\n\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t#include <begin_vertex>\n\t\t\t\t#include <project_vertex>\n\n\t\t\t}\n\t\t",n="\n\n\t\t\tuniform sampler2D tEquirect;\n\n\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t}\n\t\t",o=new kn(5,5,5),r=new zn({name:"CubemapFromEquirect",uniforms:Bn(i),vertexShader:s,fragmentShader:n,side:d,blending:p});r.uniforms.tEquirect.value=e;const a=new Cn(o,r),h=e.minFilter;return e.minFilter===ut&&(e.minFilter=ct),new Hn(1,10,this).update(t,a),e.minFilter=h,a.geometry.dispose(),a.material.dispose(),this},Vn.prototype.clear=function(t,e,i,s){const n=t.getRenderTarget();for(let n=0;n<6;n++)t.setRenderTarget(this,n),t.clear(e,i,s);t.setRenderTarget(n)},Gn.prototype=Object.create(ai.prototype),Gn.prototype.constructor=Gn,Gn.prototype.isDataTexture=!0;const jn=new Bi,qn=new pi;class $n{constructor(t,e,i,s,n,o){this.planes=[void 0!==t?t:new gs,void 0!==e?e:new gs,void 0!==i?i:new gs,void 0!==s?s:new gs,void 0!==n?n:new gs,void 0!==o?o:new gs]}set(t,e,i,s,n,o){const r=this.planes;return r[0].copy(t),r[1].copy(e),r[2].copy(i),r[3].copy(s),r[4].copy(n),r[5].copy(o),this}clone(){return(new this.constructor).copy(this)}copy(t){const e=this.planes;for(let i=0;i<6;i++)e[i].copy(t.planes[i]);return this}setFromProjectionMatrix(t){const e=this.planes,i=t.elements,s=i[0],n=i[1],o=i[2],r=i[3],a=i[4],h=i[5],l=i[6],c=i[7],d=i[8],u=i[9],p=i[10],m=i[11],f=i[12],g=i[13],y=i[14],v=i[15];return e[0].setComponents(r-s,c-a,m-d,v-f).normalize(),e[1].setComponents(r+s,c+a,m+d,v+f).normalize(),e[2].setComponents(r+n,c+h,m+u,v+g).normalize(),e[3].setComponents(r-n,c-h,m-u,v-g).normalize(),e[4].setComponents(r-o,c-l,m-p,v-y).normalize(),e[5].setComponents(r+o,c+l,m+p,v+y).normalize(),this}intersectsObject(t){const e=t.geometry;return null===e.boundingSphere&&e.computeBoundingSphere(),jn.copy(e.boundingSphere).applyMatrix4(t.matrixWorld),this.intersectsSphere(jn)}intersectsSprite(t){return jn.center.set(0,0,0),jn.radius=.7071067811865476,jn.applyMatrix4(t.matrixWorld),this.intersectsSphere(jn)}intersectsSphere(t){const e=this.planes,i=t.center,s=-t.radius;for(let t=0;t<6;t++)if(e[t].distanceToPoint(i)<s)return!1;return!0}intersectsBox(t){const e=this.planes;for(let i=0;i<6;i++){const s=e[i];if(qn.x=s.normal.x>0?t.max.x:t.min.x,qn.y=s.normal.y>0?t.max.y:t.min.y,qn.z=s.normal.z>0?t.max.z:t.min.z,s.distanceToPoint(qn)<0)return!1}return!0}containsPoint(t){const e=this.planes;for(let i=0;i<6;i++)if(e[i].distanceToPoint(t)<0)return!1;return!0}}function Xn(){let t=null,e=!1,i=null,s=null;function n(e,o){i(e,o),s=t.requestAnimationFrame(n)}return{start:function(){!0!==e&&null!==i&&(s=t.requestAnimationFrame(n),e=!0)},stop:function(){t.cancelAnimationFrame(s),e=!1},setAnimationLoop:function(t){i=t},setContext:function(e){t=e}}}function Yn(t,e){const i=e.isWebGL2,s=new WeakMap;return{get:function(t){return t.isInterleavedBufferAttribute&&(t=t.data),s.get(t)},remove:function(e){e.isInterleavedBufferAttribute&&(e=e.data);const i=s.get(e);i&&(t.deleteBuffer(i.buffer),s.delete(e))},update:function(e,n){if(e.isGLBufferAttribute){const t=s.get(e);return void((!t||t.version<e.version)&&s.set(e,{buffer:e.buffer,type:e.type,bytesPerElement:e.elementSize,version:e.version}))}e.isInterleavedBufferAttribute&&(e=e.data);const o=s.get(e);void 0===o?s.set(e,function(e,s){const n=e.array,o=e.usage,r=t.createBuffer();t.bindBuffer(s,r),t.bufferData(s,n,o),e.onUploadCallback();let a=5126;return n instanceof Float32Array?a=5126:n instanceof Float64Array?console.warn("THREE.WebGLAttributes: Unsupported data buffer format: Float64Array."):n instanceof Uint16Array?e.isFloat16BufferAttribute?i?a=5131:console.warn("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2."):a=5123:n instanceof Int16Array?a=5122:n instanceof Uint32Array?a=5125:n instanceof Int32Array?a=5124:n instanceof Int8Array?a=5120:n instanceof Uint8Array&&(a=5121),{buffer:r,type:a,bytesPerElement:n.BYTES_PER_ELEMENT,version:e.version}}(e,n)):o.version<e.version&&(function(e,s,n){const o=s.array,r=s.updateRange;t.bindBuffer(n,e),-1===r.count?t.bufferSubData(n,0,o):(i?t.bufferSubData(n,r.offset*o.BYTES_PER_ELEMENT,o,r.offset,r.count):t.bufferSubData(n,r.offset*o.BYTES_PER_ELEMENT,o.subarray(r.offset,r.offset+r.count)),r.count=-1)}(o.buffer,e,n),o.version=e.version)}}}class Zn extends cn{constructor(t=1,e=1,i=1,s=1){super(),this.type="PlaneBufferGeometry",this.parameters={width:t,height:e,widthSegments:i,heightSegments:s};const n=t/2,o=e/2,r=Math.floor(i),a=Math.floor(s),h=r+1,l=a+1,c=t/r,d=e/a,u=[],p=[],m=[],f=[];for(let t=0;t<l;t++){const e=t*d-o;for(let i=0;i<h;i++){const s=i*c-n;p.push(s,-e,0),m.push(0,0,1),f.push(i/r),f.push(1-t/a)}}for(let t=0;t<a;t++)for(let e=0;e<r;e++){const i=e+h*t,s=e+h*(t+1),n=e+1+h*(t+1),o=e+1+h*t;u.push(i,s,o),u.push(s,n,o)}this.setIndex(u),this.setAttribute("position",new Zs(p,3)),this.setAttribute("normal",new Zs(m,3)),this.setAttribute("uv",new Zs(f,2))}}const Kn={alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef ALPHATEST\n\tif ( diffuseColor.a < ALPHATEST ) discard;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex:"vec3 transformed = vec3( position );",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"vec2 integrateSpecularBRDF( const in float dotNV, const in float roughness ) {\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\treturn vec2( -1.04, 1.04 ) * a004 + r.zw;\n}\nfloat punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\tif( cutoffDistance > 0.0 ) {\n\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t}\n\treturn distanceFalloff;\n#else\n\tif( cutoffDistance > 0.0 && decayExponent > 0.0 ) {\n\t\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\t}\n\treturn 1.0;\n#endif\n}\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n}\nvec3 F_Schlick_RoughnessDependent( const in vec3 F0, const in float dotNV, const in float roughness ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotNV - 6.98316 ) * dotNV );\n\tvec3 Fr = max( vec3( 1.0 - roughness ), F0 ) - F0;\n\treturn Fr * fresnel + F0;\n}\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\treturn 1.0 / ( gl * gv );\n}\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float roughness ) {\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( incidentLight.direction + viewDir );\n\tfloat dotNL = saturate( dot( normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\tfloat D = D_GGX( alpha, dotNH );\n\treturn F * ( G * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\nvec3 BRDF_Specular_GGX_Environment( const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tvec2 brdf = integrateSpecularBRDF( dotNV, roughness );\n\treturn specularColor * brdf.x + brdf.y;\n}\nvoid BRDF_Specular_Multiscattering_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tvec3 F = F_Schlick_RoughnessDependent( specularColor, dotNV, roughness );\n\tvec2 brdf = integrateSpecularBRDF( dotNV, roughness );\n\tvec3 FssEss = F * brdf.x + brdf.y;\n\tfloat Ess = brdf.x + brdf.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = specularColor + ( 1.0 - specularColor ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\nfloat G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n}\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie(float roughness, float NoH) {\n\tfloat invAlpha = 1.0 / roughness;\n\tfloat cos2h = NoH * NoH;\n\tfloat sin2h = max(1.0 - cos2h, 0.0078125);\treturn (2.0 + invAlpha) * pow(sin2h, invAlpha * 0.5) / (2.0 * PI);\n}\nfloat V_Neubelt(float NoV, float NoL) {\n\treturn saturate(1.0 / (4.0 * (NoL + NoV - NoL * NoV)));\n}\nvec3 BRDF_Specular_Sheen( const in float roughness, const in vec3 L, const in GeometricContext geometry, vec3 specularColor ) {\n\tvec3 N = geometry.normal;\n\tvec3 V = geometry.viewDir;\n\tvec3 H = normalize( V + L );\n\tfloat dotNH = saturate( dot( N, H ) );\n\treturn specularColor * D_Charlie( roughness, dotNH ) * V_Neubelt( dot(N, V), dot(N, L) );\n}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\n\t\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );\n\t\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 );\n\t\tfDet *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\tplane = clippingPlanes[ i ];\n\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t#pragma unroll_loop_end\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\tif ( clipped ) discard;\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#ifdef USE_COLOR\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor.xyz *= color.xyz;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement(a) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract(sin(sn) * c);\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat max3( vec3 v ) { return max( max( v.x, v.y ), v.z ); }\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n#ifdef CLEARCOAT\n\tvec3 clearcoatNormal;\n#endif\n};\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\tfloat distance = dot( planeNormal, point - pointOnPlane );\n\treturn - distance * planeNormal + point;\n}\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn sign( dot( point - pointOnPlane, planeNormal ) );\n}\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat linearToRelativeLuminance( const in vec3 color ) {\n\tvec3 weights = vec3( 0.2126, 0.7152, 0.0722 );\n\treturn dot( weights, color.rgb );\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_maxMipLevel 8.0\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_maxTileSize 256.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\tfloat texelSize = 1.0 / ( 3.0 * cubeUV_maxTileSize );\n\t\tvec2 uv = getUV( direction, face ) * ( faceSize - 1.0 );\n\t\tvec2 f = fract( uv );\n\t\tuv += 0.5 - f;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tif ( mipInt < cubeUV_maxMipLevel ) {\n\t\t\tuv.y += 2.0 * cubeUV_maxTileSize;\n\t\t}\n\t\tuv.y += filterInt * 2.0 * cubeUV_minTileSize;\n\t\tuv.x += 3.0 * max( 0.0, cubeUV_maxTileSize - 2.0 * faceSize );\n\t\tuv *= texelSize;\n\t\tvec3 tl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.x += texelSize;\n\t\tvec3 tr = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.y += texelSize;\n\t\tvec3 br = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.x -= texelSize;\n\t\tvec3 bl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tvec3 tm = mix( tl, tr, f.x );\n\t\tvec3 bm = mix( bl, br, f.x );\n\t\treturn mix( tm, bm, f.y );\n\t}\n\t#define r0 1.0\n\t#define v0 0.339\n\t#define m0 - 2.0\n\t#define r1 0.8\n\t#define v1 0.276\n\t#define m1 - 1.0\n\t#define r4 0.4\n\t#define v4 0.046\n\t#define m4 2.0\n\t#define r5 0.305\n\t#define v5 0.016\n\t#define m5 3.0\n\t#define r6 0.21\n\t#define v6 0.0038\n\t#define m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= r1 ) {\n\t\t\tmip = ( r0 - roughness ) * ( m1 - m0 ) / ( r0 - r1 ) + m0;\n\t\t} else if ( roughness >= r4 ) {\n\t\t\tmip = ( r1 - roughness ) * ( m4 - m1 ) / ( r1 - r4 ) + m1;\n\t\t} else if ( roughness >= r5 ) {\n\t\t\tmip = ( r4 - roughness ) * ( m5 - m4 ) / ( r4 - r5 ) + m4;\n\t\t} else if ( roughness >= r6 ) {\n\t\t\tmip = ( r5 - roughness ) * ( m6 - m5 ) / ( r5 - r6 ) + m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), m0, cubeUV_maxMipLevel );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_INSTANCING\n\tmat3 m = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n\ttransformedNormal = m * transformedNormal;\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",encodings_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",encodings_pars_fragment:"\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.rgb, vec3( gammaFactor ) ), value.a );\n}\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.rgb, vec3( 1.0 / gammaFactor ) ), value.a );\n}\nvec4 sRGBToLinear( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}\nvec4 RGBEToLinear( in vec4 value ) {\n\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\nvec4 LinearToRGBE( in vec4 value ) {\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n}\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * value.a * maxRange, 1.0 );\n}\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.r, max( value.g, value.b ) );\n\tfloat M = clamp( maxRGB / maxRange, 0.0, 1.0 );\n\tM = ceil( M * 255.0 ) / 255.0;\n\treturn vec4( value.rgb / ( M * maxRange ), M );\n}\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\n}\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.r, max( value.g, value.b ) );\n\tfloat D = max( maxRange / maxRGB, 1.0 );\n\tD = clamp( floor( D ) / 255.0, 0.0, 1.0 );\n\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\n}\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\nvec4 LinearToLogLuv( in vec4 value ) {\n\tvec3 Xp_Y_XYZp = cLogLuvM * value.rgb;\n\tXp_Y_XYZp = max( Xp_Y_XYZp, vec3( 1e-6, 1e-6, 1e-6 ) );\n\tvec4 vResult;\n\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\n\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\n\tvResult.w = fract( Le );\n\tvResult.z = ( Le - ( floor( vResult.w * 255.0 ) ) / 255.0 ) / 255.0;\n\treturn vResult;\n}\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\nvec4 LogLuvToLinear( in vec4 value ) {\n\tfloat Le = value.z * 255.0 + value.w;\n\tvec3 Xp_Y_XYZp;\n\tXp_Y_XYZp.y = exp2( ( Le - 127.0 ) / 2.0 );\n\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\n\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\n\tvec3 vRGB = cLogLuvInverseM * Xp_Y_XYZp.rgb;\n\treturn vec4( max( vRGB, 0.0 ), 1.0 );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 envColor = textureCubeUV( envMap, reflectVec, 0.0 );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifndef ENVMAP_TYPE_CUBE_UV\n\t\tenvColor = envMapTexelToLinear( envColor );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\tuniform int maxMipLevel;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) ||defined( PHONG )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#if defined( USE_ENVMAP )\n\t#ifdef ENVMAP_MODE_REFRACTION\n\t\tuniform float refractionRatio;\n\t#endif\n\tvec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {\n\t\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );\n\t\t#else\n\t\t\tvec4 envMapColor = vec4( 0.0 );\n\t\t#endif\n\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t}\n\tfloat getSpecularMIPLevel( const in float roughness, const in int maxMIPLevel ) {\n\t\tfloat maxMIPLevelScalar = float( maxMIPLevel );\n\t\tfloat sigma = PI * roughness * roughness / ( 1.0 + roughness );\n\t\tfloat desiredMIPLevel = maxMIPLevelScalar + log2( sigma );\n\t\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\t}\n\tvec3 getLightProbeIndirectRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in int maxMIPLevel ) {\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( -viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( -viewDir, normal, refractionRatio );\n\t\t#endif\n\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\tfloat specularMIPLevel = getSpecularMIPLevel( roughness, maxMIPLevel );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );\n\t\t#endif\n\t\treturn envMapColor.rgb * envMapIntensity;\n\t}\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tfogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float fogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * fogDepth * fogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float fogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn texture2D( gradientMap, coord ).rgb;\n\t#else\n\t\treturn ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );\n\t#endif\n}",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\treflectedLight.indirectDiffuse += PI * lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_vertex:"vec3 diffuse = vec3( 1.0 );\nGeometricContext geometry;\ngeometry.position = mvPosition.xyz;\ngeometry.normal = normalize( transformedNormal );\ngeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( -mvPosition.xyz );\nGeometricContext backGeometry;\nbackGeometry.position = geometry.position;\nbackGeometry.normal = -geometry.normal;\nbackGeometry.viewDir = geometry.viewDir;\nvLightFront = vec3( 0.0 );\nvIndirectFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\n\tvLightBack = vec3( 0.0 );\n\tvIndirectBack = vec3( 0.0 );\n#endif\nIncidentLight directLight;\nfloat dotNL;\nvec3 directLightColor_Diffuse;\nvIndirectFront += getAmbientLightIrradiance( ambientLightColor );\nvIndirectFront += getLightProbeIrradiance( lightProbe, geometry );\n#ifdef DOUBLE_SIDED\n\tvIndirectBack += getAmbientLightIrradiance( ambientLightColor );\n\tvIndirectBack += getLightProbeIrradiance( lightProbe, backGeometry );\n#endif\n#if NUM_POINT_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tgetPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tgetSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_DIR_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tgetDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\tvIndirectFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvIndirectBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\nuniform vec3 lightProbe[ 9 ];\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in GeometricContext geometry ) {\n\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treturn irradiance;\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tdirectLight.color = directionalLight.color;\n\t\tdirectLight.direction = directionalLight.direction;\n\t\tdirectLight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tdirectLight.color = pointLight.color;\n\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\t\tif ( angleCos > spotLight.coneCos ) {\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\t\tdirectLight.color = spotLight.color;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\t\t} else {\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {\n\t\tfloat dotNL = dot( geometry.normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tirradiance *= PI;\n\t\t#endif\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon\n#define Material_LightProbeLOD( material )\t(0)",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong\n#define Material_LightProbeLOD( material )\t(0)",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.specularRoughness = max( roughnessFactor, 0.0525 );material.specularRoughness += geometryRoughness;\nmaterial.specularRoughness = min( material.specularRoughness, 1.0 );\n#ifdef REFLECTIVITY\n\tmaterial.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n#endif\n#ifdef CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheen;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat specularRoughness;\n\tvec3 specularColor;\n#ifdef CLEARCOAT\n\tfloat clearcoat;\n\tfloat clearcoatRoughness;\n#endif\n#ifdef USE_SHEEN\n\tvec3 sheenColor;\n#endif\n};\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\nfloat clearcoatDHRApprox( const in float roughness, const in float dotNL ) {\n\treturn DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.specularRoughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\t#ifdef CLEARCOAT\n\t\tfloat ccDotNL = saturate( dot( geometry.clearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = ccDotNL * directLight.color;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tccIrradiance *= PI;\n\t\t#endif\n\t\tfloat clearcoatDHR = material.clearcoat * clearcoatDHRApprox( material.clearcoatRoughness, ccDotNL );\n\t\treflectedLight.directSpecular += ccIrradiance * material.clearcoat * BRDF_Specular_GGX( directLight, geometry.viewDir, geometry.clearcoatNormal, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearcoatRoughness );\n\t#else\n\t\tfloat clearcoatDHR = 0.0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\treflectedLight.directSpecular += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Specular_Sheen(\n\t\t\tmaterial.specularRoughness,\n\t\t\tdirectLight.direction,\n\t\t\tgeometry,\n\t\t\tmaterial.sheenColor\n\t\t);\n\t#else\n\t\treflectedLight.directSpecular += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry.viewDir, geometry.normal, material.specularColor, material.specularRoughness);\n\t#endif\n\treflectedLight.directDiffuse += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef CLEARCOAT\n\t\tfloat ccDotNV = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular += clearcoatRadiance * material.clearcoat * BRDF_Specular_GGX_Environment( geometry.viewDir, geometry.clearcoatNormal, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearcoatRoughness );\n\t\tfloat ccDotNL = ccDotNV;\n\t\tfloat clearcoatDHR = material.clearcoat * clearcoatDHRApprox( material.clearcoatRoughness, ccDotNL );\n\t#else\n\t\tfloat clearcoatDHR = 0.0;\n\t#endif\n\tfloat clearcoatInv = 1.0 - clearcoatDHR;\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\tBRDF_Specular_Multiscattering_Environment( geometry, material.specularColor, material.specularRoughness, singleScattering, multiScattering );\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - ( singleScattering + multiScattering ) );\n\treflectedLight.indirectSpecular += clearcoatInv * radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nGeometricContext geometry;\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\n#ifdef CLEARCOAT\n\tgeometry.clearcoatNormal = clearcoatNormal;\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\tirradiance += getLightProbeIrradiance( lightProbe, geometry );\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\t\tvec3 lightMapIrradiance = lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tlightMapIrradiance *= PI;\n\t\t#endif\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getLightProbeIndirectIrradiance( geometry, maxMipLevel );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\tradiance += getLightProbeIndirectRadiance( geometry.viewDir, geometry.normal, material.specularRoughness, maxMipLevel );\n\t#ifdef CLEARCOAT\n\t\tclearcoatRadiance += getLightProbeIndirectRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness, maxMipLevel );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometry, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t\tvarying float vIsPerspective;\n\t#else\n\t\tuniform float logDepthBufFC;\n\t#endif\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n\t#else\n\t\tif ( isPerspectiveMatrix( projectionMatrix ) ) {\n\t\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\t\tgl_Position.z *= gl_Position.w;\n\t\t}\n\t#endif\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 texelColor = texture2D( map, vUv );\n\ttexelColor = mapTexelToLinear( texelColor );\n\tdiffuseColor *= texelColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n#endif\n#ifdef USE_MAP\n\tvec4 mapTexel = texture2D( map, uv );\n\tdiffuseColor *= mapTexelToLinear( mapTexel );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\tuniform mat3 uvTransform;\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\n\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\n\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\n\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\tuniform float morphTargetBaseInfluence;\n\t#ifndef USE_MORPHNORMALS\n\t\tuniform float morphTargetInfluences[ 8 ];\n\t#else\n\t\tuniform float morphTargetInfluences[ 4 ];\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\n\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\n\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\n\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\n\t#ifndef USE_MORPHNORMALS\n\t\ttransformed += morphTarget4 * morphTargetInfluences[ 4 ];\n\t\ttransformed += morphTarget5 * morphTargetInfluences[ 5 ];\n\t\ttransformed += morphTarget6 * morphTargetInfluences[ 6 ];\n\t\ttransformed += morphTarget7 * morphTargetInfluences[ 7 ];\n\t#endif\n#endif",normal_fragment_begin:"#ifdef FLAT_SHADED\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t#endif\n\t#ifdef USE_TANGENT\n\t\tvec3 tangent = normalize( vTangent );\n\t\tvec3 bitangent = normalize( vBitangent );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\ttangent = tangent * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\t\tbitangent = bitangent * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\t#endif\n\t\t#if defined( TANGENTSPACE_NORMALMAP ) || defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tmat3 vTBN = mat3( tangent, bitangent, normal );\n\t\t#endif\n\t#endif\n#endif\nvec3 geometryNormal = normal;",normal_fragment_maps:"#ifdef OBJECTSPACE_NORMALMAP\n\tnormal = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( TANGENTSPACE_NORMALMAP )\n\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\t#ifdef USE_TANGENT\n\t\tnormal = normalize( vTBN * mapN );\n\t#else\n\t\tnormal = perturbNormal2Arb( -vViewPosition, normal, mapN );\n\t#endif\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( TANGENTSPACE_NORMALMAP ) || defined ( USE_CLEARCOAT_NORMALMAP ) )\n\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec3 mapN ) {\n\t\tvec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );\n\t\tvec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );\n\t\tvec2 st0 = dFdx( vUv.st );\n\t\tvec2 st1 = dFdy( vUv.st );\n\t\tfloat scale = sign( st1.t * st0.s - st0.t * st1.s );\n\t\tvec3 S = normalize( ( q0 * st1.t - q1 * st0.t ) * scale );\n\t\tvec3 T = normalize( ( - q0 * st1.s + q1 * st0.s ) * scale );\n\t\tvec3 N = normalize( surf_norm );\n\t\tmat3 tsn = mat3( S, T, N );\n\t\tmapN.xy *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\treturn normalize( tsn * mapN );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef CLEARCOAT\n\tvec3 clearcoatNormal = geometryNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\t#ifdef USE_TANGENT\n\t\tclearcoatNormal = normalize( vTBN * clearcoatMapN );\n\t#else\n\t\tclearcoatNormal = perturbNormal2Arb( - vViewPosition, clearcoatNormal, clearcoatMapN );\n\t#endif\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nvec4 pack2HalfToRGBA( vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ));\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w);\n}\nvec2 unpackRGBATo2Half( vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n\treturn linearClipZ * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn (( near + viewZ ) * far ) / (( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\t\tbool frustumTest = all( frustumTestVec );\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ), \n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ), \n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0 || NUM_SPOT_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0\n\t\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\tvec4 shadowWorldPosition;\n\t#endif\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\t#ifdef BONE_TEXTURE\n\t\tuniform highp sampler2D boneTexture;\n\t\tuniform int boneTextureSize;\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tfloat j = i * 4.0;\n\t\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\t\ty = dy * ( y + 0.5 );\n\t\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\t\treturn bone;\n\t\t}\n\t#else\n\t\tuniform mat4 boneMatrices[ MAX_BONES ];\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tmat4 bone = boneMatrices[ int(i) ];\n\t\t\treturn bone;\n\t\t}\n\t#endif\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn toneMappingExposure * color;\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmissionmap_fragment:"#ifdef USE_TRANSMISSIONMAP\n\ttotalTransmission *= texture2D( transmissionMap, vUv ).r;\n#endif",transmissionmap_pars_fragment:"#ifdef USE_TRANSMISSIONMAP\n\tuniform sampler2D transmissionMap;\n#endif",uv_pars_fragment:"#if ( defined( USE_UV ) && ! defined( UVS_VERTEX_ONLY ) )\n\tvarying vec2 vUv;\n#endif",uv_pars_vertex:"#ifdef USE_UV\n\t#ifdef UVS_VERTEX_ONLY\n\t\tvec2 vUv;\n\t#else\n\t\tvarying vec2 vUv;\n\t#endif\n\tuniform mat3 uvTransform;\n#endif",uv_vertex:"#ifdef USE_UV\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n#endif",uv2_pars_fragment:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvarying vec2 vUv2;\n#endif",uv2_pars_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n\tuniform mat3 uv2Transform;\n#endif",uv2_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvUv2 = ( uv2Transform * vec3( uv2, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_frag:"uniform sampler2D t2D;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\tgl_FragColor = mapTexelToLinear( texColor );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",cube_frag:"#include <envmap_common_pars_fragment>\nuniform float opacity;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\tvec3 vReflect = vWorldDirection;\n\t#include <envmap_fragment>\n\tgl_FragColor = envColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#endif\n}",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tvec4 texColor = texture2D( tEquirect, sampleUV );\n\tgl_FragColor = mapTexelToLinear( texColor );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\n\t\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\t\treflectedLight.indirectDiffuse += lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_ENVMAP\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"uniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <emissivemap_fragment>\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.indirectDiffuse += ( gl_FrontFacing ) ? vIndirectFront : vIndirectBack;\n\t#else\n\t\treflectedLight.indirectDiffuse += vIndirectFront;\n\t#endif\n\t#include <lightmap_fragment>\n\treflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\t#else\n\t\treflectedLight.directDiffuse = vLightFront;\n\t#endif\n\treflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <lights_lambert_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t\tmatcapColor = matcapTexelToLinear( matcapColor );\n\t#else\n\t\tvec4 matcapColor = vec4( 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#ifndef FLAT_SHADED\n\t\tvNormal = normalize( transformedNormal );\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define REFLECTIVITY\n\t#define CLEARCOAT\n\t#define TRANSMISSION\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef TRANSMISSION\n\tuniform float transmission;\n#endif\n#ifdef REFLECTIVITY\n\tuniform float reflectivity;\n#endif\n#ifdef CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheen;\n#endif\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <transmissionmap_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#ifdef TRANSMISSION\n\t\tfloat totalTransmission = transmission;\n\t#endif\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <transmissionmap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#ifdef TRANSMISSION\n\t\tdiffuseColor.a *= mix( saturate( 1. - totalTransmission + linearToRelativeLuminance( reflectedLight.directSpecular + reflectedLight.indirectSpecular ) ), 1.0, metalness );\n\t#endif\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",normal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n}",normal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",shadow_vert:"#include <common>\n#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}"},Jn={common:{diffuse:{value:new Ds(15658734)},opacity:{value:1},map:{value:null},uvTransform:{value:new si},uv2Transform:{value:new si},alphaMap:{value:null}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98},maxMipLevel:{value:0}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new ii(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Ds(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new Ds(15658734)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},uvTransform:{value:new si}},sprite:{diffuse:{value:new Ds(15658734)},opacity:{value:1},center:{value:new ii(.5,.5)},rotation:{value:0},map:{value:null},alphaMap:{value:null},uvTransform:{value:new si}}},Qn={basic:{uniforms:Rn([Jn.common,Jn.specularmap,Jn.envmap,Jn.aomap,Jn.lightmap,Jn.fog]),vertexShader:Kn.meshbasic_vert,fragmentShader:Kn.meshbasic_frag},lambert:{uniforms:Rn([Jn.common,Jn.specularmap,Jn.envmap,Jn.aomap,Jn.lightmap,Jn.emissivemap,Jn.fog,Jn.lights,{emissive:{value:new Ds(0)}}]),vertexShader:Kn.meshlambert_vert,fragmentShader:Kn.meshlambert_frag},phong:{uniforms:Rn([Jn.common,Jn.specularmap,Jn.envmap,Jn.aomap,Jn.lightmap,Jn.emissivemap,Jn.bumpmap,Jn.normalmap,Jn.displacementmap,Jn.fog,Jn.lights,{emissive:{value:new Ds(0)},specular:{value:new Ds(1118481)},shininess:{value:30}}]),vertexShader:Kn.meshphong_vert,fragmentShader:Kn.meshphong_frag},standard:{uniforms:Rn([Jn.common,Jn.envmap,Jn.aomap,Jn.lightmap,Jn.emissivemap,Jn.bumpmap,Jn.normalmap,Jn.displacementmap,Jn.roughnessmap,Jn.metalnessmap,Jn.fog,Jn.lights,{emissive:{value:new Ds(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:Kn.meshphysical_vert,fragmentShader:Kn.meshphysical_frag},toon:{uniforms:Rn([Jn.common,Jn.aomap,Jn.lightmap,Jn.emissivemap,Jn.bumpmap,Jn.normalmap,Jn.displacementmap,Jn.gradientmap,Jn.fog,Jn.lights,{emissive:{value:new Ds(0)}}]),vertexShader:Kn.meshtoon_vert,fragmentShader:Kn.meshtoon_frag},matcap:{uniforms:Rn([Jn.common,Jn.bumpmap,Jn.normalmap,Jn.displacementmap,Jn.fog,{matcap:{value:null}}]),vertexShader:Kn.meshmatcap_vert,fragmentShader:Kn.meshmatcap_frag},points:{uniforms:Rn([Jn.points,Jn.fog]),vertexShader:Kn.points_vert,fragmentShader:Kn.points_frag},dashed:{uniforms:Rn([Jn.common,Jn.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:Kn.linedashed_vert,fragmentShader:Kn.linedashed_frag},depth:{uniforms:Rn([Jn.common,Jn.displacementmap]),vertexShader:Kn.depth_vert,fragmentShader:Kn.depth_frag},normal:{uniforms:Rn([Jn.common,Jn.bumpmap,Jn.normalmap,Jn.displacementmap,{opacity:{value:1}}]),vertexShader:Kn.normal_vert,fragmentShader:Kn.normal_frag},sprite:{uniforms:Rn([Jn.sprite,Jn.fog]),vertexShader:Kn.sprite_vert,fragmentShader:Kn.sprite_frag},background:{uniforms:{uvTransform:{value:new si},t2D:{value:null}},vertexShader:Kn.background_vert,fragmentShader:Kn.background_frag},cube:{uniforms:Rn([Jn.envmap,{opacity:{value:1}}]),vertexShader:Kn.cube_vert,fragmentShader:Kn.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:Kn.equirect_vert,fragmentShader:Kn.equirect_frag},distanceRGBA:{uniforms:Rn([Jn.common,Jn.displacementmap,{referencePosition:{value:new pi},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:Kn.distanceRGBA_vert,fragmentShader:Kn.distanceRGBA_frag},shadow:{uniforms:Rn([Jn.lights,Jn.fog,{color:{value:new Ds(0)},opacity:{value:1}}]),vertexShader:Kn.shadow_vert,fragmentShader:Kn.shadow_frag}};function to(t,e,i,s,n){const o=new Ds(0);let r,a,h=0,l=null,u=0,p=null;function m(t,e){i.buffers.color.setClear(t.r,t.g,t.b,e,n)}return{getClearColor:function(){return o},setClearColor:function(t,e=1){o.set(t),h=e,m(o,h)},getClearAlpha:function(){return h},setClearAlpha:function(t){h=t,m(o,h)},render:function(i,n,f,g){let y=!0===n.isScene?n.background:null;y&&y.isTexture&&(y=e.get(y));const v=t.xr,w=v.getSession&&v.getSession();w&&"additive"===w.environmentBlendMode&&(y=null),null===y?m(o,h):y&&y.isColor&&(m(y,1),g=!0),(t.autoClear||g)&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),y&&(y.isCubeTexture||y.isWebGLCubeRenderTarget||y.mapping===it)?(void 0===a&&(a=new Cn(new kn(1,1,1),new zn({name:"BackgroundCubeMaterial",uniforms:Bn(Qn.cube.uniforms),vertexShader:Qn.cube.vertexShader,fragmentShader:Qn.cube.fragmentShader,side:d,depthTest:!1,depthWrite:!1,fog:!1})),a.geometry.deleteAttribute("normal"),a.geometry.deleteAttribute("uv"),a.onBeforeRender=function(t,e,i){this.matrixWorld.copyPosition(i.matrixWorld)},Object.defineProperty(a.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),s.update(a)),y.isWebGLCubeRenderTarget&&(y=y.texture),a.material.uniforms.envMap.value=y,a.material.uniforms.flipEnvMap.value=y.isCubeTexture&&y._needsFlipEnvMap?-1:1,l===y&&u===y.version&&p===t.toneMapping||(a.material.needsUpdate=!0,l=y,u=y.version,p=t.toneMapping),i.unshift(a,a.geometry,a.material,0,0,null)):y&&y.isTexture&&(void 0===r&&(r=new Cn(new Zn(2,2),new zn({name:"BackgroundMaterial",uniforms:Bn(Qn.background.uniforms),vertexShader:Qn.background.vertexShader,fragmentShader:Qn.background.fragmentShader,side:c,depthTest:!1,depthWrite:!1,fog:!1})),r.geometry.deleteAttribute("normal"),Object.defineProperty(r.material,"map",{get:function(){return this.uniforms.t2D.value}}),s.update(r)),r.material.uniforms.t2D.value=y,!0===y.matrixAutoUpdate&&y.updateMatrix(),r.material.uniforms.uvTransform.value.copy(y.matrix),l===y&&u===y.version&&p===t.toneMapping||(r.material.needsUpdate=!0,l=y,u=y.version,p=t.toneMapping),i.unshift(r,r.geometry,r.material,0,0,null))}}}function eo(t,e,i,s){const n=t.getParameter(34921),o=s.isWebGL2?null:e.get("OES_vertex_array_object"),r=s.isWebGL2||null!==o,a={},h=u(null);let l=h;function c(e){return s.isWebGL2?t.bindVertexArray(e):o.bindVertexArrayOES(e)}function d(e){return s.isWebGL2?t.deleteVertexArray(e):o.deleteVertexArrayOES(e)}function u(t){const e=[],i=[],s=[];for(let t=0;t<n;t++)e[t]=0,i[t]=0,s[t]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:e,enabledAttributes:i,attributeDivisors:s,object:t,attributes:{},index:null}}function p(){const t=l.newAttributes;for(let e=0,i=t.length;e<i;e++)t[e]=0}function m(t){f(t,0)}function f(i,n){const o=l.newAttributes,r=l.enabledAttributes,a=l.attributeDivisors;o[i]=1,0===r[i]&&(t.enableVertexAttribArray(i),r[i]=1),a[i]!==n&&((s.isWebGL2?t:e.get("ANGLE_instanced_arrays"))[s.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](i,n),a[i]=n)}function g(){const e=l.newAttributes,i=l.enabledAttributes;for(let s=0,n=i.length;s<n;s++)i[s]!==e[s]&&(t.disableVertexAttribArray(s),i[s]=0)}function y(e,i,n,o,r,a){!0!==s.isWebGL2||5124!==n&&5125!==n?t.vertexAttribPointer(e,i,n,o,r,a):t.vertexAttribIPointer(e,i,n,r,a)}function v(){w(),l!==h&&(l=h,c(l.object))}function w(){h.geometry=null,h.program=null,h.wireframe=!1}return{setup:function(n,h,d,v,w){let x=!1;if(r){const e=function(e,i,n){const r=!0===n.wireframe;let h=a[e.id];void 0===h&&(h={},a[e.id]=h);let l=h[i.id];void 0===l&&(l={},h[i.id]=l);let c=l[r];return void 0===c&&(c=u(s.isWebGL2?t.createVertexArray():o.createVertexArrayOES()),l[r]=c),c}(v,d,h);l!==e&&(l=e,c(l.object)),x=function(t,e){const i=l.attributes,s=t.attributes;let n=0;for(const t in s){const e=i[t],o=s[t];if(void 0===e)return!0;if(e.attribute!==o)return!0;if(e.data!==o.data)return!0;n++}return l.attributesNum!==n||l.index!==e}(v,w),x&&function(t,e){const i={},s=t.attributes;let n=0;for(const t in s){const e=s[t],o={};o.attribute=e,e.data&&(o.data=e.data),i[t]=o,n++}l.attributes=i,l.attributesNum=n,l.index=e}(v,w)}else{const t=!0===h.wireframe;l.geometry===v.id&&l.program===d.id&&l.wireframe===t||(l.geometry=v.id,l.program=d.id,l.wireframe=t,x=!0)}!0===n.isInstancedMesh&&(x=!0),null!==w&&i.update(w,34963),x&&(function(n,o,r,a){if(!1===s.isWebGL2&&(n.isInstancedMesh||a.isInstancedBufferGeometry)&&null===e.get("ANGLE_instanced_arrays"))return;p();const h=a.attributes,l=r.getAttributes(),c=o.defaultAttributeValues;for(const e in l){const s=l[e];if(s>=0){const o=h[e];if(void 0!==o){const e=o.normalized,n=o.itemSize,r=i.get(o);if(void 0===r)continue;const h=r.buffer,l=r.type,c=r.bytesPerElement;if(o.isInterleavedBufferAttribute){const i=o.data,r=i.stride,d=o.offset;i&&i.isInstancedInterleavedBuffer?(f(s,i.meshPerAttribute),void 0===a._maxInstanceCount&&(a._maxInstanceCount=i.meshPerAttribute*i.count)):m(s),t.bindBuffer(34962,h),y(s,n,l,e,r*c,d*c)}else o.isInstancedBufferAttribute?(f(s,o.meshPerAttribute),void 0===a._maxInstanceCount&&(a._maxInstanceCount=o.meshPerAttribute*o.count)):m(s),t.bindBuffer(34962,h),y(s,n,l,e,0,0)}else if("instanceMatrix"===e){const e=i.get(n.instanceMatrix);if(void 0===e)continue;const o=e.buffer,r=e.type;f(s+0,1),f(s+1,1),f(s+2,1),f(s+3,1),t.bindBuffer(34962,o),t.vertexAttribPointer(s+0,4,r,!1,64,0),t.vertexAttribPointer(s+1,4,r,!1,64,16),t.vertexAttribPointer(s+2,4,r,!1,64,32),t.vertexAttribPointer(s+3,4,r,!1,64,48)}else if("instanceColor"===e){const e=i.get(n.instanceColor);if(void 0===e)continue;const o=e.buffer,r=e.type;f(s,1),t.bindBuffer(34962,o),t.vertexAttribPointer(s,3,r,!1,12,0)}else if(void 0!==c){const i=c[e];if(void 0!==i)switch(i.length){case 2:t.vertexAttrib2fv(s,i);break;case 3:t.vertexAttrib3fv(s,i);break;case 4:t.vertexAttrib4fv(s,i);break;default:t.vertexAttrib1fv(s,i)}}}}g()}(n,h,d,v),null!==w&&t.bindBuffer(34963,i.get(w).buffer))},reset:v,resetDefaultState:w,dispose:function(){v();for(const t in a){const e=a[t];for(const t in e){const i=e[t];for(const t in i)d(i[t].object),delete i[t];delete e[t]}delete a[t]}},releaseStatesOfGeometry:function(t){if(void 0===a[t.id])return;const e=a[t.id];for(const t in e){const i=e[t];for(const t in i)d(i[t].object),delete i[t];delete e[t]}delete a[t.id]},releaseStatesOfProgram:function(t){for(const e in a){const i=a[e];if(void 0===i[t.id])continue;const s=i[t.id];for(const t in s)d(s[t].object),delete s[t];delete i[t.id]}},initAttributes:p,enableAttribute:m,disableUnusedAttributes:g}}function io(t,e,i,s){const n=s.isWebGL2;let o;this.setMode=function(t){o=t},this.render=function(e,s){t.drawArrays(o,e,s),i.update(s,o,1)},this.renderInstances=function(s,r,a){if(0===a)return;let h,l;if(n)h=t,l="drawArraysInstanced";else if(h=e.get("ANGLE_instanced_arrays"),l="drawArraysInstancedANGLE",null===h)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");h[l](o,s,r,a),i.update(r,o,a)}}function so(t,e,i){let s;function n(e){if("highp"===e){if(t.getShaderPrecisionFormat(35633,36338).precision>0&&t.getShaderPrecisionFormat(35632,36338).precision>0)return"highp";e="mediump"}return"mediump"===e&&t.getShaderPrecisionFormat(35633,36337).precision>0&&t.getShaderPrecisionFormat(35632,36337).precision>0?"mediump":"lowp"}const o="undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext||"undefined"!=typeof WebGL2ComputeRenderingContext&&t instanceof WebGL2ComputeRenderingContext;let r=void 0!==i.precision?i.precision:"highp";const a=n(r);a!==r&&(console.warn("THREE.WebGLRenderer:",r,"not supported, using",a,"instead."),r=a);const h=!0===i.logarithmicDepthBuffer,l=t.getParameter(34930),c=t.getParameter(35660),d=t.getParameter(3379),u=t.getParameter(34076),p=t.getParameter(34921),m=t.getParameter(36347),f=t.getParameter(36348),g=t.getParameter(36349),y=c>0,v=o||!!e.get("OES_texture_float");return{isWebGL2:o,getMaxAnisotropy:function(){if(void 0!==s)return s;const i=e.get("EXT_texture_filter_anisotropic");return s=null!==i?t.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,s},getMaxPrecision:n,precision:r,logarithmicDepthBuffer:h,maxTextures:l,maxVertexTextures:c,maxTextureSize:d,maxCubemapSize:u,maxAttributes:p,maxVertexUniforms:m,maxVaryings:f,maxFragmentUniforms:g,vertexTextures:y,floatFragmentTextures:v,floatVertexTextures:y&&v,maxSamples:o?t.getParameter(36183):0}}function no(t){const e=this;let i=null,s=0,n=!1,o=!1;const r=new gs,a=new si,h={value:null,needsUpdate:!1};function l(){h.value!==i&&(h.value=i,h.needsUpdate=s>0),e.numPlanes=s,e.numIntersection=0}function c(t,i,s,n){const o=null!==t?t.length:0;let l=null;if(0!==o){if(l=h.value,!0!==n||null===l){const e=s+4*o,n=i.matrixWorldInverse;a.getNormalMatrix(n),(null===l||l.length<e)&&(l=new Float32Array(e));for(let e=0,i=s;e!==o;++e,i+=4)r.copy(t[e]).applyMatrix4(n,a),r.normal.toArray(l,i),l[i+3]=r.constant}h.value=l,h.needsUpdate=!0}return e.numPlanes=o,e.numIntersection=0,l}this.uniform=h,this.numPlanes=0,this.numIntersection=0,this.init=function(t,e,o){const r=0!==t.length||e||0!==s||n;return n=e,i=c(t,o,0),s=t.length,r},this.beginShadows=function(){o=!0,c(null)},this.endShadows=function(){o=!1,l()},this.setState=function(e,r,a){const d=e.clippingPlanes,u=e.clipIntersection,p=e.clipShadows,m=t.get(e);if(!n||null===d||0===d.length||o&&!p)o?c(null):l();else{const t=o?0:s,e=4*t;let n=m.clippingState||null;h.value=n,n=c(d,r,e,a);for(let t=0;t!==e;++t)n[t]=i[t];m.clippingState=n,this.numIntersection=u?this.numPlanes:0,this.numPlanes+=t}}}function oo(t){let e=new WeakMap;function i(t,e){return e===tt?t.mapping=J:e===et&&(t.mapping=Q),t}function s(t){const i=t.target;i.removeEventListener("dispose",s);const n=e.get(i);void 0!==n&&(e.delete(i),n.dispose())}return{get:function(n){if(n&&n.isTexture){const o=n.mapping;if(o===tt||o===et){if(e.has(n))return i(e.get(n).texture,n.mapping);{const o=n.image;if(o&&o.height>0){const r=t.getRenderList(),a=t.getRenderTarget(),h=new Vn(o.height/2);return h.fromEquirectangularTexture(t,n),e.set(n,h),t.setRenderTarget(a),t.setRenderList(r),n.addEventListener("dispose",s),i(h.texture,n.mapping)}return null}}}return n},dispose:function(){e=new WeakMap}}}function ro(t){const e={};return{has:function(i){if(void 0!==e[i])return null!==e[i];let s;switch(i){case"WEBGL_depth_texture":s=t.getExtension("WEBGL_depth_texture")||t.getExtension("MOZ_WEBGL_depth_texture")||t.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":s=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":s=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":s=t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:s=t.getExtension(i)}return e[i]=s,null!==s},get:function(t){return this.has(t)||console.warn("THREE.WebGLRenderer: "+t+" extension not supported."),e[t]}}}function ao(t,e,i,s){const n=new WeakMap,o=new WeakMap;function r(t){const a=t.target,h=n.get(a);null!==h.index&&e.remove(h.index);for(const t in h.attributes)e.remove(h.attributes[t]);a.removeEventListener("dispose",r),n.delete(a);const l=o.get(h);l&&(e.remove(l),o.delete(h)),s.releaseStatesOfGeometry(h),!0===a.isInstancedBufferGeometry&&delete a._maxInstanceCount,i.memory.geometries--}function a(t){const i=[],s=t.index,n=t.attributes.position;let r=0;if(null!==s){const t=s.array;r=s.version;for(let e=0,s=t.length;e<s;e+=3){const s=t[e+0],n=t[e+1],o=t[e+2];i.push(s,n,n,o,o,s)}}else{const t=n.array;r=n.version;for(let e=0,s=t.length/3-1;e<s;e+=3){const t=e+0,s=e+1,n=e+2;i.push(t,s,s,n,n,t)}}const a=new(Qs(i)>65535?Xs:qs)(i,1);a.version=r;const h=o.get(t);h&&e.remove(h),o.set(t,a)}return{get:function(t,e){let s=n.get(e);return s||(e.addEventListener("dispose",r),e.isBufferGeometry?s=e:e.isGeometry&&(void 0===e._bufferGeometry&&(e._bufferGeometry=(new cn).setFromObject(t)),s=e._bufferGeometry),n.set(e,s),i.memory.geometries++,s)},update:function(t){const i=t.attributes;for(const t in i)e.update(i[t],34962);const s=t.morphAttributes;for(const t in s){const i=s[t];for(let t=0,s=i.length;t<s;t++)e.update(i[t],34962)}},getWireframeAttribute:function(t){const e=o.get(t);if(e){const i=t.index;null!==i&&e.version<i.version&&a(t)}else a(t);return o.get(t)}}}function ho(t,e,i,s){const n=s.isWebGL2;let o,r,a;this.setMode=function(t){o=t},this.setIndex=function(t){r=t.type,a=t.bytesPerElement},this.render=function(e,s){t.drawElements(o,s,r,e*a),i.update(s,o,1)},this.renderInstances=function(s,h,l){if(0===l)return;let c,d;if(n)c=t,d="drawElementsInstanced";else if(c=e.get("ANGLE_instanced_arrays"),d="drawElementsInstancedANGLE",null===c)return void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");c[d](o,h,r,s*a,l),i.update(h,o,l)}}function lo(t){const e={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:e,programs:null,autoReset:!0,reset:function(){e.frame++,e.calls=0,e.triangles=0,e.points=0,e.lines=0},update:function(t,i,s){switch(e.calls++,i){case 4:e.triangles+=s*(t/3);break;case 1:e.lines+=s*(t/2);break;case 3:e.lines+=s*(t-1);break;case 2:e.lines+=s*t;break;case 0:e.points+=s*t;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",i)}}}}function co(t,e){return t[0]-e[0]}function uo(t,e){return Math.abs(e[1])-Math.abs(t[1])}function po(t){const e={},i=new Float32Array(8),s=[];for(let t=0;t<8;t++)s[t]=[t,0];return{update:function(n,o,r,a){const h=n.morphTargetInfluences,l=void 0===h?0:h.length;let c=e[o.id];if(void 0===c){c=[];for(let t=0;t<l;t++)c[t]=[t,0];e[o.id]=c}for(let t=0;t<l;t++){const e=c[t];e[0]=t,e[1]=h[t]}c.sort(uo);for(let t=0;t<8;t++)t<l&&c[t][1]?(s[t][0]=c[t][0],s[t][1]=c[t][1]):(s[t][0]=Number.MAX_SAFE_INTEGER,s[t][1]=0);s.sort(co);const d=r.morphTargets&&o.morphAttributes.position,u=r.morphNormals&&o.morphAttributes.normal;let p=0;for(let t=0;t<8;t++){const e=s[t],n=e[0],r=e[1];n!==Number.MAX_SAFE_INTEGER&&r?(d&&o.getAttribute("morphTarget"+t)!==d[n]&&o.setAttribute("morphTarget"+t,d[n]),u&&o.getAttribute("morphNormal"+t)!==u[n]&&o.setAttribute("morphNormal"+t,u[n]),i[t]=r,p+=r):(d&&!0===o.hasAttribute("morphTarget"+t)&&o.deleteAttribute("morphTarget"+t),u&&!0===o.hasAttribute("morphNormal"+t)&&o.deleteAttribute("morphNormal"+t),i[t]=0)}const m=o.morphTargetsRelative?1:1-p;a.getUniforms().setValue(t,"morphTargetBaseInfluence",m),a.getUniforms().setValue(t,"morphTargetInfluences",i)}}}function mo(t,e,i,s){let n=new WeakMap;function o(t){const e=t.target;e.removeEventListener("dispose",o),i.remove(e.instanceMatrix),null!==e.instanceColor&&i.remove(e.instanceColor)}return{update:function(t){const r=s.render.frame,a=t.geometry,h=e.get(t,a);return n.get(h)!==r&&(a.isGeometry&&h.updateFromObject(t),e.update(h),n.set(h,r)),t.isInstancedMesh&&(!1===t.hasEventListener("dispose",o)&&t.addEventListener("dispose",o),i.update(t.instanceMatrix,34962),null!==t.instanceColor&&i.update(t.instanceColor,34962)),h},dispose:function(){n=new WeakMap}}}function fo(t=null,e=1,i=1,s=1){ai.call(this,null),this.image={data:t,width:e,height:i,depth:s},this.magFilter=at,this.minFilter=at,this.wrapR=ot,this.generateMipmaps=!1,this.flipY=!1,this.needsUpdate=!0}function go(t=null,e=1,i=1,s=1){ai.call(this,null),this.image={data:t,width:e,height:i,depth:s},this.magFilter=at,this.minFilter=at,this.wrapR=ot,this.generateMipmaps=!1,this.flipY=!1,this.needsUpdate=!0}Qn.physical={uniforms:Rn([Qn.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatNormalScale:{value:new ii(1,1)},clearcoatNormalMap:{value:null},sheen:{value:new Ds(0)},transmission:{value:0},transmissionMap:{value:null}}]),vertexShader:Kn.meshphysical_vert,fragmentShader:Kn.meshphysical_frag},fo.prototype=Object.create(ai.prototype),fo.prototype.constructor=fo,fo.prototype.isDataTexture2DArray=!0,go.prototype=Object.create(ai.prototype),go.prototype.constructor=go,go.prototype.isDataTexture3D=!0;const yo=new ai,vo=new fo,wo=new go,xo=new Un,bo=[],So=[],Mo=new Float32Array(16),To=new Float32Array(9),_o=new Float32Array(4);function Eo(t,e,i){const s=t[0];if(s<=0||s>0)return t;const n=e*i;let o=bo[n];if(void 0===o&&(o=new Float32Array(n),bo[n]=o),0!==e){s.toArray(o,0);for(let s=1,n=0;s!==e;++s)n+=i,t[s].toArray(o,n)}return o}function Lo(t,e){if(t.length!==e.length)return!1;for(let i=0,s=t.length;i<s;i++)if(t[i]!==e[i])return!1;return!0}function Co(t,e){for(let i=0,s=e.length;i<s;i++)t[i]=e[i]}function Ao(t,e){let i=So[e];void 0===i&&(i=new Int32Array(e),So[e]=i);for(let s=0;s!==e;++s)i[s]=t.allocateTextureUnit();return i}function Po(t,e){const i=this.cache;i[0]!==e&&(t.uniform1f(this.addr,e),i[0]=e)}function ko(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y||(t.uniform2f(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y);else{if(Lo(i,e))return;t.uniform2fv(this.addr,e),Co(i,e)}}function Bo(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3f(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z);else if(void 0!==e.r)i[0]===e.r&&i[1]===e.g&&i[2]===e.b||(t.uniform3f(this.addr,e.r,e.g,e.b),i[0]=e.r,i[1]=e.g,i[2]=e.b);else{if(Lo(i,e))return;t.uniform3fv(this.addr,e),Co(i,e)}}function Ro(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4f(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w);else{if(Lo(i,e))return;t.uniform4fv(this.addr,e),Co(i,e)}}function Do(t,e){const i=this.cache,s=e.elements;if(void 0===s){if(Lo(i,e))return;t.uniformMatrix2fv(this.addr,!1,e),Co(i,e)}else{if(Lo(i,s))return;_o.set(s),t.uniformMatrix2fv(this.addr,!1,_o),Co(i,s)}}function Io(t,e){const i=this.cache,s=e.elements;if(void 0===s){if(Lo(i,e))return;t.uniformMatrix3fv(this.addr,!1,e),Co(i,e)}else{if(Lo(i,s))return;To.set(s),t.uniformMatrix3fv(this.addr,!1,To),Co(i,s)}}function Fo(t,e){const i=this.cache,s=e.elements;if(void 0===s){if(Lo(i,e))return;t.uniformMatrix4fv(this.addr,!1,e),Co(i,e)}else{if(Lo(i,s))return;Mo.set(s),t.uniformMatrix4fv(this.addr,!1,Mo),Co(i,s)}}function zo(t,e,i){const s=this.cache,n=i.allocateTextureUnit();s[0]!==n&&(t.uniform1i(this.addr,n),s[0]=n),i.safeSetTexture2D(e||yo,n)}function Oo(t,e,i){const s=this.cache,n=i.allocateTextureUnit();s[0]!==n&&(t.uniform1i(this.addr,n),s[0]=n),i.setTexture2DArray(e||vo,n)}function No(t,e,i){const s=this.cache,n=i.allocateTextureUnit();s[0]!==n&&(t.uniform1i(this.addr,n),s[0]=n),i.setTexture3D(e||wo,n)}function Wo(t,e,i){const s=this.cache,n=i.allocateTextureUnit();s[0]!==n&&(t.uniform1i(this.addr,n),s[0]=n),i.safeSetTextureCube(e||xo,n)}function Ho(t,e){const i=this.cache;i[0]!==e&&(t.uniform1i(this.addr,e),i[0]=e)}function Uo(t,e){const i=this.cache;Lo(i,e)||(t.uniform2iv(this.addr,e),Co(i,e))}function Vo(t,e){const i=this.cache;Lo(i,e)||(t.uniform3iv(this.addr,e),Co(i,e))}function Go(t,e){const i=this.cache;Lo(i,e)||(t.uniform4iv(this.addr,e),Co(i,e))}function jo(t,e){const i=this.cache;i[0]!==e&&(t.uniform1ui(this.addr,e),i[0]=e)}function qo(t,e){t.uniform1fv(this.addr,e)}function $o(t,e){t.uniform1iv(this.addr,e)}function Xo(t,e){t.uniform2iv(this.addr,e)}function Yo(t,e){t.uniform3iv(this.addr,e)}function Zo(t,e){t.uniform4iv(this.addr,e)}function Ko(t,e){const i=Eo(e,this.size,2);t.uniform2fv(this.addr,i)}function Jo(t,e){const i=Eo(e,this.size,3);t.uniform3fv(this.addr,i)}function Qo(t,e){const i=Eo(e,this.size,4);t.uniform4fv(this.addr,i)}function tr(t,e){const i=Eo(e,this.size,4);t.uniformMatrix2fv(this.addr,!1,i)}function er(t,e){const i=Eo(e,this.size,9);t.uniformMatrix3fv(this.addr,!1,i)}function ir(t,e){const i=Eo(e,this.size,16);t.uniformMatrix4fv(this.addr,!1,i)}function sr(t,e,i){const s=e.length,n=Ao(i,s);t.uniform1iv(this.addr,n);for(let t=0;t!==s;++t)i.safeSetTexture2D(e[t]||yo,n[t])}function nr(t,e,i){const s=e.length,n=Ao(i,s);t.uniform1iv(this.addr,n);for(let t=0;t!==s;++t)i.safeSetTextureCube(e[t]||xo,n[t])}function or(t,e,i){this.id=t,this.addr=i,this.cache=[],this.setValue=function(t){switch(t){case 5126:return Po;case 35664:return ko;case 35665:return Bo;case 35666:return Ro;case 35674:return Do;case 35675:return Io;case 35676:return Fo;case 5124:case 35670:return Ho;case 35667:case 35671:return Uo;case 35668:case 35672:return Vo;case 35669:case 35673:return Go;case 5125:return jo;case 35678:case 36198:case 36298:case 36306:case 35682:return zo;case 35679:case 36299:case 36307:return No;case 35680:case 36300:case 36308:case 36293:return Wo;case 36289:case 36303:case 36311:case 36292:return Oo}}(e.type)}function rr(t,e,i){this.id=t,this.addr=i,this.cache=[],this.size=e.size,this.setValue=function(t){switch(t){case 5126:return qo;case 35664:return Ko;case 35665:return Jo;case 35666:return Qo;case 35674:return tr;case 35675:return er;case 35676:return ir;case 5124:case 35670:return $o;case 35667:case 35671:return Xo;case 35668:case 35672:return Yo;case 35669:case 35673:return Zo;case 35678:case 36198:case 36298:case 36306:case 35682:return sr;case 35680:case 36300:case 36308:case 36293:return nr}}(e.type)}function ar(t){this.id=t,this.seq=[],this.map={}}rr.prototype.updateCache=function(t){const e=this.cache;t instanceof Float32Array&&e.length!==t.length&&(this.cache=new Float32Array(t.length)),Co(e,t)},ar.prototype.setValue=function(t,e,i){const s=this.seq;for(let n=0,o=s.length;n!==o;++n){const o=s[n];o.setValue(t,e[o.id],i)}};const hr=/(\w+)(\])?(\[|\.)?/g;function lr(t,e){t.seq.push(e),t.map[e.id]=e}function cr(t,e,i){const s=t.name,n=s.length;for(hr.lastIndex=0;;){const o=hr.exec(s),r=hr.lastIndex;let a=o[1];const h="]"===o[2],l=o[3];if(h&&(a|=0),void 0===l||"["===l&&r+2===n){lr(i,void 0===l?new or(a,t,e):new rr(a,t,e));break}{let t=i.map[a];void 0===t&&(t=new ar(a),lr(i,t)),i=t}}}function dr(t,e){this.seq=[],this.map={};const i=t.getProgramParameter(e,35718);for(let s=0;s<i;++s){const i=t.getActiveUniform(e,s);cr(i,t.getUniformLocation(e,i.name),this)}}function ur(t,e,i){const s=t.createShader(e);return t.shaderSource(s,i),t.compileShader(s),s}dr.prototype.setValue=function(t,e,i,s){const n=this.map[e];void 0!==n&&n.setValue(t,i,s)},dr.prototype.setOptional=function(t,e,i){const s=e[i];void 0!==s&&this.setValue(t,i,s)},dr.upload=function(t,e,i,s){for(let n=0,o=e.length;n!==o;++n){const o=e[n],r=i[o.id];!1!==r.needsUpdate&&o.setValue(t,r.value,s)}},dr.seqWithValue=function(t,e){const i=[];for(let s=0,n=t.length;s!==n;++s){const n=t[s];n.id in e&&i.push(n)}return i};let pr=0;function mr(t){switch(t){case Ie:return["Linear","( value )"];case Fe:return["sRGB","( value )"];case Oe:return["RGBE","( value )"];case We:return["RGBM","( value, 7.0 )"];case He:return["RGBM","( value, 16.0 )"];case Ue:return["RGBD","( value, 256.0 )"];case ze:return["Gamma","( value, float( GAMMA_FACTOR ) )"];case Ne:return["LogLuv","( value )"];default:return console.warn("THREE.WebGLProgram: Unsupported encoding:",t),["Linear","( value )"]}}function fr(t,e,i){const s=t.getShaderParameter(e,35713),n=t.getShaderInfoLog(e).trim();return s&&""===n?"":"THREE.WebGLShader: gl.getShaderInfoLog() "+i+"\n"+n+function(t){const e=t.split("\n");for(let t=0;t<e.length;t++)e[t]=t+1+": "+e[t];return e.join("\n")}(t.getShaderSource(e))}function gr(t,e){const i=mr(e);return"vec4 "+t+"( vec4 value ) { return "+i[0]+"ToLinear"+i[1]+"; }"}function yr(t,e){const i=mr(e);return"vec4 "+t+"( vec4 value ) { return LinearTo"+i[0]+i[1]+"; }"}function vr(t,e){let i;switch(e){case $:i="Linear";break;case X:i="Reinhard";break;case Y:i="OptimizedCineon";break;case Z:i="ACESFilmic";break;case K:i="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",e),i="Linear"}return"vec3 "+t+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}function wr(t){return""!==t}function xr(t,e){return t.replace(/NUM_DIR_LIGHTS/g,e.numDirLights).replace(/NUM_SPOT_LIGHTS/g,e.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,e.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,e.numPointLights).replace(/NUM_HEMI_LIGHTS/g,e.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,e.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS/g,e.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,e.numPointLightShadows)}function br(t,e){return t.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,e.numClippingPlanes-e.numClipIntersection)}const Sr=/^[ \t]*#include +<([\w\d./]+)>/gm;function Mr(t){return t.replace(Sr,Tr)}function Tr(t,e){const i=Kn[e];if(void 0===i)throw new Error("Can not resolve #include <"+e+">");return Mr(i)}const _r=/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,Er=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function Lr(t){return t.replace(Er,Ar).replace(_r,Cr)}function Cr(t,e,i,s){return console.warn("WebGLProgram: #pragma unroll_loop shader syntax is deprecated. Please use #pragma unroll_loop_start syntax instead."),Ar(0,e,i,s)}function Ar(t,e,i,s){let n="";for(let t=parseInt(e);t<parseInt(i);t++)n+=s.replace(/\[\s*i\s*\]/g,"[ "+t+" ]").replace(/UNROLLED_LOOP_INDEX/g,t);return n}function Pr(t){let e="precision "+t.precision+" float;\nprecision "+t.precision+" int;";return"highp"===t.precision?e+="\n#define HIGH_PRECISION":"mediump"===t.precision?e+="\n#define MEDIUM_PRECISION":"lowp"===t.precision&&(e+="\n#define LOW_PRECISION"),e}function kr(t,e,i,s){const n=t.getContext(),o=i.defines;let r=i.vertexShader,c=i.fragmentShader;const d=function(t){let e="SHADOWMAP_TYPE_BASIC";return t.shadowMapType===a?e="SHADOWMAP_TYPE_PCF":t.shadowMapType===h?e="SHADOWMAP_TYPE_PCF_SOFT":t.shadowMapType===l&&(e="SHADOWMAP_TYPE_VSM"),e}(i),u=function(t){let e="ENVMAP_TYPE_CUBE";if(t.envMap)switch(t.envMapMode){case J:case Q:e="ENVMAP_TYPE_CUBE";break;case it:case st:e="ENVMAP_TYPE_CUBE_UV"}return e}(i),p=function(t){let e="ENVMAP_MODE_REFLECTION";if(t.envMap)switch(t.envMapMode){case Q:case st:e="ENVMAP_MODE_REFRACTION"}return e}(i),m=function(t){let e="ENVMAP_BLENDING_NONE";if(t.envMap)switch(t.combine){case V:e="ENVMAP_BLENDING_MULTIPLY";break;case G:e="ENVMAP_BLENDING_MIX";break;case j:e="ENVMAP_BLENDING_ADD"}return e}(i),f=t.gammaFactor>0?t.gammaFactor:1,g=i.isWebGL2?"":function(t){return[t.extensionDerivatives||t.envMapCubeUV||t.bumpMap||t.tangentSpaceNormalMap||t.clearcoatNormalMap||t.flatShading||"physical"===t.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(t.extensionFragDepth||t.logarithmicDepthBuffer)&&t.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",t.extensionDrawBuffers&&t.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(t.extensionShaderTextureLOD||t.envMap)&&t.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(wr).join("\n")}(i),y=function(t){const e=[];for(const i in t){const s=t[i];!1!==s&&e.push("#define "+i+" "+s)}return e.join("\n")}(o),v=n.createProgram();let w,x,b=i.glslVersion?"#version "+i.glslVersion+"\n":"";i.isRawShaderMaterial?(w=[y].filter(wr).join("\n"),w.length>0&&(w+="\n"),x=[g,y].filter(wr).join("\n"),x.length>0&&(x+="\n")):(w=[Pr(i),"#define SHADER_NAME "+i.shaderName,y,i.instancing?"#define USE_INSTANCING":"",i.instancingColor?"#define USE_INSTANCING_COLOR":"",i.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+f,"#define MAX_BONES "+i.maxBones,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+p:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMap&&i.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",i.normalMap&&i.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.displacementMap&&i.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.vertexTangents?"#define USE_TANGENT":"",i.vertexColors?"#define USE_COLOR":"",i.vertexUvs?"#define USE_UV":"",i.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",i.flatShading?"#define FLAT_SHADED":"",i.skinning?"#define USE_SKINNING":"",i.useVertexTexture?"#define BONE_TEXTURE":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals&&!1===i.flatShading?"#define USE_MORPHNORMALS":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+d:"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#ifdef USE_COLOR","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(wr).join("\n"),x=[g,Pr(i),"#define SHADER_NAME "+i.shaderName,y,i.alphaTest?"#define ALPHATEST "+i.alphaTest+(i.alphaTest%1?"":".0"):"","#define GAMMA_FACTOR "+f,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.matcap?"#define USE_MATCAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+u:"",i.envMap?"#define "+p:"",i.envMap?"#define "+m:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMap&&i.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",i.normalMap&&i.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.sheen?"#define USE_SHEEN":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.vertexTangents?"#define USE_TANGENT":"",i.vertexColors||i.instancingColor?"#define USE_COLOR":"",i.vertexUvs?"#define USE_UV":"",i.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",i.gradientMap?"#define USE_GRADIENTMAP":"",i.flatShading?"#define FLAT_SHADED":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+d:"",i.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",i.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"",(i.extensionShaderTextureLOD||i.envMap)&&i.rendererExtensionShaderTextureLod?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",i.toneMapping!==q?"#define TONE_MAPPING":"",i.toneMapping!==q?Kn.tonemapping_pars_fragment:"",i.toneMapping!==q?vr("toneMapping",i.toneMapping):"",i.dithering?"#define DITHERING":"",Kn.encodings_pars_fragment,i.map?gr("mapTexelToLinear",i.mapEncoding):"",i.matcap?gr("matcapTexelToLinear",i.matcapEncoding):"",i.envMap?gr("envMapTexelToLinear",i.envMapEncoding):"",i.emissiveMap?gr("emissiveMapTexelToLinear",i.emissiveMapEncoding):"",i.lightMap?gr("lightMapTexelToLinear",i.lightMapEncoding):"",yr("linearToOutputTexel",i.outputEncoding),i.depthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].filter(wr).join("\n")),r=Mr(r),r=xr(r,i),r=br(r,i),c=Mr(c),c=xr(c,i),c=br(c,i),r=Lr(r),c=Lr(c),i.isWebGL2&&!0!==i.isRawShaderMaterial&&(b="#version 300 es\n",w=["#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+w,x=["#define varying in",i.glslVersion===Ke?"":"out highp vec4 pc_fragColor;",i.glslVersion===Ke?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+x);const S=b+x+c,M=ur(n,35633,b+w+r),T=ur(n,35632,S);if(n.attachShader(v,M),n.attachShader(v,T),void 0!==i.index0AttributeName?n.bindAttribLocation(v,0,i.index0AttributeName):!0===i.morphTargets&&n.bindAttribLocation(v,0,"position"),n.linkProgram(v),t.debug.checkShaderErrors){const t=n.getProgramInfoLog(v).trim(),e=n.getShaderInfoLog(M).trim(),i=n.getShaderInfoLog(T).trim();let s=!0,o=!0;if(!1===n.getProgramParameter(v,35714)){s=!1;const e=fr(n,M,"vertex"),i=fr(n,T,"fragment");console.error("THREE.WebGLProgram: shader error: ",n.getError(),"35715",n.getProgramParameter(v,35715),"gl.getProgramInfoLog",t,e,i)}else""!==t?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",t):""!==e&&""!==i||(o=!1);o&&(this.diagnostics={runnable:s,programLog:t,vertexShader:{log:e,prefix:w},fragmentShader:{log:i,prefix:x}})}let _,E;return n.deleteShader(M),n.deleteShader(T),this.getUniforms=function(){return void 0===_&&(_=new dr(n,v)),_},this.getAttributes=function(){return void 0===E&&(E=function(t,e){const i={},s=t.getProgramParameter(e,35721);for(let n=0;n<s;n++){const s=t.getActiveAttrib(e,n).name;i[s]=t.getAttribLocation(e,s)}return i}(n,v)),E},this.destroy=function(){s.releaseStatesOfProgram(this),n.deleteProgram(v),this.program=void 0},this.name=i.shaderName,this.id=pr++,this.cacheKey=e,this.usedTimes=1,this.program=v,this.vertexShader=M,this.fragmentShader=T,this}function Br(t,e,i,s,n,o){const r=[],a=s.isWebGL2,h=s.logarithmicDepthBuffer,l=s.floatVertexTextures,c=s.maxVertexUniforms,p=s.vertexTextures;let m=s.precision;const f={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"},g=["precision","isWebGL2","supportsVertexTextures","outputEncoding","instancing","instancingColor","map","mapEncoding","matcap","matcapEncoding","envMap","envMapMode","envMapEncoding","envMapCubeUV","lightMap","lightMapEncoding","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","objectSpaceNormalMap","tangentSpaceNormalMap","clearcoatMap","clearcoatRoughnessMap","clearcoatNormalMap","displacementMap","specularMap","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","vertexTangents","vertexUvs","uvsVertexOnly","fog","useFog","fogExp2","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","numDirLightShadows","numPointLightShadows","numSpotLightShadows","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering","sheen","transmissionMap"];function y(t){let e;return t&&t.isTexture?e=t.encoding:t&&t.isWebGLRenderTarget?(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),e=t.texture.encoding):e=Ie,e}return{getParameters:function(n,r,g,v,w){const x=v.fog,b=n.isMeshStandardMaterial?v.environment:null,S=e.get(n.envMap||b),M=f[n.type],T=w.isSkinnedMesh?function(t){const e=t.skeleton.bones;if(l)return 1024;{const t=c,i=Math.floor((t-20)/4),s=Math.min(i,e.length);return s<e.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+e.length+" bones. This GPU supports "+s+"."),0):s}}(w):0;let _,E;if(null!==n.precision&&(m=s.getMaxPrecision(n.precision),m!==n.precision&&console.warn("THREE.WebGLProgram.getParameters:",n.precision,"not supported, using",m,"instead.")),M){const t=Qn[M];_=t.vertexShader,E=t.fragmentShader}else _=n.vertexShader,E=n.fragmentShader;const L=t.getRenderTarget();return{isWebGL2:a,shaderID:M,shaderName:n.type,vertexShader:_,fragmentShader:E,defines:n.defines,isRawShaderMaterial:!0===n.isRawShaderMaterial,glslVersion:n.glslVersion,precision:m,instancing:!0===w.isInstancedMesh,instancingColor:!0===w.isInstancedMesh&&null!==w.instanceColor,supportsVertexTextures:p,outputEncoding:null!==L?y(L.texture):t.outputEncoding,map:!!n.map,mapEncoding:y(n.map),matcap:!!n.matcap,matcapEncoding:y(n.matcap),envMap:!!S,envMapMode:S&&S.mapping,envMapEncoding:y(S),envMapCubeUV:!!S&&(S.mapping===it||S.mapping===st),lightMap:!!n.lightMap,lightMapEncoding:y(n.lightMap),aoMap:!!n.aoMap,emissiveMap:!!n.emissiveMap,emissiveMapEncoding:y(n.emissiveMap),bumpMap:!!n.bumpMap,normalMap:!!n.normalMap,objectSpaceNormalMap:n.normalMapType===qe,tangentSpaceNormalMap:n.normalMapType===je,clearcoatMap:!!n.clearcoatMap,clearcoatRoughnessMap:!!n.clearcoatRoughnessMap,clearcoatNormalMap:!!n.clearcoatNormalMap,displacementMap:!!n.displacementMap,roughnessMap:!!n.roughnessMap,metalnessMap:!!n.metalnessMap,specularMap:!!n.specularMap,alphaMap:!!n.alphaMap,gradientMap:!!n.gradientMap,sheen:!!n.sheen,transmissionMap:!!n.transmissionMap,combine:n.combine,vertexTangents:n.normalMap&&n.vertexTangents,vertexColors:n.vertexColors,vertexUvs:!!(n.map||n.bumpMap||n.normalMap||n.specularMap||n.alphaMap||n.emissiveMap||n.roughnessMap||n.metalnessMap||n.clearcoatMap||n.clearcoatRoughnessMap||n.clearcoatNormalMap||n.displacementMap||n.transmissionMap),uvsVertexOnly:!(n.map||n.bumpMap||n.normalMap||n.specularMap||n.alphaMap||n.emissiveMap||n.roughnessMap||n.metalnessMap||n.clearcoatNormalMap||n.transmissionMap||!n.displacementMap),fog:!!x,useFog:n.fog,fogExp2:x&&x.isFogExp2,flatShading:n.flatShading,sizeAttenuation:n.sizeAttenuation,logarithmicDepthBuffer:h,skinning:n.skinning&&T>0,maxBones:T,useVertexTexture:l,morphTargets:n.morphTargets,morphNormals:n.morphNormals,maxMorphTargets:t.maxMorphTargets,maxMorphNormals:t.maxMorphNormals,numDirLights:r.directional.length,numPointLights:r.point.length,numSpotLights:r.spot.length,numRectAreaLights:r.rectArea.length,numHemiLights:r.hemi.length,numDirLightShadows:r.directionalShadowMap.length,numPointLightShadows:r.pointShadowMap.length,numSpotLightShadows:r.spotShadowMap.length,numClippingPlanes:o.numPlanes,numClipIntersection:o.numIntersection,dithering:n.dithering,shadowMapEnabled:t.shadowMap.enabled&&g.length>0,shadowMapType:t.shadowMap.type,toneMapping:n.toneMapped?t.toneMapping:q,physicallyCorrectLights:t.physicallyCorrectLights,premultipliedAlpha:n.premultipliedAlpha,alphaTest:n.alphaTest,doubleSided:n.side===u,flipSided:n.side===d,depthPacking:void 0!==n.depthPacking&&n.depthPacking,index0AttributeName:n.index0AttributeName,extensionDerivatives:n.extensions&&n.extensions.derivatives,extensionFragDepth:n.extensions&&n.extensions.fragDepth,extensionDrawBuffers:n.extensions&&n.extensions.drawBuffers,extensionShaderTextureLOD:n.extensions&&n.extensions.shaderTextureLOD,rendererExtensionFragDepth:a||i.has("EXT_frag_depth"),rendererExtensionDrawBuffers:a||i.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:a||i.has("EXT_shader_texture_lod"),customProgramCacheKey:n.customProgramCacheKey()}},getProgramCacheKey:function(e){const i=[];if(e.shaderID?i.push(e.shaderID):(i.push(e.fragmentShader),i.push(e.vertexShader)),void 0!==e.defines)for(const t in e.defines)i.push(t),i.push(e.defines[t]);if(!1===e.isRawShaderMaterial){for(let t=0;t<g.length;t++)i.push(e[g[t]]);i.push(t.outputEncoding),i.push(t.gammaFactor)}return i.push(e.customProgramCacheKey),i.join()},getUniforms:function(t){const e=f[t.type];let i;if(e){const t=Qn[e];i=Dn.clone(t.uniforms)}else i=t.uniforms;return i},acquireProgram:function(e,i){let s;for(let t=0,e=r.length;t<e;t++){const e=r[t];if(e.cacheKey===i){s=e,++s.usedTimes;break}}return void 0===s&&(s=new kr(t,i,e,n),r.push(s)),s},releaseProgram:function(t){if(0==--t.usedTimes){const e=r.indexOf(t);r[e]=r[r.length-1],r.pop(),t.destroy()}},programs:r}}function Rr(){let t=new WeakMap;return{get:function(e){let i=t.get(e);return void 0===i&&(i={},t.set(e,i)),i},remove:function(e){t.delete(e)},update:function(e,i,s){t.get(e)[i]=s},dispose:function(){t=new WeakMap}}}function Dr(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.program!==e.program?t.program.id-e.program.id:t.material.id!==e.material.id?t.material.id-e.material.id:t.z!==e.z?t.z-e.z:t.id-e.id}function Ir(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.z!==e.z?e.z-t.z:t.id-e.id}function Fr(t){const e=[];let i=0;const s=[],n=[],o={id:-1};function r(s,n,r,a,h,l){let c=e[i];const d=t.get(r);return void 0===c?(c={id:s.id,object:s,geometry:n,material:r,program:d.program||o,groupOrder:a,renderOrder:s.renderOrder,z:h,group:l},e[i]=c):(c.id=s.id,c.object=s,c.geometry=n,c.material=r,c.program=d.program||o,c.groupOrder=a,c.renderOrder=s.renderOrder,c.z=h,c.group=l),i++,c}return{opaque:s,transparent:n,init:function(){i=0,s.length=0,n.length=0},push:function(t,e,i,o,a,h){const l=r(t,e,i,o,a,h);(!0===i.transparent?n:s).push(l)},unshift:function(t,e,i,o,a,h){const l=r(t,e,i,o,a,h);(!0===i.transparent?n:s).unshift(l)},finish:function(){for(let t=i,s=e.length;t<s;t++){const i=e[t];if(null===i.id)break;i.id=null,i.object=null,i.geometry=null,i.material=null,i.program=null,i.group=null}},sort:function(t,e){s.length>1&&s.sort(t||Dr),n.length>1&&n.sort(e||Ir)}}}function zr(t){let e=new WeakMap;return{get:function(i,s){const n=e.get(i);let o;return void 0===n?(o=new Fr(t),e.set(i,new WeakMap),e.get(i).set(s,o)):(o=n.get(s),void 0===o&&(o=new Fr(t),n.set(s,o))),o},dispose:function(){e=new WeakMap}}}function Or(){const t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];let i;switch(e.type){case"DirectionalLight":i={direction:new pi,color:new Ds};break;case"SpotLight":i={position:new pi,direction:new pi,color:new Ds,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":i={position:new pi,color:new Ds,distance:0,decay:0};break;case"HemisphereLight":i={direction:new pi,skyColor:new Ds,groundColor:new Ds};break;case"RectAreaLight":i={color:new Ds,position:new pi,halfWidth:new pi,halfHeight:new pi}}return t[e.id]=i,i}}}let Nr=0;function Wr(t,e){return(e.castShadow?1:0)-(t.castShadow?1:0)}function Hr(t,e){const i=new Or,s=function(){const t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];let i;switch(e.type){case"DirectionalLight":case"SpotLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new ii};break;case"PointLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new ii,shadowCameraNear:1,shadowCameraFar:1e3}}return t[e.id]=i,i}}}(),n={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadow:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]};for(let t=0;t<9;t++)n.probe.push(new pi);const o=new pi,r=new Hi,a=new Hi;return{setup:function(o){let r=0,a=0,h=0;for(let t=0;t<9;t++)n.probe[t].set(0,0,0);let l=0,c=0,d=0,u=0,p=0,m=0,f=0,g=0;o.sort(Wr);for(let t=0,e=o.length;t<e;t++){const e=o[t],y=e.color,v=e.intensity,w=e.distance,x=e.shadow&&e.shadow.map?e.shadow.map.texture:null;if(e.isAmbientLight)r+=y.r*v,a+=y.g*v,h+=y.b*v;else if(e.isLightProbe)for(let t=0;t<9;t++)n.probe[t].addScaledVector(e.sh.coefficients[t],v);else if(e.isDirectionalLight){const t=i.get(e);if(t.color.copy(e.color).multiplyScalar(e.intensity),e.castShadow){const t=e.shadow,i=s.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,n.directionalShadow[l]=i,n.directionalShadowMap[l]=x,n.directionalShadowMatrix[l]=e.shadow.matrix,m++}n.directional[l]=t,l++}else if(e.isSpotLight){const t=i.get(e);if(t.position.setFromMatrixPosition(e.matrixWorld),t.color.copy(y).multiplyScalar(v),t.distance=w,t.coneCos=Math.cos(e.angle),t.penumbraCos=Math.cos(e.angle*(1-e.penumbra)),t.decay=e.decay,e.castShadow){const t=e.shadow,i=s.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,n.spotShadow[d]=i,n.spotShadowMap[d]=x,n.spotShadowMatrix[d]=e.shadow.matrix,g++}n.spot[d]=t,d++}else if(e.isRectAreaLight){const t=i.get(e);t.color.copy(y).multiplyScalar(v),t.halfWidth.set(.5*e.width,0,0),t.halfHeight.set(0,.5*e.height,0),n.rectArea[u]=t,u++}else if(e.isPointLight){const t=i.get(e);if(t.color.copy(e.color).multiplyScalar(e.intensity),t.distance=e.distance,t.decay=e.decay,e.castShadow){const t=e.shadow,i=s.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,i.shadowCameraNear=t.camera.near,i.shadowCameraFar=t.camera.far,n.pointShadow[c]=i,n.pointShadowMap[c]=x,n.pointShadowMatrix[c]=e.shadow.matrix,f++}n.point[c]=t,c++}else if(e.isHemisphereLight){const t=i.get(e);t.skyColor.copy(e.color).multiplyScalar(v),t.groundColor.copy(e.groundColor).multiplyScalar(v),n.hemi[p]=t,p++}}u>0&&(e.isWebGL2||!0===t.has("OES_texture_float_linear")?(n.rectAreaLTC1=Jn.LTC_FLOAT_1,n.rectAreaLTC2=Jn.LTC_FLOAT_2):!0===t.has("OES_texture_half_float_linear")?(n.rectAreaLTC1=Jn.LTC_HALF_1,n.rectAreaLTC2=Jn.LTC_HALF_2):console.error("THREE.WebGLRenderer: Unable to use RectAreaLight. Missing WebGL extensions.")),n.ambient[0]=r,n.ambient[1]=a,n.ambient[2]=h;const y=n.hash;y.directionalLength===l&&y.pointLength===c&&y.spotLength===d&&y.rectAreaLength===u&&y.hemiLength===p&&y.numDirectionalShadows===m&&y.numPointShadows===f&&y.numSpotShadows===g||(n.directional.length=l,n.spot.length=d,n.rectArea.length=u,n.point.length=c,n.hemi.length=p,n.directionalShadow.length=m,n.directionalShadowMap.length=m,n.pointShadow.length=f,n.pointShadowMap.length=f,n.spotShadow.length=g,n.spotShadowMap.length=g,n.directionalShadowMatrix.length=m,n.pointShadowMatrix.length=f,n.spotShadowMatrix.length=g,y.directionalLength=l,y.pointLength=c,y.spotLength=d,y.rectAreaLength=u,y.hemiLength=p,y.numDirectionalShadows=m,y.numPointShadows=f,y.numSpotShadows=g,n.version=Nr++)},setupView:function(t,e){let i=0,s=0,h=0,l=0,c=0;const d=e.matrixWorldInverse;for(let e=0,u=t.length;e<u;e++){const u=t[e];if(u.isDirectionalLight){const t=n.directional[i];t.direction.setFromMatrixPosition(u.matrixWorld),o.setFromMatrixPosition(u.target.matrixWorld),t.direction.sub(o),t.direction.transformDirection(d),i++}else if(u.isSpotLight){const t=n.spot[h];t.position.setFromMatrixPosition(u.matrixWorld),t.position.applyMatrix4(d),t.direction.setFromMatrixPosition(u.matrixWorld),o.setFromMatrixPosition(u.target.matrixWorld),t.direction.sub(o),t.direction.transformDirection(d),h++}else if(u.isRectAreaLight){const t=n.rectArea[l];t.position.setFromMatrixPosition(u.matrixWorld),t.position.applyMatrix4(d),a.identity(),r.copy(u.matrixWorld),r.premultiply(d),a.extractRotation(r),t.halfWidth.set(.5*u.width,0,0),t.halfHeight.set(0,.5*u.height,0),t.halfWidth.applyMatrix4(a),t.halfHeight.applyMatrix4(a),l++}else if(u.isPointLight){const t=n.point[s];t.position.setFromMatrixPosition(u.matrixWorld),t.position.applyMatrix4(d),s++}else if(u.isHemisphereLight){const t=n.hemi[c];t.direction.setFromMatrixPosition(u.matrixWorld),t.direction.transformDirection(d),t.direction.normalize(),c++}}},state:n}}function Ur(t,e){const i=new Hr(t,e),s=[],n=[];return{init:function(){s.length=0,n.length=0},state:{lightsArray:s,shadowsArray:n,lights:i},setupLights:function(){i.setup(s)},setupLightsView:function(t){i.setupView(s,t)},pushLight:function(t){s.push(t)},pushShadow:function(t){n.push(t)}}}function Vr(t,e){let i=new WeakMap;return{get:function(s,n=0){let o;return!1===i.has(s)?(o=new Ur(t,e),i.set(s,[]),i.get(s).push(o)):n>=i.get(s).length?(o=new Ur(t,e),i.get(s).push(o)):o=i.get(s)[n],o},dispose:function(){i=new WeakMap}}}function Gr(t){zs.call(this),this.type="MeshDepthMaterial",this.depthPacking=Ve,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.setValues(t)}function jr(t){zs.call(this),this.type="MeshDistanceMaterial",this.referencePosition=new pi,this.nearDistance=1,this.farDistance=1e3,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.fog=!1,this.setValues(t)}Gr.prototype=Object.create(zs.prototype),Gr.prototype.constructor=Gr,Gr.prototype.isMeshDepthMaterial=!0,Gr.prototype.copy=function(t){return zs.prototype.copy.call(this,t),this.depthPacking=t.depthPacking,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this},jr.prototype=Object.create(zs.prototype),jr.prototype.constructor=jr,jr.prototype.isMeshDistanceMaterial=!0,jr.prototype.copy=function(t){return zs.prototype.copy.call(this,t),this.referencePosition.copy(t.referencePosition),this.nearDistance=t.nearDistance,this.farDistance=t.farDistance,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this};var qr="uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy ) / resolution ) );\n\tfor ( float i = -1.0; i < 1.0 ; i += SAMPLE_RATE) {\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( i, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, i ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean * HALF_SAMPLE_RATE;\n\tsquared_mean = squared_mean * HALF_SAMPLE_RATE;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}",$r="void main() {\n\tgl_Position = vec4( position, 1.0 );\n}";function Xr(t,e,i){let s=new $n;const n=new ii,o=new ii,r=new li,h=[],m=[],f={},g={0:d,1:c,2:u},y=new zn({defines:{SAMPLE_RATE:2/8,HALF_SAMPLE_RATE:1/8},uniforms:{shadow_pass:{value:null},resolution:{value:new ii},radius:{value:4}},vertexShader:$r,fragmentShader:qr}),v=y.clone();v.defines.HORIZONTAL_PASS=1;const w=new cn;w.setAttribute("position",new Hs(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const x=new Cn(w,y),b=this;function S(i,s){const n=e.update(x);y.uniforms.shadow_pass.value=i.map.texture,y.uniforms.resolution.value=i.mapSize,y.uniforms.radius.value=i.radius,t.setRenderTarget(i.mapPass),t.clear(),t.renderBufferDirect(s,null,n,y,x,null),v.uniforms.shadow_pass.value=i.mapPass.texture,v.uniforms.resolution.value=i.mapSize,v.uniforms.radius.value=i.radius,t.setRenderTarget(i.map),t.clear(),t.renderBufferDirect(s,null,n,v,x,null)}function M(t,e,i){const s=t<<0|e<<1|i<<2;let n=h[s];return void 0===n&&(n=new Gr({depthPacking:Ge,morphTargets:t,skinning:e}),h[s]=n),n}function T(t,e,i){const s=t<<0|e<<1|i<<2;let n=m[s];return void 0===n&&(n=new jr({morphTargets:t,skinning:e}),m[s]=n),n}function _(e,i,s,n,o,r,a){let h=null,c=M,d=e.customDepthMaterial;if(!0===n.isPointLight&&(c=T,d=e.customDistanceMaterial),void 0===d){let t=!1;!0===s.morphTargets&&(t=i.morphAttributes&&i.morphAttributes.position&&i.morphAttributes.position.length>0);let n=!1;!0===e.isSkinnedMesh&&(!0===s.skinning?n=!0:console.warn("THREE.WebGLShadowMap: THREE.SkinnedMesh with material.skinning set to false:",e)),h=c(t,n,!0===e.isInstancedMesh)}else h=d;if(t.localClippingEnabled&&!0===s.clipShadows&&0!==s.clippingPlanes.length){const t=h.uuid,e=s.uuid;let i=f[t];void 0===i&&(i={},f[t]=i);let n=i[e];void 0===n&&(n=h.clone(),i[e]=n),h=n}return h.visible=s.visible,h.wireframe=s.wireframe,h.side=a===l?null!==s.shadowSide?s.shadowSide:s.side:null!==s.shadowSide?s.shadowSide:g[s.side],h.clipShadows=s.clipShadows,h.clippingPlanes=s.clippingPlanes,h.clipIntersection=s.clipIntersection,h.wireframeLinewidth=s.wireframeLinewidth,h.linewidth=s.linewidth,!0===n.isPointLight&&!0===h.isMeshDistanceMaterial&&(h.referencePosition.setFromMatrixPosition(n.matrixWorld),h.nearDistance=o,h.farDistance=r),h}function E(i,n,o,r,a){if(!1===i.visible)return;if(i.layers.test(n.layers)&&(i.isMesh||i.isLine||i.isPoints)&&(i.castShadow||i.receiveShadow&&a===l)&&(!i.frustumCulled||s.intersectsObject(i))){i.modelViewMatrix.multiplyMatrices(o.matrixWorldInverse,i.matrixWorld);const s=e.update(i),n=i.material;if(Array.isArray(n)){const e=s.groups;for(let h=0,l=e.length;h<l;h++){const l=e[h],c=n[l.materialIndex];if(c&&c.visible){const e=_(i,s,c,r,o.near,o.far,a);t.renderBufferDirect(o,null,s,e,i,l)}}}else if(n.visible){const e=_(i,s,n,r,o.near,o.far,a);t.renderBufferDirect(o,null,s,e,i,null)}}const h=i.children;for(let t=0,e=h.length;t<e;t++)E(h[t],n,o,r,a)}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=a,this.render=function(e,a,h){if(!1===b.enabled)return;if(!1===b.autoUpdate&&!1===b.needsUpdate)return;if(0===e.length)return;const c=t.getRenderTarget(),d=t.getActiveCubeFace(),u=t.getActiveMipmapLevel(),m=t.state;m.setBlending(p),m.buffers.color.setClear(1,1,1,1),m.buffers.depth.setTest(!0),m.setScissorTest(!1);for(let c=0,d=e.length;c<d;c++){const d=e[c],u=d.shadow;if(void 0===u){console.warn("THREE.WebGLShadowMap:",d,"has no shadow.");continue}if(!1===u.autoUpdate&&!1===u.needsUpdate)continue;n.copy(u.mapSize);const p=u.getFrameExtents();if(n.multiply(p),o.copy(u.mapSize),(n.x>i||n.y>i)&&(n.x>i&&(o.x=Math.floor(i/p.x),n.x=o.x*p.x,u.mapSize.x=o.x),n.y>i&&(o.y=Math.floor(i/p.y),n.y=o.y*p.y,u.mapSize.y=o.y)),null===u.map&&!u.isPointLightShadow&&this.type===l){const t={minFilter:ct,magFilter:ct,format:Lt};u.map=new ci(n.x,n.y,t),u.map.texture.name=d.name+".shadowMap",u.mapPass=new ci(n.x,n.y,t),u.camera.updateProjectionMatrix()}if(null===u.map){const t={minFilter:at,magFilter:at,format:Lt};u.map=new ci(n.x,n.y,t),u.map.texture.name=d.name+".shadowMap",u.camera.updateProjectionMatrix()}t.setRenderTarget(u.map),t.clear();const f=u.getViewportCount();for(let t=0;t<f;t++){const e=u.getViewport(t);r.set(o.x*e.x,o.y*e.y,o.x*e.z,o.y*e.w),m.viewport(r),u.updateMatrices(d,t),s=u.getFrustum(),E(a,h,u.camera,d,this.type)}u.isPointLightShadow||this.type!==l||S(u,h),u.needsUpdate=!1}b.needsUpdate=!1,t.setRenderTarget(c,d,u)}}function Yr(t,e,i){const s=i.isWebGL2,a=new function(){let e=!1;const i=new li;let s=null;const n=new li(0,0,0,0);return{setMask:function(i){s===i||e||(t.colorMask(i,i,i,i),s=i)},setLocked:function(t){e=t},setClear:function(e,s,o,r,a){!0===a&&(e*=r,s*=r,o*=r),i.set(e,s,o,r),!1===n.equals(i)&&(t.clearColor(e,s,o,r),n.copy(i))},reset:function(){e=!1,s=null,n.set(-1,0,0,0)}}},h=new function(){let e=!1,i=null,s=null,n=null;return{setTest:function(t){t?mt(2929):ft(2929)},setMask:function(s){i===s||e||(t.depthMask(s),i=s)},setFunc:function(e){if(s!==e){if(e)switch(e){case I:t.depthFunc(512);break;case F:t.depthFunc(519);break;case z:t.depthFunc(513);break;case O:t.depthFunc(515);break;case N:t.depthFunc(514);break;case W:t.depthFunc(518);break;case H:t.depthFunc(516);break;case U:t.depthFunc(517);break;default:t.depthFunc(515)}else t.depthFunc(515);s=e}},setLocked:function(t){e=t},setClear:function(e){n!==e&&(t.clearDepth(e),n=e)},reset:function(){e=!1,i=null,s=null,n=null}}},l=new function(){let e=!1,i=null,s=null,n=null,o=null,r=null,a=null,h=null,l=null;return{setTest:function(t){e||(t?mt(2960):ft(2960))},setMask:function(s){i===s||e||(t.stencilMask(s),i=s)},setFunc:function(e,i,r){s===e&&n===i&&o===r||(t.stencilFunc(e,i,r),s=e,n=i,o=r)},setOp:function(e,i,s){r===e&&a===i&&h===s||(t.stencilOp(e,i,s),r=e,a=i,h=s)},setLocked:function(t){e=t},setClear:function(e){l!==e&&(t.clearStencil(e),l=e)},reset:function(){e=!1,i=null,s=null,n=null,o=null,r=null,a=null,h=null,l=null}}};let c={},V=null,G=null,j=null,q=null,$=null,X=null,Y=null,Z=null,K=null,J=!1,Q=null,tt=null,et=null,it=null,st=null;const nt=t.getParameter(35661);let ot=!1,rt=0;const at=t.getParameter(7938);-1!==at.indexOf("WebGL")?(rt=parseFloat(/^WebGL (\d)/.exec(at)[1]),ot=rt>=1):-1!==at.indexOf("OpenGL ES")&&(rt=parseFloat(/^OpenGL ES (\d)/.exec(at)[1]),ot=rt>=2);let ht=null,lt={};const ct=new li,dt=new li;function ut(e,i,s){const n=new Uint8Array(4),o=t.createTexture();t.bindTexture(e,o),t.texParameteri(e,10241,9728),t.texParameteri(e,10240,9728);for(let e=0;e<s;e++)t.texImage2D(i+e,0,6408,1,1,0,6408,5121,n);return o}const pt={};function mt(e){!0!==c[e]&&(t.enable(e),c[e]=!0)}function ft(e){!1!==c[e]&&(t.disable(e),c[e]=!1)}pt[3553]=ut(3553,3553,1),pt[34067]=ut(34067,34069,6),a.setClear(0,0,0,1),h.setClear(1),l.setClear(0),mt(2929),h.setFunc(O),wt(!1),xt(o),mt(2884),vt(p);const gt={[w]:32774,[x]:32778,[b]:32779};if(s)gt[S]=32775,gt[M]=32776;else{const t=e.get("EXT_blend_minmax");null!==t&&(gt[S]=t.MIN_EXT,gt[M]=t.MAX_EXT)}const yt={[T]:0,[_]:1,[E]:768,[C]:770,[D]:776,[B]:774,[P]:772,[L]:769,[A]:771,[R]:775,[k]:773};function vt(e,i,s,n,o,r,a,h){if(e!==p){if(G||(mt(3042),G=!0),e===v)o=o||i,r=r||s,a=a||n,i===q&&o===Y||(t.blendEquationSeparate(gt[i],gt[o]),q=i,Y=o),s===$&&n===X&&r===Z&&a===K||(t.blendFuncSeparate(yt[s],yt[n],yt[r],yt[a]),$=s,X=n,Z=r,K=a),j=e,J=null;else if(e!==j||h!==J){if(q===w&&Y===w||(t.blendEquation(32774),q=w,Y=w),h)switch(e){case m:t.blendFuncSeparate(1,771,1,771);break;case f:t.blendFunc(1,1);break;case g:t.blendFuncSeparate(0,0,769,771);break;case y:t.blendFuncSeparate(0,768,0,770);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}else switch(e){case m:t.blendFuncSeparate(770,771,1,771);break;case f:t.blendFunc(770,1);break;case g:t.blendFunc(0,769);break;case y:t.blendFunc(0,768);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}$=null,X=null,Z=null,K=null,j=e,J=h}}else G&&(ft(3042),G=!1)}function wt(e){Q!==e&&(e?t.frontFace(2304):t.frontFace(2305),Q=e)}function xt(e){e!==n?(mt(2884),e!==tt&&(e===o?t.cullFace(1029):e===r?t.cullFace(1028):t.cullFace(1032))):ft(2884),tt=e}function bt(e,i,s){e?(mt(32823),it===i&&st===s||(t.polygonOffset(i,s),it=i,st=s)):ft(32823)}function St(e){void 0===e&&(e=33984+nt-1),ht!==e&&(t.activeTexture(e),ht=e)}return{buffers:{color:a,depth:h,stencil:l},enable:mt,disable:ft,useProgram:function(e){return V!==e&&(t.useProgram(e),V=e,!0)},setBlending:vt,setMaterial:function(t,e){t.side===u?ft(2884):mt(2884);let i=t.side===d;e&&(i=!i),wt(i),t.blending===m&&!1===t.transparent?vt(p):vt(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.premultipliedAlpha),h.setFunc(t.depthFunc),h.setTest(t.depthTest),h.setMask(t.depthWrite),a.setMask(t.colorWrite);const s=t.stencilWrite;l.setTest(s),s&&(l.setMask(t.stencilWriteMask),l.setFunc(t.stencilFunc,t.stencilRef,t.stencilFuncMask),l.setOp(t.stencilFail,t.stencilZFail,t.stencilZPass)),bt(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits)},setFlipSided:wt,setCullFace:xt,setLineWidth:function(e){e!==et&&(ot&&t.lineWidth(e),et=e)},setPolygonOffset:bt,setScissorTest:function(t){t?mt(3089):ft(3089)},activeTexture:St,bindTexture:function(e,i){null===ht&&St();let s=lt[ht];void 0===s&&(s={type:void 0,texture:void 0},lt[ht]=s),s.type===e&&s.texture===i||(t.bindTexture(e,i||pt[e]),s.type=e,s.texture=i)},unbindTexture:function(){const e=lt[ht];void 0!==e&&void 0!==e.type&&(t.bindTexture(e.type,null),e.type=void 0,e.texture=void 0)},compressedTexImage2D:function(){try{t.compressedTexImage2D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage2D:function(){try{t.texImage2D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage3D:function(){try{t.texImage3D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},scissor:function(e){!1===ct.equals(e)&&(t.scissor(e.x,e.y,e.z,e.w),ct.copy(e))},viewport:function(e){!1===dt.equals(e)&&(t.viewport(e.x,e.y,e.z,e.w),dt.copy(e))},reset:function(){c={},ht=null,lt={},V=null,G=null,j=null,q=null,$=null,X=null,Y=null,Z=null,K=null,J=!1,Q=null,tt=null,et=null,it=null,st=null,a.reset(),h.reset(),l.reset()}}}function Zr(t,e,i,s,n,o,r){const a=n.isWebGL2,h=n.maxTextures,l=n.maxCubemapSize,c=n.maxTextureSize,d=n.maxSamples,u=new WeakMap;let p,m=!1;try{m="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(t){}function f(t,e){return m?new OffscreenCanvas(t,e):document.createElementNS("http://www.w3.org/1999/xhtml","canvas")}function g(t,e,i,s){let n=1;if((t.width>s||t.height>s)&&(n=s/Math.max(t.width,t.height)),n<1||!0===e){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const s=e?ei.floorPowerOfTwo:Math.floor,o=s(n*t.width),r=s(n*t.height);void 0===p&&(p=f(o,r));const a=i?f(o,r):p;return a.width=o,a.height=r,a.getContext("2d").drawImage(t,0,0,o,r),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+t.width+"x"+t.height+") to ("+o+"x"+r+")."),a}return"data"in t&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+t.width+"x"+t.height+")."),t}return t}function y(t){return ei.isPowerOfTwo(t.width)&&ei.isPowerOfTwo(t.height)}function v(t,e){return t.generateMipmaps&&e&&t.minFilter!==at&&t.minFilter!==ct}function w(e,i,n,o){t.generateMipmap(e),s.get(i).__maxMipLevel=Math.log(Math.max(n,o))*Math.LOG2E}function x(i,s,n){if(!1===a)return s;if(null!==i){if(void 0!==t[i])return t[i];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+i+"'")}let o=s;return 6403===s&&(5126===n&&(o=33326),5131===n&&(o=33325),5121===n&&(o=33321)),6407===s&&(5126===n&&(o=34837),5131===n&&(o=34843),5121===n&&(o=32849)),6408===s&&(5126===n&&(o=34836),5131===n&&(o=34842),5121===n&&(o=32856)),33325!==o&&33326!==o&&34842!==o&&34836!==o||e.get("EXT_color_buffer_float"),o}function b(t){return t===at||t===ht||t===lt?9728:9729}function S(e){const i=e.target;i.removeEventListener("dispose",S),function(e){const i=s.get(e);void 0!==i.__webglInit&&(t.deleteTexture(i.__webglTexture),s.remove(e))}(i),i.isVideoTexture&&u.delete(i),r.memory.textures--}function M(e){const i=e.target;i.removeEventListener("dispose",M),function(e){const i=s.get(e),n=s.get(e.texture);if(e){if(void 0!==n.__webglTexture&&t.deleteTexture(n.__webglTexture),e.depthTexture&&e.depthTexture.dispose(),e.isWebGLCubeRenderTarget)for(let e=0;e<6;e++)t.deleteFramebuffer(i.__webglFramebuffer[e]),i.__webglDepthbuffer&&t.deleteRenderbuffer(i.__webglDepthbuffer[e]);else t.deleteFramebuffer(i.__webglFramebuffer),i.__webglDepthbuffer&&t.deleteRenderbuffer(i.__webglDepthbuffer),i.__webglMultisampledFramebuffer&&t.deleteFramebuffer(i.__webglMultisampledFramebuffer),i.__webglColorRenderbuffer&&t.deleteRenderbuffer(i.__webglColorRenderbuffer),i.__webglDepthRenderbuffer&&t.deleteRenderbuffer(i.__webglDepthRenderbuffer);s.remove(e.texture),s.remove(e)}}(i),r.memory.textures--}let T=0;function _(t,e){const n=s.get(t);if(t.isVideoTexture&&function(t){const e=r.render.frame;u.get(t)!==e&&(u.set(t,e),t.update())}(t),t.version>0&&n.__version!==t.version){const i=t.image;if(void 0===i)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined");else{if(!1!==i.complete)return void k(n,t,e);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}i.activeTexture(33984+e),i.bindTexture(3553,n.__webglTexture)}function E(e,n){const r=s.get(e);e.version>0&&r.__version!==e.version?function(e,s,n){if(6!==s.image.length)return;P(e,s),i.activeTexture(33984+n),i.bindTexture(34067,e.__webglTexture),t.pixelStorei(37440,s.flipY);const r=s&&(s.isCompressedTexture||s.image[0].isCompressedTexture),h=s.image[0]&&s.image[0].isDataTexture,c=[];for(let t=0;t<6;t++)c[t]=r||h?h?s.image[t].image:s.image[t]:g(s.image[t],!1,!0,l);const d=c[0],u=y(d)||a,p=o.convert(s.format),m=o.convert(s.type),f=x(s.internalFormat,p,m);let b;if(A(34067,s,u),r){for(let t=0;t<6;t++){b=c[t].mipmaps;for(let e=0;e<b.length;e++){const n=b[e];s.format!==Lt&&s.format!==Et?null!==p?i.compressedTexImage2D(34069+t,e,f,n.width,n.height,0,n.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):i.texImage2D(34069+t,e,f,n.width,n.height,0,p,m,n.data)}}e.__maxMipLevel=b.length-1}else{b=s.mipmaps;for(let t=0;t<6;t++)if(h){i.texImage2D(34069+t,0,f,c[t].width,c[t].height,0,p,m,c[t].data);for(let e=0;e<b.length;e++){const s=b[e].image[t].image;i.texImage2D(34069+t,e+1,f,s.width,s.height,0,p,m,s.data)}}else{i.texImage2D(34069+t,0,f,p,m,c[t]);for(let e=0;e<b.length;e++){const s=b[e];i.texImage2D(34069+t,e+1,f,p,m,s.image[t])}}e.__maxMipLevel=b.length}v(s,u)&&w(34067,s,d.width,d.height),e.__version=s.version,s.onUpdate&&s.onUpdate(s)}(r,e,n):(i.activeTexture(33984+n),i.bindTexture(34067,r.__webglTexture))}const L={[nt]:10497,[ot]:33071,[rt]:33648},C={[at]:9728,[ht]:9984,[lt]:9986,[ct]:9729,[dt]:9985,[ut]:9987};function A(i,o,r){r?(t.texParameteri(i,10242,L[o.wrapS]),t.texParameteri(i,10243,L[o.wrapT]),32879!==i&&35866!==i||t.texParameteri(i,32882,L[o.wrapR]),t.texParameteri(i,10240,C[o.magFilter]),t.texParameteri(i,10241,C[o.minFilter])):(t.texParameteri(i,10242,33071),t.texParameteri(i,10243,33071),32879!==i&&35866!==i||t.texParameteri(i,32882,33071),o.wrapS===ot&&o.wrapT===ot||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),t.texParameteri(i,10240,b(o.magFilter)),t.texParameteri(i,10241,b(o.minFilter)),o.minFilter!==at&&o.minFilter!==ct&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter."));const h=e.get("EXT_texture_filter_anisotropic");if(h){if(o.type===wt&&null===e.get("OES_texture_float_linear"))return;if(o.type===xt&&null===(a||e.get("OES_texture_half_float_linear")))return;(o.anisotropy>1||s.get(o).__currentAnisotropy)&&(t.texParameterf(i,h.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(o.anisotropy,n.getMaxAnisotropy())),s.get(o).__currentAnisotropy=o.anisotropy)}}function P(e,i){void 0===e.__webglInit&&(e.__webglInit=!0,i.addEventListener("dispose",S),e.__webglTexture=t.createTexture(),r.memory.textures++)}function k(e,s,n){let r=3553;s.isDataTexture2DArray&&(r=35866),s.isDataTexture3D&&(r=32879),P(e,s),i.activeTexture(33984+n),i.bindTexture(r,e.__webglTexture),t.pixelStorei(37440,s.flipY),t.pixelStorei(37441,s.premultiplyAlpha),t.pixelStorei(3317,s.unpackAlignment);const h=function(t){return!a&&(t.wrapS!==ot||t.wrapT!==ot||t.minFilter!==at&&t.minFilter!==ct)}(s)&&!1===y(s.image),l=g(s.image,h,!1,c),d=y(l)||a,u=o.convert(s.format);let p,m=o.convert(s.type),f=x(s.internalFormat,u,m);A(r,s,d);const b=s.mipmaps;if(s.isDepthTexture)f=6402,a?f=s.type===wt?36012:s.type===vt?33190:s.type===Tt?35056:33189:s.type===wt&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),s.format===kt&&6402===f&&s.type!==gt&&s.type!==vt&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),s.type=gt,m=o.convert(s.type)),s.format===Bt&&6402===f&&(f=34041,s.type!==Tt&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),s.type=Tt,m=o.convert(s.type))),i.texImage2D(3553,0,f,l.width,l.height,0,u,m,null);else if(s.isDataTexture)if(b.length>0&&d){for(let t=0,e=b.length;t<e;t++)p=b[t],i.texImage2D(3553,t,f,p.width,p.height,0,u,m,p.data);s.generateMipmaps=!1,e.__maxMipLevel=b.length-1}else i.texImage2D(3553,0,f,l.width,l.height,0,u,m,l.data),e.__maxMipLevel=0;else if(s.isCompressedTexture){for(let t=0,e=b.length;t<e;t++)p=b[t],s.format!==Lt&&s.format!==Et?null!==u?i.compressedTexImage2D(3553,t,f,p.width,p.height,0,p.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):i.texImage2D(3553,t,f,p.width,p.height,0,u,m,p.data);e.__maxMipLevel=b.length-1}else if(s.isDataTexture2DArray)i.texImage3D(35866,0,f,l.width,l.height,l.depth,0,u,m,l.data),e.__maxMipLevel=0;else if(s.isDataTexture3D)i.texImage3D(32879,0,f,l.width,l.height,l.depth,0,u,m,l.data),e.__maxMipLevel=0;else if(b.length>0&&d){for(let t=0,e=b.length;t<e;t++)p=b[t],i.texImage2D(3553,t,f,u,m,p);s.generateMipmaps=!1,e.__maxMipLevel=b.length-1}else i.texImage2D(3553,0,f,u,m,l),e.__maxMipLevel=0;v(s,d)&&w(r,s,l.width,l.height),e.__version=s.version,s.onUpdate&&s.onUpdate(s)}function B(e,n,r,a){const h=o.convert(n.texture.format),l=o.convert(n.texture.type),c=x(n.texture.internalFormat,h,l);i.texImage2D(a,0,c,n.width,n.height,0,h,l,null),t.bindFramebuffer(36160,e),t.framebufferTexture2D(36160,r,a,s.get(n.texture).__webglTexture,0),t.bindFramebuffer(36160,null)}function R(e,i,s){if(t.bindRenderbuffer(36161,e),i.depthBuffer&&!i.stencilBuffer){let n=33189;if(s){const e=i.depthTexture;e&&e.isDepthTexture&&(e.type===wt?n=36012:e.type===vt&&(n=33190));const s=D(i);t.renderbufferStorageMultisample(36161,s,n,i.width,i.height)}else t.renderbufferStorage(36161,n,i.width,i.height);t.framebufferRenderbuffer(36160,36096,36161,e)}else if(i.depthBuffer&&i.stencilBuffer){if(s){const e=D(i);t.renderbufferStorageMultisample(36161,e,35056,i.width,i.height)}else t.renderbufferStorage(36161,34041,i.width,i.height);t.framebufferRenderbuffer(36160,33306,36161,e)}else{const e=o.convert(i.texture.format),n=o.convert(i.texture.type),r=x(i.texture.internalFormat,e,n);if(s){const e=D(i);t.renderbufferStorageMultisample(36161,e,r,i.width,i.height)}else t.renderbufferStorage(36161,r,i.width,i.height)}t.bindRenderbuffer(36161,null)}function D(t){return a&&t.isWebGLMultisampleRenderTarget?Math.min(d,t.samples):0}let I=!1,F=!1;this.allocateTextureUnit=function(){const t=T;return t>=h&&console.warn("THREE.WebGLTextures: Trying to use "+t+" texture units while this GPU supports only "+h),T+=1,t},this.resetTextureUnits=function(){T=0},this.setTexture2D=_,this.setTexture2DArray=function(t,e){const n=s.get(t);t.version>0&&n.__version!==t.version?k(n,t,e):(i.activeTexture(33984+e),i.bindTexture(35866,n.__webglTexture))},this.setTexture3D=function(t,e){const n=s.get(t);t.version>0&&n.__version!==t.version?k(n,t,e):(i.activeTexture(33984+e),i.bindTexture(32879,n.__webglTexture))},this.setTextureCube=E,this.setupRenderTarget=function(e){const n=s.get(e),h=s.get(e.texture);e.addEventListener("dispose",M),h.__webglTexture=t.createTexture(),r.memory.textures++;const l=!0===e.isWebGLCubeRenderTarget,c=!0===e.isWebGLMultisampleRenderTarget,d=y(e)||a;if(!a||e.texture.format!==Et||e.texture.type!==wt&&e.texture.type!==xt||(e.texture.format=Lt,console.warn("THREE.WebGLRenderer: Rendering to textures with RGB format is not supported. Using RGBA format instead.")),l){n.__webglFramebuffer=[];for(let e=0;e<6;e++)n.__webglFramebuffer[e]=t.createFramebuffer()}else if(n.__webglFramebuffer=t.createFramebuffer(),c)if(a){n.__webglMultisampledFramebuffer=t.createFramebuffer(),n.__webglColorRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(36161,n.__webglColorRenderbuffer);const i=o.convert(e.texture.format),s=o.convert(e.texture.type),r=x(e.texture.internalFormat,i,s),a=D(e);t.renderbufferStorageMultisample(36161,a,r,e.width,e.height),t.bindFramebuffer(36160,n.__webglMultisampledFramebuffer),t.framebufferRenderbuffer(36160,36064,36161,n.__webglColorRenderbuffer),t.bindRenderbuffer(36161,null),e.depthBuffer&&(n.__webglDepthRenderbuffer=t.createRenderbuffer(),R(n.__webglDepthRenderbuffer,e,!0)),t.bindFramebuffer(36160,null)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.");if(l){i.bindTexture(34067,h.__webglTexture),A(34067,e.texture,d);for(let t=0;t<6;t++)B(n.__webglFramebuffer[t],e,36064,34069+t);v(e.texture,d)&&w(34067,e.texture,e.width,e.height),i.bindTexture(34067,null)}else i.bindTexture(3553,h.__webglTexture),A(3553,e.texture,d),B(n.__webglFramebuffer,e,36064,3553),v(e.texture,d)&&w(3553,e.texture,e.width,e.height),i.bindTexture(3553,null);e.depthBuffer&&function(e){const i=s.get(e),n=!0===e.isWebGLCubeRenderTarget;if(e.depthTexture){if(n)throw new Error("target.depthTexture not supported in Cube render targets");!function(e,i){if(i&&i.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(t.bindFramebuffer(36160,e),!i.depthTexture||!i.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");s.get(i.depthTexture).__webglTexture&&i.depthTexture.image.width===i.width&&i.depthTexture.image.height===i.height||(i.depthTexture.image.width=i.width,i.depthTexture.image.height=i.height,i.depthTexture.needsUpdate=!0),_(i.depthTexture,0);const n=s.get(i.depthTexture).__webglTexture;if(i.depthTexture.format===kt)t.framebufferTexture2D(36160,36096,3553,n,0);else{if(i.depthTexture.format!==Bt)throw new Error("Unknown depthTexture format");t.framebufferTexture2D(36160,33306,3553,n,0)}}(i.__webglFramebuffer,e)}else if(n){i.__webglDepthbuffer=[];for(let s=0;s<6;s++)t.bindFramebuffer(36160,i.__webglFramebuffer[s]),i.__webglDepthbuffer[s]=t.createRenderbuffer(),R(i.__webglDepthbuffer[s],e,!1)}else t.bindFramebuffer(36160,i.__webglFramebuffer),i.__webglDepthbuffer=t.createRenderbuffer(),R(i.__webglDepthbuffer,e,!1);t.bindFramebuffer(36160,null)}(e)},this.updateRenderTargetMipmap=function(t){const e=t.texture;if(v(e,y(t)||a)){const n=t.isWebGLCubeRenderTarget?34067:3553,o=s.get(e).__webglTexture;i.bindTexture(n,o),w(n,e,t.width,t.height),i.bindTexture(n,null)}},this.updateMultisampleRenderTarget=function(e){if(e.isWebGLMultisampleRenderTarget)if(a){const i=s.get(e);t.bindFramebuffer(36008,i.__webglMultisampledFramebuffer),t.bindFramebuffer(36009,i.__webglFramebuffer);const n=e.width,o=e.height;let r=16384;e.depthBuffer&&(r|=256),e.stencilBuffer&&(r|=1024),t.blitFramebuffer(0,0,n,o,0,0,n,o,r,9728),t.bindFramebuffer(36160,i.__webglMultisampledFramebuffer)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.")},this.safeSetTexture2D=function(t,e){t&&t.isWebGLRenderTarget&&(!1===I&&(console.warn("THREE.WebGLTextures.safeSetTexture2D: don't use render targets as textures. Use their .texture property instead."),I=!0),t=t.texture),_(t,e)},this.safeSetTextureCube=function(t,e){t&&t.isWebGLCubeRenderTarget&&(!1===F&&(console.warn("THREE.WebGLTextures.safeSetTextureCube: don't use cube render targets as textures. Use their .texture property instead."),F=!0),t=t.texture),E(t,e)}}function Kr(t,e,i){const s=i.isWebGL2;return{convert:function(t){let i;if(t===pt)return 5121;if(t===bt)return 32819;if(t===St)return 32820;if(t===Mt)return 33635;if(t===mt)return 5120;if(t===ft)return 5122;if(t===gt)return 5123;if(t===yt)return 5124;if(t===vt)return 5125;if(t===wt)return 5126;if(t===xt)return s?5131:(i=e.get("OES_texture_half_float"),null!==i?i.HALF_FLOAT_OES:null);if(t===_t)return 6406;if(t===Et)return 6407;if(t===Lt)return 6408;if(t===Ct)return 6409;if(t===At)return 6410;if(t===kt)return 6402;if(t===Bt)return 34041;if(t===Rt)return 6403;if(t===Dt)return 36244;if(t===It)return 33319;if(t===Ft)return 33320;if(t===zt)return 36248;if(t===Ot)return 36249;if(t===Nt||t===Wt||t===Ht||t===Ut){if(i=e.get("WEBGL_compressed_texture_s3tc"),null===i)return null;if(t===Nt)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(t===Wt)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(t===Ht)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(t===Ut)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(t===Vt||t===Gt||t===jt||t===qt){if(i=e.get("WEBGL_compressed_texture_pvrtc"),null===i)return null;if(t===Vt)return i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(t===Gt)return i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(t===jt)return i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(t===qt)return i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(t===$t)return i=e.get("WEBGL_compressed_texture_etc1"),null!==i?i.COMPRESSED_RGB_ETC1_WEBGL:null;if((t===Xt||t===Yt)&&(i=e.get("WEBGL_compressed_texture_etc"),null!==i)){if(t===Xt)return i.COMPRESSED_RGB8_ETC2;if(t===Yt)return i.COMPRESSED_RGBA8_ETC2_EAC}return t===Zt||t===Kt||t===Jt||t===Qt||t===te||t===ee||t===ie||t===se||t===ne||t===oe||t===re||t===ae||t===he||t===le||t===de||t===ue||t===pe||t===me||t===fe||t===ge||t===ye||t===ve||t===we||t===xe||t===be||t===Se||t===Me||t===Te?(i=e.get("WEBGL_compressed_texture_astc"),null!==i?t:null):t===ce?(i=e.get("EXT_texture_compression_bptc"),null!==i?t:null):t===Tt?s?34042:(i=e.get("WEBGL_depth_texture"),null!==i?i.UNSIGNED_INT_24_8_WEBGL:null):void 0}}}function Jr(t=[]){Nn.call(this),this.cameras=t}function Qr(){us.call(this),this.type="Group"}function ta(){this._targetRay=null,this._grip=null,this._hand=null}function ea(t,e){const i=this;let s=null,n=1,o=null,r="local-floor",a=null;const h=[],l=new Map,c=new Nn;c.layers.enable(1),c.viewport=new li;const d=new Nn;d.layers.enable(2),d.viewport=new li;const u=[c,d],p=new Jr;p.layers.enable(1),p.layers.enable(2);let m=null,f=null;function g(t){const e=l.get(t.inputSource);e&&e.dispatchEvent({type:t.type,data:t.inputSource})}function y(){l.forEach((function(t,e){t.disconnect(e)})),l.clear(),t.setFramebuffer(null),t.setRenderTarget(t.getRenderTarget()),T.stop(),i.isPresenting=!1,i.dispatchEvent({type:"sessionend"})}function v(t){o=t,T.setContext(s),T.start(),i.isPresenting=!0,i.dispatchEvent({type:"sessionstart"})}function w(t){const e=s.inputSources;for(let t=0;t<h.length;t++)l.set(e[t],h[t]);for(let e=0;e<t.removed.length;e++){const i=t.removed[e],s=l.get(i);s&&(s.dispatchEvent({type:"disconnected",data:i}),l.delete(i))}for(let e=0;e<t.added.length;e++){const i=t.added[e],s=l.get(i);s&&s.dispatchEvent({type:"connected",data:i})}}this.enabled=!1,this.isPresenting=!1,this.getController=function(t){let e=h[t];return void 0===e&&(e=new ta,h[t]=e),e.getTargetRaySpace()},this.getControllerGrip=function(t){let e=h[t];return void 0===e&&(e=new ta,h[t]=e),e.getGripSpace()},this.getHand=function(t){let e=h[t];return void 0===e&&(e=new ta,h[t]=e),e.getHandSpace()},this.setFramebufferScaleFactor=function(t){n=t,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(t){r=t,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return o},this.getSession=function(){return s},this.setSession=function(t){if(s=t,null!==s){s.addEventListener("select",g),s.addEventListener("selectstart",g),s.addEventListener("selectend",g),s.addEventListener("squeeze",g),s.addEventListener("squeezestart",g),s.addEventListener("squeezeend",g),s.addEventListener("end",y);const t=e.getContextAttributes();!0!==t.xrCompatible&&e.makeXRCompatible();const i={antialias:t.antialias,alpha:t.alpha,depth:t.depth,stencil:t.stencil,framebufferScaleFactor:n},o=new XRWebGLLayer(s,e,i);s.updateRenderState({baseLayer:o}),s.requestReferenceSpace(r).then(v),s.addEventListener("inputsourceschange",w)}};const x=new pi,b=new pi;function S(t,e){null===e?t.matrixWorld.copy(t.matrix):t.matrixWorld.multiplyMatrices(e.matrixWorld,t.matrix),t.matrixWorldInverse.copy(t.matrixWorld).invert()}this.getCamera=function(t){p.near=d.near=c.near=t.near,p.far=d.far=c.far=t.far,m===p.near&&f===p.far||(s.updateRenderState({depthNear:p.near,depthFar:p.far}),m=p.near,f=p.far);const e=t.parent,i=p.cameras;S(p,e);for(let t=0;t<i.length;t++)S(i[t],e);t.matrixWorld.copy(p.matrixWorld);const n=t.children;for(let t=0,e=n.length;t<e;t++)n[t].updateMatrixWorld(!0);return 2===i.length?function(t,e,i){x.setFromMatrixPosition(e.matrixWorld),b.setFromMatrixPosition(i.matrixWorld);const s=x.distanceTo(b),n=e.projectionMatrix.elements,o=i.projectionMatrix.elements,r=n[14]/(n[10]-1),a=n[14]/(n[10]+1),h=(n[9]+1)/n[5],l=(n[9]-1)/n[5],c=(n[8]-1)/n[0],d=(o[8]+1)/o[0],u=r*c,p=r*d,m=s/(-c+d),f=m*-c;e.matrixWorld.decompose(t.position,t.quaternion,t.scale),t.translateX(f),t.translateZ(m),t.matrixWorld.compose(t.position,t.quaternion,t.scale),t.matrixWorldInverse.copy(t.matrixWorld).invert();const g=r+m,y=a+m,v=u-f,w=p+(s-f),S=h*a/y*g,M=l*a/y*g;t.projectionMatrix.makePerspective(v,w,S,M,g,y)}(p,c,d):p.projectionMatrix.copy(c.projectionMatrix),p};let M=null;const T=new Xn;T.setAnimationLoop((function(e,i){if(a=i.getViewerPose(o),null!==a){const e=a.views,i=s.renderState.baseLayer;t.setFramebuffer(i.framebuffer);let n=!1;e.length!==p.cameras.length&&(p.cameras.length=0,n=!0);for(let t=0;t<e.length;t++){const s=e[t],o=i.getViewport(s),r=u[t];r.matrix.fromArray(s.transform.matrix),r.projectionMatrix.fromArray(s.projectionMatrix),r.viewport.set(o.x,o.y,o.width,o.height),0===t&&p.matrix.copy(r.matrix),!0===n&&p.cameras.push(r)}}const n=s.inputSources;for(let t=0;t<h.length;t++){const e=h[t],s=n[t];e.update(s,i,o)}M&&M(e,i)})),this.setAnimationLoop=function(t){M=t},this.dispose=function(){}}function ia(t){function e(e,i){e.opacity.value=i.opacity,i.color&&e.diffuse.value.copy(i.color),i.emissive&&e.emissive.value.copy(i.emissive).multiplyScalar(i.emissiveIntensity),i.map&&(e.map.value=i.map),i.alphaMap&&(e.alphaMap.value=i.alphaMap),i.specularMap&&(e.specularMap.value=i.specularMap);const s=t.get(i).envMap;if(s){e.envMap.value=s,e.flipEnvMap.value=s.isCubeTexture&&s._needsFlipEnvMap?-1:1,e.reflectivity.value=i.reflectivity,e.refractionRatio.value=i.refractionRatio;const n=t.get(s).__maxMipLevel;void 0!==n&&(e.maxMipLevel.value=n)}let n,o;i.lightMap&&(e.lightMap.value=i.lightMap,e.lightMapIntensity.value=i.lightMapIntensity),i.aoMap&&(e.aoMap.value=i.aoMap,e.aoMapIntensity.value=i.aoMapIntensity),i.map?n=i.map:i.specularMap?n=i.specularMap:i.displacementMap?n=i.displacementMap:i.normalMap?n=i.normalMap:i.bumpMap?n=i.bumpMap:i.roughnessMap?n=i.roughnessMap:i.metalnessMap?n=i.metalnessMap:i.alphaMap?n=i.alphaMap:i.emissiveMap?n=i.emissiveMap:i.clearcoatMap?n=i.clearcoatMap:i.clearcoatNormalMap?n=i.clearcoatNormalMap:i.clearcoatRoughnessMap&&(n=i.clearcoatRoughnessMap),void 0!==n&&(n.isWebGLRenderTarget&&(n=n.texture),!0===n.matrixAutoUpdate&&n.updateMatrix(),e.uvTransform.value.copy(n.matrix)),i.aoMap?o=i.aoMap:i.lightMap&&(o=i.lightMap),void 0!==o&&(o.isWebGLRenderTarget&&(o=o.texture),!0===o.matrixAutoUpdate&&o.updateMatrix(),e.uv2Transform.value.copy(o.matrix))}function i(e,i){e.roughness.value=i.roughness,e.metalness.value=i.metalness,i.roughnessMap&&(e.roughnessMap.value=i.roughnessMap),i.metalnessMap&&(e.metalnessMap.value=i.metalnessMap),i.emissiveMap&&(e.emissiveMap.value=i.emissiveMap),i.bumpMap&&(e.bumpMap.value=i.bumpMap,e.bumpScale.value=i.bumpScale,i.side===d&&(e.bumpScale.value*=-1)),i.normalMap&&(e.normalMap.value=i.normalMap,e.normalScale.value.copy(i.normalScale),i.side===d&&e.normalScale.value.negate()),i.displacementMap&&(e.displacementMap.value=i.displacementMap,e.displacementScale.value=i.displacementScale,e.displacementBias.value=i.displacementBias),t.get(i).envMap&&(e.envMapIntensity.value=i.envMapIntensity)}return{refreshFogUniforms:function(t,e){t.fogColor.value.copy(e.color),e.isFog?(t.fogNear.value=e.near,t.fogFar.value=e.far):e.isFogExp2&&(t.fogDensity.value=e.density)},refreshMaterialUniforms:function(t,s,n,o){s.isMeshBasicMaterial?e(t,s):s.isMeshLambertMaterial?(e(t,s),function(t,e){e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap)}(t,s)):s.isMeshToonMaterial?(e(t,s),function(t,e){e.gradientMap&&(t.gradientMap.value=e.gradientMap),e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap),e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,e.side===d&&(t.bumpScale.value*=-1)),e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),e.side===d&&t.normalScale.value.negate()),e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,s)):s.isMeshPhongMaterial?(e(t,s),function(t,e){t.specular.value.copy(e.specular),t.shininess.value=Math.max(e.shininess,1e-4),e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap),e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,e.side===d&&(t.bumpScale.value*=-1)),e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),e.side===d&&t.normalScale.value.negate()),e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,s)):s.isMeshStandardMaterial?(e(t,s),s.isMeshPhysicalMaterial?function(t,e){i(t,e),t.reflectivity.value=e.reflectivity,t.clearcoat.value=e.clearcoat,t.clearcoatRoughness.value=e.clearcoatRoughness,e.sheen&&t.sheen.value.copy(e.sheen),e.clearcoatMap&&(t.clearcoatMap.value=e.clearcoatMap),e.clearcoatRoughnessMap&&(t.clearcoatRoughnessMap.value=e.clearcoatRoughnessMap),e.clearcoatNormalMap&&(t.clearcoatNormalScale.value.copy(e.clearcoatNormalScale),t.clearcoatNormalMap.value=e.clearcoatNormalMap,e.side===d&&t.clearcoatNormalScale.value.negate()),t.transmission.value=e.transmission,e.transmissionMap&&(t.transmissionMap.value=e.transmissionMap)}(t,s):i(t,s)):s.isMeshMatcapMaterial?(e(t,s),function(t,e){e.matcap&&(t.matcap.value=e.matcap),e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,e.side===d&&(t.bumpScale.value*=-1)),e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),e.side===d&&t.normalScale.value.negate()),e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,s)):s.isMeshDepthMaterial?(e(t,s),function(t,e){e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,s)):s.isMeshDistanceMaterial?(e(t,s),function(t,e){e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias),t.referencePosition.value.copy(e.referencePosition),t.nearDistance.value=e.nearDistance,t.farDistance.value=e.farDistance}(t,s)):s.isMeshNormalMaterial?(e(t,s),function(t,e){e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,e.side===d&&(t.bumpScale.value*=-1)),e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),e.side===d&&t.normalScale.value.negate()),e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,s)):s.isLineBasicMaterial?(function(t,e){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity}(t,s),s.isLineDashedMaterial&&function(t,e){t.dashSize.value=e.dashSize,t.totalSize.value=e.dashSize+e.gapSize,t.scale.value=e.scale}(t,s)):s.isPointsMaterial?function(t,e,i,s){let n;t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,t.size.value=e.size*i,t.scale.value=.5*s,e.map&&(t.map.value=e.map),e.alphaMap&&(t.alphaMap.value=e.alphaMap),e.map?n=e.map:e.alphaMap&&(n=e.alphaMap),void 0!==n&&(!0===n.matrixAutoUpdate&&n.updateMatrix(),t.uvTransform.value.copy(n.matrix))}(t,s,n,o):s.isSpriteMaterial?function(t,e){let i;t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,t.rotation.value=e.rotation,e.map&&(t.map.value=e.map),e.alphaMap&&(t.alphaMap.value=e.alphaMap),e.map?i=e.map:e.alphaMap&&(i=e.alphaMap),void 0!==i&&(!0===i.matrixAutoUpdate&&i.updateMatrix(),t.uvTransform.value.copy(i.matrix))}(t,s):s.isShadowMaterial?(t.color.value.copy(s.color),t.opacity.value=s.opacity):s.isShaderMaterial&&(s.uniformsNeedUpdate=!1)}}}function sa(t){const e=void 0!==(t=t||{}).canvas?t.canvas:function(){const t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return t.style.display="block",t}(),i=void 0!==t.context?t.context:null,s=void 0!==t.alpha&&t.alpha,n=void 0===t.depth||t.depth,o=void 0===t.stencil||t.stencil,r=void 0!==t.antialias&&t.antialias,a=void 0===t.premultipliedAlpha||t.premultipliedAlpha,h=void 0!==t.preserveDrawingBuffer&&t.preserveDrawingBuffer,l=void 0!==t.powerPreference?t.powerPreference:"default",c=void 0!==t.failIfMajorPerformanceCaveat&&t.failIfMajorPerformanceCaveat;let d=null,u=null;const p=[];this.domElement=e,this.debug={checkShaderErrors:!0},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.outputEncoding=Ie,this.physicallyCorrectLights=!1,this.toneMapping=q,this.toneMappingExposure=1,this.maxMorphTargets=8,this.maxMorphNormals=4;const m=this;let f=!1,g=null,y=0,v=0,w=null,x=null,b=-1,S=null;const M=new li,T=new li;let _=null,E=e.width,L=e.height,C=1,A=null,P=null;const k=new li(0,0,E,L),B=new li(0,0,E,L);let R=!1;const D=new $n;let I=!1,F=!1;const z=new Hi,O=new pi,N={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function W(){return null===w?C:1}let H,U,V,G,j,$,X,Y,Z,K,J,Q,tt,et,it,st,nt,ot,rt,at,ht,lt=i;function ct(t,i){for(let s=0;s<t.length;s++){const n=t[s],o=e.getContext(n,i);if(null!==o)return o}return null}try{const t={alpha:s,depth:n,stencil:o,antialias:r,premultipliedAlpha:a,preserveDrawingBuffer:h,powerPreference:l,failIfMajorPerformanceCaveat:c};if(e.addEventListener("webglcontextlost",ft,!1),e.addEventListener("webglcontextrestored",gt,!1),null===lt){const e=["webgl2","webgl","experimental-webgl"];if(!0===m.isWebGL1Renderer&&e.shift(),lt=ct(e,t),null===lt)throw ct(e)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}void 0===lt.getShaderPrecisionFormat&&(lt.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(t){throw console.error("THREE.WebGLRenderer: "+t.message),t}function dt(){H=new ro(lt),U=new so(lt,H,t),!1===U.isWebGL2&&(H.get("WEBGL_depth_texture"),H.get("OES_texture_float"),H.get("OES_texture_half_float"),H.get("OES_texture_half_float_linear"),H.get("OES_standard_derivatives"),H.get("OES_element_index_uint"),H.get("OES_vertex_array_object"),H.get("ANGLE_instanced_arrays")),H.get("OES_texture_float_linear"),at=new Kr(lt,H,U),V=new Yr(lt,H,U),V.scissor(T.copy(B).multiplyScalar(C).floor()),V.viewport(M.copy(k).multiplyScalar(C).floor()),G=new lo(lt),j=new Rr,$=new Zr(lt,H,V,j,U,at,G),X=new oo(m),Y=new Yn(lt,U),ht=new eo(lt,H,Y,U),Z=new ao(lt,Y,G,ht),K=new mo(lt,Z,Y,G),nt=new po(lt),it=new no(j),J=new Br(m,X,H,U,ht,it),Q=new ia(j),tt=new zr(j),et=new Vr(H,U),st=new to(m,X,V,K,a),ot=new io(lt,H,G,U),rt=new ho(lt,H,G,U),G.programs=J.programs,m.capabilities=U,m.extensions=H,m.properties=j,m.renderLists=tt,m.state=V,m.info=G}dt();const ut=new ea(m,lt);this.xr=ut;const mt=new Xr(m,K,U.maxTextureSize);function ft(t){t.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),f=!0}function gt(){console.log("THREE.WebGLRenderer: Context Restored."),f=!1,dt()}function yt(t){const e=t.target;e.removeEventListener("dispose",yt),function(t){vt(t),j.remove(t)}(e)}function vt(t){const e=j.get(t).program;void 0!==e&&J.releaseProgram(e)}this.shadowMap=mt,this.getContext=function(){return lt},this.getContextAttributes=function(){return lt.getContextAttributes()},this.forceContextLoss=function(){const t=H.get("WEBGL_lose_context");t&&t.loseContext()},this.forceContextRestore=function(){const t=H.get("WEBGL_lose_context");t&&t.restoreContext()},this.getPixelRatio=function(){return C},this.setPixelRatio=function(t){void 0!==t&&(C=t,this.setSize(E,L,!1))},this.getSize=function(t){return void 0===t&&(console.warn("WebGLRenderer: .getsize() now requires a Vector2 as an argument"),t=new ii),t.set(E,L)},this.setSize=function(t,i,s){ut.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(E=t,L=i,e.width=Math.floor(t*C),e.height=Math.floor(i*C),!1!==s&&(e.style.width=t+"px",e.style.height=i+"px"),this.setViewport(0,0,t,i))},this.getDrawingBufferSize=function(t){return void 0===t&&(console.warn("WebGLRenderer: .getdrawingBufferSize() now requires a Vector2 as an argument"),t=new ii),t.set(E*C,L*C).floor()},this.setDrawingBufferSize=function(t,i,s){E=t,L=i,C=s,e.width=Math.floor(t*s),e.height=Math.floor(i*s),this.setViewport(0,0,t,i)},this.getCurrentViewport=function(t){return void 0===t&&(console.warn("WebGLRenderer: .getCurrentViewport() now requires a Vector4 as an argument"),t=new li),t.copy(M)},this.getViewport=function(t){return t.copy(k)},this.setViewport=function(t,e,i,s){t.isVector4?k.set(t.x,t.y,t.z,t.w):k.set(t,e,i,s),V.viewport(M.copy(k).multiplyScalar(C).floor())},this.getScissor=function(t){return t.copy(B)},this.setScissor=function(t,e,i,s){t.isVector4?B.set(t.x,t.y,t.z,t.w):B.set(t,e,i,s),V.scissor(T.copy(B).multiplyScalar(C).floor())},this.getScissorTest=function(){return R},this.setScissorTest=function(t){V.setScissorTest(R=t)},this.setOpaqueSort=function(t){A=t},this.setTransparentSort=function(t){P=t},this.getClearColor=function(t){return void 0===t&&(console.warn("WebGLRenderer: .getClearColor() now requires a Color as an argument"),t=new Ds),t.copy(st.getClearColor())},this.setClearColor=function(){st.setClearColor.apply(st,arguments)},this.getClearAlpha=function(){return st.getClearAlpha()},this.setClearAlpha=function(){st.setClearAlpha.apply(st,arguments)},this.clear=function(t,e,i){let s=0;(void 0===t||t)&&(s|=16384),(void 0===e||e)&&(s|=256),(void 0===i||i)&&(s|=1024),lt.clear(s)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){e.removeEventListener("webglcontextlost",ft,!1),e.removeEventListener("webglcontextrestored",gt,!1),tt.dispose(),et.dispose(),j.dispose(),X.dispose(),K.dispose(),ht.dispose(),ut.dispose(),St.stop()},this.renderBufferImmediate=function(t,e){ht.initAttributes();const i=j.get(t);t.hasPositions&&!i.position&&(i.position=lt.createBuffer()),t.hasNormals&&!i.normal&&(i.normal=lt.createBuffer()),t.hasUvs&&!i.uv&&(i.uv=lt.createBuffer()),t.hasColors&&!i.color&&(i.color=lt.createBuffer());const s=e.getAttributes();t.hasPositions&&(lt.bindBuffer(34962,i.position),lt.bufferData(34962,t.positionArray,35048),ht.enableAttribute(s.position),lt.vertexAttribPointer(s.position,3,5126,!1,0,0)),t.hasNormals&&(lt.bindBuffer(34962,i.normal),lt.bufferData(34962,t.normalArray,35048),ht.enableAttribute(s.normal),lt.vertexAttribPointer(s.normal,3,5126,!1,0,0)),t.hasUvs&&(lt.bindBuffer(34962,i.uv),lt.bufferData(34962,t.uvArray,35048),ht.enableAttribute(s.uv),lt.vertexAttribPointer(s.uv,2,5126,!1,0,0)),t.hasColors&&(lt.bindBuffer(34962,i.color),lt.bufferData(34962,t.colorArray,35048),ht.enableAttribute(s.color),lt.vertexAttribPointer(s.color,3,5126,!1,0,0)),ht.disableUnusedAttributes(),lt.drawArrays(4,0,t.count),t.count=0},this.renderBufferDirect=function(t,e,i,s,n,o){null===e&&(e=N);const r=n.isMesh&&n.matrixWorld.determinant()<0,a=Ct(t,e,s,n);V.setMaterial(s,r);let h=i.index;const l=i.attributes.position;if(null===h){if(void 0===l||0===l.count)return}else if(0===h.count)return;let c,d=1;!0===s.wireframe&&(h=Z.getWireframeAttribute(i),d=2),(s.morphTargets||s.morphNormals)&&nt.update(n,i,s,a),ht.setup(n,s,a,i,h);let u=ot;null!==h&&(c=Y.get(h),u=rt,u.setIndex(c));const p=null!==h?h.count:l.count,m=i.drawRange.start*d,f=i.drawRange.count*d,g=null!==o?o.start*d:0,y=null!==o?o.count*d:1/0,v=Math.max(m,g),w=Math.min(p,m+f,g+y)-1,x=Math.max(0,w-v+1);if(0!==x){if(n.isMesh)!0===s.wireframe?(V.setLineWidth(s.wireframeLinewidth*W()),u.setMode(1)):u.setMode(4);else if(n.isLine){let t=s.linewidth;void 0===t&&(t=1),V.setLineWidth(t*W()),n.isLineSegments?u.setMode(1):n.isLineLoop?u.setMode(2):u.setMode(3)}else n.isPoints?u.setMode(0):n.isSprite&&u.setMode(4);if(n.isInstancedMesh)u.renderInstances(v,x,n.count);else if(i.isInstancedBufferGeometry){const t=Math.min(i.instanceCount,i._maxInstanceCount);u.renderInstances(v,x,t)}else u.render(v,x)}},this.compile=function(t,e){u=et.get(t),u.init(),t.traverseVisible((function(t){t.isLight&&t.layers.test(e.layers)&&(u.pushLight(t),t.castShadow&&u.pushShadow(t))})),u.setupLights();const i=new WeakMap;t.traverse((function(e){const s=e.material;if(s)if(Array.isArray(s))for(let n=0;n<s.length;n++){const o=s[n];!1===i.has(o)&&(Et(o,t,e),i.set(o))}else!1===i.has(s)&&(Et(s,t,e),i.set(s))}))};let bt=null;const St=new Xn;function Mt(t,e,i,s){if(!1===t.visible)return;if(t.layers.test(e.layers))if(t.isGroup)i=t.renderOrder;else if(t.isLOD)!0===t.autoUpdate&&t.update(e);else if(t.isLight)u.pushLight(t),t.castShadow&&u.pushShadow(t);else if(t.isSprite){if(!t.frustumCulled||D.intersectsSprite(t)){s&&O.setFromMatrixPosition(t.matrixWorld).applyMatrix4(z);const e=K.update(t),n=t.material;n.visible&&d.push(t,e,n,i,O.z,null)}}else if(t.isImmediateRenderObject)s&&O.setFromMatrixPosition(t.matrixWorld).applyMatrix4(z),d.push(t,null,t.material,i,O.z,null);else if((t.isMesh||t.isLine||t.isPoints)&&(t.isSkinnedMesh&&t.skeleton.frame!==G.render.frame&&(t.skeleton.update(),t.skeleton.frame=G.render.frame),!t.frustumCulled||D.intersectsObject(t))){s&&O.setFromMatrixPosition(t.matrixWorld).applyMatrix4(z);const e=K.update(t),n=t.material;if(Array.isArray(n)){const s=e.groups;for(let o=0,r=s.length;o<r;o++){const r=s[o],a=n[r.materialIndex];a&&a.visible&&d.push(t,e,a,i,O.z,r)}}else n.visible&&d.push(t,e,n,i,O.z,null)}const n=t.children;for(let t=0,o=n.length;t<o;t++)Mt(n[t],e,i,s)}function Tt(t,e,i){const s=!0===e.isScene?e.overrideMaterial:null;for(let n=0,o=t.length;n<o;n++){const o=t[n],r=o.object,a=o.geometry,h=null===s?o.material:s,l=o.group;if(i.isArrayCamera){const t=i.cameras;for(let i=0,s=t.length;i<s;i++){const s=t[i];r.layers.test(s.layers)&&(V.viewport(M.copy(s.viewport)),u.setupLightsView(s),_t(r,e,s,a,h,l))}}else _t(r,e,i,a,h,l)}}function _t(t,e,i,s,n,o){if(t.onBeforeRender(m,e,i,s,n,o),t.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,t.matrixWorld),t.normalMatrix.getNormalMatrix(t.modelViewMatrix),t.isImmediateRenderObject){const s=Ct(i,e,n,t);V.setMaterial(n),ht.reset(),function(t,e){t.render((function(t){m.renderBufferImmediate(t,e)}))}(t,s)}else m.renderBufferDirect(i,e,s,n,t,o);t.onAfterRender(m,e,i,s,n,o)}function Et(t,e,i){!0!==e.isScene&&(e=N);const s=j.get(t),n=u.state.lights,o=u.state.shadowsArray,r=n.state.version,a=J.getParameters(t,n.state,o,e,i),h=J.getProgramCacheKey(a);let l=s.program,c=!0;if(void 0===l)t.addEventListener("dispose",yt);else if(l.cacheKey!==h)vt(t);else if(s.lightsStateVersion!==r)c=!1;else{if(void 0!==a.shaderID){const i=t.isMeshStandardMaterial?e.environment:null;return void(s.envMap=X.get(t.envMap||i))}c=!1}c&&(a.uniforms=J.getUniforms(t),t.onBeforeCompile(a,m),l=J.acquireProgram(a,h),s.program=l,s.uniforms=a.uniforms,s.outputEncoding=a.outputEncoding);const d=s.uniforms;(t.isShaderMaterial||t.isRawShaderMaterial)&&!0!==t.clipping||(s.numClippingPlanes=it.numPlanes,s.numIntersection=it.numIntersection,d.clippingPlanes=it.uniform),s.environment=t.isMeshStandardMaterial?e.environment:null,s.fog=e.fog,s.envMap=X.get(t.envMap||s.environment),s.needsLights=function(t){return t.isMeshLambertMaterial||t.isMeshToonMaterial||t.isMeshPhongMaterial||t.isMeshStandardMaterial||t.isShadowMaterial||t.isShaderMaterial&&!0===t.lights}(t),s.lightsStateVersion=r,s.needsLights&&(d.ambientLightColor.value=n.state.ambient,d.lightProbe.value=n.state.probe,d.directionalLights.value=n.state.directional,d.directionalLightShadows.value=n.state.directionalShadow,d.spotLights.value=n.state.spot,d.spotLightShadows.value=n.state.spotShadow,d.rectAreaLights.value=n.state.rectArea,d.ltc_1.value=n.state.rectAreaLTC1,d.ltc_2.value=n.state.rectAreaLTC2,d.pointLights.value=n.state.point,d.pointLightShadows.value=n.state.pointShadow,d.hemisphereLights.value=n.state.hemi,d.directionalShadowMap.value=n.state.directionalShadowMap,d.directionalShadowMatrix.value=n.state.directionalShadowMatrix,d.spotShadowMap.value=n.state.spotShadowMap,d.spotShadowMatrix.value=n.state.spotShadowMatrix,d.pointShadowMap.value=n.state.pointShadowMap,d.pointShadowMatrix.value=n.state.pointShadowMatrix);const p=s.program.getUniforms(),f=dr.seqWithValue(p.seq,d);s.uniformsList=f}function Ct(t,e,i,s){!0!==e.isScene&&(e=N),$.resetTextureUnits();const n=e.fog,o=i.isMeshStandardMaterial?e.environment:null,r=null===w?m.outputEncoding:w.texture.encoding,a=X.get(i.envMap||o),h=j.get(i),l=u.state.lights;if(!0===I&&(!0===F||t!==S)){const e=t===S&&i.id===b;it.setState(i,t,e)}i.version===h.__version?i.fog&&h.fog!==n||h.environment!==o||h.needsLights&&h.lightsStateVersion!==l.state.version?Et(i,e,s):void 0===h.numClippingPlanes||h.numClippingPlanes===it.numPlanes&&h.numIntersection===it.numIntersection?(h.outputEncoding!==r||h.envMap!==a)&&Et(i,e,s):Et(i,e,s):(Et(i,e,s),h.__version=i.version);let c=!1,d=!1,p=!1;const f=h.program,g=f.getUniforms(),y=h.uniforms;if(V.useProgram(f.program)&&(c=!0,d=!0,p=!0),i.id!==b&&(b=i.id,d=!0),c||S!==t){if(g.setValue(lt,"projectionMatrix",t.projectionMatrix),U.logarithmicDepthBuffer&&g.setValue(lt,"logDepthBufFC",2/(Math.log(t.far+1)/Math.LN2)),S!==t&&(S=t,d=!0,p=!0),i.isShaderMaterial||i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshStandardMaterial||i.envMap){const e=g.map.cameraPosition;void 0!==e&&e.setValue(lt,O.setFromMatrixPosition(t.matrixWorld))}(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial)&&g.setValue(lt,"isOrthographic",!0===t.isOrthographicCamera),(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial||i.isShadowMaterial||i.skinning)&&g.setValue(lt,"viewMatrix",t.matrixWorldInverse)}if(i.skinning){g.setOptional(lt,s,"bindMatrix"),g.setOptional(lt,s,"bindMatrixInverse");const t=s.skeleton;if(t){const e=t.bones;if(U.floatVertexTextures){if(null===t.boneTexture){let i=Math.sqrt(4*e.length);i=ei.ceilPowerOfTwo(i),i=Math.max(i,4);const s=new Float32Array(i*i*4);s.set(t.boneMatrices);const n=new Gn(s,i,i,Lt,wt);t.boneMatrices=s,t.boneTexture=n,t.boneTextureSize=i}g.setValue(lt,"boneTexture",t.boneTexture,$),g.setValue(lt,"boneTextureSize",t.boneTextureSize)}else g.setOptional(lt,t,"boneMatrices")}}var v,x;return(d||h.receiveShadow!==s.receiveShadow)&&(h.receiveShadow=s.receiveShadow,g.setValue(lt,"receiveShadow",s.receiveShadow)),d&&(g.setValue(lt,"toneMappingExposure",m.toneMappingExposure),h.needsLights&&(x=p,(v=y).ambientLightColor.needsUpdate=x,v.lightProbe.needsUpdate=x,v.directionalLights.needsUpdate=x,v.directionalLightShadows.needsUpdate=x,v.pointLights.needsUpdate=x,v.pointLightShadows.needsUpdate=x,v.spotLights.needsUpdate=x,v.spotLightShadows.needsUpdate=x,v.rectAreaLights.needsUpdate=x,v.hemisphereLights.needsUpdate=x),n&&i.fog&&Q.refreshFogUniforms(y,n),Q.refreshMaterialUniforms(y,i,C,L),dr.upload(lt,h.uniformsList,y,$)),i.isShaderMaterial&&!0===i.uniformsNeedUpdate&&(dr.upload(lt,h.uniformsList,y,$),i.uniformsNeedUpdate=!1),i.isSpriteMaterial&&g.setValue(lt,"center",s.center),g.setValue(lt,"modelViewMatrix",s.modelViewMatrix),g.setValue(lt,"normalMatrix",s.normalMatrix),g.setValue(lt,"modelMatrix",s.matrixWorld),f}St.setAnimationLoop((function(t){ut.isPresenting||bt&&bt(t)})),"undefined"!=typeof window&&St.setContext(window),this.setAnimationLoop=function(t){bt=t,ut.setAnimationLoop(t),null===t?St.stop():St.start()},this.render=function(t,e){let i,s;if(void 0!==arguments[2]&&(console.warn("THREE.WebGLRenderer.render(): the renderTarget argument has been removed. Use .setRenderTarget() instead."),i=arguments[2]),void 0!==arguments[3]&&(console.warn("THREE.WebGLRenderer.render(): the forceClear argument has been removed. Use .clear() instead."),s=arguments[3]),void 0!==e&&!0!==e.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===f)return;ht.resetDefaultState(),b=-1,S=null,!0===t.autoUpdate&&t.updateMatrixWorld(),null===e.parent&&e.updateMatrixWorld(),!0===ut.enabled&&!0===ut.isPresenting&&(e=ut.getCamera(e)),!0===t.isScene&&t.onBeforeRender(m,t,e,i||w),u=et.get(t,p.length),u.init(),p.push(u),z.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),D.setFromProjectionMatrix(z),F=this.localClippingEnabled,I=it.init(this.clippingPlanes,F,e),d=tt.get(t,e),d.init(),Mt(t,e,0,m.sortObjects),d.finish(),!0===m.sortObjects&&d.sort(A,P),!0===I&&it.beginShadows();const n=u.state.shadowsArray;mt.render(n,t,e),u.setupLights(),u.setupLightsView(e),!0===I&&it.endShadows(),!0===this.info.autoReset&&this.info.reset(),void 0!==i&&this.setRenderTarget(i),st.render(d,t,e,s);const o=d.opaque,r=d.transparent;o.length>0&&Tt(o,t,e),r.length>0&&Tt(r,t,e),!0===t.isScene&&t.onAfterRender(m,t,e),null!==w&&($.updateRenderTargetMipmap(w),$.updateMultisampleRenderTarget(w)),V.buffers.depth.setTest(!0),V.buffers.depth.setMask(!0),V.buffers.color.setMask(!0),V.setPolygonOffset(!1),p.pop(),u=p.length>0?p[p.length-1]:null,d=null},this.setFramebuffer=function(t){g!==t&&null===w&&lt.bindFramebuffer(36160,t),g=t},this.getActiveCubeFace=function(){return y},this.getActiveMipmapLevel=function(){return v},this.getRenderList=function(){return d},this.setRenderList=function(t){d=t},this.getRenderTarget=function(){return w},this.setRenderTarget=function(t,e=0,i=0){w=t,y=e,v=i,t&&void 0===j.get(t).__webglFramebuffer&&$.setupRenderTarget(t);let s=g,n=!1;if(t){const i=j.get(t).__webglFramebuffer;t.isWebGLCubeRenderTarget?(s=i[e],n=!0):s=t.isWebGLMultisampleRenderTarget?j.get(t).__webglMultisampledFramebuffer:i,M.copy(t.viewport),T.copy(t.scissor),_=t.scissorTest}else M.copy(k).multiplyScalar(C).floor(),T.copy(B).multiplyScalar(C).floor(),_=R;if(x!==s&&(lt.bindFramebuffer(36160,s),x=s),V.viewport(M),V.scissor(T),V.setScissorTest(_),n){const s=j.get(t.texture);lt.framebufferTexture2D(36160,36064,34069+e,s.__webglTexture,i)}},this.readRenderTargetPixels=function(t,e,i,s,n,o,r){if(!t||!t.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let a=j.get(t).__webglFramebuffer;if(t.isWebGLCubeRenderTarget&&void 0!==r&&(a=a[r]),a){let r=!1;a!==x&&(lt.bindFramebuffer(36160,a),r=!0);try{const r=t.texture,a=r.format,h=r.type;if(a!==Lt&&at.convert(a)!==lt.getParameter(35739))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!(h===pt||at.convert(h)===lt.getParameter(35738)||h===wt&&(U.isWebGL2||H.get("OES_texture_float")||H.get("WEBGL_color_buffer_float"))||h===xt&&(U.isWebGL2?H.get("EXT_color_buffer_float"):H.get("EXT_color_buffer_half_float"))))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");36053===lt.checkFramebufferStatus(36160)?e>=0&&e<=t.width-s&&i>=0&&i<=t.height-n&&lt.readPixels(e,i,s,n,at.convert(a),at.convert(h),o):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{r&&lt.bindFramebuffer(36160,x)}}},this.copyFramebufferToTexture=function(t,e,i=0){const s=Math.pow(2,-i),n=Math.floor(e.image.width*s),o=Math.floor(e.image.height*s),r=at.convert(e.format);$.setTexture2D(e,0),lt.copyTexImage2D(3553,i,r,t.x,t.y,n,o,0),V.unbindTexture()},this.copyTextureToTexture=function(t,e,i,s=0){const n=e.image.width,o=e.image.height,r=at.convert(i.format),a=at.convert(i.type);$.setTexture2D(i,0),lt.pixelStorei(37440,i.flipY),lt.pixelStorei(37441,i.premultiplyAlpha),lt.pixelStorei(3317,i.unpackAlignment),e.isDataTexture?lt.texSubImage2D(3553,s,t.x,t.y,n,o,r,a,e.image.data):e.isCompressedTexture?lt.compressedTexSubImage2D(3553,s,t.x,t.y,e.mipmaps[0].width,e.mipmaps[0].height,r,e.mipmaps[0].data):lt.texSubImage2D(3553,s,t.x,t.y,r,a,e.image),0===s&&i.generateMipmaps&&lt.generateMipmap(3553),V.unbindTexture()},this.initTexture=function(t){$.setTexture2D(t,0),V.unbindTexture()},this.resetState=function(){V.reset(),ht.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}function na(t){sa.call(this,t)}Jr.prototype=Object.assign(Object.create(Nn.prototype),{constructor:Jr,isArrayCamera:!0}),Qr.prototype=Object.assign(Object.create(us.prototype),{constructor:Qr,isGroup:!0}),Object.assign(ta.prototype,{constructor:ta,getHandSpace:function(){if(null===this._hand&&(this._hand=new Qr,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints=[],this._hand.inputState={pinching:!1},window.XRHand))for(let t=0;t<=window.XRHand.LITTLE_PHALANX_TIP;t++){const t=new Qr;t.matrixAutoUpdate=!1,t.visible=!1,this._hand.joints.push(t),this._hand.add(t)}return this._hand},getTargetRaySpace:function(){return null===this._targetRay&&(this._targetRay=new Qr,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1),this._targetRay},getGripSpace:function(){return null===this._grip&&(this._grip=new Qr,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1),this._grip},dispatchEvent:function(t){return null!==this._targetRay&&this._targetRay.dispatchEvent(t),null!==this._grip&&this._grip.dispatchEvent(t),null!==this._hand&&this._hand.dispatchEvent(t),this},disconnect:function(t){return this.dispatchEvent({type:"disconnected",data:t}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this},update:function(t,e,i){let s=null,n=null,o=null;const r=this._targetRay,a=this._grip,h=this._hand;if(t&&"visible-blurred"!==e.session.visibilityState)if(h&&t.hand){o=!0;for(let s=0;s<=window.XRHand.LITTLE_PHALANX_TIP;s++)if(t.hand[s]){const n=e.getJointPose(t.hand[s],i),o=h.joints[s];null!==n&&(o.matrix.fromArray(n.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.jointRadius=n.radius),o.visible=null!==n;const r=h.joints[window.XRHand.INDEX_PHALANX_TIP],a=h.joints[window.XRHand.THUMB_PHALANX_TIP],l=r.position.distanceTo(a.position),c=.02,d=.005;h.inputState.pinching&&l>c+d?(h.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:t.handedness,target:this})):!h.inputState.pinching&&l<=c-d&&(h.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:t.handedness,target:this}))}}else null!==r&&(s=e.getPose(t.targetRaySpace,i),null!==s&&(r.matrix.fromArray(s.transform.matrix),r.matrix.decompose(r.position,r.rotation,r.scale))),null!==a&&t.gripSpace&&(n=e.getPose(t.gripSpace,i),null!==n&&(a.matrix.fromArray(n.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale)));return null!==r&&(r.visible=null!==s),null!==a&&(a.visible=null!==n),null!==h&&(h.visible=null!==o),this}}),Object.assign(ea.prototype,Je.prototype),na.prototype=Object.assign(Object.create(sa.prototype),{constructor:na,isWebGL1Renderer:!0});class oa extends us{constructor(){super(),Object.defineProperty(this,"isScene",{value:!0}),this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(t,e){return super.copy(t,e),null!==t.background&&(this.background=t.background.clone()),null!==t.environment&&(this.environment=t.environment.clone()),null!==t.fog&&(this.fog=t.fog.clone()),null!==t.overrideMaterial&&(this.overrideMaterial=t.overrideMaterial.clone()),this.autoUpdate=t.autoUpdate,this.matrixAutoUpdate=t.matrixAutoUpdate,this}toJSON(t){const e=super.toJSON(t);return null!==this.background&&(e.object.background=this.background.toJSON(t)),null!==this.environment&&(e.object.environment=this.environment.toJSON(t)),null!==this.fog&&(e.object.fog=this.fog.toJSON()),e}}function ra(t,e){this.array=t,this.stride=e,this.count=void 0!==t?t.length/e:0,this.usage=Ye,this.updateRange={offset:0,count:-1},this.version=0,this.uuid=ei.generateUUID()}Object.defineProperty(ra.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}}),Object.assign(ra.prototype,{isInterleavedBuffer:!0,onUploadCallback:function(){},setUsage:function(t){return this.usage=t,this},copy:function(t){return this.array=new t.array.constructor(t.array),this.count=t.count,this.stride=t.stride,this.usage=t.usage,this},copyAt:function(t,e,i){t*=this.stride,i*=e.stride;for(let s=0,n=this.stride;s<n;s++)this.array[t+s]=e.array[i+s];return this},set:function(t,e=0){return this.array.set(t,e),this},clone:function(t){void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=ei.generateUUID()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const e=new ra(new this.array.constructor(t.arrayBuffers[this.array.buffer._uuid]),this.stride);return e.setUsage(this.usage),e},onUpload:function(t){return this.onUploadCallback=t,this},toJSON:function(t){return void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=ei.generateUUID()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=Array.prototype.slice.call(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}});const aa=new pi;function ha(t,e,i,s){this.name="",this.data=t,this.itemSize=e,this.offset=i,this.normalized=!0===s}function la(t){zs.call(this),this.type="SpriteMaterial",this.color=new Ds(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.setValues(t)}let ca;Object.defineProperties(ha.prototype,{count:{get:function(){return this.data.count}},array:{get:function(){return this.data.array}},needsUpdate:{set:function(t){this.data.needsUpdate=t}}}),Object.assign(ha.prototype,{isInterleavedBufferAttribute:!0,applyMatrix4:function(t){for(let e=0,i=this.data.count;e<i;e++)aa.x=this.getX(e),aa.y=this.getY(e),aa.z=this.getZ(e),aa.applyMatrix4(t),this.setXYZ(e,aa.x,aa.y,aa.z);return this},setX:function(t,e){return this.data.array[t*this.data.stride+this.offset]=e,this},setY:function(t,e){return this.data.array[t*this.data.stride+this.offset+1]=e,this},setZ:function(t,e){return this.data.array[t*this.data.stride+this.offset+2]=e,this},setW:function(t,e){return this.data.array[t*this.data.stride+this.offset+3]=e,this},getX:function(t){return this.data.array[t*this.data.stride+this.offset]},getY:function(t){return this.data.array[t*this.data.stride+this.offset+1]},getZ:function(t){return this.data.array[t*this.data.stride+this.offset+2]},getW:function(t){return this.data.array[t*this.data.stride+this.offset+3]},setXY:function(t,e,i){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this},setXYZ:function(t,e,i,s){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=s,this},setXYZW:function(t,e,i,s,n){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=s,this.data.array[t+3]=n,this},clone:function(t){if(void 0===t){console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interlaved buffer attribute will deinterleave buffer data.");const t=[];for(let e=0;e<this.count;e++){const i=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[i+e])}return new Hs(new this.array.constructor(t),this.itemSize,this.normalized)}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.clone(t)),new ha(t.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)},toJSON:function(t){if(void 0===t){console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interlaved buffer attribute will deinterleave buffer data.");const t=[];for(let e=0;e<this.count;e++){const i=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[i+e])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:t,normalized:this.normalized}}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.toJSON(t)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}),la.prototype=Object.create(zs.prototype),la.prototype.constructor=la,la.prototype.isSpriteMaterial=!0,la.prototype.copy=function(t){return zs.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.rotation=t.rotation,this.sizeAttenuation=t.sizeAttenuation,this};const da=new pi,ua=new pi,pa=new pi,ma=new ii,fa=new ii,ga=new Hi,ya=new pi,va=new pi,wa=new pi,xa=new ii,ba=new ii,Sa=new ii;function Ma(t){if(us.call(this),this.type="Sprite",void 0===ca){ca=new cn;const t=new ra(new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),5);ca.setIndex([0,1,2,0,2,3]),ca.setAttribute("position",new ha(t,3,0,!1)),ca.setAttribute("uv",new ha(t,2,3,!1))}this.geometry=ca,this.material=void 0!==t?t:new la,this.center=new ii(.5,.5)}function Ta(t,e,i,s,n,o){ma.subVectors(t,i).addScalar(.5).multiply(s),void 0!==n?(fa.x=o*ma.x-n*ma.y,fa.y=n*ma.x+o*ma.y):fa.copy(ma),t.copy(e),t.x+=fa.x,t.y+=fa.y,t.applyMatrix4(ga)}Ma.prototype=Object.assign(Object.create(us.prototype),{constructor:Ma,isSprite:!0,raycast:function(t,e){null===t.camera&&console.error('THREE.Sprite: "Raycaster.camera" needs to be set in order to raycast against sprites.'),ua.setFromMatrixScale(this.matrixWorld),ga.copy(t.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(t.camera.matrixWorldInverse,this.matrixWorld),pa.setFromMatrixPosition(this.modelViewMatrix),t.camera.isPerspectiveCamera&&!1===this.material.sizeAttenuation&&ua.multiplyScalar(-pa.z);const i=this.material.rotation;let s,n;0!==i&&(n=Math.cos(i),s=Math.sin(i));const o=this.center;Ta(ya.set(-.5,-.5,0),pa,o,ua,s,n),Ta(va.set(.5,-.5,0),pa,o,ua,s,n),Ta(wa.set(.5,.5,0),pa,o,ua,s,n),xa.set(0,0),ba.set(1,0),Sa.set(1,1);let r=t.ray.intersectTriangle(ya,va,wa,!1,da);if(null===r&&(Ta(va.set(-.5,.5,0),pa,o,ua,s,n),ba.set(0,1),r=t.ray.intersectTriangle(ya,wa,va,!1,da),null===r))return;const a=t.ray.origin.distanceTo(da);a<t.near||a>t.far||e.push({distance:a,point:da.clone(),uv:Ls.getUV(da,ya,va,wa,xa,ba,Sa,new ii),face:null,object:this})},copy:function(t){return us.prototype.copy.call(this,t),void 0!==t.center&&this.center.copy(t.center),this.material=t.material,this}});const _a=new pi,Ea=new pi;function La(){us.call(this),this._currentLevel=0,this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]}}),this.autoUpdate=!0}La.prototype=Object.assign(Object.create(us.prototype),{constructor:La,isLOD:!0,copy:function(t){us.prototype.copy.call(this,t,!1);const e=t.levels;for(let t=0,i=e.length;t<i;t++){const i=e[t];this.addLevel(i.object.clone(),i.distance)}return this.autoUpdate=t.autoUpdate,this},addLevel:function(t,e=0){e=Math.abs(e);const i=this.levels;let s;for(s=0;s<i.length&&!(e<i[s].distance);s++);return i.splice(s,0,{distance:e,object:t}),this.add(t),this},getCurrentLevel:function(){return this._currentLevel},getObjectForDistance:function(t){const e=this.levels;if(e.length>0){let i,s;for(i=1,s=e.length;i<s&&!(t<e[i].distance);i++);return e[i-1].object}return null},raycast:function(t,e){if(this.levels.length>0){_a.setFromMatrixPosition(this.matrixWorld);const i=t.ray.origin.distanceTo(_a);this.getObjectForDistance(i).raycast(t,e)}},update:function(t){const e=this.levels;if(e.length>1){_a.setFromMatrixPosition(t.matrixWorld),Ea.setFromMatrixPosition(this.matrixWorld);const i=_a.distanceTo(Ea)/t.zoom;let s,n;for(e[0].object.visible=!0,s=1,n=e.length;s<n&&i>=e[s].distance;s++)e[s-1].object.visible=!1,e[s].object.visible=!0;for(this._currentLevel=s-1;s<n;s++)e[s].object.visible=!1}},toJSON:function(t){const e=us.prototype.toJSON.call(this,t);!1===this.autoUpdate&&(e.object.autoUpdate=!1),e.object.levels=[];const i=this.levels;for(let t=0,s=i.length;t<s;t++){const s=i[t];e.object.levels.push({object:s.object.uuid,distance:s.distance})}return e}});const Ca=new pi,Aa=new li,Pa=new li,ka=new pi,Ba=new Hi;function Ra(t,e){t&&t.isGeometry&&console.error("THREE.SkinnedMesh no longer supports THREE.Geometry. Use THREE.BufferGeometry instead."),Cn.call(this,t,e),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new Hi,this.bindMatrixInverse=new Hi}function Da(){us.call(this),this.type="Bone"}Ra.prototype=Object.assign(Object.create(Cn.prototype),{constructor:Ra,isSkinnedMesh:!0,copy:function(t){return Cn.prototype.copy.call(this,t),this.bindMode=t.bindMode,this.bindMatrix.copy(t.bindMatrix),this.bindMatrixInverse.copy(t.bindMatrixInverse),this.skeleton=t.skeleton,this},bind:function(t,e){this.skeleton=t,void 0===e&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),e=this.matrixWorld),this.bindMatrix.copy(e),this.bindMatrixInverse.copy(e).invert()},pose:function(){this.skeleton.pose()},normalizeSkinWeights:function(){const t=new li,e=this.geometry.attributes.skinWeight;for(let i=0,s=e.count;i<s;i++){t.x=e.getX(i),t.y=e.getY(i),t.z=e.getZ(i),t.w=e.getW(i);const s=1/t.manhattanLength();s!==1/0?t.multiplyScalar(s):t.set(1,0,0,0),e.setXYZW(i,t.x,t.y,t.z,t.w)}},updateMatrixWorld:function(t){Cn.prototype.updateMatrixWorld.call(this,t),"attached"===this.bindMode?this.bindMatrixInverse.copy(this.matrixWorld).invert():"detached"===this.bindMode?this.bindMatrixInverse.copy(this.bindMatrix).invert():console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)},boneTransform:function(t,e){const i=this.skeleton,s=this.geometry;Aa.fromBufferAttribute(s.attributes.skinIndex,t),Pa.fromBufferAttribute(s.attributes.skinWeight,t),Ca.fromBufferAttribute(s.attributes.position,t).applyMatrix4(this.bindMatrix),e.set(0,0,0);for(let t=0;t<4;t++){const s=Pa.getComponent(t);if(0!==s){const n=Aa.getComponent(t);Ba.multiplyMatrices(i.bones[n].matrixWorld,i.boneInverses[n]),e.addScaledVector(ka.copy(Ca).applyMatrix4(Ba),s)}}return e.applyMatrix4(this.bindMatrixInverse)}}),Da.prototype=Object.assign(Object.create(us.prototype),{constructor:Da,isBone:!0});const Ia=new Hi,Fa=new Hi;function za(t=[],e=[]){this.uuid=ei.generateUUID(),this.bones=t.slice(0),this.boneInverses=e,this.boneMatrices=null,this.boneTexture=null,this.boneTextureSize=0,this.frame=-1,this.init()}Object.assign(za.prototype,{init:function(){const t=this.bones,e=this.boneInverses;if(this.boneMatrices=new Float32Array(16*t.length),0===e.length)this.calculateInverses();else if(t.length!==e.length){console.warn("THREE.Skeleton: Number of inverse bone matrices does not match amount of bones."),this.boneInverses=[];for(let t=0,e=this.bones.length;t<e;t++)this.boneInverses.push(new Hi)}},calculateInverses:function(){this.boneInverses.length=0;for(let t=0,e=this.bones.length;t<e;t++){const e=new Hi;this.bones[t]&&e.copy(this.bones[t].matrixWorld).invert(),this.boneInverses.push(e)}},pose:function(){for(let t=0,e=this.bones.length;t<e;t++){const e=this.bones[t];e&&e.matrixWorld.copy(this.boneInverses[t]).invert()}for(let t=0,e=this.bones.length;t<e;t++){const e=this.bones[t];e&&(e.parent&&e.parent.isBone?(e.matrix.copy(e.parent.matrixWorld).invert(),e.matrix.multiply(e.matrixWorld)):e.matrix.copy(e.matrixWorld),e.matrix.decompose(e.position,e.quaternion,e.scale))}},update:function(){const t=this.bones,e=this.boneInverses,i=this.boneMatrices,s=this.boneTexture;for(let s=0,n=t.length;s<n;s++){const n=t[s]?t[s].matrixWorld:Fa;Ia.multiplyMatrices(n,e[s]),Ia.toArray(i,16*s)}null!==s&&(s.needsUpdate=!0)},clone:function(){return new za(this.bones,this.boneInverses)},getBoneByName:function(t){for(let e=0,i=this.bones.length;e<i;e++){const i=this.bones[e];if(i.name===t)return i}},dispose:function(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)},fromJSON:function(t,e){this.uuid=t.uuid;for(let i=0,s=t.bones.length;i<s;i++){const s=t.bones[i];let n=e[s];void 0===n&&(console.warn("THREE.Skeleton: No bone found with UUID:",s),n=new Da),this.bones.push(n),this.boneInverses.push((new Hi).fromArray(t.boneInverses[i]))}return this.init(),this},toJSON:function(){const t={metadata:{version:4.5,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};t.uuid=this.uuid;const e=this.bones,i=this.boneInverses;for(let s=0,n=e.length;s<n;s++){const n=e[s];t.bones.push(n.uuid);const o=i[s];t.boneInverses.push(o.toArray())}return t}});const Oa=new Hi,Na=new Hi,Wa=[],Ha=new Cn;function Ua(t,e,i){Cn.call(this,t,e),this.instanceMatrix=new Hs(new Float32Array(16*i),16),this.instanceColor=null,this.count=i,this.frustumCulled=!1}function Va(t){zs.call(this),this.type="LineBasicMaterial",this.color=new Ds(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.morphTargets=!1,this.setValues(t)}Ua.prototype=Object.assign(Object.create(Cn.prototype),{constructor:Ua,isInstancedMesh:!0,copy:function(t){return Cn.prototype.copy.call(this,t),this.instanceMatrix.copy(t.instanceMatrix),this.count=t.count,this},getColorAt:function(t,e){e.fromArray(this.instanceColor.array,3*t)},getMatrixAt:function(t,e){e.fromArray(this.instanceMatrix.array,16*t)},raycast:function(t,e){const i=this.matrixWorld,s=this.count;if(Ha.geometry=this.geometry,Ha.material=this.material,void 0!==Ha.material)for(let n=0;n<s;n++){this.getMatrixAt(n,Oa),Na.multiplyMatrices(i,Oa),Ha.matrixWorld=Na,Ha.raycast(t,Wa);for(let t=0,i=Wa.length;t<i;t++){const i=Wa[t];i.instanceId=n,i.object=this,e.push(i)}Wa.length=0}},setColorAt:function(t,e){null===this.instanceColor&&(this.instanceColor=new Hs(new Float32Array(3*this.count),3)),e.toArray(this.instanceColor.array,3*t)},setMatrixAt:function(t,e){e.toArray(this.instanceMatrix.array,16*t)},updateMorphTargets:function(){},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Va.prototype=Object.create(zs.prototype),Va.prototype.constructor=Va,Va.prototype.isLineBasicMaterial=!0,Va.prototype.copy=function(t){return zs.prototype.copy.call(this,t),this.color.copy(t.color),this.linewidth=t.linewidth,this.linecap=t.linecap,this.linejoin=t.linejoin,this.morphTargets=t.morphTargets,this};const Ga=new pi,ja=new pi,qa=new Hi,$a=new Wi,Xa=new Bi;function Ya(t=new cn,e=new Va){us.call(this),this.type="Line",this.geometry=t,this.material=e,this.updateMorphTargets()}Ya.prototype=Object.assign(Object.create(us.prototype),{constructor:Ya,isLine:!0,copy:function(t){return us.prototype.copy.call(this,t),this.material=t.material,this.geometry=t.geometry,this},computeLineDistances:function(){const t=this.geometry;if(t.isBufferGeometry)if(null===t.index){const e=t.attributes.position,i=[0];for(let t=1,s=e.count;t<s;t++)Ga.fromBufferAttribute(e,t-1),ja.fromBufferAttribute(e,t),i[t]=i[t-1],i[t]+=Ga.distanceTo(ja);t.setAttribute("lineDistance",new Zs(i,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else if(t.isGeometry){const e=t.vertices,i=t.lineDistances;i[0]=0;for(let t=1,s=e.length;t<s;t++)i[t]=i[t-1],i[t]+=e[t-1].distanceTo(e[t])}return this},raycast:function(t,e){const i=this.geometry,s=this.matrixWorld,n=t.params.Line.threshold;if(null===i.boundingSphere&&i.computeBoundingSphere(),Xa.copy(i.boundingSphere),Xa.applyMatrix4(s),Xa.radius+=n,!1===t.ray.intersectsSphere(Xa))return;qa.copy(s).invert(),$a.copy(t.ray).applyMatrix4(qa);const o=n/((this.scale.x+this.scale.y+this.scale.z)/3),r=o*o,a=new pi,h=new pi,l=new pi,c=new pi,d=this.isLineSegments?2:1;if(i.isBufferGeometry){const s=i.index,n=i.attributes.position;if(null!==s){const i=s.array;for(let s=0,o=i.length-1;s<o;s+=d){const o=i[s],d=i[s+1];if(a.fromBufferAttribute(n,o),h.fromBufferAttribute(n,d),$a.distanceSqToSegment(a,h,c,l)>r)continue;c.applyMatrix4(this.matrixWorld);const u=t.ray.origin.distanceTo(c);u<t.near||u>t.far||e.push({distance:u,point:l.clone().applyMatrix4(this.matrixWorld),index:s,face:null,faceIndex:null,object:this})}}else for(let i=0,s=n.count-1;i<s;i+=d){if(a.fromBufferAttribute(n,i),h.fromBufferAttribute(n,i+1),$a.distanceSqToSegment(a,h,c,l)>r)continue;c.applyMatrix4(this.matrixWorld);const s=t.ray.origin.distanceTo(c);s<t.near||s>t.far||e.push({distance:s,point:l.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}else if(i.isGeometry){const s=i.vertices,n=s.length;for(let i=0;i<n-1;i+=d){if($a.distanceSqToSegment(s[i],s[i+1],c,l)>r)continue;c.applyMatrix4(this.matrixWorld);const n=t.ray.origin.distanceTo(c);n<t.near||n>t.far||e.push({distance:n,point:l.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}},updateMorphTargets:function(){const t=this.geometry;if(t.isBufferGeometry){const e=t.morphAttributes,i=Object.keys(e);if(i.length>0){const t=e[i[0]];if(void 0!==t){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=t.length;e<i;e++){const i=t[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}else{const e=t.morphTargets;void 0!==e&&e.length>0&&console.error("THREE.Line.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}});const Za=new pi,Ka=new pi;function Ja(t,e){Ya.call(this,t,e),this.type="LineSegments"}function Qa(t,e){Ya.call(this,t,e),this.type="LineLoop"}function th(t){zs.call(this),this.type="PointsMaterial",this.color=new Ds(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.morphTargets=!1,this.setValues(t)}Ja.prototype=Object.assign(Object.create(Ya.prototype),{constructor:Ja,isLineSegments:!0,computeLineDistances:function(){const t=this.geometry;if(t.isBufferGeometry)if(null===t.index){const e=t.attributes.position,i=[];for(let t=0,s=e.count;t<s;t+=2)Za.fromBufferAttribute(e,t),Ka.fromBufferAttribute(e,t+1),i[t]=0===t?0:i[t-1],i[t+1]=i[t]+Za.distanceTo(Ka);t.setAttribute("lineDistance",new Zs(i,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else if(t.isGeometry){const e=t.vertices,i=t.lineDistances;for(let t=0,s=e.length;t<s;t+=2)Za.copy(e[t]),Ka.copy(e[t+1]),i[t]=0===t?0:i[t-1],i[t+1]=i[t]+Za.distanceTo(Ka)}return this}}),Qa.prototype=Object.assign(Object.create(Ya.prototype),{constructor:Qa,isLineLoop:!0}),th.prototype=Object.create(zs.prototype),th.prototype.constructor=th,th.prototype.isPointsMaterial=!0,th.prototype.copy=function(t){return zs.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.size=t.size,this.sizeAttenuation=t.sizeAttenuation,this.morphTargets=t.morphTargets,this};const eh=new Hi,ih=new Wi,sh=new Bi,nh=new pi;function oh(t=new cn,e=new th){us.call(this),this.type="Points",this.geometry=t,this.material=e,this.updateMorphTargets()}function rh(t,e,i,s,n,o,r){const a=ih.distanceSqToPoint(t);if(a<i){const i=new pi;ih.closestPointToPoint(t,i),i.applyMatrix4(s);const h=n.ray.origin.distanceTo(i);if(h<n.near||h>n.far)return;o.push({distance:h,distanceToRay:Math.sqrt(a),point:i,index:e,face:null,object:r})}}function ah(t,e,i,s,n,o,r,a,h){ai.call(this,t,e,i,s,n,o,r,a,h),this.format=void 0!==r?r:Et,this.minFilter=void 0!==o?o:ct,this.magFilter=void 0!==n?n:ct,this.generateMipmaps=!1;const l=this;"requestVideoFrameCallback"in t&&t.requestVideoFrameCallback((function e(){l.needsUpdate=!0,t.requestVideoFrameCallback(e)}))}function hh(t,e,i,s,n,o,r,a,h,l,c,d){ai.call(this,null,o,r,a,h,l,s,n,c,d),this.image={width:e,height:i},this.mipmaps=t,this.flipY=!1,this.generateMipmaps=!1}function lh(t,e,i,s,n,o,r,a,h){ai.call(this,t,e,i,s,n,o,r,a,h),this.needsUpdate=!0}function ch(t,e,i,s,n,o,r,a,h,l){if((l=void 0!==l?l:kt)!==kt&&l!==Bt)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===i&&l===kt&&(i=gt),void 0===i&&l===Bt&&(i=Tt),ai.call(this,null,s,n,o,r,a,l,i,h),this.image={width:t,height:e},this.magFilter=void 0!==r?r:at,this.minFilter=void 0!==a?a:at,this.flipY=!1,this.generateMipmaps=!1}oh.prototype=Object.assign(Object.create(us.prototype),{constructor:oh,isPoints:!0,copy:function(t){return us.prototype.copy.call(this,t),this.material=t.material,this.geometry=t.geometry,this},raycast:function(t,e){const i=this.geometry,s=this.matrixWorld,n=t.params.Points.threshold;if(null===i.boundingSphere&&i.computeBoundingSphere(),sh.copy(i.boundingSphere),sh.applyMatrix4(s),sh.radius+=n,!1===t.ray.intersectsSphere(sh))return;eh.copy(s).invert(),ih.copy(t.ray).applyMatrix4(eh);const o=n/((this.scale.x+this.scale.y+this.scale.z)/3),r=o*o;if(i.isBufferGeometry){const n=i.index,o=i.attributes.position;if(null!==n){const i=n.array;for(let n=0,a=i.length;n<a;n++){const a=i[n];nh.fromBufferAttribute(o,a),rh(nh,a,r,s,t,e,this)}}else for(let i=0,n=o.count;i<n;i++)nh.fromBufferAttribute(o,i),rh(nh,i,r,s,t,e,this)}else{const n=i.vertices;for(let i=0,o=n.length;i<o;i++)rh(n[i],i,r,s,t,e,this)}},updateMorphTargets:function(){const t=this.geometry;if(t.isBufferGeometry){const e=t.morphAttributes,i=Object.keys(e);if(i.length>0){const t=e[i[0]];if(void 0!==t){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=t.length;e<i;e++){const i=t[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}else{const e=t.morphTargets;void 0!==e&&e.length>0&&console.error("THREE.Points.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}}),ah.prototype=Object.assign(Object.create(ai.prototype),{constructor:ah,clone:function(){return new this.constructor(this.image).copy(this)},isVideoTexture:!0,update:function(){const t=this.image;!1=="requestVideoFrameCallback"in t&&t.readyState>=t.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}),hh.prototype=Object.create(ai.prototype),hh.prototype.constructor=hh,hh.prototype.isCompressedTexture=!0,lh.prototype=Object.create(ai.prototype),lh.prototype.constructor=lh,lh.prototype.isCanvasTexture=!0,ch.prototype=Object.create(ai.prototype),ch.prototype.constructor=ch,ch.prototype.isDepthTexture=!0;let dh=0;const uh=new Hi,ph=new us,mh=new pi;function fh(){Object.defineProperty(this,"id",{value:dh+=2}),this.uuid=ei.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}fh.prototype=Object.assign(Object.create(Je.prototype),{constructor:fh,isGeometry:!0,applyMatrix4:function(t){const e=(new si).getNormalMatrix(t);for(let e=0,i=this.vertices.length;e<i;e++)this.vertices[e].applyMatrix4(t);for(let t=0,i=this.faces.length;t<i;t++){const i=this.faces[t];i.normal.applyMatrix3(e).normalize();for(let t=0,s=i.vertexNormals.length;t<s;t++)i.vertexNormals[t].applyMatrix3(e).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this},rotateX:function(t){return uh.makeRotationX(t),this.applyMatrix4(uh),this},rotateY:function(t){return uh.makeRotationY(t),this.applyMatrix4(uh),this},rotateZ:function(t){return uh.makeRotationZ(t),this.applyMatrix4(uh),this},translate:function(t,e,i){return uh.makeTranslation(t,e,i),this.applyMatrix4(uh),this},scale:function(t,e,i){return uh.makeScale(t,e,i),this.applyMatrix4(uh),this},lookAt:function(t){return ph.lookAt(t),ph.updateMatrix(),this.applyMatrix4(ph.matrix),this},fromBufferGeometry:function(t){const e=this,i=null!==t.index?t.index:void 0,s=t.attributes;if(void 0===s.position)return console.error("THREE.Geometry.fromBufferGeometry(): Position attribute required for conversion."),this;const n=s.position,o=s.normal,r=s.color,a=s.uv,h=s.uv2;void 0!==h&&(this.faceVertexUvs[1]=[]);for(let t=0;t<n.count;t++)e.vertices.push((new pi).fromBufferAttribute(n,t)),void 0!==r&&e.colors.push((new Ds).fromBufferAttribute(r,t));function l(t,i,s,n){const l=void 0===r?[]:[e.colors[t].clone(),e.colors[i].clone(),e.colors[s].clone()],c=void 0===o?[]:[(new pi).fromBufferAttribute(o,t),(new pi).fromBufferAttribute(o,i),(new pi).fromBufferAttribute(o,s)],d=new Is(t,i,s,c,l,n);e.faces.push(d),void 0!==a&&e.faceVertexUvs[0].push([(new ii).fromBufferAttribute(a,t),(new ii).fromBufferAttribute(a,i),(new ii).fromBufferAttribute(a,s)]),void 0!==h&&e.faceVertexUvs[1].push([(new ii).fromBufferAttribute(h,t),(new ii).fromBufferAttribute(h,i),(new ii).fromBufferAttribute(h,s)])}const c=t.groups;if(c.length>0)for(let t=0;t<c.length;t++){const e=c[t],s=e.start;for(let t=s,n=s+e.count;t<n;t+=3)void 0!==i?l(i.getX(t),i.getX(t+1),i.getX(t+2),e.materialIndex):l(t,t+1,t+2,e.materialIndex)}else if(void 0!==i)for(let t=0;t<i.count;t+=3)l(i.getX(t),i.getX(t+1),i.getX(t+2));else for(let t=0;t<n.count;t+=3)l(t,t+1,t+2);return this.computeFaceNormals(),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),this},center:function(){return this.computeBoundingBox(),this.boundingBox.getCenter(mh).negate(),this.translate(mh.x,mh.y,mh.z),this},normalize:function(){this.computeBoundingSphere();const t=this.boundingSphere.center,e=this.boundingSphere.radius,i=0===e?1:1/e,s=new Hi;return s.set(i,0,0,-i*t.x,0,i,0,-i*t.y,0,0,i,-i*t.z,0,0,0,1),this.applyMatrix4(s),this},computeFaceNormals:function(){const t=new pi,e=new pi;for(let i=0,s=this.faces.length;i<s;i++){const s=this.faces[i],n=this.vertices[s.a],o=this.vertices[s.b],r=this.vertices[s.c];t.subVectors(r,o),e.subVectors(n,o),t.cross(e),t.normalize(),s.normal.copy(t)}},computeVertexNormals:function(t=!0){const e=new Array(this.vertices.length);for(let t=0,i=this.vertices.length;t<i;t++)e[t]=new pi;if(t){const t=new pi,i=new pi;for(let s=0,n=this.faces.length;s<n;s++){const n=this.faces[s],o=this.vertices[n.a],r=this.vertices[n.b],a=this.vertices[n.c];t.subVectors(a,r),i.subVectors(o,r),t.cross(i),e[n.a].add(t),e[n.b].add(t),e[n.c].add(t)}}else{this.computeFaceNormals();for(let t=0,i=this.faces.length;t<i;t++){const i=this.faces[t];e[i.a].add(i.normal),e[i.b].add(i.normal),e[i.c].add(i.normal)}}for(let t=0,i=this.vertices.length;t<i;t++)e[t].normalize();for(let t=0,i=this.faces.length;t<i;t++){const i=this.faces[t],s=i.vertexNormals;3===s.length?(s[0].copy(e[i.a]),s[1].copy(e[i.b]),s[2].copy(e[i.c])):(s[0]=e[i.a].clone(),s[1]=e[i.b].clone(),s[2]=e[i.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeFlatVertexNormals:function(){this.computeFaceNormals();for(let t=0,e=this.faces.length;t<e;t++){const e=this.faces[t],i=e.vertexNormals;3===i.length?(i[0].copy(e.normal),i[1].copy(e.normal),i[2].copy(e.normal)):(i[0]=e.normal.clone(),i[1]=e.normal.clone(),i[2]=e.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeMorphNormals:function(){for(let t=0,e=this.faces.length;t<e;t++){const e=this.faces[t];e.__originalFaceNormal?e.__originalFaceNormal.copy(e.normal):e.__originalFaceNormal=e.normal.clone(),e.__originalVertexNormals||(e.__originalVertexNormals=[]);for(let t=0,i=e.vertexNormals.length;t<i;t++)e.__originalVertexNormals[t]?e.__originalVertexNormals[t].copy(e.vertexNormals[t]):e.__originalVertexNormals[t]=e.vertexNormals[t].clone()}const t=new fh;t.faces=this.faces;for(let e=0,i=this.morphTargets.length;e<i;e++){if(!this.morphNormals[e]){this.morphNormals[e]={},this.morphNormals[e].faceNormals=[],this.morphNormals[e].vertexNormals=[];const t=this.morphNormals[e].faceNormals,i=this.morphNormals[e].vertexNormals;for(let e=0,s=this.faces.length;e<s;e++){const e=new pi,s={a:new pi,b:new pi,c:new pi};t.push(e),i.push(s)}}const i=this.morphNormals[e];t.vertices=this.morphTargets[e].vertices,t.computeFaceNormals(),t.computeVertexNormals();for(let t=0,e=this.faces.length;t<e;t++){const e=this.faces[t],s=i.faceNormals[t],n=i.vertexNormals[t];s.copy(e.normal),n.a.copy(e.vertexNormals[0]),n.b.copy(e.vertexNormals[1]),n.c.copy(e.vertexNormals[2])}}for(let t=0,e=this.faces.length;t<e;t++){const e=this.faces[t];e.normal=e.__originalFaceNormal,e.vertexNormals=e.__originalVertexNormals}},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new gi),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new Bi),this.boundingSphere.setFromPoints(this.vertices)},merge:function(t,e,i=0){if(!t||!t.isGeometry)return void console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",t);let s;const n=this.vertices.length,o=this.vertices,r=t.vertices,a=this.faces,h=t.faces,l=this.colors,c=t.colors;void 0!==e&&(s=(new si).getNormalMatrix(e));for(let t=0,i=r.length;t<i;t++){const i=r[t].clone();void 0!==e&&i.applyMatrix4(e),o.push(i)}for(let t=0,e=c.length;t<e;t++)l.push(c[t].clone());for(let t=0,e=h.length;t<e;t++){const e=h[t];let o,r;const l=e.vertexNormals,c=e.vertexColors,d=new Is(e.a+n,e.b+n,e.c+n);d.normal.copy(e.normal),void 0!==s&&d.normal.applyMatrix3(s).normalize();for(let t=0,e=l.length;t<e;t++)o=l[t].clone(),void 0!==s&&o.applyMatrix3(s).normalize(),d.vertexNormals.push(o);d.color.copy(e.color);for(let t=0,e=c.length;t<e;t++)r=c[t],d.vertexColors.push(r.clone());d.materialIndex=e.materialIndex+i,a.push(d)}for(let e=0,i=t.faceVertexUvs.length;e<i;e++){const i=t.faceVertexUvs[e];void 0===this.faceVertexUvs[e]&&(this.faceVertexUvs[e]=[]);for(let t=0,s=i.length;t<s;t++){const s=i[t],n=[];for(let t=0,e=s.length;t<e;t++)n.push(s[t].clone());this.faceVertexUvs[e].push(n)}}},mergeMesh:function(t){t&&t.isMesh?(t.matrixAutoUpdate&&t.updateMatrix(),this.merge(t.geometry,t.matrix)):console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",t)},mergeVertices:function(t=4){const e={},i=[],s=[],n=Math.pow(10,t);for(let t=0,o=this.vertices.length;t<o;t++){const o=this.vertices[t],r=Math.round(o.x*n)+"_"+Math.round(o.y*n)+"_"+Math.round(o.z*n);void 0===e[r]?(e[r]=t,i.push(this.vertices[t]),s[t]=i.length-1):s[t]=s[e[r]]}const o=[];for(let t=0,e=this.faces.length;t<e;t++){const e=this.faces[t];e.a=s[e.a],e.b=s[e.b],e.c=s[e.c];const i=[e.a,e.b,e.c];for(let e=0;e<3;e++)if(i[e]===i[(e+1)%3]){o.push(t);break}}for(let t=o.length-1;t>=0;t--){const e=o[t];this.faces.splice(e,1);for(let t=0,i=this.faceVertexUvs.length;t<i;t++)this.faceVertexUvs[t].splice(e,1)}const r=this.vertices.length-i.length;return this.vertices=i,r},setFromPoints:function(t){this.vertices=[];for(let e=0,i=t.length;e<i;e++){const i=t[e];this.vertices.push(new pi(i.x,i.y,i.z||0))}return this},sortFacesByMaterialIndex:function(){const t=this.faces,e=t.length;for(let i=0;i<e;i++)t[i]._id=i;t.sort((function(t,e){return t.materialIndex-e.materialIndex}));const i=this.faceVertexUvs[0],s=this.faceVertexUvs[1];let n,o;i&&i.length===e&&(n=[]),s&&s.length===e&&(o=[]);for(let r=0;r<e;r++){const e=t[r]._id;n&&n.push(i[e]),o&&o.push(s[e])}n&&(this.faceVertexUvs[0]=n),o&&(this.faceVertexUvs[1]=o)},toJSON:function(){const t={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),void 0!==this.parameters){const e=this.parameters;for(const i in e)void 0!==e[i]&&(t[i]=e[i]);return t}const e=[];for(let t=0;t<this.vertices.length;t++){const i=this.vertices[t];e.push(i.x,i.y,i.z)}const i=[],s=[],n={},o=[],r={},a=[],h={};for(let t=0;t<this.faces.length;t++){const e=this.faces[t],s=!0,n=!1,o=void 0!==this.faceVertexUvs[0][t],r=e.normal.length()>0,a=e.vertexNormals.length>0,h=1!==e.color.r||1!==e.color.g||1!==e.color.b,p=e.vertexColors.length>0;let m=0;if(m=l(m,0,0),m=l(m,1,s),m=l(m,2,n),m=l(m,3,o),m=l(m,4,r),m=l(m,5,a),m=l(m,6,h),m=l(m,7,p),i.push(m),i.push(e.a,e.b,e.c),i.push(e.materialIndex),o){const e=this.faceVertexUvs[0][t];i.push(u(e[0]),u(e[1]),u(e[2]))}if(r&&i.push(c(e.normal)),a){const t=e.vertexNormals;i.push(c(t[0]),c(t[1]),c(t[2]))}if(h&&i.push(d(e.color)),p){const t=e.vertexColors;i.push(d(t[0]),d(t[1]),d(t[2]))}}function l(t,e,i){return i?t|1<<e:t&~(1<<e)}function c(t){const e=t.x.toString()+t.y.toString()+t.z.toString();return void 0!==n[e]||(n[e]=s.length/3,s.push(t.x,t.y,t.z)),n[e]}function d(t){const e=t.r.toString()+t.g.toString()+t.b.toString();return void 0!==r[e]||(r[e]=o.length,o.push(t.getHex())),r[e]}function u(t){const e=t.x.toString()+t.y.toString();return void 0!==h[e]||(h[e]=a.length/2,a.push(t.x,t.y)),h[e]}return t.data={},t.data.vertices=e,t.data.normals=s,o.length>0&&(t.data.colors=o),a.length>0&&(t.data.uvs=[a]),t.data.faces=i,t},clone:function(){return(new fh).copy(this)},copy:function(t){this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=t.name;const e=t.vertices;for(let t=0,i=e.length;t<i;t++)this.vertices.push(e[t].clone());const i=t.colors;for(let t=0,e=i.length;t<e;t++)this.colors.push(i[t].clone());const s=t.faces;for(let t=0,e=s.length;t<e;t++)this.faces.push(s[t].clone());for(let e=0,i=t.faceVertexUvs.length;e<i;e++){const i=t.faceVertexUvs[e];void 0===this.faceVertexUvs[e]&&(this.faceVertexUvs[e]=[]);for(let t=0,s=i.length;t<s;t++){const s=i[t],n=[];for(let t=0,e=s.length;t<e;t++){const e=s[t];n.push(e.clone())}this.faceVertexUvs[e].push(n)}}const n=t.morphTargets;for(let t=0,e=n.length;t<e;t++){const e={};if(e.name=n[t].name,void 0!==n[t].vertices){e.vertices=[];for(let i=0,s=n[t].vertices.length;i<s;i++)e.vertices.push(n[t].vertices[i].clone())}if(void 0!==n[t].normals){e.normals=[];for(let i=0,s=n[t].normals.length;i<s;i++)e.normals.push(n[t].normals[i].clone())}this.morphTargets.push(e)}const o=t.morphNormals;for(let t=0,e=o.length;t<e;t++){const e={};if(void 0!==o[t].vertexNormals){e.vertexNormals=[];for(let i=0,s=o[t].vertexNormals.length;i<s;i++){const s=o[t].vertexNormals[i],n={};n.a=s.a.clone(),n.b=s.b.clone(),n.c=s.c.clone(),e.vertexNormals.push(n)}}if(void 0!==o[t].faceNormals){e.faceNormals=[];for(let i=0,s=o[t].faceNormals.length;i<s;i++)e.faceNormals.push(o[t].faceNormals[i].clone())}this.morphNormals.push(e)}const r=t.skinWeights;for(let t=0,e=r.length;t<e;t++)this.skinWeights.push(r[t].clone());const a=t.skinIndices;for(let t=0,e=a.length;t<e;t++)this.skinIndices.push(a[t].clone());const h=t.lineDistances;for(let t=0,e=h.length;t<e;t++)this.lineDistances.push(h[t]);const l=t.boundingBox;null!==l&&(this.boundingBox=l.clone());const c=t.boundingSphere;return null!==c&&(this.boundingSphere=c.clone()),this.elementsNeedUpdate=t.elementsNeedUpdate,this.verticesNeedUpdate=t.verticesNeedUpdate,this.uvsNeedUpdate=t.uvsNeedUpdate,this.normalsNeedUpdate=t.normalsNeedUpdate,this.colorsNeedUpdate=t.colorsNeedUpdate,this.lineDistancesNeedUpdate=t.lineDistancesNeedUpdate,this.groupsNeedUpdate=t.groupsNeedUpdate,this},dispose:function(){this.dispatchEvent({type:"dispose"})}});class gh extends fh{constructor(t,e,i,s,n,o){super(),this.type="BoxGeometry",this.parameters={width:t,height:e,depth:i,widthSegments:s,heightSegments:n,depthSegments:o},this.fromBufferGeometry(new kn(t,e,i,s,n,o)),this.mergeVertices()}}const yh=new pi,vh=new pi,wh=new pi,xh=new Ls;class bh extends cn{constructor(t,e){super(),this.type="EdgesGeometry",this.parameters={thresholdAngle:e},e=void 0!==e?e:1,t.isGeometry&&(t=(new cn).fromGeometry(t));const i=Math.pow(10,4),s=Math.cos(ei.DEG2RAD*e),n=t.getIndex(),o=t.getAttribute("position"),r=n?n.count:o.count,a=[0,0,0],h=["a","b","c"],l=new Array(3),c={},d=[];for(let t=0;t<r;t+=3){n?(a[0]=n.getX(t),a[1]=n.getX(t+1),a[2]=n.getX(t+2)):(a[0]=t,a[1]=t+1,a[2]=t+2);const{a:e,b:r,c:u}=xh;if(e.fromBufferAttribute(o,a[0]),r.fromBufferAttribute(o,a[1]),u.fromBufferAttribute(o,a[2]),xh.getNormal(wh),l[0]=`${Math.round(e.x*i)},${Math.round(e.y*i)},${Math.round(e.z*i)}`,l[1]=`${Math.round(r.x*i)},${Math.round(r.y*i)},${Math.round(r.z*i)}`,l[2]=`${Math.round(u.x*i)},${Math.round(u.y*i)},${Math.round(u.z*i)}`,l[0]!==l[1]&&l[1]!==l[2]&&l[2]!==l[0])for(let t=0;t<3;t++){const e=(t+1)%3,i=l[t],n=l[e],o=xh[h[t]],r=xh[h[e]],u=`${i}_${n}`,p=`${n}_${i}`;p in c&&c[p]?(wh.dot(c[p].normal)<=s&&(d.push(o.x,o.y,o.z),d.push(r.x,r.y,r.z)),c[p]=null):u in c||(c[u]={index0:a[t],index1:a[e],normal:wh.clone()})}}for(const t in c)if(c[t]){const{index0:e,index1:i}=c[t];yh.fromBufferAttribute(o,e),vh.fromBufferAttribute(o,i),d.push(yh.x,yh.y,yh.z),d.push(vh.x,vh.y,vh.z)}this.setAttribute("position",new Zs(d,3))}}function Sh(t,e,i,s,n){let o,r;if(n===function(t,e,i,s){let n=0;for(let o=e,r=i-s;o<i;o+=s)n+=(t[r]-t[o])*(t[o+1]+t[r+1]),r=o;return n}(t,e,i,s)>0)for(o=e;o<i;o+=s)r=Vh(o,t[o],t[o+1],r);else for(o=i-s;o>=e;o-=s)r=Vh(o,t[o],t[o+1],r);return r&&zh(r,r.next)&&(Gh(r),r=r.next),r}function Mh(t,e){if(!t)return t;e||(e=t);let i,s=t;do{if(i=!1,s.steiner||!zh(s,s.next)&&0!==Fh(s.prev,s,s.next))s=s.next;else{if(Gh(s),s=e=s.prev,s===s.next)break;i=!0}}while(i||s!==e);return e}function Th(t,e,i,s,n,o,r){if(!t)return;!r&&o&&function(t,e,i,s){let n=t;do{null===n.z&&(n.z=Bh(n.x,n.y,e,i,s)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==t);n.prevZ.nextZ=null,n.prevZ=null,function(t){let e,i,s,n,o,r,a,h,l=1;do{for(i=t,t=null,o=null,r=0;i;){for(r++,s=i,a=0,e=0;e<l&&(a++,s=s.nextZ,s);e++);for(h=l;a>0||h>0&&s;)0!==a&&(0===h||!s||i.z<=s.z)?(n=i,i=i.nextZ,a--):(n=s,s=s.nextZ,h--),o?o.nextZ=n:t=n,n.prevZ=o,o=n;i=s}o.nextZ=null,l*=2}while(r>1)}(n)}(t,s,n,o);let a,h,l=t;for(;t.prev!==t.next;)if(a=t.prev,h=t.next,o?Eh(t,s,n,o):_h(t))e.push(a.i/i),e.push(t.i/i),e.push(h.i/i),Gh(t),t=h.next,l=h.next;else if((t=h)===l){r?1===r?Th(t=Lh(Mh(t),e,i),e,i,s,n,o,2):2===r&&Ch(t,e,i,s,n,o):Th(Mh(t),e,i,s,n,o,1);break}}function _h(t){const e=t.prev,i=t,s=t.next;if(Fh(e,i,s)>=0)return!1;let n=t.next.next;for(;n!==t.prev;){if(Dh(e.x,e.y,i.x,i.y,s.x,s.y,n.x,n.y)&&Fh(n.prev,n,n.next)>=0)return!1;n=n.next}return!0}function Eh(t,e,i,s){const n=t.prev,o=t,r=t.next;if(Fh(n,o,r)>=0)return!1;const a=n.x<o.x?n.x<r.x?n.x:r.x:o.x<r.x?o.x:r.x,h=n.y<o.y?n.y<r.y?n.y:r.y:o.y<r.y?o.y:r.y,l=n.x>o.x?n.x>r.x?n.x:r.x:o.x>r.x?o.x:r.x,c=n.y>o.y?n.y>r.y?n.y:r.y:o.y>r.y?o.y:r.y,d=Bh(a,h,e,i,s),u=Bh(l,c,e,i,s);let p=t.prevZ,m=t.nextZ;for(;p&&p.z>=d&&m&&m.z<=u;){if(p!==t.prev&&p!==t.next&&Dh(n.x,n.y,o.x,o.y,r.x,r.y,p.x,p.y)&&Fh(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,m!==t.prev&&m!==t.next&&Dh(n.x,n.y,o.x,o.y,r.x,r.y,m.x,m.y)&&Fh(m.prev,m,m.next)>=0)return!1;m=m.nextZ}for(;p&&p.z>=d;){if(p!==t.prev&&p!==t.next&&Dh(n.x,n.y,o.x,o.y,r.x,r.y,p.x,p.y)&&Fh(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;m&&m.z<=u;){if(m!==t.prev&&m!==t.next&&Dh(n.x,n.y,o.x,o.y,r.x,r.y,m.x,m.y)&&Fh(m.prev,m,m.next)>=0)return!1;m=m.nextZ}return!0}function Lh(t,e,i){let s=t;do{const n=s.prev,o=s.next.next;!zh(n,o)&&Oh(n,s,s.next,o)&&Hh(n,o)&&Hh(o,n)&&(e.push(n.i/i),e.push(s.i/i),e.push(o.i/i),Gh(s),Gh(s.next),s=t=o),s=s.next}while(s!==t);return Mh(s)}function Ch(t,e,i,s,n,o){let r=t;do{let t=r.next.next;for(;t!==r.prev;){if(r.i!==t.i&&Ih(r,t)){let a=Uh(r,t);return r=Mh(r,r.next),a=Mh(a,a.next),Th(r,e,i,s,n,o),void Th(a,e,i,s,n,o)}t=t.next}r=r.next}while(r!==t)}function Ah(t,e){return t.x-e.x}function Ph(t,e){if(e=function(t,e){let i=e;const s=t.x,n=t.y;let o,r=-1/0;do{if(n<=i.y&&n>=i.next.y&&i.next.y!==i.y){const t=i.x+(n-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(t<=s&&t>r){if(r=t,t===s){if(n===i.y)return i;if(n===i.next.y)return i.next}o=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!o)return null;if(s===r)return o;const a=o,h=o.x,l=o.y;let c,d=1/0;i=o;do{s>=i.x&&i.x>=h&&s!==i.x&&Dh(n<l?s:r,n,h,l,n<l?r:s,n,i.x,i.y)&&(c=Math.abs(n-i.y)/(s-i.x),Hh(i,t)&&(c<d||c===d&&(i.x>o.x||i.x===o.x&&kh(o,i)))&&(o=i,d=c)),i=i.next}while(i!==a);return o}(t,e),e){const i=Uh(e,t);Mh(e,e.next),Mh(i,i.next)}}function kh(t,e){return Fh(t.prev,t,e.prev)<0&&Fh(e.next,t,t.next)<0}function Bh(t,e,i,s,n){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*n)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-s)*n)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Rh(t){let e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}function Dh(t,e,i,s,n,o,r,a){return(n-r)*(e-a)-(t-r)*(o-a)>=0&&(t-r)*(s-a)-(i-r)*(e-a)>=0&&(i-r)*(o-a)-(n-r)*(s-a)>=0}function Ih(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&Oh(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&(Hh(t,e)&&Hh(e,t)&&function(t,e){let i=t,s=!1;const n=(t.x+e.x)/2,o=(t.y+e.y)/2;do{i.y>o!=i.next.y>o&&i.next.y!==i.y&&n<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(s=!s),i=i.next}while(i!==t);return s}(t,e)&&(Fh(t.prev,t,e.prev)||Fh(t,e.prev,e))||zh(t,e)&&Fh(t.prev,t,t.next)>0&&Fh(e.prev,e,e.next)>0)}function Fh(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function zh(t,e){return t.x===e.x&&t.y===e.y}function Oh(t,e,i,s){const n=Wh(Fh(t,e,i)),o=Wh(Fh(t,e,s)),r=Wh(Fh(i,s,t)),a=Wh(Fh(i,s,e));return n!==o&&r!==a||!(0!==n||!Nh(t,i,e))||!(0!==o||!Nh(t,s,e))||!(0!==r||!Nh(i,t,s))||!(0!==a||!Nh(i,e,s))}function Nh(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function Wh(t){return t>0?1:t<0?-1:0}function Hh(t,e){return Fh(t.prev,t,t.next)<0?Fh(t,e,t.next)>=0&&Fh(t,t.prev,e)>=0:Fh(t,e,t.prev)<0||Fh(t,t.next,e)<0}function Uh(t,e){const i=new jh(t.i,t.x,t.y),s=new jh(e.i,e.x,e.y),n=t.next,o=e.prev;return t.next=e,e.prev=t,i.next=n,n.prev=i,s.next=i,i.prev=s,o.next=s,s.prev=o,s}function Vh(t,e,i,s){const n=new jh(t,e,i);return s?(n.next=s.next,n.prev=s,s.next.prev=n,s.next=n):(n.prev=n,n.next=n),n}function Gh(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function jh(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}const qh={area:function(t){const e=t.length;let i=0;for(let s=e-1,n=0;n<e;s=n++)i+=t[s].x*t[n].y-t[n].x*t[s].y;return.5*i},isClockWise:function(t){return qh.area(t)<0},triangulateShape:function(t,e){const i=[],s=[],n=[];$h(t),Xh(i,t);let o=t.length;e.forEach($h);for(let t=0;t<e.length;t++)s.push(o),o+=e[t].length,Xh(i,e[t]);const r=function(t,e,i){i=i||2;const s=e&&e.length,n=s?e[0]*i:t.length;let o=Sh(t,0,n,i,!0);const r=[];if(!o||o.next===o.prev)return r;let a,h,l,c,d,u,p;if(s&&(o=function(t,e,i,s){const n=[];let o,r,a,h,l;for(o=0,r=e.length;o<r;o++)a=e[o]*s,h=o<r-1?e[o+1]*s:t.length,l=Sh(t,a,h,s,!1),l===l.next&&(l.steiner=!0),n.push(Rh(l));for(n.sort(Ah),o=0;o<n.length;o++)Ph(n[o],i),i=Mh(i,i.next);return i}(t,e,o,i)),t.length>80*i){a=l=t[0],h=c=t[1];for(let e=i;e<n;e+=i)d=t[e],u=t[e+1],d<a&&(a=d),u<h&&(h=u),d>l&&(l=d),u>c&&(c=u);p=Math.max(l-a,c-h),p=0!==p?1/p:0}return Th(o,r,i,a,h,p),r}(i,s);for(let t=0;t<r.length;t+=3)n.push(r.slice(t,t+3));return n}};function $h(t){const e=t.length;e>2&&t[e-1].equals(t[0])&&t.pop()}function Xh(t,e){for(let i=0;i<e.length;i++)t.push(e[i].x),t.push(e[i].y)}class Yh extends cn{constructor(t,e){super(),this.type="ExtrudeBufferGeometry",this.parameters={shapes:t,options:e},t=Array.isArray(t)?t:[t];const i=this,s=[],n=[];for(let e=0,i=t.length;e<i;e++)o(t[e]);function o(t){const o=[],r=void 0!==e.curveSegments?e.curveSegments:12,a=void 0!==e.steps?e.steps:1;let h=void 0!==e.depth?e.depth:100,l=void 0===e.bevelEnabled||e.bevelEnabled,c=void 0!==e.bevelThickness?e.bevelThickness:6,d=void 0!==e.bevelSize?e.bevelSize:c-2,u=void 0!==e.bevelOffset?e.bevelOffset:0,p=void 0!==e.bevelSegments?e.bevelSegments:3;const m=e.extrudePath,f=void 0!==e.UVGenerator?e.UVGenerator:Zh;void 0!==e.amount&&(console.warn("THREE.ExtrudeBufferGeometry: amount has been renamed to depth."),h=e.amount);let g,y,v,w,x,b=!1;m&&(g=m.getSpacedPoints(a),b=!0,l=!1,y=m.computeFrenetFrames(a,!1),v=new pi,w=new pi,x=new pi),l||(p=0,c=0,d=0,u=0);const S=t.extractPoints(r);let M=S.shape;const T=S.holes;if(!qh.isClockWise(M)){M=M.reverse();for(let t=0,e=T.length;t<e;t++){const e=T[t];qh.isClockWise(e)&&(T[t]=e.reverse())}}const _=qh.triangulateShape(M,T),E=M;for(let t=0,e=T.length;t<e;t++){const e=T[t];M=M.concat(e)}function L(t,e,i){return e||console.error("THREE.ExtrudeGeometry: vec does not exist"),e.clone().multiplyScalar(i).add(t)}const C=M.length,A=_.length;function P(t,e,i){let s,n,o;const r=t.x-e.x,a=t.y-e.y,h=i.x-t.x,l=i.y-t.y,c=r*r+a*a,d=r*l-a*h;if(Math.abs(d)>Number.EPSILON){const d=Math.sqrt(c),u=Math.sqrt(h*h+l*l),p=e.x-a/d,m=e.y+r/d,f=((i.x-l/u-p)*l-(i.y+h/u-m)*h)/(r*l-a*h);s=p+r*f-t.x,n=m+a*f-t.y;const g=s*s+n*n;if(g<=2)return new ii(s,n);o=Math.sqrt(g/2)}else{let t=!1;r>Number.EPSILON?h>Number.EPSILON&&(t=!0):r<-Number.EPSILON?h<-Number.EPSILON&&(t=!0):Math.sign(a)===Math.sign(l)&&(t=!0),t?(s=-a,n=r,o=Math.sqrt(c)):(s=r,n=a,o=Math.sqrt(c/2))}return new ii(s/o,n/o)}const k=[];for(let t=0,e=E.length,i=e-1,s=t+1;t<e;t++,i++,s++)i===e&&(i=0),s===e&&(s=0),k[t]=P(E[t],E[i],E[s]);const B=[];let R,D=k.concat();for(let t=0,e=T.length;t<e;t++){const e=T[t];R=[];for(let t=0,i=e.length,s=i-1,n=t+1;t<i;t++,s++,n++)s===i&&(s=0),n===i&&(n=0),R[t]=P(e[t],e[s],e[n]);B.push(R),D=D.concat(R)}for(let t=0;t<p;t++){const e=t/p,i=c*Math.cos(e*Math.PI/2),s=d*Math.sin(e*Math.PI/2)+u;for(let t=0,e=E.length;t<e;t++){const e=L(E[t],k[t],s);z(e.x,e.y,-i)}for(let t=0,e=T.length;t<e;t++){const e=T[t];R=B[t];for(let t=0,n=e.length;t<n;t++){const n=L(e[t],R[t],s);z(n.x,n.y,-i)}}}const I=d+u;for(let t=0;t<C;t++){const e=l?L(M[t],D[t],I):M[t];b?(w.copy(y.normals[0]).multiplyScalar(e.x),v.copy(y.binormals[0]).multiplyScalar(e.y),x.copy(g[0]).add(w).add(v),z(x.x,x.y,x.z)):z(e.x,e.y,0)}for(let t=1;t<=a;t++)for(let e=0;e<C;e++){const i=l?L(M[e],D[e],I):M[e];b?(w.copy(y.normals[t]).multiplyScalar(i.x),v.copy(y.binormals[t]).multiplyScalar(i.y),x.copy(g[t]).add(w).add(v),z(x.x,x.y,x.z)):z(i.x,i.y,h/a*t)}for(let t=p-1;t>=0;t--){const e=t/p,i=c*Math.cos(e*Math.PI/2),s=d*Math.sin(e*Math.PI/2)+u;for(let t=0,e=E.length;t<e;t++){const e=L(E[t],k[t],s);z(e.x,e.y,h+i)}for(let t=0,e=T.length;t<e;t++){const e=T[t];R=B[t];for(let t=0,n=e.length;t<n;t++){const n=L(e[t],R[t],s);b?z(n.x,n.y+g[a-1].y,g[a-1].x+i):z(n.x,n.y,h+i)}}}function F(t,e){let i=t.length;for(;--i>=0;){const s=i;let n=i-1;n<0&&(n=t.length-1);for(let t=0,i=a+2*p;t<i;t++){const i=C*t,o=C*(t+1);N(e+s+i,e+n+i,e+n+o,e+s+o)}}}function z(t,e,i){o.push(t),o.push(e),o.push(i)}function O(t,e,n){W(t),W(e),W(n);const o=s.length/3,r=f.generateTopUV(i,s,o-3,o-2,o-1);H(r[0]),H(r[1]),H(r[2])}function N(t,e,n,o){W(t),W(e),W(o),W(e),W(n),W(o);const r=s.length/3,a=f.generateSideWallUV(i,s,r-6,r-3,r-2,r-1);H(a[0]),H(a[1]),H(a[3]),H(a[1]),H(a[2]),H(a[3])}function W(t){s.push(o[3*t+0]),s.push(o[3*t+1]),s.push(o[3*t+2])}function H(t){n.push(t.x),n.push(t.y)}!function(){const t=s.length/3;if(l){let t=0,e=C*t;for(let t=0;t<A;t++){const i=_[t];O(i[2]+e,i[1]+e,i[0]+e)}t=a+2*p,e=C*t;for(let t=0;t<A;t++){const i=_[t];O(i[0]+e,i[1]+e,i[2]+e)}}else{for(let t=0;t<A;t++){const e=_[t];O(e[2],e[1],e[0])}for(let t=0;t<A;t++){const e=_[t];O(e[0]+C*a,e[1]+C*a,e[2]+C*a)}}i.addGroup(t,s.length/3-t,0)}(),function(){const t=s.length/3;let e=0;F(E,e),e+=E.length;for(let t=0,i=T.length;t<i;t++){const i=T[t];F(i,e),e+=i.length}i.addGroup(t,s.length/3-t,1)}()}this.setAttribute("position",new Zs(s,3)),this.setAttribute("uv",new Zs(n,2)),this.computeVertexNormals()}toJSON(){const t=cn.prototype.toJSON.call(this);return function(t,e,i){if(i.shapes=[],Array.isArray(t))for(let e=0,s=t.length;e<s;e++){const s=t[e];i.shapes.push(s.uuid)}else i.shapes.push(t.uuid);return void 0!==e.extrudePath&&(i.options.extrudePath=e.extrudePath.toJSON()),i}(this.parameters.shapes,this.parameters.options,t)}}const Zh={generateTopUV:function(t,e,i,s,n){const o=e[3*i],r=e[3*i+1],a=e[3*s],h=e[3*s+1],l=e[3*n],c=e[3*n+1];return[new ii(o,r),new ii(a,h),new ii(l,c)]},generateSideWallUV:function(t,e,i,s,n,o){const r=e[3*i],a=e[3*i+1],h=e[3*i+2],l=e[3*s],c=e[3*s+1],d=e[3*s+2],u=e[3*n],p=e[3*n+1],m=e[3*n+2],f=e[3*o],g=e[3*o+1],y=e[3*o+2];return Math.abs(a-c)<.01?[new ii(r,1-h),new ii(l,1-d),new ii(u,1-m),new ii(f,1-y)]:[new ii(a,1-h),new ii(c,1-d),new ii(p,1-m),new ii(g,1-y)]}};class Kh extends fh{constructor(t,e){super(),this.type="ExtrudeGeometry",this.parameters={shapes:t,options:e},this.fromBufferGeometry(new Yh(t,e)),this.mergeVertices()}toJSON(){const t=super.toJSON();return function(t,e,i){if(i.shapes=[],Array.isArray(t))for(let e=0,s=t.length;e<s;e++){const s=t[e];i.shapes.push(s.uuid)}else i.shapes.push(t.uuid);return void 0!==e.extrudePath&&(i.options.extrudePath=e.extrudePath.toJSON()),i}(this.parameters.shapes,this.parameters.options,t)}}function Jh(t,e,i){cn.call(this),this.type="ParametricBufferGeometry",this.parameters={func:t,slices:e,stacks:i};const s=[],n=[],o=[],r=[],a=1e-5,h=new pi,l=new pi,c=new pi,d=new pi,u=new pi;t.length<3&&console.error("THREE.ParametricGeometry: Function must now modify a Vector3 as third parameter.");const p=e+1;for(let s=0;s<=i;s++){const p=s/i;for(let i=0;i<=e;i++){const s=i/e;t(s,p,l),n.push(l.x,l.y,l.z),s-a>=0?(t(s-a,p,c),d.subVectors(l,c)):(t(s+a,p,c),d.subVectors(c,l)),p-a>=0?(t(s,p-a,c),u.subVectors(l,c)):(t(s,p+a,c),u.subVectors(c,l)),h.crossVectors(d,u).normalize(),o.push(h.x,h.y,h.z),r.push(s,p)}}for(let t=0;t<i;t++)for(let i=0;i<e;i++){const e=t*p+i,n=t*p+i+1,o=(t+1)*p+i+1,r=(t+1)*p+i;s.push(e,n,r),s.push(n,o,r)}this.setIndex(s),this.setAttribute("position",new Zs(n,3)),this.setAttribute("normal",new Zs(o,3)),this.setAttribute("uv",new Zs(r,2))}function Qh(t,e,i){fh.call(this),this.type="ParametricGeometry",this.parameters={func:t,slices:e,stacks:i},this.fromBufferGeometry(new Jh(t,e,i)),this.mergeVertices()}Jh.prototype=Object.create(cn.prototype),Jh.prototype.constructor=Jh,Qh.prototype=Object.create(fh.prototype),Qh.prototype.constructor=Qh;class tl extends fh{constructor(t,e,i,s){super(),this.type="PlaneGeometry",this.parameters={width:t,height:e,widthSegments:i,heightSegments:s},this.fromBufferGeometry(new Zn(t,e,i,s)),this.mergeVertices()}}class el extends cn{constructor(t,e=12){super(),this.type="ShapeBufferGeometry",this.parameters={shapes:t,curveSegments:e};const i=[],s=[],n=[],o=[];let r=0,a=0;if(!1===Array.isArray(t))h(t);else for(let e=0;e<t.length;e++)h(t[e]),this.addGroup(r,a,e),r+=a,a=0;function h(t){const r=s.length/3,h=t.extractPoints(e);let l=h.shape;const c=h.holes;!1===qh.isClockWise(l)&&(l=l.reverse());for(let t=0,e=c.length;t<e;t++){const e=c[t];!0===qh.isClockWise(e)&&(c[t]=e.reverse())}const d=qh.triangulateShape(l,c);for(let t=0,e=c.length;t<e;t++){const e=c[t];l=l.concat(e)}for(let t=0,e=l.length;t<e;t++){const e=l[t];s.push(e.x,e.y,0),n.push(0,0,1),o.push(e.x,e.y)}for(let t=0,e=d.length;t<e;t++){const e=d[t],s=e[0]+r,n=e[1]+r,o=e[2]+r;i.push(s,n,o),a+=3}}this.setIndex(i),this.setAttribute("position",new Zs(s,3)),this.setAttribute("normal",new Zs(n,3)),this.setAttribute("uv",new Zs(o,2))}toJSON(){const t=cn.prototype.toJSON.call(this);return function(t,e){if(e.shapes=[],Array.isArray(t))for(let i=0,s=t.length;i<s;i++){const s=t[i];e.shapes.push(s.uuid)}else e.shapes.push(t.uuid);return e}(this.parameters.shapes,t)}}class il extends fh{constructor(t,e){super(),this.type="ShapeGeometry","object"==typeof e&&(console.warn("THREE.ShapeGeometry: Options parameter has been removed."),e=e.curveSegments),this.parameters={shapes:t,curveSegments:e},this.fromBufferGeometry(new el(t,e)),this.mergeVertices()}toJSON(){const t=fh.prototype.toJSON.call(this);return function(t,e){if(e.shapes=[],Array.isArray(t))for(let i=0,s=t.length;i<s;i++){const s=t[i];e.shapes.push(s.uuid)}else e.shapes.push(t.uuid);return e}(this.parameters.shapes,t)}}class sl extends cn{constructor(t=1,e=8,i=6,s=0,n=2*Math.PI,o=0,r=Math.PI){super(),this.type="SphereBufferGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:i,phiStart:s,phiLength:n,thetaStart:o,thetaLength:r},e=Math.max(3,Math.floor(e)),i=Math.max(2,Math.floor(i));const a=Math.min(o+r,Math.PI);let h=0;const l=[],c=new pi,d=new pi,u=[],p=[],m=[],f=[];for(let u=0;u<=i;u++){const g=[],y=u/i;let v=0;0==u&&0==o?v=.5/e:u==i&&a==Math.PI&&(v=-.5/e);for(let i=0;i<=e;i++){const a=i/e;c.x=-t*Math.cos(s+a*n)*Math.sin(o+y*r),c.y=t*Math.cos(o+y*r),c.z=t*Math.sin(s+a*n)*Math.sin(o+y*r),p.push(c.x,c.y,c.z),d.copy(c).normalize(),m.push(d.x,d.y,d.z),f.push(a+v,1-y),g.push(h++)}l.push(g)}for(let t=0;t<i;t++)for(let s=0;s<e;s++){const e=l[t][s+1],n=l[t][s],r=l[t+1][s],h=l[t+1][s+1];(0!==t||o>0)&&u.push(e,n,h),(t!==i-1||a<Math.PI)&&u.push(n,r,h)}this.setIndex(u),this.setAttribute("position",new Zs(p,3)),this.setAttribute("normal",new Zs(m,3)),this.setAttribute("uv",new Zs(f,2))}}class nl extends fh{constructor(t,e,i,s,n,o,r){super(),this.type="SphereGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:i,phiStart:s,phiLength:n,thetaStart:o,thetaLength:r},this.fromBufferGeometry(new sl(t,e,i,s,n,o,r)),this.mergeVertices()}}class ol extends cn{constructor(t,e=64,i=1,s=8,n=!1){super(),this.type="TubeBufferGeometry",this.parameters={path:t,tubularSegments:e,radius:i,radialSegments:s,closed:n};const o=t.computeFrenetFrames(e,n);this.tangents=o.tangents,this.normals=o.normals,this.binormals=o.binormals;const r=new pi,a=new pi,h=new ii;let l=new pi;const c=[],d=[],u=[],p=[];function m(n){l=t.getPointAt(n/e,l);const h=o.normals[n],u=o.binormals[n];for(let t=0;t<=s;t++){const e=t/s*Math.PI*2,n=Math.sin(e),o=-Math.cos(e);a.x=o*h.x+n*u.x,a.y=o*h.y+n*u.y,a.z=o*h.z+n*u.z,a.normalize(),d.push(a.x,a.y,a.z),r.x=l.x+i*a.x,r.y=l.y+i*a.y,r.z=l.z+i*a.z,c.push(r.x,r.y,r.z)}}!function(){for(let t=0;t<e;t++)m(t);m(!1===n?e:0),function(){for(let t=0;t<=e;t++)for(let i=0;i<=s;i++)h.x=t/e,h.y=i/s,u.push(h.x,h.y)}(),function(){for(let t=1;t<=e;t++)for(let e=1;e<=s;e++){const i=(s+1)*(t-1)+(e-1),n=(s+1)*t+(e-1),o=(s+1)*t+e,r=(s+1)*(t-1)+e;p.push(i,n,r),p.push(n,o,r)}}()}(),this.setIndex(p),this.setAttribute("position",new Zs(c,3)),this.setAttribute("normal",new Zs(d,3)),this.setAttribute("uv",new Zs(u,2))}toJSON(){const t=cn.prototype.toJSON.call(this);return t.path=this.parameters.path.toJSON(),t}}class rl extends fh{constructor(t,e,i,s,n,o){super(),this.type="TubeGeometry",this.parameters={path:t,tubularSegments:e,radius:i,radialSegments:s,closed:n},void 0!==o&&console.warn("THREE.TubeGeometry: taper has been removed.");const r=new ol(t,e,i,s,n);this.tangents=r.tangents,this.normals=r.normals,this.binormals=r.binormals,this.fromBufferGeometry(r),this.mergeVertices()}}class al extends cn{constructor(t){super(),this.type="WireframeGeometry";const e=[],i=[0,0],s={},n=["a","b","c"];if(t&&t.isGeometry){const o=t.faces;for(let t=0,e=o.length;t<e;t++){const e=o[t];for(let t=0;t<3;t++){const o=e[n[t]],r=e[n[(t+1)%3]];i[0]=Math.min(o,r),i[1]=Math.max(o,r);const a=i[0]+","+i[1];void 0===s[a]&&(s[a]={index1:i[0],index2:i[1]})}}for(const i in s){const n=s[i];let o=t.vertices[n.index1];e.push(o.x,o.y,o.z),o=t.vertices[n.index2],e.push(o.x,o.y,o.z)}}else if(t&&t.isBufferGeometry){const n=new pi;if(null!==t.index){const o=t.attributes.position,r=t.index;let a=t.groups;0===a.length&&(a=[{start:0,count:r.count,materialIndex:0}]);for(let t=0,e=a.length;t<e;++t){const e=a[t],n=e.start;for(let t=n,o=n+e.count;t<o;t+=3)for(let e=0;e<3;e++){const n=r.getX(t+e),o=r.getX(t+(e+1)%3);i[0]=Math.min(n,o),i[1]=Math.max(n,o);const a=i[0]+","+i[1];void 0===s[a]&&(s[a]={index1:i[0],index2:i[1]})}}for(const t in s){const i=s[t];n.fromBufferAttribute(o,i.index1),e.push(n.x,n.y,n.z),n.fromBufferAttribute(o,i.index2),e.push(n.x,n.y,n.z)}}else{const i=t.attributes.position;for(let t=0,s=i.count/3;t<s;t++)for(let s=0;s<3;s++){const o=3*t+s;n.fromBufferAttribute(i,o),e.push(n.x,n.y,n.z);const r=3*t+(s+1)%3;n.fromBufferAttribute(i,r),e.push(n.x,n.y,n.z)}}}this.setAttribute("position",new Zs(e,3))}}function hl(t){zs.call(this),this.type="ShadowMaterial",this.color=new Ds(0),this.transparent=!0,this.setValues(t)}function ll(t){zn.call(this,t),this.type="RawShaderMaterial"}function cl(t){zs.call(this),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new Ds(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Ds(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=je,this.normalScale=new ii(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.vertexTangents=!1,this.setValues(t)}function dl(t){cl.call(this),this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.clearcoat=0,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new ii(1,1),this.clearcoatNormalMap=null,this.reflectivity=.5,Object.defineProperty(this,"ior",{get:function(){return(1+.4*this.reflectivity)/(1-.4*this.reflectivity)},set:function(t){this.reflectivity=ei.clamp(2.5*(t-1)/(t+1),0,1)}}),this.sheen=null,this.transmission=0,this.transmissionMap=null,this.setValues(t)}function ul(t){zs.call(this),this.type="MeshPhongMaterial",this.color=new Ds(16777215),this.specular=new Ds(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Ds(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=je,this.normalScale=new ii(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=V,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}function pl(t){zs.call(this),this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new Ds(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Ds(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=je,this.normalScale=new ii(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}function ml(t){zs.call(this),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=je,this.normalScale=new ii(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}function fl(t){zs.call(this),this.type="MeshLambertMaterial",this.color=new Ds(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Ds(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=V,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}function gl(t){zs.call(this),this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new Ds(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=je,this.normalScale=new ii(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}function yl(t){Va.call(this),this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(t)}hl.prototype=Object.create(zs.prototype),hl.prototype.constructor=hl,hl.prototype.isShadowMaterial=!0,hl.prototype.copy=function(t){return zs.prototype.copy.call(this,t),this.color.copy(t.color),this},ll.prototype=Object.create(zn.prototype),ll.prototype.constructor=ll,ll.prototype.isRawShaderMaterial=!0,cl.prototype=Object.create(zs.prototype),cl.prototype.constructor=cl,cl.prototype.isMeshStandardMaterial=!0,cl.prototype.copy=function(t){return zs.prototype.copy.call(this,t),this.defines={STANDARD:""},this.color.copy(t.color),this.roughness=t.roughness,this.metalness=t.metalness,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.roughnessMap=t.roughnessMap,this.metalnessMap=t.metalnessMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapIntensity=t.envMapIntensity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this.vertexTangents=t.vertexTangents,this},dl.prototype=Object.create(cl.prototype),dl.prototype.constructor=dl,dl.prototype.isMeshPhysicalMaterial=!0,dl.prototype.copy=function(t){return cl.prototype.copy.call(this,t),this.defines={STANDARD:"",PHYSICAL:""},this.clearcoat=t.clearcoat,this.clearcoatMap=t.clearcoatMap,this.clearcoatRoughness=t.clearcoatRoughness,this.clearcoatRoughnessMap=t.clearcoatRoughnessMap,this.clearcoatNormalMap=t.clearcoatNormalMap,this.clearcoatNormalScale.copy(t.clearcoatNormalScale),this.reflectivity=t.reflectivity,t.sheen?this.sheen=(this.sheen||new Ds).copy(t.sheen):this.sheen=null,this.transmission=t.transmission,this.transmissionMap=t.transmissionMap,this},ul.prototype=Object.create(zs.prototype),ul.prototype.constructor=ul,ul.prototype.isMeshPhongMaterial=!0,ul.prototype.copy=function(t){return zs.prototype.copy.call(this,t),this.color.copy(t.color),this.specular.copy(t.specular),this.shininess=t.shininess,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},pl.prototype=Object.create(zs.prototype),pl.prototype.constructor=pl,pl.prototype.isMeshToonMaterial=!0,pl.prototype.copy=function(t){return zs.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.gradientMap=t.gradientMap,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.alphaMap=t.alphaMap,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},ml.prototype=Object.create(zs.prototype),ml.prototype.constructor=ml,ml.prototype.isMeshNormalMaterial=!0,ml.prototype.copy=function(t){return zs.prototype.copy.call(this,t),this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},fl.prototype=Object.create(zs.prototype),fl.prototype.constructor=fl,fl.prototype.isMeshLambertMaterial=!0,fl.prototype.copy=function(t){return zs.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},gl.prototype=Object.create(zs.prototype),gl.prototype.constructor=gl,gl.prototype.isMeshMatcapMaterial=!0,gl.prototype.copy=function(t){return zs.prototype.copy.call(this,t),this.defines={MATCAP:""},this.color.copy(t.color),this.matcap=t.matcap,this.map=t.map,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.alphaMap=t.alphaMap,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},yl.prototype=Object.create(Va.prototype),yl.prototype.constructor=yl,yl.prototype.isLineDashedMaterial=!0,yl.prototype.copy=function(t){return Va.prototype.copy.call(this,t),this.scale=t.scale,this.dashSize=t.dashSize,this.gapSize=t.gapSize,this};var vl=Object.freeze({__proto__:null,ShadowMaterial:hl,SpriteMaterial:la,RawShaderMaterial:ll,ShaderMaterial:zn,PointsMaterial:th,MeshPhysicalMaterial:dl,MeshStandardMaterial:cl,MeshPhongMaterial:ul,MeshToonMaterial:pl,MeshNormalMaterial:ml,MeshLambertMaterial:fl,MeshDepthMaterial:Gr,MeshDistanceMaterial:jr,MeshBasicMaterial:Os,MeshMatcapMaterial:gl,LineDashedMaterial:yl,LineBasicMaterial:Va,Material:zs});const wl={arraySlice:function(t,e,i){return wl.isTypedArray(t)?new t.constructor(t.subarray(e,void 0!==i?i:t.length)):t.slice(e,i)},convertArray:function(t,e,i){return!t||!i&&t.constructor===e?t:"number"==typeof e.BYTES_PER_ELEMENT?new e(t):Array.prototype.slice.call(t)},isTypedArray:function(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)},getKeyframeOrder:function(t){const e=t.length,i=new Array(e);for(let t=0;t!==e;++t)i[t]=t;return i.sort((function(e,i){return t[e]-t[i]})),i},sortedArray:function(t,e,i){const s=t.length,n=new t.constructor(s);for(let o=0,r=0;r!==s;++o){const s=i[o]*e;for(let i=0;i!==e;++i)n[r++]=t[s+i]}return n},flattenJSON:function(t,e,i,s){let n=1,o=t[0];for(;void 0!==o&&void 0===o[s];)o=t[n++];if(void 0===o)return;let r=o[s];if(void 0!==r)if(Array.isArray(r))do{r=o[s],void 0!==r&&(e.push(o.time),i.push.apply(i,r)),o=t[n++]}while(void 0!==o);else if(void 0!==r.toArray)do{r=o[s],void 0!==r&&(e.push(o.time),r.toArray(i,i.length)),o=t[n++]}while(void 0!==o);else do{r=o[s],void 0!==r&&(e.push(o.time),i.push(r)),o=t[n++]}while(void 0!==o)},subclip:function(t,e,i,s,n=30){const o=t.clone();o.name=e;const r=[];for(let t=0;t<o.tracks.length;++t){const e=o.tracks[t],a=e.getValueSize(),h=[],l=[];for(let t=0;t<e.times.length;++t){const o=e.times[t]*n;if(!(o<i||o>=s)){h.push(e.times[t]);for(let i=0;i<a;++i)l.push(e.values[t*a+i])}}0!==h.length&&(e.times=wl.convertArray(h,e.times.constructor),e.values=wl.convertArray(l,e.values.constructor),r.push(e))}o.tracks=r;let a=1/0;for(let t=0;t<o.tracks.length;++t)a>o.tracks[t].times[0]&&(a=o.tracks[t].times[0]);for(let t=0;t<o.tracks.length;++t)o.tracks[t].shift(-1*a);return o.resetDuration(),o},makeClipAdditive:function(t,e=0,i=t,s=30){s<=0&&(s=30);const n=i.tracks.length,o=e/s;for(let e=0;e<n;++e){const s=i.tracks[e],n=s.ValueTypeName;if("bool"===n||"string"===n)continue;const r=t.tracks.find((function(t){return t.name===s.name&&t.ValueTypeName===n}));if(void 0===r)continue;let a=0;const h=s.getValueSize();s.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(a=h/3);let l=0;const c=r.getValueSize();r.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(l=c/3);const d=s.times.length-1;let u;if(o<=s.times[0]){const t=a,e=h-a;u=wl.arraySlice(s.values,t,e)}else if(o>=s.times[d]){const t=d*h+a,e=t+h-a;u=wl.arraySlice(s.values,t,e)}else{const t=s.createInterpolant(),e=a,i=h-a;t.evaluate(o),u=wl.arraySlice(t.resultBuffer,e,i)}"quaternion"===n&&(new ui).fromArray(u).normalize().conjugate().toArray(u);const p=r.times.length;for(let t=0;t<p;++t){const e=t*c+l;if("quaternion"===n)ui.multiplyQuaternionsFlat(r.values,e,u,0,r.values,e);else{const t=c-2*l;for(let i=0;i<t;++i)r.values[e+i]-=u[i]}}}return t.blendMode=2501,t}};function xl(t,e,i,s){this.parameterPositions=t,this._cachedIndex=0,this.resultBuffer=void 0!==s?s:new e.constructor(i),this.sampleValues=e,this.valueSize=i}function bl(t,e,i,s){xl.call(this,t,e,i,s),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0}function Sl(t,e,i,s){xl.call(this,t,e,i,s)}function Ml(t,e,i,s){xl.call(this,t,e,i,s)}function Tl(t,e,i,s){if(void 0===t)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===e||0===e.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+t);this.name=t,this.times=wl.convertArray(e,this.TimeBufferType),this.values=wl.convertArray(i,this.ValueBufferType),this.setInterpolation(s||this.DefaultInterpolation)}function _l(t,e,i){Tl.call(this,t,e,i)}function El(t,e,i,s){Tl.call(this,t,e,i,s)}function Ll(t,e,i,s){Tl.call(this,t,e,i,s)}function Cl(t,e,i,s){xl.call(this,t,e,i,s)}function Al(t,e,i,s){Tl.call(this,t,e,i,s)}function Pl(t,e,i,s){Tl.call(this,t,e,i,s)}function kl(t,e,i,s){Tl.call(this,t,e,i,s)}function Bl(t,e=-1,i,s=Be){this.name=t,this.tracks=i,this.duration=e,this.blendMode=s,this.uuid=ei.generateUUID(),this.duration<0&&this.resetDuration()}function Rl(t){if(void 0===t.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const e=function(t){switch(t.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return Ll;case"vector":case"vector2":case"vector3":case"vector4":return kl;case"color":return El;case"quaternion":return Al;case"bool":case"boolean":return _l;case"string":return Pl}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+t)}(t.type);if(void 0===t.times){const e=[],i=[];wl.flattenJSON(t.keys,e,i,"value"),t.times=e,t.values=i}return void 0!==e.parse?e.parse(t):new e(t.name,t.times,t.values,t.interpolation)}Object.assign(xl.prototype,{evaluate:function(t){const e=this.parameterPositions;let i=this._cachedIndex,s=e[i],n=e[i-1];t:{e:{let o;i:{s:if(!(t<s)){for(let o=i+2;;){if(void 0===s){if(t<n)break s;return i=e.length,this._cachedIndex=i,this.afterEnd_(i-1,t,n)}if(i===o)break;if(n=s,s=e[++i],t<s)break e}o=e.length;break i}if(t>=n)break t;{const r=e[1];t<r&&(i=2,n=r);for(let o=i-2;;){if(void 0===n)return this._cachedIndex=0,this.beforeStart_(0,t,s);if(i===o)break;if(s=n,n=e[--i-1],t>=n)break e}o=i,i=0}}for(;i<o;){const s=i+o>>>1;t<e[s]?o=s:i=s+1}if(s=e[i],n=e[i-1],void 0===n)return this._cachedIndex=0,this.beforeStart_(0,t,s);if(void 0===s)return i=e.length,this._cachedIndex=i,this.afterEnd_(i-1,n,t)}this._cachedIndex=i,this.intervalChanged_(i,n,s)}return this.interpolate_(i,n,t,s)},settings:null,DefaultSettings_:{},getSettings_:function(){return this.settings||this.DefaultSettings_},copySampleValue_:function(t){const e=this.resultBuffer,i=this.sampleValues,s=this.valueSize,n=t*s;for(let t=0;t!==s;++t)e[t]=i[n+t];return e},interpolate_:function(){throw new Error("call to abstract method")},intervalChanged_:function(){}}),Object.assign(xl.prototype,{beforeStart_:xl.prototype.copySampleValue_,afterEnd_:xl.prototype.copySampleValue_}),bl.prototype=Object.assign(Object.create(xl.prototype),{constructor:bl,DefaultSettings_:{endingStart:Ae,endingEnd:Ae},intervalChanged_:function(t,e,i){const s=this.parameterPositions;let n=t-2,o=t+1,r=s[n],a=s[o];if(void 0===r)switch(this.getSettings_().endingStart){case Pe:n=t,r=2*e-i;break;case ke:n=s.length-2,r=e+s[n]-s[n+1];break;default:n=t,r=i}if(void 0===a)switch(this.getSettings_().endingEnd){case Pe:o=t,a=2*i-e;break;case ke:o=1,a=i+s[1]-s[0];break;default:o=t-1,a=e}const h=.5*(i-e),l=this.valueSize;this._weightPrev=h/(e-r),this._weightNext=h/(a-i),this._offsetPrev=n*l,this._offsetNext=o*l},interpolate_:function(t,e,i,s){const n=this.resultBuffer,o=this.sampleValues,r=this.valueSize,a=t*r,h=a-r,l=this._offsetPrev,c=this._offsetNext,d=this._weightPrev,u=this._weightNext,p=(i-e)/(s-e),m=p*p,f=m*p,g=-d*f+2*d*m-d*p,y=(1+d)*f+(-1.5-2*d)*m+(-.5+d)*p+1,v=(-1-u)*f+(1.5+u)*m+.5*p,w=u*f-u*m;for(let t=0;t!==r;++t)n[t]=g*o[l+t]+y*o[h+t]+v*o[a+t]+w*o[c+t];return n}}),Sl.prototype=Object.assign(Object.create(xl.prototype),{constructor:Sl,interpolate_:function(t,e,i,s){const n=this.resultBuffer,o=this.sampleValues,r=this.valueSize,a=t*r,h=a-r,l=(i-e)/(s-e),c=1-l;for(let t=0;t!==r;++t)n[t]=o[h+t]*c+o[a+t]*l;return n}}),Ml.prototype=Object.assign(Object.create(xl.prototype),{constructor:Ml,interpolate_:function(t){return this.copySampleValue_(t-1)}}),Object.assign(Tl,{toJSON:function(t){const e=t.constructor;let i;if(void 0!==e.toJSON)i=e.toJSON(t);else{i={name:t.name,times:wl.convertArray(t.times,Array),values:wl.convertArray(t.values,Array)};const e=t.getInterpolation();e!==t.DefaultInterpolation&&(i.interpolation=e)}return i.type=t.ValueTypeName,i}}),Object.assign(Tl.prototype,{constructor:Tl,TimeBufferType:Float32Array,ValueBufferType:Float32Array,DefaultInterpolation:Le,InterpolantFactoryMethodDiscrete:function(t){return new Ml(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodLinear:function(t){return new Sl(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodSmooth:function(t){return new bl(this.times,this.values,this.getValueSize(),t)},setInterpolation:function(t){let e;switch(t){case Ee:e=this.InterpolantFactoryMethodDiscrete;break;case Le:e=this.InterpolantFactoryMethodLinear;break;case Ce:e=this.InterpolantFactoryMethodSmooth}if(void 0===e){const e="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(t===this.DefaultInterpolation)throw new Error(e);this.setInterpolation(this.DefaultInterpolation)}return console.warn("THREE.KeyframeTrack:",e),this}return this.createInterpolant=e,this},getInterpolation:function(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return Ee;case this.InterpolantFactoryMethodLinear:return Le;case this.InterpolantFactoryMethodSmooth:return Ce}},getValueSize:function(){return this.values.length/this.times.length},shift:function(t){if(0!==t){const e=this.times;for(let i=0,s=e.length;i!==s;++i)e[i]+=t}return this},scale:function(t){if(1!==t){const e=this.times;for(let i=0,s=e.length;i!==s;++i)e[i]*=t}return this},trim:function(t,e){const i=this.times,s=i.length;let n=0,o=s-1;for(;n!==s&&i[n]<t;)++n;for(;-1!==o&&i[o]>e;)--o;if(++o,0!==n||o!==s){n>=o&&(o=Math.max(o,1),n=o-1);const t=this.getValueSize();this.times=wl.arraySlice(i,n,o),this.values=wl.arraySlice(this.values,n*t,o*t)}return this},validate:function(){let t=!0;const e=this.getValueSize();e-Math.floor(e)!=0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),t=!1);const i=this.times,s=this.values,n=i.length;0===n&&(console.error("THREE.KeyframeTrack: Track is empty.",this),t=!1);let o=null;for(let e=0;e!==n;e++){const s=i[e];if("number"==typeof s&&isNaN(s)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,e,s),t=!1;break}if(null!==o&&o>s){console.error("THREE.KeyframeTrack: Out of order keys.",this,e,s,o),t=!1;break}o=s}if(void 0!==s&&wl.isTypedArray(s))for(let e=0,i=s.length;e!==i;++e){const i=s[e];if(isNaN(i)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,e,i),t=!1;break}}return t},optimize:function(){const t=wl.arraySlice(this.times),e=wl.arraySlice(this.values),i=this.getValueSize(),s=this.getInterpolation()===Ce,n=t.length-1;let o=1;for(let r=1;r<n;++r){let n=!1;const a=t[r];if(a!==t[r+1]&&(1!==r||a!==a[0]))if(s)n=!0;else{const t=r*i,s=t-i,o=t+i;for(let r=0;r!==i;++r){const i=e[t+r];if(i!==e[s+r]||i!==e[o+r]){n=!0;break}}}if(n){if(r!==o){t[o]=t[r];const s=r*i,n=o*i;for(let t=0;t!==i;++t)e[n+t]=e[s+t]}++o}}if(n>0){t[o]=t[n];for(let t=n*i,s=o*i,r=0;r!==i;++r)e[s+r]=e[t+r];++o}return o!==t.length?(this.times=wl.arraySlice(t,0,o),this.values=wl.arraySlice(e,0,o*i)):(this.times=t,this.values=e),this},clone:function(){const t=wl.arraySlice(this.times,0),e=wl.arraySlice(this.values,0),i=new(0,this.constructor)(this.name,t,e);return i.createInterpolant=this.createInterpolant,i}}),_l.prototype=Object.assign(Object.create(Tl.prototype),{constructor:_l,ValueTypeName:"bool",ValueBufferType:Array,DefaultInterpolation:Ee,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),El.prototype=Object.assign(Object.create(Tl.prototype),{constructor:El,ValueTypeName:"color"}),Ll.prototype=Object.assign(Object.create(Tl.prototype),{constructor:Ll,ValueTypeName:"number"}),Cl.prototype=Object.assign(Object.create(xl.prototype),{constructor:Cl,interpolate_:function(t,e,i,s){const n=this.resultBuffer,o=this.sampleValues,r=this.valueSize,a=(i-e)/(s-e);let h=t*r;for(let t=h+r;h!==t;h+=4)ui.slerpFlat(n,0,o,h-r,o,h,a);return n}}),Al.prototype=Object.assign(Object.create(Tl.prototype),{constructor:Al,ValueTypeName:"quaternion",DefaultInterpolation:Le,InterpolantFactoryMethodLinear:function(t){return new Cl(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodSmooth:void 0}),Pl.prototype=Object.assign(Object.create(Tl.prototype),{constructor:Pl,ValueTypeName:"string",ValueBufferType:Array,DefaultInterpolation:Ee,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),kl.prototype=Object.assign(Object.create(Tl.prototype),{constructor:kl,ValueTypeName:"vector"}),Object.assign(Bl,{parse:function(t){const e=[],i=t.tracks,s=1/(t.fps||1);for(let t=0,n=i.length;t!==n;++t)e.push(Rl(i[t]).scale(s));const n=new Bl(t.name,t.duration,e,t.blendMode);return n.uuid=t.uuid,n},toJSON:function(t){const e=[],i=t.tracks,s={name:t.name,duration:t.duration,tracks:e,uuid:t.uuid,blendMode:t.blendMode};for(let t=0,s=i.length;t!==s;++t)e.push(Tl.toJSON(i[t]));return s},CreateFromMorphTargetSequence:function(t,e,i,s){const n=e.length,o=[];for(let t=0;t<n;t++){let r=[],a=[];r.push((t+n-1)%n,t,(t+1)%n),a.push(0,1,0);const h=wl.getKeyframeOrder(r);r=wl.sortedArray(r,1,h),a=wl.sortedArray(a,1,h),s||0!==r[0]||(r.push(n),a.push(a[0])),o.push(new Ll(".morphTargetInfluences["+e[t].name+"]",r,a).scale(1/i))}return new Bl(t,-1,o)},findByName:function(t,e){let i=t;if(!Array.isArray(t)){const e=t;i=e.geometry&&e.geometry.animations||e.animations}for(let t=0;t<i.length;t++)if(i[t].name===e)return i[t];return null},CreateClipsFromMorphTargetSequences:function(t,e,i){const s={},n=/^([\w-]*?)([\d]+)$/;for(let e=0,i=t.length;e<i;e++){const i=t[e],o=i.name.match(n);if(o&&o.length>1){const t=o[1];let e=s[t];e||(s[t]=e=[]),e.push(i)}}const o=[];for(const t in s)o.push(Bl.CreateFromMorphTargetSequence(t,s[t],e,i));return o},parseAnimation:function(t,e){if(!t)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;const i=function(t,e,i,s,n){if(0!==i.length){const o=[],r=[];wl.flattenJSON(i,o,r,s),0!==o.length&&n.push(new t(e,o,r))}},s=[],n=t.name||"default",o=t.fps||30,r=t.blendMode;let a=t.length||-1;const h=t.hierarchy||[];for(let t=0;t<h.length;t++){const n=h[t].keys;if(n&&0!==n.length)if(n[0].morphTargets){const t={};let e;for(e=0;e<n.length;e++)if(n[e].morphTargets)for(let i=0;i<n[e].morphTargets.length;i++)t[n[e].morphTargets[i]]=-1;for(const i in t){const t=[],o=[];for(let s=0;s!==n[e].morphTargets.length;++s){const s=n[e];t.push(s.time),o.push(s.morphTarget===i?1:0)}s.push(new Ll(".morphTargetInfluence["+i+"]",t,o))}a=t.length*(o||1)}else{const o=".bones["+e[t].name+"]";i(kl,o+".position",n,"pos",s),i(Al,o+".quaternion",n,"rot",s),i(kl,o+".scale",n,"scl",s)}}return 0===s.length?null:new Bl(n,a,s,r)}}),Object.assign(Bl.prototype,{resetDuration:function(){let t=0;for(let e=0,i=this.tracks.length;e!==i;++e){const i=this.tracks[e];t=Math.max(t,i.times[i.times.length-1])}return this.duration=t,this},trim:function(){for(let t=0;t<this.tracks.length;t++)this.tracks[t].trim(0,this.duration);return this},validate:function(){let t=!0;for(let e=0;e<this.tracks.length;e++)t=t&&this.tracks[e].validate();return t},optimize:function(){for(let t=0;t<this.tracks.length;t++)this.tracks[t].optimize();return this},clone:function(){const t=[];for(let e=0;e<this.tracks.length;e++)t.push(this.tracks[e].clone());return new Bl(this.name,this.duration,t,this.blendMode)},toJSON:function(){return Bl.toJSON(this)}});const Dl={enabled:!1,files:{},add:function(t,e){!1!==this.enabled&&(this.files[t]=e)},get:function(t){if(!1!==this.enabled)return this.files[t]},remove:function(t){delete this.files[t]},clear:function(){this.files={}}};function Il(t,e,i){const s=this;let n,o=!1,r=0,a=0;const h=[];this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=i,this.itemStart=function(t){a++,!1===o&&void 0!==s.onStart&&s.onStart(t,r,a),o=!0},this.itemEnd=function(t){r++,void 0!==s.onProgress&&s.onProgress(t,r,a),r===a&&(o=!1,void 0!==s.onLoad&&s.onLoad())},this.itemError=function(t){void 0!==s.onError&&s.onError(t)},this.resolveURL=function(t){return n?n(t):t},this.setURLModifier=function(t){return n=t,this},this.addHandler=function(t,e){return h.push(t,e),this},this.removeHandler=function(t){const e=h.indexOf(t);return-1!==e&&h.splice(e,2),this},this.getHandler=function(t){for(let e=0,i=h.length;e<i;e+=2){const i=h[e],s=h[e+1];if(i.global&&(i.lastIndex=0),i.test(t))return s}return null}}const Fl=new Il;function zl(t){this.manager=void 0!==t?t:Fl,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}Object.assign(zl.prototype,{load:function(){},loadAsync:function(t,e){const i=this;return new Promise((function(s,n){i.load(t,s,e,n)}))},parse:function(){},setCrossOrigin:function(t){return this.crossOrigin=t,this},setWithCredentials:function(t){return this.withCredentials=t,this},setPath:function(t){return this.path=t,this},setResourcePath:function(t){return this.resourcePath=t,this},setRequestHeader:function(t){return this.requestHeader=t,this}});const Ol={};function Nl(t){zl.call(this,t)}function Wl(t){zl.call(this,t)}function Hl(t){zl.call(this,t)}function Ul(t){zl.call(this,t)}function Vl(t){zl.call(this,t)}function Gl(t){zl.call(this,t)}function jl(t){zl.call(this,t)}function ql(){this.type="Curve",this.arcLengthDivisions=200}function $l(t,e,i,s,n,o,r,a){ql.call(this),this.type="EllipseCurve",this.aX=t||0,this.aY=e||0,this.xRadius=i||1,this.yRadius=s||1,this.aStartAngle=n||0,this.aEndAngle=o||2*Math.PI,this.aClockwise=r||!1,this.aRotation=a||0}function Xl(t,e,i,s,n,o){$l.call(this,t,e,i,i,s,n,o),this.type="ArcCurve"}function Yl(){let t=0,e=0,i=0,s=0;function n(n,o,r,a){t=n,e=r,i=-3*n+3*o-2*r-a,s=2*n-2*o+r+a}return{initCatmullRom:function(t,e,i,s,o){n(e,i,o*(i-t),o*(s-e))},initNonuniformCatmullRom:function(t,e,i,s,o,r,a){let h=(e-t)/o-(i-t)/(o+r)+(i-e)/r,l=(i-e)/r-(s-e)/(r+a)+(s-i)/a;h*=r,l*=r,n(e,i,h,l)},calc:function(n){const o=n*n;return t+e*n+i*o+s*(o*n)}}}Nl.prototype=Object.assign(Object.create(zl.prototype),{constructor:Nl,load:function(t,e,i,s){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const n=this,o=Dl.get(t);if(void 0!==o)return n.manager.itemStart(t),setTimeout((function(){e&&e(o),n.manager.itemEnd(t)}),0),o;if(void 0!==Ol[t])return void Ol[t].push({onLoad:e,onProgress:i,onError:s});const r=t.match(/^data:(.*?)(;base64)?,(.*)$/);let a;if(r){const i=r[1],o=!!r[2];let a=r[3];a=decodeURIComponent(a),o&&(a=atob(a));try{let s;const o=(this.responseType||"").toLowerCase();switch(o){case"arraybuffer":case"blob":const t=new Uint8Array(a.length);for(let e=0;e<a.length;e++)t[e]=a.charCodeAt(e);s="blob"===o?new Blob([t.buffer],{type:i}):t.buffer;break;case"document":const e=new DOMParser;s=e.parseFromString(a,i);break;case"json":s=JSON.parse(a);break;default:s=a}setTimeout((function(){e&&e(s),n.manager.itemEnd(t)}),0)}catch(e){setTimeout((function(){s&&s(e),n.manager.itemError(t),n.manager.itemEnd(t)}),0)}}else{Ol[t]=[],Ol[t].push({onLoad:e,onProgress:i,onError:s}),a=new XMLHttpRequest,a.open("GET",t,!0),a.addEventListener("load",(function(e){const i=this.response,s=Ol[t];if(delete Ol[t],200===this.status||0===this.status){0===this.status&&console.warn("THREE.FileLoader: HTTP Status 0 received."),Dl.add(t,i);for(let t=0,e=s.length;t<e;t++){const e=s[t];e.onLoad&&e.onLoad(i)}n.manager.itemEnd(t)}else{for(let t=0,i=s.length;t<i;t++){const i=s[t];i.onError&&i.onError(e)}n.manager.itemError(t),n.manager.itemEnd(t)}}),!1),a.addEventListener("progress",(function(e){const i=Ol[t];for(let t=0,s=i.length;t<s;t++){const s=i[t];s.onProgress&&s.onProgress(e)}}),!1),a.addEventListener("error",(function(e){const i=Ol[t];delete Ol[t];for(let t=0,s=i.length;t<s;t++){const s=i[t];s.onError&&s.onError(e)}n.manager.itemError(t),n.manager.itemEnd(t)}),!1),a.addEventListener("abort",(function(e){const i=Ol[t];delete Ol[t];for(let t=0,s=i.length;t<s;t++){const s=i[t];s.onError&&s.onError(e)}n.manager.itemError(t),n.manager.itemEnd(t)}),!1),void 0!==this.responseType&&(a.responseType=this.responseType),void 0!==this.withCredentials&&(a.withCredentials=this.withCredentials),a.overrideMimeType&&a.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain");for(const t in this.requestHeader)a.setRequestHeader(t,this.requestHeader[t]);a.send(null)}return n.manager.itemStart(t),a},setResponseType:function(t){return this.responseType=t,this},setMimeType:function(t){return this.mimeType=t,this}}),Wl.prototype=Object.assign(Object.create(zl.prototype),{constructor:Wl,load:function(t,e,i,s){const n=this,o=new Nl(n.manager);o.setPath(n.path),o.setRequestHeader(n.requestHeader),o.setWithCredentials(n.withCredentials),o.load(t,(function(i){try{e(n.parse(JSON.parse(i)))}catch(e){s?s(e):console.error(e),n.manager.itemError(t)}}),i,s)},parse:function(t){const e=[];for(let i=0;i<t.length;i++){const s=Bl.parse(t[i]);e.push(s)}return e}}),Hl.prototype=Object.assign(Object.create(zl.prototype),{constructor:Hl,load:function(t,e,i,s){const n=this,o=[],r=new hh,a=new Nl(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(n.withCredentials);let h=0;function l(l){a.load(t[l],(function(t){const i=n.parse(t,!0);o[l]={width:i.width,height:i.height,format:i.format,mipmaps:i.mipmaps},h+=1,6===h&&(1===i.mipmapCount&&(r.minFilter=ct),r.image=o,r.format=i.format,r.needsUpdate=!0,e&&e(r))}),i,s)}if(Array.isArray(t))for(let e=0,i=t.length;e<i;++e)l(e);else a.load(t,(function(t){const i=n.parse(t,!0);if(i.isCubemap){const t=i.mipmaps.length/i.mipmapCount;for(let e=0;e<t;e++){o[e]={mipmaps:[]};for(let t=0;t<i.mipmapCount;t++)o[e].mipmaps.push(i.mipmaps[e*i.mipmapCount+t]),o[e].format=i.format,o[e].width=i.width,o[e].height=i.height}r.image=o}else r.image.width=i.width,r.image.height=i.height,r.mipmaps=i.mipmaps;1===i.mipmapCount&&(r.minFilter=ct),r.format=i.format,r.needsUpdate=!0,e&&e(r)}),i,s);return r}}),Ul.prototype=Object.assign(Object.create(zl.prototype),{constructor:Ul,load:function(t,e,i,s){void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const n=this,o=Dl.get(t);if(void 0!==o)return n.manager.itemStart(t),setTimeout((function(){e&&e(o),n.manager.itemEnd(t)}),0),o;const r=document.createElementNS("http://www.w3.org/1999/xhtml","img");function a(){r.removeEventListener("load",a,!1),r.removeEventListener("error",h,!1),Dl.add(t,this),e&&e(this),n.manager.itemEnd(t)}function h(e){r.removeEventListener("load",a,!1),r.removeEventListener("error",h,!1),s&&s(e),n.manager.itemError(t),n.manager.itemEnd(t)}return r.addEventListener("load",a,!1),r.addEventListener("error",h,!1),"data:"!==t.substr(0,5)&&void 0!==this.crossOrigin&&(r.crossOrigin=this.crossOrigin),n.manager.itemStart(t),r.src=t,r}}),Vl.prototype=Object.assign(Object.create(zl.prototype),{constructor:Vl,load:function(t,e,i,s){const n=new Un,o=new Ul(this.manager);o.setCrossOrigin(this.crossOrigin),o.setPath(this.path);let r=0;function a(i){o.load(t[i],(function(t){n.images[i]=t,r++,6===r&&(n.needsUpdate=!0,e&&e(n))}),void 0,s)}for(let e=0;e<t.length;++e)a(e);return n}}),Gl.prototype=Object.assign(Object.create(zl.prototype),{constructor:Gl,load:function(t,e,i,s){const n=this,o=new Gn,r=new Nl(this.manager);return r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setPath(this.path),r.setWithCredentials(n.withCredentials),r.load(t,(function(t){const i=n.parse(t);i&&(void 0!==i.image?o.image=i.image:void 0!==i.data&&(o.image.width=i.width,o.image.height=i.height,o.image.data=i.data),o.wrapS=void 0!==i.wrapS?i.wrapS:ot,o.wrapT=void 0!==i.wrapT?i.wrapT:ot,o.magFilter=void 0!==i.magFilter?i.magFilter:ct,o.minFilter=void 0!==i.minFilter?i.minFilter:ct,o.anisotropy=void 0!==i.anisotropy?i.anisotropy:1,void 0!==i.format&&(o.format=i.format),void 0!==i.type&&(o.type=i.type),void 0!==i.mipmaps&&(o.mipmaps=i.mipmaps,o.minFilter=ut),1===i.mipmapCount&&(o.minFilter=ct),o.needsUpdate=!0,e&&e(o,i))}),i,s),o}}),jl.prototype=Object.assign(Object.create(zl.prototype),{constructor:jl,load:function(t,e,i,s){const n=new ai,o=new Ul(this.manager);return o.setCrossOrigin(this.crossOrigin),o.setPath(this.path),o.load(t,(function(i){n.image=i;const s=t.search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/);n.format=s?Et:Lt,n.needsUpdate=!0,void 0!==e&&e(n)}),i,s),n}}),Object.assign(ql.prototype,{getPoint:function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},getPointAt:function(t,e){const i=this.getUtoTmapping(t);return this.getPoint(i,e)},getPoints:function(t=5){const e=[];for(let i=0;i<=t;i++)e.push(this.getPoint(i/t));return e},getSpacedPoints:function(t=5){const e=[];for(let i=0;i<=t;i++)e.push(this.getPointAt(i/t));return e},getLength:function(){const t=this.getLengths();return t[t.length-1]},getLengths:function(t){if(void 0===t&&(t=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const e=[];let i,s=this.getPoint(0),n=0;e.push(0);for(let o=1;o<=t;o++)i=this.getPoint(o/t),n+=i.distanceTo(s),e.push(n),s=i;return this.cacheArcLengths=e,e},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(t,e){const i=this.getLengths();let s=0;const n=i.length;let o;o=e||t*i[n-1];let r,a=0,h=n-1;for(;a<=h;)if(s=Math.floor(a+(h-a)/2),r=i[s]-o,r<0)a=s+1;else{if(!(r>0)){h=s;break}h=s-1}if(s=h,i[s]===o)return s/(n-1);const l=i[s];return(s+(o-l)/(i[s+1]-l))/(n-1)},getTangent:function(t,e){const i=1e-4;let s=t-i,n=t+i;s<0&&(s=0),n>1&&(n=1);const o=this.getPoint(s),r=this.getPoint(n),a=e||(o.isVector2?new ii:new pi);return a.copy(r).sub(o).normalize(),a},getTangentAt:function(t,e){const i=this.getUtoTmapping(t);return this.getTangent(i,e)},computeFrenetFrames:function(t,e){const i=new pi,s=[],n=[],o=[],r=new pi,a=new Hi;for(let e=0;e<=t;e++){const i=e/t;s[e]=this.getTangentAt(i,new pi),s[e].normalize()}n[0]=new pi,o[0]=new pi;let h=Number.MAX_VALUE;const l=Math.abs(s[0].x),c=Math.abs(s[0].y),d=Math.abs(s[0].z);l<=h&&(h=l,i.set(1,0,0)),c<=h&&(h=c,i.set(0,1,0)),d<=h&&i.set(0,0,1),r.crossVectors(s[0],i).normalize(),n[0].crossVectors(s[0],r),o[0].crossVectors(s[0],n[0]);for(let e=1;e<=t;e++){if(n[e]=n[e-1].clone(),o[e]=o[e-1].clone(),r.crossVectors(s[e-1],s[e]),r.length()>Number.EPSILON){r.normalize();const t=Math.acos(ei.clamp(s[e-1].dot(s[e]),-1,1));n[e].applyMatrix4(a.makeRotationAxis(r,t))}o[e].crossVectors(s[e],n[e])}if(!0===e){let e=Math.acos(ei.clamp(n[0].dot(n[t]),-1,1));e/=t,s[0].dot(r.crossVectors(n[0],n[t]))>0&&(e=-e);for(let i=1;i<=t;i++)n[i].applyMatrix4(a.makeRotationAxis(s[i],e*i)),o[i].crossVectors(s[i],n[i])}return{tangents:s,normals:n,binormals:o}},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.arcLengthDivisions=t.arcLengthDivisions,this},toJSON:function(){const t={metadata:{version:4.5,type:"Curve",generator:"Curve.toJSON"}};return t.arcLengthDivisions=this.arcLengthDivisions,t.type=this.type,t},fromJSON:function(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}}),$l.prototype=Object.create(ql.prototype),$l.prototype.constructor=$l,$l.prototype.isEllipseCurve=!0,$l.prototype.getPoint=function(t,e){const i=e||new ii,s=2*Math.PI;let n=this.aEndAngle-this.aStartAngle;const o=Math.abs(n)<Number.EPSILON;for(;n<0;)n+=s;for(;n>s;)n-=s;n<Number.EPSILON&&(n=o?0:s),!0!==this.aClockwise||o||(n===s?n=-s:n-=s);const r=this.aStartAngle+t*n;let a=this.aX+this.xRadius*Math.cos(r),h=this.aY+this.yRadius*Math.sin(r);if(0!==this.aRotation){const t=Math.cos(this.aRotation),e=Math.sin(this.aRotation),i=a-this.aX,s=h-this.aY;a=i*t-s*e+this.aX,h=i*e+s*t+this.aY}return i.set(a,h)},$l.prototype.copy=function(t){return ql.prototype.copy.call(this,t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this},$l.prototype.toJSON=function(){const t=ql.prototype.toJSON.call(this);return t.aX=this.aX,t.aY=this.aY,t.xRadius=this.xRadius,t.yRadius=this.yRadius,t.aStartAngle=this.aStartAngle,t.aEndAngle=this.aEndAngle,t.aClockwise=this.aClockwise,t.aRotation=this.aRotation,t},$l.prototype.fromJSON=function(t){return ql.prototype.fromJSON.call(this,t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this},Xl.prototype=Object.create($l.prototype),Xl.prototype.constructor=Xl,Xl.prototype.isArcCurve=!0;const Zl=new pi,Kl=new Yl,Jl=new Yl,Ql=new Yl;function tc(t=[],e=!1,i="centripetal",s=.5){ql.call(this),this.type="CatmullRomCurve3",this.points=t,this.closed=e,this.curveType=i,this.tension=s}function ec(t,e,i,s,n){const o=.5*(s-e),r=.5*(n-i),a=t*t;return(2*i-2*s+o+r)*(t*a)+(-3*i+3*s-2*o-r)*a+o*t+i}function ic(t,e,i,s){return function(t,e){const i=1-t;return i*i*e}(t,e)+function(t,e){return 2*(1-t)*t*e}(t,i)+function(t,e){return t*t*e}(t,s)}function sc(t,e,i,s,n){return function(t,e){const i=1-t;return i*i*i*e}(t,e)+function(t,e){const i=1-t;return 3*i*i*t*e}(t,i)+function(t,e){return 3*(1-t)*t*t*e}(t,s)+function(t,e){return t*t*t*e}(t,n)}function nc(t=new ii,e=new ii,i=new ii,s=new ii){ql.call(this),this.type="CubicBezierCurve",this.v0=t,this.v1=e,this.v2=i,this.v3=s}function oc(t=new pi,e=new pi,i=new pi,s=new pi){ql.call(this),this.type="CubicBezierCurve3",this.v0=t,this.v1=e,this.v2=i,this.v3=s}function rc(t=new ii,e=new ii){ql.call(this),this.type="LineCurve",this.v1=t,this.v2=e}function ac(t=new pi,e=new pi){ql.call(this),this.type="LineCurve3",this.v1=t,this.v2=e}function hc(t=new ii,e=new ii,i=new ii){ql.call(this),this.type="QuadraticBezierCurve",this.v0=t,this.v1=e,this.v2=i}function lc(t=new pi,e=new pi,i=new pi){ql.call(this),this.type="QuadraticBezierCurve3",this.v0=t,this.v1=e,this.v2=i}function cc(t=[]){ql.call(this),this.type="SplineCurve",this.points=t}tc.prototype=Object.create(ql.prototype),tc.prototype.constructor=tc,tc.prototype.isCatmullRomCurve3=!0,tc.prototype.getPoint=function(t,e=new pi){const i=e,s=this.points,n=s.length,o=(n-(this.closed?0:1))*t;let r,a,h=Math.floor(o),l=o-h;this.closed?h+=h>0?0:(Math.floor(Math.abs(h)/n)+1)*n:0===l&&h===n-1&&(h=n-2,l=1),this.closed||h>0?r=s[(h-1)%n]:(Zl.subVectors(s[0],s[1]).add(s[0]),r=Zl);const c=s[h%n],d=s[(h+1)%n];if(this.closed||h+2<n?a=s[(h+2)%n]:(Zl.subVectors(s[n-1],s[n-2]).add(s[n-1]),a=Zl),"centripetal"===this.curveType||"chordal"===this.curveType){const t="chordal"===this.curveType?.5:.25;let e=Math.pow(r.distanceToSquared(c),t),i=Math.pow(c.distanceToSquared(d),t),s=Math.pow(d.distanceToSquared(a),t);i<1e-4&&(i=1),e<1e-4&&(e=i),s<1e-4&&(s=i),Kl.initNonuniformCatmullRom(r.x,c.x,d.x,a.x,e,i,s),Jl.initNonuniformCatmullRom(r.y,c.y,d.y,a.y,e,i,s),Ql.initNonuniformCatmullRom(r.z,c.z,d.z,a.z,e,i,s)}else"catmullrom"===this.curveType&&(Kl.initCatmullRom(r.x,c.x,d.x,a.x,this.tension),Jl.initCatmullRom(r.y,c.y,d.y,a.y,this.tension),Ql.initCatmullRom(r.z,c.z,d.z,a.z,this.tension));return i.set(Kl.calc(l),Jl.calc(l),Ql.calc(l)),i},tc.prototype.copy=function(t){ql.prototype.copy.call(this,t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push(i.clone())}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this},tc.prototype.toJSON=function(){const t=ql.prototype.toJSON.call(this);t.points=[];for(let e=0,i=this.points.length;e<i;e++){const i=this.points[e];t.points.push(i.toArray())}return t.closed=this.closed,t.curveType=this.curveType,t.tension=this.tension,t},tc.prototype.fromJSON=function(t){ql.prototype.fromJSON.call(this,t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push((new pi).fromArray(i))}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this},nc.prototype=Object.create(ql.prototype),nc.prototype.constructor=nc,nc.prototype.isCubicBezierCurve=!0,nc.prototype.getPoint=function(t,e=new ii){const i=e,s=this.v0,n=this.v1,o=this.v2,r=this.v3;return i.set(sc(t,s.x,n.x,o.x,r.x),sc(t,s.y,n.y,o.y,r.y)),i},nc.prototype.copy=function(t){return ql.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this},nc.prototype.toJSON=function(){const t=ql.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t},nc.prototype.fromJSON=function(t){return ql.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this},oc.prototype=Object.create(ql.prototype),oc.prototype.constructor=oc,oc.prototype.isCubicBezierCurve3=!0,oc.prototype.getPoint=function(t,e=new pi){const i=e,s=this.v0,n=this.v1,o=this.v2,r=this.v3;return i.set(sc(t,s.x,n.x,o.x,r.x),sc(t,s.y,n.y,o.y,r.y),sc(t,s.z,n.z,o.z,r.z)),i},oc.prototype.copy=function(t){return ql.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this},oc.prototype.toJSON=function(){const t=ql.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t},oc.prototype.fromJSON=function(t){return ql.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this},rc.prototype=Object.create(ql.prototype),rc.prototype.constructor=rc,rc.prototype.isLineCurve=!0,rc.prototype.getPoint=function(t,e=new ii){const i=e;return 1===t?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(t).add(this.v1)),i},rc.prototype.getPointAt=function(t,e){return this.getPoint(t,e)},rc.prototype.getTangent=function(t,e){const i=e||new ii;return i.copy(this.v2).sub(this.v1).normalize(),i},rc.prototype.copy=function(t){return ql.prototype.copy.call(this,t),this.v1.copy(t.v1),this.v2.copy(t.v2),this},rc.prototype.toJSON=function(){const t=ql.prototype.toJSON.call(this);return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t},rc.prototype.fromJSON=function(t){return ql.prototype.fromJSON.call(this,t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this},ac.prototype=Object.create(ql.prototype),ac.prototype.constructor=ac,ac.prototype.isLineCurve3=!0,ac.prototype.getPoint=function(t,e=new pi){const i=e;return 1===t?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(t).add(this.v1)),i},ac.prototype.getPointAt=function(t,e){return this.getPoint(t,e)},ac.prototype.copy=function(t){return ql.prototype.copy.call(this,t),this.v1.copy(t.v1),this.v2.copy(t.v2),this},ac.prototype.toJSON=function(){const t=ql.prototype.toJSON.call(this);return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t},ac.prototype.fromJSON=function(t){return ql.prototype.fromJSON.call(this,t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this},hc.prototype=Object.create(ql.prototype),hc.prototype.constructor=hc,hc.prototype.isQuadraticBezierCurve=!0,hc.prototype.getPoint=function(t,e=new ii){const i=e,s=this.v0,n=this.v1,o=this.v2;return i.set(ic(t,s.x,n.x,o.x),ic(t,s.y,n.y,o.y)),i},hc.prototype.copy=function(t){return ql.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this},hc.prototype.toJSON=function(){const t=ql.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t},hc.prototype.fromJSON=function(t){return ql.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this},lc.prototype=Object.create(ql.prototype),lc.prototype.constructor=lc,lc.prototype.isQuadraticBezierCurve3=!0,lc.prototype.getPoint=function(t,e=new pi){const i=e,s=this.v0,n=this.v1,o=this.v2;return i.set(ic(t,s.x,n.x,o.x),ic(t,s.y,n.y,o.y),ic(t,s.z,n.z,o.z)),i},lc.prototype.copy=function(t){return ql.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this},lc.prototype.toJSON=function(){const t=ql.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t},lc.prototype.fromJSON=function(t){return ql.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this},cc.prototype=Object.create(ql.prototype),cc.prototype.constructor=cc,cc.prototype.isSplineCurve=!0,cc.prototype.getPoint=function(t,e=new ii){const i=e,s=this.points,n=(s.length-1)*t,o=Math.floor(n),r=n-o,a=s[0===o?o:o-1],h=s[o],l=s[o>s.length-2?s.length-1:o+1],c=s[o>s.length-3?s.length-1:o+2];return i.set(ec(r,a.x,h.x,l.x,c.x),ec(r,a.y,h.y,l.y,c.y)),i},cc.prototype.copy=function(t){ql.prototype.copy.call(this,t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push(i.clone())}return this},cc.prototype.toJSON=function(){const t=ql.prototype.toJSON.call(this);t.points=[];for(let e=0,i=this.points.length;e<i;e++){const i=this.points[e];t.points.push(i.toArray())}return t},cc.prototype.fromJSON=function(t){ql.prototype.fromJSON.call(this,t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push((new ii).fromArray(i))}return this};var dc=Object.freeze({__proto__:null,ArcCurve:Xl,CatmullRomCurve3:tc,CubicBezierCurve:nc,CubicBezierCurve3:oc,EllipseCurve:$l,LineCurve:rc,LineCurve3:ac,QuadraticBezierCurve:hc,QuadraticBezierCurve3:lc,SplineCurve:cc});function uc(){ql.call(this),this.type="CurvePath",this.curves=[],this.autoClose=!1}function pc(t){uc.call(this),this.type="Path",this.currentPoint=new ii,t&&this.setFromPoints(t)}function mc(t){pc.call(this,t),this.uuid=ei.generateUUID(),this.type="Shape",this.holes=[]}function fc(t,e=1){us.call(this),this.type="Light",this.color=new Ds(t),this.intensity=e}function gc(t,e,i){fc.call(this,t,i),this.type="HemisphereLight",this.position.copy(us.DefaultUp),this.updateMatrix(),this.groundColor=new Ds(e)}function yc(t){this.camera=t,this.bias=0,this.normalBias=0,this.radius=1,this.mapSize=new ii(512,512),this.map=null,this.mapPass=null,this.matrix=new Hi,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new $n,this._frameExtents=new ii(1,1),this._viewportCount=1,this._viewports=[new li(0,0,1,1)]}function vc(){yc.call(this,new Nn(50,1,.5,500)),this.focus=1}function wc(t,e,i,s,n,o){fc.call(this,t,e),this.type="SpotLight",this.position.copy(us.DefaultUp),this.updateMatrix(),this.target=new us,Object.defineProperty(this,"power",{get:function(){return this.intensity*Math.PI},set:function(t){this.intensity=t/Math.PI}}),this.distance=void 0!==i?i:0,this.angle=void 0!==s?s:Math.PI/3,this.penumbra=void 0!==n?n:0,this.decay=void 0!==o?o:1,this.shadow=new vc}function xc(){yc.call(this,new Nn(90,1,.5,500)),this._frameExtents=new ii(4,2),this._viewportCount=6,this._viewports=[new li(2,1,1,1),new li(0,1,1,1),new li(3,1,1,1),new li(1,1,1,1),new li(3,0,1,1),new li(1,0,1,1)],this._cubeDirections=[new pi(1,0,0),new pi(-1,0,0),new pi(0,0,1),new pi(0,0,-1),new pi(0,1,0),new pi(0,-1,0)],this._cubeUps=[new pi(0,1,0),new pi(0,1,0),new pi(0,1,0),new pi(0,1,0),new pi(0,0,1),new pi(0,0,-1)]}function bc(t,e,i,s){fc.call(this,t,e),this.type="PointLight",Object.defineProperty(this,"power",{get:function(){return 4*this.intensity*Math.PI},set:function(t){this.intensity=t/(4*Math.PI)}}),this.distance=void 0!==i?i:0,this.decay=void 0!==s?s:1,this.shadow=new xc}function Sc(t=-1,e=1,i=1,s=-1,n=.1,o=2e3){On.call(this),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=t,this.right=e,this.top=i,this.bottom=s,this.near=n,this.far=o,this.updateProjectionMatrix()}function Mc(){yc.call(this,new Sc(-5,5,5,-5,.5,500))}function Tc(t,e){fc.call(this,t,e),this.type="DirectionalLight",this.position.copy(us.DefaultUp),this.updateMatrix(),this.target=new us,this.shadow=new Mc}function _c(t,e){fc.call(this,t,e),this.type="AmbientLight"}function Ec(t,e,i,s){fc.call(this,t,e),this.type="RectAreaLight",this.width=void 0!==i?i:10,this.height=void 0!==s?s:10}uc.prototype=Object.assign(Object.create(ql.prototype),{constructor:uc,add:function(t){this.curves.push(t)},closePath:function(){const t=this.curves[0].getPoint(0),e=this.curves[this.curves.length-1].getPoint(1);t.equals(e)||this.curves.push(new rc(e,t))},getPoint:function(t){const e=t*this.getLength(),i=this.getCurveLengths();let s=0;for(;s<i.length;){if(i[s]>=e){const t=i[s]-e,n=this.curves[s],o=n.getLength(),r=0===o?0:1-t/o;return n.getPointAt(r)}s++}return null},getLength:function(){const t=this.getCurveLengths();return t[t.length-1]},updateArcLengths:function(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()},getCurveLengths:function(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const t=[];let e=0;for(let i=0,s=this.curves.length;i<s;i++)e+=this.curves[i].getLength(),t.push(e);return this.cacheLengths=t,t},getSpacedPoints:function(t=40){const e=[];for(let i=0;i<=t;i++)e.push(this.getPoint(i/t));return this.autoClose&&e.push(e[0]),e},getPoints:function(t=12){const e=[];let i;for(let s=0,n=this.curves;s<n.length;s++){const o=n[s],r=o&&o.isEllipseCurve?2*t:o&&(o.isLineCurve||o.isLineCurve3)?1:o&&o.isSplineCurve?t*o.points.length:t,a=o.getPoints(r);for(let t=0;t<a.length;t++){const s=a[t];i&&i.equals(s)||(e.push(s),i=s)}}return this.autoClose&&e.length>1&&!e[e.length-1].equals(e[0])&&e.push(e[0]),e},copy:function(t){ql.prototype.copy.call(this,t),this.curves=[];for(let e=0,i=t.curves.length;e<i;e++){const i=t.curves[e];this.curves.push(i.clone())}return this.autoClose=t.autoClose,this},toJSON:function(){const t=ql.prototype.toJSON.call(this);t.autoClose=this.autoClose,t.curves=[];for(let e=0,i=this.curves.length;e<i;e++){const i=this.curves[e];t.curves.push(i.toJSON())}return t},fromJSON:function(t){ql.prototype.fromJSON.call(this,t),this.autoClose=t.autoClose,this.curves=[];for(let e=0,i=t.curves.length;e<i;e++){const i=t.curves[e];this.curves.push((new dc[i.type]).fromJSON(i))}return this}}),pc.prototype=Object.assign(Object.create(uc.prototype),{constructor:pc,setFromPoints:function(t){this.moveTo(t[0].x,t[0].y);for(let e=1,i=t.length;e<i;e++)this.lineTo(t[e].x,t[e].y);return this},moveTo:function(t,e){return this.currentPoint.set(t,e),this},lineTo:function(t,e){const i=new rc(this.currentPoint.clone(),new ii(t,e));return this.curves.push(i),this.currentPoint.set(t,e),this},quadraticCurveTo:function(t,e,i,s){const n=new hc(this.currentPoint.clone(),new ii(t,e),new ii(i,s));return this.curves.push(n),this.currentPoint.set(i,s),this},bezierCurveTo:function(t,e,i,s,n,o){const r=new nc(this.currentPoint.clone(),new ii(t,e),new ii(i,s),new ii(n,o));return this.curves.push(r),this.currentPoint.set(n,o),this},splineThru:function(t){const e=new cc([this.currentPoint.clone()].concat(t));return this.curves.push(e),this.currentPoint.copy(t[t.length-1]),this},arc:function(t,e,i,s,n,o){const r=this.currentPoint.x,a=this.currentPoint.y;return this.absarc(t+r,e+a,i,s,n,o),this},absarc:function(t,e,i,s,n,o){return this.absellipse(t,e,i,i,s,n,o),this},ellipse:function(t,e,i,s,n,o,r,a){const h=this.currentPoint.x,l=this.currentPoint.y;return this.absellipse(t+h,e+l,i,s,n,o,r,a),this},absellipse:function(t,e,i,s,n,o,r,a){const h=new $l(t,e,i,s,n,o,r,a);if(this.curves.length>0){const t=h.getPoint(0);t.equals(this.currentPoint)||this.lineTo(t.x,t.y)}this.curves.push(h);const l=h.getPoint(1);return this.currentPoint.copy(l),this},copy:function(t){return uc.prototype.copy.call(this,t),this.currentPoint.copy(t.currentPoint),this},toJSON:function(){const t=uc.prototype.toJSON.call(this);return t.currentPoint=this.currentPoint.toArray(),t},fromJSON:function(t){return uc.prototype.fromJSON.call(this,t),this.currentPoint.fromArray(t.currentPoint),this}}),mc.prototype=Object.assign(Object.create(pc.prototype),{constructor:mc,getPointsHoles:function(t){const e=[];for(let i=0,s=this.holes.length;i<s;i++)e[i]=this.holes[i].getPoints(t);return e},extractPoints:function(t){return{shape:this.getPoints(t),holes:this.getPointsHoles(t)}},copy:function(t){pc.prototype.copy.call(this,t),this.holes=[];for(let e=0,i=t.holes.length;e<i;e++){const i=t.holes[e];this.holes.push(i.clone())}return this},toJSON:function(){const t=pc.prototype.toJSON.call(this);t.uuid=this.uuid,t.holes=[];for(let e=0,i=this.holes.length;e<i;e++){const i=this.holes[e];t.holes.push(i.toJSON())}return t},fromJSON:function(t){pc.prototype.fromJSON.call(this,t),this.uuid=t.uuid,this.holes=[];for(let e=0,i=t.holes.length;e<i;e++){const i=t.holes[e];this.holes.push((new pc).fromJSON(i))}return this}}),fc.prototype=Object.assign(Object.create(us.prototype),{constructor:fc,isLight:!0,copy:function(t){return us.prototype.copy.call(this,t),this.color.copy(t.color),this.intensity=t.intensity,this},toJSON:function(t){const e=us.prototype.toJSON.call(this,t);return e.object.color=this.color.getHex(),e.object.intensity=this.intensity,void 0!==this.groundColor&&(e.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(e.object.distance=this.distance),void 0!==this.angle&&(e.object.angle=this.angle),void 0!==this.decay&&(e.object.decay=this.decay),void 0!==this.penumbra&&(e.object.penumbra=this.penumbra),void 0!==this.shadow&&(e.object.shadow=this.shadow.toJSON()),e}}),gc.prototype=Object.assign(Object.create(fc.prototype),{constructor:gc,isHemisphereLight:!0,copy:function(t){return fc.prototype.copy.call(this,t),this.groundColor.copy(t.groundColor),this}}),Object.assign(yc.prototype,{_projScreenMatrix:new Hi,_lightPositionWorld:new pi,_lookTarget:new pi,getViewportCount:function(){return this._viewportCount},getFrustum:function(){return this._frustum},updateMatrices:function(t){const e=this.camera,i=this.matrix,s=this._projScreenMatrix,n=this._lookTarget,o=this._lightPositionWorld;o.setFromMatrixPosition(t.matrixWorld),e.position.copy(o),n.setFromMatrixPosition(t.target.matrixWorld),e.lookAt(n),e.updateMatrixWorld(),s.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this._frustum.setFromProjectionMatrix(s),i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(e.projectionMatrix),i.multiply(e.matrixWorldInverse)},getViewport:function(t){return this._viewports[t]},getFrameExtents:function(){return this._frameExtents},copy:function(t){return this.camera=t.camera.clone(),this.bias=t.bias,this.radius=t.radius,this.mapSize.copy(t.mapSize),this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){const t={};return 0!==this.bias&&(t.bias=this.bias),0!==this.normalBias&&(t.normalBias=this.normalBias),1!==this.radius&&(t.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(t.mapSize=this.mapSize.toArray()),t.camera=this.camera.toJSON(!1).object,delete t.camera.matrix,t}}),vc.prototype=Object.assign(Object.create(yc.prototype),{constructor:vc,isSpotLightShadow:!0,updateMatrices:function(t){const e=this.camera,i=2*ei.RAD2DEG*t.angle*this.focus,s=this.mapSize.width/this.mapSize.height,n=t.distance||e.far;i===e.fov&&s===e.aspect&&n===e.far||(e.fov=i,e.aspect=s,e.far=n,e.updateProjectionMatrix()),yc.prototype.updateMatrices.call(this,t)}}),wc.prototype=Object.assign(Object.create(fc.prototype),{constructor:wc,isSpotLight:!0,copy:function(t){return fc.prototype.copy.call(this,t),this.distance=t.distance,this.angle=t.angle,this.penumbra=t.penumbra,this.decay=t.decay,this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}),xc.prototype=Object.assign(Object.create(yc.prototype),{constructor:xc,isPointLightShadow:!0,updateMatrices:function(t,e=0){const i=this.camera,s=this.matrix,n=this._lightPositionWorld,o=this._lookTarget,r=this._projScreenMatrix;n.setFromMatrixPosition(t.matrixWorld),i.position.copy(n),o.copy(i.position),o.add(this._cubeDirections[e]),i.up.copy(this._cubeUps[e]),i.lookAt(o),i.updateMatrixWorld(),s.makeTranslation(-n.x,-n.y,-n.z),r.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),this._frustum.setFromProjectionMatrix(r)}}),bc.prototype=Object.assign(Object.create(fc.prototype),{constructor:bc,isPointLight:!0,copy:function(t){return fc.prototype.copy.call(this,t),this.distance=t.distance,this.decay=t.decay,this.shadow=t.shadow.clone(),this}}),Sc.prototype=Object.assign(Object.create(On.prototype),{constructor:Sc,isOrthographicCamera:!0,copy:function(t,e){return On.prototype.copy.call(this,t,e),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.near=t.near,this.far=t.far,this.zoom=t.zoom,this.view=null===t.view?null:Object.assign({},t.view),this},setViewOffset:function(t,e,i,s,n,o){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=s,this.view.width=n,this.view.height=o,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){const t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,s=(this.top+this.bottom)/2;let n=i-t,o=i+t,r=s+e,a=s-e;if(null!==this.view&&this.view.enabled){const t=(this.right-this.left)/this.view.fullWidth/this.zoom,e=(this.top-this.bottom)/this.view.fullHeight/this.zoom;n+=t*this.view.offsetX,o=n+t*this.view.width,r-=e*this.view.offsetY,a=r-e*this.view.height}this.projectionMatrix.makeOrthographic(n,o,r,a,this.near,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()},toJSON:function(t){const e=us.prototype.toJSON.call(this,t);return e.object.zoom=this.zoom,e.object.left=this.left,e.object.right=this.right,e.object.top=this.top,e.object.bottom=this.bottom,e.object.near=this.near,e.object.far=this.far,null!==this.view&&(e.object.view=Object.assign({},this.view)),e}}),Mc.prototype=Object.assign(Object.create(yc.prototype),{constructor:Mc,isDirectionalLightShadow:!0,updateMatrices:function(t){yc.prototype.updateMatrices.call(this,t)}}),Tc.prototype=Object.assign(Object.create(fc.prototype),{constructor:Tc,isDirectionalLight:!0,copy:function(t){return fc.prototype.copy.call(this,t),this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}),_c.prototype=Object.assign(Object.create(fc.prototype),{constructor:_c,isAmbientLight:!0}),Ec.prototype=Object.assign(Object.create(fc.prototype),{constructor:Ec,isRectAreaLight:!0,copy:function(t){return fc.prototype.copy.call(this,t),this.width=t.width,this.height=t.height,this},toJSON:function(t){const e=fc.prototype.toJSON.call(this,t);return e.object.width=this.width,e.object.height=this.height,e}});class Lc{constructor(){Object.defineProperty(this,"isSphericalHarmonics3",{value:!0}),this.coefficients=[];for(let t=0;t<9;t++)this.coefficients.push(new pi)}set(t){for(let e=0;e<9;e++)this.coefficients[e].copy(t[e]);return this}zero(){for(let t=0;t<9;t++)this.coefficients[t].set(0,0,0);return this}getAt(t,e){const i=t.x,s=t.y,n=t.z,o=this.coefficients;return e.copy(o[0]).multiplyScalar(.282095),e.addScaledVector(o[1],.488603*s),e.addScaledVector(o[2],.488603*n),e.addScaledVector(o[3],.488603*i),e.addScaledVector(o[4],i*s*1.092548),e.addScaledVector(o[5],s*n*1.092548),e.addScaledVector(o[6],.315392*(3*n*n-1)),e.addScaledVector(o[7],i*n*1.092548),e.addScaledVector(o[8],.546274*(i*i-s*s)),e}getIrradianceAt(t,e){const i=t.x,s=t.y,n=t.z,o=this.coefficients;return e.copy(o[0]).multiplyScalar(.886227),e.addScaledVector(o[1],1.023328*s),e.addScaledVector(o[2],1.023328*n),e.addScaledVector(o[3],1.023328*i),e.addScaledVector(o[4],.858086*i*s),e.addScaledVector(o[5],.858086*s*n),e.addScaledVector(o[6],.743125*n*n-.247708),e.addScaledVector(o[7],.858086*i*n),e.addScaledVector(o[8],.429043*(i*i-s*s)),e}add(t){for(let e=0;e<9;e++)this.coefficients[e].add(t.coefficients[e]);return this}addScaledSH(t,e){for(let i=0;i<9;i++)this.coefficients[i].addScaledVector(t.coefficients[i],e);return this}scale(t){for(let e=0;e<9;e++)this.coefficients[e].multiplyScalar(t);return this}lerp(t,e){for(let i=0;i<9;i++)this.coefficients[i].lerp(t.coefficients[i],e);return this}equals(t){for(let e=0;e<9;e++)if(!this.coefficients[e].equals(t.coefficients[e]))return!1;return!0}copy(t){return this.set(t.coefficients)}clone(){return(new this.constructor).copy(this)}fromArray(t,e=0){const i=this.coefficients;for(let s=0;s<9;s++)i[s].fromArray(t,e+3*s);return this}toArray(t=[],e=0){const i=this.coefficients;for(let s=0;s<9;s++)i[s].toArray(t,e+3*s);return t}static getBasisAt(t,e){const i=t.x,s=t.y,n=t.z;e[0]=.282095,e[1]=.488603*s,e[2]=.488603*n,e[3]=.488603*i,e[4]=1.092548*i*s,e[5]=1.092548*s*n,e[6]=.315392*(3*n*n-1),e[7]=1.092548*i*n,e[8]=.546274*(i*i-s*s)}}function Cc(t,e){fc.call(this,void 0,e),this.type="LightProbe",this.sh=void 0!==t?t:new Lc}function Ac(t){zl.call(this,t),this.textures={}}Cc.prototype=Object.assign(Object.create(fc.prototype),{constructor:Cc,isLightProbe:!0,copy:function(t){return fc.prototype.copy.call(this,t),this.sh.copy(t.sh),this},fromJSON:function(t){return this.intensity=t.intensity,this.sh.fromArray(t.sh),this},toJSON:function(t){const e=fc.prototype.toJSON.call(this,t);return e.object.sh=this.sh.toArray(),e}}),Ac.prototype=Object.assign(Object.create(zl.prototype),{constructor:Ac,load:function(t,e,i,s){const n=this,o=new Nl(n.manager);o.setPath(n.path),o.setRequestHeader(n.requestHeader),o.setWithCredentials(n.withCredentials),o.load(t,(function(i){try{e(n.parse(JSON.parse(i)))}catch(e){s?s(e):console.error(e),n.manager.itemError(t)}}),i,s)},parse:function(t){const e=this.textures;function i(t){return void 0===e[t]&&console.warn("THREE.MaterialLoader: Undefined texture",t),e[t]}const s=new vl[t.type];if(void 0!==t.uuid&&(s.uuid=t.uuid),void 0!==t.name&&(s.name=t.name),void 0!==t.color&&void 0!==s.color&&s.color.setHex(t.color),void 0!==t.roughness&&(s.roughness=t.roughness),void 0!==t.metalness&&(s.metalness=t.metalness),void 0!==t.sheen&&(s.sheen=(new Ds).setHex(t.sheen)),void 0!==t.emissive&&void 0!==s.emissive&&s.emissive.setHex(t.emissive),void 0!==t.specular&&void 0!==s.specular&&s.specular.setHex(t.specular),void 0!==t.shininess&&(s.shininess=t.shininess),void 0!==t.clearcoat&&(s.clearcoat=t.clearcoat),void 0!==t.clearcoatRoughness&&(s.clearcoatRoughness=t.clearcoatRoughness),void 0!==t.fog&&(s.fog=t.fog),void 0!==t.flatShading&&(s.flatShading=t.flatShading),void 0!==t.blending&&(s.blending=t.blending),void 0!==t.combine&&(s.combine=t.combine),void 0!==t.side&&(s.side=t.side),void 0!==t.opacity&&(s.opacity=t.opacity),void 0!==t.transparent&&(s.transparent=t.transparent),void 0!==t.alphaTest&&(s.alphaTest=t.alphaTest),void 0!==t.depthTest&&(s.depthTest=t.depthTest),void 0!==t.depthWrite&&(s.depthWrite=t.depthWrite),void 0!==t.colorWrite&&(s.colorWrite=t.colorWrite),void 0!==t.stencilWrite&&(s.stencilWrite=t.stencilWrite),void 0!==t.stencilWriteMask&&(s.stencilWriteMask=t.stencilWriteMask),void 0!==t.stencilFunc&&(s.stencilFunc=t.stencilFunc),void 0!==t.stencilRef&&(s.stencilRef=t.stencilRef),void 0!==t.stencilFuncMask&&(s.stencilFuncMask=t.stencilFuncMask),void 0!==t.stencilFail&&(s.stencilFail=t.stencilFail),void 0!==t.stencilZFail&&(s.stencilZFail=t.stencilZFail),void 0!==t.stencilZPass&&(s.stencilZPass=t.stencilZPass),void 0!==t.wireframe&&(s.wireframe=t.wireframe),void 0!==t.wireframeLinewidth&&(s.wireframeLinewidth=t.wireframeLinewidth),void 0!==t.wireframeLinecap&&(s.wireframeLinecap=t.wireframeLinecap),void 0!==t.wireframeLinejoin&&(s.wireframeLinejoin=t.wireframeLinejoin),void 0!==t.rotation&&(s.rotation=t.rotation),1!==t.linewidth&&(s.linewidth=t.linewidth),void 0!==t.dashSize&&(s.dashSize=t.dashSize),void 0!==t.gapSize&&(s.gapSize=t.gapSize),void 0!==t.scale&&(s.scale=t.scale),void 0!==t.polygonOffset&&(s.polygonOffset=t.polygonOffset),void 0!==t.polygonOffsetFactor&&(s.polygonOffsetFactor=t.polygonOffsetFactor),void 0!==t.polygonOffsetUnits&&(s.polygonOffsetUnits=t.polygonOffsetUnits),void 0!==t.skinning&&(s.skinning=t.skinning),void 0!==t.morphTargets&&(s.morphTargets=t.morphTargets),void 0!==t.morphNormals&&(s.morphNormals=t.morphNormals),void 0!==t.dithering&&(s.dithering=t.dithering),void 0!==t.vertexTangents&&(s.vertexTangents=t.vertexTangents),void 0!==t.visible&&(s.visible=t.visible),void 0!==t.toneMapped&&(s.toneMapped=t.toneMapped),void 0!==t.userData&&(s.userData=t.userData),void 0!==t.vertexColors&&("number"==typeof t.vertexColors?s.vertexColors=t.vertexColors>0:s.vertexColors=t.vertexColors),void 0!==t.uniforms)for(const e in t.uniforms){const n=t.uniforms[e];switch(s.uniforms[e]={},n.type){case"t":s.uniforms[e].value=i(n.value);break;case"c":s.uniforms[e].value=(new Ds).setHex(n.value);break;case"v2":s.uniforms[e].value=(new ii).fromArray(n.value);break;case"v3":s.uniforms[e].value=(new pi).fromArray(n.value);break;case"v4":s.uniforms[e].value=(new li).fromArray(n.value);break;case"m3":s.uniforms[e].value=(new si).fromArray(n.value);break;case"m4":s.uniforms[e].value=(new Hi).fromArray(n.value);break;default:s.uniforms[e].value=n.value}}if(void 0!==t.defines&&(s.defines=t.defines),void 0!==t.vertexShader&&(s.vertexShader=t.vertexShader),void 0!==t.fragmentShader&&(s.fragmentShader=t.fragmentShader),void 0!==t.extensions)for(const e in t.extensions)s.extensions[e]=t.extensions[e];if(void 0!==t.shading&&(s.flatShading=1===t.shading),void 0!==t.size&&(s.size=t.size),void 0!==t.sizeAttenuation&&(s.sizeAttenuation=t.sizeAttenuation),void 0!==t.map&&(s.map=i(t.map)),void 0!==t.matcap&&(s.matcap=i(t.matcap)),void 0!==t.alphaMap&&(s.alphaMap=i(t.alphaMap)),void 0!==t.bumpMap&&(s.bumpMap=i(t.bumpMap)),void 0!==t.bumpScale&&(s.bumpScale=t.bumpScale),void 0!==t.normalMap&&(s.normalMap=i(t.normalMap)),void 0!==t.normalMapType&&(s.normalMapType=t.normalMapType),void 0!==t.normalScale){let e=t.normalScale;!1===Array.isArray(e)&&(e=[e,e]),s.normalScale=(new ii).fromArray(e)}return void 0!==t.displacementMap&&(s.displacementMap=i(t.displacementMap)),void 0!==t.displacementScale&&(s.displacementScale=t.displacementScale),void 0!==t.displacementBias&&(s.displacementBias=t.displacementBias),void 0!==t.roughnessMap&&(s.roughnessMap=i(t.roughnessMap)),void 0!==t.metalnessMap&&(s.metalnessMap=i(t.metalnessMap)),void 0!==t.emissiveMap&&(s.emissiveMap=i(t.emissiveMap)),void 0!==t.emissiveIntensity&&(s.emissiveIntensity=t.emissiveIntensity),void 0!==t.specularMap&&(s.specularMap=i(t.specularMap)),void 0!==t.envMap&&(s.envMap=i(t.envMap)),void 0!==t.envMapIntensity&&(s.envMapIntensity=t.envMapIntensity),void 0!==t.reflectivity&&(s.reflectivity=t.reflectivity),void 0!==t.refractionRatio&&(s.refractionRatio=t.refractionRatio),void 0!==t.lightMap&&(s.lightMap=i(t.lightMap)),void 0!==t.lightMapIntensity&&(s.lightMapIntensity=t.lightMapIntensity),void 0!==t.aoMap&&(s.aoMap=i(t.aoMap)),void 0!==t.aoMapIntensity&&(s.aoMapIntensity=t.aoMapIntensity),void 0!==t.gradientMap&&(s.gradientMap=i(t.gradientMap)),void 0!==t.clearcoatMap&&(s.clearcoatMap=i(t.clearcoatMap)),void 0!==t.clearcoatRoughnessMap&&(s.clearcoatRoughnessMap=i(t.clearcoatRoughnessMap)),void 0!==t.clearcoatNormalMap&&(s.clearcoatNormalMap=i(t.clearcoatNormalMap)),void 0!==t.clearcoatNormalScale&&(s.clearcoatNormalScale=(new ii).fromArray(t.clearcoatNormalScale)),void 0!==t.transmission&&(s.transmission=t.transmission),void 0!==t.transmissionMap&&(s.transmissionMap=i(t.transmissionMap)),s},setTextures:function(t){return this.textures=t,this}});const Pc={decodeText:function(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);let e="";for(let i=0,s=t.length;i<s;i++)e+=String.fromCharCode(t[i]);try{return decodeURIComponent(escape(e))}catch(t){return e}},extractUrlBase:function(t){const e=t.lastIndexOf("/");return-1===e?"./":t.substr(0,e+1)}};function kc(){cn.call(this),this.type="InstancedBufferGeometry",this.instanceCount=1/0}function Bc(t,e,i,s){"number"==typeof i&&(s=i,i=!1,console.error("THREE.InstancedBufferAttribute: The constructor now expects normalized as the third argument.")),Hs.call(this,t,e,i),this.meshPerAttribute=s||1}function Rc(t){zl.call(this,t)}function Dc(t){"undefined"==typeof createImageBitmap&&console.warn("THREE.ImageBitmapLoader: createImageBitmap() not supported."),"undefined"==typeof fetch&&console.warn("THREE.ImageBitmapLoader: fetch() not supported."),zl.call(this,t),this.options={premultiplyAlpha:"none"}}function Ic(){this.type="ShapePath",this.color=new Ds,this.subPaths=[],this.currentPath=null}function Fc(t){this.type="Font",this.data=t}function zc(t,e,i,s,n){const o=n.glyphs[t]||n.glyphs["?"];if(!o)return void console.error('THREE.Font: character "'+t+'" does not exists in font family '+n.familyName+".");const r=new Ic;let a,h,l,c,d,u,p,m;if(o.o){const t=o._cachedOutline||(o._cachedOutline=o.o.split(" "));for(let n=0,o=t.length;n<o;)switch(t[n++]){case"m":a=t[n++]*e+i,h=t[n++]*e+s,r.moveTo(a,h);break;case"l":a=t[n++]*e+i,h=t[n++]*e+s,r.lineTo(a,h);break;case"q":l=t[n++]*e+i,c=t[n++]*e+s,d=t[n++]*e+i,u=t[n++]*e+s,r.quadraticCurveTo(d,u,l,c);break;case"b":l=t[n++]*e+i,c=t[n++]*e+s,d=t[n++]*e+i,u=t[n++]*e+s,p=t[n++]*e+i,m=t[n++]*e+s,r.bezierCurveTo(d,u,p,m,l,c)}}return{offsetX:o.ha*e,path:r}}function Oc(t){zl.call(this,t)}let Nc;kc.prototype=Object.assign(Object.create(cn.prototype),{constructor:kc,isInstancedBufferGeometry:!0,copy:function(t){return cn.prototype.copy.call(this,t),this.instanceCount=t.instanceCount,this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){const t=cn.prototype.toJSON.call(this);return t.instanceCount=this.instanceCount,t.isInstancedBufferGeometry=!0,t}}),Bc.prototype=Object.assign(Object.create(Hs.prototype),{constructor:Bc,isInstancedBufferAttribute:!0,copy:function(t){return Hs.prototype.copy.call(this,t),this.meshPerAttribute=t.meshPerAttribute,this},toJSON:function(){const t=Hs.prototype.toJSON.call(this);return t.meshPerAttribute=this.meshPerAttribute,t.isInstancedBufferAttribute=!0,t}}),Rc.prototype=Object.assign(Object.create(zl.prototype),{constructor:Rc,load:function(t,e,i,s){const n=this,o=new Nl(n.manager);o.setPath(n.path),o.setRequestHeader(n.requestHeader),o.setWithCredentials(n.withCredentials),o.load(t,(function(i){try{e(n.parse(JSON.parse(i)))}catch(e){s?s(e):console.error(e),n.manager.itemError(t)}}),i,s)},parse:function(t){const e={},i={};function s(t,s){if(void 0!==e[s])return e[s];const n=t.interleavedBuffers[s],o=function(t,e){if(void 0!==i[e])return i[e];const s=t.arrayBuffers[e],n=new Uint32Array(s).buffer;return i[e]=n,n}(t,n.buffer),r=new ra(en(n.type,o),n.stride);return r.uuid=n.uuid,e[s]=r,r}const n=t.isInstancedBufferGeometry?new kc:new cn,o=t.data.index;if(void 0!==o){const t=en(o.type,o.array);n.setIndex(new Hs(t,1))}const r=t.data.attributes;for(const e in r){const i=r[e];let o;if(i.isInterleavedBufferAttribute)o=new ha(s(t.data,i.data),i.itemSize,i.offset,i.normalized);else{const t=en(i.type,i.array);o=new(i.isInstancedBufferAttribute?Bc:Hs)(t,i.itemSize,i.normalized)}void 0!==i.name&&(o.name=i.name),n.setAttribute(e,o)}const a=t.data.morphAttributes;if(a)for(const e in a){const i=a[e],o=[];for(let e=0,n=i.length;e<n;e++){const n=i[e];let r;r=n.isInterleavedBufferAttribute?new ha(s(t.data,n.data),n.itemSize,n.offset,n.normalized):new Hs(en(n.type,n.array),n.itemSize,n.normalized),void 0!==n.name&&(r.name=n.name),o.push(r)}n.morphAttributes[e]=o}t.data.morphTargetsRelative&&(n.morphTargetsRelative=!0);const h=t.data.groups||t.data.drawcalls||t.data.offsets;if(void 0!==h)for(let t=0,e=h.length;t!==e;++t){const e=h[t];n.addGroup(e.start,e.count,e.materialIndex)}const l=t.data.boundingSphere;if(void 0!==l){const t=new pi;void 0!==l.center&&t.fromArray(l.center),n.boundingSphere=new Bi(t,l.radius)}return t.name&&(n.name=t.name),t.userData&&(n.userData=t.userData),n}}),Dc.prototype=Object.assign(Object.create(zl.prototype),{constructor:Dc,isImageBitmapLoader:!0,setOptions:function(t){return this.options=t,this},load:function(t,e,i,s){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const n=this,o=Dl.get(t);if(void 0!==o)return n.manager.itemStart(t),setTimeout((function(){e&&e(o),n.manager.itemEnd(t)}),0),o;const r={};r.credentials="anonymous"===this.crossOrigin?"same-origin":"include",fetch(t,r).then((function(t){return t.blob()})).then((function(t){return createImageBitmap(t,n.options)})).then((function(i){Dl.add(t,i),e&&e(i),n.manager.itemEnd(t)})).catch((function(e){s&&s(e),n.manager.itemError(t),n.manager.itemEnd(t)})),n.manager.itemStart(t)}}),Object.assign(Ic.prototype,{moveTo:function(t,e){return this.currentPath=new pc,this.subPaths.push(this.currentPath),this.currentPath.moveTo(t,e),this},lineTo:function(t,e){return this.currentPath.lineTo(t,e),this},quadraticCurveTo:function(t,e,i,s){return this.currentPath.quadraticCurveTo(t,e,i,s),this},bezierCurveTo:function(t,e,i,s,n,o){return this.currentPath.bezierCurveTo(t,e,i,s,n,o),this},splineThru:function(t){return this.currentPath.splineThru(t),this},toShapes:function(t,e){function i(t){const e=[];for(let i=0,s=t.length;i<s;i++){const s=t[i],n=new mc;n.curves=s.curves,e.push(n)}return e}function s(t,e){const i=e.length;let s=!1;for(let n=i-1,o=0;o<i;n=o++){let i=e[n],r=e[o],a=r.x-i.x,h=r.y-i.y;if(Math.abs(h)>Number.EPSILON){if(h<0&&(i=e[o],a=-a,r=e[n],h=-h),t.y<i.y||t.y>r.y)continue;if(t.y===i.y){if(t.x===i.x)return!0}else{const e=h*(t.x-i.x)-a*(t.y-i.y);if(0===e)return!0;if(e<0)continue;s=!s}}else{if(t.y!==i.y)continue;if(r.x<=t.x&&t.x<=i.x||i.x<=t.x&&t.x<=r.x)return!0}}return s}const n=qh.isClockWise,o=this.subPaths;if(0===o.length)return[];if(!0===e)return i(o);let r,a,h;const l=[];if(1===o.length)return a=o[0],h=new mc,h.curves=a.curves,l.push(h),l;let c=!n(o[0].getPoints());c=t?!c:c;const d=[],u=[];let p,m,f=[],g=0;u[g]=void 0,f[g]=[];for(let e=0,i=o.length;e<i;e++)a=o[e],p=a.getPoints(),r=n(p),r=t?!r:r,r?(!c&&u[g]&&g++,u[g]={s:new mc,p},u[g].s.curves=a.curves,c&&g++,f[g]=[]):f[g].push({h:a,p:p[0]});if(!u[0])return i(o);if(u.length>1){let t=!1;const e=[];for(let t=0,e=u.length;t<e;t++)d[t]=[];for(let i=0,n=u.length;i<n;i++){const n=f[i];for(let o=0;o<n.length;o++){const r=n[o];let a=!0;for(let n=0;n<u.length;n++)s(r.p,u[n].p)&&(i!==n&&e.push({froms:i,tos:n,hole:o}),a?(a=!1,d[n].push(r)):t=!0);a&&d[i].push(r)}}e.length>0&&(t||(f=d))}for(let t=0,e=u.length;t<e;t++){h=u[t].s,l.push(h),m=f[t];for(let t=0,e=m.length;t<e;t++)h.holes.push(m[t].h)}return l}}),Object.assign(Fc.prototype,{isFont:!0,generateShapes:function(t,e=100){const i=[],s=function(t,e,i){const s=Array.from?Array.from(t):String(t).split(""),n=e/i.resolution,o=(i.boundingBox.yMax-i.boundingBox.yMin+i.underlineThickness)*n,r=[];let a=0,h=0;for(let t=0;t<s.length;t++){const e=s[t];if("\n"===e)a=0,h-=o;else{const t=zc(e,n,a,h,i);a+=t.offsetX,r.push(t.path)}}return r}(t,e,this.data);for(let t=0,e=s.length;t<e;t++)Array.prototype.push.apply(i,s[t].toShapes());return i}}),Oc.prototype=Object.assign(Object.create(zl.prototype),{constructor:Oc,load:function(t,e,i,s){const n=this,o=new Nl(this.manager);o.setPath(this.path),o.setRequestHeader(this.requestHeader),o.setWithCredentials(n.withCredentials),o.load(t,(function(t){let i;try{i=JSON.parse(t)}catch(e){console.warn("THREE.FontLoader: typeface.js support is being deprecated. Use typeface.json instead."),i=JSON.parse(t.substring(65,t.length-2))}const s=n.parse(i);e&&e(s)}),i,s)},parse:function(t){return new Fc(t)}});const Wc=function(){return void 0===Nc&&(Nc=new(window.AudioContext||window.webkitAudioContext)),Nc};function Hc(t){zl.call(this,t)}function Uc(t,e,i){Cc.call(this,void 0,i);const s=(new Ds).set(t),n=(new Ds).set(e),o=new pi(s.r,s.g,s.b),r=new pi(n.r,n.g,n.b),a=Math.sqrt(Math.PI),h=a*Math.sqrt(.75);this.sh.coefficients[0].copy(o).add(r).multiplyScalar(a),this.sh.coefficients[1].copy(o).sub(r).multiplyScalar(h)}function Vc(t,e){Cc.call(this,void 0,e);const i=(new Ds).set(t);this.sh.coefficients[0].set(i.r,i.g,i.b).multiplyScalar(2*Math.sqrt(Math.PI))}Hc.prototype=Object.assign(Object.create(zl.prototype),{constructor:Hc,load:function(t,e,i,s){const n=this,o=new Nl(n.manager);o.setResponseType("arraybuffer"),o.setPath(n.path),o.setRequestHeader(n.requestHeader),o.setWithCredentials(n.withCredentials),o.load(t,(function(i){try{const t=i.slice(0);Wc().decodeAudioData(t,(function(t){e(t)}))}catch(e){s?s(e):console.error(e),n.manager.itemError(t)}}),i,s)}}),Uc.prototype=Object.assign(Object.create(Cc.prototype),{constructor:Uc,isHemisphereLightProbe:!0,copy:function(t){return Cc.prototype.copy.call(this,t),this},toJSON:function(t){return Cc.prototype.toJSON.call(this,t)}}),Vc.prototype=Object.assign(Object.create(Cc.prototype),{constructor:Vc,isAmbientLightProbe:!0,copy:function(t){return Cc.prototype.copy.call(this,t),this},toJSON:function(t){return Cc.prototype.toJSON.call(this,t)}});const Gc=new Hi,jc=new Hi;Object.assign(function(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new Nn,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new Nn,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1,this._cache={focus:null,fov:null,aspect:null,near:null,far:null,zoom:null,eyeSep:null}}.prototype,{update:function(t){const e=this._cache;if(e.focus!==t.focus||e.fov!==t.fov||e.aspect!==t.aspect*this.aspect||e.near!==t.near||e.far!==t.far||e.zoom!==t.zoom||e.eyeSep!==this.eyeSep){e.focus=t.focus,e.fov=t.fov,e.aspect=t.aspect*this.aspect,e.near=t.near,e.far=t.far,e.zoom=t.zoom,e.eyeSep=this.eyeSep;const i=t.projectionMatrix.clone(),s=e.eyeSep/2,n=s*e.near/e.focus,o=e.near*Math.tan(ei.DEG2RAD*e.fov*.5)/e.zoom;let r,a;jc.elements[12]=-s,Gc.elements[12]=s,r=-o*e.aspect+n,a=o*e.aspect+n,i.elements[0]=2*e.near/(a-r),i.elements[8]=(a+r)/(a-r),this.cameraL.projectionMatrix.copy(i),r=-o*e.aspect-n,a=o*e.aspect-n,i.elements[0]=2*e.near/(a-r),i.elements[8]=(a+r)/(a-r),this.cameraR.projectionMatrix.copy(i)}this.cameraL.matrixWorld.copy(t.matrixWorld).multiply(jc),this.cameraR.matrixWorld.copy(t.matrixWorld).multiply(Gc)}});class qc{constructor(t){this.autoStart=void 0===t||t,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=$c(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let t=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const e=$c();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}return t}}function $c(){return("undefined"==typeof performance?Date:performance).now()}const Xc=new pi,Yc=new ui,Zc=new pi,Kc=new pi;class Jc extends us{constructor(){super(),this.type="AudioListener",this.context=Wc(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null,this.timeDelta=0,this._clock=new qc}getInput(){return this.gain}removeFilter(){return null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null),this}getFilter(){return this.filter}setFilter(t){return null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=t,this.gain.connect(this.filter),this.filter.connect(this.context.destination),this}getMasterVolume(){return this.gain.gain.value}setMasterVolume(t){return this.gain.gain.setTargetAtTime(t,this.context.currentTime,.01),this}updateMatrixWorld(t){super.updateMatrixWorld(t);const e=this.context.listener,i=this.up;if(this.timeDelta=this._clock.getDelta(),this.matrixWorld.decompose(Xc,Yc,Zc),Kc.set(0,0,-1).applyQuaternion(Yc),e.positionX){const t=this.context.currentTime+this.timeDelta;e.positionX.linearRampToValueAtTime(Xc.x,t),e.positionY.linearRampToValueAtTime(Xc.y,t),e.positionZ.linearRampToValueAtTime(Xc.z,t),e.forwardX.linearRampToValueAtTime(Kc.x,t),e.forwardY.linearRampToValueAtTime(Kc.y,t),e.forwardZ.linearRampToValueAtTime(Kc.z,t),e.upX.linearRampToValueAtTime(i.x,t),e.upY.linearRampToValueAtTime(i.y,t),e.upZ.linearRampToValueAtTime(i.z,t)}else e.setPosition(Xc.x,Xc.y,Xc.z),e.setOrientation(Kc.x,Kc.y,Kc.z,i.x,i.y,i.z)}}class Qc extends us{constructor(t){super(),this.type="Audio",this.listener=t,this.context=t.context,this.gain=this.context.createGain(),this.gain.connect(t.getInput()),this.autoplay=!1,this.buffer=null,this.detune=0,this.loop=!1,this.loopStart=0,this.loopEnd=0,this.offset=0,this.duration=void 0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.source=null,this.sourceType="empty",this._startedAt=0,this._progress=0,this._connected=!1,this.filters=[]}getOutput(){return this.gain}setNodeSource(t){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=t,this.connect(),this}setMediaElementSource(t){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(t),this.connect(),this}setMediaStreamSource(t){return this.hasPlaybackControl=!1,this.sourceType="mediaStreamNode",this.source=this.context.createMediaStreamSource(t),this.connect(),this}setBuffer(t){return this.buffer=t,this.sourceType="buffer",this.autoplay&&this.play(),this}play(t=0){if(!0===this.isPlaying)return void console.warn("THREE.Audio: Audio is already playing.");if(!1===this.hasPlaybackControl)return void console.warn("THREE.Audio: this Audio has no playback control.");this._startedAt=this.context.currentTime+t;const e=this.context.createBufferSource();return e.buffer=this.buffer,e.loop=this.loop,e.loopStart=this.loopStart,e.loopEnd=this.loopEnd,e.onended=this.onEnded.bind(this),e.start(this._startedAt,this._progress+this.offset,this.duration),this.isPlaying=!0,this.source=e,this.setDetune(this.detune),this.setPlaybackRate(this.playbackRate),this.connect()}pause(){if(!1!==this.hasPlaybackControl)return!0===this.isPlaying&&(this._progress+=Math.max(this.context.currentTime-this._startedAt,0)*this.playbackRate,!0===this.loop&&(this._progress=this._progress%(this.duration||this.buffer.duration)),this.source.stop(),this.source.onended=null,this.isPlaying=!1),this;console.warn("THREE.Audio: this Audio has no playback control.")}stop(){if(!1!==this.hasPlaybackControl)return this._progress=0,this.source.stop(),this.source.onended=null,this.isPlaying=!1,this;console.warn("THREE.Audio: this Audio has no playback control.")}connect(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(let t=1,e=this.filters.length;t<e;t++)this.filters[t-1].connect(this.filters[t]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this._connected=!0,this}disconnect(){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(let t=1,e=this.filters.length;t<e;t++)this.filters[t-1].disconnect(this.filters[t]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this._connected=!1,this}getFilters(){return this.filters}setFilters(t){return t||(t=[]),!0===this._connected?(this.disconnect(),this.filters=t.slice(),this.connect()):this.filters=t.slice(),this}setDetune(t){if(this.detune=t,void 0!==this.source.detune)return!0===this.isPlaying&&this.source.detune.setTargetAtTime(this.detune,this.context.currentTime,.01),this}getDetune(){return this.detune}getFilter(){return this.getFilters()[0]}setFilter(t){return this.setFilters(t?[t]:[])}setPlaybackRate(t){if(!1!==this.hasPlaybackControl)return this.playbackRate=t,!0===this.isPlaying&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01),this;console.warn("THREE.Audio: this Audio has no playback control.")}getPlaybackRate(){return this.playbackRate}onEnded(){this.isPlaying=!1}getLoop(){return!1===this.hasPlaybackControl?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.loop}setLoop(t){if(!1!==this.hasPlaybackControl)return this.loop=t,!0===this.isPlaying&&(this.source.loop=this.loop),this;console.warn("THREE.Audio: this Audio has no playback control.")}setLoopStart(t){return this.loopStart=t,this}setLoopEnd(t){return this.loopEnd=t,this}getVolume(){return this.gain.gain.value}setVolume(t){return this.gain.gain.setTargetAtTime(t,this.context.currentTime,.01),this}}function td(t,e,i){let s,n,o;switch(this.binding=t,this.valueSize=i,e){case"quaternion":s=this._slerp,n=this._slerpAdditive,o=this._setAdditiveIdentityQuaternion,this.buffer=new Float64Array(6*i),this._workIndex=5;break;case"string":case"bool":s=this._select,n=this._select,o=this._setAdditiveIdentityOther,this.buffer=new Array(5*i);break;default:s=this._lerp,n=this._lerpAdditive,o=this._setAdditiveIdentityNumeric,this.buffer=new Float64Array(5*i)}this._mixBufferRegion=s,this._mixBufferRegionAdditive=n,this._setIdentity=o,this._origIndex=3,this._addIndex=4,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,this.useCount=0,this.referenceCount=0}Object.assign(td.prototype,{accumulate:function(t,e){const i=this.buffer,s=this.valueSize,n=t*s+s;let o=this.cumulativeWeight;if(0===o){for(let t=0;t!==s;++t)i[n+t]=i[t];o=e}else{o+=e;const t=e/o;this._mixBufferRegion(i,n,0,t,s)}this.cumulativeWeight=o},accumulateAdditive:function(t){const e=this.buffer,i=this.valueSize,s=i*this._addIndex;0===this.cumulativeWeightAdditive&&this._setIdentity(),this._mixBufferRegionAdditive(e,s,0,t,i),this.cumulativeWeightAdditive+=t},apply:function(t){const e=this.valueSize,i=this.buffer,s=t*e+e,n=this.cumulativeWeight,o=this.cumulativeWeightAdditive,r=this.binding;if(this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,n<1){const t=e*this._origIndex;this._mixBufferRegion(i,s,t,1-n,e)}o>0&&this._mixBufferRegionAdditive(i,s,this._addIndex*e,1,e);for(let t=e,n=e+e;t!==n;++t)if(i[t]!==i[t+e]){r.setValue(i,s);break}},saveOriginalState:function(){const t=this.binding,e=this.buffer,i=this.valueSize,s=i*this._origIndex;t.getValue(e,s);for(let t=i,n=s;t!==n;++t)e[t]=e[s+t%i];this._setIdentity(),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0},restoreOriginalState:function(){const t=3*this.valueSize;this.binding.setValue(this.buffer,t)},_setAdditiveIdentityNumeric:function(){const t=this._addIndex*this.valueSize,e=t+this.valueSize;for(let i=t;i<e;i++)this.buffer[i]=0},_setAdditiveIdentityQuaternion:function(){this._setAdditiveIdentityNumeric(),this.buffer[this._addIndex*this.valueSize+3]=1},_setAdditiveIdentityOther:function(){const t=this._origIndex*this.valueSize,e=this._addIndex*this.valueSize;for(let i=0;i<this.valueSize;i++)this.buffer[e+i]=this.buffer[t+i]},_select:function(t,e,i,s,n){if(s>=.5)for(let s=0;s!==n;++s)t[e+s]=t[i+s]},_slerp:function(t,e,i,s){ui.slerpFlat(t,e,t,e,t,i,s)},_slerpAdditive:function(t,e,i,s,n){const o=this._workIndex*n;ui.multiplyQuaternionsFlat(t,o,t,e,t,i),ui.slerpFlat(t,e,t,e,t,o,s)},_lerp:function(t,e,i,s,n){const o=1-s;for(let r=0;r!==n;++r){const n=e+r;t[n]=t[n]*o+t[i+r]*s}},_lerpAdditive:function(t,e,i,s,n){for(let o=0;o!==n;++o){const n=e+o;t[n]=t[n]+t[i+o]*s}}});const ed="\\[\\]\\.:\\/",id=new RegExp("["+ed+"]","g"),sd="[^"+ed+"]",nd="[^"+ed.replace("\\.","")+"]",od=/((?:WC+[\/:])*)/.source.replace("WC",sd),rd=/(WCOD+)?/.source.replace("WCOD",nd),ad=/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",sd),hd=/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",sd),ld=new RegExp("^"+od+rd+ad+hd+"$"),cd=["material","materials","bones"];function dd(t,e,i){const s=i||ud.parseTrackName(e);this._targetGroup=t,this._bindings=t.subscribe_(e,s)}function ud(t,e,i){this.path=e,this.parsedPath=i||ud.parseTrackName(e),this.node=ud.findNode(t,this.parsedPath.nodeName)||t,this.rootNode=t}Object.assign(dd.prototype,{getValue:function(t,e){this.bind();const i=this._targetGroup.nCachedObjects_,s=this._bindings[i];void 0!==s&&s.getValue(t,e)},setValue:function(t,e){const i=this._bindings;for(let s=this._targetGroup.nCachedObjects_,n=i.length;s!==n;++s)i[s].setValue(t,e)},bind:function(){const t=this._bindings;for(let e=this._targetGroup.nCachedObjects_,i=t.length;e!==i;++e)t[e].bind()},unbind:function(){const t=this._bindings;for(let e=this._targetGroup.nCachedObjects_,i=t.length;e!==i;++e)t[e].unbind()}}),Object.assign(ud,{Composite:dd,create:function(t,e,i){return t&&t.isAnimationObjectGroup?new ud.Composite(t,e,i):new ud(t,e,i)},sanitizeNodeName:function(t){return t.replace(/\s/g,"_").replace(id,"")},parseTrackName:function(t){const e=ld.exec(t);if(!e)throw new Error("PropertyBinding: Cannot parse trackName: "+t);const i={nodeName:e[2],objectName:e[3],objectIndex:e[4],propertyName:e[5],propertyIndex:e[6]},s=i.nodeName&&i.nodeName.lastIndexOf(".");if(void 0!==s&&-1!==s){const t=i.nodeName.substring(s+1);-1!==cd.indexOf(t)&&(i.nodeName=i.nodeName.substring(0,s),i.objectName=t)}if(null===i.propertyName||0===i.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+t);return i},findNode:function(t,e){if(!e||""===e||"."===e||-1===e||e===t.name||e===t.uuid)return t;if(t.skeleton){const i=t.skeleton.getBoneByName(e);if(void 0!==i)return i}if(t.children){const i=function(t){for(let s=0;s<t.length;s++){const n=t[s];if(n.name===e||n.uuid===e)return n;const o=i(n.children);if(o)return o}return null},s=i(t.children);if(s)return s}return null}}),Object.assign(ud.prototype,{_getValue_unavailable:function(){},_setValue_unavailable:function(){},BindingType:{Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Versioning:{None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},GetterByBindingType:[function(t,e){t[e]=this.node[this.propertyName]},function(t,e){const i=this.resolvedProperty;for(let s=0,n=i.length;s!==n;++s)t[e++]=i[s]},function(t,e){t[e]=this.resolvedProperty[this.propertyIndex]},function(t,e){this.resolvedProperty.toArray(t,e)}],SetterByBindingTypeAndVersioning:[[function(t,e){this.targetObject[this.propertyName]=t[e]},function(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.needsUpdate=!0},function(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(t,e){const i=this.resolvedProperty;for(let s=0,n=i.length;s!==n;++s)i[s]=t[e++]},function(t,e){const i=this.resolvedProperty;for(let s=0,n=i.length;s!==n;++s)i[s]=t[e++];this.targetObject.needsUpdate=!0},function(t,e){const i=this.resolvedProperty;for(let s=0,n=i.length;s!==n;++s)i[s]=t[e++];this.targetObject.matrixWorldNeedsUpdate=!0}],[function(t,e){this.resolvedProperty[this.propertyIndex]=t[e]},function(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.needsUpdate=!0},function(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(t,e){this.resolvedProperty.fromArray(t,e)},function(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.needsUpdate=!0},function(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.matrixWorldNeedsUpdate=!0}]],getValue:function(t,e){this.bind(),this.getValue(t,e)},setValue:function(t,e){this.bind(),this.setValue(t,e)},bind:function(){let t=this.node;const e=this.parsedPath,i=e.objectName,s=e.propertyName;let n=e.propertyIndex;if(t||(t=ud.findNode(this.rootNode,e.nodeName)||this.rootNode,this.node=t),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!t)return void console.error("THREE.PropertyBinding: Trying to update node for track: "+this.path+" but it wasn't found.");if(i){let s=e.objectIndex;switch(i){case"materials":if(!t.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!t.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);t=t.material.materials;break;case"bones":if(!t.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);t=t.skeleton.bones;for(let e=0;e<t.length;e++)if(t[e].name===s){s=e;break}break;default:if(void 0===t[i])return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);t=t[i]}if(void 0!==s){if(void 0===t[s])return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,t);t=t[s]}}const o=t[s];if(void 0===o){const i=e.nodeName;return void console.error("THREE.PropertyBinding: Trying to update property for track: "+i+"."+s+" but it wasn't found.",t)}let r=this.Versioning.None;this.targetObject=t,void 0!==t.needsUpdate?r=this.Versioning.NeedsUpdate:void 0!==t.matrixWorldNeedsUpdate&&(r=this.Versioning.MatrixWorldNeedsUpdate);let a=this.BindingType.Direct;if(void 0!==n){if("morphTargetInfluences"===s){if(!t.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!t.geometry.isBufferGeometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences on THREE.Geometry. Use THREE.BufferGeometry instead.",this);if(!t.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);void 0!==t.morphTargetDictionary[n]&&(n=t.morphTargetDictionary[n])}a=this.BindingType.ArrayElement,this.resolvedProperty=o,this.propertyIndex=n}else void 0!==o.fromArray&&void 0!==o.toArray?(a=this.BindingType.HasFromToArray,this.resolvedProperty=o):Array.isArray(o)?(a=this.BindingType.EntireArray,this.resolvedProperty=o):this.propertyName=s;this.getValue=this.GetterByBindingType[a],this.setValue=this.SetterByBindingTypeAndVersioning[a][r]},unbind:function(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}),Object.assign(ud.prototype,{_getValue_unbound:ud.prototype.getValue,_setValue_unbound:ud.prototype.setValue}),Object.assign(function(){this.uuid=ei.generateUUID(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;const t={};this._indicesByUUID=t;for(let e=0,i=arguments.length;e!==i;++e)t[arguments[e].uuid]=e;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};const e=this;this.stats={objects:{get total(){return e._objects.length},get inUse(){return this.total-e.nCachedObjects_}},get bindingsPerObject(){return e._bindings.length}}}.prototype,{isAnimationObjectGroup:!0,add:function(){const t=this._objects,e=this._indicesByUUID,i=this._paths,s=this._parsedPaths,n=this._bindings,o=n.length;let r,a=t.length,h=this.nCachedObjects_;for(let l=0,c=arguments.length;l!==c;++l){const c=arguments[l],d=c.uuid;let u=e[d];if(void 0===u){u=a++,e[d]=u,t.push(c);for(let t=0,e=o;t!==e;++t)n[t].push(new ud(c,i[t],s[t]))}else if(u<h){r=t[u];const a=--h,l=t[a];e[l.uuid]=u,t[u]=l,e[d]=a,t[a]=c;for(let t=0,e=o;t!==e;++t){const e=n[t],o=e[a];let r=e[u];e[u]=o,void 0===r&&(r=new ud(c,i[t],s[t])),e[a]=r}}else t[u]!==r&&console.error("THREE.AnimationObjectGroup: Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes.")}this.nCachedObjects_=h},remove:function(){const t=this._objects,e=this._indicesByUUID,i=this._bindings,s=i.length;let n=this.nCachedObjects_;for(let o=0,r=arguments.length;o!==r;++o){const r=arguments[o],a=r.uuid,h=e[a];if(void 0!==h&&h>=n){const o=n++,l=t[o];e[l.uuid]=h,t[h]=l,e[a]=o,t[o]=r;for(let t=0,e=s;t!==e;++t){const e=i[t],s=e[o],n=e[h];e[h]=s,e[o]=n}}}this.nCachedObjects_=n},uncache:function(){const t=this._objects,e=this._indicesByUUID,i=this._bindings,s=i.length;let n=this.nCachedObjects_,o=t.length;for(let r=0,a=arguments.length;r!==a;++r){const a=arguments[r].uuid,h=e[a];if(void 0!==h)if(delete e[a],h<n){const r=--n,a=t[r],l=--o,c=t[l];e[a.uuid]=h,t[h]=a,e[c.uuid]=r,t[r]=c,t.pop();for(let t=0,e=s;t!==e;++t){const e=i[t],s=e[r],n=e[l];e[h]=s,e[r]=n,e.pop()}}else{const n=--o,r=t[n];n>0&&(e[r.uuid]=h),t[h]=r,t.pop();for(let t=0,e=s;t!==e;++t){const e=i[t];e[h]=e[n],e.pop()}}}this.nCachedObjects_=n},subscribe_:function(t,e){const i=this._bindingsIndicesByPath;let s=i[t];const n=this._bindings;if(void 0!==s)return n[s];const o=this._paths,r=this._parsedPaths,a=this._objects,h=a.length,l=this.nCachedObjects_,c=new Array(h);s=n.length,i[t]=s,o.push(t),r.push(e),n.push(c);for(let i=l,s=a.length;i!==s;++i){const s=a[i];c[i]=new ud(s,t,e)}return c},unsubscribe_:function(t){const e=this._bindingsIndicesByPath,i=e[t];if(void 0!==i){const s=this._paths,n=this._parsedPaths,o=this._bindings,r=o.length-1,a=o[r];e[t[r]]=i,o[i]=a,o.pop(),n[i]=n[r],n.pop(),s[i]=s[r],s.pop()}}});class pd{constructor(t,e,i=null,s=e.blendMode){this._mixer=t,this._clip=e,this._localRoot=i,this.blendMode=s;const n=e.tracks,o=n.length,r=new Array(o),a={endingStart:Ae,endingEnd:Ae};for(let t=0;t!==o;++t){const e=n[t].createInterpolant(null);r[t]=e,e.settings=a}this._interpolantSettings=a,this._interpolants=r,this._propertyBindings=new Array(o),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=_e,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}play(){return this._mixer._activateAction(this),this}stop(){return this._mixer._deactivateAction(this),this.reset()}reset(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()}isRunning(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)}isScheduled(){return this._mixer._isActiveAction(this)}startAt(t){return this._startTime=t,this}setLoop(t,e){return this.loop=t,this.repetitions=e,this}setEffectiveWeight(t){return this.weight=t,this._effectiveWeight=this.enabled?t:0,this.stopFading()}getEffectiveWeight(){return this._effectiveWeight}fadeIn(t){return this._scheduleFading(t,0,1)}fadeOut(t){return this._scheduleFading(t,1,0)}crossFadeFrom(t,e,i){if(t.fadeOut(e),this.fadeIn(e),i){const i=this._clip.duration,s=t._clip.duration,n=s/i,o=i/s;t.warp(1,n,e),this.warp(o,1,e)}return this}crossFadeTo(t,e,i){return t.crossFadeFrom(this,e,i)}stopFading(){const t=this._weightInterpolant;return null!==t&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(t)),this}setEffectiveTimeScale(t){return this.timeScale=t,this._effectiveTimeScale=this.paused?0:t,this.stopWarping()}getEffectiveTimeScale(){return this._effectiveTimeScale}setDuration(t){return this.timeScale=this._clip.duration/t,this.stopWarping()}syncWith(t){return this.time=t.time,this.timeScale=t.timeScale,this.stopWarping()}halt(t){return this.warp(this._effectiveTimeScale,0,t)}warp(t,e,i){const s=this._mixer,n=s.time,o=this.timeScale;let r=this._timeScaleInterpolant;null===r&&(r=s._lendControlInterpolant(),this._timeScaleInterpolant=r);const a=r.parameterPositions,h=r.sampleValues;return a[0]=n,a[1]=n+i,h[0]=t/o,h[1]=e/o,this}stopWarping(){const t=this._timeScaleInterpolant;return null!==t&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(t)),this}getMixer(){return this._mixer}getClip(){return this._clip}getRoot(){return this._localRoot||this._mixer._root}_update(t,e,i,s){if(!this.enabled)return void this._updateWeight(t);const n=this._startTime;if(null!==n){const s=(t-n)*i;if(s<0||0===i)return;this._startTime=null,e=i*s}e*=this._updateTimeScale(t);const o=this._updateTime(e),r=this._updateWeight(t);if(r>0){const t=this._interpolants,e=this._propertyBindings;if(2501===this.blendMode)for(let i=0,s=t.length;i!==s;++i)t[i].evaluate(o),e[i].accumulateAdditive(r);else for(let i=0,n=t.length;i!==n;++i)t[i].evaluate(o),e[i].accumulate(s,r)}}_updateWeight(t){let e=0;if(this.enabled){e=this.weight;const i=this._weightInterpolant;if(null!==i){const s=i.evaluate(t)[0];e*=s,t>i.parameterPositions[1]&&(this.stopFading(),0===s&&(this.enabled=!1))}}return this._effectiveWeight=e,e}_updateTimeScale(t){let e=0;if(!this.paused){e=this.timeScale;const i=this._timeScaleInterpolant;null!==i&&(e*=i.evaluate(t)[0],t>i.parameterPositions[1]&&(this.stopWarping(),0===e?this.paused=!0:this.timeScale=e))}return this._effectiveTimeScale=e,e}_updateTime(t){const e=this._clip.duration,i=this.loop;let s=this.time+t,n=this._loopCount;const o=2202===i;if(0===t)return-1===n?s:o&&1==(1&n)?e-s:s;if(2200===i){-1===n&&(this._loopCount=0,this._setEndings(!0,!0,!1));t:{if(s>=e)s=e;else{if(!(s<0)){this.time=s;break t}s=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=s,this._mixer.dispatchEvent({type:"finished",action:this,direction:t<0?-1:1})}}else{if(-1===n&&(t>=0?(n=0,this._setEndings(!0,0===this.repetitions,o)):this._setEndings(0===this.repetitions,!0,o)),s>=e||s<0){const i=Math.floor(s/e);s-=e*i,n+=Math.abs(i);const r=this.repetitions-n;if(r<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,s=t>0?e:0,this.time=s,this._mixer.dispatchEvent({type:"finished",action:this,direction:t>0?1:-1});else{if(1===r){const e=t<0;this._setEndings(e,!e,o)}else this._setEndings(!1,!1,o);this._loopCount=n,this.time=s,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:i})}}else this.time=s;if(o&&1==(1&n))return e-s}return s}_setEndings(t,e,i){const s=this._interpolantSettings;i?(s.endingStart=Pe,s.endingEnd=Pe):(s.endingStart=t?this.zeroSlopeAtStart?Pe:Ae:ke,s.endingEnd=e?this.zeroSlopeAtEnd?Pe:Ae:ke)}_scheduleFading(t,e,i){const s=this._mixer,n=s.time;let o=this._weightInterpolant;null===o&&(o=s._lendControlInterpolant(),this._weightInterpolant=o);const r=o.parameterPositions,a=o.sampleValues;return r[0]=n,a[0]=e,r[1]=n+t,a[1]=i,this}}function md(t){this._root=t,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}md.prototype=Object.assign(Object.create(Je.prototype),{constructor:md,_bindAction:function(t,e){const i=t._localRoot||this._root,s=t._clip.tracks,n=s.length,o=t._propertyBindings,r=t._interpolants,a=i.uuid,h=this._bindingsByRootAndName;let l=h[a];void 0===l&&(l={},h[a]=l);for(let t=0;t!==n;++t){const n=s[t],h=n.name;let c=l[h];if(void 0!==c)o[t]=c;else{if(c=o[t],void 0!==c){null===c._cacheIndex&&(++c.referenceCount,this._addInactiveBinding(c,a,h));continue}const s=e&&e._propertyBindings[t].binding.parsedPath;c=new td(ud.create(i,h,s),n.ValueTypeName,n.getValueSize()),++c.referenceCount,this._addInactiveBinding(c,a,h),o[t]=c}r[t].resultBuffer=c.buffer}},_activateAction:function(t){if(!this._isActiveAction(t)){if(null===t._cacheIndex){const e=(t._localRoot||this._root).uuid,i=t._clip.uuid,s=this._actionsByClip[i];this._bindAction(t,s&&s.knownActions[0]),this._addInactiveAction(t,i,e)}const e=t._propertyBindings;for(let t=0,i=e.length;t!==i;++t){const i=e[t];0==i.useCount++&&(this._lendBinding(i),i.saveOriginalState())}this._lendAction(t)}},_deactivateAction:function(t){if(this._isActiveAction(t)){const e=t._propertyBindings;for(let t=0,i=e.length;t!==i;++t){const i=e[t];0==--i.useCount&&(i.restoreOriginalState(),this._takeBackBinding(i))}this._takeBackAction(t)}},_initMemoryManager:function(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;const t=this;this.stats={actions:{get total(){return t._actions.length},get inUse(){return t._nActiveActions}},bindings:{get total(){return t._bindings.length},get inUse(){return t._nActiveBindings}},controlInterpolants:{get total(){return t._controlInterpolants.length},get inUse(){return t._nActiveControlInterpolants}}}},_isActiveAction:function(t){const e=t._cacheIndex;return null!==e&&e<this._nActiveActions},_addInactiveAction:function(t,e,i){const s=this._actions,n=this._actionsByClip;let o=n[e];if(void 0===o)o={knownActions:[t],actionByRoot:{}},t._byClipCacheIndex=0,n[e]=o;else{const e=o.knownActions;t._byClipCacheIndex=e.length,e.push(t)}t._cacheIndex=s.length,s.push(t),o.actionByRoot[i]=t},_removeInactiveAction:function(t){const e=this._actions,i=e[e.length-1],s=t._cacheIndex;i._cacheIndex=s,e[s]=i,e.pop(),t._cacheIndex=null;const n=t._clip.uuid,o=this._actionsByClip,r=o[n],a=r.knownActions,h=a[a.length-1],l=t._byClipCacheIndex;h._byClipCacheIndex=l,a[l]=h,a.pop(),t._byClipCacheIndex=null,delete r.actionByRoot[(t._localRoot||this._root).uuid],0===a.length&&delete o[n],this._removeInactiveBindingsForAction(t)},_removeInactiveBindingsForAction:function(t){const e=t._propertyBindings;for(let t=0,i=e.length;t!==i;++t){const i=e[t];0==--i.referenceCount&&this._removeInactiveBinding(i)}},_lendAction:function(t){const e=this._actions,i=t._cacheIndex,s=this._nActiveActions++,n=e[s];t._cacheIndex=s,e[s]=t,n._cacheIndex=i,e[i]=n},_takeBackAction:function(t){const e=this._actions,i=t._cacheIndex,s=--this._nActiveActions,n=e[s];t._cacheIndex=s,e[s]=t,n._cacheIndex=i,e[i]=n},_addInactiveBinding:function(t,e,i){const s=this._bindingsByRootAndName,n=this._bindings;let o=s[e];void 0===o&&(o={},s[e]=o),o[i]=t,t._cacheIndex=n.length,n.push(t)},_removeInactiveBinding:function(t){const e=this._bindings,i=t.binding,s=i.rootNode.uuid,n=i.path,o=this._bindingsByRootAndName,r=o[s],a=e[e.length-1],h=t._cacheIndex;a._cacheIndex=h,e[h]=a,e.pop(),delete r[n],0===Object.keys(r).length&&delete o[s]},_lendBinding:function(t){const e=this._bindings,i=t._cacheIndex,s=this._nActiveBindings++,n=e[s];t._cacheIndex=s,e[s]=t,n._cacheIndex=i,e[i]=n},_takeBackBinding:function(t){const e=this._bindings,i=t._cacheIndex,s=--this._nActiveBindings,n=e[s];t._cacheIndex=s,e[s]=t,n._cacheIndex=i,e[i]=n},_lendControlInterpolant:function(){const t=this._controlInterpolants,e=this._nActiveControlInterpolants++;let i=t[e];return void 0===i&&(i=new Sl(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer),i.__cacheIndex=e,t[e]=i),i},_takeBackControlInterpolant:function(t){const e=this._controlInterpolants,i=t.__cacheIndex,s=--this._nActiveControlInterpolants,n=e[s];t.__cacheIndex=s,e[s]=t,n.__cacheIndex=i,e[i]=n},_controlInterpolantsResultBuffer:new Float32Array(1),clipAction:function(t,e,i){const s=e||this._root,n=s.uuid;let o="string"==typeof t?Bl.findByName(s,t):t;const r=null!==o?o.uuid:t,a=this._actionsByClip[r];let h=null;if(void 0===i&&(i=null!==o?o.blendMode:Be),void 0!==a){const t=a.actionByRoot[n];if(void 0!==t&&t.blendMode===i)return t;h=a.knownActions[0],null===o&&(o=h._clip)}if(null===o)return null;const l=new pd(this,o,e,i);return this._bindAction(l,h),this._addInactiveAction(l,r,n),l},existingAction:function(t,e){const i=e||this._root,s=i.uuid,n="string"==typeof t?Bl.findByName(i,t):t,o=n?n.uuid:t,r=this._actionsByClip[o];return void 0!==r&&r.actionByRoot[s]||null},stopAllAction:function(){const t=this._actions;for(let e=this._nActiveActions-1;e>=0;--e)t[e].stop();return this},update:function(t){t*=this.timeScale;const e=this._actions,i=this._nActiveActions,s=this.time+=t,n=Math.sign(t),o=this._accuIndex^=1;for(let r=0;r!==i;++r)e[r]._update(s,t,n,o);const r=this._bindings,a=this._nActiveBindings;for(let t=0;t!==a;++t)r[t].apply(o);return this},setTime:function(t){this.time=0;for(let t=0;t<this._actions.length;t++)this._actions[t].time=0;return this.update(t)},getRoot:function(){return this._root},uncacheClip:function(t){const e=this._actions,i=t.uuid,s=this._actionsByClip,n=s[i];if(void 0!==n){const t=n.knownActions;for(let i=0,s=t.length;i!==s;++i){const s=t[i];this._deactivateAction(s);const n=s._cacheIndex,o=e[e.length-1];s._cacheIndex=null,s._byClipCacheIndex=null,o._cacheIndex=n,e[n]=o,e.pop(),this._removeInactiveBindingsForAction(s)}delete s[i]}},uncacheRoot:function(t){const e=t.uuid,i=this._actionsByClip;for(const t in i){const s=i[t].actionByRoot[e];void 0!==s&&(this._deactivateAction(s),this._removeInactiveAction(s))}const s=this._bindingsByRootAndName[e];if(void 0!==s)for(const t in s){const e=s[t];e.restoreOriginalState(),this._removeInactiveBinding(e)}},uncacheAction:function(t,e){const i=this.existingAction(t,e);null!==i&&(this._deactivateAction(i),this._removeInactiveAction(i))}});class fd{constructor(t){"string"==typeof t&&(console.warn("THREE.Uniform: Type parameter is no longer needed."),t=arguments[1]),this.value=t}clone(){return new fd(void 0===this.value.clone?this.value:this.value.clone())}}function gd(t,e,i){ra.call(this,t,e),this.meshPerAttribute=i||1}function yd(t,e,i,s,n){this.buffer=t,this.type=e,this.itemSize=i,this.elementSize=s,this.count=n,this.version=0}function vd(t,e,i,s){this.ray=new Wi(t,e),this.near=i||0,this.far=s||1/0,this.camera=null,this.layers=new Ji,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}},Object.defineProperties(this.params,{PointCloud:{get:function(){return console.warn("THREE.Raycaster: params.PointCloud has been renamed to params.Points."),this.Points}}})}function wd(t,e){return t.distance-e.distance}function xd(t,e,i,s){if(t.layers.test(e.layers)&&t.raycast(e,i),!0===s){const s=t.children;for(let t=0,n=s.length;t<n;t++)xd(s[t],e,i,!0)}}gd.prototype=Object.assign(Object.create(ra.prototype),{constructor:gd,isInstancedInterleavedBuffer:!0,copy:function(t){return ra.prototype.copy.call(this,t),this.meshPerAttribute=t.meshPerAttribute,this},clone:function(t){const e=ra.prototype.clone.call(this,t);return e.meshPerAttribute=this.meshPerAttribute,e},toJSON:function(t){const e=ra.prototype.toJSON.call(this,t);return e.isInstancedInterleavedBuffer=!0,e.meshPerAttribute=this.meshPerAttribute,e}}),Object.defineProperty(yd.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}}),Object.assign(yd.prototype,{isGLBufferAttribute:!0,setBuffer:function(t){return this.buffer=t,this},setType:function(t,e){return this.type=t,this.elementSize=e,this},setItemSize:function(t){return this.itemSize=t,this},setCount:function(t){return this.count=t,this}}),Object.assign(vd.prototype,{set:function(t,e){this.ray.set(t,e)},setFromCamera:function(t,e){e&&e.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(t.x,t.y,.5).unproject(e).sub(this.ray.origin).normalize(),this.camera=e):e&&e.isOrthographicCamera?(this.ray.origin.set(t.x,t.y,(e.near+e.far)/(e.near-e.far)).unproject(e),this.ray.direction.set(0,0,-1).transformDirection(e.matrixWorld),this.camera=e):console.error("THREE.Raycaster: Unsupported camera type: "+e.type)},intersectObject:function(t,e,i){const s=i||[];return xd(t,this,s,e),s.sort(wd),s},intersectObjects:function(t,e,i){const s=i||[];if(!1===Array.isArray(t))return console.warn("THREE.Raycaster.intersectObjects: objects is not an Array."),s;for(let i=0,n=t.length;i<n;i++)xd(t[i],this,s,e);return s.sort(wd),s}});class bd{constructor(t=1,e=0,i=0){return this.radius=t,this.phi=e,this.theta=i,this}set(t,e,i){return this.radius=t,this.phi=e,this.theta=i,this}clone(){return(new this.constructor).copy(this)}copy(t){return this.radius=t.radius,this.phi=t.phi,this.theta=t.theta,this}makeSafe(){const t=1e-6;return this.phi=Math.max(t,Math.min(Math.PI-t,this.phi)),this}setFromVector3(t){return this.setFromCartesianCoords(t.x,t.y,t.z)}setFromCartesianCoords(t,e,i){return this.radius=Math.sqrt(t*t+e*e+i*i),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(t,i),this.phi=Math.acos(ei.clamp(e/this.radius,-1,1))),this}}const Sd=new ii;function Md(t){us.call(this),this.material=t,this.render=function(){},this.hasPositions=!1,this.hasNormals=!1,this.hasColors=!1,this.hasUvs=!1,this.positionArray=null,this.normalArray=null,this.colorArray=null,this.uvArray=null,this.count=0}Md.prototype=Object.create(us.prototype),Md.prototype.constructor=Md,Md.prototype.isImmediateRenderObject=!0;const Td=new pi,_d=new Hi,Ed=new Hi;function Ld(t){const e=[];t&&t.isBone&&e.push(t);for(let i=0;i<t.children.length;i++)e.push.apply(e,Ld(t.children[i]));return e}const Cd=new Float32Array(1),Ad=new Int32Array(Cd.buffer),Pd={toHalfFloat:function(t){Cd[0]=t;const e=Ad[0];let i=e>>16&32768,s=e>>12&2047;const n=e>>23&255;return n<103?i:n>142?(i|=31744,i|=(255==n?0:1)&&8388607&e,i):n<113?(s|=2048,i|=(s>>114-n)+(s>>113-n&1),i):(i|=n-112<<10|s>>1,i+=1&s,i)}},kd=(Math.pow(2,8),[.125,.215,.35,.446,.526,.582]),Bd=5+kd.length,{_lodPlanes:Rd,_sizeLods:Dd,_sigmas:Id}=Fd();function Fd(){const t=[],e=[],i=[];let s=8;for(let n=0;n<Bd;n++){const o=Math.pow(2,s);e.push(o);let r=1/o;n>4?r=kd[n-8+4-1]:0==n&&(r=0),i.push(r);const a=1/(o-1),h=-a/2,l=1+a/2,c=[h,h,l,h,l,l,h,h,l,l,h,l],d=6,u=6,p=3,m=2,f=1,g=new Float32Array(p*u*d),y=new Float32Array(m*u*d),v=new Float32Array(f*u*d);for(let t=0;t<d;t++){const e=t%3*2/3-1,i=t>2?0:-1,s=[e,i,0,e+2/3,i,0,e+2/3,i+1,0,e,i,0,e+2/3,i+1,0,e,i+1,0];g.set(s,p*u*t),y.set(c,m*u*t);const n=[t,t,t,t,t,t];v.set(n,f*u*t)}const w=new cn;w.setAttribute("position",new Hs(g,p)),w.setAttribute("uv",new Hs(y,m)),w.setAttribute("faceIndex",new Hs(v,f)),t.push(w),s>4&&s--}return{_lodPlanes:t,_sizeLods:e,_sigmas:i}}function zd(t){console.warn("THREE.Spline has been removed. Use THREE.CatmullRomCurve3 instead."),tc.call(this,t),this.type="catmullrom"}Math.sqrt(5),ql.create=function(t,e){return console.log("THREE.Curve.create() has been deprecated"),t.prototype=Object.create(ql.prototype),t.prototype.constructor=t,t.prototype.getPoint=e,t},Object.assign(uc.prototype,{createPointsGeometry:function(t){console.warn("THREE.CurvePath: .createPointsGeometry() has been removed. Use new THREE.Geometry().setFromPoints( points ) instead.");const e=this.getPoints(t);return this.createGeometry(e)},createSpacedPointsGeometry:function(t){console.warn("THREE.CurvePath: .createSpacedPointsGeometry() has been removed. Use new THREE.Geometry().setFromPoints( points ) instead.");const e=this.getSpacedPoints(t);return this.createGeometry(e)},createGeometry:function(t){console.warn("THREE.CurvePath: .createGeometry() has been removed. Use new THREE.Geometry().setFromPoints( points ) instead.");const e=new fh;for(let i=0,s=t.length;i<s;i++){const s=t[i];e.vertices.push(new pi(s.x,s.y,s.z||0))}return e}}),Object.assign(pc.prototype,{fromPoints:function(t){return console.warn("THREE.Path: .fromPoints() has been renamed to .setFromPoints()."),this.setFromPoints(t)}}),Object.create(tc.prototype),Object.create(tc.prototype),zd.prototype=Object.create(tc.prototype),Object.assign(zd.prototype,{initFromArray:function(){console.error("THREE.Spline: .initFromArray() has been removed.")},getControlPointsArray:function(){console.error("THREE.Spline: .getControlPointsArray() has been removed.")},reparametrizeByArcLength:function(){console.error("THREE.Spline: .reparametrizeByArcLength() has been removed.")}}),class extends Ja{constructor(t=10,e=10,i=4473924,s=8947848){i=new Ds(i),s=new Ds(s);const n=e/2,o=t/e,r=t/2,a=[],h=[];for(let t=0,l=0,c=-r;t<=e;t++,c+=o){a.push(-r,0,c,r,0,c),a.push(c,0,-r,c,0,r);const e=t===n?i:s;e.toArray(h,l),l+=3,e.toArray(h,l),l+=3,e.toArray(h,l),l+=3,e.toArray(h,l),l+=3}const l=new cn;l.setAttribute("position",new Zs(a,3)),l.setAttribute("color",new Zs(h,3)),super(l,new Va({vertexColors:!0,toneMapped:!1})),this.type="GridHelper"}}.prototype.setColors=function(){console.error("THREE.GridHelper: setColors() has been deprecated, pass them in the constructor instead.")},class extends Ja{constructor(t){const e=Ld(t),i=new cn,s=[],n=[],o=new Ds(0,0,1),r=new Ds(0,1,0);for(let t=0;t<e.length;t++){const i=e[t];i.parent&&i.parent.isBone&&(s.push(0,0,0),s.push(0,0,0),n.push(o.r,o.g,o.b),n.push(r.r,r.g,r.b))}i.setAttribute("position",new Zs(s,3)),i.setAttribute("color",new Zs(n,3)),super(i,new Va({vertexColors:!0,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.type="SkeletonHelper",this.isSkeletonHelper=!0,this.root=t,this.bones=e,this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(t){const e=this.bones,i=this.geometry,s=i.getAttribute("position");Ed.copy(this.root.matrixWorld).invert();for(let t=0,i=0;t<e.length;t++){const n=e[t];n.parent&&n.parent.isBone&&(_d.multiplyMatrices(Ed,n.matrixWorld),Td.setFromMatrixPosition(_d),s.setXYZ(i,Td.x,Td.y,Td.z),_d.multiplyMatrices(Ed,n.parent.matrixWorld),Td.setFromMatrixPosition(_d),s.setXYZ(i+1,Td.x,Td.y,Td.z),i+=2)}i.getAttribute("position").needsUpdate=!0,super.updateMatrixWorld(t)}}.prototype.update=function(){console.error("THREE.SkeletonHelper: update() no longer needs to be called.")},Object.assign(zl.prototype,{extractUrlBase:function(t){return console.warn("THREE.Loader: .extractUrlBase() has been deprecated. Use THREE.LoaderUtils.extractUrlBase() instead."),Pc.extractUrlBase(t)}}),zl.Handlers={add:function(){console.error("THREE.Loader: Handlers.add() has been removed. Use LoadingManager.addHandler() instead.")},get:function(){console.error("THREE.Loader: Handlers.get() has been removed. Use LoadingManager.getHandler() instead.")}},Object.assign(class{constructor(t,e){Object.defineProperty(this,"isBox2",{value:!0}),this.min=void 0!==t?t:new ii(1/0,1/0),this.max=void 0!==e?e:new ii(-1/0,-1/0)}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromPoints(t){this.makeEmpty();for(let e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const i=Sd.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(t){return void 0===t&&(console.warn("THREE.Box2: .getCenter() target is now required"),t=new ii),this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return void 0===t&&(console.warn("THREE.Box2: .getSize() target is now required"),t=new ii),this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y)}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y}getParameter(t,e){return void 0===e&&(console.warn("THREE.Box2: .getParameter() target is now required"),e=new ii),e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y)}clampPoint(t,e){return void 0===e&&(console.warn("THREE.Box2: .clampPoint() target is now required"),e=new ii),e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return Sd.copy(t).clamp(this.min,this.max).sub(t).length()}intersect(t){return this.min.max(t.min),this.max.min(t.max),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}.prototype,{center:function(t){return console.warn("THREE.Box2: .center() has been renamed to .getCenter()."),this.getCenter(t)},empty:function(){return console.warn("THREE.Box2: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(t){return console.warn("THREE.Box2: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(t)},size:function(t){return console.warn("THREE.Box2: .size() has been renamed to .getSize()."),this.getSize(t)}}),Object.assign(gi.prototype,{center:function(t){return console.warn("THREE.Box3: .center() has been renamed to .getCenter()."),this.getCenter(t)},empty:function(){return console.warn("THREE.Box3: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(t){return console.warn("THREE.Box3: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(t)},isIntersectionSphere:function(t){return console.warn("THREE.Box3: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(t)},size:function(t){return console.warn("THREE.Box3: .size() has been renamed to .getSize()."),this.getSize(t)}}),Object.assign(Bi.prototype,{empty:function(){return console.warn("THREE.Sphere: .empty() has been renamed to .isEmpty()."),this.isEmpty()}}),$n.prototype.setFromMatrix=function(t){return console.warn("THREE.Frustum: .setFromMatrix() has been renamed to .setFromProjectionMatrix()."),this.setFromProjectionMatrix(t)},Object.assign(ei,{random16:function(){return console.warn("THREE.Math: .random16() has been deprecated. Use Math.random() instead."),Math.random()},nearestPowerOfTwo:function(t){return console.warn("THREE.Math: .nearestPowerOfTwo() has been renamed to .floorPowerOfTwo()."),ei.floorPowerOfTwo(t)},nextPowerOfTwo:function(t){return console.warn("THREE.Math: .nextPowerOfTwo() has been renamed to .ceilPowerOfTwo()."),ei.ceilPowerOfTwo(t)}}),Object.assign(si.prototype,{flattenToArrayOffset:function(t,e){return console.warn("THREE.Matrix3: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(t,e)},multiplyVector3:function(t){return console.warn("THREE.Matrix3: .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),t.applyMatrix3(this)},multiplyVector3Array:function(){console.error("THREE.Matrix3: .multiplyVector3Array() has been removed.")},applyToBufferAttribute:function(t){return console.warn("THREE.Matrix3: .applyToBufferAttribute() has been removed. Use attribute.applyMatrix3( matrix ) instead."),t.applyMatrix3(this)},applyToVector3Array:function(){console.error("THREE.Matrix3: .applyToVector3Array() has been removed.")},getInverse:function(t){return console.warn("THREE.Matrix3: .getInverse() has been removed. Use matrixInv.copy( matrix ).invert(); instead."),this.copy(t).invert()}}),Object.assign(Hi.prototype,{extractPosition:function(t){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(t)},flattenToArrayOffset:function(t,e){return console.warn("THREE.Matrix4: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(t,e)},getPosition:function(){return console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead."),(new pi).setFromMatrixColumn(this,3)},setRotationFromQuaternion:function(t){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(t)},multiplyToArray:function(){console.warn("THREE.Matrix4: .multiplyToArray() has been removed.")},multiplyVector3:function(t){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},multiplyVector4:function(t){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},multiplyVector3Array:function(){console.error("THREE.Matrix4: .multiplyVector3Array() has been removed.")},rotateAxis:function(t){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),t.transformDirection(this)},crossVector:function(t){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},translate:function(){console.error("THREE.Matrix4: .translate() has been removed.")},rotateX:function(){console.error("THREE.Matrix4: .rotateX() has been removed.")},rotateY:function(){console.error("THREE.Matrix4: .rotateY() has been removed.")},rotateZ:function(){console.error("THREE.Matrix4: .rotateZ() has been removed.")},rotateByAxis:function(){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},applyToBufferAttribute:function(t){return console.warn("THREE.Matrix4: .applyToBufferAttribute() has been removed. Use attribute.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},applyToVector3Array:function(){console.error("THREE.Matrix4: .applyToVector3Array() has been removed.")},makeFrustum:function(t,e,i,s,n,o){return console.warn("THREE.Matrix4: .makeFrustum() has been removed. Use .makePerspective( left, right, top, bottom, near, far ) instead."),this.makePerspective(t,e,s,i,n,o)},getInverse:function(t){return console.warn("THREE.Matrix4: .getInverse() has been removed. Use matrixInv.copy( matrix ).invert(); instead."),this.copy(t).invert()}}),gs.prototype.isIntersectionLine=function(t){return console.warn("THREE.Plane: .isIntersectionLine() has been renamed to .intersectsLine()."),this.intersectsLine(t)},Object.assign(ui.prototype,{multiplyVector3:function(t){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),t.applyQuaternion(this)},inverse:function(){return console.warn("THREE.Quaternion: .inverse() has been renamed to invert()."),this.invert()}}),Object.assign(Wi.prototype,{isIntersectionBox:function(t){return console.warn("THREE.Ray: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(t)},isIntersectionPlane:function(t){return console.warn("THREE.Ray: .isIntersectionPlane() has been renamed to .intersectsPlane()."),this.intersectsPlane(t)},isIntersectionSphere:function(t){return console.warn("THREE.Ray: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(t)}}),Object.assign(Ls.prototype,{area:function(){return console.warn("THREE.Triangle: .area() has been renamed to .getArea()."),this.getArea()},barycoordFromPoint:function(t,e){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),this.getBarycoord(t,e)},midpoint:function(t){return console.warn("THREE.Triangle: .midpoint() has been renamed to .getMidpoint()."),this.getMidpoint(t)},normal:function(t){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),this.getNormal(t)},plane:function(t){return console.warn("THREE.Triangle: .plane() has been renamed to .getPlane()."),this.getPlane(t)}}),Object.assign(Ls,{barycoordFromPoint:function(t,e,i,s,n){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),Ls.getBarycoord(t,e,i,s,n)},normal:function(t,e,i,s){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),Ls.getNormal(t,e,i,s)}}),Object.assign(mc.prototype,{extractAllPoints:function(t){return console.warn("THREE.Shape: .extractAllPoints() has been removed. Use .extractPoints() instead."),this.extractPoints(t)},extrude:function(t){return console.warn("THREE.Shape: .extrude() has been removed. Use ExtrudeGeometry() instead."),new Kh(this,t)},makeGeometry:function(t){return console.warn("THREE.Shape: .makeGeometry() has been removed. Use ShapeGeometry() instead."),new il(this,t)}}),Object.assign(ii.prototype,{fromAttribute:function(t,e,i){return console.warn("THREE.Vector2: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(t,e,i)},distanceToManhattan:function(t){return console.warn("THREE.Vector2: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(t)},lengthManhattan:function(){return console.warn("THREE.Vector2: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}}),Object.assign(pi.prototype,{setEulerFromRotationMatrix:function(){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},setEulerFromQuaternion:function(){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},getPositionFromMatrix:function(t){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(t)},getScaleFromMatrix:function(t){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(t)},getColumnFromMatrix:function(t,e){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(e,t)},applyProjection:function(t){return console.warn("THREE.Vector3: .applyProjection() has been removed. Use .applyMatrix4( m ) instead."),this.applyMatrix4(t)},fromAttribute:function(t,e,i){return console.warn("THREE.Vector3: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(t,e,i)},distanceToManhattan:function(t){return console.warn("THREE.Vector3: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(t)},lengthManhattan:function(){return console.warn("THREE.Vector3: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}}),Object.assign(li.prototype,{fromAttribute:function(t,e,i){return console.warn("THREE.Vector4: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(t,e,i)},lengthManhattan:function(){return console.warn("THREE.Vector4: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}}),Object.assign(fh.prototype,{computeTangents:function(){console.error("THREE.Geometry: .computeTangents() has been removed.")},computeLineDistances:function(){console.error("THREE.Geometry: .computeLineDistances() has been removed. Use THREE.Line.computeLineDistances() instead.")},applyMatrix:function(t){return console.warn("THREE.Geometry: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(t)}}),Object.assign(us.prototype,{getChildByName:function(t){return console.warn("THREE.Object3D: .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(t)},renderDepth:function(){console.warn("THREE.Object3D: .renderDepth has been removed. Use .renderOrder, instead.")},translate:function(t,e){return console.warn("THREE.Object3D: .translate() has been removed. Use .translateOnAxis( axis, distance ) instead."),this.translateOnAxis(e,t)},getWorldRotation:function(){console.error("THREE.Object3D: .getWorldRotation() has been removed. Use THREE.Object3D.getWorldQuaternion( target ) instead.")},applyMatrix:function(t){return console.warn("THREE.Object3D: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(t)}}),Object.defineProperties(us.prototype,{eulerOrder:{get:function(){return console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order},set:function(t){console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order=t}},useQuaternion:{get:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")}}}),Object.assign(Cn.prototype,{setDrawMode:function(){console.error("THREE.Mesh: .setDrawMode() has been removed. The renderer now always assumes THREE.TrianglesDrawMode. Transform your geometry via BufferGeometryUtils.toTrianglesDrawMode() if necessary.")}}),Object.defineProperties(Cn.prototype,{drawMode:{get:function(){return console.error("THREE.Mesh: .drawMode has been removed. The renderer now always assumes THREE.TrianglesDrawMode."),0},set:function(){console.error("THREE.Mesh: .drawMode has been removed. The renderer now always assumes THREE.TrianglesDrawMode. Transform your geometry via BufferGeometryUtils.toTrianglesDrawMode() if necessary.")}}}),Object.defineProperties(La.prototype,{objects:{get:function(){return console.warn("THREE.LOD: .objects has been renamed to .levels."),this.levels}}}),Object.defineProperty(za.prototype,"useVertexTexture",{get:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")},set:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")}}),Ra.prototype.initBones=function(){console.error("THREE.SkinnedMesh: initBones() has been removed.")},Object.defineProperty(ql.prototype,"__arcLengthDivisions",{get:function(){return console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions},set:function(t){console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions=t}}),Nn.prototype.setLens=function(t,e){console.warn("THREE.PerspectiveCamera.setLens is deprecated. Use .setFocalLength and .filmGauge for a photographic setup."),void 0!==e&&(this.filmGauge=e),this.setFocalLength(t)},Object.defineProperties(fc.prototype,{onlyShadow:{set:function(){console.warn("THREE.Light: .onlyShadow has been removed.")}},shadowCameraFov:{set:function(t){console.warn("THREE.Light: .shadowCameraFov is now .shadow.camera.fov."),this.shadow.camera.fov=t}},shadowCameraLeft:{set:function(t){console.warn("THREE.Light: .shadowCameraLeft is now .shadow.camera.left."),this.shadow.camera.left=t}},shadowCameraRight:{set:function(t){console.warn("THREE.Light: .shadowCameraRight is now .shadow.camera.right."),this.shadow.camera.right=t}},shadowCameraTop:{set:function(t){console.warn("THREE.Light: .shadowCameraTop is now .shadow.camera.top."),this.shadow.camera.top=t}},shadowCameraBottom:{set:function(t){console.warn("THREE.Light: .shadowCameraBottom is now .shadow.camera.bottom."),this.shadow.camera.bottom=t}},shadowCameraNear:{set:function(t){console.warn("THREE.Light: .shadowCameraNear is now .shadow.camera.near."),this.shadow.camera.near=t}},shadowCameraFar:{set:function(t){console.warn("THREE.Light: .shadowCameraFar is now .shadow.camera.far."),this.shadow.camera.far=t}},shadowCameraVisible:{set:function(){console.warn("THREE.Light: .shadowCameraVisible has been removed. Use new THREE.CameraHelper( light.shadow.camera ) instead.")}},shadowBias:{set:function(t){console.warn("THREE.Light: .shadowBias is now .shadow.bias."),this.shadow.bias=t}},shadowDarkness:{set:function(){console.warn("THREE.Light: .shadowDarkness has been removed.")}},shadowMapWidth:{set:function(t){console.warn("THREE.Light: .shadowMapWidth is now .shadow.mapSize.width."),this.shadow.mapSize.width=t}},shadowMapHeight:{set:function(t){console.warn("THREE.Light: .shadowMapHeight is now .shadow.mapSize.height."),this.shadow.mapSize.height=t}}}),Object.defineProperties(Hs.prototype,{length:{get:function(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Use .count instead."),this.array.length}},dynamic:{get:function(){return console.warn("THREE.BufferAttribute: .dynamic has been deprecated. Use .usage instead."),this.usage===Ze},set:function(){console.warn("THREE.BufferAttribute: .dynamic has been deprecated. Use .usage instead."),this.setUsage(Ze)}}}),Object.assign(Hs.prototype,{setDynamic:function(t){return console.warn("THREE.BufferAttribute: .setDynamic() has been deprecated. Use .setUsage() instead."),this.setUsage(!0===t?Ze:Ye),this},copyIndicesArray:function(){console.error("THREE.BufferAttribute: .copyIndicesArray() has been removed.")},setArray:function(){console.error("THREE.BufferAttribute: .setArray has been removed. Use BufferGeometry .setAttribute to replace/resize attribute buffers")}}),Object.assign(cn.prototype,{addIndex:function(t){console.warn("THREE.BufferGeometry: .addIndex() has been renamed to .setIndex()."),this.setIndex(t)},addAttribute:function(t,e){return console.warn("THREE.BufferGeometry: .addAttribute() has been renamed to .setAttribute()."),e&&e.isBufferAttribute||e&&e.isInterleavedBufferAttribute?"index"===t?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),this.setIndex(e),this):this.setAttribute(t,e):(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),this.setAttribute(t,new Hs(arguments[1],arguments[2])))},addDrawCall:function(t,e,i){void 0!==i&&console.warn("THREE.BufferGeometry: .addDrawCall() no longer supports indexOffset."),console.warn("THREE.BufferGeometry: .addDrawCall() is now .addGroup()."),this.addGroup(t,e)},clearDrawCalls:function(){console.warn("THREE.BufferGeometry: .clearDrawCalls() is now .clearGroups()."),this.clearGroups()},computeTangents:function(){console.warn("THREE.BufferGeometry: .computeTangents() has been removed.")},computeOffsets:function(){console.warn("THREE.BufferGeometry: .computeOffsets() has been removed.")},removeAttribute:function(t){return console.warn("THREE.BufferGeometry: .removeAttribute() has been renamed to .deleteAttribute()."),this.deleteAttribute(t)},applyMatrix:function(t){return console.warn("THREE.BufferGeometry: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(t)}}),Object.defineProperties(cn.prototype,{drawcalls:{get:function(){return console.error("THREE.BufferGeometry: .drawcalls has been renamed to .groups."),this.groups}},offsets:{get:function(){return console.warn("THREE.BufferGeometry: .offsets has been renamed to .groups."),this.groups}}}),Object.defineProperties(kc.prototype,{maxInstancedCount:{get:function(){return console.warn("THREE.InstancedBufferGeometry: .maxInstancedCount has been renamed to .instanceCount."),this.instanceCount},set:function(t){console.warn("THREE.InstancedBufferGeometry: .maxInstancedCount has been renamed to .instanceCount."),this.instanceCount=t}}}),Object.defineProperties(vd.prototype,{linePrecision:{get:function(){return console.warn("THREE.Raycaster: .linePrecision has been deprecated. Use .params.Line.threshold instead."),this.params.Line.threshold},set:function(t){console.warn("THREE.Raycaster: .linePrecision has been deprecated. Use .params.Line.threshold instead."),this.params.Line.threshold=t}}}),Object.defineProperties(ra.prototype,{dynamic:{get:function(){return console.warn("THREE.InterleavedBuffer: .length has been deprecated. Use .usage instead."),this.usage===Ze},set:function(t){console.warn("THREE.InterleavedBuffer: .length has been deprecated. Use .usage instead."),this.setUsage(t)}}}),Object.assign(ra.prototype,{setDynamic:function(t){return console.warn("THREE.InterleavedBuffer: .setDynamic() has been deprecated. Use .setUsage() instead."),this.setUsage(!0===t?Ze:Ye),this},setArray:function(){console.error("THREE.InterleavedBuffer: .setArray has been removed. Use BufferGeometry .setAttribute to replace/resize attribute buffers")}}),Object.assign(Yh.prototype,{getArrays:function(){console.error("THREE.ExtrudeBufferGeometry: .getArrays() has been removed.")},addShapeList:function(){console.error("THREE.ExtrudeBufferGeometry: .addShapeList() has been removed.")},addShape:function(){console.error("THREE.ExtrudeBufferGeometry: .addShape() has been removed.")}}),Object.assign(oa.prototype,{dispose:function(){console.error("THREE.Scene: .dispose() has been removed.")}}),Object.defineProperties(fd.prototype,{dynamic:{set:function(){console.warn("THREE.Uniform: .dynamic has been removed. Use object.onBeforeRender() instead.")}},onUpdate:{value:function(){return console.warn("THREE.Uniform: .onUpdate() has been removed. Use object.onBeforeRender() instead."),this}}}),Object.defineProperties(zs.prototype,{wrapAround:{get:function(){console.warn("THREE.Material: .wrapAround has been removed.")},set:function(){console.warn("THREE.Material: .wrapAround has been removed.")}},overdraw:{get:function(){console.warn("THREE.Material: .overdraw has been removed.")},set:function(){console.warn("THREE.Material: .overdraw has been removed.")}},wrapRGB:{get:function(){return console.warn("THREE.Material: .wrapRGB has been removed."),new Ds}},shading:{get:function(){console.error("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead.")},set:function(t){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=1===t}},stencilMask:{get:function(){return console.warn("THREE."+this.type+": .stencilMask has been removed. Use .stencilFuncMask instead."),this.stencilFuncMask},set:function(t){console.warn("THREE."+this.type+": .stencilMask has been removed. Use .stencilFuncMask instead."),this.stencilFuncMask=t}}}),Object.defineProperties(ul.prototype,{metal:{get:function(){return console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead."),!1},set:function(){console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead")}}}),Object.defineProperties(dl.prototype,{transparency:{get:function(){return console.warn("THREE.MeshPhysicalMaterial: .transparency has been renamed to .transmission."),this.transmission},set:function(t){console.warn("THREE.MeshPhysicalMaterial: .transparency has been renamed to .transmission."),this.transmission=t}}}),Object.defineProperties(zn.prototype,{derivatives:{get:function(){return console.warn("THREE.ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives},set:function(t){console.warn("THREE. ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives=t}}}),Object.assign(sa.prototype,{clearTarget:function(t,e,i,s){console.warn("THREE.WebGLRenderer: .clearTarget() has been deprecated. Use .setRenderTarget() and .clear() instead."),this.setRenderTarget(t),this.clear(e,i,s)},animate:function(t){console.warn("THREE.WebGLRenderer: .animate() is now .setAnimationLoop()."),this.setAnimationLoop(t)},getCurrentRenderTarget:function(){return console.warn("THREE.WebGLRenderer: .getCurrentRenderTarget() is now .getRenderTarget()."),this.getRenderTarget()},getMaxAnisotropy:function(){return console.warn("THREE.WebGLRenderer: .getMaxAnisotropy() is now .capabilities.getMaxAnisotropy()."),this.capabilities.getMaxAnisotropy()},getPrecision:function(){return console.warn("THREE.WebGLRenderer: .getPrecision() is now .capabilities.precision."),this.capabilities.precision},resetGLState:function(){return console.warn("THREE.WebGLRenderer: .resetGLState() is now .state.reset()."),this.state.reset()},supportsFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")},supportsHalfFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")},supportsStandardDerivatives:function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")},supportsCompressedTextureS3TC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")},supportsCompressedTexturePVRTC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")},supportsBlendMinMax:function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")},supportsVertexTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsVertexTextures() is now .capabilities.vertexTextures."),this.capabilities.vertexTextures},supportsInstancedArrays:function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")},enableScissorTest:function(t){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(t)},initMaterial:function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")},addPrePlugin:function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")},addPostPlugin:function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")},updateShadowMap:function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")},setFaceCulling:function(){console.warn("THREE.WebGLRenderer: .setFaceCulling() has been removed.")},allocTextureUnit:function(){console.warn("THREE.WebGLRenderer: .allocTextureUnit() has been removed.")},setTexture:function(){console.warn("THREE.WebGLRenderer: .setTexture() has been removed.")},setTexture2D:function(){console.warn("THREE.WebGLRenderer: .setTexture2D() has been removed.")},setTextureCube:function(){console.warn("THREE.WebGLRenderer: .setTextureCube() has been removed.")},getActiveMipMapLevel:function(){return console.warn("THREE.WebGLRenderer: .getActiveMipMapLevel() is now .getActiveMipmapLevel()."),this.getActiveMipmapLevel()}}),Object.defineProperties(sa.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(t){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=t}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(t){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=t}},shadowMapCullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")}},context:{get:function(){return console.warn("THREE.WebGLRenderer: .context has been removed. Use .getContext() instead."),this.getContext()}},vr:{get:function(){return console.warn("THREE.WebGLRenderer: .vr has been renamed to .xr"),this.xr}},gammaInput:{get:function(){return console.warn("THREE.WebGLRenderer: .gammaInput has been removed. Set the encoding for textures via Texture.encoding instead."),!1},set:function(){console.warn("THREE.WebGLRenderer: .gammaInput has been removed. Set the encoding for textures via Texture.encoding instead.")}},gammaOutput:{get:function(){return console.warn("THREE.WebGLRenderer: .gammaOutput has been removed. Set WebGLRenderer.outputEncoding instead."),!1},set:function(t){console.warn("THREE.WebGLRenderer: .gammaOutput has been removed. Set WebGLRenderer.outputEncoding instead."),this.outputEncoding=!0===t?Fe:Ie}},toneMappingWhitePoint:{get:function(){return console.warn("THREE.WebGLRenderer: .toneMappingWhitePoint has been removed."),1},set:function(){console.warn("THREE.WebGLRenderer: .toneMappingWhitePoint has been removed.")}}}),Object.defineProperties(Xr.prototype,{cullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")}},renderReverseSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")}},renderSingleSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")}}}),Object.defineProperties(ci.prototype,{wrapS:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS},set:function(t){console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS=t}},wrapT:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT},set:function(t){console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT=t}},magFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter},set:function(t){console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter=t}},minFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter},set:function(t){console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter=t}},anisotropy:{get:function(){return console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy},set:function(t){console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy=t}},offset:{get:function(){return console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset},set:function(t){console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset=t}},repeat:{get:function(){return console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat},set:function(t){console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat=t}},format:{get:function(){return console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format},set:function(t){console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format=t}},type:{get:function(){return console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type},set:function(t){console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type=t}},generateMipmaps:{get:function(){return console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps},set:function(t){console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps=t}}}),Object.defineProperties(Qc.prototype,{load:{value:function(t){console.warn("THREE.Audio: .load has been deprecated. Use THREE.AudioLoader instead.");const e=this;return(new Hc).load(t,(function(t){e.setBuffer(t)})),this}},startTime:{set:function(){console.warn("THREE.Audio: .startTime is now .play( delay ).")}}}),Hn.prototype.updateCubeMap=function(t,e){return console.warn("THREE.CubeCamera: .updateCubeMap() is now .update()."),this.update(t,e)},Hn.prototype.clear=function(t,e,i,s){return console.warn("THREE.CubeCamera: .clear() is now .renderTarget.clear()."),this.renderTarget.clear(t,e,i,s)},oi.crossOrigin=void 0,oi.loadTexture=function(t,e,i,s){console.warn("THREE.ImageUtils.loadTexture has been deprecated. Use THREE.TextureLoader() instead.");const n=new jl;n.setCrossOrigin(this.crossOrigin);const o=n.load(t,i,void 0,s);return e&&(o.mapping=e),o},oi.loadTextureCube=function(t,e,i,s){console.warn("THREE.ImageUtils.loadTextureCube has been deprecated. Use THREE.CubeTextureLoader() instead.");const n=new Vl;n.setCrossOrigin(this.crossOrigin);const o=n.load(t,i,void 0,s);return e&&(o.mapping=e),o},oi.loadCompressedTexture=function(){console.error("THREE.ImageUtils.loadCompressedTexture has been removed. Use THREE.DDSLoader instead.")},oi.loadCompressedTextureCube=function(){console.error("THREE.ImageUtils.loadCompressedTextureCube has been removed. Use THREE.DDSLoader instead.")},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:"124"}}));var Od=function(t,e){var n,o,r,a,h,l;void 0===e&&console.warn('THREE.OrbitControls: The second parameter "domElement" is now mandatory.'),e===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.object=t,this.domElement=e,this.enabled=!0,this.target=new pi,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={LEFT:i.ROTATE,MIDDLE:i.DOLLY,RIGHT:i.PAN},this.touches={ONE:s.ROTATE,TWO:s.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return y.phi},this.getAzimuthalAngle=function(){return y.theta},this.saveState=function(){c.target0.copy(c.target),c.position0.copy(c.object.position),c.zoom0=c.object.zoom},this.reset=function(){c.target.copy(c.target0),c.object.position.copy(c.position0),c.object.zoom=c.zoom0,c.object.updateProjectionMatrix(),c.dispatchEvent(d),c.update(),f=m.NONE},this.update=(n=new pi,o=(new ui).setFromUnitVectors(t.up,new pi(0,1,0)),r=o.clone().invert(),a=new pi,h=new ui,l=2*Math.PI,function(){var t=c.object.position;n.copy(t).sub(c.target),n.applyQuaternion(o),y.setFromVector3(n),c.autoRotate&&f===m.NONE&&B(2*Math.PI/60/60*c.autoRotateSpeed),c.enableDamping?(y.theta+=v.theta*c.dampingFactor,y.phi+=v.phi*c.dampingFactor):(y.theta+=v.theta,y.phi+=v.phi);var e=c.minAzimuthAngle,i=c.maxAzimuthAngle;return isFinite(e)&&isFinite(i)&&(e<-Math.PI?e+=l:e>Math.PI&&(e-=l),i<-Math.PI?i+=l:i>Math.PI&&(i-=l),y.theta=e<=i?Math.max(e,Math.min(i,y.theta)):y.theta>(e+i)/2?Math.max(e,y.theta):Math.min(i,y.theta)),y.phi=Math.max(c.minPolarAngle,Math.min(c.maxPolarAngle,y.phi)),y.makeSafe(),y.radius*=w,y.radius=Math.max(c.minDistance,Math.min(c.maxDistance,y.radius)),!0===c.enableDamping?c.target.addScaledVector(x,c.dampingFactor):c.target.add(x),n.setFromSpherical(y),n.applyQuaternion(r),t.copy(c.target).add(n),c.object.lookAt(c.target),!0===c.enableDamping?(v.theta*=1-c.dampingFactor,v.phi*=1-c.dampingFactor,x.multiplyScalar(1-c.dampingFactor)):(v.set(0,0,0),x.set(0,0,0)),w=1,!!(b||a.distanceToSquared(c.object.position)>g||8*(1-h.dot(c.object.quaternion))>g)&&(c.dispatchEvent(d),a.copy(c.object.position),h.copy(c.object.quaternion),b=!1,!0)}),this.dispose=function(){c.domElement.removeEventListener("contextmenu",it,!1),c.domElement.removeEventListener("pointerdown",X,!1),c.domElement.removeEventListener("wheel",K,!1),c.domElement.removeEventListener("touchstart",Q,!1),c.domElement.removeEventListener("touchend",et,!1),c.domElement.removeEventListener("touchmove",tt,!1),c.domElement.ownerDocument.removeEventListener("pointermove",Y,!1),c.domElement.ownerDocument.removeEventListener("pointerup",Z,!1),c.domElement.removeEventListener("keydown",J,!1)};var c=this,d={type:"change"},u={type:"start"},p={type:"end"},m={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},f=m.NONE,g=1e-6,y=new bd,v=new bd,w=1,x=new pi,b=!1,S=new ii,M=new ii,T=new ii,_=new ii,E=new ii,L=new ii,C=new ii,A=new ii,P=new ii;function k(){return Math.pow(.95,c.zoomSpeed)}function B(t){v.theta-=t}function R(t){v.phi-=t}var D,I=(D=new pi,function(t,e){D.setFromMatrixColumn(e,0),D.multiplyScalar(-t),x.add(D)}),F=function(){var t=new pi;return function(e,i){!0===c.screenSpacePanning?t.setFromMatrixColumn(i,1):(t.setFromMatrixColumn(i,0),t.crossVectors(c.object.up,t)),t.multiplyScalar(e),x.add(t)}}(),z=function(){var t=new pi;return function(e,i){var s=c.domElement;if(c.object.isPerspectiveCamera){var n=c.object.position;t.copy(n).sub(c.target);var o=t.length();o*=Math.tan(c.object.fov/2*Math.PI/180),I(2*e*o/s.clientHeight,c.object.matrix),F(2*i*o/s.clientHeight,c.object.matrix)}else c.object.isOrthographicCamera?(I(e*(c.object.right-c.object.left)/c.object.zoom/s.clientWidth,c.object.matrix),F(i*(c.object.top-c.object.bottom)/c.object.zoom/s.clientHeight,c.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),c.enablePan=!1)}}();function O(t){c.object.isPerspectiveCamera?w/=t:c.object.isOrthographicCamera?(c.object.zoom=Math.max(c.minZoom,Math.min(c.maxZoom,c.object.zoom*t)),c.object.updateProjectionMatrix(),b=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),c.enableZoom=!1)}function N(t){c.object.isPerspectiveCamera?w*=t:c.object.isOrthographicCamera?(c.object.zoom=Math.max(c.minZoom,Math.min(c.maxZoom,c.object.zoom/t)),c.object.updateProjectionMatrix(),b=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),c.enableZoom=!1)}function W(t){S.set(t.clientX,t.clientY)}function H(t){_.set(t.clientX,t.clientY)}function U(t){if(1==t.touches.length)S.set(t.touches[0].pageX,t.touches[0].pageY);else{var e=.5*(t.touches[0].pageX+t.touches[1].pageX),i=.5*(t.touches[0].pageY+t.touches[1].pageY);S.set(e,i)}}function V(t){if(1==t.touches.length)_.set(t.touches[0].pageX,t.touches[0].pageY);else{var e=.5*(t.touches[0].pageX+t.touches[1].pageX),i=.5*(t.touches[0].pageY+t.touches[1].pageY);_.set(e,i)}}function G(t){var e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY,s=Math.sqrt(e*e+i*i);C.set(0,s)}function j(t){if(1==t.touches.length)M.set(t.touches[0].pageX,t.touches[0].pageY);else{var e=.5*(t.touches[0].pageX+t.touches[1].pageX),i=.5*(t.touches[0].pageY+t.touches[1].pageY);M.set(e,i)}T.subVectors(M,S).multiplyScalar(c.rotateSpeed);var s=c.domElement;B(2*Math.PI*T.x/s.clientHeight),R(2*Math.PI*T.y/s.clientHeight),S.copy(M)}function q(t){if(1==t.touches.length)E.set(t.touches[0].pageX,t.touches[0].pageY);else{var e=.5*(t.touches[0].pageX+t.touches[1].pageX),i=.5*(t.touches[0].pageY+t.touches[1].pageY);E.set(e,i)}L.subVectors(E,_).multiplyScalar(c.panSpeed),z(L.x,L.y),_.copy(E)}function $(t){var e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY,s=Math.sqrt(e*e+i*i);A.set(0,s),P.set(0,Math.pow(A.y/C.y,c.zoomSpeed)),O(P.y),C.copy(A)}function X(t){if(!1!==c.enabled)switch(t.pointerType){case"mouse":case"pen":!function(t){var e;switch(t.preventDefault(),c.domElement.focus?c.domElement.focus():window.focus(),t.button){case 0:e=c.mouseButtons.LEFT;break;case 1:e=c.mouseButtons.MIDDLE;break;case 2:e=c.mouseButtons.RIGHT;break;default:e=-1}switch(e){case i.DOLLY:if(!1===c.enableZoom)return;!function(t){C.set(t.clientX,t.clientY)}(t),f=m.DOLLY;break;case i.ROTATE:if(t.ctrlKey||t.metaKey||t.shiftKey){if(!1===c.enablePan)return;H(t),f=m.PAN}else{if(!1===c.enableRotate)return;W(t),f=m.ROTATE}break;case i.PAN:if(t.ctrlKey||t.metaKey||t.shiftKey){if(!1===c.enableRotate)return;W(t),f=m.ROTATE}else{if(!1===c.enablePan)return;H(t),f=m.PAN}break;default:f=m.NONE}f!==m.NONE&&(c.domElement.ownerDocument.addEventListener("pointermove",Y,!1),c.domElement.ownerDocument.addEventListener("pointerup",Z,!1),c.dispatchEvent(u))}(t)}}function Y(t){if(!1!==c.enabled)switch(t.pointerType){case"mouse":case"pen":!function(t){if(!1!==c.enabled)switch(t.preventDefault(),f){case m.ROTATE:if(!1===c.enableRotate)return;!function(t){M.set(t.clientX,t.clientY),T.subVectors(M,S).multiplyScalar(c.rotateSpeed);var e=c.domElement;B(2*Math.PI*T.x/e.clientHeight),R(2*Math.PI*T.y/e.clientHeight),S.copy(M),c.update()}(t);break;case m.DOLLY:if(!1===c.enableZoom)return;!function(t){A.set(t.clientX,t.clientY),P.subVectors(A,C),P.y>0?O(k()):P.y<0&&N(k()),C.copy(A),c.update()}(t);break;case m.PAN:if(!1===c.enablePan)return;!function(t){E.set(t.clientX,t.clientY),L.subVectors(E,_).multiplyScalar(c.panSpeed),z(L.x,L.y),_.copy(E),c.update()}(t)}}(t)}}function Z(t){switch(t.pointerType){case"mouse":case"pen":c.domElement.ownerDocument.removeEventListener("pointermove",Y,!1),c.domElement.ownerDocument.removeEventListener("pointerup",Z,!1),!1!==c.enabled&&(c.dispatchEvent(p),f=m.NONE)}}function K(t){!1===c.enabled||!1===c.enableZoom||f!==m.NONE&&f!==m.ROTATE||(t.preventDefault(),t.stopPropagation(),c.dispatchEvent(u),function(t){t.deltaY<0?N(k()):t.deltaY>0&&O(k()),c.update()}(t),c.dispatchEvent(p))}function J(t){!1!==c.enabled&&!1!==c.enableKeys&&!1!==c.enablePan&&function(t){var e=!1;switch(t.keyCode){case c.keys.UP:z(0,c.keyPanSpeed),e=!0;break;case c.keys.BOTTOM:z(0,-c.keyPanSpeed),e=!0;break;case c.keys.LEFT:z(c.keyPanSpeed,0),e=!0;break;case c.keys.RIGHT:z(-c.keyPanSpeed,0),e=!0}e&&(t.preventDefault(),c.update())}(t)}function Q(t){if(!1!==c.enabled){switch(t.preventDefault(),t.touches.length){case 1:switch(c.touches.ONE){case s.ROTATE:if(!1===c.enableRotate)return;U(t),f=m.TOUCH_ROTATE;break;case s.PAN:if(!1===c.enablePan)return;V(t),f=m.TOUCH_PAN;break;default:f=m.NONE}break;case 2:switch(c.touches.TWO){case s.DOLLY_PAN:if(!1===c.enableZoom&&!1===c.enablePan)return;!function(t){c.enableZoom&&G(t),c.enablePan&&V(t)}(t),f=m.TOUCH_DOLLY_PAN;break;case s.DOLLY_ROTATE:if(!1===c.enableZoom&&!1===c.enableRotate)return;!function(t){c.enableZoom&&G(t),c.enableRotate&&U(t)}(t),f=m.TOUCH_DOLLY_ROTATE;break;default:f=m.NONE}break;default:f=m.NONE}f!==m.NONE&&c.dispatchEvent(u)}}function tt(t){if(!1!==c.enabled)switch(t.preventDefault(),t.stopPropagation(),f){case m.TOUCH_ROTATE:if(!1===c.enableRotate)return;j(t),c.update();break;case m.TOUCH_PAN:if(!1===c.enablePan)return;q(t),c.update();break;case m.TOUCH_DOLLY_PAN:if(!1===c.enableZoom&&!1===c.enablePan)return;!function(t){c.enableZoom&&$(t),c.enablePan&&q(t)}(t),c.update();break;case m.TOUCH_DOLLY_ROTATE:if(!1===c.enableZoom&&!1===c.enableRotate)return;!function(t){c.enableZoom&&$(t),c.enableRotate&&j(t)}(t),c.update();break;default:f=m.NONE}}function et(t){!1!==c.enabled&&(c.dispatchEvent(p),f=m.NONE)}function it(t){!1!==c.enabled&&t.preventDefault()}c.domElement.addEventListener("contextmenu",it,!1),c.domElement.addEventListener("pointerdown",X,!1),c.domElement.addEventListener("wheel",K,!1),c.domElement.addEventListener("touchstart",Q,!1),c.domElement.addEventListener("touchend",et,!1),c.domElement.addEventListener("touchmove",tt,!1),c.domElement.addEventListener("keydown",J,!1),this.update()};Od.prototype=Object.create(Je.prototype),Od.prototype.constructor=Od;var Nd=function(t,e){Od.call(this,t,e),this.screenSpacePanning=!1,this.mouseButtons.LEFT=i.PAN,this.mouseButtons.RIGHT=i.ROTATE,this.touches.ONE=s.PAN,this.touches.TWO=s.DOLLY_ROTATE};(Nd.prototype=Object.create(Je.prototype)).constructor=Nd;class Wd{constructor(t=[0,0,0,0,0,0,0,0,0]){this.elements=void 0,this.elements=t}identity(){const t=this.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1}setZero(){const t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0}setTrace(t){const e=this.elements;e[0]=t.x,e[4]=t.y,e[8]=t.z}getTrace(t=new Ud){const e=this.elements;return t.x=e[0],t.y=e[4],t.z=e[8],t}vmult(t,e=new Ud){const i=this.elements,s=t.x,n=t.y,o=t.z;return e.x=i[0]*s+i[1]*n+i[2]*o,e.y=i[3]*s+i[4]*n+i[5]*o,e.z=i[6]*s+i[7]*n+i[8]*o,e}smult(t){for(let e=0;e<this.elements.length;e++)this.elements[e]*=t}mmult(t,e=new Wd){const i=this.elements,s=t.elements,n=e.elements,o=i[0],r=i[1],a=i[2],h=i[3],l=i[4],c=i[5],d=i[6],u=i[7],p=i[8],m=s[0],f=s[1],g=s[2],y=s[3],v=s[4],w=s[5],x=s[6],b=s[7],S=s[8];return n[0]=o*m+r*y+a*x,n[1]=o*f+r*v+a*b,n[2]=o*g+r*w+a*S,n[3]=h*m+l*y+c*x,n[4]=h*f+l*v+c*b,n[5]=h*g+l*w+c*S,n[6]=d*m+u*y+p*x,n[7]=d*f+u*v+p*b,n[8]=d*g+u*w+p*S,e}scale(t,e=new Wd){const i=this.elements,s=e.elements;for(let e=0;3!==e;e++)s[3*e+0]=t.x*i[3*e+0],s[3*e+1]=t.y*i[3*e+1],s[3*e+2]=t.z*i[3*e+2];return e}solve(t,e=new Ud){const i=[];let s,n;for(s=0;s<12;s++)i.push(0);for(s=0;s<3;s++)for(n=0;n<3;n++)i[s+4*n]=this.elements[s+3*n];i[3]=t.x,i[7]=t.y,i[11]=t.z;let o=3;const r=o;let a,h;do{if(s=r-o,0===i[s+4*s])for(n=s+1;n<r;n++)if(0!==i[s+4*n]){a=4;do{h=4-a,i[h+4*s]+=i[h+4*n]}while(--a);break}if(0!==i[s+4*s])for(n=s+1;n<r;n++){const t=i[s+4*n]/i[s+4*s];a=4;do{h=4-a,i[h+4*n]=h<=s?0:i[h+4*n]-i[h+4*s]*t}while(--a)}}while(--o);if(e.z=i[11]/i[10],e.y=(i[7]-i[6]*e.z)/i[5],e.x=(i[3]-i[2]*e.z-i[1]*e.y)/i[0],isNaN(e.x)||isNaN(e.y)||isNaN(e.z)||e.x===1/0||e.y===1/0||e.z===1/0)throw"Could not solve equation! Got x=["+e.toString()+"], b=["+t.toString()+"], A=["+this.toString()+"]";return e}e(t,e,i){if(void 0===i)return this.elements[e+3*t];this.elements[e+3*t]=i}copy(t){for(let e=0;e<t.elements.length;e++)this.elements[e]=t.elements[e];return this}toString(){let t="";for(let e=0;e<9;e++)t+=this.elements[e]+",";return t}reverse(t=new Wd){const e=Hd;let i,s;for(i=0;i<3;i++)for(s=0;s<3;s++)e[i+6*s]=this.elements[i+3*s];e[3]=1,e[9]=0,e[15]=0,e[4]=0,e[10]=1,e[16]=0,e[5]=0,e[11]=0,e[17]=1;let n=3;const o=n;let r,a;do{if(i=o-n,0===e[i+6*i])for(s=i+1;s<o;s++)if(0!==e[i+6*s]){r=6;do{a=6-r,e[a+6*i]+=e[a+6*s]}while(--r);break}if(0!==e[i+6*i])for(s=i+1;s<o;s++){const t=e[i+6*s]/e[i+6*i];r=6;do{a=6-r,e[a+6*s]=a<=i?0:e[a+6*s]-e[a+6*i]*t}while(--r)}}while(--n);i=2;do{s=i-1;do{const t=e[i+6*s]/e[i+6*i];r=6;do{a=6-r,e[a+6*s]=e[a+6*s]-e[a+6*i]*t}while(--r)}while(s--)}while(--i);i=2;do{const t=1/e[i+6*i];r=6;do{a=6-r,e[a+6*i]=e[a+6*i]*t}while(--r)}while(i--);i=2;do{s=2;do{if(a=e[3+s+6*i],isNaN(a)||a===1/0)throw"Could not reverse! A=["+this.toString()+"]";t.e(i,s,a)}while(s--)}while(i--);return t}setRotationFromQuaternion(t){const e=t.x,i=t.y,s=t.z,n=t.w,o=e+e,r=i+i,a=s+s,h=e*o,l=e*r,c=e*a,d=i*r,u=i*a,p=s*a,m=n*o,f=n*r,g=n*a,y=this.elements;return y[0]=1-(d+p),y[1]=l-g,y[2]=c+f,y[3]=l+g,y[4]=1-(h+p),y[5]=u-m,y[6]=c-f,y[7]=u+m,y[8]=1-(h+d),this}transpose(t=new Wd){const e=this.elements,i=t.elements;let s;return i[0]=e[0],i[4]=e[4],i[8]=e[8],s=e[1],i[1]=e[3],i[3]=s,s=e[2],i[2]=e[6],i[6]=s,s=e[5],i[5]=e[7],i[7]=s,t}}const Hd=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];class Ud{constructor(t=0,e=0,i=0){this.x=void 0,this.y=void 0,this.z=void 0,this.x=t,this.y=e,this.z=i}cross(t,e=new Ud){const i=t.x,s=t.y,n=t.z,o=this.x,r=this.y,a=this.z;return e.x=r*n-a*s,e.y=a*i-o*n,e.z=o*s-r*i,e}set(t,e,i){return this.x=t,this.y=e,this.z=i,this}setZero(){this.x=this.y=this.z=0}vadd(t,e){if(!e)return new Ud(this.x+t.x,this.y+t.y,this.z+t.z);e.x=t.x+this.x,e.y=t.y+this.y,e.z=t.z+this.z}vsub(t,e){if(!e)return new Ud(this.x-t.x,this.y-t.y,this.z-t.z);e.x=this.x-t.x,e.y=this.y-t.y,e.z=this.z-t.z}crossmat(){return new Wd([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])}normalize(){const t=this.x,e=this.y,i=this.z,s=Math.sqrt(t*t+e*e+i*i);if(s>0){const t=1/s;this.x*=t,this.y*=t,this.z*=t}else this.x=0,this.y=0,this.z=0;return s}unit(t=new Ud){const e=this.x,i=this.y,s=this.z;let n=Math.sqrt(e*e+i*i+s*s);return n>0?(n=1/n,t.x=e*n,t.y=i*n,t.z=s*n):(t.x=1,t.y=0,t.z=0),t}length(){const t=this.x,e=this.y,i=this.z;return Math.sqrt(t*t+e*e+i*i)}lengthSquared(){return this.dot(this)}distanceTo(t){const e=this.x,i=this.y,s=this.z,n=t.x,o=t.y,r=t.z;return Math.sqrt((n-e)*(n-e)+(o-i)*(o-i)+(r-s)*(r-s))}distanceSquared(t){const e=this.x,i=this.y,s=this.z,n=t.x,o=t.y,r=t.z;return(n-e)*(n-e)+(o-i)*(o-i)+(r-s)*(r-s)}scale(t,e=new Ud){const i=this.x,s=this.y,n=this.z;return e.x=t*i,e.y=t*s,e.z=t*n,e}vmul(t,e=new Ud){return e.x=t.x*this.x,e.y=t.y*this.y,e.z=t.z*this.z,e}addScaledVector(t,e,i=new Ud){return i.x=this.x+t*e.x,i.y=this.y+t*e.y,i.z=this.z+t*e.z,i}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}isZero(){return 0===this.x&&0===this.y&&0===this.z}negate(t=new Ud){return t.x=-this.x,t.y=-this.y,t.z=-this.z,t}tangents(t,e){const i=this.length();if(i>0){const s=Vd,n=1/i;s.set(this.x*n,this.y*n,this.z*n);const o=Gd;Math.abs(s.x)<.9?(o.set(1,0,0),s.cross(o,t)):(o.set(0,1,0),s.cross(o,t)),s.cross(t,e)}else t.set(1,0,0),e.set(0,1,0)}toString(){return this.x+","+this.y+","+this.z}toArray(){return[this.x,this.y,this.z]}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}lerp(t,e,i){const s=this.x,n=this.y,o=this.z;i.x=s+(t.x-s)*e,i.y=n+(t.y-n)*e,i.z=o+(t.z-o)*e}almostEquals(t,e=1e-6){return!(Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e)}almostZero(t=1e-6){return!(Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t)}isAntiparallelTo(t,e){return this.negate(jd),jd.almostEquals(t,e)}clone(){return new Ud(this.x,this.y,this.z)}}Ud.ZERO=void 0,Ud.UNIT_X=void 0,Ud.UNIT_Y=void 0,Ud.UNIT_Z=void 0,Ud.ZERO=new Ud(0,0,0),Ud.UNIT_X=new Ud(1,0,0),Ud.UNIT_Y=new Ud(0,1,0),Ud.UNIT_Z=new Ud(0,0,1);const Vd=new Ud,Gd=new Ud,jd=new Ud;class qd{constructor(t={}){this.lowerBound=void 0,this.upperBound=void 0,this.lowerBound=new Ud,this.upperBound=new Ud,t.lowerBound&&this.lowerBound.copy(t.lowerBound),t.upperBound&&this.upperBound.copy(t.upperBound)}setFromPoints(t,e,i,s){const n=this.lowerBound,o=this.upperBound,r=i;n.copy(t[0]),r&&r.vmult(n,n),o.copy(n);for(let e=1;e<t.length;e++){let i=t[e];r&&(r.vmult(i,$d),i=$d),i.x>o.x&&(o.x=i.x),i.x<n.x&&(n.x=i.x),i.y>o.y&&(o.y=i.y),i.y<n.y&&(n.y=i.y),i.z>o.z&&(o.z=i.z),i.z<n.z&&(n.z=i.z)}return e&&(e.vadd(n,n),e.vadd(o,o)),s&&(n.x-=s,n.y-=s,n.z-=s,o.x+=s,o.y+=s,o.z+=s),this}copy(t){return this.lowerBound.copy(t.lowerBound),this.upperBound.copy(t.upperBound),this}clone(){return(new qd).copy(this)}extend(t){this.lowerBound.x=Math.min(this.lowerBound.x,t.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,t.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,t.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,t.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,t.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,t.upperBound.z)}overlaps(t){const e=this.lowerBound,i=this.upperBound,s=t.lowerBound,n=t.upperBound,o=s.x<=i.x&&i.x<=n.x||e.x<=n.x&&n.x<=i.x,r=s.y<=i.y&&i.y<=n.y||e.y<=n.y&&n.y<=i.y,a=s.z<=i.z&&i.z<=n.z||e.z<=n.z&&n.z<=i.z;return o&&r&&a}volume(){const t=this.lowerBound,e=this.upperBound;return(e.x-t.x)*(e.y-t.y)*(e.z-t.z)}contains(t){const e=this.lowerBound,i=this.upperBound,s=t.lowerBound,n=t.upperBound;return e.x<=s.x&&i.x>=n.x&&e.y<=s.y&&i.y>=n.y&&e.z<=s.z&&i.z>=n.z}getCorners(t,e,i,s,n,o,r,a){const h=this.lowerBound,l=this.upperBound;t.copy(h),e.set(l.x,h.y,h.z),i.set(l.x,l.y,h.z),s.set(h.x,l.y,l.z),n.set(l.x,h.y,l.z),o.set(h.x,l.y,h.z),r.set(h.x,h.y,l.z),a.copy(l)}toLocalFrame(t,e){const i=Xd,s=i[0],n=i[1],o=i[2],r=i[3],a=i[4],h=i[5],l=i[6],c=i[7];this.getCorners(s,n,o,r,a,h,l,c);for(let e=0;8!==e;e++){const s=i[e];t.pointToLocal(s,s)}return e.setFromPoints(i)}toWorldFrame(t,e){const i=Xd,s=i[0],n=i[1],o=i[2],r=i[3],a=i[4],h=i[5],l=i[6],c=i[7];this.getCorners(s,n,o,r,a,h,l,c);for(let e=0;8!==e;e++){const s=i[e];t.pointToWorld(s,s)}return e.setFromPoints(i)}overlapsRay(t){const{direction:e,from:i}=t,s=1/e.x,n=1/e.y,o=1/e.z,r=(this.lowerBound.x-i.x)*s,a=(this.upperBound.x-i.x)*s,h=(this.lowerBound.y-i.y)*n,l=(this.upperBound.y-i.y)*n,c=(this.lowerBound.z-i.z)*o,d=(this.upperBound.z-i.z)*o,u=Math.max(Math.max(Math.min(r,a),Math.min(h,l)),Math.min(c,d)),p=Math.min(Math.min(Math.max(r,a),Math.max(h,l)),Math.max(c,d));return!(p<0||u>p)}}const $d=new Ud,Xd=[new Ud,new Ud,new Ud,new Ud,new Ud,new Ud,new Ud,new Ud];class Yd{constructor(){this.matrix=void 0,this.matrix=[]}get(t,e){let{index:i}=t,{index:s}=e;if(s>i){const t=s;s=i,i=t}return this.matrix[(i*(i+1)>>1)+s-1]}set(t,e,i){let{index:s}=t,{index:n}=e;if(n>s){const t=n;n=s,s=t}this.matrix[(s*(s+1)>>1)+n-1]=i?1:0}reset(){for(let t=0,e=this.matrix.length;t!==e;t++)this.matrix[t]=0}setNumObjects(t){this.matrix.length=t*(t-1)>>1}}class Zd{constructor(){this._listeners=void 0}addEventListener(t,e){void 0===this._listeners&&(this._listeners={});const i=this._listeners;return void 0===i[t]&&(i[t]=[]),i[t].includes(e)||i[t].push(e),this}hasEventListener(t,e){if(void 0===this._listeners)return!1;const i=this._listeners;return!(void 0===i[t]||!i[t].includes(e))}hasAnyEventListener(t){return void 0!==this._listeners&&void 0!==this._listeners[t]}removeEventListener(t,e){if(void 0===this._listeners)return this;const i=this._listeners;if(void 0===i[t])return this;const s=i[t].indexOf(e);return-1!==s&&i[t].splice(s,1),this}dispatchEvent(t){if(void 0===this._listeners)return this;const e=this._listeners[t.type];if(void 0!==e){t.target=this;for(let i=0,s=e.length;i<s;i++)e[i].call(this,t)}return this}}class Kd{constructor(t=0,e=0,i=0,s=1){this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,this.x=t,this.y=e,this.z=i,this.w=s}set(t,e,i,s){return this.x=t,this.y=e,this.z=i,this.w=s,this}toString(){return this.x+","+this.y+","+this.z+","+this.w}toArray(){return[this.x,this.y,this.z,this.w]}setFromAxisAngle(t,e){const i=Math.sin(.5*e);return this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=Math.cos(.5*e),this}toAxisAngle(t=new Ud){this.normalize();const e=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(t.x=this.x,t.y=this.y,t.z=this.z):(t.x=this.x/i,t.y=this.y/i,t.z=this.z/i),[t,e]}setFromVectors(t,e){if(t.isAntiparallelTo(e)){const e=Jd,i=Qd;t.tangents(e,i),this.setFromAxisAngle(e,Math.PI)}else{const i=t.cross(e);this.x=i.x,this.y=i.y,this.z=i.z,this.w=Math.sqrt(t.length()**2*e.length()**2)+t.dot(e),this.normalize()}return this}mult(t,e=new Kd){const i=this.x,s=this.y,n=this.z,o=this.w,r=t.x,a=t.y,h=t.z,l=t.w;return e.x=i*l+o*r+s*h-n*a,e.y=s*l+o*a+n*r-i*h,e.z=n*l+o*h+i*a-s*r,e.w=o*l-i*r-s*a-n*h,e}inverse(t=new Kd){const e=this.x,i=this.y,s=this.z,n=this.w;this.conjugate(t);const o=1/(e*e+i*i+s*s+n*n);return t.x*=o,t.y*=o,t.z*=o,t.w*=o,t}conjugate(t=new Kd){return t.x=-this.x,t.y=-this.y,t.z=-this.z,t.w=this.w,t}normalize(){let t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this}normalizeFast(){const t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t),this}vmult(t,e=new Ud){const i=t.x,s=t.y,n=t.z,o=this.x,r=this.y,a=this.z,h=this.w,l=h*i+r*n-a*s,c=h*s+a*i-o*n,d=h*n+o*s-r*i,u=-o*i-r*s-a*n;return e.x=l*h+u*-o+c*-a-d*-r,e.y=c*h+u*-r+d*-o-l*-a,e.z=d*h+u*-a+l*-r-c*-o,e}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}toEuler(t,e="YZX"){let i,s,n;const o=this.x,r=this.y,a=this.z,h=this.w;if("YZX"!==e)throw new Error("Euler order "+e+" not supported yet.");{const t=o*r+a*h;if(t>.499&&(i=2*Math.atan2(o,h),s=Math.PI/2,n=0),t<-.499&&(i=-2*Math.atan2(o,h),s=-Math.PI/2,n=0),void 0===i){const e=o*o,l=r*r,c=a*a;i=Math.atan2(2*r*h-2*o*a,1-2*l-2*c),s=Math.asin(2*t),n=Math.atan2(2*o*h-2*r*a,1-2*e-2*c)}}t.y=i,t.z=s,t.x=n}setFromEuler(t,e,i,s="XYZ"){const n=Math.cos(t/2),o=Math.cos(e/2),r=Math.cos(i/2),a=Math.sin(t/2),h=Math.sin(e/2),l=Math.sin(i/2);return"XYZ"===s?(this.x=a*o*r+n*h*l,this.y=n*h*r-a*o*l,this.z=n*o*l+a*h*r,this.w=n*o*r-a*h*l):"YXZ"===s?(this.x=a*o*r+n*h*l,this.y=n*h*r-a*o*l,this.z=n*o*l-a*h*r,this.w=n*o*r+a*h*l):"ZXY"===s?(this.x=a*o*r-n*h*l,this.y=n*h*r+a*o*l,this.z=n*o*l+a*h*r,this.w=n*o*r-a*h*l):"ZYX"===s?(this.x=a*o*r-n*h*l,this.y=n*h*r+a*o*l,this.z=n*o*l-a*h*r,this.w=n*o*r+a*h*l):"YZX"===s?(this.x=a*o*r+n*h*l,this.y=n*h*r+a*o*l,this.z=n*o*l-a*h*r,this.w=n*o*r-a*h*l):"XZY"===s&&(this.x=a*o*r-n*h*l,this.y=n*h*r-a*o*l,this.z=n*o*l+a*h*r,this.w=n*o*r+a*h*l),this}clone(){return new Kd(this.x,this.y,this.z,this.w)}slerp(t,e,i=new Kd){const s=this.x,n=this.y,o=this.z,r=this.w;let a,h,l,c,d,u=t.x,p=t.y,m=t.z,f=t.w;return h=s*u+n*p+o*m+r*f,h<0&&(h=-h,u=-u,p=-p,m=-m,f=-f),1-h>1e-6?(a=Math.acos(h),l=Math.sin(a),c=Math.sin((1-e)*a)/l,d=Math.sin(e*a)/l):(c=1-e,d=e),i.x=c*s+d*u,i.y=c*n+d*p,i.z=c*o+d*m,i.w=c*r+d*f,i}integrate(t,e,i,s=new Kd){const n=t.x*i.x,o=t.y*i.y,r=t.z*i.z,a=this.x,h=this.y,l=this.z,c=this.w,d=.5*e;return s.x+=d*(n*c+o*l-r*h),s.y+=d*(o*c+r*a-n*l),s.z+=d*(r*c+n*h-o*a),s.w+=d*(-n*a-o*h-r*l),s}}const Jd=new Ud,Qd=new Ud;class tu{constructor(t={}){this.id=void 0,this.type=void 0,this.boundingSphereRadius=void 0,this.collisionResponse=void 0,this.collisionFilterGroup=void 0,this.collisionFilterMask=void 0,this.material=void 0,this.body=void 0,this.id=tu.idCounter++,this.type=t.type||0,this.boundingSphereRadius=0,this.collisionResponse=!t.collisionResponse||t.collisionResponse,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:1,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.material=t.material?t.material:null,this.body=null}updateBoundingSphereRadius(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type}volume(){throw"volume() not implemented for shape type "+this.type}calculateLocalInertia(t,e){throw"calculateLocalInertia() not implemented for shape type "+this.type}calculateWorldAABB(t,e,i,s){throw"calculateWorldAABB() not implemented for shape type "+this.type}}tu.idCounter=0,tu.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256};class eu{constructor(t={}){this.position=void 0,this.quaternion=void 0,this.position=new Ud,this.quaternion=new Kd,t.position&&this.position.copy(t.position),t.quaternion&&this.quaternion.copy(t.quaternion)}pointToLocal(t,e){return eu.pointToLocalFrame(this.position,this.quaternion,t,e)}pointToWorld(t,e){return eu.pointToWorldFrame(this.position,this.quaternion,t,e)}vectorToWorldFrame(t,e=new Ud){return this.quaternion.vmult(t,e),e}static pointToLocalFrame(t,e,i,s=new Ud){return i.vsub(t,s),e.conjugate(iu),iu.vmult(s,s),s}static pointToWorldFrame(t,e,i,s=new Ud){return e.vmult(i,s),s.vadd(t,s),s}static vectorToWorldFrame(t,e,i=new Ud){return t.vmult(e,i),i}static vectorToLocalFrame(t,e,i,s=new Ud){return e.w*=-1,e.vmult(i,s),e.w*=-1,s}}const iu=new Kd;class su extends tu{constructor(t={}){const{vertices:e=[],faces:i=[],normals:s=[],axes:n,boundingSphereRadius:o}=t;super({type:tu.types.CONVEXPOLYHEDRON}),this.vertices=void 0,this.faces=void 0,this.faceNormals=void 0,this.worldVertices=void 0,this.worldVerticesNeedsUpdate=void 0,this.worldFaceNormals=void 0,this.worldFaceNormalsNeedsUpdate=void 0,this.uniqueAxes=void 0,this.uniqueEdges=void 0,this.vertices=e,this.faces=i,this.faceNormals=s,0===this.faceNormals.length&&this.computeNormals(),o?this.boundingSphereRadius=o:this.updateBoundingSphereRadius(),this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.worldFaceNormals=[],this.worldFaceNormalsNeedsUpdate=!0,this.uniqueAxes=n?n.slice():null,this.uniqueEdges=[],this.computeEdges()}computeEdges(){const t=this.faces,e=this.vertices,i=this.uniqueEdges;i.length=0;const s=new Ud;for(let n=0;n!==t.length;n++){const o=t[n],r=o.length;for(let t=0;t!==r;t++){const n=(t+1)%r;e[o[t]].vsub(e[o[n]],s),s.normalize();let a=!1;for(let t=0;t!==i.length;t++)if(i[t].almostEquals(s)||i[t].almostEquals(s)){a=!0;break}a||i.push(s.clone())}}}computeNormals(){this.faceNormals.length=this.faces.length;for(let t=0;t<this.faces.length;t++){for(let e=0;e<this.faces[t].length;e++)if(!this.vertices[this.faces[t][e]])throw new Error("Vertex "+this.faces[t][e]+" not found!");const e=this.faceNormals[t]||new Ud;this.getFaceNormal(t,e),e.negate(e),this.faceNormals[t]=e;const i=this.vertices[this.faces[t][0]];if(e.dot(i)<0){console.error(".faceNormals["+t+"] = Vec3("+e.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(let e=0;e<this.faces[t].length;e++)console.warn(".vertices["+this.faces[t][e]+"] = Vec3("+this.vertices[this.faces[t][e]].toString()+")")}}}getFaceNormal(t,e){const i=this.faces[t],s=this.vertices[i[0]],n=this.vertices[i[1]],o=this.vertices[i[2]];su.computeNormal(s,n,o,e)}static computeNormal(t,e,i,s){const n=new Ud,o=new Ud;e.vsub(t,o),i.vsub(e,n),n.cross(o,s),s.isZero()||s.normalize()}clipAgainstHull(t,e,i,s,n,o,r,a,h){const l=new Ud;let c=-1,d=-Number.MAX_VALUE;for(let t=0;t<i.faces.length;t++){l.copy(i.faceNormals[t]),n.vmult(l,l);const e=l.dot(o);e>d&&(d=e,c=t)}const u=[];for(let t=0;t<i.faces[c].length;t++){const e=i.vertices[i.faces[c][t]],o=new Ud;o.copy(e),n.vmult(o,o),s.vadd(o,o),u.push(o)}c>=0&&this.clipFaceAgainstHull(o,t,e,u,r,a,h)}findSeparatingAxis(t,e,i,s,n,o,r,a){const h=new Ud,l=new Ud,c=new Ud,d=new Ud,u=new Ud,p=new Ud;let m=Number.MAX_VALUE;const f=this;if(f.uniqueAxes)for(let r=0;r!==f.uniqueAxes.length;r++){i.vmult(f.uniqueAxes[r],h);const a=f.testSepAxis(h,t,e,i,s,n);if(!1===a)return!1;a<m&&(m=a,o.copy(h))}else{const a=r?r.length:f.faces.length;for(let l=0;l<a;l++){const a=r?r[l]:l;h.copy(f.faceNormals[a]),i.vmult(h,h);const c=f.testSepAxis(h,t,e,i,s,n);if(!1===c)return!1;c<m&&(m=c,o.copy(h))}}if(t.uniqueAxes)for(let r=0;r!==t.uniqueAxes.length;r++){n.vmult(t.uniqueAxes[r],l);const a=f.testSepAxis(l,t,e,i,s,n);if(!1===a)return!1;a<m&&(m=a,o.copy(l))}else{const r=a?a.length:t.faces.length;for(let h=0;h<r;h++){const r=a?a[h]:h;l.copy(t.faceNormals[r]),n.vmult(l,l);const c=f.testSepAxis(l,t,e,i,s,n);if(!1===c)return!1;c<m&&(m=c,o.copy(l))}}for(let r=0;r!==f.uniqueEdges.length;r++){i.vmult(f.uniqueEdges[r],d);for(let r=0;r!==t.uniqueEdges.length;r++)if(n.vmult(t.uniqueEdges[r],u),d.cross(u,p),!p.almostZero()){p.normalize();const r=f.testSepAxis(p,t,e,i,s,n);if(!1===r)return!1;r<m&&(m=r,o.copy(p))}}return s.vsub(e,c),c.dot(o)>0&&o.negate(o),!0}testSepAxis(t,e,i,s,n,o){su.project(this,t,i,s,nu),su.project(e,t,n,o,ou);const r=nu[0],a=nu[1],h=ou[0],l=ou[1];if(r<l||h<a)return!1;const c=r-l,d=h-a;return c<d?c:d}calculateLocalInertia(t,e){const i=new Ud,s=new Ud;this.computeLocalAABB(s,i);const n=i.x-s.x,o=i.y-s.y,r=i.z-s.z;e.x=1/12*t*(2*o*2*o+2*r*2*r),e.y=1/12*t*(2*n*2*n+2*r*2*r),e.z=1/12*t*(2*o*2*o+2*n*2*n)}getPlaneConstantOfFace(t){const e=this.faces[t],i=this.faceNormals[t],s=this.vertices[e[0]];return-i.dot(s)}clipFaceAgainstHull(t,e,i,s,n,o,r){const a=new Ud,h=new Ud,l=new Ud,c=new Ud,d=new Ud,u=new Ud,p=new Ud,m=new Ud,f=this,g=s,y=[];let v=-1,w=Number.MAX_VALUE;for(let e=0;e<f.faces.length;e++){a.copy(f.faceNormals[e]),i.vmult(a,a);const s=a.dot(t);s<w&&(w=s,v=e)}if(v<0)return;const x=f.faces[v];x.connectedFaces=[];for(let t=0;t<f.faces.length;t++)for(let e=0;e<f.faces[t].length;e++)-1!==x.indexOf(f.faces[t][e])&&t!==v&&-1===x.connectedFaces.indexOf(t)&&x.connectedFaces.push(t);const b=x.length;for(let t=0;t<b;t++){const s=f.vertices[x[t]],n=f.vertices[x[(t+1)%b]];s.vsub(n,h),l.copy(h),i.vmult(l,l),e.vadd(l,l),c.copy(this.faceNormals[v]),i.vmult(c,c),e.vadd(c,c),l.cross(c,d),d.negate(d),u.copy(s),i.vmult(u,u),e.vadd(u,u);const o=x.connectedFaces[t];p.copy(this.faceNormals[o]);const r=this.getPlaneConstantOfFace(o);m.copy(p),i.vmult(m,m);const a=r-m.dot(e);for(this.clipFaceAgainstPlane(g,y,m,a);g.length;)g.shift();for(;y.length;)g.push(y.shift())}p.copy(this.faceNormals[v]);const S=this.getPlaneConstantOfFace(v);m.copy(p),i.vmult(m,m);const M=S-m.dot(e);for(let t=0;t<g.length;t++){let e=m.dot(g[t])+M;if(e<=n&&(console.log("clamped: depth="+e+" to minDist="+n),e=n),e<=o){const i=g[t];if(e<=1e-6){const t={point:i,normal:m,depth:e};r.push(t)}}}}clipFaceAgainstPlane(t,e,i,s){let n,o;const r=t.length;if(r<2)return e;let a=t[t.length-1],h=t[0];n=i.dot(a)+s;for(let l=0;l<r;l++){if(h=t[l],o=i.dot(h)+s,n<0)if(o<0){const t=new Ud;t.copy(h),e.push(t)}else{const t=new Ud;a.lerp(h,n/(n-o),t),e.push(t)}else if(o<0){const t=new Ud;a.lerp(h,n/(n-o),t),e.push(t),e.push(h)}a=h,n=o}return e}computeWorldVertices(t,e){for(;this.worldVertices.length<this.vertices.length;)this.worldVertices.push(new Ud);const i=this.vertices,s=this.worldVertices;for(let n=0;n!==this.vertices.length;n++)e.vmult(i[n],s[n]),t.vadd(s[n],s[n]);this.worldVerticesNeedsUpdate=!1}computeLocalAABB(t,e){const i=this.vertices;t.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),e.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let s=0;s<this.vertices.length;s++){const n=i[s];n.x<t.x?t.x=n.x:n.x>e.x&&(e.x=n.x),n.y<t.y?t.y=n.y:n.y>e.y&&(e.y=n.y),n.z<t.z?t.z=n.z:n.z>e.z&&(e.z=n.z)}}computeWorldFaceNormals(t){const e=this.faceNormals.length;for(;this.worldFaceNormals.length<e;)this.worldFaceNormals.push(new Ud);const i=this.faceNormals,s=this.worldFaceNormals;for(let n=0;n!==e;n++)t.vmult(i[n],s[n]);this.worldFaceNormalsNeedsUpdate=!1}updateBoundingSphereRadius(){let t=0;const e=this.vertices;for(let i=0;i!==e.length;i++){const s=e[i].lengthSquared();s>t&&(t=s)}this.boundingSphereRadius=Math.sqrt(t)}calculateWorldAABB(t,e,i,s){const n=this.vertices;let o,r,a,h,l,c,d=new Ud;for(let i=0;i<n.length;i++){d.copy(n[i]),e.vmult(d,d),t.vadd(d,d);const s=d;(void 0===o||s.x<o)&&(o=s.x),(void 0===h||s.x>h)&&(h=s.x),(void 0===r||s.y<r)&&(r=s.y),(void 0===l||s.y>l)&&(l=s.y),(void 0===a||s.z<a)&&(a=s.z),(void 0===c||s.z>c)&&(c=s.z)}i.set(o,r,a),s.set(h,l,c)}volume(){return 4*Math.PI*this.boundingSphereRadius/3}getAveragePointLocal(t=new Ud){const e=this.vertices;for(let i=0;i<e.length;i++)t.vadd(e[i],t);return t.scale(1/e.length,t),t}transformAllPoints(t,e){const i=this.vertices.length,s=this.vertices;if(e){for(let t=0;t<i;t++){const i=s[t];e.vmult(i,i)}for(let t=0;t<this.faceNormals.length;t++){const i=this.faceNormals[t];e.vmult(i,i)}}if(t)for(let e=0;e<i;e++){const i=s[e];i.vadd(t,i)}}pointIsInside(t){const e=this.vertices,i=this.faces,s=this.faceNormals,n=new Ud;this.getAveragePointLocal(n);for(let o=0;o<this.faces.length;o++){let r=s[o];const a=e[i[o][0]],h=new Ud;t.vsub(a,h);const l=r.dot(h),c=new Ud;n.vsub(a,c);const d=r.dot(c);if(l<0&&d>0||l>0&&d<0)return!1}return-1}static project(t,e,i,s,n){const o=t.vertices.length,r=ru;let a=0,h=0;const l=au,c=t.vertices;l.setZero(),eu.vectorToLocalFrame(i,s,e,r),eu.pointToLocalFrame(i,s,l,l);const d=l.dot(r);h=a=c[0].dot(r);for(let t=1;t<o;t++){const e=c[t].dot(r);e>a&&(a=e),e<h&&(h=e)}if(h-=d,a-=d,h>a){const t=h;h=a,a=t}n[0]=a,n[1]=h}}const nu=[],ou=[],ru=new Ud,au=new Ud;class hu extends tu{constructor(t){super({type:tu.types.BOX}),this.halfExtents=void 0,this.convexPolyhedronRepresentation=void 0,this.halfExtents=t,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}updateConvexPolyhedronRepresentation(){const t=this.halfExtents.x,e=this.halfExtents.y,i=this.halfExtents.z,s=Ud,n=[new s(-t,-e,-i),new s(t,-e,-i),new s(t,e,-i),new s(-t,e,-i),new s(-t,-e,i),new s(t,-e,i),new s(t,e,i),new s(-t,e,i)],o=[new s(0,0,1),new s(0,1,0),new s(1,0,0)],r=new su({vertices:n,faces:[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],axes:o});this.convexPolyhedronRepresentation=r,r.material=this.material}calculateLocalInertia(t,e=new Ud){return hu.calculateInertia(this.halfExtents,t,e),e}static calculateInertia(t,e,i){const s=t;i.x=1/12*e*(2*s.y*2*s.y+2*s.z*2*s.z),i.y=1/12*e*(2*s.x*2*s.x+2*s.z*2*s.z),i.z=1/12*e*(2*s.y*2*s.y+2*s.x*2*s.x)}getSideNormals(t,e){const i=t,s=this.halfExtents;if(i[0].set(s.x,0,0),i[1].set(0,s.y,0),i[2].set(0,0,s.z),i[3].set(-s.x,0,0),i[4].set(0,-s.y,0),i[5].set(0,0,-s.z),void 0!==e)for(let t=0;t!==i.length;t++)e.vmult(i[t],i[t]);return i}volume(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z}updateBoundingSphereRadius(){this.boundingSphereRadius=this.halfExtents.length()}forEachWorldCorner(t,e,i){const s=this.halfExtents,n=[[s.x,s.y,s.z],[-s.x,s.y,s.z],[-s.x,-s.y,s.z],[-s.x,-s.y,-s.z],[s.x,-s.y,-s.z],[s.x,s.y,-s.z],[-s.x,s.y,-s.z],[s.x,-s.y,s.z]];for(let s=0;s<n.length;s++)lu.set(n[s][0],n[s][1],n[s][2]),e.vmult(lu,lu),t.vadd(lu,lu),i(lu.x,lu.y,lu.z)}calculateWorldAABB(t,e,i,s){const n=this.halfExtents;cu[0].set(n.x,n.y,n.z),cu[1].set(-n.x,n.y,n.z),cu[2].set(-n.x,-n.y,n.z),cu[3].set(-n.x,-n.y,-n.z),cu[4].set(n.x,-n.y,-n.z),cu[5].set(n.x,n.y,-n.z),cu[6].set(-n.x,n.y,-n.z),cu[7].set(n.x,-n.y,n.z);const o=cu[0];e.vmult(o,o),t.vadd(o,o),s.copy(o),i.copy(o);for(let n=1;n<8;n++){const o=cu[n];e.vmult(o,o),t.vadd(o,o);const r=o.x,a=o.y,h=o.z;r>s.x&&(s.x=r),a>s.y&&(s.y=a),h>s.z&&(s.z=h),r<i.x&&(i.x=r),a<i.y&&(i.y=a),h<i.z&&(i.z=h)}}}const lu=new Ud,cu=[new Ud,new Ud,new Ud,new Ud,new Ud,new Ud,new Ud,new Ud];class du extends Zd{constructor(t={}){super(),this.id=void 0,this.index=void 0,this.world=void 0,this.preStep=void 0,this.postStep=void 0,this.vlambda=void 0,this.collisionFilterGroup=void 0,this.collisionFilterMask=void 0,this.collisionResponse=void 0,this.position=void 0,this.previousPosition=void 0,this.interpolatedPosition=void 0,this.initPosition=void 0,this.velocity=void 0,this.initVelocity=void 0,this.force=void 0,this.mass=void 0,this.invMass=void 0,this.material=void 0,this.linearDamping=void 0,this.type=void 0,this.allowSleep=void 0,this.sleepState=void 0,this.sleepSpeedLimit=void 0,this.sleepTimeLimit=void 0,this.timeLastSleepy=void 0,this.wakeUpAfterNarrowphase=void 0,this.torque=void 0,this.quaternion=void 0,this.initQuaternion=void 0,this.previousQuaternion=void 0,this.interpolatedQuaternion=void 0,this.angularVelocity=void 0,this.initAngularVelocity=void 0,this.shapes=void 0,this.shapeOffsets=void 0,this.shapeOrientations=void 0,this.inertia=void 0,this.invInertia=void 0,this.invInertiaWorld=void 0,this.invMassSolve=void 0,this.invInertiaSolve=void 0,this.invInertiaWorldSolve=void 0,this.fixedRotation=void 0,this.angularDamping=void 0,this.linearFactor=void 0,this.angularFactor=void 0,this.aabb=void 0,this.aabbNeedsUpdate=void 0,this.boundingRadius=void 0,this.wlambda=void 0,this.isTrigger=void 0,this.id=du.idCounter++,this.index=-1,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new Ud,this.collisionFilterGroup="number"==typeof t.collisionFilterGroup?t.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionResponse="boolean"!=typeof t.collisionResponse||t.collisionResponse,this.position=new Ud,this.previousPosition=new Ud,this.interpolatedPosition=new Ud,this.initPosition=new Ud,t.position&&(this.position.copy(t.position),this.previousPosition.copy(t.position),this.interpolatedPosition.copy(t.position),this.initPosition.copy(t.position)),this.velocity=new Ud,t.velocity&&this.velocity.copy(t.velocity),this.initVelocity=new Ud,this.force=new Ud;const e="number"==typeof t.mass?t.mass:0;this.mass=e,this.invMass=e>0?1/e:0,this.material=t.material||null,this.linearDamping="number"==typeof t.linearDamping?t.linearDamping:.01,this.type=e<=0?du.STATIC:du.DYNAMIC,typeof t.type==typeof du.STATIC&&(this.type=t.type),this.allowSleep=void 0===t.allowSleep||t.allowSleep,this.sleepState=du.AWAKE,this.sleepSpeedLimit=void 0!==t.sleepSpeedLimit?t.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==t.sleepTimeLimit?t.sleepTimeLimit:1,this.timeLastSleepy=0,this.wakeUpAfterNarrowphase=!1,this.torque=new Ud,this.quaternion=new Kd,this.initQuaternion=new Kd,this.previousQuaternion=new Kd,this.interpolatedQuaternion=new Kd,t.quaternion&&(this.quaternion.copy(t.quaternion),this.initQuaternion.copy(t.quaternion),this.previousQuaternion.copy(t.quaternion),this.interpolatedQuaternion.copy(t.quaternion)),this.angularVelocity=new Ud,t.angularVelocity&&this.angularVelocity.copy(t.angularVelocity),this.initAngularVelocity=new Ud,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new Ud,this.invInertia=new Ud,this.invInertiaWorld=new Wd,this.invMassSolve=0,this.invInertiaSolve=new Ud,this.invInertiaWorldSolve=new Wd,this.fixedRotation=void 0!==t.fixedRotation&&t.fixedRotation,this.angularDamping=void 0!==t.angularDamping?t.angularDamping:.01,this.linearFactor=new Ud(1,1,1),t.linearFactor&&this.linearFactor.copy(t.linearFactor),this.angularFactor=new Ud(1,1,1),t.angularFactor&&this.angularFactor.copy(t.angularFactor),this.aabb=new qd,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new Ud,this.isTrigger=Boolean(t.isTrigger),t.shape&&this.addShape(t.shape),this.updateMassProperties()}wakeUp(){const t=this.sleepState;this.sleepState=du.AWAKE,this.wakeUpAfterNarrowphase=!1,t===du.SLEEPING&&this.dispatchEvent(du.wakeupEvent)}sleep(){this.sleepState=du.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.wakeUpAfterNarrowphase=!1}sleepTick(t){if(this.allowSleep){const e=this.sleepState,i=this.velocity.lengthSquared()+this.angularVelocity.lengthSquared(),s=this.sleepSpeedLimit**2;e===du.AWAKE&&i<s?(this.sleepState=du.SLEEPY,this.timeLastSleepy=t,this.dispatchEvent(du.sleepyEvent)):e===du.SLEEPY&&i>s?this.wakeUp():e===du.SLEEPY&&t-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(du.sleepEvent))}}updateSolveMassProperties(){this.sleepState===du.SLEEPING||this.type===du.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))}pointToLocalFrame(t,e=new Ud){return t.vsub(this.position,e),this.quaternion.conjugate().vmult(e,e),e}vectorToLocalFrame(t,e=new Ud){return this.quaternion.conjugate().vmult(t,e),e}pointToWorldFrame(t,e=new Ud){return this.quaternion.vmult(t,e),e.vadd(this.position,e),e}vectorToWorldFrame(t,e=new Ud){return this.quaternion.vmult(t,e),e}addShape(t,e,i){const s=new Ud,n=new Kd;return e&&s.copy(e),i&&n.copy(i),this.shapes.push(t),this.shapeOffsets.push(s),this.shapeOrientations.push(n),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,t.body=this,this}removeShape(t){const e=this.shapes.indexOf(t);return-1===e?(console.warn("Shape does not belong to the body"),this):(this.shapes.splice(e,1),this.shapeOffsets.splice(e,1),this.shapeOrientations.splice(e,1),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,t.body=null,this)}updateBoundingRadius(){const t=this.shapes,e=this.shapeOffsets,i=t.length;let s=0;for(let n=0;n!==i;n++){const i=t[n];i.updateBoundingSphereRadius();const o=e[n].length(),r=i.boundingSphereRadius;o+r>s&&(s=o+r)}this.boundingRadius=s}updateAABB(){const t=this.shapes,e=this.shapeOffsets,i=this.shapeOrientations,s=t.length,n=uu,o=pu,r=this.quaternion,a=this.aabb,h=mu;for(let l=0;l!==s;l++){const s=t[l];r.vmult(e[l],n),n.vadd(this.position,n),r.mult(i[l],o),s.calculateWorldAABB(n,o,h.lowerBound,h.upperBound),0===l?a.copy(h):a.extend(h)}this.aabbNeedsUpdate=!1}updateInertiaWorld(t){const e=this.invInertia;if(e.x!==e.y||e.y!==e.z||t){const t=fu,i=gu;t.setRotationFromQuaternion(this.quaternion),t.transpose(i),t.scale(e,t),t.mmult(i,this.invInertiaWorld)}}applyForce(t,e=new Ud){if(this.type!==du.DYNAMIC)return;this.sleepState===du.SLEEPING&&this.wakeUp();const i=yu;e.cross(t,i),this.force.vadd(t,this.force),this.torque.vadd(i,this.torque)}applyLocalForce(t,e=new Ud){if(this.type!==du.DYNAMIC)return;const i=vu,s=wu;this.vectorToWorldFrame(t,i),this.vectorToWorldFrame(e,s),this.applyForce(i,s)}applyTorque(t){this.type===du.DYNAMIC&&(this.sleepState===du.SLEEPING&&this.wakeUp(),this.torque.vadd(t,this.torque))}applyImpulse(t,e=new Ud){if(this.type!==du.DYNAMIC)return;this.sleepState===du.SLEEPING&&this.wakeUp();const i=e,s=xu;s.copy(t),s.scale(this.invMass,s),this.velocity.vadd(s,this.velocity);const n=bu;i.cross(t,n),this.invInertiaWorld.vmult(n,n),this.angularVelocity.vadd(n,this.angularVelocity)}applyLocalImpulse(t,e=new Ud){if(this.type!==du.DYNAMIC)return;const i=Su,s=Mu;this.vectorToWorldFrame(t,i),this.vectorToWorldFrame(e,s),this.applyImpulse(i,s)}updateMassProperties(){const t=Tu;this.invMass=this.mass>0?1/this.mass:0;const e=this.inertia,i=this.fixedRotation;this.updateAABB(),t.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),hu.calculateInertia(t,this.mass,e),this.invInertia.set(e.x>0&&!i?1/e.x:0,e.y>0&&!i?1/e.y:0,e.z>0&&!i?1/e.z:0),this.updateInertiaWorld(!0)}getVelocityAtWorldPoint(t,e){const i=new Ud;return t.vsub(this.position,i),this.angularVelocity.cross(i,e),this.velocity.vadd(e,e),e}integrate(t,e,i){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),this.type!==du.DYNAMIC&&this.type!==du.KINEMATIC||this.sleepState===du.SLEEPING)return;const s=this.velocity,n=this.angularVelocity,o=this.position,r=this.force,a=this.torque,h=this.quaternion,l=this.invMass,c=this.invInertiaWorld,d=this.linearFactor,u=l*t;s.x+=r.x*u*d.x,s.y+=r.y*u*d.y,s.z+=r.z*u*d.z;const p=c.elements,m=this.angularFactor,f=a.x*m.x,g=a.y*m.y,y=a.z*m.z;n.x+=t*(p[0]*f+p[1]*g+p[2]*y),n.y+=t*(p[3]*f+p[4]*g+p[5]*y),n.z+=t*(p[6]*f+p[7]*g+p[8]*y),o.x+=s.x*t,o.y+=s.y*t,o.z+=s.z*t,h.integrate(this.angularVelocity,t,this.angularFactor,h),e&&(i?h.normalizeFast():h.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}}du.idCounter=0,du.COLLIDE_EVENT_NAME="collide",du.DYNAMIC=1,du.STATIC=2,du.KINEMATIC=4,du.AWAKE=0,du.SLEEPY=1,du.SLEEPING=2,du.wakeupEvent={type:"wakeup"},du.sleepyEvent={type:"sleepy"},du.sleepEvent={type:"sleep"};const uu=new Ud,pu=new Kd,mu=new qd,fu=new Wd,gu=new Wd,yu=new Ud,vu=new Ud,wu=new Ud,xu=new Ud,bu=new Ud,Su=new Ud,Mu=new Ud,Tu=new Ud;class _u{constructor(){this.world=void 0,this.useBoundingBoxes=void 0,this.dirty=void 0,this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}collisionPairs(t,e,i){throw new Error("collisionPairs not implemented for this BroadPhase class!")}needBroadphaseCollision(t,e){return 0!=(t.collisionFilterGroup&e.collisionFilterMask)&&0!=(e.collisionFilterGroup&t.collisionFilterMask)&&(0==(t.type&du.STATIC)&&t.sleepState!==du.SLEEPING||0==(e.type&du.STATIC)&&e.sleepState!==du.SLEEPING)}intersectionTest(t,e,i,s){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,e,i,s):this.doBoundingSphereBroadphase(t,e,i,s)}doBoundingSphereBroadphase(t,e,i,s){const n=Eu;e.position.vsub(t.position,n);const o=(t.boundingRadius+e.boundingRadius)**2;n.lengthSquared()<o&&(i.push(t),s.push(e))}doBoundingBoxBroadphase(t,e,i,s){t.aabbNeedsUpdate&&t.updateAABB(),e.aabbNeedsUpdate&&e.updateAABB(),t.aabb.overlaps(e.aabb)&&(i.push(t),s.push(e))}makePairsUnique(t,e){const i=Lu,s=Cu,n=Au,o=t.length;for(let i=0;i!==o;i++)s[i]=t[i],n[i]=e[i];t.length=0,e.length=0;for(let t=0;t!==o;t++){const e=s[t].id,o=n[t].id,r=e<o?e+","+o:o+","+e;i[r]=t,i.keys.push(r)}for(let o=0;o!==i.keys.length;o++){const o=i.keys.pop(),r=i[o];t.push(s[r]),e.push(n[r]),delete i[o]}}setWorld(t){}static boundingSphereCheck(t,e){const i=new Ud;t.position.vsub(e.position,i);const s=t.shapes[0],n=e.shapes[0];return Math.pow(s.boundingSphereRadius+n.boundingSphereRadius,2)>i.lengthSquared()}aabbQuery(t,e,i){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}}const Eu=new Ud,Lu={keys:[]},Cu=[],Au=[];new Ud;class Pu extends _u{constructor(){super()}collisionPairs(t,e,i){const s=t.bodies,n=s.length;let o,r;for(let t=0;t!==n;t++)for(let n=0;n!==t;n++)o=s[t],r=s[n],this.needBroadphaseCollision(o,r)&&this.intersectionTest(o,r,e,i)}aabbQuery(t,e,i=[]){for(let s=0;s<t.bodies.length;s++){const n=t.bodies[s];n.aabbNeedsUpdate&&n.updateAABB(),n.aabb.overlaps(e)&&i.push(n)}return i}}class ku{constructor(){this.rayFromWorld=void 0,this.rayToWorld=void 0,this.hitNormalWorld=void 0,this.hitPointWorld=void 0,this.hasHit=void 0,this.shape=void 0,this.body=void 0,this.hitFaceIndex=void 0,this.distance=void 0,this.shouldStop=void 0,this.rayFromWorld=new Ud,this.rayToWorld=new Ud,this.hitNormalWorld=new Ud,this.hitPointWorld=new Ud,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}reset(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}abort(){this.shouldStop=!0}set(t,e,i,s,n,o,r){this.rayFromWorld.copy(t),this.rayToWorld.copy(e),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(s),this.shape=n,this.body=o,this.distance=r}}let Bu,Ru,Du,Iu,Fu,zu,Ou;Bu=tu.types.SPHERE,Ru=tu.types.PLANE,Du=tu.types.BOX,Iu=tu.types.CYLINDER,Fu=tu.types.CONVEXPOLYHEDRON,zu=tu.types.HEIGHTFIELD,Ou=tu.types.TRIMESH;class Nu{get[Bu](){return this._intersectSphere}get[Ru](){return this._intersectPlane}get[Du](){return this._intersectBox}get[Iu](){return this._intersectConvex}get[Fu](){return this._intersectConvex}get[zu](){return this._intersectHeightfield}get[Ou](){return this._intersectTrimesh}constructor(t=new Ud,e=new Ud){this.from=void 0,this.to=void 0,this.direction=void 0,this.precision=void 0,this.checkCollisionResponse=void 0,this.skipBackfaces=void 0,this.collisionFilterMask=void 0,this.collisionFilterGroup=void 0,this.mode=void 0,this.result=void 0,this.hasHit=void 0,this.callback=void 0,this.from=t.clone(),this.to=e.clone(),this.direction=new Ud,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=Nu.ANY,this.result=new ku,this.hasHit=!1,this.callback=t=>{}}intersectWorld(t,e){return this.mode=e.mode||Nu.ANY,this.result=e.result||new ku,this.skipBackfaces=!!e.skipBackfaces,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:-1,this.checkCollisionResponse=void 0===e.checkCollisionResponse||e.checkCollisionResponse,e.from&&this.from.copy(e.from),e.to&&this.to.copy(e.to),this.callback=e.callback||(()=>{}),this.hasHit=!1,this.result.reset(),this.updateDirection(),this.getAABB(Wu),Hu.length=0,t.broadphase.aabbQuery(t,Wu,Hu),this.intersectBodies(Hu),this.hasHit}intersectBody(t,e){e&&(this.result=e,this.updateDirection());const i=this.checkCollisionResponse;if(i&&!t.collisionResponse)return;if(0==(this.collisionFilterGroup&t.collisionFilterMask)||0==(t.collisionFilterGroup&this.collisionFilterMask))return;const s=Gu,n=ju;for(let e=0,o=t.shapes.length;e<o;e++){const o=t.shapes[e];if((!i||o.collisionResponse)&&(t.quaternion.mult(t.shapeOrientations[e],n),t.quaternion.vmult(t.shapeOffsets[e],s),s.vadd(t.position,s),this.intersectShape(o,n,s,t),this.result.shouldStop))break}}intersectBodies(t,e){e&&(this.result=e,this.updateDirection());for(let e=0,i=t.length;!this.result.shouldStop&&e<i;e++)this.intersectBody(t[e])}updateDirection(){this.to.vsub(this.from,this.direction),this.direction.normalize()}intersectShape(t,e,i,s){const n=function(t,e,i){i.vsub(t,up);const s=up.dot(e);e.scale(s,pp),pp.vadd(t,pp);return i.distanceTo(pp)}(this.from,this.direction,i);if(n>t.boundingSphereRadius)return;const o=this[t.type];o&&o.call(this,t,e,i,s,t)}_intersectBox(t,e,i,s,n){return this._intersectConvex(t.convexPolyhedronRepresentation,e,i,s,n)}_intersectPlane(t,e,i,s,n){const o=this.from,r=this.to,a=this.direction,h=new Ud(0,0,1);e.vmult(h,h);const l=new Ud;o.vsub(i,l);const c=l.dot(h);if(r.vsub(i,l),c*l.dot(h)>0)return;if(o.distanceTo(r)<c)return;const d=h.dot(a);if(Math.abs(d)<this.precision)return;const u=new Ud,p=new Ud,m=new Ud;o.vsub(i,u);const f=-h.dot(u)/d;a.scale(f,p),o.vadd(p,m),this.reportIntersection(h,m,n,s,-1)}getAABB(t){const{lowerBound:e,upperBound:i}=t,s=this.to,n=this.from;e.x=Math.min(s.x,n.x),e.y=Math.min(s.y,n.y),e.z=Math.min(s.z,n.z),i.x=Math.max(s.x,n.x),i.y=Math.max(s.y,n.y),i.z=Math.max(s.z,n.z)}_intersectHeightfield(t,e,i,s,n){t.data,t.elementSize;const o=Ju;o.from.copy(this.from),o.to.copy(this.to),eu.pointToLocalFrame(i,e,o.from,o.from),eu.pointToLocalFrame(i,e,o.to,o.to),o.updateDirection();const r=Qu;let a,h,l,c;a=h=0,l=c=t.data.length-1;const d=new qd;o.getAABB(d),t.getIndexOfPosition(d.lowerBound.x,d.lowerBound.y,r,!0),a=Math.max(a,r[0]),h=Math.max(h,r[1]),t.getIndexOfPosition(d.upperBound.x,d.upperBound.y,r,!0),l=Math.min(l,r[0]+1),c=Math.min(c,r[1]+1);for(let r=a;r<l;r++)for(let a=h;a<c;a++){if(this.result.shouldStop)return;if(t.getAabbAtIndex(r,a,d),d.overlapsRay(o)){if(t.getConvexTrianglePillar(r,a,!1),eu.pointToWorldFrame(i,e,t.pillarOffset,Ku),this._intersectConvex(t.pillarConvex,e,Ku,s,n,Zu),this.result.shouldStop)return;t.getConvexTrianglePillar(r,a,!0),eu.pointToWorldFrame(i,e,t.pillarOffset,Ku),this._intersectConvex(t.pillarConvex,e,Ku,s,n,Zu)}}}_intersectSphere(t,e,i,s,n){const o=this.from,r=this.to,a=t.radius,h=(r.x-o.x)**2+(r.y-o.y)**2+(r.z-o.z)**2,l=2*((r.x-o.x)*(o.x-i.x)+(r.y-o.y)*(o.y-i.y)+(r.z-o.z)*(o.z-i.z)),c=l**2-4*h*((o.x-i.x)**2+(o.y-i.y)**2+(o.z-i.z)**2-a**2),d=tp,u=ep;if(!(c<0))if(0===c)o.lerp(r,c,d),d.vsub(i,u),u.normalize(),this.reportIntersection(u,d,n,s,-1);else{const t=(-l-Math.sqrt(c))/(2*h),e=(-l+Math.sqrt(c))/(2*h);if(t>=0&&t<=1&&(o.lerp(r,t,d),d.vsub(i,u),u.normalize(),this.reportIntersection(u,d,n,s,-1)),this.result.shouldStop)return;e>=0&&e<=1&&(o.lerp(r,e,d),d.vsub(i,u),u.normalize(),this.reportIntersection(u,d,n,s,-1))}}_intersectConvex(t,e,i,s,n,o){const r=ip,a=sp,h=o&&o.faceList||null,l=t.faces,c=t.vertices,d=t.faceNormals,u=this.direction,p=this.from,m=this.to,f=p.distanceTo(m),g=h?h.length:l.length,y=this.result;for(let t=0;!y.shouldStop&&t<g;t++){const o=h?h[t]:t,m=l[o],g=d[o],v=e,w=i;a.copy(c[m[0]]),v.vmult(a,a),a.vadd(w,a),a.vsub(p,a),v.vmult(g,r);const x=u.dot(r);if(Math.abs(x)<this.precision)continue;const b=r.dot(a)/x;if(!(b<0)){u.scale(b,qu),qu.vadd(p,qu),$u.copy(c[m[0]]),v.vmult($u,$u),w.vadd($u,$u);for(let t=1;!y.shouldStop&&t<m.length-1;t++){Xu.copy(c[m[t]]),Yu.copy(c[m[t+1]]),v.vmult(Xu,Xu),v.vmult(Yu,Yu),w.vadd(Xu,Xu),w.vadd(Yu,Yu);const e=qu.distanceTo(p);!Nu.pointInTriangle(qu,$u,Xu,Yu)&&!Nu.pointInTriangle(qu,Xu,$u,Yu)||e>f||this.reportIntersection(r,qu,n,s,o)}}}}_intersectTrimesh(t,e,i,s,n,o){const r=np,a=cp,h=dp,l=sp,c=op,d=rp,u=ap,p=lp,m=hp,f=t.indices;t.vertices;const g=this.from,y=this.to,v=this.direction;h.position.copy(i),h.quaternion.copy(e),eu.vectorToLocalFrame(i,e,v,c),eu.pointToLocalFrame(i,e,g,d),eu.pointToLocalFrame(i,e,y,u),u.x*=t.scale.x,u.y*=t.scale.y,u.z*=t.scale.z,d.x*=t.scale.x,d.y*=t.scale.y,d.z*=t.scale.z,u.vsub(d,c),c.normalize();const w=d.distanceSquared(u);t.tree.rayQuery(this,h,a);for(let o=0,h=a.length;!this.result.shouldStop&&o!==h;o++){const h=a[o];t.getNormal(h,r),t.getVertex(f[3*h],$u),$u.vsub(d,l);const u=c.dot(r),g=r.dot(l)/u;if(g<0)continue;c.scale(g,qu),qu.vadd(d,qu),t.getVertex(f[3*h+1],Xu),t.getVertex(f[3*h+2],Yu);const y=qu.distanceSquared(d);!Nu.pointInTriangle(qu,Xu,$u,Yu)&&!Nu.pointInTriangle(qu,$u,Xu,Yu)||y>w||(eu.vectorToWorldFrame(e,r,m),eu.pointToWorldFrame(i,e,qu,p),this.reportIntersection(m,p,n,s,h))}a.length=0}reportIntersection(t,e,i,s,n){const o=this.from,r=this.to,a=o.distanceTo(e),h=this.result;if(!(this.skipBackfaces&&t.dot(this.direction)>0))switch(h.hitFaceIndex=void 0!==n?n:-1,this.mode){case Nu.ALL:this.hasHit=!0,h.set(o,r,t,e,i,s,a),h.hasHit=!0,this.callback(h);break;case Nu.CLOSEST:(a<h.distance||!h.hasHit)&&(this.hasHit=!0,h.hasHit=!0,h.set(o,r,t,e,i,s,a));break;case Nu.ANY:this.hasHit=!0,h.hasHit=!0,h.set(o,r,t,e,i,s,a),h.shouldStop=!0}}static pointInTriangle(t,e,i,s){s.vsub(e,up),i.vsub(e,Uu),t.vsub(e,Vu);const n=up.dot(up),o=up.dot(Uu),r=up.dot(Vu),a=Uu.dot(Uu),h=Uu.dot(Vu);let l,c;return(l=a*r-o*h)>=0&&(c=n*h-o*r)>=0&&l+c<n*a-o*o}}Nu.CLOSEST=1,Nu.ANY=2,Nu.ALL=4;const Wu=new qd,Hu=[],Uu=new Ud,Vu=new Ud,Gu=new Ud,ju=new Kd,qu=new Ud,$u=new Ud,Xu=new Ud,Yu=new Ud,Zu={faceList:[0]},Ku=new Ud,Ju=new Nu,Qu=[],tp=new Ud,ep=new Ud,ip=new Ud,sp=new Ud,np=new Ud,op=new Ud,rp=new Ud,ap=new Ud,hp=new Ud,lp=new Ud;new qd;const cp=[],dp=new eu,up=new Ud,pp=new Ud;class mp extends _u{static checkBounds(t,e,i){let s,n;0===i?(s=t.position.x,n=e.position.x):1===i?(s=t.position.y,n=e.position.y):2===i&&(s=t.position.z,n=e.position.z);const o=t.boundingRadius;return n-e.boundingRadius<s+o}static insertionSortX(t){for(let e=1,i=t.length;e<i;e++){const i=t[e];let s;for(s=e-1;s>=0&&!(t[s].aabb.lowerBound.x<=i.aabb.lowerBound.x);s--)t[s+1]=t[s];t[s+1]=i}return t}static insertionSortY(t){for(let e=1,i=t.length;e<i;e++){const i=t[e];let s;for(s=e-1;s>=0&&!(t[s].aabb.lowerBound.y<=i.aabb.lowerBound.y);s--)t[s+1]=t[s];t[s+1]=i}return t}static insertionSortZ(t){for(let e=1,i=t.length;e<i;e++){const i=t[e];let s;for(s=e-1;s>=0&&!(t[s].aabb.lowerBound.z<=i.aabb.lowerBound.z);s--)t[s+1]=t[s];t[s+1]=i}return t}constructor(t){super(),this.axisList=void 0,this.world=void 0,this.axisIndex=void 0,this._addBodyHandler=void 0,this._removeBodyHandler=void 0,this.axisList=[],this.world=null,this.axisIndex=0;const e=this.axisList;this._addBodyHandler=t=>{e.push(t.body)},this._removeBodyHandler=t=>{const i=e.indexOf(t.body);-1!==i&&e.splice(i,1)},t&&this.setWorld(t)}setWorld(t){this.axisList.length=0;for(let e=0;e<t.bodies.length;e++)this.axisList.push(t.bodies[e]);t.removeEventListener("addBody",this._addBodyHandler),t.removeEventListener("removeBody",this._removeBodyHandler),t.addEventListener("addBody",this._addBodyHandler),t.addEventListener("removeBody",this._removeBodyHandler),this.world=t,this.dirty=!0}collisionPairs(t,e,i){const s=this.axisList,n=s.length,o=this.axisIndex;let r,a;for(this.dirty&&(this.sortList(),this.dirty=!1),r=0;r!==n;r++){const t=s[r];for(a=r+1;a<n;a++){const n=s[a];if(this.needBroadphaseCollision(t,n)){if(!mp.checkBounds(t,n,o))break;this.intersectionTest(t,n,e,i)}}}}sortList(){const t=this.axisList,e=this.axisIndex,i=t.length;for(let e=0;e!==i;e++){const i=t[e];i.aabbNeedsUpdate&&i.updateAABB()}0===e?mp.insertionSortX(t):1===e?mp.insertionSortY(t):2===e&&mp.insertionSortZ(t)}autoDetectAxis(){let t=0,e=0,i=0,s=0,n=0,o=0;const r=this.axisList,a=r.length,h=1/a;for(let h=0;h!==a;h++){const a=r[h],l=a.position.x;t+=l,e+=l*l;const c=a.position.y;i+=c,s+=c*c;const d=a.position.z;n+=d,o+=d*d}const l=e-t*t*h,c=s-i*i*h,d=o-n*n*h;this.axisIndex=l>c?l>d?0:2:c>d?1:2}aabbQuery(t,e,i=[]){this.dirty&&(this.sortList(),this.dirty=!1);const s=this.axisIndex;let n="x";1===s&&(n="y"),2===s&&(n="z");const o=this.axisList;e.lowerBound[n],e.upperBound[n];for(let t=0;t<o.length;t++){const s=o[t];s.aabbNeedsUpdate&&s.updateAABB(),s.aabb.overlaps(e)&&i.push(s)}return i}}class fp{static defaults(t={},e){for(let i in e)i in t||(t[i]=e[i]);return t}}class gp{constructor(t,e,i={}){this.equations=void 0,this.bodyA=void 0,this.bodyB=void 0,this.id=void 0,this.collideConnected=void 0,i=fp.defaults(i,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=t,this.bodyB=e,this.id=gp.idCounter++,this.collideConnected=i.collideConnected,i.wakeUpBodies&&(t&&t.wakeUp(),e&&e.wakeUp())}update(){throw new Error("method update() not implmemented in this Constraint subclass!")}enable(){const t=this.equations;for(let e=0;e<t.length;e++)t[e].enabled=!0}disable(){const t=this.equations;for(let e=0;e<t.length;e++)t[e].enabled=!1}}gp.idCounter=0;class yp{constructor(){this.spatial=void 0,this.rotational=void 0,this.spatial=new Ud,this.rotational=new Ud}multiplyElement(t){return t.spatial.dot(this.spatial)+t.rotational.dot(this.rotational)}multiplyVectors(t,e){return t.dot(this.spatial)+e.dot(this.rotational)}}class vp{constructor(t,e,i=-1e6,s=1e6){this.id=void 0,this.minForce=void 0,this.maxForce=void 0,this.bi=void 0,this.bj=void 0,this.si=void 0,this.sj=void 0,this.a=void 0,this.b=void 0,this.eps=void 0,this.jacobianElementA=void 0,this.jacobianElementB=void 0,this.enabled=void 0,this.multiplier=void 0,this.id=vp.idCounter++,this.minForce=i,this.maxForce=s,this.bi=t,this.bj=e,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new yp,this.jacobianElementB=new yp,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}setSpookParams(t,e,i){const s=e,n=t,o=i;this.a=4/(o*(1+4*s)),this.b=4*s/(1+4*s),this.eps=4/(o*o*n*(1+4*s))}computeB(t,e,i){const s=this.computeGW();return-this.computeGq()*t-s*e-this.computeGiMf()*i}computeGq(){const t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,s=this.bj,n=i.position,o=s.position;return t.spatial.dot(n)+e.spatial.dot(o)}computeGW(){const t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,s=this.bj,n=i.velocity,o=s.velocity,r=i.angularVelocity,a=s.angularVelocity;return t.multiplyVectors(n,r)+e.multiplyVectors(o,a)}computeGWlambda(){const t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,s=this.bj,n=i.vlambda,o=s.vlambda,r=i.wlambda,a=s.wlambda;return t.multiplyVectors(n,r)+e.multiplyVectors(o,a)}computeGiMf(){const t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,s=this.bj,n=i.force,o=i.torque,r=s.force,a=s.torque,h=i.invMassSolve,l=s.invMassSolve;return n.scale(h,wp),r.scale(l,xp),i.invInertiaWorldSolve.vmult(o,bp),s.invInertiaWorldSolve.vmult(a,Sp),t.multiplyVectors(wp,bp)+e.multiplyVectors(xp,Sp)}computeGiMGt(){const t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,s=this.bj,n=i.invMassSolve,o=s.invMassSolve,r=i.invInertiaWorldSolve,a=s.invInertiaWorldSolve;let h=n+o;return r.vmult(t.rotational,Mp),h+=Mp.dot(t.rotational),a.vmult(e.rotational,Mp),h+=Mp.dot(e.rotational),h}addToWlambda(t){const e=this.jacobianElementA,i=this.jacobianElementB,s=this.bi,n=this.bj,o=Tp;s.vlambda.addScaledVector(s.invMassSolve*t,e.spatial,s.vlambda),n.vlambda.addScaledVector(n.invMassSolve*t,i.spatial,n.vlambda),s.invInertiaWorldSolve.vmult(e.rotational,o),s.wlambda.addScaledVector(t,o,s.wlambda),n.invInertiaWorldSolve.vmult(i.rotational,o),n.wlambda.addScaledVector(t,o,n.wlambda)}computeC(){return this.computeGiMGt()+this.eps}}vp.idCounter=0;const wp=new Ud,xp=new Ud,bp=new Ud,Sp=new Ud,Mp=new Ud,Tp=new Ud;class _p extends vp{constructor(t,e,i=1e6){super(t,e,0,i),this.restitution=void 0,this.ri=void 0,this.rj=void 0,this.ni=void 0,this.restitution=0,this.ri=new Ud,this.rj=new Ud,this.ni=new Ud}computeB(t){const e=this.a,i=this.b,s=this.bi,n=this.bj,o=this.ri,r=this.rj,a=Ep,h=Lp,l=s.velocity,c=s.angularVelocity;s.force,s.torque;const d=n.velocity,u=n.angularVelocity;n.force,n.torque;const p=Cp,m=this.jacobianElementA,f=this.jacobianElementB,g=this.ni;o.cross(g,a),r.cross(g,h),g.negate(m.spatial),a.negate(m.rotational),f.spatial.copy(g),f.rotational.copy(h),p.copy(n.position),p.vadd(r,p),p.vsub(s.position,p),p.vsub(o,p);const y=g.dot(p),v=this.restitution+1;return-y*e-(v*d.dot(g)-v*l.dot(g)+u.dot(h)-c.dot(a))*i-t*this.computeGiMf()}getImpactVelocityAlongNormal(){const t=Ap,e=Pp,i=kp,s=Bp,n=Rp;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,s),this.bi.getVelocityAtWorldPoint(i,t),this.bj.getVelocityAtWorldPoint(s,e),t.vsub(e,n),this.ni.dot(n)}}const Ep=new Ud,Lp=new Ud,Cp=new Ud,Ap=new Ud,Pp=new Ud,kp=new Ud,Bp=new Ud,Rp=new Ud;new Ud,new Ud,new Ud,new Ud,new Ud,new Ud;class Dp extends vp{constructor(t,e,i){super(t,e,-i,i),this.ri=void 0,this.rj=void 0,this.t=void 0,this.ri=new Ud,this.rj=new Ud,this.t=new Ud}computeB(t){this.a;const e=this.b;this.bi,this.bj;const i=this.ri,s=this.rj,n=Ip,o=Fp,r=this.t;i.cross(r,n),s.cross(r,o);const a=this.jacobianElementA,h=this.jacobianElementB;return r.negate(a.spatial),n.negate(a.rotational),h.spatial.copy(r),h.rotational.copy(o),-this.computeGW()*e-t*this.computeGiMf()}}const Ip=new Ud,Fp=new Ud;class zp{constructor(t,e,i){this.id=void 0,this.materials=void 0,this.friction=void 0,this.restitution=void 0,this.contactEquationStiffness=void 0,this.contactEquationRelaxation=void 0,this.frictionEquationStiffness=void 0,this.frictionEquationRelaxation=void 0,i=fp.defaults(i,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=zp.idCounter++,this.materials=[t,e],this.friction=i.friction,this.restitution=i.restitution,this.contactEquationStiffness=i.contactEquationStiffness,this.contactEquationRelaxation=i.contactEquationRelaxation,this.frictionEquationStiffness=i.frictionEquationStiffness,this.frictionEquationRelaxation=i.frictionEquationRelaxation}}zp.idCounter=0;class Op{constructor(t={}){this.name=void 0,this.id=void 0,this.friction=void 0,this.restitution=void 0;let e="";"string"==typeof t&&(e=t,t={}),this.name=e,this.id=Op.idCounter++,this.friction=void 0!==t.friction?t.friction:-1,this.restitution=void 0!==t.restitution?t.restitution:-1}}Op.idCounter=0,new Ud,new Ud,new Ud,new Ud,new Ud,new Ud,new Ud,new Ud,new Ud,new Ud,new Ud;class Np{constructor(t={}){this.maxSuspensionTravel=void 0,this.customSlidingRotationalSpeed=void 0,this.useCustomSlidingRotationalSpeed=void 0,this.sliding=void 0,this.chassisConnectionPointLocal=void 0,this.chassisConnectionPointWorld=void 0,this.directionLocal=void 0,this.directionWorld=void 0,this.axleLocal=void 0,this.axleWorld=void 0,this.suspensionRestLength=void 0,this.suspensionMaxLength=void 0,this.radius=void 0,this.suspensionStiffness=void 0,this.dampingCompression=void 0,this.dampingRelaxation=void 0,this.frictionSlip=void 0,this.forwardAcceleration=void 0,this.sideAcceleration=void 0,this.steering=void 0,this.rotation=void 0,this.deltaRotation=void 0,this.rollInfluence=void 0,this.maxSuspensionForce=void 0,this.engineForce=void 0,this.brake=void 0,this.isFrontWheel=void 0,this.clippedInvContactDotSuspension=void 0,this.suspensionRelativeVelocity=void 0,this.suspensionForce=void 0,this.slipInfo=void 0,this.skidInfo=void 0,this.suspensionLength=void 0,this.sideImpulse=void 0,this.forwardImpulse=void 0,this.raycastResult=void 0,this.worldTransform=void 0,this.isInContact=void 0,t=fp.defaults(t,{chassisConnectionPointLocal:new Ud,chassisConnectionPointWorld:new Ud,directionLocal:new Ud,directionWorld:new Ud,axleLocal:new Ud,axleWorld:new Ud,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:10.5,forwardAcceleration:1,sideAcceleration:1,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,slipInfo:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=t.maxSuspensionTravel,this.customSlidingRotationalSpeed=t.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=t.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=t.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=t.chassisConnectionPointWorld.clone(),this.directionLocal=t.directionLocal.clone(),this.directionWorld=t.directionWorld.clone(),this.axleLocal=t.axleLocal.clone(),this.axleWorld=t.axleWorld.clone(),this.suspensionRestLength=t.suspensionRestLength,this.suspensionMaxLength=t.suspensionMaxLength,this.radius=t.radius,this.suspensionStiffness=t.suspensionStiffness,this.dampingCompression=t.dampingCompression,this.dampingRelaxation=t.dampingRelaxation,this.frictionSlip=t.frictionSlip,this.forwardAcceleration=t.forwardAcceleration,this.sideAcceleration=t.sideAcceleration,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=t.rollInfluence,this.maxSuspensionForce=t.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=t.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.slipInfo=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new ku,this.worldTransform=new eu,this.isInContact=!1}updateWheel(t){const e=this.raycastResult;if(this.isInContact){const i=e.hitNormalWorld.dot(e.directionWorld);e.hitPointWorld.vsub(t.position,Hp),t.getVelocityAtWorldPoint(Hp,Wp);const s=e.hitNormalWorld.dot(Wp);if(i>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{const t=-1/i;this.suspensionRelativeVelocity=s*t,this.clippedInvContactDotSuspension=t}}else e.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.hitNormalWorld),this.clippedInvContactDotSuspension=1}}const Wp=new Ud,Hp=new Ud;class Up{constructor(t){this.chassisBody=void 0,this.wheelInfos=void 0,this.sliding=void 0,this.world=void 0,this.indexRightAxis=void 0,this.indexForwardAxis=void 0,this.indexUpAxis=void 0,this.constraints=void 0,this.preStepCallback=void 0,this.currentVehicleSpeedKmHour=void 0,this.numWheelsOnGround=void 0,this.chassisBody=t.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==t.indexRightAxis?t.indexRightAxis:2,this.indexForwardAxis=void 0!==t.indexForwardAxis?t.indexForwardAxis:0,this.indexUpAxis=void 0!==t.indexUpAxis?t.indexUpAxis:1,this.constraints=[],this.preStepCallback=()=>{},this.currentVehicleSpeedKmHour=0,this.numWheelsOnGround=0}addWheel(t={}){const e=new Np(t),i=this.wheelInfos.length;return this.wheelInfos.push(e),i}setSteeringValue(t,e){this.wheelInfos[e].steering=t}applyEngineForce(t,e){this.wheelInfos[e].engineForce=t}setBrake(t,e){this.wheelInfos[e].brake=t}addToWorld(t){t.addBody(this.chassisBody);const e=this;this.preStepCallback=()=>{e.updateVehicle(t.dt)},t.addEventListener("preStep",this.preStepCallback),this.world=t}getVehicleAxisWorld(t,e){e.set(0===t?1:0,1===t?1:0,2===t?1:0),this.chassisBody.vectorToWorldFrame(e,e)}updateVehicle(t){const e=this.wheelInfos,i=e.length,s=this.chassisBody;for(let t=0;t<i;t++)this.updateWheelTransform(t);this.currentVehicleSpeedKmHour=3.6*s.velocity.length();const n=new Ud;this.getVehicleAxisWorld(this.indexForwardAxis,n),n.dot(s.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(let t=0;t<i;t++)this.castRay(e[t]);this.updateSuspension(t);const o=new Ud,r=new Ud;for(let n=0;n<i;n++){const i=e[n];let a=i.suspensionForce;a>i.maxSuspensionForce&&(a=i.maxSuspensionForce),i.raycastResult.hitNormalWorld.scale(a*t,o),i.raycastResult.hitPointWorld.vsub(s.position,r),s.applyImpulse(o,r)}this.updateFriction(t);const a=new Ud,h=new Ud,l=new Ud;for(let n=0;n<i;n++){const i=e[n];s.getVelocityAtWorldPoint(i.chassisConnectionPointWorld,l);let o=1;if(1===this.indexUpAxis&&(o=-1),i.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,h);const e=h.dot(i.raycastResult.hitNormalWorld);i.raycastResult.hitNormalWorld.scale(e,a),h.vsub(a,h);const s=h.dot(l);i.deltaRotation=o*s*t/i.radius}!i.sliding&&i.isInContact||0===i.engineForce||!i.useCustomSlidingRotationalSpeed||(i.deltaRotation=(i.engineForce>0?1:-1)*i.customSlidingRotationalSpeed*t),Math.abs(i.brake)>Math.abs(i.engineForce)&&(i.deltaRotation=0),i.rotation+=i.deltaRotation,i.deltaRotation*=.99}}updateSuspension(t){const e=this.chassisBody.mass,i=this.wheelInfos,s=i.length;for(let t=0;t<s;t++){const s=i[t];if(s.isInContact){let t;const i=s.suspensionRestLength-s.suspensionLength;t=s.suspensionStiffness*i*s.clippedInvContactDotSuspension;const n=s.suspensionRelativeVelocity;let o;o=n<0?s.dampingCompression:s.dampingRelaxation,t-=o*n,s.suspensionForce=t*e,s.suspensionForce<0&&(s.suspensionForce=0)}else s.suspensionForce=0}}removeFromWorld(t){this.constraints,t.removeBody(this.chassisBody),t.removeEventListener("preStep",this.preStepCallback),this.world=null}castRay(t){const e=qp,i=$p;this.updateWheelTransformWorld(t);const s=this.chassisBody;let n=-1;const o=t.suspensionRestLength+t.radius;t.directionWorld.scale(o,e);const r=t.chassisConnectionPointWorld;r.vadd(e,i);const a=t.raycastResult;a.reset();const h=s.collisionResponse;s.collisionResponse=!1,this.world.rayTest(r,i,a),s.collisionResponse=h;const l=a.body;if(t.raycastResult.groundObject=0,l){n=a.distance,t.raycastResult.hitNormalWorld=a.hitNormalWorld,t.isInContact=!0;const e=a.distance;t.suspensionLength=e-t.radius;const i=t.suspensionRestLength-t.maxSuspensionTravel,o=t.suspensionRestLength+t.maxSuspensionTravel;t.suspensionLength<i&&(t.suspensionLength=i),t.suspensionLength>o&&(t.suspensionLength=o,t.raycastResult.reset());const r=t.raycastResult.hitNormalWorld.dot(t.directionWorld),h=new Ud;s.getVelocityAtWorldPoint(t.raycastResult.hitPointWorld,h);const l=t.raycastResult.hitNormalWorld.dot(h);if(r>=-.1)t.suspensionRelativeVelocity=0,t.clippedInvContactDotSuspension=10;else{const e=-1/r;t.suspensionRelativeVelocity=l*e,t.clippedInvContactDotSuspension=e}}else t.suspensionLength=t.suspensionRestLength+0*t.maxSuspensionTravel,t.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.raycastResult.hitNormalWorld),t.clippedInvContactDotSuspension=1;return n}updateWheelTransformWorld(t){t.isInContact=!1;const e=this.chassisBody;e.pointToWorldFrame(t.chassisConnectionPointLocal,t.chassisConnectionPointWorld),e.vectorToWorldFrame(t.directionLocal,t.directionWorld),e.vectorToWorldFrame(t.axleLocal,t.axleWorld)}updateWheelTransform(t){const e=Vp,i=Gp,s=jp,n=this.wheelInfos[t];this.updateWheelTransformWorld(n),n.directionLocal.scale(-1,e),i.copy(n.axleLocal),e.cross(i,s),s.normalize(),i.normalize();const o=n.steering,r=new Kd;r.setFromAxisAngle(e,o);const a=new Kd;a.setFromAxisAngle(i,n.rotation);const h=n.worldTransform.quaternion;this.chassisBody.quaternion.mult(r,h),h.mult(a,h),h.normalize();const l=n.worldTransform.position;l.copy(n.directionWorld),l.scale(n.suspensionLength,l),l.vadd(n.chassisConnectionPointWorld,l)}getWheelTransformWorld(t){return this.wheelInfos[t].worldTransform}updateFriction(t){const e=Yp,i=this.wheelInfos,s=i.length,n=this.chassisBody,o=Kp,r=Zp;this.numWheelsOnGround=0;for(let t=0;t<s;t++){const e=i[t];e.raycastResult.body&&this.numWheelsOnGround++,e.sideImpulse=0,e.forwardImpulse=0,o[t]||(o[t]=new Ud),r[t]||(r[t]=new Ud)}for(let t=0;t<s;t++){const s=i[t],a=s.raycastResult.body;if(a){const i=r[t];this.getWheelTransformWorld(t).vectorToWorldFrame(Xp[this.indexRightAxis],i);const h=s.raycastResult.hitNormalWorld,l=i.dot(h);h.scale(l,e),i.vsub(e,i),i.normalize(),h.cross(i,o[t]),o[t].normalize(),s.sideImpulse=dm(n,s.raycastResult.hitPointWorld,a,s.raycastResult.hitPointWorld,i),s.sideImpulse*=Jp}}this.sliding=!1;for(let e=0;e<s;e++){const s=i[e],r=s.raycastResult.body;let a=0;if(s.slipInfo=1,r){const i=0,h=s.brake?s.brake:i;a=im(n,r,s.raycastResult.hitPointWorld,o[e],h),a+=s.engineForce*t;const l=h/a;s.slipInfo*=l}if(s.forwardImpulse=0,s.skidInfo=1,r){s.skidInfo=1;const e=s.suspensionForce*t*s.frictionSlip,i=e*e;s.forwardImpulse=a;const n=.5*s.forwardImpulse/s.forwardAcceleration,o=1*s.sideImpulse/s.sideAcceleration,r=n*n+o*o;if(s.sliding=!1,r>i){this.sliding=!0,s.sliding=!0;const t=e/Math.sqrt(r);s.skidInfo*=t}}}if(this.sliding)for(let t=0;t<s;t++){const e=i[t];0!==e.sideImpulse&&e.skidInfo<1&&(e.forwardImpulse*=e.skidInfo,e.sideImpulse*=e.skidInfo)}for(let t=0;t<s;t++){const e=i[t],s=new Ud;if(e.raycastResult.hitPointWorld.vsub(n.position,s),0!==e.forwardImpulse){const i=new Ud;o[t].scale(e.forwardImpulse,i),n.applyImpulse(i,s)}if(0!==e.sideImpulse){const i=e.raycastResult.body,o=new Ud;e.raycastResult.hitPointWorld.vsub(i.position,o);const a=new Ud;r[t].scale(e.sideImpulse,a),n.vectorToLocalFrame(s,s),s["xyz"[this.indexUpAxis]]*=e.rollInfluence,n.vectorToWorldFrame(s,s),n.applyImpulse(a,s),a.scale(-1,a),i.applyImpulse(a,o)}}}}const Vp=new Ud,Gp=new Ud,jp=new Ud;new Nu;const qp=new Ud,$p=new Ud,Xp=[new Ud(1,0,0),new Ud(0,1,0),new Ud(0,0,1)],Yp=new Ud,Zp=[],Kp=[],Jp=1,Qp=new Ud,tm=new Ud,em=new Ud;function im(t,e,i,s,n){let o=0;const r=i,a=Qp,h=tm,l=em;return t.getVelocityAtWorldPoint(r,a),e.getVelocityAtWorldPoint(r,h),a.vsub(h,l),o=-s.dot(l)*(1/(am(t,i,s)+am(e,i,s))),n<o&&(o=n),o<-n&&(o=-n),o}const sm=new Ud,nm=new Ud,om=new Ud,rm=new Ud;function am(t,e,i){const s=sm,n=nm,o=om,r=rm;return e.vsub(t.position,s),s.cross(i,n),t.invInertiaWorld.vmult(n,r),r.cross(s,o),t.invMass+i.dot(o)}const hm=new Ud,lm=new Ud,cm=new Ud;function dm(t,e,i,s,n){if(n.lengthSquared()>1.1)return 0;const o=hm,r=lm,a=cm;return t.getVelocityAtWorldPoint(e,o),i.getVelocityAtWorldPoint(s,r),o.vsub(r,a),-.2*n.dot(a)*(1/(t.invMass+i.invMass))}class um extends tu{constructor(t){if(super({type:tu.types.SPHERE}),this.radius=void 0,this.radius=void 0!==t?t:1,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}calculateLocalInertia(t,e=new Ud){const i=2*t*this.radius*this.radius/5;return e.x=i,e.y=i,e.z=i,e}volume(){return 4*Math.PI*Math.pow(this.radius,3)/3}updateBoundingSphereRadius(){this.boundingSphereRadius=this.radius}calculateWorldAABB(t,e,i,s){const n=this.radius,o=["x","y","z"];for(let e=0;e<o.length;e++){const r=o[e];i[r]=t[r]-n,s[r]=t[r]+n}}}new Ud,new Ud,new Ud,new Ud,new Ud,new Ud,new Ud,new Ud,new Ud;class pm extends su{constructor(t=1,e=1,i=1,s=8){if(t<0)throw new Error("The cylinder radiusTop cannot be negative.");if(e<0)throw new Error("The cylinder radiusBottom cannot be negative.");const n=s,o=[],r=[],a=[],h=[],l=[],c=Math.cos,d=Math.sin;o.push(new Ud(-e*d(0),.5*-i,e*c(0))),h.push(0),o.push(new Ud(-t*d(0),.5*i,t*c(0))),l.push(1);for(let s=0;s<n;s++){const u=2*Math.PI/n*(s+1),p=2*Math.PI/n*(s+.5);s<n-1?(o.push(new Ud(-e*d(u),.5*-i,e*c(u))),h.push(2*s+2),o.push(new Ud(-t*d(u),.5*i,t*c(u))),l.push(2*s+3),a.push([2*s,2*s+1,2*s+3,2*s+2])):a.push([2*s,2*s+1,1,0]),(n%2==1||s<n/2)&&r.push(new Ud(-d(p),0,c(p)))}a.push(h),r.push(new Ud(0,1,0));const u=[];for(let t=0;t<l.length;t++)u.push(l[l.length-t-1]);a.push(u),super({vertices:o,faces:a,axes:r}),this.radiusTop=void 0,this.radiusBottom=void 0,this.height=void 0,this.numSegments=void 0,this.type=tu.types.CYLINDER,this.radiusTop=t,this.radiusBottom=e,this.height=i,this.numSegments=s}}class mm extends tu{constructor(){super({type:tu.types.PLANE}),this.worldNormal=void 0,this.worldNormalNeedsUpdate=void 0,this.boundingSphereRadius=void 0,this.worldNormal=new Ud,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}computeWorldNormal(t){const e=this.worldNormal;e.set(0,0,1),t.vmult(e,e),this.worldNormalNeedsUpdate=!1}calculateLocalInertia(t,e=new Ud){return e}volume(){return Number.MAX_VALUE}calculateWorldAABB(t,e,i,s){fm.set(0,0,1),e.vmult(fm,fm);const n=Number.MAX_VALUE;i.set(-n,-n,-n),s.set(n,n,n),1===fm.x?s.x=t.x:-1===fm.x&&(i.x=t.x),1===fm.y?s.y=t.y:-1===fm.y&&(i.y=t.y),1===fm.z?s.z=t.z:-1===fm.z&&(i.z=t.z)}updateBoundingSphereRadius(){this.boundingSphereRadius=Number.MAX_VALUE}}const fm=new Ud;new Ud,new Ud,new Ud,new Ud,new Ud,new Ud,new Ud,new Ud,new Ud;class gm{constructor(t={}){this.root=void 0,this.aabb=void 0,this.data=void 0,this.children=void 0,this.root=t.root||null,this.aabb=t.aabb?t.aabb.clone():new qd,this.data=[],this.children=[]}reset(){this.children.length=this.data.length=0}insert(t,e,i=0){const s=this.data;if(!this.aabb.contains(t))return!1;const n=this.children;if(i<(this.maxDepth||this.root.maxDepth)){let s=!1;n.length||(this.subdivide(),s=!0);for(let s=0;8!==s;s++)if(n[s].insert(t,e,i+1))return!0;s&&(n.length=0)}return s.push(e),!0}subdivide(){const t=this.aabb,e=t.lowerBound,i=t.upperBound,s=this.children;s.push(new gm({aabb:new qd({lowerBound:new Ud(0,0,0)})}),new gm({aabb:new qd({lowerBound:new Ud(1,0,0)})}),new gm({aabb:new qd({lowerBound:new Ud(1,1,0)})}),new gm({aabb:new qd({lowerBound:new Ud(1,1,1)})}),new gm({aabb:new qd({lowerBound:new Ud(0,1,1)})}),new gm({aabb:new qd({lowerBound:new Ud(0,0,1)})}),new gm({aabb:new qd({lowerBound:new Ud(1,0,1)})}),new gm({aabb:new qd({lowerBound:new Ud(0,1,0)})})),i.vsub(e,vm),vm.scale(.5,vm);const n=this.root||this;for(let t=0;8!==t;t++){const i=s[t];i.root=n;const o=i.aabb.lowerBound;o.x*=vm.x,o.y*=vm.y,o.z*=vm.z,o.vadd(e,o),o.vadd(vm,i.aabb.upperBound)}}aabbQuery(t,e){this.data,this.children;const i=[this];for(;i.length;){const s=i.pop();s.aabb.overlaps(t)&&Array.prototype.push.apply(e,s.data),Array.prototype.push.apply(i,s.children)}return e}rayQuery(t,e,i){return t.getAABB(wm),wm.toLocalFrame(e,wm),this.aabbQuery(wm,i),i}removeEmptyNodes(){for(let t=this.children.length-1;t>=0;t--)this.children[t].removeEmptyNodes(),this.children[t].children.length||this.children[t].data.length||this.children.splice(t,1)}}class ym extends gm{constructor(t,e={}){super({root:null,aabb:t}),this.maxDepth=void 0,this.maxDepth=void 0!==e.maxDepth?e.maxDepth:8}}const vm=new Ud,wm=new qd;class xm extends tu{constructor(t,e){super({type:tu.types.TRIMESH}),this.vertices=void 0,this.indices=void 0,this.normals=void 0,this.aabb=void 0,this.edges=void 0,this.scale=void 0,this.tree=void 0,this.vertices=new Float32Array(t),this.indices=new Int16Array(e),this.normals=new Float32Array(e.length),this.aabb=new qd,this.edges=null,this.scale=new Ud(1,1,1),this.tree=new ym,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}updateTree(){const t=this.tree;t.reset(),t.aabb.copy(this.aabb);const e=this.scale;t.aabb.lowerBound.x*=1/e.x,t.aabb.lowerBound.y*=1/e.y,t.aabb.lowerBound.z*=1/e.z,t.aabb.upperBound.x*=1/e.x,t.aabb.upperBound.y*=1/e.y,t.aabb.upperBound.z*=1/e.z;const i=new qd,s=new Ud,n=new Ud,o=new Ud,r=[s,n,o];for(let e=0;e<this.indices.length/3;e++){const a=3*e;this._getUnscaledVertex(this.indices[a],s),this._getUnscaledVertex(this.indices[a+1],n),this._getUnscaledVertex(this.indices[a+2],o),i.setFromPoints(r),t.insert(i,e)}t.removeEmptyNodes()}getTrianglesInAABB(t,e){Sm.copy(t);const i=this.scale,s=i.x,n=i.y,o=i.z,r=Sm.lowerBound,a=Sm.upperBound;return r.x/=s,r.y/=n,r.z/=o,a.x/=s,a.y/=n,a.z/=o,this.tree.aabbQuery(Sm,e)}setScale(t){const e=this.scale.x===this.scale.y&&this.scale.y===this.scale.z,i=t.x===t.y&&t.y===t.z;e&&i||this.updateNormals(),this.scale.copy(t),this.updateAABB(),this.updateBoundingSphereRadius()}updateNormals(){const t=bm,e=this.normals;for(let i=0;i<this.indices.length/3;i++){const s=3*i,n=this.indices[s],o=this.indices[s+1],r=this.indices[s+2];this.getVertex(n,Lm),this.getVertex(o,Cm),this.getVertex(r,Am),xm.computeNormal(Cm,Lm,Am,t),e[s]=t.x,e[s+1]=t.y,e[s+2]=t.z}}updateEdges(){const t={},e=(e,i)=>{t[e<i?e+"_"+i:i+"_"+e]=!0};for(let t=0;t<this.indices.length/3;t++){const i=3*t,s=this.indices[i],n=this.indices[i+1],o=this.indices[i+2];e(s,n),e(n,o),e(o,s)}const i=Object.keys(t);this.edges=new Int16Array(2*i.length);for(let t=0;t<i.length;t++){const e=i[t].split("_");this.edges[2*t]=parseInt(e[0],10),this.edges[2*t+1]=parseInt(e[1],10)}}getEdgeVertex(t,e,i){const s=this.edges[2*t+(e?1:0)];this.getVertex(s,i)}getEdgeVector(t,e){const i=Mm,s=Tm;this.getEdgeVertex(t,0,i),this.getEdgeVertex(t,1,s),s.vsub(i,e)}static computeNormal(t,e,i,s){e.vsub(t,Em),i.vsub(e,_m),_m.cross(Em,s),s.isZero()||s.normalize()}getVertex(t,e){const i=this.scale;return this._getUnscaledVertex(t,e),e.x*=i.x,e.y*=i.y,e.z*=i.z,e}_getUnscaledVertex(t,e){const i=3*t,s=this.vertices;return e.set(s[i],s[i+1],s[i+2])}getWorldVertex(t,e,i,s){return this.getVertex(t,s),eu.pointToWorldFrame(e,i,s,s),s}getTriangleVertices(t,e,i,s){const n=3*t;this.getVertex(this.indices[n],e),this.getVertex(this.indices[n+1],i),this.getVertex(this.indices[n+2],s)}getNormal(t,e){const i=3*t;return e.set(this.normals[i],this.normals[i+1],this.normals[i+2])}calculateLocalInertia(t,e){this.computeLocalAABB(Pm);const i=Pm.upperBound.x-Pm.lowerBound.x,s=Pm.upperBound.y-Pm.lowerBound.y,n=Pm.upperBound.z-Pm.lowerBound.z;return e.set(1/12*t*(2*s*2*s+2*n*2*n),1/12*t*(2*i*2*i+2*n*2*n),1/12*t*(2*s*2*s+2*i*2*i))}computeLocalAABB(t){const e=t.lowerBound,i=t.upperBound,s=this.vertices.length;this.vertices;const n=km;this.getVertex(0,n),e.copy(n),i.copy(n);for(let t=0;t!==s;t++)this.getVertex(t,n),n.x<e.x?e.x=n.x:n.x>i.x&&(i.x=n.x),n.y<e.y?e.y=n.y:n.y>i.y&&(i.y=n.y),n.z<e.z?e.z=n.z:n.z>i.z&&(i.z=n.z)}updateAABB(){this.computeLocalAABB(this.aabb)}updateBoundingSphereRadius(){let t=0;const e=this.vertices,i=new Ud;for(let s=0,n=e.length/3;s!==n;s++){this.getVertex(s,i);const e=i.lengthSquared();e>t&&(t=e)}this.boundingSphereRadius=Math.sqrt(t)}calculateWorldAABB(t,e,i,s){const n=Bm,o=Rm;n.position=t,n.quaternion=e,this.aabb.toWorldFrame(n,o),i.copy(o.lowerBound),s.copy(o.upperBound)}volume(){return 4*Math.PI*this.boundingSphereRadius/3}static createTorus(t=1,e=.5,i=8,s=6,n=2*Math.PI){const o=[],r=[];for(let r=0;r<=i;r++)for(let a=0;a<=s;a++){const h=a/s*n,l=r/i*Math.PI*2,c=(t+e*Math.cos(l))*Math.cos(h),d=(t+e*Math.cos(l))*Math.sin(h),u=e*Math.sin(l);o.push(c,d,u)}for(let t=1;t<=i;t++)for(let e=1;e<=s;e++){const i=(s+1)*t+e-1,n=(s+1)*(t-1)+e-1,o=(s+1)*(t-1)+e,a=(s+1)*t+e;r.push(i,n,a),r.push(n,o,a)}return new xm(o,r)}}const bm=new Ud,Sm=new qd,Mm=new Ud,Tm=new Ud,_m=new Ud,Em=new Ud,Lm=new Ud,Cm=new Ud,Am=new Ud,Pm=new qd,km=new Ud,Bm=new eu,Rm=new qd;class Dm{constructor(){this.equations=void 0,this.equations=[]}solve(t,e){return 0}addEquation(t){!t.enabled||t.bi.isTrigger||t.bj.isTrigger||this.equations.push(t)}removeEquation(t){const e=this.equations,i=e.indexOf(t);-1!==i&&e.splice(i,1)}removeAllEquations(){this.equations.length=0}}class Im extends Dm{constructor(){super(),this.iterations=void 0,this.tolerance=void 0,this.iterations=10,this.tolerance=1e-7}solve(t,e){let i=0;const s=this.iterations,n=this.tolerance*this.tolerance,o=this.equations,r=o.length,a=e.bodies,h=a.length,l=t;let c,d,u,p,m,f;if(0!==r)for(let t=0;t!==h;t++)a[t].updateSolveMassProperties();const g=zm,y=Om,v=Fm;g.length=r,y.length=r,v.length=r;for(let t=0;t!==r;t++){const e=o[t];v[t]=0,y[t]=e.computeB(l),g[t]=1/e.computeC()}if(0!==r){for(let t=0;t!==h;t++){const e=a[t],i=e.vlambda,s=e.wlambda;i.set(0,0,0),s.set(0,0,0)}for(i=0;i!==s;i++){p=0;for(let t=0;t!==r;t++){const e=o[t];c=y[t],d=g[t],f=v[t],m=e.computeGWlambda(),u=d*(c-m-e.eps*f),f+u<e.minForce?u=e.minForce-f:f+u>e.maxForce&&(u=e.maxForce-f),v[t]+=u,p+=u>0?u:-u,e.addToWlambda(u)}if(p*p<n)break}for(let t=0;t!==h;t++){const e=a[t],i=e.velocity,s=e.angularVelocity;e.vlambda.vmul(e.linearFactor,e.vlambda),i.vadd(e.vlambda,i),e.wlambda.vmul(e.angularFactor,e.wlambda),s.vadd(e.wlambda,s)}let t=o.length;const e=1/l;for(;t--;)o[t].multiplier=v[t]*e}return i}}const Fm=[],zm=[],Om=[];du.STATIC;class Nm{constructor(){this.objects=[],this.type=Object}release(...t){const e=t.length;for(let i=0;i!==e;i++)this.objects.push(t[i]);return this}get(){return 0===this.objects.length?this.constructObject():this.objects.pop()}constructObject(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}resize(t){const e=this.objects;for(;e.length>t;)e.pop();for(;e.length<t;)e.push(this.constructObject());return this}}class Wm extends Nm{constructor(...t){super(...t),this.type=Ud}constructObject(){return new Ud}}let Hm,Um,Vm,Gm,jm,qm,$m,Xm,Ym,Zm,Km,Jm,Qm,tf,ef,sf,nf,of,rf,af,hf,lf,cf,df,uf;const pf={sphereSphere:tu.types.SPHERE,spherePlane:tu.types.SPHERE|tu.types.PLANE,boxBox:tu.types.BOX|tu.types.BOX,sphereBox:tu.types.SPHERE|tu.types.BOX,planeBox:tu.types.PLANE|tu.types.BOX,convexConvex:tu.types.CONVEXPOLYHEDRON,sphereConvex:tu.types.SPHERE|tu.types.CONVEXPOLYHEDRON,planeConvex:tu.types.PLANE|tu.types.CONVEXPOLYHEDRON,boxConvex:tu.types.BOX|tu.types.CONVEXPOLYHEDRON,sphereHeightfield:tu.types.SPHERE|tu.types.HEIGHTFIELD,boxHeightfield:tu.types.BOX|tu.types.HEIGHTFIELD,convexHeightfield:tu.types.CONVEXPOLYHEDRON|tu.types.HEIGHTFIELD,sphereParticle:tu.types.PARTICLE|tu.types.SPHERE,planeParticle:tu.types.PLANE|tu.types.PARTICLE,boxParticle:tu.types.BOX|tu.types.PARTICLE,convexParticle:tu.types.PARTICLE|tu.types.CONVEXPOLYHEDRON,cylinderCylinder:tu.types.CYLINDER,sphereCylinder:tu.types.SPHERE|tu.types.CYLINDER,planeCylinder:tu.types.PLANE|tu.types.CYLINDER,boxCylinder:tu.types.BOX|tu.types.CYLINDER,convexCylinder:tu.types.CONVEXPOLYHEDRON|tu.types.CYLINDER,heightfieldCylinder:tu.types.HEIGHTFIELD|tu.types.CYLINDER,particleCylinder:tu.types.PARTICLE|tu.types.CYLINDER,sphereTrimesh:tu.types.SPHERE|tu.types.TRIMESH,planeTrimesh:tu.types.PLANE|tu.types.TRIMESH};Hm=pf.sphereSphere,Um=pf.spherePlane,Vm=pf.boxBox,Gm=pf.sphereBox,jm=pf.planeBox,qm=pf.convexConvex,$m=pf.sphereConvex,Xm=pf.planeConvex,Ym=pf.boxConvex,Zm=pf.sphereHeightfield,Km=pf.boxHeightfield,Jm=pf.convexHeightfield,Qm=pf.sphereParticle,tf=pf.planeParticle,ef=pf.boxParticle,sf=pf.convexParticle,nf=pf.cylinderCylinder,of=pf.sphereCylinder,rf=pf.planeCylinder,af=pf.boxCylinder,hf=pf.convexCylinder,lf=pf.heightfieldCylinder,cf=pf.particleCylinder,df=pf.sphereTrimesh,uf=pf.planeTrimesh;class mf{get[Hm](){return this.sphereSphere}get[Um](){return this.spherePlane}get[Vm](){return this.boxBox}get[Gm](){return this.sphereBox}get[jm](){return this.planeBox}get[qm](){return this.convexConvex}get[$m](){return this.sphereConvex}get[Xm](){return this.planeConvex}get[Ym](){return this.boxConvex}get[Zm](){return this.sphereHeightfield}get[Km](){return this.boxHeightfield}get[Jm](){return this.convexHeightfield}get[Qm](){return this.sphereParticle}get[tf](){return this.planeParticle}get[ef](){return this.boxParticle}get[sf](){return this.convexParticle}get[nf](){return this.convexConvex}get[of](){return this.sphereConvex}get[rf](){return this.planeConvex}get[af](){return this.boxConvex}get[hf](){return this.convexConvex}get[lf](){return this.heightfieldCylinder}get[cf](){return this.particleCylinder}get[df](){return this.sphereTrimesh}get[uf](){return this.planeTrimesh}constructor(t){this.contactPointPool=void 0,this.frictionEquationPool=void 0,this.result=void 0,this.frictionResult=void 0,this.v3pool=void 0,this.world=void 0,this.currentContactMaterial=void 0,this.enableFrictionReduction=void 0,this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new Wm,this.world=t,this.currentContactMaterial=t.defaultContactMaterial,this.enableFrictionReduction=!1}createContactEquation(t,e,i,s,n,o){let r;this.contactPointPool.length?(r=this.contactPointPool.pop(),r.bi=t,r.bj=e):r=new _p(t,e),r.enabled=t.collisionResponse&&e.collisionResponse&&i.collisionResponse&&s.collisionResponse;const a=this.currentContactMaterial;r.restitution=a.restitution,r.setSpookParams(a.contactEquationStiffness,a.contactEquationRelaxation,this.world.dt);const h=i.material||t.material,l=s.material||e.material;return h&&l&&h.restitution>=0&&l.restitution>=0&&(r.restitution=h.restitution*l.restitution),r.si=n||i,r.sj=o||s,r}createFrictionEquationsFromContact(t,e){const i=t.bi,s=t.bj,n=t.si,o=t.sj,r=this.world,a=this.currentContactMaterial;let h=a.friction;const l=n.material||i.material,c=o.material||s.material;if(l&&c&&l.friction>=0&&c.friction>=0&&(h=l.friction*c.friction),h>0){const n=h*r.gravity.length();let o=i.invMass+s.invMass;o>0&&(o=1/o);const l=this.frictionEquationPool,c=l.length?l.pop():new Dp(i,s,n*o),d=l.length?l.pop():new Dp(i,s,n*o);return c.bi=d.bi=i,c.bj=d.bj=s,c.minForce=d.minForce=-n*o,c.maxForce=d.maxForce=n*o,c.ri.copy(t.ri),c.rj.copy(t.rj),d.ri.copy(t.ri),d.rj.copy(t.rj),t.ni.tangents(c.t,d.t),c.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,r.dt),d.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,r.dt),c.enabled=d.enabled=t.enabled,e.push(c,d),!0}return!1}createFrictionFromAverage(t){let e=this.result[this.result.length-1];if(!this.createFrictionEquationsFromContact(e,this.frictionResult)||1===t)return;const i=this.frictionResult[this.frictionResult.length-2],s=this.frictionResult[this.frictionResult.length-1];ff.setZero(),gf.setZero(),yf.setZero();const n=e.bi;e.bj;for(let i=0;i!==t;i++)e=this.result[this.result.length-1-i],e.bi!==n?(ff.vadd(e.ni,ff),gf.vadd(e.ri,gf),yf.vadd(e.rj,yf)):(ff.vsub(e.ni,ff),gf.vadd(e.rj,gf),yf.vadd(e.ri,yf));const o=1/t;gf.scale(o,i.ri),yf.scale(o,i.rj),s.ri.copy(i.ri),s.rj.copy(i.rj),ff.normalize(),ff.tangents(i.t,s.t)}getContacts(t,e,i,s,n,o,r){this.contactPointPool=n,this.frictionEquationPool=r,this.result=s,this.frictionResult=o;const a=xf,h=bf,l=vf,c=wf;for(let s=0,n=t.length;s!==n;s++){const n=t[s],o=e[s];let r=null;n.material&&o.material&&(r=i.getContactMaterial(n.material,o.material)||null);const d=n.type&du.KINEMATIC&&o.type&du.STATIC||n.type&du.STATIC&&o.type&du.KINEMATIC||n.type&du.KINEMATIC&&o.type&du.KINEMATIC;for(let t=0;t<n.shapes.length;t++){n.quaternion.mult(n.shapeOrientations[t],a),n.quaternion.vmult(n.shapeOffsets[t],l),l.vadd(n.position,l);const e=n.shapes[t];for(let t=0;t<o.shapes.length;t++){o.quaternion.mult(o.shapeOrientations[t],h),o.quaternion.vmult(o.shapeOffsets[t],c),c.vadd(o.position,c);const s=o.shapes[t];if(!(e.collisionFilterMask&s.collisionFilterGroup&&s.collisionFilterMask&e.collisionFilterGroup))continue;if(l.distanceTo(c)>e.boundingSphereRadius+s.boundingSphereRadius)continue;let u=null;e.material&&s.material&&(u=i.getContactMaterial(e.material,s.material)||null),this.currentContactMaterial=u||r||i.defaultContactMaterial;const p=this[e.type|s.type];if(p){let t=!1;t=e.type<s.type?p.call(this,e,s,l,c,a,h,n,o,e,s,d):p.call(this,s,e,c,l,h,a,o,n,e,s,d),t&&d&&(i.shapeOverlapKeeper.set(e.id,s.id),i.bodyOverlapKeeper.set(n.id,o.id))}}}}}sphereSphere(t,e,i,s,n,o,r,a,h,l,c){if(c)return i.distanceSquared(s)<(t.radius+e.radius)**2;const d=this.createContactEquation(r,a,t,e,h,l);s.vsub(i,d.ni),d.ni.normalize(),d.ri.copy(d.ni),d.rj.copy(d.ni),d.ri.scale(t.radius,d.ri),d.rj.scale(-e.radius,d.rj),d.ri.vadd(i,d.ri),d.ri.vsub(r.position,d.ri),d.rj.vadd(s,d.rj),d.rj.vsub(a.position,d.rj),this.result.push(d),this.createFrictionEquationsFromContact(d,this.frictionResult)}spherePlane(t,e,i,s,n,o,r,a,h,l,c){const d=this.createContactEquation(r,a,t,e,h,l);if(d.ni.set(0,0,1),o.vmult(d.ni,d.ni),d.ni.negate(d.ni),d.ni.normalize(),d.ni.scale(t.radius,d.ri),i.vsub(s,Wf),d.ni.scale(d.ni.dot(Wf),Hf),Wf.vsub(Hf,d.rj),-Wf.dot(d.ni)<=t.radius){if(c)return!0;const t=d.ri,e=d.rj;t.vadd(i,t),t.vsub(r.position,t),e.vadd(s,e),e.vsub(a.position,e),this.result.push(d),this.createFrictionEquationsFromContact(d,this.frictionResult)}}boxBox(t,e,i,s,n,o,r,a,h,l,c){return t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e.convexPolyhedronRepresentation,i,s,n,o,r,a,t,e,c)}sphereBox(t,e,i,s,n,o,r,a,h,l,c){const d=this.v3pool,u=Zf;i.vsub(s,qf),e.getSideNormals(u,o);const p=t.radius;let m=!1;const f=Jf,g=Qf,y=tg;let v=null,w=0,x=0,b=0,S=null;for(let t=0,e=u.length;t!==e&&!1===m;t++){const e=$f;e.copy(u[t]);const i=e.length();e.normalize();const s=qf.dot(e);if(s<i+p&&s>0){const n=Xf,o=Yf;n.copy(u[(t+1)%3]),o.copy(u[(t+2)%3]);const r=n.length(),a=o.length();n.normalize(),o.normalize();const h=qf.dot(n),l=qf.dot(o);if(h<r&&h>-r&&l<a&&l>-a){const t=Math.abs(s-i-p);if((null===S||t<S)&&(S=t,x=h,b=l,v=i,f.copy(e),g.copy(n),y.copy(o),w++,c))return!0}}}if(w){m=!0;const n=this.createContactEquation(r,a,t,e,h,l);f.scale(-p,n.ri),n.ni.copy(f),n.ni.negate(n.ni),f.scale(v,f),g.scale(x,g),f.vadd(g,f),y.scale(b,y),f.vadd(y,n.rj),n.ri.vadd(i,n.ri),n.ri.vsub(r.position,n.ri),n.rj.vadd(s,n.rj),n.rj.vsub(a.position,n.rj),this.result.push(n),this.createFrictionEquationsFromContact(n,this.frictionResult)}let M=d.get();const T=Kf;for(let n=0;2!==n&&!m;n++)for(let o=0;2!==o&&!m;o++)for(let d=0;2!==d&&!m;d++)if(M.set(0,0,0),n?M.vadd(u[0],M):M.vsub(u[0],M),o?M.vadd(u[1],M):M.vsub(u[1],M),d?M.vadd(u[2],M):M.vsub(u[2],M),s.vadd(M,T),T.vsub(i,T),T.lengthSquared()<p*p){if(c)return!0;m=!0;const n=this.createContactEquation(r,a,t,e,h,l);n.ri.copy(T),n.ri.normalize(),n.ni.copy(n.ri),n.ri.scale(p,n.ri),n.rj.copy(M),n.ri.vadd(i,n.ri),n.ri.vsub(r.position,n.ri),n.rj.vadd(s,n.rj),n.rj.vsub(a.position,n.rj),this.result.push(n),this.createFrictionEquationsFromContact(n,this.frictionResult)}d.release(M),M=null;const _=d.get(),E=d.get(),L=d.get(),C=d.get(),A=d.get(),P=u.length;for(let n=0;n!==P&&!m;n++)for(let o=0;o!==P&&!m;o++)if(n%3!=o%3){u[o].cross(u[n],_),_.normalize(),u[n].vadd(u[o],E),L.copy(i),L.vsub(E,L),L.vsub(s,L);const d=L.dot(_);_.scale(d,C);let f=0;for(;f===n%3||f===o%3;)f++;A.copy(i),A.vsub(C,A),A.vsub(E,A),A.vsub(s,A);const g=Math.abs(d),y=A.length();if(g<u[f].length()&&y<p){if(c)return!0;m=!0;const n=this.createContactEquation(r,a,t,e,h,l);E.vadd(C,n.rj),n.rj.copy(n.rj),A.negate(n.ni),n.ni.normalize(),n.ri.copy(n.rj),n.ri.vadd(s,n.ri),n.ri.vsub(i,n.ri),n.ri.normalize(),n.ri.scale(p,n.ri),n.ri.vadd(i,n.ri),n.ri.vsub(r.position,n.ri),n.rj.vadd(s,n.rj),n.rj.vsub(a.position,n.rj),this.result.push(n),this.createFrictionEquationsFromContact(n,this.frictionResult)}}d.release(_,E,L,C,A)}planeBox(t,e,i,s,n,o,r,a,h,l,c){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,e.convexPolyhedronRepresentation.id=e.id,this.planeConvex(t,e.convexPolyhedronRepresentation,i,s,n,o,r,a,t,e,c)}convexConvex(t,e,i,s,n,o,r,a,h,l,c,d,u){const p=fg;if(!(i.distanceTo(s)>t.boundingSphereRadius+e.boundingSphereRadius)&&t.findSeparatingAxis(e,i,n,s,o,p,d,u)){const d=[],u=gg;t.clipAgainstHull(i,n,e,s,o,p,-100,100,d);let m=0;for(let n=0;n!==d.length;n++){if(c)return!0;const o=this.createContactEquation(r,a,t,e,h,l),f=o.ri,g=o.rj;p.negate(o.ni),d[n].normal.negate(u),u.scale(d[n].depth,u),d[n].point.vadd(u,f),g.copy(d[n].point),f.vsub(i,f),g.vsub(s,g),f.vadd(i,f),f.vsub(r.position,f),g.vadd(s,g),g.vsub(a.position,g),this.result.push(o),m++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(o,this.frictionResult)}this.enableFrictionReduction&&m&&this.createFrictionFromAverage(m)}}sphereConvex(t,e,i,s,n,o,r,a,h,l,c){const d=this.v3pool;i.vsub(s,eg);const u=e.faceNormals,p=e.faces,m=e.vertices,f=t.radius;let g=!1;for(let n=0;n!==m.length;n++){const d=m[n],u=og;o.vmult(d,u),s.vadd(u,u);const p=ng;if(u.vsub(i,p),p.lengthSquared()<f*f){if(c)return!0;g=!0;const n=this.createContactEquation(r,a,t,e,h,l);return n.ri.copy(p),n.ri.normalize(),n.ni.copy(n.ri),n.ri.scale(f,n.ri),u.vsub(s,n.rj),n.ri.vadd(i,n.ri),n.ri.vsub(r.position,n.ri),n.rj.vadd(s,n.rj),n.rj.vsub(a.position,n.rj),this.result.push(n),void this.createFrictionEquationsFromContact(n,this.frictionResult)}}for(let n=0,y=p.length;n!==y&&!1===g;n++){const y=u[n],v=p[n],w=rg;o.vmult(y,w);const x=ag;o.vmult(m[v[0]],x),x.vadd(s,x);const b=hg;w.scale(-f,b),i.vadd(b,b);const S=lg;b.vsub(x,S);const M=S.dot(w),T=cg;if(i.vsub(x,T),M<0&&T.dot(w)>0){const n=[];for(let t=0,e=v.length;t!==e;t++){const e=d.get();o.vmult(m[v[t]],e),s.vadd(e,e),n.push(e)}if(jf(n,w,i)){if(c)return!0;g=!0;const o=this.createContactEquation(r,a,t,e,h,l);w.scale(-f,o.ri),w.negate(o.ni);const u=d.get();w.scale(-M,u);const p=d.get();w.scale(-f,p),i.vsub(s,o.rj),o.rj.vadd(p,o.rj),o.rj.vadd(u,o.rj),o.rj.vadd(s,o.rj),o.rj.vsub(a.position,o.rj),o.ri.vadd(i,o.ri),o.ri.vsub(r.position,o.ri),d.release(u),d.release(p),this.result.push(o),this.createFrictionEquationsFromContact(o,this.frictionResult);for(let t=0,e=n.length;t!==e;t++)d.release(n[t]);return}for(let u=0;u!==v.length;u++){const p=d.get(),g=d.get();o.vmult(m[v[(u+1)%v.length]],p),o.vmult(m[v[(u+2)%v.length]],g),s.vadd(p,p),s.vadd(g,g);const y=ig;g.vsub(p,y);const w=sg;y.unit(w);const x=d.get(),b=d.get();i.vsub(p,b);const S=b.dot(w);w.scale(S,x),x.vadd(p,x);const M=d.get();if(x.vsub(i,M),S>0&&S*S<y.lengthSquared()&&M.lengthSquared()<f*f){if(c)return!0;const o=this.createContactEquation(r,a,t,e,h,l);x.vsub(s,o.rj),x.vsub(i,o.ni),o.ni.normalize(),o.ni.scale(f,o.ri),o.rj.vadd(s,o.rj),o.rj.vsub(a.position,o.rj),o.ri.vadd(i,o.ri),o.ri.vsub(r.position,o.ri),this.result.push(o),this.createFrictionEquationsFromContact(o,this.frictionResult);for(let t=0,e=n.length;t!==e;t++)d.release(n[t]);return d.release(p),d.release(g),d.release(x),d.release(M),void d.release(b)}d.release(p),d.release(g),d.release(x),d.release(M),d.release(b)}for(let t=0,e=n.length;t!==e;t++)d.release(n[t])}}}planeConvex(t,e,i,s,n,o,r,a,h,l,c){const d=dg,u=ug;u.set(0,0,1),n.vmult(u,u);let p=0;const m=pg;for(let n=0;n!==e.vertices.length;n++)if(d.copy(e.vertices[n]),o.vmult(d,d),s.vadd(d,d),d.vsub(i,m),u.dot(m)<=0){if(c)return!0;const n=this.createContactEquation(r,a,t,e,h,l),o=mg;u.scale(u.dot(m),o),d.vsub(o,o),o.vsub(i,n.ri),n.ni.copy(u),d.vsub(s,n.rj),n.ri.vadd(i,n.ri),n.ri.vsub(r.position,n.ri),n.rj.vadd(s,n.rj),n.rj.vsub(a.position,n.rj),this.result.push(n),p++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(n,this.frictionResult)}this.enableFrictionReduction&&p&&this.createFrictionFromAverage(p)}boxConvex(t,e,i,s,n,o,r,a,h,l,c){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e,i,s,n,o,r,a,t,e,c)}sphereHeightfield(t,e,i,s,n,o,r,a,h,l,c){const d=e.data,u=t.radius,p=e.elementSize,m=Pg,f=Ag;eu.pointToLocalFrame(s,o,i,f);let g=Math.floor((f.x-u)/p)-1,y=Math.ceil((f.x+u)/p)+1,v=Math.floor((f.y-u)/p)-1,w=Math.ceil((f.y+u)/p)+1;if(y<0||w<0||g>d.length||v>d[0].length)return;g<0&&(g=0),y<0&&(y=0),v<0&&(v=0),w<0&&(w=0),g>=d.length&&(g=d.length-1),y>=d.length&&(y=d.length-1),w>=d[0].length&&(w=d[0].length-1),v>=d[0].length&&(v=d[0].length-1);const x=[];e.getRectMinMax(g,v,y,w,x);const b=x[0],S=x[1];if(f.z-u>S||f.z+u<b)return;const M=this.result;for(let h=g;h<y;h++)for(let l=v;l<w;l++){const d=M.length;let u=!1;if(e.getConvexTrianglePillar(h,l,!1),eu.pointToWorldFrame(s,o,e.pillarOffset,m),i.distanceTo(m)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(u=this.sphereConvex(t,e.pillarConvex,i,m,n,o,r,a,t,e,c)),c&&u)return!0;if(e.getConvexTrianglePillar(h,l,!0),eu.pointToWorldFrame(s,o,e.pillarOffset,m),i.distanceTo(m)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(u=this.sphereConvex(t,e.pillarConvex,i,m,n,o,r,a,t,e,c)),c&&u)return!0;if(M.length-d>2)return}}boxHeightfield(t,e,i,s,n,o,r,a,h,l,c){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexHeightfield(t.convexPolyhedronRepresentation,e,i,s,n,o,r,a,t,e,c)}convexHeightfield(t,e,i,s,n,o,r,a,h,l,c){const d=e.data,u=e.elementSize,p=t.boundingSphereRadius,m=Lg,f=Cg,g=Eg;eu.pointToLocalFrame(s,o,i,g);let y=Math.floor((g.x-p)/u)-1,v=Math.ceil((g.x+p)/u)+1,w=Math.floor((g.y-p)/u)-1,x=Math.ceil((g.y+p)/u)+1;if(v<0||x<0||y>d.length||w>d[0].length)return;y<0&&(y=0),v<0&&(v=0),w<0&&(w=0),x<0&&(x=0),y>=d.length&&(y=d.length-1),v>=d.length&&(v=d.length-1),x>=d[0].length&&(x=d[0].length-1),w>=d[0].length&&(w=d[0].length-1);const b=[];e.getRectMinMax(y,w,v,x,b);const S=b[0],M=b[1];if(!(g.z-p>M||g.z+p<S))for(let h=y;h<v;h++)for(let l=w;l<x;l++){let d=!1;if(e.getConvexTrianglePillar(h,l,!1),eu.pointToWorldFrame(s,o,e.pillarOffset,m),i.distanceTo(m)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(d=this.convexConvex(t,e.pillarConvex,i,m,n,o,r,a,null,null,c,f,null)),c&&d)return!0;if(e.getConvexTrianglePillar(h,l,!0),eu.pointToWorldFrame(s,o,e.pillarOffset,m),i.distanceTo(m)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(d=this.convexConvex(t,e.pillarConvex,i,m,n,o,r,a,null,null,c,f,null)),c&&d)return!0}}sphereParticle(t,e,i,s,n,o,r,a,h,l,c){const d=xg;if(d.set(0,0,1),s.vsub(i,d),d.lengthSquared()<=t.radius*t.radius){if(c)return!0;const i=this.createContactEquation(a,r,e,t,h,l);d.normalize(),i.rj.copy(d),i.rj.scale(t.radius,i.rj),i.ni.copy(d),i.ni.negate(i.ni),i.ri.set(0,0,0),this.result.push(i),this.createFrictionEquationsFromContact(i,this.frictionResult)}}planeParticle(t,e,i,s,n,o,r,a,h,l,c){const d=yg;d.set(0,0,1),r.quaternion.vmult(d,d);const u=vg;if(s.vsub(r.position,u),d.dot(u)<=0){if(c)return!0;const i=this.createContactEquation(a,r,e,t,h,l);i.ni.copy(d),i.ni.negate(i.ni),i.ri.set(0,0,0);const n=wg;d.scale(d.dot(s),n),s.vsub(n,n),i.rj.copy(n),this.result.push(i),this.createFrictionEquationsFromContact(i,this.frictionResult)}}boxParticle(t,e,i,s,n,o,r,a,h,l,c){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexParticle(t.convexPolyhedronRepresentation,e,i,s,n,o,r,a,t,e,c)}convexParticle(t,e,i,s,n,o,r,a,h,l,c){let d=-1;const u=Mg,p=_g;let m=null;const f=Sg;if(f.copy(s),f.vsub(i,f),n.conjugate(bg),bg.vmult(f,f),t.pointIsInside(f)){t.worldVerticesNeedsUpdate&&t.computeWorldVertices(i,n),t.worldFaceNormalsNeedsUpdate&&t.computeWorldFaceNormals(n);for(let e=0,i=t.faces.length;e!==i;e++){const i=[t.worldVertices[t.faces[e][0]]],n=t.worldFaceNormals[e];s.vsub(i[0],Tg);const o=-n.dot(Tg);if(null===m||Math.abs(o)<Math.abs(m)){if(c)return!0;m=o,d=e,u.copy(n)}}if(-1!==d){const n=this.createContactEquation(a,r,e,t,h,l);u.scale(m,p),p.vadd(s,p),p.vsub(i,p),n.rj.copy(p),u.negate(n.ni),n.ri.set(0,0,0);const o=n.ri,c=n.rj;o.vadd(s,o),o.vsub(a.position,o),c.vadd(i,c),c.vsub(r.position,c),this.result.push(n),this.createFrictionEquationsFromContact(n,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}}heightfieldCylinder(t,e,i,s,n,o,r,a,h,l,c){return this.convexHeightfield(e,t,s,i,o,n,a,r,h,l,c)}particleCylinder(t,e,i,s,n,o,r,a,h,l,c){return this.convexParticle(e,t,s,i,o,n,a,r,h,l,c)}sphereTrimesh(t,e,i,s,n,o,r,a,h,l,c){const d=Af,u=Pf,p=kf,m=Bf,f=Rf,g=Df,y=Of,v=Cf,w=Ef,x=Nf;eu.pointToLocalFrame(s,o,i,f);const b=t.radius;y.lowerBound.set(f.x-b,f.y-b,f.z-b),y.upperBound.set(f.x+b,f.y+b,f.z+b),e.getTrianglesInAABB(y,x);const S=Lf,M=t.radius*t.radius;for(let n=0;n<x.length;n++)for(let d=0;d<3;d++)if(e.getVertex(e.indices[3*x[n]+d],S),S.vsub(f,w),w.lengthSquared()<=M){if(v.copy(S),eu.pointToWorldFrame(s,o,v,S),S.vsub(i,w),c)return!0;let n=this.createContactEquation(r,a,t,e,h,l);n.ni.copy(w),n.ni.normalize(),n.ri.copy(n.ni),n.ri.scale(t.radius,n.ri),n.ri.vadd(i,n.ri),n.ri.vsub(r.position,n.ri),n.rj.copy(S),n.rj.vsub(a.position,n.rj),this.result.push(n),this.createFrictionEquationsFromContact(n,this.frictionResult)}for(let n=0;n<x.length;n++)for(let y=0;y<3;y++){e.getVertex(e.indices[3*x[n]+y],d),e.getVertex(e.indices[3*x[n]+(y+1)%3],u),u.vsub(d,p),f.vsub(u,g);const v=g.dot(p);f.vsub(d,g);let w=g.dot(p);if(w>0&&v<0&&(f.vsub(d,g),m.copy(p),m.normalize(),w=g.dot(m),m.scale(w,g),g.vadd(d,g),g.distanceTo(f)<t.radius)){if(c)return!0;const n=this.createContactEquation(r,a,t,e,h,l);g.vsub(f,n.ni),n.ni.normalize(),n.ni.scale(t.radius,n.ri),n.ri.vadd(i,n.ri),n.ri.vsub(r.position,n.ri),eu.pointToWorldFrame(s,o,g,g),g.vsub(a.position,n.rj),eu.vectorToWorldFrame(o,n.ni,n.ni),eu.vectorToWorldFrame(o,n.ri,n.ri),this.result.push(n),this.createFrictionEquationsFromContact(n,this.frictionResult)}}const T=If,_=Ff,E=zf,L=_f;for(let n=0,d=x.length;n!==d;n++){e.getTriangleVertices(x[n],T,_,E),e.getNormal(x[n],L),f.vsub(T,g);let d=g.dot(L);if(L.scale(d,g),f.vsub(g,g),d=g.distanceTo(f),Nu.pointInTriangle(g,T,_,E)&&d<t.radius){if(c)return!0;let n=this.createContactEquation(r,a,t,e,h,l);g.vsub(f,n.ni),n.ni.normalize(),n.ni.scale(t.radius,n.ri),n.ri.vadd(i,n.ri),n.ri.vsub(r.position,n.ri),eu.pointToWorldFrame(s,o,g,g),g.vsub(a.position,n.rj),eu.vectorToWorldFrame(o,n.ni,n.ni),eu.vectorToWorldFrame(o,n.ri,n.ri),this.result.push(n),this.createFrictionEquationsFromContact(n,this.frictionResult)}}x.length=0}planeTrimesh(t,e,i,s,n,o,r,a,h,l,c){const d=new Ud,u=Sf;u.set(0,0,1),n.vmult(u,u);for(let n=0;n<e.vertices.length/3;n++){e.getVertex(n,d);const p=new Ud;p.copy(d),eu.pointToWorldFrame(s,o,p,d);const m=Mf;if(d.vsub(i,m),u.dot(m)<=0){if(c)return!0;const i=this.createContactEquation(r,a,t,e,h,l);i.ni.copy(u);const s=Tf;u.scale(m.dot(u),s),d.vsub(s,s),i.ri.copy(s),i.ri.vsub(r.position,i.ri),i.rj.copy(d),i.rj.vsub(a.position,i.rj),this.result.push(i),this.createFrictionEquationsFromContact(i,this.frictionResult)}}}}const ff=new Ud,gf=new Ud,yf=new Ud,vf=new Ud,wf=new Ud,xf=new Kd,bf=new Kd,Sf=new Ud,Mf=new Ud,Tf=new Ud,_f=new Ud,Ef=new Ud,Lf=new Ud,Cf=new Ud,Af=new Ud,Pf=new Ud,kf=new Ud,Bf=new Ud,Rf=new Ud,Df=new Ud,If=new Ud,Ff=new Ud,zf=new Ud,Of=new qd,Nf=[],Wf=new Ud,Hf=new Ud,Uf=new Ud,Vf=new Ud,Gf=new Ud;function jf(t,e,i){let s=null;const n=t.length;for(let o=0;o!==n;o++){const r=t[o],a=Uf;t[(o+1)%n].vsub(r,a);const h=Vf;a.cross(e,h);const l=Gf;i.vsub(r,l);const c=h.dot(l);if(!(null===s||c>0&&!0===s||c<=0&&!1===s))return!1;null===s&&(s=c>0)}return!0}const qf=new Ud,$f=new Ud,Xf=new Ud,Yf=new Ud,Zf=[new Ud,new Ud,new Ud,new Ud,new Ud,new Ud],Kf=new Ud,Jf=new Ud,Qf=new Ud,tg=new Ud,eg=new Ud,ig=new Ud,sg=new Ud,ng=new Ud,og=new Ud,rg=new Ud,ag=new Ud,hg=new Ud,lg=new Ud,cg=new Ud,dg=new Ud,ug=new Ud,pg=new Ud,mg=new Ud,fg=new Ud,gg=new Ud,yg=new Ud,vg=new Ud,wg=new Ud,xg=new Ud,bg=new Kd,Sg=new Ud,Mg=new Ud,Tg=new Ud,_g=new Ud,Eg=new Ud,Lg=new Ud,Cg=[0],Ag=new Ud,Pg=new Ud;class kg{constructor(){this.current=void 0,this.previous=void 0,this.current=[],this.previous=[]}getKey(t,e){if(e<t){const i=e;e=t,t=i}return t<<16|e}set(t,e){const i=this.getKey(t,e),s=this.current;let n=0;for(;i>s[n];)n++;if(i!==s[n]){for(let t=s.length-1;t>=n;t--)s[t+1]=s[t];s[n]=i}}tick(){const t=this.current;this.current=this.previous,this.previous=t,this.current.length=0}getDiff(t,e){const i=this.current,s=this.previous,n=i.length,o=s.length;let r=0;for(let e=0;e<n;e++){let n=!1;const o=i[e];for(;o>s[r];)r++;n=o===s[r],n||Bg(t,o)}r=0;for(let t=0;t<o;t++){let n=!1;const o=s[t];for(;o>i[r];)r++;n=i[r]===o,n||Bg(e,o)}}}function Bg(t,e){t.push((4294901760&e)>>16,65535&e)}class Rg{constructor(){this.data={keys:[]}}get(t,e){if(t>e){const i=e;e=t,t=i}return this.data[t+"-"+e]}set(t,e,i){if(t>e){const i=e;e=t,t=i}const s=t+"-"+e;this.get(t,e)||this.data.keys.push(s),this.data[s]=i}reset(){const t=this.data,e=t.keys;for(;e.length>0;)delete t[e.pop()]}}class Dg extends Zd{constructor(t={}){super(),this.dt=void 0,this.allowSleep=void 0,this.contacts=void 0,this.frictionEquations=void 0,this.quatNormalizeSkip=void 0,this.quatNormalizeFast=void 0,this.time=void 0,this.stepnumber=void 0,this.default_dt=void 0,this.nextId=void 0,this.gravity=void 0,this.broadphase=void 0,this.bodies=void 0,this.hasActiveBodies=void 0,this.solver=void 0,this.constraints=void 0,this.narrowphase=void 0,this.collisionMatrix=void 0,this.collisionMatrixPrevious=void 0,this.bodyOverlapKeeper=void 0,this.shapeOverlapKeeper=void 0,this.materials=void 0,this.contactmaterials=void 0,this.contactMaterialTable=void 0,this.defaultMaterial=void 0,this.defaultContactMaterial=void 0,this.doProfiling=void 0,this.profile=void 0,this.accumulator=void 0,this.subsystems=void 0,this.addBodyEvent=void 0,this.removeBodyEvent=void 0,this.idToBodyMap=void 0,this.dt=-1,this.allowSleep=!!t.allowSleep,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=void 0!==t.quatNormalizeSkip?t.quatNormalizeSkip:0,this.quatNormalizeFast=void 0!==t.quatNormalizeFast&&t.quatNormalizeFast,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new Ud,t.gravity&&this.gravity.copy(t.gravity),this.broadphase=void 0!==t.broadphase?t.broadphase:new Pu,this.bodies=[],this.hasActiveBodies=!1,this.solver=void 0!==t.solver?t.solver:new Im,this.constraints=[],this.narrowphase=new mf(this),this.collisionMatrix=new Yd,this.collisionMatrixPrevious=new Yd,this.bodyOverlapKeeper=new kg,this.shapeOverlapKeeper=new kg,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new Rg,this.defaultMaterial=new Op("default"),this.defaultContactMaterial=new zp(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.accumulator=0,this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.idToBodyMap={},this.broadphase.setWorld(this)}getContactMaterial(t,e){return this.contactMaterialTable.get(t.id,e.id)}numObjects(){return this.bodies.length}collisionMatrixTick(){const t=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=t,this.collisionMatrix.reset(),this.bodyOverlapKeeper.tick(),this.shapeOverlapKeeper.tick()}addConstraint(t){this.constraints.push(t)}removeConstraint(t){const e=this.constraints.indexOf(t);-1!==e&&this.constraints.splice(e,1)}rayTest(t,e,i){i instanceof ku?this.raycastClosest(t,e,{skipBackfaces:!0},i):this.raycastAll(t,e,{skipBackfaces:!0},i)}raycastAll(t,e,i={},s){return i.mode=Nu.ALL,i.from=t,i.to=e,i.callback=s,Ig.intersectWorld(this,i)}raycastAny(t,e,i={},s){return i.mode=Nu.ANY,i.from=t,i.to=e,i.result=s,Ig.intersectWorld(this,i)}raycastClosest(t,e,i={},s){return i.mode=Nu.CLOSEST,i.from=t,i.to=e,i.result=s,Ig.intersectWorld(this,i)}addBody(t){this.bodies.includes(t)||(t.index=this.bodies.length,this.bodies.push(t),t.world=this,t.initPosition.copy(t.position),t.initVelocity.copy(t.velocity),t.timeLastSleepy=this.time,t instanceof du&&(t.initAngularVelocity.copy(t.angularVelocity),t.initQuaternion.copy(t.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=t,this.idToBodyMap[t.id]=t,this.dispatchEvent(this.addBodyEvent))}removeBody(t){t.world=null;const e=this.bodies.length-1,i=this.bodies,s=i.indexOf(t);if(-1!==s){i.splice(s,1);for(let t=0;t!==i.length;t++)i[t].index=t;this.collisionMatrix.setNumObjects(e),this.removeBodyEvent.body=t,delete this.idToBodyMap[t.id],this.dispatchEvent(this.removeBodyEvent)}}getBodyById(t){return this.idToBodyMap[t]}getShapeById(t){const e=this.bodies;for(let i=0;i<e.length;i++){const s=e[i].shapes;for(let e=0;e<s.length;e++){const i=s[e];if(i.id===t)return i}}return null}addMaterial(t){this.materials.push(t)}addContactMaterial(t){this.contactmaterials.push(t),this.contactMaterialTable.set(t.materials[0].id,t.materials[1].id,t)}step(t,e,i=10){if(void 0===e)this.internalStep(t),this.time+=t;else{this.accumulator+=e;const s=Fg.now();let n=0;for(;this.accumulator>=t&&n<i&&(this.internalStep(t),this.accumulator-=t,n++,!(Fg.now()-s>1e3*t)););this.accumulator=this.accumulator%t;const o=this.accumulator/t;for(let t=0;t!==this.bodies.length;t++){const e=this.bodies[t];e.previousPosition.lerp(e.position,o,e.interpolatedPosition),e.previousQuaternion.slerp(e.quaternion,o,e.interpolatedQuaternion),e.previousQuaternion.normalize()}this.time+=e}}internalStep(t){this.dt=t;const e=this.contacts,i=Ug,s=Vg,n=this.numObjects(),o=this.bodies,r=this.solver,a=this.gravity,h=this.doProfiling,l=this.profile,c=du.DYNAMIC;let d=-1/0;const u=this.constraints,p=Hg;a.length();const m=a.x,f=a.y,g=a.z;let y=0;for(h&&(d=Fg.now()),y=0;y!==n;y++){const t=o[y];if(t.type===c){const e=t.force,i=t.mass;e.x+=i*m,e.y+=i*f,e.z+=i*g}}for(let t=0,e=this.subsystems.length;t!==e;t++)this.subsystems[t].update();h&&(d=Fg.now()),i.length=0,s.length=0,this.broadphase.collisionPairs(this,i,s),h&&(l.broadphase=Fg.now()-d);let v=u.length;for(y=0;y!==v;y++){const t=u[y];if(!t.collideConnected)for(let e=i.length-1;e>=0;e-=1)(t.bodyA===i[e]&&t.bodyB===s[e]||t.bodyB===i[e]&&t.bodyA===s[e])&&(i.splice(e,1),s.splice(e,1))}this.collisionMatrixTick(),h&&(d=Fg.now());const w=Wg,x=e.length;for(y=0;y!==x;y++)w.push(e[y]);e.length=0;const b=this.frictionEquations.length;for(y=0;y!==b;y++)p.push(this.frictionEquations[y]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(i,s,this,e,w,this.frictionEquations,p),h&&(l.narrowphase=Fg.now()-d),h&&(d=Fg.now()),y=0;y<this.frictionEquations.length;y++)r.addEquation(this.frictionEquations[y]);const S=e.length;for(let t=0;t!==S;t++){const i=e[t],s=i.bi,n=i.bj,o=i.si,a=i.sj;let h;h=s.material&&n.material&&this.getContactMaterial(s.material,n.material)||this.defaultContactMaterial,h.friction,s.material&&n.material&&(s.material.friction>=0&&n.material.friction>=0&&(s.material.friction,n.material.friction),s.material.restitution>=0&&n.material.restitution>=0&&(i.restitution=s.material.restitution*n.material.restitution)),r.addEquation(i),s.allowSleep&&s.type===du.DYNAMIC&&s.sleepState===du.SLEEPING&&n.sleepState===du.AWAKE&&n.type!==du.STATIC&&n.velocity.lengthSquared()+n.angularVelocity.lengthSquared()>=2*n.sleepSpeedLimit**2&&(s.wakeUpAfterNarrowphase=!0),n.allowSleep&&n.type===du.DYNAMIC&&n.sleepState===du.SLEEPING&&s.sleepState===du.AWAKE&&s.type!==du.STATIC&&s.velocity.lengthSquared()+s.angularVelocity.lengthSquared()>=2*s.sleepSpeedLimit**2&&(n.wakeUpAfterNarrowphase=!0),this.collisionMatrix.set(s,n,!0),this.collisionMatrixPrevious.get(s,n)||(Ng.body=n,Ng.contact=i,s.dispatchEvent(Ng),Ng.body=s,n.dispatchEvent(Ng)),this.bodyOverlapKeeper.set(s.id,n.id),this.shapeOverlapKeeper.set(o.id,a.id)}for(this.emitContactEvents(),h&&(l.makeContactConstraints=Fg.now()-d,d=Fg.now()),y=0;y!==n;y++){const t=o[y];t.wakeUpAfterNarrowphase&&(t.wakeUp(),t.wakeUpAfterNarrowphase=!1)}for(v=u.length,y=0;y!==v;y++){const t=u[y];t.update();for(let e=0,i=t.equations.length;e!==i;e++){const i=t.equations[e];r.addEquation(i)}}r.solve(t,this),h&&(l.solve=Fg.now()-d),r.removeAllEquations();const M=Math.pow;for(y=0;y!==n;y++){const e=o[y];if(e.type&c){const i=M(1-e.linearDamping,t),s=e.velocity;s.scale(i,s);const n=e.angularVelocity;if(n){const i=M(1-e.angularDamping,t);n.scale(i,n)}}}for(this.dispatchEvent(Og),y=0;y!==n;y++){const t=o[y];t.preStep&&t.preStep.call(t)}h&&(d=Fg.now());const T=this.stepnumber%(this.quatNormalizeSkip+1)==0,_=this.quatNormalizeFast;for(y=0;y!==n;y++)o[y].integrate(t,T,_);for(this.clearForces(),this.broadphase.dirty=!0,h&&(l.integrate=Fg.now()-d),this.stepnumber+=1,this.dispatchEvent(zg),y=0;y!==n;y++){const t=o[y],e=t.postStep;e&&e.call(t)}let E=!0;if(this.allowSleep)for(E=!1,y=0;y!==n;y++){const t=o[y];t.sleepTick(this.time),t.sleepState!==du.SLEEPING&&(E=!0)}this.hasActiveBodies=E}emitContactEvents(){const t=this.hasAnyEventListener("beginContact"),e=this.hasAnyEventListener("endContact");if((t||e)&&this.bodyOverlapKeeper.getDiff(Gg,jg),t){for(let t=0,e=Gg.length;t<e;t+=2)qg.bodyA=this.getBodyById(Gg[t]),qg.bodyB=this.getBodyById(Gg[t+1]),this.dispatchEvent(qg);qg.bodyA=qg.bodyB=null}if(e){for(let t=0,e=jg.length;t<e;t+=2)$g.bodyA=this.getBodyById(jg[t]),$g.bodyB=this.getBodyById(jg[t+1]),this.dispatchEvent($g);$g.bodyA=$g.bodyB=null}Gg.length=jg.length=0;const i=this.hasAnyEventListener("beginShapeContact"),s=this.hasAnyEventListener("endShapeContact");if((i||s)&&this.shapeOverlapKeeper.getDiff(Gg,jg),i){for(let t=0,e=Gg.length;t<e;t+=2){const e=this.getShapeById(Gg[t]),i=this.getShapeById(Gg[t+1]);Xg.shapeA=e,Xg.shapeB=i,e&&(Xg.bodyA=e.body),i&&(Xg.bodyB=i.body),this.dispatchEvent(Xg)}Xg.bodyA=Xg.bodyB=Xg.shapeA=Xg.shapeB=null}if(s){for(let t=0,e=jg.length;t<e;t+=2){const e=this.getShapeById(jg[t]),i=this.getShapeById(jg[t+1]);Yg.shapeA=e,Yg.shapeB=i,e&&(Yg.bodyA=e.body),i&&(Yg.bodyB=i.body),this.dispatchEvent(Yg)}Yg.bodyA=Yg.bodyB=Yg.shapeA=Yg.shapeB=null}}clearForces(){const t=this.bodies,e=t.length;for(let i=0;i!==e;i++){const e=t[i];e.force,e.torque,e.force.set(0,0,0),e.torque.set(0,0,0)}}}new qd;const Ig=new Nu,Fg=globalThis.performance||{};if(!Fg.now){let t=Date.now();Fg.timing&&Fg.timing.navigationStart&&(t=Fg.timing.navigationStart),Fg.now=()=>Date.now()-t}const zg={type:"postStep"},Og={type:"preStep"},Ng={type:du.COLLIDE_EVENT_NAME,body:null,contact:null},Wg=[],Hg=[],Ug=[],Vg=[],Gg=[],jg=[],qg={type:"beginContact",bodyA:null,bodyB:null},$g={type:"endContact",bodyA:null,bodyB:null},Xg={type:"beginShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},Yg={type:"endShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null};var Zg=function(){function t(t){zl.call(this,t),this.dracoLoader=null,this.ddsLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(t){return new r(t)})),this.register((function(t){return new h(t)})),this.register((function(t){return new l(t)})),this.register((function(t){return new a(t)})),this.register((function(t){return new n(t)})),this.register((function(t){return new d(t)}))}function e(){var t={};return{get:function(e){return t[e]},add:function(e,i){t[e]=i},remove:function(e){delete t[e]},removeAll:function(){t={}}}}t.prototype=Object.assign(Object.create(zl.prototype),{constructor:t,load:function(t,e,i,s){var n,o=this;n=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:Pc.extractUrlBase(t),this.manager.itemStart(t);var r=function(e){s?s(e):console.error(e),o.manager.itemError(t),o.manager.itemEnd(t)},a=new Nl(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(t,(function(i){try{o.parse(i,n,(function(i){e(i),o.manager.itemEnd(t)}),r)}catch(t){r(t)}}),i,r)},setDRACOLoader:function(t){return this.dracoLoader=t,this},setDDSLoader:function(t){return this.ddsLoader=t,this},setKTX2Loader:function(t){return this.ktx2Loader=t,this},setMeshoptDecoder:function(t){return this.meshoptDecoder=t,this},register:function(t){return-1===this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.push(t),this},unregister:function(t){return-1!==this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(t),1),this},parse:function(t,e,n,r){var a,h={},l={};if("string"==typeof t)a=t;else if(Pc.decodeText(new Uint8Array(t,0,4))===p){try{h[i.KHR_BINARY_GLTF]=new g(t)}catch(t){return void(r&&r(t))}a=h[i.KHR_BINARY_GLTF].content}else a=Pc.decodeText(new Uint8Array(t));var c=JSON.parse(a);if(void 0===c.asset||c.asset.version[0]<2)r&&r(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));else{var d=new I(c,{path:e||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});d.fileLoader.setRequestHeader(this.requestHeader);for(var u=0;u<this.pluginCallbacks.length;u++){var m=this.pluginCallbacks[u](d);l[m.name]=m,h[m.name]=!0}if(c.extensionsUsed)for(u=0;u<c.extensionsUsed.length;++u){var f=c.extensionsUsed[u],w=c.extensionsRequired||[];switch(f){case i.KHR_MATERIALS_UNLIT:h[f]=new o;break;case i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:h[f]=new x;break;case i.KHR_DRACO_MESH_COMPRESSION:h[f]=new y(c,this.dracoLoader);break;case i.MSFT_TEXTURE_DDS:h[f]=new s(this.ddsLoader);break;case i.KHR_TEXTURE_TRANSFORM:h[f]=new v;break;case i.KHR_MESH_QUANTIZATION:h[f]=new b;break;default:w.indexOf(f)>=0&&void 0===l[f]&&console.warn('THREE.GLTFLoader: Unknown extension "'+f+'".')}}d.setExtensions(h),d.setPlugins(l),d.parse(n,r)}}});var i={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function s(t){if(!t)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing DDSLoader");this.name=i.MSFT_TEXTURE_DDS,this.ddsLoader=t}function n(t){this.parser=t,this.name=i.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}function o(){this.name=i.KHR_MATERIALS_UNLIT}function r(t){this.parser=t,this.name=i.KHR_MATERIALS_CLEARCOAT}function a(t){this.parser=t,this.name=i.KHR_MATERIALS_TRANSMISSION}function h(t){this.parser=t,this.name=i.KHR_TEXTURE_BASISU}function l(t){this.parser=t,this.name=i.EXT_TEXTURE_WEBP,this.isSupported=null}function d(t){this.name=i.EXT_MESHOPT_COMPRESSION,this.parser=t}n.prototype._markDefs=function(){for(var t=this.parser,e=this.parser.json.nodes||[],i=0,s=e.length;i<s;i++){var n=e[i];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&t._addNodeRef(this.cache,n.extensions[this.name].light)}},n.prototype._loadLight=function(t){var e=this.parser,i="light:"+t,s=e.cache.get(i);if(s)return s;var n,o=e.json,r=((o.extensions&&o.extensions[this.name]||{}).lights||[])[t],a=new Ds(16777215);void 0!==r.color&&a.fromArray(r.color);var h=void 0!==r.range?r.range:0;switch(r.type){case"directional":(n=new Tc(a)).target.position.set(0,0,-1),n.add(n.target);break;case"point":(n=new bc(a)).distance=h;break;case"spot":(n=new wc(a)).distance=h,r.spot=r.spot||{},r.spot.innerConeAngle=void 0!==r.spot.innerConeAngle?r.spot.innerConeAngle:0,r.spot.outerConeAngle=void 0!==r.spot.outerConeAngle?r.spot.outerConeAngle:Math.PI/4,n.angle=r.spot.outerConeAngle,n.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,n.target.position.set(0,0,-1),n.add(n.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+r.type)}return n.position.set(0,0,0),n.decay=2,void 0!==r.intensity&&(n.intensity=r.intensity),n.name=e.createUniqueName(r.name||"light_"+t),s=Promise.resolve(n),e.cache.add(i,s),s},n.prototype.createNodeAttachment=function(t){var e=this,i=this.parser,s=i.json.nodes[t],n=(s.extensions&&s.extensions[this.name]||{}).light;return void 0===n?null:this._loadLight(n).then((function(t){return i._getNodeRef(e.cache,n,t)}))},o.prototype.getMaterialType=function(){return Os},o.prototype.extendParams=function(t,e,i){var s=[];t.color=new Ds(1,1,1),t.opacity=1;var n=e.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){var o=n.baseColorFactor;t.color.fromArray(o),t.opacity=o[3]}void 0!==n.baseColorTexture&&s.push(i.assignTexture(t,"map",n.baseColorTexture))}return Promise.all(s)},r.prototype.getMaterialType=function(t){var e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?dl:null},r.prototype.extendMaterialParams=function(t,e){var i=this.parser,s=i.json.materials[t];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();var n=[],o=s.extensions[this.name];if(void 0!==o.clearcoatFactor&&(e.clearcoat=o.clearcoatFactor),void 0!==o.clearcoatTexture&&n.push(i.assignTexture(e,"clearcoatMap",o.clearcoatTexture)),void 0!==o.clearcoatRoughnessFactor&&(e.clearcoatRoughness=o.clearcoatRoughnessFactor),void 0!==o.clearcoatRoughnessTexture&&n.push(i.assignTexture(e,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),void 0!==o.clearcoatNormalTexture&&(n.push(i.assignTexture(e,"clearcoatNormalMap",o.clearcoatNormalTexture)),void 0!==o.clearcoatNormalTexture.scale)){var r=o.clearcoatNormalTexture.scale;e.clearcoatNormalScale=new ii(r,r)}return Promise.all(n)},a.prototype.getMaterialType=function(t){var e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?dl:null},a.prototype.extendMaterialParams=function(t,e){var i=this.parser,s=i.json.materials[t];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();var n=[],o=s.extensions[this.name];return void 0!==o.transmissionFactor&&(e.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&n.push(i.assignTexture(e,"transmissionMap",o.transmissionTexture)),Promise.all(n)},h.prototype.loadTexture=function(t){var e=this.parser,i=e.json,s=i.textures[t];if(!s.extensions||!s.extensions[this.name])return null;var n=s.extensions[this.name],o=i.images[n.source],r=e.options.ktx2Loader;if(!r){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return e.loadTextureImage(t,o,r)},l.prototype.loadTexture=function(t){var e=this.name,i=this.parser,s=i.json,n=s.textures[t];if(!n.extensions||!n.extensions[e])return null;var o=n.extensions[e],r=s.images[o.source],a=r.uri?i.options.manager.getHandler(r.uri):i.textureLoader;return this.detectSupport().then((function(n){if(n)return i.loadTextureImage(t,r,a);if(s.extensionsRequired&&s.extensionsRequired.indexOf(e)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return i.loadTexture(t)}))},l.prototype.detectSupport=function(){return this.isSupported||(this.isSupported=new Promise((function(t){var e=new Image;e.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",e.onload=e.onerror=function(){t(1===e.height)}}))),this.isSupported},d.prototype.loadBufferView=function(t){var e=this.parser.json,i=e.bufferViews[t];if(i.extensions&&i.extensions[this.name]){var s=i.extensions[this.name],n=this.parser.getDependency("buffer",s.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(e.extensionsRequired&&e.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([n,o.ready]).then((function(t){var e=s.byteOffset||0,i=s.byteLength||0,n=s.count,r=s.byteStride,a=new ArrayBuffer(n*r),h=new Uint8Array(t[0],e,i);return o.decodeGltfBuffer(new Uint8Array(a),n,r,h,s.mode,s.filter),a}))}return null};var p="glTF",m=12,f={JSON:1313821514,BIN:5130562};function g(t){this.name=i.KHR_BINARY_GLTF,this.content=null,this.body=null;var e=new DataView(t,0,m);if(this.header={magic:Pc.decodeText(new Uint8Array(t.slice(0,4))),version:e.getUint32(4,!0),length:e.getUint32(8,!0)},this.header.magic!==p)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");for(var s=new DataView(t,m),n=0;n<s.byteLength;){var o=s.getUint32(n,!0);n+=4;var r=s.getUint32(n,!0);if(n+=4,r===f.JSON){var a=new Uint8Array(t,m+n,o);this.content=Pc.decodeText(a)}else if(r===f.BIN){var h=m+n;this.body=t.slice(h,h+o)}n+=o}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function y(t,e){if(!e)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=i.KHR_DRACO_MESH_COMPRESSION,this.json=t,this.dracoLoader=e,this.dracoLoader.preload()}function v(){this.name=i.KHR_TEXTURE_TRANSFORM}function w(t){cl.call(this),this.isGLTFSpecularGlossinessMaterial=!0;var e=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),i=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),s=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),n=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),o=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),r={specular:{value:(new Ds).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=r,this.onBeforeCompile=function(t){for(var a in r)t.uniforms[a]=r[a];t.fragmentShader=t.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",e).replace("#include <metalnessmap_pars_fragment>",i).replace("#include <roughnessmap_fragment>",s).replace("#include <metalnessmap_fragment>",n).replace("#include <lights_physical_fragment>",o)},Object.defineProperties(this,{specular:{get:function(){return r.specular.value},set:function(t){r.specular.value=t}},specularMap:{get:function(){return r.specularMap.value},set:function(t){r.specularMap.value=t,t?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return r.glossiness.value},set:function(t){r.glossiness.value=t}},glossinessMap:{get:function(){return r.glossinessMap.value},set:function(t){r.glossinessMap.value=t,t?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(t)}function x(){return{name:i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return w},extendParams:function(t,e,i){var s=e.extensions[this.name];t.color=new Ds(1,1,1),t.opacity=1;var n=[];if(Array.isArray(s.diffuseFactor)){var o=s.diffuseFactor;t.color.fromArray(o),t.opacity=o[3]}if(void 0!==s.diffuseTexture&&n.push(i.assignTexture(t,"map",s.diffuseTexture)),t.emissive=new Ds(0,0,0),t.glossiness=void 0!==s.glossinessFactor?s.glossinessFactor:1,t.specular=new Ds(1,1,1),Array.isArray(s.specularFactor)&&t.specular.fromArray(s.specularFactor),void 0!==s.specularGlossinessTexture){var r=s.specularGlossinessTexture;n.push(i.assignTexture(t,"glossinessMap",r)),n.push(i.assignTexture(t,"specularMap",r))}return Promise.all(n)},createMaterial:function(t){var e=new w(t);return e.fog=!0,e.color=t.color,e.map=void 0===t.map?null:t.map,e.lightMap=null,e.lightMapIntensity=1,e.aoMap=void 0===t.aoMap?null:t.aoMap,e.aoMapIntensity=1,e.emissive=t.emissive,e.emissiveIntensity=1,e.emissiveMap=void 0===t.emissiveMap?null:t.emissiveMap,e.bumpMap=void 0===t.bumpMap?null:t.bumpMap,e.bumpScale=1,e.normalMap=void 0===t.normalMap?null:t.normalMap,e.normalMapType=je,t.normalScale&&(e.normalScale=t.normalScale),e.displacementMap=null,e.displacementScale=1,e.displacementBias=0,e.specularMap=void 0===t.specularMap?null:t.specularMap,e.specular=t.specular,e.glossinessMap=void 0===t.glossinessMap?null:t.glossinessMap,e.glossiness=t.glossiness,e.alphaMap=null,e.envMap=void 0===t.envMap?null:t.envMap,e.envMapIntensity=1,e.refractionRatio=.98,e}}}function b(){this.name=i.KHR_MESH_QUANTIZATION}function S(t,e,i,s){xl.call(this,t,e,i,s)}y.prototype.decodePrimitive=function(t,e){var i=this.json,s=this.dracoLoader,n=t.extensions[this.name].bufferView,o=t.extensions[this.name].attributes,r={},a={},h={};for(var l in o){var c=L[l]||l.toLowerCase();r[c]=o[l]}for(l in t.attributes)if(c=L[l]||l.toLowerCase(),void 0!==o[l]){var d=i.accessors[t.attributes[l]],u=M[d.componentType];h[c]=u,a[c]=!0===d.normalized}return e.getDependency("bufferView",n).then((function(t){return new Promise((function(e){s.decodeDracoFile(t,(function(t){for(var i in t.attributes){var s=t.attributes[i],n=a[i];void 0!==n&&(s.normalized=n)}e(t)}),r,h)}))}))},v.prototype.extendTexture=function(t,e){return t=t.clone(),void 0!==e.offset&&t.offset.fromArray(e.offset),void 0!==e.rotation&&(t.rotation=e.rotation),void 0!==e.scale&&t.repeat.fromArray(e.scale),void 0!==e.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),t.needsUpdate=!0,t},w.prototype=Object.create(cl.prototype),w.prototype.constructor=w,w.prototype.copy=function(t){return cl.prototype.copy.call(this,t),this.specularMap=t.specularMap,this.specular.copy(t.specular),this.glossinessMap=t.glossinessMap,this.glossiness=t.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},S.prototype=Object.create(xl.prototype),S.prototype.constructor=S,S.prototype.copySampleValue_=function(t){for(var e=this.resultBuffer,i=this.sampleValues,s=this.valueSize,n=t*s*3+s,o=0;o!==s;o++)e[o]=i[n+o];return e},S.prototype.beforeStart_=S.prototype.copySampleValue_,S.prototype.afterEnd_=S.prototype.copySampleValue_,S.prototype.interpolate_=function(t,e,i,s){for(var n=this.resultBuffer,o=this.sampleValues,r=this.valueSize,a=2*r,h=3*r,l=s-e,c=(i-e)/l,d=c*c,u=d*c,p=t*h,m=p-h,f=-2*u+3*d,g=u-d,y=1-f,v=g-d+c,w=0;w!==r;w++){var x=o[m+w+r],b=o[m+w+a]*l,S=o[p+w+r],M=o[p+w]*l;n[w]=y*x+v*b+f*S+g*M}return n};var M={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},T={9728:at,9729:ct,9984:ht,9985:dt,9986:lt,9987:ut},_={33071:ot,33648:rt,10497:nt},E={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},L={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},C={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},A={CUBICSPLINE:void 0,LINEAR:Le,STEP:Ee};function P(t,e){return"string"!=typeof t||""===t?"":(/^https?:\/\//i.test(e)&&/^\//.test(t)&&(e=e.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(t)||/^data:.*,.*$/i.test(t)||/^blob:.*$/i.test(t)?t:e+t)}function k(t,e,i){for(var s in i.extensions)void 0===t[s]&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[s]=i.extensions[s])}function B(t,e){void 0!==e.extras&&("object"==typeof e.extras?Object.assign(t.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function R(t,e){if(t.updateMorphTargets(),void 0!==e.weights)for(var i=0,s=e.weights.length;i<s;i++)t.morphTargetInfluences[i]=e.weights[i];if(e.extras&&Array.isArray(e.extras.targetNames)){var n=e.extras.targetNames;if(t.morphTargetInfluences.length===n.length)for(t.morphTargetDictionary={},i=0,s=n.length;i<s;i++)t.morphTargetDictionary[n[i]]=i;else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function D(t){for(var e="",i=Object.keys(t).sort(),s=0,n=i.length;s<n;s++)e+=i[s]+":"+t[i[s]]+";";return e}function I(t,i){this.json=t||{},this.extensions={},this.plugins={},this.options=i||{},this.cache=new e,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new Dc(this.options.manager):this.textureLoader=new jl(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new Nl(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function F(t,e,i){var s=e.attributes,n=[];function o(e,s){return i.getDependency("accessor",e).then((function(e){t.setAttribute(s,e)}))}for(var r in s){var a=L[r]||r.toLowerCase();a in t.attributes||n.push(o(s[r],a))}if(void 0!==e.indices&&!t.index){var h=i.getDependency("accessor",e.indices).then((function(e){t.setIndex(e)}));n.push(h)}return B(t,e),function(t,e,i){var s=e.attributes,n=new gi;if(void 0!==s.POSITION){var o=(u=i.json.accessors[s.POSITION]).min,r=u.max;if(void 0!==o&&void 0!==r){n.set(new pi(o[0],o[1],o[2]),new pi(r[0],r[1],r[2]));var a=e.targets;if(void 0!==a){for(var h=new pi,l=new pi,c=0,d=a.length;c<d;c++){var u,p=a[c];void 0!==p.POSITION&&(o=(u=i.json.accessors[p.POSITION]).min,r=u.max,void 0!==o&&void 0!==r?(l.setX(Math.max(Math.abs(o[0]),Math.abs(r[0]))),l.setY(Math.max(Math.abs(o[1]),Math.abs(r[1]))),l.setZ(Math.max(Math.abs(o[2]),Math.abs(r[2]))),h.max(l)):console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION."))}n.expandByVector(h)}t.boundingBox=n;var m=new Bi;n.getCenter(m.center),m.radius=n.min.distanceTo(n.max)/2,t.boundingSphere=m}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}(t,e,i),Promise.all(n).then((function(){return void 0!==e.targets?function(t,e,i){for(var s=!1,n=!1,o=0,r=e.length;o<r&&(void 0!==(l=e[o]).POSITION&&(s=!0),void 0!==l.NORMAL&&(n=!0),!s||!n);o++);if(!s&&!n)return Promise.resolve(t);var a=[],h=[];for(o=0,r=e.length;o<r;o++){var l=e[o];if(s){var c=void 0!==l.POSITION?i.getDependency("accessor",l.POSITION):t.attributes.position;a.push(c)}n&&(c=void 0!==l.NORMAL?i.getDependency("accessor",l.NORMAL):t.attributes.normal,h.push(c))}return Promise.all([Promise.all(a),Promise.all(h)]).then((function(e){var i=e[0],o=e[1];return s&&(t.morphAttributes.position=i),n&&(t.morphAttributes.normal=o),t.morphTargetsRelative=!0,t}))}(t,e.targets,i):t}))}function z(t,e){var i=t.getIndex();if(null===i){var s=[],n=t.getAttribute("position");if(void 0===n)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),t;for(var o=0;o<n.count;o++)s.push(o);t.setIndex(s),i=t.getIndex()}var r=i.count-2,a=[];if(e===De)for(o=1;o<=r;o++)a.push(i.getX(0)),a.push(i.getX(o)),a.push(i.getX(o+1));else for(o=0;o<r;o++)o%2==0?(a.push(i.getX(o)),a.push(i.getX(o+1)),a.push(i.getX(o+2))):(a.push(i.getX(o+2)),a.push(i.getX(o+1)),a.push(i.getX(o)));a.length/3!==r&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var h=t.clone();return h.setIndex(a),h}return I.prototype.setExtensions=function(t){this.extensions=t},I.prototype.setPlugins=function(t){this.plugins=t},I.prototype.parse=function(t,e){var i=this,s=this.json,n=this.extensions;this.cache.removeAll(),this._invokeAll((function(t){return t._markDefs&&t._markDefs()})),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then((function(e){var o={scene:e[0][s.scene||0],scenes:e[0],animations:e[1],cameras:e[2],asset:s.asset,parser:i,userData:{}};k(n,o,s),B(o,s),t(o)})).catch(e)},I.prototype._markDefs=function(){for(var t=this.json.nodes||[],e=this.json.skins||[],i=this.json.meshes||[],s=0,n=e.length;s<n;s++)for(var o=e[s].joints,r=0,a=o.length;r<a;r++)t[o[r]].isBone=!0;for(var h=0,l=t.length;h<l;h++){var c=t[h];void 0!==c.mesh&&(this._addNodeRef(this.meshCache,c.mesh),void 0!==c.skin&&(i[c.mesh].isSkinnedMesh=!0)),void 0!==c.camera&&this._addNodeRef(this.cameraCache,c.camera)}},I.prototype._addNodeRef=function(t,e){void 0!==e&&(void 0===t.refs[e]&&(t.refs[e]=t.uses[e]=0),t.refs[e]++)},I.prototype._getNodeRef=function(t,e,i){if(t.refs[e]<=1)return i;var s=i.clone();return s.name+="_instance_"+t.uses[e]++,s},I.prototype._invokeOne=function(t){var e=Object.values(this.plugins);e.push(this);for(var i=0;i<e.length;i++){var s=t(e[i]);if(s)return s}},I.prototype._invokeAll=function(t){var e=Object.values(this.plugins);e.unshift(this);for(var i=[],s=0;s<e.length;s++){var n=t(e[s]);n&&i.push(n)}return i},I.prototype.getDependency=function(t,e){var i=t+":"+e,s=this.cache.get(i);if(!s){switch(t){case"scene":s=this.loadScene(e);break;case"node":s=this.loadNode(e);break;case"mesh":s=this._invokeOne((function(t){return t.loadMesh&&t.loadMesh(e)}));break;case"accessor":s=this.loadAccessor(e);break;case"bufferView":s=this._invokeOne((function(t){return t.loadBufferView&&t.loadBufferView(e)}));break;case"buffer":s=this.loadBuffer(e);break;case"material":s=this._invokeOne((function(t){return t.loadMaterial&&t.loadMaterial(e)}));break;case"texture":s=this._invokeOne((function(t){return t.loadTexture&&t.loadTexture(e)}));break;case"skin":s=this.loadSkin(e);break;case"animation":s=this.loadAnimation(e);break;case"camera":s=this.loadCamera(e);break;default:throw new Error("Unknown type: "+t)}this.cache.add(i,s)}return s},I.prototype.getDependencies=function(t){var e=this.cache.get(t);if(!e){var i=this,s=this.json[t+("mesh"===t?"es":"s")]||[];e=Promise.all(s.map((function(e,s){return i.getDependency(t,s)}))),this.cache.add(t,e)}return e},I.prototype.loadBuffer=function(t){var e=this.json.buffers[t],s=this.fileLoader;if(e.type&&"arraybuffer"!==e.type)throw new Error("THREE.GLTFLoader: "+e.type+" buffer type is not supported.");if(void 0===e.uri&&0===t)return Promise.resolve(this.extensions[i.KHR_BINARY_GLTF].body);var n=this.options;return new Promise((function(t,i){s.load(P(e.uri,n.path),t,void 0,(function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+e.uri+'".'))}))}))},I.prototype.loadBufferView=function(t){var e=this.json.bufferViews[t];return this.getDependency("buffer",e.buffer).then((function(t){var i=e.byteLength||0,s=e.byteOffset||0;return t.slice(s,s+i)}))},I.prototype.loadAccessor=function(t){var e=this,i=this.json,s=this.json.accessors[t];if(void 0===s.bufferView&&void 0===s.sparse)return Promise.resolve(null);var n=[];return void 0!==s.bufferView?n.push(this.getDependency("bufferView",s.bufferView)):n.push(null),void 0!==s.sparse&&(n.push(this.getDependency("bufferView",s.sparse.indices.bufferView)),n.push(this.getDependency("bufferView",s.sparse.values.bufferView))),Promise.all(n).then((function(t){var n,o=t[0],r=E[s.type],a=M[s.componentType],h=a.BYTES_PER_ELEMENT,l=h*r,c=s.byteOffset||0,d=void 0!==s.bufferView?i.bufferViews[s.bufferView].byteStride:void 0,u=!0===s.normalized;if(d&&d!==l){var p=Math.floor(c/d),m="InterleavedBuffer:"+s.bufferView+":"+s.componentType+":"+p+":"+s.count,f=e.cache.get(m);f||(f=new ra(new a(o,p*d,s.count*d/h),d/h),e.cache.add(m,f)),n=new ha(f,r,c%d/h,u)}else n=new Hs(null===o?new a(s.count*r):new a(o,c,s.count*r),r,u);if(void 0!==s.sparse){var g=E.SCALAR,y=M[s.sparse.indices.componentType],v=s.sparse.indices.byteOffset||0,w=s.sparse.values.byteOffset||0,x=new y(t[1],v,s.sparse.count*g),b=new a(t[2],w,s.sparse.count*r);null!==o&&(n=new Hs(n.array.slice(),n.itemSize,n.normalized));for(var S=0,T=x.length;S<T;S++){var _=x[S];if(n.setX(_,b[S*r]),r>=2&&n.setY(_,b[S*r+1]),r>=3&&n.setZ(_,b[S*r+2]),r>=4&&n.setW(_,b[S*r+3]),r>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return n}))},I.prototype.loadTexture=function(t){var e,s,n=this.json,o=this.options,r=n.textures[t],a=r.extensions||{};return(e=a[i.MSFT_TEXTURE_DDS]?n.images[a[i.MSFT_TEXTURE_DDS].source]:n.images[r.source]).uri&&(s=o.manager.getHandler(e.uri)),s||(s=a[i.MSFT_TEXTURE_DDS]?this.extensions[i.MSFT_TEXTURE_DDS].ddsLoader:this.textureLoader),this.loadTextureImage(t,e,s)},I.prototype.loadTextureImage=function(t,e,i){var s=this,n=this.json,o=this.options,r=n.textures[t],a=self.URL||self.webkitURL,h=e.uri,l=!1,c=!0;return"image/jpeg"===e.mimeType&&(c=!1),void 0!==e.bufferView&&(h=s.getDependency("bufferView",e.bufferView).then((function(t){if("image/png"===e.mimeType){var i=new DataView(t,25,1).getUint8(0,!1);c=6===i||4===i||3===i}l=!0;var s=new Blob([t],{type:e.mimeType});return h=a.createObjectURL(s)}))),Promise.resolve(h).then((function(t){return new Promise((function(e,s){var n=e;!0===i.isImageBitmapLoader&&(n=function(t){e(new lh(t))}),i.load(P(t,o.path),n,void 0,s)}))})).then((function(e){!0===l&&a.revokeObjectURL(h),e.flipY=!1,r.name&&(e.name=r.name),c||(e.format=Et);var i=(n.samplers||{})[r.sampler]||{};return e.magFilter=T[i.magFilter]||ct,e.minFilter=T[i.minFilter]||ut,e.wrapS=_[i.wrapS]||nt,e.wrapT=_[i.wrapT]||nt,s.associations.set(e,{type:"textures",index:t}),e}))},I.prototype.assignTexture=function(t,e,s){var n=this;return this.getDependency("texture",s.index).then((function(o){if(void 0===s.texCoord||0==s.texCoord||"aoMap"===e&&1==s.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+s.texCoord+" for texture "+e+" not yet supported."),n.extensions[i.KHR_TEXTURE_TRANSFORM]){var r=void 0!==s.extensions?s.extensions[i.KHR_TEXTURE_TRANSFORM]:void 0;if(r){var a=n.associations.get(o);o=n.extensions[i.KHR_TEXTURE_TRANSFORM].extendTexture(o,r),n.associations.set(o,a)}}t[e]=o}))},I.prototype.assignFinalMaterial=function(t){var e=t.geometry,i=t.material,s=void 0!==e.attributes.tangent,n=void 0!==e.attributes.color,o=void 0===e.attributes.normal,r=!0===t.isSkinnedMesh,a=Object.keys(e.morphAttributes).length>0,h=a&&void 0!==e.morphAttributes.normal;if(t.isPoints){var l="PointsMaterial:"+i.uuid,c=this.cache.get(l);c||(c=new th,zs.prototype.copy.call(c,i),c.color.copy(i.color),c.map=i.map,c.sizeAttenuation=!1,this.cache.add(l,c)),i=c}else if(t.isLine){l="LineBasicMaterial:"+i.uuid;var d=this.cache.get(l);d||(d=new Va,zs.prototype.copy.call(d,i),d.color.copy(i.color),this.cache.add(l,d)),i=d}if(s||n||o||r||a){l="ClonedMaterial:"+i.uuid+":",i.isGLTFSpecularGlossinessMaterial&&(l+="specular-glossiness:"),r&&(l+="skinning:"),s&&(l+="vertex-tangents:"),n&&(l+="vertex-colors:"),o&&(l+="flat-shading:"),a&&(l+="morph-targets:"),h&&(l+="morph-normals:");var u=this.cache.get(l);u||(u=i.clone(),r&&(u.skinning=!0),s&&(u.vertexTangents=!0),n&&(u.vertexColors=!0),o&&(u.flatShading=!0),a&&(u.morphTargets=!0),h&&(u.morphNormals=!0),this.cache.add(l,u),this.associations.set(u,this.associations.get(i))),i=u}i.aoMap&&void 0===e.attributes.uv2&&void 0!==e.attributes.uv&&e.setAttribute("uv2",e.attributes.uv),i.normalScale&&!s&&(i.normalScale.y=-i.normalScale.y),i.clearcoatNormalScale&&!s&&(i.clearcoatNormalScale.y=-i.clearcoatNormalScale.y),t.material=i},I.prototype.getMaterialType=function(){return cl},I.prototype.loadMaterial=function(t){var e,s=this,n=this.json,o=this.extensions,r=n.materials[t],a={},h=r.extensions||{},l=[];if(h[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var c=o[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];e=c.getMaterialType(),l.push(c.extendParams(a,r,s))}else if(h[i.KHR_MATERIALS_UNLIT]){var d=o[i.KHR_MATERIALS_UNLIT];e=d.getMaterialType(),l.push(d.extendParams(a,r,s))}else{var p=r.pbrMetallicRoughness||{};if(a.color=new Ds(1,1,1),a.opacity=1,Array.isArray(p.baseColorFactor)){var m=p.baseColorFactor;a.color.fromArray(m),a.opacity=m[3]}void 0!==p.baseColorTexture&&l.push(s.assignTexture(a,"map",p.baseColorTexture)),a.metalness=void 0!==p.metallicFactor?p.metallicFactor:1,a.roughness=void 0!==p.roughnessFactor?p.roughnessFactor:1,void 0!==p.metallicRoughnessTexture&&(l.push(s.assignTexture(a,"metalnessMap",p.metallicRoughnessTexture)),l.push(s.assignTexture(a,"roughnessMap",p.metallicRoughnessTexture))),e=this._invokeOne((function(e){return e.getMaterialType&&e.getMaterialType(t)})),l.push(Promise.all(this._invokeAll((function(e){return e.extendMaterialParams&&e.extendMaterialParams(t,a)}))))}!0===r.doubleSided&&(a.side=u);var f=r.alphaMode||"OPAQUE";return"BLEND"===f?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,"MASK"===f&&(a.alphaTest=void 0!==r.alphaCutoff?r.alphaCutoff:.5)),void 0!==r.normalTexture&&e!==Os&&(l.push(s.assignTexture(a,"normalMap",r.normalTexture)),a.normalScale=new ii(1,1),void 0!==r.normalTexture.scale&&a.normalScale.set(r.normalTexture.scale,r.normalTexture.scale)),void 0!==r.occlusionTexture&&e!==Os&&(l.push(s.assignTexture(a,"aoMap",r.occlusionTexture)),void 0!==r.occlusionTexture.strength&&(a.aoMapIntensity=r.occlusionTexture.strength)),void 0!==r.emissiveFactor&&e!==Os&&(a.emissive=(new Ds).fromArray(r.emissiveFactor)),void 0!==r.emissiveTexture&&e!==Os&&l.push(s.assignTexture(a,"emissiveMap",r.emissiveTexture)),Promise.all(l).then((function(){var n;return n=e===w?o[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(a):new e(a),r.name&&(n.name=r.name),n.map&&(n.map.encoding=Fe),n.emissiveMap&&(n.emissiveMap.encoding=Fe),B(n,r),s.associations.set(n,{type:"materials",index:t}),r.extensions&&k(o,n,r),n}))},I.prototype.createUniqueName=function(t){for(var e=ud.sanitizeNodeName(t||""),i=e,s=1;this.nodeNamesUsed[i];++s)i=e+"_"+s;return this.nodeNamesUsed[i]=!0,i},I.prototype.loadGeometries=function(t){var e=this,s=this.extensions,n=this.primitiveCache;function o(t){return s[i.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(t,e).then((function(i){return F(i,t,e)}))}for(var r,a,h=[],l=0,c=t.length;l<c;l++){var d,u=t[l],p=(void 0,(a=(r=u).extensions&&r.extensions[i.KHR_DRACO_MESH_COMPRESSION])?"draco:"+a.bufferView+":"+a.indices+":"+D(a.attributes):r.indices+":"+D(r.attributes)+":"+r.mode),m=n[p];m?h.push(m.promise):(d=u.extensions&&u.extensions[i.KHR_DRACO_MESH_COMPRESSION]?o(u):F(new cn,u,e),n[p]={primitive:u,promise:d},h.push(d))}return Promise.all(h)},I.prototype.loadMesh=function(t){for(var e,i=this,s=this.json,n=this.extensions,o=s.meshes[t],r=o.primitives,a=[],h=0,l=r.length;h<l;h++){var d=void 0===r[h].material?(void 0===(e=this.cache).DefaultMaterial&&(e.DefaultMaterial=new cl({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:c})),e.DefaultMaterial):this.getDependency("material",r[h].material);a.push(d)}return a.push(i.loadGeometries(r)),Promise.all(a).then((function(e){for(var s=e.slice(0,e.length-1),a=e[e.length-1],h=[],l=0,c=a.length;l<c;l++){var d,u=a[l],p=r[l],m=s[l];if(4===p.mode||5===p.mode||6===p.mode||void 0===p.mode)!0!==(d=!0===o.isSkinnedMesh?new Ra(u,m):new Cn(u,m)).isSkinnedMesh||d.geometry.attributes.skinWeight.normalized||d.normalizeSkinWeights(),5===p.mode?d.geometry=z(d.geometry,Re):6===p.mode&&(d.geometry=z(d.geometry,De));else if(1===p.mode)d=new Ja(u,m);else if(3===p.mode)d=new Ya(u,m);else if(2===p.mode)d=new Qa(u,m);else{if(0!==p.mode)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+p.mode);d=new oh(u,m)}Object.keys(d.geometry.morphAttributes).length>0&&R(d,o),d.name=i.createUniqueName(o.name||"mesh_"+t),B(d,o),p.extensions&&k(n,d,p),i.assignFinalMaterial(d),h.push(d)}if(1===h.length)return h[0];var f=new Qr;for(l=0,c=h.length;l<c;l++)f.add(h[l]);return f}))},I.prototype.loadCamera=function(t){var e,i=this.json.cameras[t],s=i[i.type];if(s)return"perspective"===i.type?e=new Nn(ei.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):"orthographic"===i.type&&(e=new Sc(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),i.name&&(e.name=this.createUniqueName(i.name)),B(e,i),Promise.resolve(e);console.warn("THREE.GLTFLoader: Missing camera parameters.")},I.prototype.loadSkin=function(t){var e=this.json.skins[t],i={joints:e.joints};return void 0===e.inverseBindMatrices?Promise.resolve(i):this.getDependency("accessor",e.inverseBindMatrices).then((function(t){return i.inverseBindMatrices=t,i}))},I.prototype.loadAnimation=function(t){for(var e=this.json.animations[t],i=[],s=[],n=[],o=[],r=[],a=0,h=e.channels.length;a<h;a++){var l=e.channels[a],c=e.samplers[l.sampler],d=l.target,u=void 0!==d.node?d.node:d.id,p=void 0!==e.parameters?e.parameters[c.input]:c.input,m=void 0!==e.parameters?e.parameters[c.output]:c.output;i.push(this.getDependency("node",u)),s.push(this.getDependency("accessor",p)),n.push(this.getDependency("accessor",m)),o.push(c),r.push(d)}return Promise.all([Promise.all(i),Promise.all(s),Promise.all(n),Promise.all(o),Promise.all(r)]).then((function(i){for(var s=i[0],n=i[1],o=i[2],r=i[3],a=i[4],h=[],l=0,c=s.length;l<c;l++){var d=s[l],u=n[l],p=o[l],m=r[l],f=a[l];if(void 0!==d){var g;switch(d.updateMatrix(),d.matrixAutoUpdate=!0,C[f.path]){case C.weights:g=Ll;break;case C.rotation:g=Al;break;default:g=kl}var y=d.name?d.name:d.uuid,v=void 0!==m.interpolation?A[m.interpolation]:Le,w=[];C[f.path]===C.weights?d.traverse((function(t){!0===t.isMesh&&t.morphTargetInfluences&&w.push(t.name?t.name:t.uuid)})):w.push(y);var x=p.array;if(p.normalized){var b;if(x.constructor===Int8Array)b=1/127;else if(x.constructor===Uint8Array)b=1/255;else if(x.constructor==Int16Array)b=1/32767;else{if(x.constructor!==Uint16Array)throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.");b=1/65535}for(var M=new Float32Array(x.length),T=0,_=x.length;T<_;T++)M[T]=x[T]*b;x=M}for(T=0,_=w.length;T<_;T++){var E=new g(w[T]+"."+C[f.path],u.array,x,v);"CUBICSPLINE"===m.interpolation&&(E.createInterpolant=function(t){return new S(this.times,this.values,this.getValueSize()/3,t)},E.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),h.push(E)}}}return new Bl(e.name?e.name:"animation_"+t,void 0,h)}))},I.prototype.loadNode=function(t){var e,i=this.json,s=this.extensions,n=this,o=i.nodes[t],r=o.name?n.createUniqueName(o.name):"";return(e=[],void 0!==o.mesh&&e.push(n.getDependency("mesh",o.mesh).then((function(t){var e=n._getNodeRef(n.meshCache,o.mesh,t);return void 0!==o.weights&&e.traverse((function(t){if(t.isMesh)for(var e=0,i=o.weights.length;e<i;e++)t.morphTargetInfluences[e]=o.weights[e]})),e}))),void 0!==o.camera&&e.push(n.getDependency("camera",o.camera).then((function(t){return n._getNodeRef(n.cameraCache,o.camera,t)}))),n._invokeAll((function(e){return e.createNodeAttachment&&e.createNodeAttachment(t)})).forEach((function(t){e.push(t)})),Promise.all(e)).then((function(e){var i;if((i=!0===o.isBone?new Da:e.length>1?new Qr:1===e.length?e[0]:new us)!==e[0])for(var a=0,h=e.length;a<h;a++)i.add(e[a]);if(o.name&&(i.userData.name=o.name,i.name=r),B(i,o),o.extensions&&k(s,i,o),void 0!==o.matrix){var l=new Hi;l.fromArray(o.matrix),i.applyMatrix4(l)}else void 0!==o.translation&&i.position.fromArray(o.translation),void 0!==o.rotation&&i.quaternion.fromArray(o.rotation),void 0!==o.scale&&i.scale.fromArray(o.scale);return n.associations.set(i,{type:"nodes",index:t}),i}))},I.prototype.loadScene=function(){function t(e,i,s,n){var o=s.nodes[e];return n.getDependency("node",e).then((function(t){return void 0===o.skin?t:n.getDependency("skin",o.skin).then((function(t){for(var i=[],s=0,o=(e=t).joints.length;s<o;s++)i.push(n.getDependency("node",e.joints[s]));return Promise.all(i)})).then((function(i){return t.traverse((function(t){if(t.isMesh){for(var s=[],n=[],o=0,r=i.length;o<r;o++){var a=i[o];if(a){s.push(a);var h=new Hi;void 0!==e.inverseBindMatrices&&h.fromArray(e.inverseBindMatrices.array,16*o),n.push(h)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',e.joints[o])}t.bind(new za(s,n),t.matrixWorld)}})),t}));var e})).then((function(e){i.add(e);var r=[];if(o.children)for(var a=o.children,h=0,l=a.length;h<l;h++){var c=a[h];r.push(t(c,e,s,n))}return Promise.all(r)}))}return function(e){var i=this.json,s=this.extensions,n=this.json.scenes[e],o=new Qr;n.name&&(o.name=this.createUniqueName(n.name)),B(o,n),n.extensions&&k(s,o,n);for(var r=n.nodes||[],a=[],h=0,l=r.length;h<l;h++)a.push(t(r[h],o,i,this));return Promise.all(a).then((function(){return o}))}}(),t}(),Kg=function(t){zl.call(this,t),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}};Kg.prototype=Object.assign(Object.create(zl.prototype),{constructor:Kg,setDecoderPath:function(t){return this.decoderPath=t,this},setDecoderConfig:function(t){return this.decoderConfig=t,this},setWorkerLimit:function(t){return this.workerLimit=t,this},setVerbosity:function(){console.warn("THREE.DRACOLoader: The .setVerbosity() method has been removed.")},setDrawMode:function(){console.warn("THREE.DRACOLoader: The .setDrawMode() method has been removed.")},setSkipDequantization:function(){console.warn("THREE.DRACOLoader: The .setSkipDequantization() method has been removed.")},load:function(t,e,i,s){var n=new Nl(this.manager);n.setPath(this.path),n.setResponseType("arraybuffer"),n.setRequestHeader(this.requestHeader),n.setWithCredentials(this.withCredentials),n.load(t,(t=>{var i={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(t,i).then(e).catch(s)}),i,s)},decodeDracoFile:function(t,e,i,s){var n={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:s||this.defaultAttributeTypes,useUniqueIDs:!!i};this.decodeGeometry(t,n).then(e)},decodeGeometry:function(t,e){for(var i in e.attributeTypes){var s=e.attributeTypes[i];void 0!==s.BYTES_PER_ELEMENT&&(e.attributeTypes[i]=s.name)}var n,o=JSON.stringify(e);if(Kg.taskCache.has(t)){var r=Kg.taskCache.get(t);if(r.key===o)return r.promise;if(0===t.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var a=this.workerNextTaskID++,h=t.byteLength,l=this._getWorker(a,h).then((i=>(n=i,new Promise(((i,s)=>{n._callbacks[a]={resolve:i,reject:s},n.postMessage({type:"decode",id:a,taskConfig:e,buffer:t},[t])}))))).then((t=>this._createGeometry(t.geometry)));return l.catch((()=>!0)).then((()=>{n&&a&&this._releaseTask(n,a)})),Kg.taskCache.set(t,{key:o,promise:l}),l},_createGeometry:function(t){var e=new cn;t.index&&e.setIndex(new Hs(t.index.array,1));for(var i=0;i<t.attributes.length;i++){var s=t.attributes[i],n=s.name,o=s.array,r=s.itemSize;e.setAttribute(n,new Hs(o,r))}return e},_loadLibrary:function(t,e){var i=new Nl(this.manager);return i.setPath(this.decoderPath),i.setResponseType(e),i.setWithCredentials(this.withCredentials),new Promise(((e,s)=>{i.load(t,e,void 0,s)}))},preload:function(){return this._initDecoder(),this},_initDecoder:function(){if(this.decoderPending)return this.decoderPending;var t="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,e=[];return t?e.push(this._loadLibrary("draco_decoder.js","text")):(e.push(this._loadLibrary("draco_wasm_wrapper.js","text")),e.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(e).then((e=>{var i=e[0];t||(this.decoderConfig.wasmBinary=e[1]);var s=Kg.DRACOWorker.toString(),n=["/* draco decoder */",i,"","/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([n]))})),this.decoderPending},_getWorker:function(t,e){return this._initDecoder().then((()=>{var i;return this.workerPool.length<this.workerLimit?((i=new Worker(this.workerSourceURL))._callbacks={},i._taskCosts={},i._taskLoad=0,i.postMessage({type:"init",decoderConfig:this.decoderConfig}),i.onmessage=function(t){var e=t.data;switch(e.type){case"decode":i._callbacks[e.id].resolve(e);break;case"error":i._callbacks[e.id].reject(e);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+e.type+'"')}},this.workerPool.push(i)):this.workerPool.sort((function(t,e){return t._taskLoad>e._taskLoad?-1:1})),(i=this.workerPool[this.workerPool.length-1])._taskCosts[t]=e,i._taskLoad+=e,i}))},_releaseTask:function(t,e){t._taskLoad-=t._taskCosts[e],delete t._callbacks[e],delete t._taskCosts[e]},debug:function(){console.log("Task load: ",this.workerPool.map((t=>t._taskLoad)))},dispose:function(){for(var t=0;t<this.workerPool.length;++t)this.workerPool[t].terminate();return this.workerPool.length=0,this}}),Kg.DRACOWorker=function(){var t,e;function i(t,e,i,s,n,o){var r=o.num_components(),a=i.num_points()*r,h=a*n.BYTES_PER_ELEMENT,l=function(t,e){switch(e){case Float32Array:return t.DT_FLOAT32;case Int8Array:return t.DT_INT8;case Int16Array:return t.DT_INT16;case Int32Array:return t.DT_INT32;case Uint8Array:return t.DT_UINT8;case Uint16Array:return t.DT_UINT16;case Uint32Array:return t.DT_UINT32}}(t,n),c=t._malloc(h);e.GetAttributeDataArrayForAllPoints(i,o,l,h,c);var d=new n(t.HEAPF32.buffer,c,a).slice();return t._free(c),{name:s,array:d,itemSize:r}}onmessage=function(s){var n=s.data;switch(n.type){case"init":t=n.decoderConfig,e=new Promise((function(e){t.onModuleLoaded=function(t){e({draco:t})},DracoDecoderModule(t)}));break;case"decode":var o=n.buffer,r=n.taskConfig;e.then((t=>{var e=t.draco,s=new e.Decoder,a=new e.DecoderBuffer;a.Init(new Int8Array(o),o.byteLength);try{var h=function(t,e,s,n){var o,r,a=n.attributeIDs,h=n.attributeTypes,l=e.GetEncodedGeometryType(s);if(l===t.TRIANGULAR_MESH)o=new t.Mesh,r=e.DecodeBufferToMesh(s,o);else{if(l!==t.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");o=new t.PointCloud,r=e.DecodeBufferToPointCloud(s,o)}if(!r.ok()||0===o.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+r.error_msg());var c={index:null,attributes:[]};for(var d in a){var u,p,m=self[h[d]];if(n.useUniqueIDs)p=a[d],u=e.GetAttributeByUniqueId(o,p);else{if(-1===(p=e.GetAttributeId(o,t[a[d]])))continue;u=e.GetAttribute(o,p)}c.attributes.push(i(t,e,o,d,m,u))}return l===t.TRIANGULAR_MESH&&(c.index=function(t,e,i){var s=3*i.num_faces(),n=4*s,o=t._malloc(n);e.GetTrianglesUInt32Array(i,n,o);var r=new Uint32Array(t.HEAPF32.buffer,o,s).slice();return t._free(o),{array:r,itemSize:1}}(t,e,o)),t.destroy(o),c}(e,s,a,r),l=h.attributes.map((t=>t.array.buffer));h.index&&l.push(h.index.array.buffer),self.postMessage({type:"decode",id:n.id,geometry:h},l)}catch(t){console.error(t),self.postMessage({type:"error",id:n.id,error:t.message})}finally{e.destroy(a),e.destroy(s)}}))}}},Kg.taskCache=new WeakMap,Kg.setDecoderPath=function(){console.warn("THREE.DRACOLoader: The .setDecoderPath() method has been removed. Use instance methods.")},Kg.setDecoderConfig=function(){console.warn("THREE.DRACOLoader: The .setDecoderConfig() method has been removed. Use instance methods.")},Kg.releaseDecoderModule=function(){console.warn("THREE.DRACOLoader: The .releaseDecoderModule() method has been removed. Use instance methods.")},Kg.getDecoderModule=function(){console.warn("THREE.DRACOLoader: The .getDecoderModule() method has been removed. Use instance methods.")};const Jg=[];for(let t=0;t<256;t++)Jg[t]=(t<16?"0":"")+t.toString(16);let Qg=1234567;const ty={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0;return(Jg[255&t]+Jg[t>>8&255]+Jg[t>>16&255]+Jg[t>>24&255]+"-"+Jg[255&e]+Jg[e>>8&255]+"-"+Jg[e>>16&15|64]+Jg[e>>24&255]+"-"+Jg[63&i|128]+Jg[i>>8&255]+"-"+Jg[i>>16&255]+Jg[i>>24&255]+Jg[255&s]+Jg[s>>8&255]+Jg[s>>16&255]+Jg[s>>24&255]).toUpperCase()},clamp:function(t,e,i){return Math.max(e,Math.min(i,t))},euclideanModulo:function(t,e){return(t%e+e)%e},mapLinear:function(t,e,i,s,n){return s+(t-e)*(n-s)/(i-e)},lerp:function(t,e,i){return(1-i)*t+i*e},smoothstep:function(t,e,i){return t<=e?0:t>=i?1:(t=(t-e)/(i-e))*t*(3-2*t)},smootherstep:function(t,e,i){return t<=e?0:t>=i?1:(t=(t-e)/(i-e))*t*t*(t*(6*t-15)+10)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},seededRandom:function(t){return void 0!==t&&(Qg=t%2147483647),Qg=16807*Qg%2147483647,(Qg-1)/2147483646},degToRad:function(t){return t*ty.DEG2RAD},radToDeg:function(t){return t*ty.RAD2DEG},isPowerOfTwo:function(t){return 0==(t&t-1)&&0!==t},ceilPowerOfTwo:function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))},floorPowerOfTwo:function(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))},setQuaternionFromProperEuler:function(t,e,i,s,n){const o=Math.cos,r=Math.sin,a=o(i/2),h=r(i/2),l=o((e+s)/2),c=r((e+s)/2),d=o((e-s)/2),u=r((e-s)/2),p=o((s-e)/2),m=r((s-e)/2);switch(n){case"XYX":t.set(a*c,h*d,h*u,a*l);break;case"YZY":t.set(h*u,a*c,h*d,a*l);break;case"ZXZ":t.set(h*d,h*u,a*c,a*l);break;case"XZX":t.set(a*c,h*m,h*p,a*l);break;case"YXY":t.set(h*p,a*c,h*m,a*l);break;case"ZYZ":t.set(h*m,h*p,a*c,a*l);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+n)}}},ey={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},iy={h:0,s:0,l:0},sy={h:0,s:0,l:0};function ny(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+6*(e-t)*(2/3-i):t}function oy(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function ry(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}class ay{constructor(t,e,i){return Object.defineProperty(this,"isColor",{value:!0}),void 0===e&&void 0===i?this.set(t):this.setRGB(t,e,i)}set(t){return t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t),this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,this}setRGB(t,e,i){return this.r=t,this.g=e,this.b=i,this}setHSL(t,e,i){if(t=ty.euclideanModulo(t,1),e=ty.clamp(e,0,1),i=ty.clamp(i,0,1),0===e)this.r=this.g=this.b=i;else{const s=i<=.5?i*(1+e):i+e-i*e,n=2*i-s;this.r=ny(n,s,t+1/3),this.g=ny(n,s,t),this.b=ny(n,s,t-1/3)}return this}setStyle(t){function e(e){void 0!==e&&parseFloat(e)<1&&console.warn("THREE.Color: Alpha component of "+t+" will be ignored.")}let i;if(i=/^((?:rgb|hsl)a?)\(\s*([^\)]*)\)/.exec(t)){let t;const s=i[1],n=i[2];switch(s){case"rgb":case"rgba":if(t=/^(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return this.r=Math.min(255,parseInt(t[1],10))/255,this.g=Math.min(255,parseInt(t[2],10))/255,this.b=Math.min(255,parseInt(t[3],10))/255,e(t[4]),this;if(t=/^(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return this.r=Math.min(100,parseInt(t[1],10))/100,this.g=Math.min(100,parseInt(t[2],10))/100,this.b=Math.min(100,parseInt(t[3],10))/100,e(t[4]),this;break;case"hsl":case"hsla":if(t=/^(\d*\.?\d+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n)){const i=parseFloat(t[1])/360,s=parseInt(t[2],10)/100,n=parseInt(t[3],10)/100;return e(t[4]),this.setHSL(i,s,n)}}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(t)){const t=i[1],e=t.length;if(3===e)return this.r=parseInt(t.charAt(0)+t.charAt(0),16)/255,this.g=parseInt(t.charAt(1)+t.charAt(1),16)/255,this.b=parseInt(t.charAt(2)+t.charAt(2),16)/255,this;if(6===e)return this.r=parseInt(t.charAt(0)+t.charAt(1),16)/255,this.g=parseInt(t.charAt(2)+t.charAt(3),16)/255,this.b=parseInt(t.charAt(4)+t.charAt(5),16)/255,this}return t&&t.length>0?this.setColorName(t):this}setColorName(t){const e=ey[t];return void 0!==e?this.setHex(e):console.warn("THREE.Color: Unknown color "+t),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copyGammaToLinear(t,e=2){return this.r=Math.pow(t.r,e),this.g=Math.pow(t.g,e),this.b=Math.pow(t.b,e),this}copyLinearToGamma(t,e=2){const i=e>0?1/e:1;return this.r=Math.pow(t.r,i),this.g=Math.pow(t.g,i),this.b=Math.pow(t.b,i),this}convertGammaToLinear(t){return this.copyGammaToLinear(this,t),this}convertLinearToGamma(t){return this.copyLinearToGamma(this,t),this}copySRGBToLinear(t){return this.r=oy(t.r),this.g=oy(t.g),this.b=oy(t.b),this}copyLinearToSRGB(t){return this.r=ry(t.r),this.g=ry(t.g),this.b=ry(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0}getHexString(){return("000000"+this.getHex().toString(16)).slice(-6)}getHSL(t){void 0===t&&(console.warn("THREE.Color: .getHSL() target is now required"),t={h:0,s:0,l:0});const e=this.r,i=this.g,s=this.b,n=Math.max(e,i,s),o=Math.min(e,i,s);let r,a;const h=(o+n)/2;if(o===n)r=0,a=0;else{const t=n-o;switch(a=h<=.5?t/(n+o):t/(2-n-o),n){case e:r=(i-s)/t+(i<s?6:0);break;case i:r=(s-e)/t+2;break;case s:r=(e-i)/t+4}r/=6}return t.h=r,t.s=a,t.l=h,t}getStyle(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"}offsetHSL(t,e,i){return this.getHSL(iy),iy.h+=t,iy.s+=e,iy.l+=i,this.setHSL(iy.h,iy.s,iy.l),this}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpHSL(t,e){this.getHSL(iy),t.getHSL(sy);const i=ty.lerp(iy.h,sy.h,e),s=ty.lerp(iy.s,sy.s,e),n=ty.lerp(iy.l,sy.l,e);return this.setHSL(i,s,n),this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),!0===t.normalized&&(this.r/=255,this.g/=255,this.b/=255),this}toJSON(){return this.getHex()}}ay.NAMES=ey,ay.prototype.r=1,ay.prototype.g=1,ay.prototype.b=1;class hy{constructor(t=1,e="Loading..."){this.totalItems=t,this.loadedItems=0,this.title=e,this.isVisible=!1,this.onComplete=null,this.colors={primary:"#FFDF00",secondary:"#FFD700",tertiary:"#B8860B",quaternary:"#DAA520"},this.animationDuration="3s",this.size="60px",this.textSet=["Just a moment...","Almost there...","Finalizing details..."],this.createLoader()}getRandomText(){const t=Math.floor(Math.random()*this.textSet.length);return this.textSet[t]}createLoader(){this.loaderOverlay=document.createElement("div"),this.loaderOverlay.id="model-loader",this.loaderOverlay.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.8);\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            align-items: center;\n            z-index: 9999;\n            font-family: Arial, sans-serif;\n            color: white;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        ",this.loadingSpinner=document.createElement("div"),this.loadingSpinner.className="custom-loader-enhanced";const t=document.createElement("section");if(t.className="custom-loader-item-enhanced",this.loadingSpinner.appendChild(t),!document.getElementById("loader-styles")){const t=document.createElement("style");t.id="loader-styles",t.textContent=`\n                .custom-loader-enhanced {\n                    height: ${this.size};\n                    aspect-ratio: 1;\n                    box-sizing: border-box;\n                    transform: rotate(45deg);\n                    display: grid;\n                    place-content: center;\n                    mask: conic-gradient(#000 0 10%), conic-gradient(#000 0 0) content-box exclude;\n                    overflow: hidden;\n                    margin-bottom: 30px;\n                }\n                \n                .custom-loader-enhanced:before {\n                    content: "";\n                    position: absolute;\n                    inset: 0;\n                    transform: scale(1.5);\n                    background: linear-gradient(\n                        0,\n                        transparent 0%,\n                        transparent 10%,\n                        transparent 40%,\n                        ${this.colors.quaternary} 50%,\n                        ${this.colors.primary} 60%,\n                        ${this.colors.tertiary} 60%\n                    );\n                    filter: blur(8px);\n                    animation: custom-loader-spin ${this.animationDuration} linear infinite;\n                }\n                \n                .custom-loader-item-enhanced {\n                    background: linear-gradient(45deg, \n                        ${this.colors.primary}, \n                        ${this.colors.secondary}, \n                        ${this.colors.tertiary}, \n                        ${this.colors.quaternary}, \n                        ${this.colors.tertiary}\n                    );\n                    height: 5px;\n                    width: 5px;\n                    border: 5px solid #000;\n                    box-shadow: inset -8px -8px 0 black, inset 8px 8px 0 black;\n                    aspect-ratio: 1;\n                    z-index: 2;\n                    filter: unset;\n                    position: relative;\n                }\n                \n                @keyframes custom-loader-spin {\n                    to {\n                        rotate: 1turn;\n                    }\n                }\n                \n                @keyframes pulse {\n                    0% { opacity: 0.6; }\n                    50% { opacity: 1; }\n                    100% { opacity: 0.6; }\n                }\n                \n                @keyframes text-fade {\n                    0% { opacity: 0.6; }\n                    100% { opacity: 1; }\n                }\n                \n                .loader-pulse {\n                    animation: pulse 1.5s ease-in-out infinite;\n                }\n\n                .random-loading-text {\n                    animation: text-fade 2s ease-in-out infinite alternate;\n                    margin-bottom: 15px;\n                    font-size: 16px;\n                    opacity: 0.8;\n                }\n            `,document.head.appendChild(t)}this.randomText=document.createElement("div"),this.randomText.className="random-loading-text",this.randomText.style.cssText="\n            font-size: 16px;\n            margin-bottom: 15px;\n            font-weight: 400;\n            opacity: 0.8;\n        ",this.randomText.textContent=this.getRandomText(),this.loadingText=document.createElement("div"),this.loadingText.style.cssText="\n            font-size: 18px;\n            margin-bottom: 20px;\n            font-weight: 500;\n        ",this.loadingText.textContent=this.title,this.progressContainer=document.createElement("div"),this.progressContainer.style.cssText="\n            width: 300px;\n            height: 8px;\n            background: rgba(255, 255, 255, 0.2);\n            border-radius: 4px;\n            overflow: hidden;\n            margin-bottom: 10px;\n            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);\n        ",this.progressBar=document.createElement("div"),this.progressBar.style.cssText=`\n            width: 0%;\n            height: 100%;\n            background: linear-gradient(90deg, ${this.colors.primary}, ${this.colors.secondary}, ${this.colors.tertiary});\n            border-radius: 4px;\n            transition: width 0.4s ease;\n            box-shadow: 0 0 10px rgba(255, 223, 0, 0.4);\n        `,this.progressText=document.createElement("div"),this.progressText.style.cssText="\n            font-size: 14px;\n            opacity: 0.8;\n            font-weight: 300;\n            margin-bottom: 10px;\n        ",this.progressText.textContent="0%",this.detailsText=document.createElement("div"),this.detailsText.style.cssText="\n            font-size: 12px;\n            opacity: 0.6;\n            text-align: center;\n        ",this.detailsText.textContent=`Loading ${this.totalItems} items...`,this.progressContainer.appendChild(this.progressBar),this.loaderOverlay.appendChild(this.loadingSpinner),this.loaderOverlay.appendChild(this.randomText),this.loaderOverlay.appendChild(this.loadingText),this.loaderOverlay.appendChild(this.progressContainer),this.loaderOverlay.appendChild(this.progressText),this.loaderOverlay.appendChild(this.detailsText)}show(){this.isVisible||(document.body.appendChild(this.loaderOverlay),this.isVisible=!0,setTimeout((()=>{this.loaderOverlay.style.opacity="1"}),10),this.textInterval=setInterval((()=>{this.isVisible&&this.randomText&&(this.randomText.textContent=this.getRandomText())}),3e3))}hide(){this.isVisible&&(this.loaderOverlay.style.opacity="0",this.textInterval&&(clearInterval(this.textInterval),this.textInterval=null),setTimeout((()=>{this.loaderOverlay&&this.loaderOverlay.parentNode&&(this.loaderOverlay.parentNode.removeChild(this.loaderOverlay),this.isVisible=!1)}),300))}updateProgress(t=1,e=""){this.loadedItems+=t;const i=Math.min(this.loadedItems/this.totalItems*100,100);this.progressBar.style.width=`${i}%`,this.progressText.textContent=`${Math.round(i)}%`,this.detailsText.textContent=e?`Loaded: ${e}`:`${this.loadedItems}/${this.totalItems} items loaded`,this.loadedItems>=this.totalItems&&this.complete()}complete(){this.loadingText.textContent="Complete!",this.detailsText.textContent="All models loaded successfully",this.randomText.textContent="Ready to go!",this.loadingSpinner.style.display="none",this.textInterval&&(clearInterval(this.textInterval),this.textInterval=null),this.onComplete&&"function"==typeof this.onComplete&&this.onComplete(),setTimeout((()=>{this.hide()}),800)}setTitle(t){this.title=t,this.loadingText&&(this.loadingText.textContent=t)}setDetails(t){this.detailsText&&(this.detailsText.textContent=t)}setProgress(t){const e=Math.max(0,Math.min(100,t));this.progressBar.style.width=`${e}%`,this.progressText.textContent=`${Math.round(e)}%`}setOnComplete(t){this.onComplete=t}isComplete(){return this.loadedItems>=this.totalItems}reset(){this.loadedItems=0,this.progressBar.style.width="0%",this.progressText.textContent="0%",this.loadingText.textContent=this.title,this.detailsText.textContent=`Loading ${this.totalItems} items...`,this.loadingSpinner.style.display="block",this.randomText.textContent=this.getRandomText(),this.isVisible&&!this.textInterval&&(this.textInterval=setInterval((()=>{this.isVisible&&this.randomText&&(this.randomText.textContent=this.getRandomText())}),3e3))}cleanup(){if(this.textInterval&&(clearInterval(this.textInterval),this.textInterval=null),this.hide(),document.querySelectorAll('[id^="model-loader"]').length<=1){const t=document.getElementById("loader-styles");t&&t.remove()}}}class ly{followTarget=new us;pivot;constructor(t,e,i,s={x:0,y:1,z:0},n=null,o){this.scene=t,this.world=e,this.loadingManager=o,this.startPosition=new Ud(s.x,s.y,s.z),this.car={},this.chassis={},this.wheels=[],this.chassisDimension={x:2.7,y:1,z:7},this.chassisModelPos={x:0,y:0,z:0},this.wheelScale={frontWheel:1.1,hindWheel:1.1},this.mass=500,this.pivot=i,this.maxForce=1800,this.speedMultiplier=1.5,this.brakeLight=null,this.originalBrakeLightMaterial=null,this.isBraking=!1,this.isReversing=!1,this.mixer=null,this.boostAnimation=null,this.isBoostAnimationPlaying=!1,this.animationClock=new qc,this.isDrifting=!1,this.normalFriction=2,this.driftFriction=.05,this.driftSteerMultiplier=1,this.flipCheckInterval=100,this.flipThreshold=Math.PI/3,this.timeUpsideDown=0,this.flipResetDelay=2e3,this.lastFlipCheck=0,this.isFlipped=!1,this.currentFlipType="upright",this.health=n,this.wasDestroyed=!1,this.controlsDisabled=!1,this.loader=new hy(5,"Loading Car Models..."),this.isLoaded=!1,this.loader.setOnComplete((()=>{this.isLoaded=!0,console.log("Car models loaded successfully!")}))}setupAnimations(t){if(t.animations&&t.animations.length>0){this.mixer=new md(this.chassis);const e=t.animations.find((t=>t.name.includes("Boost")));e?(this.boostAnimation=this.mixer.clipAction(e),this.boostAnimation.setLoop(_e),this.boostAnimation.clampWhenFinished=!1,console.log("Boost animation found and setup:",e.name)):console.warn("Boost animation not found. Available animations:",t.animations.map((t=>t.name)))}else console.warn("No animations found in the GLTF model")}playBoostAnimation(){this.boostAnimation&&!this.isBoostAnimationPlaying&&(this.boostAnimation.reset(),this.boostAnimation.play(),this.isBoostAnimationPlaying=!0,console.log("Boost animation started"))}stopBoostAnimation(){this.boostAnimation&&this.isBoostAnimationPlaying&&(this.boostAnimation.stop(),this.isBoostAnimationPlaying=!1,console.log("Boost animation stopped"))}updateAnimations(){if(this.mixer){const t=this.animationClock.getDelta();this.mixer.update(t)}}createChassisWireframe(){const t=new gh(this.chassisDimension.x,this.chassisDimension.y,this.chassisDimension.z),e=new Os({color:16711680,wireframe:!0,transparent:!0,opacity:.8});this.chassisWireframe=new Cn(t,e),this.chassisWireframe.visible=!1,this.scene.add(this.chassisWireframe),console.log("Chassis wireframe created with dimensions:",this.chassisDimension)}createChassisWireframeEdges(){const t=new gh(this.chassisDimension.x,this.chassisDimension.y,this.chassisDimension.z),e=new bh(t),i=new Va({color:65280,linewidth:2});this.chassisWireframe=new Ja(e,i),this.scene.add(this.chassisWireframe),console.log("Chassis wireframe edges created with dimensions:",this.chassisDimension)}startDrift(){this.isDrifting||(this.isDrifting=!0,this.car.wheelInfos&&this.car.wheelInfos.length>=4&&(this.car.wheelInfos[0].frictionSlip=this.driftFriction,this.car.wheelInfos[1].frictionSlip=this.driftFriction,this.car.wheelInfos[2].frictionSlip=this.normalFriction,this.car.wheelInfos[3].frictionSlip=this.normalFriction),console.log("Drift mode activated!"))}stopDrift(){if(this.isDrifting){if(this.isDrifting=!1,this.car.wheelInfos&&this.car.wheelInfos.length>=4)for(let t=0;t<4;t++)this.car.wheelInfos[t].frictionSlip=this.normalFriction;console.log("Drift mode deactivated.")}}checkIfFlipped(){if(!this.car.chassisBody)return!1;const t=new Ud(0,1,0);return this.car.chassisBody.quaternion.vmult(t,t),t.y<.3}checkFlipByRotation(){if(!this.car.chassisBody)return!1;const t=new Yi,e=new ui(this.car.chassisBody.quaternion.x,this.car.chassisBody.quaternion.y,this.car.chassisBody.quaternion.z,this.car.chassisBody.quaternion.w);t.setFromQuaternion(e);const i=Math.abs(t.z),s=Math.abs(t.x),n=Math.min(i,Math.PI-i),o=Math.min(s,Math.PI-s),r=Math.PI/3;return n>r||o>r}checkFlipByGroundContact(){if(!this.car.chassisBody)return!1;const t=new Ud(0,1,0);this.car.chassisBody.quaternion.vmult(t,t);const e=t.y>.3;if(this.car.wheelInfos&&4===this.car.wheelInfos.length){let t=0;const i=this.car.chassisBody.position.y;for(let e=0;e<4;e++)this.car.wheelInfos[e]&&this.car.wheelInfos[e].worldTransform&&this.car.wheelInfos[e].worldTransform.position.y>i+.5&&t++;return!(e&&t<3)}return!e}getFlipType(){if(!this.car.chassisBody)return"none";const t=new Yi,e=new ui(this.car.chassisBody.quaternion.x,this.car.chassisBody.quaternion.y,this.car.chassisBody.quaternion.z,this.car.chassisBody.quaternion.w);t.setFromQuaternion(e);const i=t.z,s=t.x,n=new Ud(0,1,0);return this.car.chassisBody.quaternion.vmult(n,n),n.y<-.5?"upside_down":Math.abs(i)>Math.PI/3?i>0?"right_side":"left_side":Math.abs(s)>Math.PI/3?s>0?"nose_down":"nose_up":n.y<.3?"tilted":"upright"}handleFlipDetection(t){const e=performance.now();if(e-this.lastFlipCheck<this.flipCheckInterval)return;this.lastFlipCheck=e;const i=this.checkFlipByGroundContact(),s=this.getFlipType();if(i)if(this.isFlipped){if(this.timeUpsideDown+=this.flipCheckInterval,this.timeUpsideDown%1e3==0){const t=(this.flipResetDelay-this.timeUpsideDown)/1e3;console.log(`Auto-reset in ${t} seconds... (${s})`)}this.timeUpsideDown>=this.flipResetDelay&&(console.log(`Car has been ${s} for too long. Auto-resetting...`),this.autoReset(s))}else this.isFlipped=!0,this.timeUpsideDown=0,console.log(`Car flipped! Type: ${s}. Starting countdown...`);else this.isFlipped&&(this.isFlipped=!1,this.timeUpsideDown=0,console.log("Car recovered from flip."))}autoReset(t="unknown"){const e=this.car.chassisBody.position;let i=3;"upside_down"===t?i=4:"left_side"!==t&&"right_side"!==t||(i=3.5),this.car.chassisBody.position.set(e.x,e.y+i,e.z);const s=this.car.chassisBody.quaternion,n=new Yi,o=new ui(s.x,s.y,s.z,s.w);n.setFromQuaternion(o);const r=new Ud(0,n.y,0),a=new Kd;a.setFromEuler(r.x,r.y,r.z),this.car.chassisBody.quaternion.copy(a),this.car.chassisBody.angularVelocity.set(0,0,0),this.car.chassisBody.velocity.set(0,0,0),this.isFlipped=!1,this.timeUpsideDown=0,console.log(`Car auto-reset completed. Was: ${t}, now upright at:`,e)}setupFrontLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup front light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.frontLights=[],this.originalFrontLightMaterials=new Map,this.frontLightObjects=[],this.frontLightFlares=[],this.isFrontLightOn=!1,this.chassis.traverse((e=>{if("Object_1"===e.name){this.frontLights.push(e),this.frontLightObjects.push(e),e.material&&this.originalFrontLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16777215,transparent:!0,opacity:.9,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16777130,transparent:!0,opacity:.7,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1.5,1.5,1.5),n.visible=!1;const o=new Ma(s);o.scale.set(1.5,1.5,1.5),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.5);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.frontLightFlares.push([n,o]),console.log(`Front light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.frontLights.length&&console.warn("Front lights not found in chassis model - check object names")}toggleFrontLight(){this.isFrontLightOn?this.deactivateFrontLight():this.activateFrontLight()}activateFrontLight(){if(this.frontLights&&!this.isFrontLightOn){this.isFrontLightOn=!0;const t=new cl({color:16777215,emissive:new Ds(1,1,.9).multiplyScalar(.6),emissiveIntensity:15});this.frontLights.forEach((e=>{e.material=t})),this.frontLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Front lights activated (with lens flare)")}}deactivateFrontLight(){this.frontLights&&this.isFrontLightOn&&(this.isFrontLightOn=!1,this.frontLights.forEach((t=>{const e=this.originalFrontLightMaterials.get(t);e&&(t.material=e)})),this.frontLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Front lights deactivated (original state)"))}updateFrontLightFlarePositions(){this.frontLights&&this.frontLightFlares&&this.frontLights.forEach(((t,e)=>{if(this.frontLightFlares[e]){const[i,s]=this.frontLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(-1.1,-.3,2.9),o=new pi(1.1,-.3,2.9);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(.5),r=n.clone().multiplyScalar(.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustFrontFlarePosition(t,e,i,s,n){if(this.frontLightFlares&&this.frontLightFlares[t]){const o=this.frontLightFlares[t];if(o[e]){const r=o[e],a=this.frontLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Front Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothFrontFlares(t,e,i){this.adjustFrontFlarePosition(t,0,e.x,e.y,e.z),this.adjustFrontFlarePosition(t,1,i.x,i.y,i.z)}handleFrontLightToggle(t){"l"!==t.key&&"L"!==t.key||this.toggleFrontLight()}setupFrontLightKeyListener(){document.addEventListener("keydown",(t=>{this.handleFrontLightToggle(t)})),console.log("Front light key listener setup - Press 'L' to toggle front lights")}setupBrakeLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup brake light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.brakeLights=[],this.originalBrakeLightMaterials=new Map,this.brakeLightObjects=[],this.brakeLightFlares=[],this.chassis.traverse((e=>{if("Object"===e.name){this.brakeLights.push(e),this.brakeLightObjects.push(e),e.material&&this.originalBrakeLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16711680,transparent:!0,opacity:.8,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16711680,transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1,1,1),n.visible=!1;const o=new Ma(s);o.scale.set(1,1,1),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.3);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.brakeLightFlares.push([n,o]),console.log(`Brake light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.brakeLights.length&&console.warn("Brake lights (Object_29 / Object_33) not found in chassis model")}activateBrakeLight(){if(this.brakeLights&&!this.isBraking){this.isBraking=!0;const t=new cl({color:16711680,emissive:new Ds(1,0,0).multiplyScalar(.5),emissiveIntensity:10});this.brakeLights.forEach((e=>{e.material=t})),this.brakeLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Brake lights activated (with lens flare)")}}deactivateBrakeLight(){this.brakeLights&&this.isBraking&&(this.isBraking=!1,this.brakeLights.forEach((t=>{const e=this.originalBrakeLightMaterials.get(t);e&&(t.material=e)})),this.brakeLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Brake lights deactivated (original state)"))}updateBrakeLightFlarePositions(){this.brakeLights&&this.brakeLightFlares&&this.brakeLights.forEach(((t,e)=>{if(this.brakeLightFlares[e]){const[i,s]=this.brakeLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(1.2,0,-3.3),o=new pi(-1.2,0,-3.3);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(-.3),r=n.clone().multiplyScalar(-.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustBrakeFlarePosition(t,e,i,s,n){if(this.brakeLightFlares&&this.brakeLightFlares[t]){const o=this.brakeLightFlares[t];if(o[e]){const r=o[e],a=this.brakeLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Brake Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothBrakeFlares(t,e,i){this.adjustBrakeFlarePosition(t,0,e.x,e.y,e.z),this.adjustBrakeFlarePosition(t,1,i.x,i.y,i.z)}setupReverseLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup reverse light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.reverseLights=[],this.originalReverseLightMaterials=new Map,this.reverseLightObjects=[],this.reverseLightFlares=[],this.chassis.traverse((e=>{if("Object"===e.name){this.reverseLights.push(e),this.reverseLightObjects.push(e),e.material&&this.originalReverseLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16777215,transparent:!0,opacity:.8,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16777215,transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1,1,1),n.visible=!1;const o=new Ma(s);o.scale.set(1,1,1),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.3);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.reverseLightFlares.push([n,o]),console.log(`Reverse light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.reverseLights.length&&console.warn("Reverse lights not found in chassis model")}activateReverseLight(){if(this.reverseLights&&!this.isReversing){this.isReversing=!0;const t=new cl({color:16777215,emissive:new Ds(1,1,1).multiplyScalar(.5),emissiveIntensity:50});this.reverseLights.forEach((e=>{e.material=t})),this.reverseLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Reverse lights activated (with lens flare)")}}deactivateReverseLight(){this.reverseLights&&this.isReversing&&(this.isReversing=!1,this.reverseLights.forEach((t=>{const e=this.originalReverseLightMaterials.get(t);e&&(t.material=e)})),this.reverseLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Reverse lights deactivated (original state)"))}updateReverseLightFlarePositions(){this.reverseLights&&this.reverseLightFlares&&this.reverseLights.forEach(((t,e)=>{if(this.reverseLightFlares[e]){const[i,s]=this.reverseLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(1.2,0,-3.3),o=new pi(-1.2,0,-3.3);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(-.3),r=n.clone().multiplyScalar(-.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustFlarePosition(t,e,i,s,n){if(this.reverseLightFlares&&this.reverseLightFlares[t]){const o=this.reverseLightFlares[t];if(o[e]){const r=o[e],a=this.reverseLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothFlares(t,e,i){this.adjustFlarePosition(t,0,e.x,e.y,e.z),this.adjustFlarePosition(t,1,i.x,i.y,i.z)}init(t=null){this.health=t,this.loader.show(),this.loadModels(),this.setChassis(),this.setWheels(),this.controls(),this.update(),this.createChassisWireframe()}loadModels(){const t=new Zg(this.loadingManager),e=new Kg(this.loadingManager);e.setDecoderConfig({type:"js"}),e.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/"),t.setDRACOLoader(e),t.load("./car/Ferrari_Spy.glb",(t=>{this.chassis=t.scene,this.chassis.traverse((function(t){t.isMesh&&(t.castShadow=!0,t.recieveShadow=!0)})),this.chassis.scale.set(1,1,1),this.scene.add(this.chassis),this.loader.updateProgress(1,"Chassis"),this.setupBrakeLight(),this.setupReverseLight(),this.setupFrontLight(),this.setupFrontLightKeyListener(),this.setupAnimations(t)}),(t=>{console.log("Chassis loading progress:",t.loaded/t.total*100+"%")}),(t=>{console.error("Error loading chassis:",t),this.loader.setTitle("Error loading chassis model"),this.loader.setDetails("Please check the model file path")})),this.wheels=[];for(let e=0;e<4;e++)t.load("./car/Ferrari_Spy_Wheel.glb",(t=>{const i=t.scene;this.wheels[e]=i,1===e||3===e?this.wheels[e].scale.set(-1.5*this.wheelScale.frontWheel,1.5*this.wheelScale.frontWheel,-1.5*this.wheelScale.frontWheel):this.wheels[e].scale.set(1.5*this.wheelScale.frontWheel,1.5*this.wheelScale.frontWheel,1.5*this.wheelScale.frontWheel),this.scene.add(this.wheels[e]),this.loader.updateProgress(1,`Wheel ${e+1}`)}),(t=>{console.log(`Wheel ${e} loading progress:`,t.loaded/t.total*100+"%")}),(t=>{console.error(`Error loading wheel ${e}:`,t),this.loader.setTitle(`Error loading wheel ${e+1}`),this.loader.setDetails("Please check the wheel model file path")}))}setChassis(){const t=new hu(new Ud(.5*this.chassisDimension.x,.5*this.chassisDimension.y,.5*this.chassisDimension.z)),e=new Op({friction:.3,restitution:.1}),i=new du({mass:this.mass,material:e,type:du.DYNAMIC,collisionFilterGroup:1,collisionFilterMask:1});i.linearDamping=.1,i.angularDamping=.1,i.addShape(t),i.position.set(this.startPosition.x,this.startPosition.y,this.startPosition.z);const s=new Ud(0,-Math.PI/2,0),n=new Kd;n.setFromEuler(s.x,s.y,s.z),i.quaternion.copy(n),this.world.addBody(i),this.car=new Up({chassisBody:i,indexRightAxis:0,indexUpAxis:1,indexForwardAxis:2}),i.userData={type:"car",car:this},this.car.addToWorld(this.world),this.chassisBody=i}setWheels(){this.car.wheelInfos=[];const t=[new Ud(1.25,-.5,-2.25),new Ud(-1.25,-.5,-2.25),new Ud(1.2,-.5,1.75),new Ud(-1.2,-.5,1.75)];for(let e=0;e<4;e++)this.car.addWheel({radius:.5,directionLocal:new Ud(0,-1,0),suspensionStiffness:30,suspensionRestLength:.3,frictionSlip:2.5,dampingRelaxation:2.3,dampingCompression:4.3,maxSuspensionForce:1e5,rollInfluence:.01,axleLocal:new Ud(-1,0,0),chassisConnectionPointLocal:t[e],maxSuspensionTravel:.3,customSlidingRotationalSpeed:30,useCustomSlidingRotationalSpeed:!0})}ensureGroundExists(){if(!this.groundBody){const t=new mm;this.groundBody=new du({mass:0,material:new Op({friction:.4,restitution:.3})}),this.groundBody.addShape(t),this.groundBody.quaternion.setFromAxisAngle(new Ud(1,0,0),-Math.PI/2),this.groundBody.collisionFilterGroup=2,this.groundBody.collisionFilterMask=-1,this.world.addBody(this.groundBody)}}setHealthSystem(t){this.health=t,console.log("Health system attached to car")}controls(){const t=.5,e=[];this.previousPosition=null,this.previousTime=null,this.currentSpeed=0,this.maxReachedSpeed=0,this.speedHistory=[],this.maxHistoryLength=10,this.averageSpeed=0,this.options={unit:"mph",maxSpeed:180},this.needleSmoothing=.1,this.currentNeedleAngle=-135,this.targetNeedleAngle=-135,this.accelerationPhase=0,this.isInGearShift=!1,this.gearShiftTimer=0,this.gearShiftDuration=150,this.lastGearShiftTime=0,this.accelerationStartTime=0,this.wasAcceleratingPreviously=!1,this.accelerationPhases=[{maxForce:2800,duration:600},{maxForce:2600,duration:1200},{maxForce:2400,duration:1800},{maxForce:2200,duration:2400},{maxForce:2e3,duration:1/0}],this.sounds={drifting:null,gearShift:null,brake:null,backfire:null},this.activeSounds=new Set,this.soundStates={drifting:!1,brake:!1},this.backfireSystem={lastBackfireTime:0,backfireChance:.3,backfireCooldown:2e3,highSpeedBackfireChance:.6,highSpeedThreshold:60,gearShiftBackfireChance:.4,engineOffBackfireChance:.7,lastEngineState:!1,wasAcceleratingRecently:!1,recentAccelerationTime:0},this.fadeOutTimer=null,this.fadeOutDuration=300,this.fadeInDuration=150,this.speedThreshold=2,this.lastSoundChangeTime=0,this.soundChangeDelay=50,this.isMoving=!1,this.wasMoving=!1,this.isDriftingNow=!1,this.wasDriftingPreviously=!1,this.driftStartTime=0,this.driftMinDuration=100,this.lastDriftEndTime=0,this.driftCooldown=200,this.speedThresholds={deceleration:{min:0,max:50}},this.initSounds=()=>{this.sounds.drifting=new Audio("./sounds/fer_drift.wav"),this.sounds.gearShift=new Audio("./sounds/fer_gear.mp3"),this.sounds.brake=new Audio("./sounds/fer_brake.mp3"),this.sounds.backfire=new Audio("./sounds/backfire.mp3"),this.sounds.drifting.loop=!0,this.sounds.brake.loop=!1,this.sounds.backfire.loop=!1,this.sounds.drifting.volume=.6,this.sounds.gearShift.volume=.3,this.sounds.brake.volume=1,this.sounds.backfire.volume=.8,Object.keys(this.sounds).forEach((t=>{this.sounds[t]&&this.sounds[t].addEventListener("error",(e=>{console.warn(`Failed to load ${t} sound:`,e)}))}))},this.initSounds(),this.calculateSpeed=()=>{if(!this.car||!this.car.chassisBody)return 0;const t=Date.now(),e=this.car.chassisBody.position;if(!this.previousPosition)return this.previousPosition=e.clone(),this.previousTime=t,0;const i=e.distanceTo(this.previousPosition),s=(t-this.previousTime)/1e3;if(0===s)return this.currentSpeed;const n=i/s;let o;return o="mph"===this.options.unit?2.237*n:3.6*n,this.previousPosition=e.clone(),this.previousTime=t,Math.max(0,o)},this.updateSpeed=()=>{const t=this.calculateSpeed();this.currentSpeed=this.currentSpeed+.1*(t-this.currentSpeed),this.currentSpeed>this.maxReachedSpeed&&(this.maxReachedSpeed=this.currentSpeed,this.onMaxSpeedReached&&this.onMaxSpeedReached(this.maxReachedSpeed)),this.speedHistory.push(this.currentSpeed),this.speedHistory.length>this.maxHistoryLength&&this.speedHistory.shift(),this.averageSpeed=this.speedHistory.reduce(((t,e)=>t+e),0)/this.speedHistory.length;const e=Math.min(this.currentSpeed/this.options.maxSpeed,1);this.targetNeedleAngle=270*e-135,this.currentNeedleAngle=this.currentNeedleAngle+(this.targetNeedleAngle-this.currentNeedleAngle)*this.needleSmoothing,this.updateSpeedometerUI&&this.updateSpeedometerUI(),this.onSpeedChange&&this.onSpeedChange(this.currentSpeed,this.maxReachedSpeed,this.averageSpeed)},this.startSound=(t,e=null,i=!1)=>{if(!this.sounds[t]||!i&&this.soundStates[t])return;const s=this.sounds[t],n=e||this.getOriginalVolume(t);s.fadeInterval&&clearInterval(s.fadeInterval),s.volume=0,s.currentTime=0;const o=s.play();o&&o.catch((e=>console.log(`${t} audio play failed:`,e))),this.soundStates[t]=!0,this.activeSounds.add(t);const r=n/(this.fadeInDuration/20);s.fadeInterval=setInterval((()=>{s.volume=Math.min(n,s.volume+r),s.volume>=n&&(clearInterval(s.fadeInterval),s.fadeInterval=null)}),20)},this.stopSound=(t,e=null,i=!1)=>{if(!this.sounds[t]||!i&&!this.soundStates[t])return void(e&&e());const s=this.sounds[t];if(s.fadeInterval&&clearInterval(s.fadeInterval),s.paused||0===s.volume)return this.soundStates[t]=!1,this.activeSounds.delete(t),void(e&&e());const n=s.volume/(this.fadeOutDuration/20);s.fadeInterval=setInterval((()=>{s.volume=Math.max(0,s.volume-n),s.volume<=0&&(clearInterval(s.fadeInterval),s.fadeInterval=null,s.pause(),s.currentTime=0,s.volume=this.getOriginalVolume(t),this.soundStates[t]=!1,this.activeSounds.delete(t),e&&e())}),20)},this.playGearShiftSound=()=>{if(this.sounds.gearShift){const t=new Audio("./sounds/fer_gear.mp3");t.volume=.3,t.currentTime=0,t.play().catch((t=>console.log("Gear shift sound failed:",t))),this.tryPlayBackfire("gearshift")}},this.tryPlayBackfire=(t="random")=>{const e=Date.now();if(e-this.backfireSystem.lastBackfireTime<this.backfireSystem.backfireCooldown)return;let i=0;switch(t){case"gearshift":i=this.backfireSystem.gearShiftBackfireChance;break;case"engineoff":i=this.backfireSystem.engineOffBackfireChance;break;case"deceleration":i=this.currentSpeed>this.backfireSystem.highSpeedThreshold?this.backfireSystem.highSpeedBackfireChance:this.backfireSystem.backfireChance;break;default:i=this.backfireSystem.backfireChance}Math.random()<i&&(this.playBackfireSound(),this.backfireSystem.lastBackfireTime=e,console.log(`BACKFIRE triggered by: ${t}`))},this.playBackfireSound=()=>{if(this.sounds.backfire){const t=new Audio("./sounds/backfire.mp3");t.volume=.8,t.currentTime=0,t.play().catch((t=>console.log("Backfire sound failed:",t)))}},this.getOriginalVolume=t=>({drifting:.6,gearShift:.3,brake:1,backfire:.8}[t]||.5),this.stopAllSounds=(t=!1)=>{Object.keys(this.sounds).forEach((e=>{if(this.sounds[e]){const i=this.sounds[e];i.fadeInterval&&clearInterval(i.fadeInterval),t?(i.pause(),i.currentTime=0,i.volume=this.getOriginalVolume(e),this.soundStates[e]=!1):this.stopSound(e,null,!0)}})),this.activeSounds.clear()},this.isCarSpeedLow=()=>this.currentSpeed<5,this.updateSound=()=>{const t=Date.now(),i=this.currentSpeed;this.isMoving=i>this.speedThreshold;const s=e.includes("w")||e.includes("arrowup"),n=e.includes("s")||e.includes("arrowdown"),o=e.includes(" "),r=e.includes("a")||e.includes("arrowleft"),a=e.includes("d")||e.includes("arrowright"),h=s||n;if(this.backfireSystem.lastEngineState&&!h&&this.isMoving&&this.tryPlayBackfire("engineoff"),s)this.backfireSystem.wasAcceleratingRecently=!0,this.backfireSystem.recentAccelerationTime=t;else if(this.backfireSystem.wasAcceleratingRecently){const e=t-this.backfireSystem.recentAccelerationTime;e<1e3&&this.isMoving&&i>20?(this.tryPlayBackfire("deceleration"),this.backfireSystem.wasAcceleratingRecently=!1):e>2e3&&(this.backfireSystem.wasAcceleratingRecently=!1)}this.backfireSystem.lastEngineState=h;const l=o&&(r||a)&&s&&this.isMoving,c=o&&!r&&!a&&this.isMoving&&!s;l&&!this.isDriftingNow?t-this.lastDriftEndTime>this.driftCooldown&&(this.isDriftingNow=!0,this.driftStartTime=t,this.stopSound("brake",null,!0),this.startSound("drifting",null,!0),console.log("DRIFT START")):!l&&this.isDriftingNow&&t-this.driftStartTime>this.driftMinDuration&&(this.isDriftingNow=!1,this.lastDriftEndTime=t,this.stopSound("drifting",null,!0),console.log("DRIFT STOP")),!c||this.isDriftingNow||this.soundStates.brake?c&&!this.isDriftingNow||!this.soundStates.brake||(this.stopSound("brake"),console.log("BRAKE STOP")):(this.startSound("brake"),console.log("BRAKE START")),this.soundStates.drifting&&(!o||!this.isMoving||i<3)&&(this.stopSound("drifting",null,!0),this.isDriftingNow=!1,console.log("DRIFT FORCE STOP - Safety check")),this.wasDriftingPreviously=this.isDriftingNow,this.wasMoving=this.isMoving},this.updateAcceleration=()=>{const t=Date.now(),i=e.includes("w")||e.includes("arrowup");if(i&&!this.wasAcceleratingPreviously&&(this.accelerationPhase=0,this.accelerationStartTime=t,this.isInGearShift=!1,this.gearShiftTimer=0),i){const e=t-this.accelerationStartTime;if(!this.isInGearShift&&this.accelerationPhase<4){const t=this.accelerationPhases[this.accelerationPhase];(this.accelerationPhase>0&&e>=t.duration||0===this.accelerationPhase&&e>=100)&&this.startGearShift()}this.isInGearShift&&t-this.lastGearShiftTime>=this.gearShiftDuration&&this.completeGearShift(),this.wasAcceleratingPreviously=!0}else this.accelerationPhase=0,this.isInGearShift=!1,this.wasAcceleratingPreviously=!1},this.startGearShift=()=>{this.isInGearShift=!0,this.lastGearShiftTime=Date.now(),this.playGearShiftSound()},this.completeGearShift=()=>{this.isInGearShift=!1,this.accelerationPhase=Math.min(this.accelerationPhase+1,4),this.accelerationStartTime=Date.now()},this.getCurrentMaxForce=()=>this.isInGearShift?.3*this.accelerationPhases[this.accelerationPhase].maxForce:this.accelerationPhases[this.accelerationPhase].maxForce,window.addEventListener("keydown",(t=>{this.isLoaded&&(e.includes(t.key.toLowerCase())||e.push(t.key.toLowerCase()),i())})),window.addEventListener("keyup",(t=>{this.isLoaded&&(e.splice(e.indexOf(t.key.toLowerCase()),1),i())}));const i=()=>{if(this.controlsDisabled)return;this.updateSpeed(),this.updateAcceleration(),e.includes("f")&&(this.toggleWireframe(),e.splice(e.indexOf("f"),1));const i=e.includes("w")||e.includes("arrowup"),r=e.includes(" "),a=e.includes("a")||e.includes("arrowleft"),h=e.includes("d")||e.includes("arrowright"),l=r&&(a||h)&&i&&this.isMoving;if(l&&!this.isDrifting?this.startDrift():!l&&this.isDrifting&&this.stopDrift(),!r||l){r?l&&this.activateBrakeLight():this.deactivateBrakeLight(),this.car.setBrake(0,0),this.car.setBrake(0,1),this.car.setBrake(0,2),this.car.setBrake(0,3);const i=this.isDrifting?this.driftSteerMultiplier:1;if(a?(this.car.setSteeringValue(t*i,2),this.car.setSteeringValue(t*i,3)):h?(this.car.setSteeringValue(t*-i,2),this.car.setSteeringValue(t*-i,3)):o(),e.includes("w")||e.includes("arrowup")){const t=this.getCurrentMaxForce();this.car.applyEngineForce(-1*t,0),this.car.applyEngineForce(-1*t,1),this.car.applyEngineForce(-1*t,2),this.car.applyEngineForce(-1*t,3)}else e.includes("s")||e.includes("arrowdown")?(l||this.activateReverseLight(),this.car.applyEngineForce(1*this.maxForce,0),this.car.applyEngineForce(1*this.maxForce,1),this.car.applyEngineForce(1*this.maxForce,2),this.car.applyEngineForce(1*this.maxForce,3)):(this.car.applyEngineForce(0,0),this.car.applyEngineForce(0,1),this.car.applyEngineForce(0,2),this.car.applyEngineForce(0,3),this.deactivateReverseLight(),l||n())}else this.activateBrakeLight(),s();this.updateSound()},s=()=>{this.car.setBrake(45,0),this.car.setBrake(45,1),this.car.setBrake(45,2),this.car.setBrake(45,3)},n=()=>{this.car.setBrake(25,0),this.car.setBrake(25,1),this.car.setBrake(25,2),this.car.setBrake(25,3)},o=()=>{this.car.setSteeringValue(0,2),this.car.setSteeringValue(0,3)};this.cleanup=()=>{Object.keys(this.sounds).forEach((t=>{if(this.sounds[t]){const e=this.sounds[t];e.fadeInterval&&clearInterval(e.fadeInterval),e.pause(),e.currentTime=0,e.volume=this.getOriginalVolume(t)}})),this.activeSounds.clear(),Object.keys(this.soundStates).forEach((t=>{this.soundStates[t]=!1})),this.isDriftingNow=!1,this.wasDriftingPreviously=!1,this.driftStartTime=0,this.lastDriftEndTime=0,this.fadeOutTimer&&clearTimeout(this.fadeOutTimer),console.log("CLEANUP COMPLETE - All sounds stopped")}}checkHealthStatus(){if(!this.health)return;const t=this.health.isDestroyed;t&&!this.wasDestroyed?(console.log("Car destroyed! Stopping all sounds and disabling controls."),this.onCarDestroyed()):!t&&this.wasDestroyed&&(console.log("Car repaired! Re-enabling controls."),this.onCarRepaired()),this.wasDestroyed=t}onCarDestroyed(){this.controlsDisabled=!0,this.car&&this.car.chassisBody&&(this.car.setBrake(0,0),this.car.setBrake(100,1),this.car.setBrake(500,2),this.car.setBrake(0,3),this.car.applyEngineForce(0,0),this.car.applyEngineForce(0,1),this.car.applyEngineForce(0,2),this.car.applyEngineForce(0,3),this.car.setSteeringValue(0,2),this.car.setSteeringValue(0,3)),this.stopDrift(),this.activateBrakeLight()}onCarRepaired(){this.controlsDisabled=!1,this.car&&(this.car.setBrake(0,0),this.car.setBrake(0,1),this.car.setBrake(0,2),this.car.setBrake(0,3)),this.playSound("idle")}update(){this.world.addEventListener("postStep",(()=>{if(this.updateAnimations(),this.handleFlipDetection(),this.checkHealthStatus(),this.updateReverseLightFlarePositions(),this.updateBrakeLightFlarePositions(),this.updateFrontLightFlarePositions(),this.car.wheelInfos&&this.chassis.position&&this.wheels[0]?.position){this.chassis.position.set(this.car.chassisBody.position.x+this.chassisModelPos.x,this.car.chassisBody.position.y+this.chassisModelPos.y,this.car.chassisBody.position.z+this.chassisModelPos.z),this.chassis.quaternion.copy(this.car.chassisBody.quaternion),this.chassisWireframe&&(this.chassisWireframe.position.copy(this.car.chassisBody.position),this.chassisWireframe.quaternion.copy(this.car.chassisBody.quaternion));for(let t=0;t<4;t++)this.car.wheelInfos[t]&&(this.car.updateWheelTransform(t),this.wheels[t].position.copy(this.car.wheelInfos[t].worldTransform.position),this.wheels[t].quaternion.copy(this.car.wheelInfos[t].worldTransform.quaternion))}}))}toggleWireframe(t=null){this.chassisWireframe&&(this.chassisWireframe.visible=null!==t?t:!this.chassisWireframe.visible,console.log("Chassis wireframe visibility:",this.chassisWireframe.visible))}removeWireframe(){this.chassisWireframe&&(this.scene.remove(this.chassisWireframe),this.chassisWireframe.geometry.dispose(),this.chassisWireframe.material.dispose(),this.chassisWireframe=null,console.log("Chassis wireframe removed"))}forceFlipReset(){console.log("Manual flip reset triggered"),this.autoReset()}getFlipStatus(){return{isFlipped:this.isFlipped,timeUpsideDown:this.timeUpsideDown,resetProgress:this.timeUpsideDown/this.flipResetDelay}}cleanup(){console.log("Starting car cleanup..."),this.loader&&this.loader.destroy(),this.sounds&&(Object.values(this.sounds).forEach((t=>{t&&(t.pause(),t.currentTime=0,t.src="",t.removeEventListener("ended",t.onended))})),this.sounds={}),this.mixer&&(this.mixer.stopAllAction(),this.mixer.uncacheRoot(this.mixer.getRoot()),this.mixer=null),this.boostAnimation=null,this.car&&this.car.chassisBody&&(this.car.removeFromWorld(this.world),this.world.removeBody(this.car.chassisBody)),this.chassis&&(this.chassis.traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose())})),this.scene.remove(this.chassis),this.chassis=null),this.wheels&&this.wheels.length>0&&(this.wheels.forEach((t=>{t&&(t.traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose())})),this.scene.remove(t))})),this.wheels=[]),this.removeWireframe(),this.brakeLight=null,this.originalBrakeLightMaterial&&(this.originalBrakeLightMaterial.dispose(),this.originalBrakeLightMaterial=null),this.followTarget&&(this.scene.remove(this.followTarget),this.followTarget=null),this.isDrifting=!1,this.isBraking=!1,this.isFlipped=!1,this.controlsDisabled=!1,this.wasDestroyed=!1,this.timeUpsideDown=0,this.lastFlipCheck=0,this.car=null,this.scene=null,this.world=null,this.health=null,this.pivot=null,console.log("Car cleanup completed")}}class cy{followTarget=new us;pivot;constructor(t,e,i,s={x:0,y:1,z:0},n=null,o){this.scene=t,this.world=e,this.loadingManager=o,this.startPosition=new Ud(s.x,s.y,s.z),this.car={},this.chassis={},this.wheels=[],this.chassisDimension={x:2.7,y:1,z:7},this.chassisModelPos={x:0,y:0,z:0},this.wheelScale={frontWheel:1.1,hindWheel:1.1},this.mass=500,this.pivot=i,this.maxForce=1800,this.speedMultiplier=1.5,this.brakeLight=null,this.originalBrakeLightMaterial=null,this.isBraking=!1,this.isReversing=!1,this.mixer=null,this.boostAnimation=null,this.isBoostAnimationPlaying=!1,this.animationClock=new qc,this.isDrifting=!1,this.normalFriction=2,this.driftFriction=.05,this.driftSteerMultiplier=1,this.flipCheckInterval=100,this.flipThreshold=Math.PI/3,this.timeUpsideDown=0,this.flipResetDelay=2e3,this.lastFlipCheck=0,this.isFlipped=!1,this.currentFlipType="upright",this.health=n,this.wasDestroyed=!1,this.controlsDisabled=!1,this.loader=new hy(5,"Loading Car Models..."),this.isLoaded=!1,this.loader.setOnComplete((()=>{this.isLoaded=!0,console.log("Car models loaded successfully!")}))}setupAnimations(t){if(t.animations&&t.animations.length>0){this.mixer=new md(this.chassis);const e=t.animations.find((t=>t.name.includes("Boost")));e?(this.boostAnimation=this.mixer.clipAction(e),this.boostAnimation.setLoop(_e),this.boostAnimation.clampWhenFinished=!1,console.log("Boost animation found and setup:",e.name)):console.warn("Boost animation not found. Available animations:",t.animations.map((t=>t.name)))}else console.warn("No animations found in the GLTF model")}playBoostAnimation(){this.boostAnimation&&!this.isBoostAnimationPlaying&&(this.boostAnimation.reset(),this.boostAnimation.play(),this.isBoostAnimationPlaying=!0,console.log("Boost animation started"))}stopBoostAnimation(){this.boostAnimation&&this.isBoostAnimationPlaying&&(this.boostAnimation.stop(),this.isBoostAnimationPlaying=!1,console.log("Boost animation stopped"))}updateAnimations(){if(this.mixer){const t=this.animationClock.getDelta();this.mixer.update(t)}}createChassisWireframe(){const t=new gh(this.chassisDimension.x,this.chassisDimension.y,this.chassisDimension.z),e=new Os({color:16711680,wireframe:!0,transparent:!0,opacity:.8});this.chassisWireframe=new Cn(t,e),this.chassisWireframe.visible=!1,this.scene.add(this.chassisWireframe),console.log("Chassis wireframe created with dimensions:",this.chassisDimension)}createChassisWireframeEdges(){const t=new gh(this.chassisDimension.x,this.chassisDimension.y,this.chassisDimension.z),e=new bh(t),i=new Va({color:65280,linewidth:2});this.chassisWireframe=new Ja(e,i),this.scene.add(this.chassisWireframe),console.log("Chassis wireframe edges created with dimensions:",this.chassisDimension)}startDrift(){this.isDrifting||(this.isDrifting=!0,this.car.wheelInfos&&this.car.wheelInfos.length>=4&&(this.car.wheelInfos[0].frictionSlip=this.driftFriction,this.car.wheelInfos[1].frictionSlip=this.driftFriction,this.car.wheelInfos[2].frictionSlip=this.normalFriction,this.car.wheelInfos[3].frictionSlip=this.normalFriction),console.log("Drift mode activated!"))}stopDrift(){if(this.isDrifting){if(this.isDrifting=!1,this.car.wheelInfos&&this.car.wheelInfos.length>=4)for(let t=0;t<4;t++)this.car.wheelInfos[t].frictionSlip=this.normalFriction;console.log("Drift mode deactivated.")}}checkIfFlipped(){if(!this.car.chassisBody)return!1;const t=new Ud(0,1,0);return this.car.chassisBody.quaternion.vmult(t,t),t.y<.3}checkFlipByRotation(){if(!this.car.chassisBody)return!1;const t=new Yi,e=new ui(this.car.chassisBody.quaternion.x,this.car.chassisBody.quaternion.y,this.car.chassisBody.quaternion.z,this.car.chassisBody.quaternion.w);t.setFromQuaternion(e);const i=Math.abs(t.z),s=Math.abs(t.x),n=Math.min(i,Math.PI-i),o=Math.min(s,Math.PI-s),r=Math.PI/3;return n>r||o>r}checkFlipByGroundContact(){if(!this.car.chassisBody)return!1;const t=new Ud(0,1,0);this.car.chassisBody.quaternion.vmult(t,t);const e=t.y>.3;if(this.car.wheelInfos&&4===this.car.wheelInfos.length){let t=0;const i=this.car.chassisBody.position.y;for(let e=0;e<4;e++)this.car.wheelInfos[e]&&this.car.wheelInfos[e].worldTransform&&this.car.wheelInfos[e].worldTransform.position.y>i+.5&&t++;return!(e&&t<3)}return!e}getFlipType(){if(!this.car.chassisBody)return"none";const t=new Yi,e=new ui(this.car.chassisBody.quaternion.x,this.car.chassisBody.quaternion.y,this.car.chassisBody.quaternion.z,this.car.chassisBody.quaternion.w);t.setFromQuaternion(e);const i=t.z,s=t.x,n=new Ud(0,1,0);return this.car.chassisBody.quaternion.vmult(n,n),n.y<-.5?"upside_down":Math.abs(i)>Math.PI/3?i>0?"right_side":"left_side":Math.abs(s)>Math.PI/3?s>0?"nose_down":"nose_up":n.y<.3?"tilted":"upright"}handleFlipDetection(t){const e=performance.now();if(e-this.lastFlipCheck<this.flipCheckInterval)return;this.lastFlipCheck=e;const i=this.checkFlipByGroundContact(),s=this.getFlipType();if(i)if(this.isFlipped){if(this.timeUpsideDown+=this.flipCheckInterval,this.timeUpsideDown%1e3==0){const t=(this.flipResetDelay-this.timeUpsideDown)/1e3;console.log(`Auto-reset in ${t} seconds... (${s})`)}this.timeUpsideDown>=this.flipResetDelay&&(console.log(`Car has been ${s} for too long. Auto-resetting...`),this.autoReset(s))}else this.isFlipped=!0,this.timeUpsideDown=0,console.log(`Car flipped! Type: ${s}. Starting countdown...`);else this.isFlipped&&(this.isFlipped=!1,this.timeUpsideDown=0,console.log("Car recovered from flip."))}autoReset(t="unknown"){const e=this.car.chassisBody.position;let i=3;"upside_down"===t?i=4:"left_side"!==t&&"right_side"!==t||(i=3.5),this.car.chassisBody.position.set(e.x,e.y+i,e.z);const s=this.car.chassisBody.quaternion,n=new Yi,o=new ui(s.x,s.y,s.z,s.w);n.setFromQuaternion(o);const r=new Ud(0,n.y,0),a=new Kd;a.setFromEuler(r.x,r.y,r.z),this.car.chassisBody.quaternion.copy(a),this.car.chassisBody.angularVelocity.set(0,0,0),this.car.chassisBody.velocity.set(0,0,0),this.isFlipped=!1,this.timeUpsideDown=0,console.log(`Car auto-reset completed. Was: ${t}, now upright at:`,e)}setupFrontLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup front light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.frontLights=[],this.originalFrontLightMaterials=new Map,this.frontLightObjects=[],this.frontLightFlares=[],this.isFrontLightOn=!1,this.chassis.traverse((e=>{if("Object_99"===e.name){this.frontLights.push(e),this.frontLightObjects.push(e),e.material&&this.originalFrontLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16777215,transparent:!0,opacity:.9,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16777130,transparent:!0,opacity:.7,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1.5,1.5,1.5),n.visible=!1;const o=new Ma(s);o.scale.set(1.5,1.5,1.5),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.5);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.frontLightFlares.push([n,o]),console.log(`Front light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.frontLights.length&&console.warn("Front lights not found in chassis model - check object names")}toggleFrontLight(){this.isFrontLightOn?this.deactivateFrontLight():this.activateFrontLight()}activateFrontLight(){if(this.frontLights&&!this.isFrontLightOn){this.isFrontLightOn=!0;const t=new cl({color:16777215,emissive:new Ds(1,1,.9).multiplyScalar(.6),emissiveIntensity:15});this.frontLights.forEach((e=>{e.material=t})),this.frontLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Front lights activated (with lens flare)")}}deactivateFrontLight(){this.frontLights&&this.isFrontLightOn&&(this.isFrontLightOn=!1,this.frontLights.forEach((t=>{const e=this.originalFrontLightMaterials.get(t);e&&(t.material=e)})),this.frontLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Front lights deactivated (original state)"))}updateFrontLightFlarePositions(){this.frontLights&&this.frontLightFlares&&this.frontLights.forEach(((t,e)=>{if(this.frontLightFlares[e]){const[i,s]=this.frontLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(-.7,-.15,3.1),o=new pi(.7,-.15,3.1);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(.5),r=n.clone().multiplyScalar(.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustFrontFlarePosition(t,e,i,s,n){if(this.frontLightFlares&&this.frontLightFlares[t]){const o=this.frontLightFlares[t];if(o[e]){const r=o[e],a=this.frontLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Front Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothFrontFlares(t,e,i){this.adjustFrontFlarePosition(t,0,e.x,e.y,e.z),this.adjustFrontFlarePosition(t,1,i.x,i.y,i.z)}handleFrontLightToggle(t){"l"!==t.key&&"L"!==t.key||this.toggleFrontLight()}setupFrontLightKeyListener(){document.addEventListener("keydown",(t=>{this.handleFrontLightToggle(t)})),console.log("Front light key listener setup - Press 'L' to toggle front lights")}setupBrakeLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup brake light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.brakeLights=[],this.originalBrakeLightMaterials=new Map,this.brakeLightObjects=[],this.brakeLightFlares=[],this.chassis.traverse((e=>{if("Object_29"===e.name||"Object_33"===e.name){this.brakeLights.push(e),this.brakeLightObjects.push(e),e.material&&this.originalBrakeLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16711680,transparent:!0,opacity:.8,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16711680,transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1,1,1),n.visible=!1;const o=new Ma(s);o.scale.set(1,1,1),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.3);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.brakeLightFlares.push([n,o]),console.log(`Brake light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.brakeLights.length&&console.warn("Brake lights (Object_29 / Object_33) not found in chassis model")}activateBrakeLight(){if(this.brakeLights&&!this.isBraking){this.isBraking=!0;const t=new cl({color:16711680,emissive:new Ds(1,0,0).multiplyScalar(.5),emissiveIntensity:10});this.brakeLights.forEach((e=>{e.material=t})),this.brakeLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Brake lights activated (with lens flare)")}}deactivateBrakeLight(){this.brakeLights&&this.isBraking&&(this.isBraking=!1,this.brakeLights.forEach((t=>{const e=this.originalBrakeLightMaterials.get(t);e&&(t.material=e)})),this.brakeLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Brake lights deactivated (original state)"))}updateBrakeLightFlarePositions(){this.brakeLights&&this.brakeLightFlares&&this.brakeLights.forEach(((t,e)=>{if(this.brakeLightFlares[e]){const[i,s]=this.brakeLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(.6,.1,-3.2),o=new pi(-.6,.1,-3.2);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(-.3),r=n.clone().multiplyScalar(-.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustBrakeFlarePosition(t,e,i,s,n){if(this.brakeLightFlares&&this.brakeLightFlares[t]){const o=this.brakeLightFlares[t];if(o[e]){const r=o[e],a=this.brakeLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Brake Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothBrakeFlares(t,e,i){this.adjustBrakeFlarePosition(t,0,e.x,e.y,e.z),this.adjustBrakeFlarePosition(t,1,i.x,i.y,i.z)}setupReverseLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup reverse light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.reverseLights=[],this.originalReverseLightMaterials=new Map,this.reverseLightObjects=[],this.reverseLightFlares=[],this.chassis.traverse((e=>{if("Object_100"===e.name){this.reverseLights.push(e),this.reverseLightObjects.push(e),e.material&&this.originalReverseLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16777215,transparent:!0,opacity:.8,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16777215,transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1,1,1),n.visible=!1;const o=new Ma(s);o.scale.set(1,1,1),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.3);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.reverseLightFlares.push([n,o]),console.log(`Reverse light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.reverseLights.length&&console.warn("Reverse lights not found in chassis model")}activateReverseLight(){if(this.reverseLights&&!this.isReversing){this.isReversing=!0;const t=new cl({color:16777215,emissive:new Ds(1,1,1).multiplyScalar(.5),emissiveIntensity:50});this.reverseLights.forEach((e=>{e.material=t})),this.reverseLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Reverse lights activated (with lens flare)")}}deactivateReverseLight(){this.reverseLights&&this.isReversing&&(this.isReversing=!1,this.reverseLights.forEach((t=>{const e=this.originalReverseLightMaterials.get(t);e&&(t.material=e)})),this.reverseLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Reverse lights deactivated (original state)"))}updateReverseLightFlarePositions(){this.reverseLights&&this.reverseLightFlares&&this.reverseLights.forEach(((t,e)=>{if(this.reverseLightFlares[e]){const[i,s]=this.reverseLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(.35,.1,-3.2),o=new pi(-.35,.1,-3.2);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(-.3),r=n.clone().multiplyScalar(-.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustFlarePosition(t,e,i,s,n){if(this.reverseLightFlares&&this.reverseLightFlares[t]){const o=this.reverseLightFlares[t];if(o[e]){const r=o[e],a=this.reverseLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothFlares(t,e,i){this.adjustFlarePosition(t,0,e.x,e.y,e.z),this.adjustFlarePosition(t,1,i.x,i.y,i.z)}init(t=null){this.health=t,this.loader.show(),this.loadModels(),this.setChassis(),this.setWheels(),this.controls(),this.update(),this.createChassisWireframe()}loadModels(){const t=new Zg(this.loadingManager),e=new Kg(this.loadingManager);e.setDecoderConfig({type:"js"}),e.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/"),t.setDRACOLoader(e),t.load("./car/toyota_supra.glb",(t=>{this.chassis=t.scene,this.chassis.traverse((function(t){t.isMesh&&(t.castShadow=!0,t.recieveShadow=!0)})),this.chassis.scale.set(1,1,1),this.scene.add(this.chassis),this.setupBrakeLight(),this.setupReverseLight(),this.setupFrontLight(),this.setupFrontLightKeyListener(),this.setupAnimations(t),this.loader.updateProgress(1,"Chassis")}),(t=>{console.log("Chassis loading progress:",t.loaded/t.total*100+"%")}),(t=>{console.error("Error loading chassis:",t),this.loader.setTitle("Error loading chassis model"),this.loader.setDetails("Please check the model file path")})),this.wheels=[];for(let e=0;e<4;e++)t.load("./car/supra_wheels.glb",(t=>{const i=t.scene;this.wheels[e]=i,1===e||3===e?this.wheels[e].scale.set(-1.4*this.wheelScale.frontWheel,1.4*this.wheelScale.frontWheel,-1.4*this.wheelScale.frontWheel):this.wheels[e].scale.set(1.4*this.wheelScale.frontWheel,1.4*this.wheelScale.frontWheel,1.4*this.wheelScale.frontWheel),this.scene.add(this.wheels[e]),this.loader.updateProgress(1,`Wheel ${e+1}`)}),(t=>{console.log(`Wheel ${e} loading progress:`,t.loaded/t.total*100+"%")}),(t=>{console.error(`Error loading wheel ${e}:`,t),this.loader.setTitle(`Error loading wheel ${e+1}`),this.loader.setDetails("Please check the wheel model file path")}))}setChassis(){const t=new hu(new Ud(.5*this.chassisDimension.x,.5*this.chassisDimension.y,.5*this.chassisDimension.z)),e=new Op({friction:.3,restitution:.1}),i=new du({mass:this.mass,material:e,type:du.DYNAMIC,collisionFilterGroup:1,collisionFilterMask:1});i.linearDamping=.1,i.angularDamping=.1,i.addShape(t),i.position.set(this.startPosition.x,this.startPosition.y,this.startPosition.z);const s=new Ud(0,-Math.PI/2,0),n=new Kd;n.setFromEuler(s.x,s.y,s.z),i.quaternion.copy(n),this.world.addBody(i),this.car=new Up({chassisBody:i,indexRightAxis:0,indexUpAxis:1,indexForwardAxis:2}),i.userData={type:"car",car:this},this.car.addToWorld(this.world),this.chassisBody=i}setWheels(){this.car.wheelInfos=[];const t=[new Ud(1.25,-.5,-1.9),new Ud(-1.25,-.5,-1.9),new Ud(1.1,-.5,1.95),new Ud(-1.1,-.5,1.95)];for(let e=0;e<4;e++)this.car.addWheel({radius:.45,directionLocal:new Ud(0,-1,0),suspensionStiffness:30,suspensionRestLength:.3,frictionSlip:2.5,dampingRelaxation:2.3,dampingCompression:4.3,maxSuspensionForce:1e5,rollInfluence:.01,axleLocal:new Ud(-1,0,0),chassisConnectionPointLocal:t[e],maxSuspensionTravel:.3,customSlidingRotationalSpeed:30,useCustomSlidingRotationalSpeed:!0})}ensureGroundExists(){if(!this.groundBody){const t=new mm;this.groundBody=new du({mass:0,material:new Op({friction:.4,restitution:.3})}),this.groundBody.addShape(t),this.groundBody.quaternion.setFromAxisAngle(new Ud(1,0,0),-Math.PI/2),this.groundBody.collisionFilterGroup=2,this.groundBody.collisionFilterMask=-1,this.world.addBody(this.groundBody)}}setHealthSystem(t){this.health=t,console.log("Health system attached to car")}controls(){const t=.5,e=[];this.previousPosition=null,this.previousTime=null,this.currentSpeed=0,this.maxReachedSpeed=0,this.speedHistory=[],this.maxHistoryLength=10,this.averageSpeed=0,this.options={unit:"mph",maxSpeed:180},this.needleSmoothing=.1,this.currentNeedleAngle=-135,this.targetNeedleAngle=-135,this.accelerationPhase=0,this.isInGearShift=!1,this.gearShiftTimer=0,this.gearShiftDuration=150,this.lastGearShiftTime=0,this.accelerationStartTime=0,this.wasAcceleratingPreviously=!1,this.accelerationPhases=[{maxForce:2800,duration:600},{maxForce:2600,duration:1200},{maxForce:2400,duration:1800},{maxForce:2200,duration:2400},{maxForce:2e3,duration:1/0}],this.sounds={drifting:null,gearShift:null,brake:null,backfire:null},this.activeSounds=new Set,this.soundStates={drifting:!1,brake:!1},this.backfireSystem={lastBackfireTime:0,backfireChance:.3,backfireCooldown:2e3,highSpeedBackfireChance:.6,highSpeedThreshold:60,gearShiftBackfireChance:.4,engineOffBackfireChance:.7,lastEngineState:!1,wasAcceleratingRecently:!1,recentAccelerationTime:0},this.fadeOutTimer=null,this.fadeOutDuration=300,this.fadeInDuration=150,this.speedThreshold=2,this.lastSoundChangeTime=0,this.soundChangeDelay=50,this.isMoving=!1,this.wasMoving=!1,this.isDriftingNow=!1,this.wasDriftingPreviously=!1,this.driftStartTime=0,this.driftMinDuration=100,this.lastDriftEndTime=0,this.driftCooldown=200,this.speedThresholds={deceleration:{min:0,max:50}},this.initSounds=()=>{this.sounds.drifting=new Audio("./sounds/fer_drift.wav"),this.sounds.gearShift=new Audio("./sounds/fer_gear.mp3"),this.sounds.brake=new Audio("./sounds/fer_brake.mp3"),this.sounds.backfire=new Audio("./sounds/backfire.mp3"),this.sounds.drifting.loop=!0,this.sounds.brake.loop=!1,this.sounds.backfire.loop=!1,this.sounds.drifting.volume=.6,this.sounds.gearShift.volume=.3,this.sounds.brake.volume=1,this.sounds.backfire.volume=.8,Object.keys(this.sounds).forEach((t=>{this.sounds[t]&&this.sounds[t].addEventListener("error",(e=>{console.warn(`Failed to load ${t} sound:`,e)}))}))},this.initSounds(),this.calculateSpeed=()=>{if(!this.car||!this.car.chassisBody)return 0;const t=Date.now(),e=this.car.chassisBody.position;if(!this.previousPosition)return this.previousPosition=e.clone(),this.previousTime=t,0;const i=e.distanceTo(this.previousPosition),s=(t-this.previousTime)/1e3;if(0===s)return this.currentSpeed;const n=i/s;let o;return o="mph"===this.options.unit?2.237*n:3.6*n,this.previousPosition=e.clone(),this.previousTime=t,Math.max(0,o)},this.updateSpeed=()=>{const t=this.calculateSpeed();this.currentSpeed=this.currentSpeed+.1*(t-this.currentSpeed),this.currentSpeed>this.maxReachedSpeed&&(this.maxReachedSpeed=this.currentSpeed,this.onMaxSpeedReached&&this.onMaxSpeedReached(this.maxReachedSpeed)),this.speedHistory.push(this.currentSpeed),this.speedHistory.length>this.maxHistoryLength&&this.speedHistory.shift(),this.averageSpeed=this.speedHistory.reduce(((t,e)=>t+e),0)/this.speedHistory.length;const e=Math.min(this.currentSpeed/this.options.maxSpeed,1);this.targetNeedleAngle=270*e-135,this.currentNeedleAngle=this.currentNeedleAngle+(this.targetNeedleAngle-this.currentNeedleAngle)*this.needleSmoothing,this.updateSpeedometerUI&&this.updateSpeedometerUI(),this.onSpeedChange&&this.onSpeedChange(this.currentSpeed,this.maxReachedSpeed,this.averageSpeed)},this.startSound=(t,e=null,i=!1)=>{if(!this.sounds[t]||!i&&this.soundStates[t])return;const s=this.sounds[t],n=e||this.getOriginalVolume(t);s.fadeInterval&&clearInterval(s.fadeInterval),s.volume=0,s.currentTime=0;const o=s.play();o&&o.catch((e=>console.log(`${t} audio play failed:`,e))),this.soundStates[t]=!0,this.activeSounds.add(t);const r=n/(this.fadeInDuration/20);s.fadeInterval=setInterval((()=>{s.volume=Math.min(n,s.volume+r),s.volume>=n&&(clearInterval(s.fadeInterval),s.fadeInterval=null)}),20)},this.stopSound=(t,e=null,i=!1)=>{if(!this.sounds[t]||!i&&!this.soundStates[t])return void(e&&e());const s=this.sounds[t];if(s.fadeInterval&&clearInterval(s.fadeInterval),s.paused||0===s.volume)return this.soundStates[t]=!1,this.activeSounds.delete(t),void(e&&e());const n=s.volume/(this.fadeOutDuration/20);s.fadeInterval=setInterval((()=>{s.volume=Math.max(0,s.volume-n),s.volume<=0&&(clearInterval(s.fadeInterval),s.fadeInterval=null,s.pause(),s.currentTime=0,s.volume=this.getOriginalVolume(t),this.soundStates[t]=!1,this.activeSounds.delete(t),e&&e())}),20)},this.playGearShiftSound=()=>{if(this.sounds.gearShift){const t=new Audio("./sounds/fer_gear.mp3");t.volume=.3,t.currentTime=0,t.play().catch((t=>console.log("Gear shift sound failed:",t))),this.tryPlayBackfire("gearshift")}},this.tryPlayBackfire=(t="random")=>{const e=Date.now();if(e-this.backfireSystem.lastBackfireTime<this.backfireSystem.backfireCooldown)return;let i=0;switch(t){case"gearshift":i=this.backfireSystem.gearShiftBackfireChance;break;case"engineoff":i=this.backfireSystem.engineOffBackfireChance;break;case"deceleration":i=this.currentSpeed>this.backfireSystem.highSpeedThreshold?this.backfireSystem.highSpeedBackfireChance:this.backfireSystem.backfireChance;break;default:i=this.backfireSystem.backfireChance}Math.random()<i&&(this.playBackfireSound(),this.backfireSystem.lastBackfireTime=e,console.log(`BACKFIRE triggered by: ${t}`))},this.playBackfireSound=()=>{if(this.sounds.backfire){const t=new Audio("./sounds/backfire.mp3");t.volume=.8,t.currentTime=0,t.play().catch((t=>console.log("Backfire sound failed:",t)))}},this.getOriginalVolume=t=>({drifting:.6,gearShift:.3,brake:1,backfire:.8}[t]||.5),this.stopAllSounds=(t=!1)=>{Object.keys(this.sounds).forEach((e=>{if(this.sounds[e]){const i=this.sounds[e];i.fadeInterval&&clearInterval(i.fadeInterval),t?(i.pause(),i.currentTime=0,i.volume=this.getOriginalVolume(e),this.soundStates[e]=!1):this.stopSound(e,null,!0)}})),this.activeSounds.clear()},this.isCarSpeedLow=()=>this.currentSpeed<5,this.updateSound=()=>{const t=Date.now(),i=this.currentSpeed;this.isMoving=i>this.speedThreshold;const s=e.includes("w")||e.includes("arrowup"),n=e.includes("s")||e.includes("arrowdown"),o=e.includes(" "),r=e.includes("a")||e.includes("arrowleft"),a=e.includes("d")||e.includes("arrowright"),h=s||n;if(this.backfireSystem.lastEngineState&&!h&&this.isMoving&&this.tryPlayBackfire("engineoff"),s)this.backfireSystem.wasAcceleratingRecently=!0,this.backfireSystem.recentAccelerationTime=t;else if(this.backfireSystem.wasAcceleratingRecently){const e=t-this.backfireSystem.recentAccelerationTime;e<1e3&&this.isMoving&&i>20?(this.tryPlayBackfire("deceleration"),this.backfireSystem.wasAcceleratingRecently=!1):e>2e3&&(this.backfireSystem.wasAcceleratingRecently=!1)}this.backfireSystem.lastEngineState=h;const l=o&&(r||a)&&s&&this.isMoving,c=o&&!r&&!a&&this.isMoving&&!s;l&&!this.isDriftingNow?t-this.lastDriftEndTime>this.driftCooldown&&(this.isDriftingNow=!0,this.driftStartTime=t,this.stopSound("brake",null,!0),this.startSound("drifting",null,!0),console.log("DRIFT START")):!l&&this.isDriftingNow&&t-this.driftStartTime>this.driftMinDuration&&(this.isDriftingNow=!1,this.lastDriftEndTime=t,this.stopSound("drifting",null,!0),console.log("DRIFT STOP")),!c||this.isDriftingNow||this.soundStates.brake?c&&!this.isDriftingNow||!this.soundStates.brake||(this.stopSound("brake"),console.log("BRAKE STOP")):(this.startSound("brake"),console.log("BRAKE START")),this.soundStates.drifting&&(!o||!this.isMoving||i<3)&&(this.stopSound("drifting",null,!0),this.isDriftingNow=!1,console.log("DRIFT FORCE STOP - Safety check")),this.wasDriftingPreviously=this.isDriftingNow,this.wasMoving=this.isMoving},this.updateAcceleration=()=>{const t=Date.now(),i=e.includes("w")||e.includes("arrowup");if(i&&!this.wasAcceleratingPreviously&&(this.accelerationPhase=0,this.accelerationStartTime=t,this.isInGearShift=!1,this.gearShiftTimer=0),i){const e=t-this.accelerationStartTime;if(!this.isInGearShift&&this.accelerationPhase<4){const t=this.accelerationPhases[this.accelerationPhase];(this.accelerationPhase>0&&e>=t.duration||0===this.accelerationPhase&&e>=100)&&this.startGearShift()}this.isInGearShift&&t-this.lastGearShiftTime>=this.gearShiftDuration&&this.completeGearShift(),this.wasAcceleratingPreviously=!0}else this.accelerationPhase=0,this.isInGearShift=!1,this.wasAcceleratingPreviously=!1},this.startGearShift=()=>{this.isInGearShift=!0,this.lastGearShiftTime=Date.now(),this.playGearShiftSound()},this.completeGearShift=()=>{this.isInGearShift=!1,this.accelerationPhase=Math.min(this.accelerationPhase+1,4),this.accelerationStartTime=Date.now()},this.getCurrentMaxForce=()=>this.isInGearShift?.3*this.accelerationPhases[this.accelerationPhase].maxForce:this.accelerationPhases[this.accelerationPhase].maxForce,window.addEventListener("keydown",(t=>{this.isLoaded&&(e.includes(t.key.toLowerCase())||e.push(t.key.toLowerCase()),i())})),window.addEventListener("keyup",(t=>{this.isLoaded&&(e.splice(e.indexOf(t.key.toLowerCase()),1),i())}));const i=()=>{if(this.controlsDisabled)return;this.updateSpeed(),this.updateAcceleration(),e.includes("f")&&(this.toggleWireframe(),e.splice(e.indexOf("f"),1));const i=e.includes("w")||e.includes("arrowup"),r=e.includes(" "),a=e.includes("a")||e.includes("arrowleft"),h=e.includes("d")||e.includes("arrowright"),l=r&&(a||h)&&i&&this.isMoving;if(l&&!this.isDrifting?this.startDrift():!l&&this.isDrifting&&this.stopDrift(),!r||l){r?l&&this.activateBrakeLight():this.deactivateBrakeLight(),this.car.setBrake(0,0),this.car.setBrake(0,1),this.car.setBrake(0,2),this.car.setBrake(0,3);const i=this.isDrifting?this.driftSteerMultiplier:1;if(a?(this.car.setSteeringValue(t*i,2),this.car.setSteeringValue(t*i,3)):h?(this.car.setSteeringValue(t*-i,2),this.car.setSteeringValue(t*-i,3)):o(),e.includes("w")||e.includes("arrowup")){const t=this.getCurrentMaxForce();this.car.applyEngineForce(-1*t,0),this.car.applyEngineForce(-1*t,1),this.car.applyEngineForce(-1*t,2),this.car.applyEngineForce(-1*t,3)}else e.includes("s")||e.includes("arrowdown")?(l||this.activateReverseLight(),this.car.applyEngineForce(1*this.maxForce,0),this.car.applyEngineForce(1*this.maxForce,1),this.car.applyEngineForce(1*this.maxForce,2),this.car.applyEngineForce(1*this.maxForce,3)):(this.car.applyEngineForce(0,0),this.car.applyEngineForce(0,1),this.car.applyEngineForce(0,2),this.car.applyEngineForce(0,3),this.deactivateReverseLight(),l||n())}else this.activateBrakeLight(),s();this.updateSound()},s=()=>{this.car.setBrake(45,0),this.car.setBrake(45,1),this.car.setBrake(45,2),this.car.setBrake(45,3)},n=()=>{this.car.setBrake(25,0),this.car.setBrake(25,1),this.car.setBrake(25,2),this.car.setBrake(25,3)},o=()=>{this.car.setSteeringValue(0,2),this.car.setSteeringValue(0,3)};this.cleanup=()=>{Object.keys(this.sounds).forEach((t=>{if(this.sounds[t]){const e=this.sounds[t];e.fadeInterval&&clearInterval(e.fadeInterval),e.pause(),e.currentTime=0,e.volume=this.getOriginalVolume(t)}})),this.activeSounds.clear(),Object.keys(this.soundStates).forEach((t=>{this.soundStates[t]=!1})),this.isDriftingNow=!1,this.wasDriftingPreviously=!1,this.driftStartTime=0,this.lastDriftEndTime=0,this.fadeOutTimer&&clearTimeout(this.fadeOutTimer),console.log("CLEANUP COMPLETE - All sounds stopped")}}checkHealthStatus(){if(!this.health)return;const t=this.health.isDestroyed;t&&!this.wasDestroyed?(console.log("Car destroyed! Stopping all sounds and disabling controls."),this.onCarDestroyed()):!t&&this.wasDestroyed&&(console.log("Car repaired! Re-enabling controls."),this.onCarRepaired()),this.wasDestroyed=t}onCarDestroyed(){this.stopAllSounds(),this.controlsDisabled=!0,this.car&&this.car.chassisBody&&(this.car.setBrake(0,0),this.car.setBrake(100,1),this.car.setBrake(500,2),this.car.setBrake(0,3),this.car.applyEngineForce(0,0),this.car.applyEngineForce(0,1),this.car.applyEngineForce(0,2),this.car.applyEngineForce(0,3),this.car.setSteeringValue(0,2),this.car.setSteeringValue(0,3)),this.stopDrift(),this.activateBrakeLight()}onCarRepaired(){this.controlsDisabled=!1,this.car&&(this.car.setBrake(0,0),this.car.setBrake(0,1),this.car.setBrake(0,2),this.car.setBrake(0,3)),this.playSound("idle")}update(){this.world.addEventListener("postStep",(()=>{if(this.updateAnimations(),this.handleFlipDetection(),this.checkHealthStatus(),this.updateReverseLightFlarePositions(),this.updateBrakeLightFlarePositions(),this.updateFrontLightFlarePositions(),this.car.wheelInfos&&this.chassis.position&&this.wheels[0]?.position){this.chassis.position.set(this.car.chassisBody.position.x+this.chassisModelPos.x,this.car.chassisBody.position.y+this.chassisModelPos.y,this.car.chassisBody.position.z+this.chassisModelPos.z),this.chassis.quaternion.copy(this.car.chassisBody.quaternion),this.chassisWireframe&&(this.chassisWireframe.position.copy(this.car.chassisBody.position),this.chassisWireframe.quaternion.copy(this.car.chassisBody.quaternion));for(let t=0;t<4;t++)this.car.wheelInfos[t]&&(this.car.updateWheelTransform(t),this.wheels[t].position.copy(this.car.wheelInfos[t].worldTransform.position),this.wheels[t].quaternion.copy(this.car.wheelInfos[t].worldTransform.quaternion))}}))}toggleWireframe(t=null){this.chassisWireframe&&(this.chassisWireframe.visible=null!==t?t:!this.chassisWireframe.visible,console.log("Chassis wireframe visibility:",this.chassisWireframe.visible))}removeWireframe(){this.chassisWireframe&&(this.scene.remove(this.chassisWireframe),this.chassisWireframe.geometry.dispose(),this.chassisWireframe.material.dispose(),this.chassisWireframe=null,console.log("Chassis wireframe removed"))}forceFlipReset(){console.log("Manual flip reset triggered"),this.autoReset()}getFlipStatus(){return{isFlipped:this.isFlipped,timeUpsideDown:this.timeUpsideDown,resetProgress:this.timeUpsideDown/this.flipResetDelay}}cleanup(){console.log("Starting car cleanup..."),this.stopAllSounds(),this.sounds&&(Object.values(this.sounds).forEach((t=>{t&&(t.pause(),t.currentTime=0,t.src="",t.removeEventListener("ended",t.onended))})),this.sounds={}),this.mixer&&(this.mixer.stopAllAction(),this.mixer.uncacheRoot(this.mixer.getRoot()),this.mixer=null),this.boostAnimation=null,this.car&&this.car.chassisBody&&(this.car.removeFromWorld(this.world),this.world.removeBody(this.car.chassisBody)),this.chassis&&(this.chassis.traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose())})),this.scene.remove(this.chassis),this.chassis=null),this.wheels&&this.wheels.length>0&&(this.wheels.forEach((t=>{t&&(t.traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose())})),this.scene.remove(t))})),this.wheels=[]),this.removeWireframe(),this.brakeLight=null,this.originalBrakeLightMaterial&&(this.originalBrakeLightMaterial.dispose(),this.originalBrakeLightMaterial=null),this.followTarget&&(this.scene.remove(this.followTarget),this.followTarget=null),this.isDrifting=!1,this.isBraking=!1,this.isFlipped=!1,this.controlsDisabled=!1,this.wasDestroyed=!1,this.timeUpsideDown=0,this.lastFlipCheck=0,this.car=null,this.scene=null,this.world=null,this.health=null,this.pivot=null,console.log("Car cleanup completed")}}class dy{followTarget=new us;constructor(t,e,i={x:0,y:0,z:0},s={},n){this.scene=t,this.world=e,this.position=i,this.mesh=null,this.body=null,this.mass=s.mass||1,this.friction=s.friction||.4,this.restitution=s.restitution||.3,this.modelPath=s.modelPath||null,this.scale=s.scale||{x:1,y:1,z:1},this.rotation=s.rotation||{x:0,y:0,z:0},this.shapeType=s.shapeType||"auto",this.customDimensions=s.customDimensions||null,this.showWireframe=s.showWireframe||!1,this.wireframeMesh=null,this.visible=void 0===s.visible||s.visible,this.linearDamping=s.linearDamping||.1,this.angularDamping=s.angularDamping||.1,this.collisionGroup=s.collisionGroup||1,this.collisionMask=s.collisionMask||-1,this.isLoaded=!1,this.isPhysicsReady=!1,n&&n instanceof Il?(this.loadingManager=n,this.useCustomLoader=!1):(this.loadingManager=new Il,this.useCustomLoader=!0,this.loader=new hy(5,"Loading Asset Models..."),this.loader.setOnComplete((()=>{this.isLoaded=!0,console.log("Asset models loaded successfully!")})))}init(){this.useCustomLoader&&this.loader.show(),this.loadModel(),this.update()}loadModel(){const t=new Zg(this.loadingManager),e=new Kg;e.setDecoderConfig({type:"js"}),e.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/"),t.setDRACOLoader(e),this.modelPath?t.load(this.modelPath,(t=>{this.mesh=t.scene,this.setupMesh(),this.createPhysicsBody(),this.isLoaded=!0,this.useCustomLoader&&this.loader.complete()}),(t=>{if(this.useCustomLoader&&t.total>0){const e=t.loaded/t.total*100;console.log(`Loading progress: ${e.toFixed(2)}%`),this.loader.updateProgress(t.loaded/t.total,"Loading Model")}}),(t=>{console.error("Error loading GLB model:",t),this.createFallbackMesh()})):this.createFallbackMesh()}createFallbackMesh(){const t=new gh(2,2,2),e=new fl({color:16777215*Math.random()});this.mesh=new Cn(t,e),this.setupMesh(),this.createPhysicsBody(),this.isLoaded=!0,this.useCustomLoader&&this.loader.complete()}setupMesh(){this.mesh&&(this.mesh.scale.set(this.scale.x,this.scale.y,this.scale.z),this.mesh.rotation.set(this.rotation.x,this.rotation.y,this.rotation.z),this.mesh.position.set(this.position.x,this.position.y,this.position.z),this.mesh.visible=this.visible,this.mesh.traverse((t=>{t.isMesh&&(t.castShadow=!0,t.receiveShadow=!0,t.visible=this.visible,t.userData={type:"asset",asset:this,id:this.generateId()})})),this.scene.add(this.mesh))}createPhysicsBody(){if(!this.mesh)return;const t=this.createCollisionShape(),e=new Op({friction:this.friction,restitution:this.restitution});if(this.body=new du({mass:this.mass,material:e,shape:t,position:new Ud(this.position.x,this.position.y,this.position.z),collisionFilterGroup:this.collisionGroup,collisionFilterMask:this.collisionMask}),0!==this.rotation.x||0!==this.rotation.y||0!==this.rotation.z){const t=new Ud(this.rotation.x,this.rotation.y,this.rotation.z),e=new Kd;e.setFromEuler(t.x,t.y,t.z),this.body.quaternion.copy(e)}this.body.linearDamping=this.linearDamping,this.body.angularDamping=this.angularDamping,this.body.userData={type:"asset",asset:this,id:this.generateId()},this.world.addBody(this.body),this.isPhysicsReady=!0,this.showWireframe&&t instanceof xm&&this.createWireframe(t)}createWireframe(t){if(!(t&&t instanceof xm))return;const e=new cn,i=t.vertices,s=t.indices,n=new Float32Array(3*i.length);for(let t=0;t<i.length;t++)n[3*t]=i[t].x,n[3*t+1]=i[t].y,n[3*t+2]=i[t].z;e.setAttribute("position",new Hs(n,3)),s&&e.setIndex(s);const o=new Os({color:65280,wireframe:!0,transparent:!0,opacity:.7});this.wireframeMesh=new Cn(e,o),this.wireframeMesh.visible=this.visible,this.wireframeMesh.position.copy(this.body.position),this.wireframeMesh.quaternion.copy(this.body.quaternion),this.scene.add(this.wireframeMesh)}createCollisionShape(){return this.customDimensions?this.createCustomShape():"auto"===this.shapeType?this.autoDetectShape():this.createShapeByType()}createCustomShape(){const t=this.customDimensions;switch(this.shapeType){case"box":default:return new hu(new Ud(.5*t.x,.5*t.y,.5*t.z));case"sphere":return new um(t.radius);case"cylinder":return new pm(t.radiusTop,t.radiusBottom,t.height,t.segments||8)}}autoDetectShape(){if(!this.mesh.geometry){const t=(new gi).setFromObject(this.mesh).getSize(new pi);return new hu(new Ud(.5*t.x,.5*t.y,.5*t.z))}const t=this.mesh.geometry;if("BoxGeometry"===t.type){const e=t.parameters;return new hu(new Ud(.5*e.width*this.scale.x,.5*e.height*this.scale.y,.5*e.depth*this.scale.z))}if("SphereGeometry"===t.type){const e=t.parameters;return new um(e.radius*Math.max(this.scale.x,this.scale.y,this.scale.z))}if("CylinderGeometry"===t.type){const e=t.parameters;return new pm(e.radiusTop*this.scale.x,e.radiusBottom*this.scale.x,e.height*this.scale.y,e.radialSegments||8)}return this.createComplexShape()}createShapeByType(){const t=(new gi).setFromObject(this.mesh).getSize(new pi);switch(this.shapeType){case"box":default:return new hu(new Ud(.5*t.x,.5*t.y,.5*t.z));case"sphere":const e=.5*Math.max(t.x,t.y,t.z);return new um(e);case"cylinder":return new pm(.5*t.x,.5*t.x,t.y,8);case"convex":return this.createConvexHull();case"trimesh":return this.createTrimesh()}}createComplexShape(){return 0===this.mass?this.createTrimesh():this.createConvexHull()||this.createBoundingBox()}createConvexHull(){if(!this.mesh.geometry||!this.mesh.geometry.attributes.position)return this.createBoundingBox();try{const t=this.mesh.geometry.attributes.position.array,e=[];for(let i=0;i<t.length;i+=3)e.push(new Ud(t[i]*this.scale.x,t[i+1]*this.scale.y,t[i+2]*this.scale.z));return new su({vertices:e})}catch(t){return console.warn("Failed to create convex hull, using bounding box:",t),this.createBoundingBox()}}createTrimesh(){if(!this.mesh.geometry||!this.mesh.geometry.attributes.position)return this.createBoundingBox();try{const t=this.mesh.geometry,e=t.attributes.position.array,i=t.index?t.index.array:null,s=new Float32Array(e.length);for(let t=0;t<e.length;t+=3)s[t]=e[t]*this.scale.x,s[t+1]=e[t+1]*this.scale.y,s[t+2]=e[t+2]*this.scale.z;return new xm(s,i)}catch(t){return console.warn("Failed to create trimesh, using bounding box:",t),this.createBoundingBox()}}createBoundingBox(){const t=(new gi).setFromObject(this.mesh).getSize(new pi);return new hu(new Ud(.5*t.x,.5*t.y,.5*t.z))}setMass(t){this.mass=t,this.body&&(this.body.mass=t,this.body.updateMassProperties())}setFriction(t){this.friction=t,this.body&&this.body.material&&(this.body.material.friction=t)}setRestitution(t){this.restitution=t,this.body&&this.body.material&&(this.body.material.restitution=t)}setVisible(t){this.visible=t,this.mesh&&(this.mesh.visible=t,this.mesh.traverse((e=>{e.isMesh&&(e.visible=t)}))),this.wireframeMesh&&(this.wireframeMesh.visible=t)}show(){this.setVisible(!0)}hide(){this.setVisible(!1)}toggleVisibility(){this.setVisible(!this.visible)}isVisible(){return this.visible}setShowWireframe(t){this.showWireframe=t,t&&!this.wireframeMesh&&this.body&&this.body.shapes[0]instanceof xm?this.createWireframe(this.body.shapes[0]):!t&&this.wireframeMesh&&(this.scene.remove(this.wireframeMesh),this.wireframeMesh=null)}toggleWireframe(){this.setShowWireframe(!this.showWireframe)}applyForce(t,e=null){if(!this.body)return;const i=new Ud(t.x,t.y,t.z),s=e?new Ud(e.x,e.y,e.z):this.body.position;this.body.applyForce(i,s)}applyImpulse(t,e=null){if(!this.body)return;const i=new Ud(t.x,t.y,t.z),s=e?new Ud(e.x,e.y,e.z):this.body.position;this.body.applyImpulse(i,s)}setPosition(t,e,i){this.position={x:t,y:e,z:i},this.body&&this.body.position.set(t,e,i),this.mesh&&this.mesh.position.set(t,e,i),this.wireframeMesh&&this.wireframeMesh.position.set(t,e,i)}setRotation(t,e,i){if(this.rotation={x:t,y:e,z:i},this.body){const s=new Ud(t,e,i),n=new Kd;n.setFromEuler(s.x,s.y,s.z),this.body.quaternion.copy(n)}this.mesh&&this.mesh.rotation.set(t,e,i),this.wireframeMesh&&this.wireframeMesh.rotation.set(t,e,i)}reset(t=this.position,e=this.rotation){if(this.body&&(this.body.position.set(t.x,t.y,t.z),this.body.angularVelocity.set(0,0,0),this.body.velocity.set(0,0,0),e)){const t=new Ud(e.x,e.y,e.z),i=new Kd;i.setFromEuler(t.x,t.y,t.z),this.body.quaternion.copy(i)}}cleanup(){this.mesh&&(this.scene.remove(this.mesh),this.mesh=null),this.wireframeMesh&&(this.scene.remove(this.wireframeMesh),this.wireframeMesh=null),this.body&&(this.world.removeBody(this.body),this.body=null),this.useCustomLoader&&this.loader&&(this.loader.hide(),this.loader=null),this.isLoaded=!1,this.isPhysicsReady=!1,console.log("Asset Cleaned Up")}generateId(){return"asset_"+Math.random().toString(36).substr(2,9)}update(){this.world&&this.world.addEventListener("postStep",(()=>{this.body&&this.mesh&&this.isLoaded&&this.isPhysicsReady&&(this.mesh.position.copy(this.body.position),this.mesh.quaternion.copy(this.body.quaternion),this.wireframeMesh&&(this.wireframeMesh.position.copy(this.body.position),this.wireframeMesh.quaternion.copy(this.body.quaternion)))}))}onCollision(t){this.body&&this.body.addEventListener("collide",(e=>{const{target:i,body:s,contact:n}=e;t({otherBody:s,contact:n,asset:this})}))}getVelocity(){return this.body?this.body.velocity:new Ud(0,0,0)}getAngularVelocity(){return this.body?this.body.angularVelocity:new Ud(0,0,0)}getPosition(){return this.body?this.body.position:new Ud(0,0,0)}getRotation(){return this.body?this.body.quaternion:new Kd}}class uy{constructor(t,e,i,s,n,o=0,r=null,a=null,h){this.scene=t,this.world=e,this.loadingManager=h,this.path=i,this.startPoint=s,this.endPoint=n,this.carId=o,this.isControlDisabled=!1,this.carVariants={lamborghini_hurracan:{chassisModel:"./car/Lamborghini_Hu.glb",wheelModel:"./car/Lamborghini_Wheel.glb",mass:250,chassisDimension:{x:2.7,y:1,z:7},chassisModelPos:{x:0,y:0,z:0},wheelScale:{frontWheel:1.1,hindWheel:1.1},wheelPositions:[new Ud(1.35,-.5,-2.15),new Ud(-1.35,-.5,-2.15),new Ud(1.32,-.5,1.8),new Ud(-1.32,-.5,1.8)],wheelRadius:.5,maxSpeed:90,maxForce:900},ferrari_spyder:{chassisModel:"./car/Ferrari_Spy.glb",wheelModel:"./car/Ferrari_Spy_Wheel.glb",mass:250,chassisDimension:{x:2.7,y:1,z:7},chassisModelPos:{x:0,y:0,z:0},wheelScale:{frontWheel:1.1,hindWheel:1.1},wheelPositions:[new Ud(1.25,-.5,-2.25),new Ud(-1.25,-.5,-2.25),new Ud(1.2,-.5,1.75),new Ud(-1.2,-.5,1.75)],wheelRadius:.5,maxSpeed:80,maxForce:900},bmw_m4:{chassisModel:"./car/bmw_m4.glb",wheelModel:"./car/bmw_m4_wheel.glb",mass:250,chassisDimension:{x:2.7,y:1,z:7},chassisModelPos:{x:0,y:.1,z:0},wheelScale:{frontWheel:1.1,hindWheel:1.1},wheelPositions:[new Ud(1.15,-.5,-1.9),new Ud(-1.15,-.5,-1.9),new Ud(1.15,-.5,2.2),new Ud(-1.15,-.5,2.2)],wheelRadius:.5,maxSpeed:90,maxForce:700},toyota_supra:{chassisModel:"./car/toyota_supra.glb",wheelModel:"./car/supra_wheels.glb",mass:250,chassisDimension:{x:2.7,y:1,z:7},chassisModelPos:{x:0,y:0,z:0},wheelScale:{frontWheel:1.1,hindWheel:1.1},wheelPositions:[new Ud(1.25,-.5,-1.9),new Ud(-1.25,-.5,-1.9),new Ud(1.1,-.5,1.95),new Ud(-1.1,-.5,1.95)],wheelRadius:.45,maxSpeed:80,maxForce:900},chevrolet_corvette:{chassisModel:"./car/Chevrolet_Corvette.glb",wheelModel:"./car/supra_wheels.glb",mass:250,chassisDimension:{x:2.7,y:1,z:7},chassisModelPos:{x:0,y:0,z:0},wheelScale:{frontWheel:1.1,hindWheel:1.1},wheelPositions:[new Ud(1.27,-.5,-2.08),new Ud(-1.27,-.5,-2.08),new Ud(1.25,-.5,2.05),new Ud(-1.25,-.5,2.05)],wheelRadius:.5,maxSpeed:75,maxForce:850}},this.currentVariant=r||this.getRandomVariant(),this.carConfig=this.carVariants[this.currentVariant],this.mass=this.carConfig.mass,this.chassisDimension=this.carConfig.chassisDimension,this.chassisModelPos=this.carConfig.chassisModelPos,this.wheelScale=this.carConfig.wheelScale,this.wheelPositions=this.carConfig.wheelPositions,this.wheelRadius=this.carConfig.wheelRadius,this.currentPathIndex=0,this.reachedDestination=!1,this.pathTolerance=3,this.destinationTolerance=5,this.maxSpeed=this.carConfig.maxSpeed,this.maxForce=this.carConfig.maxForce,this.maxSteerAngle=.4,this.lookAheadDistance=8,this.currentSteer=0,this.steerSmoothness=.15,this.steerDeadZone=.02,this.obstacleAvoidanceRadius=12,this.avoidanceForce=.6,this.isAvoiding=!1,this.avoidanceTimer=0,this.isReversing=!1,this.reverseTimer=.6,this.reverseDirection=1,this.stuckTimer=0,this.lastPosition=new pi,this.stuckThreshold=.8,this.stuckCheckInterval=60,this.frameCounter=0,this.debugMode=!0,this.car={},this.chassis={},this.wheels=[],this.targetSteer=0,this.targetThrottle=0,this.upsideDownThreshold=.3,this.upsideDownTimer=0,this.upsideDownCheckInterval=30,this.upsideDownResetDelay=1e3,this.isDestroyed=!1,this.updateWorldHandler=null,this.playerCar=a,this.isActivated=!0,this.audio=null,this.audioLoaded=!1,this.audioPlayIntent=!1,this.minDistance=5,this.maxDistance=50,this.baseVolume=1,this.currentVolume=0,this.audioStartTime=.1,this.audioEndOffset=.1,this.collisionDetected=!1,this.collisionTimer=0,this.collisionThreshold=3,this.velocityThreshold=1,this.impactForceThreshold=50,this.lastVelocity=new Ud(0,0,0),this.positionHistory=[],this.historySize=10,this.movementThreshold=.5,this.reverseIntensity=.8,this.reverseDuration=120,this.postReverseDelay=60,this.postReverseTimer=0,this.loader=new hy(5,"Loading Car Models..."),this.isLoaded=!1,this.loader.setOnComplete((()=>{this.isLoaded=!0,console.log("Car models loaded successfully!")})),this.init()}getRandomVariant(){const t=Object.keys(this.carVariants);return t[Math.floor(Math.random()*t.length)]}static getRandomVariantName(){const t=["lamborghini_hurracan","ferrari_spyder","bmw_m4","toyota_supra","chevrolet_corvette"];return t[Math.floor(Math.random()*t.length)]}static getAllVariants(){return["lamborghini_hurracan","ferrari_spyder","bmw_m4","toyota_supra","chevrolet_corvette"]}init(){console.log(`AI Car ${this.carId} initialized with variant: ${this.currentVariant}`),this.loader.show(),this.loadModels(),this.setChassis(),this.setWheels(),this.loadAudio(),this.startAI(),this.debugMode&&(console.log(`AI Car ${this.carId} (${this.currentVariant}) initialized with path:`,this.path),console.log(`Start: (${this.startPoint.x}, ${this.startPoint.y}, ${this.startPoint.z})`),console.log(`End: (${this.endPoint.x}, ${this.endPoint.y}, ${this.endPoint.z})`),console.log(`Mass: ${this.mass}, Max Speed: ${this.maxSpeed}, Max Force: ${this.maxForce}`))}loadModels(){const t=new Zg(this.loadingManager),e=new Kg(this.loadingManager);e.setDecoderConfig({type:"js"}),e.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/"),t.setDRACOLoader(e),t.load(this.carConfig.chassisModel,(t=>{this.chassis=t.scene,this.chassis.traverse((t=>{t.isMesh&&(t.castShadow=!0,t.receiveShadow=!0)})),this.chassis.scale.set(1,1,1),this.scene.add(this.chassis),this.loader.updateProgress(1,"Chassis")}),(t=>{console.log("Chassis loading progress:",t.loaded/t.total*100+"%")}),(t=>{console.error("Error loading chassis:",t),this.loader.setTitle("Error loading chassis model"),this.loader.setDetails("Please check the model file path")}),void 0,(e=>{console.warn(`Failed to load chassis model ${this.carConfig.chassisModel}, falling back to default`),t.load("./car/omni.glb",(t=>{this.chassis=t.scene,this.chassis.traverse((t=>{t.isMesh&&(t.castShadow=!0,t.receiveShadow=!0)})),this.chassis.scale.set(1.5,1.5,1.5),this.scene.add(this.chassis)}))})),this.wheels=[];for(let e=0;e<4;e++)t.load(this.carConfig.wheelModel,(t=>{const i=t.scene;this.wheels[e]=i;const s=0===e||2===e?this.wheelScale.frontWheel:this.wheelScale.hindWheel;1===e||3===e?this.wheels[e].scale.set(-1.5*s,1.5*s,-1.5*s):this.wheels[e].scale.set(1.5*s,1.5*s,1.5*s),this.scene.add(this.wheels[e]),this.loader.updateProgress(1,`Wheel ${e+1}`)}),(t=>{console.log(`Wheel ${e} loading progress:`,t.loaded/t.total*100+"%")}),(t=>{console.error(`Error loading wheel ${e}:`,t),this.loader.setTitle(`Error loading wheel ${e+1}`),this.loader.setDetails("Please check the wheel model file path")}),void 0,(i=>{console.warn(`Failed to load wheel model ${this.carConfig.wheelModel}, falling back to default`),t.load("./car/wheel.gltf",(t=>{const i=t.scene;this.wheels[e]=i;const s=0===e||2===e?this.wheelScale.frontWheel:this.wheelScale.hindWheel;1===e||3===e?this.wheels[e].scale.set(-1.5*s,1.5*s,-1.5*s):this.wheels[e].scale.set(1.5*s,1.5*s,1.5*s),this.scene.add(this.wheels[e])}))}))}setChassis(){const t=new hu(new Ud(.5*this.chassisDimension.x,.5*this.chassisDimension.y,.5*this.chassisDimension.z)),e=new du({mass:this.mass,material:new Op({friction:.3})});e.linearDamping=.15,e.angularDamping=.15,e.addShape(t),e.position.set(this.startPoint.x,this.startPoint.y,this.startPoint.z),this.lastPosition.copy(e.position),this.car=new Up({chassisBody:e,indexRightAxis:0,indexUpAxis:1,indexForwardAxis:2}),e.userData={type:`aicar${this.carId}`,car:this,id:this.carId,variant:this.currentVariant,belongsTo:"aiCar"},this.car.addToWorld(this.world)}setWheels(){this.car.wheelInfos=[];for(let t=0;t<4;t++)this.car.addWheel({radius:this.wheelRadius,directionLocal:new Ud(0,-1,0),suspensionStiffness:80,suspensionRestLength:.15,frictionSlip:25,dampingRelaxation:2.3,dampingCompression:4.3,maxSuspensionForce:1e5,rollInfluence:.01,axleLocal:new Ud(-1,0,0),chassisConnectionPointLocal:this.wheelPositions[t],maxSuspensionTravel:.1,customSlidingRotationalSpeed:30});this.car.wheelInfos.forEach(((t,e)=>{const i=new pm(t.radius,t.radius,t.radius/2,20),s=new du({mass:1,material:new Op({friction:.7})});s.linearDamping=.4,s.angularDamping=.4;const n=(new Kd).setFromEuler(0,Math.PI/2,0);s.addShape(i,new Ud,n)}))}loadAudio(){console.log("Loading AI car engine audio..."),this.audio=new Audio("./sounds/policecar_sound.mp3"),this.audio.loop=!0,this.audio.volume=0,this.audio.preload="auto",this.audio.addEventListener("loadedmetadata",(()=>{this.audioLoaded=!0})),this.audio.addEventListener("canplaythrough",(()=>{this.isActivated&&this.startAudioPlayback()})),this.audio.addEventListener("error",(t=>{}))}setupAudioLoop(){if(!this.audioLoaded)return;const t=this.audio.duration-this.audioEndOffset;this.audio.addEventListener("timeupdate",(()=>{this.audio.currentTime>=t&&this.isActivated&&(this.audio.currentTime=this.audioStartTime)})),console.log(`Audio loop configured: ${this.audioStartTime}s to ${t.toFixed(2)}s`)}updateAudio(){if(!this.audioLoaded||!this.audio||!this.isActivated)return;const t=this.getDistanceToPlayer(),e=this.calculateVolumeFromDistance(t);e>0?(this.startAudioPlayback(),this.smoothVolumeTransition(e)):this.stopAudioPlayback()}getDistanceToPlayer(){if(!(this.playerCar&&this.playerCar.car&&this.playerCar.car.chassisBody&&this.car&&this.car.chassisBody))return this.maxDistance;const t=this.car.chassisBody.position,e=this.playerCar.car.chassisBody.position;return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)+Math.pow(e.z-t.z,2))}calculateVolumeFromDistance(t){if(t<=this.minDistance)return this.baseVolume;if(t>=this.maxDistance)return 0;{const e=(t-this.minDistance)/(this.maxDistance-this.minDistance),i=Math.pow(1-e,2);return this.baseVolume*i}}startAudioPlayback(){if(!this.audio||!this.audio.paused)return;this.audio.currentTime=this.audioStartTime;const t=this.audio.play();void 0!==t&&t.then((()=>{})).catch((t=>{this.audioPlayIntent=!0}))}stopAudioPlayback(){this.audio&&!this.audio.paused&&(this.audio.pause(),this.audio.currentTime=this.audioStartTime)}smoothVolumeTransition(t){if(!this.audio||this.audio.paused)return;const e=this.audio.volume,i=t-e;if(Math.abs(i)>.01){const t=.1*i,s=Math.max(0,Math.min(1,e+t));this.audio.volume=s,this.currentVolume=s}}handleUserInteraction(){this.audioPlayIntent&&this.audioLoaded&&this.isActivated&&(this.startAudio(this.calculateVolumeFromDistance(this.getDistanceToPlayer())),this.audioPlayIntent=!1)}startAI(){this.update(),this.aiLoop()}setPlayerCar(t){this.playerCar=t,console.log(`AI Car ${this.carId} player car reference set`)}activateAudio(){this.isActivated=!0,this.audioLoaded&&this.startAudioPlayback()}deactivateAudio(){this.isActivated=!1,this.stopAudioPlayback()}checkIfUpsideDown(){if(!this.car.chassisBody)return;if(this.frameCounter++,this.frameCounter%this.upsideDownCheckInterval!=0)return;const t=new pi(0,1,0).applyQuaternion(this.car.chassisBody.quaternion);t.y<this.upsideDownThreshold?(this.upsideDownTimer++,this.debugMode&&console.log(`AI Car ${this.carId} (${this.currentVariant}) upside down check: ${this.upsideDownTimer}, up vector Y: ${t.y.toFixed(2)}`),this.upsideDownTimer>=this.upsideDownResetDelay/this.upsideDownCheckInterval&&(this.resetUpsideDownCar(),this.upsideDownTimer=0)):this.upsideDownTimer=0}resetUpsideDownCar(){if(!this.car.chassisBody)return;this.debugMode&&console.log(`AI Car ${this.carId} (${this.currentVariant}) is upside down, resetting position`);const t=this.car.chassisBody.position;this.car.chassisBody.position.set(t.x,t.y+2,t.z),this.car.chassisBody.quaternion.set(0,0,0,1),this.car.chassisBody.angularVelocity.set(0,0,0),this.car.chassisBody.velocity.set(0,0,0),this.targetSteer=0,this.targetThrottle=0,this.currentSteer=0,this.isReversing=!1,this.reverseTimer=0,this.stuckTimer=0}aiLoop(){if(!this.reachedDestination&&!this.isDestroyed){if(this.isControlDisabled)return this.stopCar(),void(this.isDestroyed||requestAnimationFrame((()=>this.aiLoop())));this.checkIfStuckEnhanced(),this.checkIfUpsideDown(),this.handleEnhancedReversing(),this.postReverseTimer<=0&&(this.followPath(),this.avoidObstacles()),this.updateCarMovement(),this.isDestroyed||requestAnimationFrame((()=>this.aiLoop()))}}setRotation(t=0,e=0,i=0){if(!this.car.chassisBody)return;const s=new Kd;s.setFromEuler(t,e,i),this.car.chassisBody.quaternion.copy(s),this.car.chassisBody.angularVelocity.set(0,0,0),this.debugMode&&console.log(`AI Car ${this.carId} (${this.currentVariant}) rotation set to: x=${t}, y=${e}, z=${i}`)}setRotationQuaternion(t){this.car.chassisBody&&(this.car.chassisBody.quaternion.copy(t),this.car.chassisBody.angularVelocity.set(0,0,0),this.debugMode&&console.log(`AI Car ${this.carId} (${this.currentVariant}) rotation set via quaternion`))}rotateBy(t=0,e=0,i=0){if(!this.car.chassisBody)return;const s=this.car.chassisBody.quaternion,n=new Kd;n.setFromEuler(t,e,i);const o=s.mult(n);this.car.chassisBody.quaternion.copy(o),this.car.chassisBody.angularVelocity.set(0,0,0),this.debugMode&&console.log(`AI Car ${this.carId} (${this.currentVariant}) rotated by: x=${t}, y=${e}, z=${i}`)}faceDirection(t,e){if(!this.car.chassisBody)return;const i=this.car.chassisBody.position,s=new pi(t-i.x,0,e-i.z);s.normalize();const n=Math.atan2(s.x,s.z),o=new Kd;o.setFromEuler(0,n,0),this.car.chassisBody.quaternion.copy(o),this.car.chassisBody.angularVelocity.set(0,0,0),this.debugMode&&console.log(`AI Car ${this.carId} (${this.currentVariant}) facing direction: (${t}, ${e})`)}checkIfStuckEnhanced(){if(!this.car.chassisBody)return;this.frameCounter++;const t=this.car.chassisBody.position.clone();if(this.positionHistory.push(t),this.positionHistory.length>this.historySize&&this.positionHistory.shift(),this.frameCounter%30!=0)return;const e=this.car.chassisBody.velocity.length();let i=0;if(this.positionHistory.length>=2)for(let t=1;t<this.positionHistory.length;t++)i+=this.positionHistory[t].distanceTo(this.positionHistory[t-1]);const s=i/Math.max(1,this.positionHistory.length-1),n=e<this.velocityThreshold,o=s<this.movementThreshold,r=Math.abs(this.targetThrottle)>.1,a=this.detectCollisions();n&&o&&r||a?(this.stuckTimer++,this.debugMode&&console.log(`AI Car ${this.carId} stuck/collision check: timer=${this.stuckTimer}, speed=${e.toFixed(2)}, movement=${s.toFixed(2)}, collision=${a}`),(this.stuckTimer>=2||a)&&(this.debugMode&&console.log(`AI Car ${this.carId} triggering reverse maneuver - stuck=${!a}, collision=${a}`),this.startEnhancedReverseManeuver(),this.stuckTimer=0,this.positionHistory=[])):this.stuckTimer=0}startEnhancedReverseManeuver(){this.isReversing=!0,this.reverseTimer=this.reverseDuration;let t=this.calculateBestReverseDirection();this.reverseDirection=t,this.stuckTimer=0,this.collisionTimer=0,this.positionHistory=[],this.debugMode&&console.log(`AI Car ${this.carId} starting enhanced reverse: direction=${this.reverseDirection}, duration=${this.reverseTimer}`)}calculateBestReverseDirection(){if(!this.car.chassisBody)return Math.random()>.5?1:-1;const t=this.car.chassisBody.position;let e=0,i=0;const s=new pi(1,0,0).applyQuaternion(this.car.chassisBody.quaternion),n=(new pi(0,0,-1).applyQuaternion(this.car.chassisBody.quaternion),new Ud(t.x+-8*s.x,t.y,t.z+-8*s.z)),o=new Ud(t.x+8*s.x,t.y,t.z+8*s.z);return this.world.bodies.forEach((s=>{if(s.userData&&s!==this.car.chassisBody&&s.position.distanceTo(t)<12){const t=s.position.distanceTo(n),r=s.position.distanceTo(o);t<8&&e++,r<8&&i++}})),e<i?-1:i<e||Math.random()>.5?1:-1}handleEnhancedReversing(){if(!this.isReversing)return this.postReverseTimer>0?(this.postReverseTimer--,this.targetThrottle=0,void(this.targetSteer=0)):void 0;if(this.reverseTimer--,this.reverseTimer<=0)return this.isReversing=!1,this.postReverseTimer=this.postReverseDelay,this.stuckTimer=0,void(this.debugMode&&console.log(`AI Car ${this.carId} finished reverse maneuver, entering post-reverse delay`));const t=1-this.reverseTimer/this.reverseDuration;this.targetThrottle=t<.5?-this.reverseIntensity:.5*-this.reverseIntensity,this.targetSteer=t<.3?.5*this.reverseDirection:t<.7?.3*this.reverseDirection:.1*this.reverseDirection,this.positionHistory.length>=3&&this.positionHistory[0].distanceTo(this.car.chassisBody.position)>4&&(this.reverseTimer=Math.min(this.reverseTimer,30))}followPath(){if(this.isReversing)return;if(!this.car.chassisBody)return;if(this.car.chassisBody.position,this.getDistanceToPoint(this.endPoint)<this.destinationTolerance)return this.reachedDestination=!0,this.stopCar(),void(this.debugMode&&console.log(`AI Car ${this.carId} (${this.currentVariant}) reached final destination!`));let t=this.endPoint;if(this.path&&this.path.length>0){if(this.currentPathIndex<this.path.length){const t=this.path[this.currentPathIndex],e=this.getDistanceToPoint(t);if(e<this.pathTolerance)this.currentPathIndex++,this.debugMode;else if(this.currentPathIndex<this.path.length-1){const t=this.path[this.currentPathIndex+1],i=this.getDistanceToPoint(t);i<e&&i<1.5*this.pathTolerance&&(this.currentPathIndex++,this.debugMode&&console.log(`AI Car ${this.carId} (${this.currentVariant}) skipped to waypoint ${this.currentPathIndex}/${this.path.length} (overshoot)`))}}if(this.currentPathIndex<this.path.length){t=this.path[this.currentPathIndex];const e=Math.min(this.currentPathIndex+2,this.path.length-1);if(e>this.currentPathIndex){const i=this.path[this.currentPathIndex],s=this.path[e],n=this.getDistanceToPoint(i);if(n<this.lookAheadDistance){let e=Math.max(0,Math.min(1,(this.lookAheadDistance-n)/this.lookAheadDistance));if(this.currentPathIndex>0&&this.currentPathIndex<this.path.length-1){const t=this.path[this.currentPathIndex-1],i=this.path[this.currentPathIndex],s=this.path[this.currentPathIndex+1],n=(new pi).subVectors(i,t).normalize(),o=(new pi).subVectors(s,i).normalize();e*=1-.5*(1-n.dot(o))}t=(new pi).lerpVectors(i,s,e)}}}}this.targetSteer=this.calculateSmoothSteering(t),this.targetThrottle=this.calculateThrottle(this.getDistanceToPoint(t))}calculateSmoothSteering(t){if(!this.car.chassisBody)return 0;const e=this.car.chassisBody.position,i=this.car.chassisBody.quaternion,s=(new pi).subVectors(t,e).normalize(),n=new pi(0,0,1).applyQuaternion(i),o=n.dot(s),r=(new pi).crossVectors(n,s),a=Math.atan2(r.y,o);let h=Math.max(-1,Math.min(1,a/(.3*Math.PI)));Math.abs(h)<this.steerDeadZone&&(h=0);const l=h*this.maxSteerAngle;return this.currentSteer+=(l-this.currentSteer)*this.steerSmoothness,this.currentSteer}detectCollisions(){if(!this.car.chassisBody)return;const t=this.car.chassisBody.position,e=this.car.chassisBody.velocity;let i=!1;if(this.playerCar&&this.playerCar.car&&this.playerCar.car.chassisBody){const s=this.playerCar.car.chassisBody.position,n=t.distanceTo(s);if(n<this.collisionThreshold){const t=this.playerCar.car.chassisBody.velocity,s=(new Ud).copy(t).vsub(e).length();s>this.impactForceThreshold/10&&(i=!0,this.debugMode&&console.log(`AI Car ${this.carId} collision with player! Distance: ${n.toFixed(2)}, Impact: ${s.toFixed(2)}`))}}return this.world.bodies.forEach((s=>{if(s.userData&&s.userData.type&&s.userData.type.startsWith("aicar")&&s.userData.id!==this.carId){const n=s.position,o=t.distanceTo(n);if(o<this.collisionThreshold){const t=s.velocity;(new Ud).copy(t).vsub(e).length()>this.impactForceThreshold/20&&(i=!0,this.debugMode&&console.log(`AI Car ${this.carId} collision with AI car ${s.userData.id}! Distance: ${o.toFixed(2)}`))}}})),this.world.bodies.forEach((e=>{if(e.userData&&("wall"===e.userData.type||"barrier"===e.userData.type||"obstacle"===e.userData.type)){const s=e.position,n=t.distanceTo(s);n<this.collisionThreshold&&(i=!0,this.debugMode&&console.log(`AI Car ${this.carId} collision with obstacle! Distance: ${n.toFixed(2)}`))}})),i}avoidObstacles(){if(!this.car.chassisBody||this.isReversing||this.postReverseTimer>0)return;const t=this.car.chassisBody.position;this.isAvoiding=!1;let e=0,i=this.obstacleAvoidanceRadius;if(this.playerCar&&this.playerCar.car&&this.playerCar.car.chassisBody){const s=this.playerCar.car.chassisBody.position,n=t.distanceTo(s);if(n<1.2*this.obstacleAvoidanceRadius){const o=new pi(0,0,1).applyQuaternion(this.car.chassisBody.quaternion),r=(new pi).subVectors(s,t).normalize();if(o.dot(r)>.1){const t=new pi(1,0,0).applyQuaternion(this.car.chassisBody.quaternion),s=r.dot(t),o=(1.2*this.obstacleAvoidanceRadius-n)/(1.2*this.obstacleAvoidanceRadius);e+=(s>0?-1:1)*this.avoidanceForce*o*1.5,this.isAvoiding=!0,i=Math.min(i,n)}}}this.world.bodies.forEach((s=>{if(s.userData&&s.userData.type&&s.userData.type.startsWith("aicar")&&s.userData.id!==this.carId){const n=s.position,o=t.distanceTo(n);if(o<this.obstacleAvoidanceRadius&&o>.1){const s=new pi(0,0,1).applyQuaternion(this.car.chassisBody.quaternion),r=(new pi).subVectors(n,t).normalize();if(s.dot(r)>.2){const t=new pi(1,0,0).applyQuaternion(this.car.chassisBody.quaternion),s=r.dot(t),n=(this.obstacleAvoidanceRadius-o)/this.obstacleAvoidanceRadius;e+=(s>0?-1:1)*this.avoidanceForce*n,this.isAvoiding=!0,i=Math.min(i,o)}}}})),this.isAvoiding&&(this.targetSteer+=e,this.targetSteer=Math.max(-this.maxSteerAngle,Math.min(this.maxSteerAngle,this.targetSteer)),i<4&&!this.isReversing&&this.postReverseTimer<=0?(this.debugMode&&console.log(`AI Car ${this.carId} very close to obstacle (${i.toFixed(2)}), triggering immediate reverse`),this.startEnhancedReverseManeuver()):this.targetThrottle*=Math.max(.2,i/this.obstacleAvoidanceRadius))}calculateThrottle(t){if(this.isReversing)return this.targetThrottle;const e=this.car.chassisBody.velocity.length();let i=this.maxSpeed;return t<20&&(i=Math.max(10,this.maxSpeed*(t/20))),t<8&&(i=Math.max(5,.5*i)),this.isAvoiding&&(i*=.6),e<i?Math.min(1,(i-e)/15):Math.max(0,(i-e)/20)}updateCarMovement(){if(!this.car.chassisBody||this.reachedDestination)return;this.car.setSteeringValue(this.targetSteer,2),this.car.setSteeringValue(this.targetSteer,3);const t=Math.abs(this.targetThrottle)*this.maxForce,e=this.targetThrottle>=0?-1:1;this.car.applyEngineForce(e*t,0),this.car.applyEngineForce(e*t,1),this.car.applyEngineForce(e*t,2),this.car.applyEngineForce(e*t,3),Math.abs(this.targetThrottle)<.1?(this.car.setBrake(30,0),this.car.setBrake(30,1),this.car.setBrake(30,2),this.car.setBrake(30,3)):(this.car.setBrake(0,0),this.car.setBrake(0,1),this.car.setBrake(0,2),this.car.setBrake(0,3))}stopCar(){this.car.applyEngineForce(0,0),this.car.applyEngineForce(0,1),this.car.applyEngineForce(0,2),this.car.applyEngineForce(0,3),this.car.setBrake(10,0),this.car.setBrake(10,1),this.car.setBrake(10,2),this.car.setBrake(10,3)}getDistanceToPoint(t){return this.car.chassisBody?this.car.chassisBody.position.distanceTo(t):1/0}update(){this.world.addEventListener("postStep",(()=>{if(this.updateAudio(),!this.isDestroyed&&this.car.wheelInfos&&this.chassis.position&&this.wheels[0]?.position){this.chassis.position.set(this.car.chassisBody.position.x+this.chassisModelPos.x,this.car.chassisBody.position.y+this.chassisModelPos.y,this.car.chassisBody.position.z+this.chassisModelPos.z),this.chassis.quaternion.copy(this.car.chassisBody.quaternion);for(let t=0;t<4;t++)this.car.wheelInfos[t]&&this.wheels[t]&&(this.car.updateWheelTransform(t),this.wheels[t].position.copy(this.car.wheelInfos[t].worldTransform.position),this.wheels[t].quaternion.copy(this.car.wheelInfos[t].worldTransform.quaternion))}}))}reset(){this.car.chassisBody&&(this.car.chassisBody.position.set(this.startPoint.x,this.startPoint.y,this.startPoint.z),this.car.chassisBody.quaternion.set(0,0,0,1),this.car.chassisBody.angularVelocity.set(0,0,0),this.car.chassisBody.velocity.set(0,0,0)),this.currentPathIndex=0,this.reachedDestination=!1,this.targetSteer=0,this.targetThrottle=0,this.currentSteer=0,this.isReversing=!1,this.reverseTimer=0,this.stuckTimer=0,this.frameCounter=0,this.upsideDownTimer=0,this.isControlDisabled=!1,this.car.chassisBody&&this.lastPosition.copy(this.car.chassisBody.position)}enableControl(){this.isControlDisabled=!1,this.debugMode&&console.log(`AI Car ${this.carId} (${this.currentVariant}) control enabled`)}disableControl(){this.isControlDisabled=!0,this.stopCar(),this.debugMode&&console.log(`AI Car ${this.carId} (${this.currentVariant}) control disabled`)}playSound(){if(!this.audioLoaded||!this.isActivated)return!1;const t=this.getDistanceToPlayer();if(t>this.maxDistance)return this.pauseSound(),!1;const e=Math.max(0,(this.maxDistance-t)/(this.maxDistance-this.minDistance));this.currentVolume=Math.min(this.baseVolume*e,this.baseVolume);try{if(this.audio){this.audio.currentTime=this.audioStartTime,this.audio.volume=this.currentVolume;const t=this.audio.play();return void 0!==t&&t.then((()=>{console.log("AI Car audio playing")})).catch((t=>{console.warn("Audio play failed:",t)})),this.audioPlayIntent=!0,!0}}catch(t){return console.warn("Error playing AI Car audio:",t),!1}return!1}pauseSound(){try{return this.audio&&!this.audio.paused&&(this.audio.pause(),console.log("AI Car audio paused")),this.audioPlayIntent=!1,this.currentVolume=0,!0}catch(t){return console.warn("Error pausing AI Car audio:",t),!1}}stopSound(){try{return this.audio&&(this.audio.pause(),this.audio.currentTime=this.audioStartTime),this.audioPlayIntent=!1,this.currentVolume=0,console.log("AI Car audio stopped"),!0}catch(t){return console.warn("Error stopping AI Car audio:",t),!1}}updateVolume(){if(!this.audioLoaded)return;const t=this.getDistanceToPlayer();if(t>this.maxDistance)return void this.pauseSound();const e=Math.max(0,(this.maxDistance-t)/(this.maxDistance-this.minDistance));this.currentVolume=Math.min(this.baseVolume*e,this.baseVolume),this.audio&&(this.audio.volume=this.currentVolume)}cleanup(){this.isDestroyed||(console.log(`Cleaning up AI Car ${this.carId}`),this.isDestroyed=!0,this.stopCar(),this.audio&&(this.audio.pause(),this.audio.src="",this.audio=null),this.audioLoaded=!1,this.audioPlayIntent=!1,this.currentVolume=0,this.updateWorldHandler&&(this.world.removeEventListener("postStep",this.updateWorldHandler),this.updateWorldHandler=null),this.chassis&&(this.scene.remove(this.chassis),this.chassis.traverse((t=>{t.isMesh&&(t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose()))})),this.chassis=null),this.wheels.forEach(((t,e)=>{t&&(this.scene.remove(t),t.traverse((t=>{t.isMesh&&(t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose()))})))})),this.wheels=[],this.car&&(this.car.chassisBody&&(this.car.chassisBody.userData=null,this.world.removeBody(this.car.chassisBody)),this.car.wheelInfos&&this.car.wheelInfos.forEach(((t,e)=>{t.body&&this.world.removeBody(t.body)})),this.car.removeFromWorld(this.world),this.car=null),this.scene=null,this.world=null,this.path=null,this.startPoint=null,this.endPoint=null,this.lastPosition=null,console.log(`AI Car ${this.carId} cleanup complete`))}setAudioConfiguration(t={}){this.minDistance=t.minDistance||5,this.maxDistance=t.maxDistance||50,this.baseVolume=t.baseVolume||1,this.audioStartTime=t.startTime||.3,this.audioEndOffset=t.endOffset||.3,console.log(`Audio config updated: Min=${this.minDistance}, Max=${this.maxDistance}, Volume=${this.baseVolume}`)}}class py{constructor(t,e){this.scene=t,this.world=e,this.aiCars=[],this.setupCollisionDetection()}setupCollisionDetection(){this.world.addEventListener("beginContact",(t=>{const{bodyA:e,bodyB:i}=t;if(e.userData&&i.userData){const t="aicar"===e.userData.type?e.userData.car:null,s="aicar"===i.userData.type?i.userData.car:null;t&&"lapBox"!==i.userData.type&&(console.log(`AI Car ${t.carId} collided with ${i.userData.type||"obstacle"}`),this.handleCollision(t)),s&&s!==t&&"lapBox"!==e.userData.type&&(console.log(`AI Car ${s.carId} collided with ${e.userData.type||"obstacle"}`),this.handleCollision(s))}}))}handleCollision(t){t.isReversing||(console.log(`Starting reverse maneuver for AI Car ${t.carId} due to collision`),t.startReverseManeuver())}createAICar(t,e,i){const s=this.aiCars.length,n=new uy(this.scene,this.world,t,e,i,s);return this.aiCars.push(n),n}createStraightPath(t,e,i=8){const s=[];for(let n=1;n<i;n++){const o=n/i,r=(new pi).lerpVectors(t,e,o);s.push(r)}return s}createCurvedPath(t,e,i,s=15){const n=[],o=new tc([t,...i,e]);for(let t=1;t<s;t++){const e=t/s,i=o.getPoint(e);n.push(i)}return n}visualizePath(t,e=16711680){if(!t||0===t.length)return;const i=new Ya((new cn).setFromPoints(t),new Va({color:e}));return this.scene.add(i),i}resetAllCars(){this.aiCars.forEach((t=>t.reset()))}cleanup(){console.log(`Cleaning up ${this.aiCars.length} AI cars`),this.aiCars.forEach(((t,e)=>{t&&"function"==typeof t.cleanup&&t.cleanup()})),this.aiCars=[],console.log("AI Car Manager cleanup complete")}removeAICar(t){const e=this.aiCars.findIndex((e=>e.carId===t));if(-1!==e){const i=this.aiCars[e];i&&"function"==typeof i.cleanup&&i.cleanup(),this.aiCars.splice(e,1),console.log(`Removed AI Car ${t} from manager`)}}removeAICarByReference(t){const e=this.aiCars.indexOf(t);if(-1!==e){const t=this.aiCars[e];t&&"function"==typeof t.cleanup&&t.cleanup(),this.aiCars.splice(e,1),console.log(`Removed AI Car ${t.carId} from manager`)}}}class my{followTarget=new us;constructor(t,e,i={x:0,y:0,z:0},s={}){this.scene=t,this.world=e,this.position=i,this.mesh=null,this.wireframeMesh=null,this.body=null,this.mass=void 0!==s.mass?s.mass:0,this.friction=s.friction||.4,this.restitution=s.restitution||.3,this.modelPath=s.modelPath||null,this.scale=s.scale||{x:1,y:1,z:1},this.rotation=s.rotation||{x:0,y:0,z:0},this.showWireframe=void 0===s.showWireframe||s.showWireframe,this.wireframeColor=s.wireframeColor||65280,this.wireframeOpacity=s.wireframeOpacity||.3,this.shapeType=s.shapeType||"trimesh",this.customDimensions=s.customDimensions||null,this.useConvexHullFallback=void 0===s.useConvexHullFallback||s.useConvexHullFallback,this.simplifyMesh=void 0!==s.simplifyMesh&&s.simplifyMesh,this.simplificationRatio=s.simplificationRatio||.5,this.linearDamping=s.linearDamping||.1,this.angularDamping=s.angularDamping||.1,this.collisionGroup=s.collisionGroup||2,this.collisionMask=s.collisionMask||-1,this.isLoaded=!1,this.isPhysicsReady=!1,this.combinedGeometry=null}init(){this.loadModel(),this.update()}loadModel(){const t=new Zg,e=new Kg;e.setDecoderConfig({type:"js"}),e.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/"),t.setDRACOLoader(e),this.modelPath?t.load(this.modelPath,(t=>{this.mesh=t.scene,this.setupMesh(),this.combineGeometries(),this.createPhysicsBody(),this.createWireframe(),this.isLoaded=!0}),void 0,(t=>{console.error("Error loading GLB model:",t),this.createFallbackMesh()})):this.createFallbackMesh()}createFallbackMesh(){const t=new gh(2,2,2),e=new fl({color:16777215*Math.random()});this.mesh=new Cn(t,e),this.combinedGeometry=t.clone(),this.setupMesh(),this.createPhysicsBody(),this.createWireframe(),this.isLoaded=!0}setupMesh(){this.mesh&&(this.mesh.scale.set(this.scale.x,this.scale.y,this.scale.z),this.mesh.rotation.set(this.rotation.x,this.rotation.y,this.rotation.z),this.mesh.position.set(this.position.x,this.position.y,this.position.z),this.mesh.traverse((t=>{t.isMesh&&(t.castShadow=!0,t.receiveShadow=!0,t.userData={type:"asset",asset:this,id:this.generateId()})})),this.scene.add(this.mesh))}combineGeometries(){if(!this.mesh)return;const t=[],e=new Hi;this.mesh.traverse((i=>{if(i.isMesh&&i.geometry){const s=i.geometry.clone();i.updateMatrixWorld(),e.copy(i.matrixWorld);const n=new Hi;i.parent&&i.parent!==this.mesh&&(n.copy(i.parent.matrixWorld).invert(),e.premultiply(n)),s.applyMatrix4(e),t.push(s)}})),0!==t.length?(1===t.length?this.combinedGeometry=t[0]:(this.combinedGeometry=new cn,this.combinedGeometry=this.mergeBufferGeometries(t)),this.combinedGeometry.attributes.position?(this.combinedGeometry.attributes.normal||this.combinedGeometry.computeVertexNormals(),this.simplifyMesh&&this.simplifyGeometry(),console.log(`Combined geometry: ${this.combinedGeometry.attributes.position.count} vertices`)):console.error("Combined geometry has no position attribute")):console.warn("No geometries found in model")}mergeBufferGeometries(t){const e=new cn;let i=0,s=0;for(const e of t)i+=e.attributes.position.count,e.index?s+=e.index.count:s+=e.attributes.position.count;const n=new Float32Array(3*i),o=s>0?new Uint32Array(s):null;let r=0,a=0,h=0;for(const e of t){const t=e.attributes.position,i=e.index;if(n.set(t.array,3*r),o)if(i){for(let t=0;t<i.count;t++)o[a+t]=i.getX(t)+h;a+=i.count}else{for(let e=0;e<t.count;e++)o[a+e]=h+e;a+=t.count}h+=t.count,r+=t.count}return e.setAttribute("position",new Hs(n,3)),o&&e.setIndex(new Hs(o,1)),e}simplifyGeometry(){if(!this.combinedGeometry||!this.combinedGeometry.attributes.position)return;const t=this.combinedGeometry.attributes.position.array,e=(this.combinedGeometry.index&&this.combinedGeometry.index.array,Math.floor(t.length/3*this.simplificationRatio)),i=Math.max(1,Math.floor(t.length/3/e)),s=[],n=[];for(let e=0;e<t.length;e+=3*i)s.push(t[e],t[e+1],t[e+2]);const o=new cn;o.setAttribute("position",new Zs(s,3));for(let t=0;t<s.length/9;t++){const e=3*t;n.push(e,e+1,e+2)}n.length>0&&o.setIndex(n),this.combinedGeometry=o,console.log(`Simplified geometry to ${s.length/3} vertices`)}createPhysicsBody(){if(!this.mesh)return;const t=this.createTrimeshShape(),e=new Op({friction:this.friction,restitution:this.restitution});if(this.body=new du({mass:this.mass,material:e,shape:t,position:new Ud(this.position.x,this.position.y,this.position.z),collisionFilterGroup:this.collisionGroup,collisionFilterMask:this.collisionMask,type:0===this.mass?du.KINEMATIC:du.DYNAMIC}),0!==this.rotation.x||0!==this.rotation.y||0!==this.rotation.z){const t=new Ud(this.rotation.x,this.rotation.y,this.rotation.z),e=new Kd;e.setFromEuler(t.x,t.y,t.z),this.body.quaternion.copy(e)}this.mass>0&&(this.body.linearDamping=this.linearDamping,this.body.angularDamping=this.angularDamping),this.body.userData={type:"asset",asset:this,id:this.generateId(),isStatic:0===this.mass},this.world.addBody(this.body),this.isPhysicsReady=!0,console.log(`Physics body created: ${this.mass,"STATIC"} trimesh with ${this.body.shapes[0].vertices?this.body.shapes[0].vertices.length/3:"unknown"} vertices`)}createTrimeshShape(){if(!this.combinedGeometry||!this.combinedGeometry.attributes.position)return console.warn("No combined geometry available, creating bounding box fallback"),this.createBoundingBox();try{const t=this.combinedGeometry.attributes.position.array,e=this.combinedGeometry.index?this.combinedGeometry.index.array:null,i=new Float32Array(t.length);for(let e=0;e<t.length;e+=3)i[e]=t[e]*this.scale.x,i[e+1]=t[e+1]*this.scale.y,i[e+2]=t[e+2]*this.scale.z;console.log(`Creating trimesh with ${i.length/3} vertices and ${e?e.length/3:"auto-generated"} triangles`);const s=new xm(i,e);return s.updateTree(),0===this.mass&&s.updateNormals(),s}catch(t){return console.warn("Failed to create trimesh, using fallback:",t),this.useConvexHullFallback?this.createConvexHull():this.createBoundingBox()}}createWireframe(){if(this.showWireframe&&this.combinedGeometry)try{const t=new al(this.combinedGeometry),e=new Va({color:this.wireframeColor,transparent:!0,opacity:this.wireframeOpacity,depthTest:!1,depthWrite:!1});this.wireframeMesh=new Ja(t,e),this.wireframeMesh.scale.copy(this.mesh.scale),this.wireframeMesh.rotation.copy(this.mesh.rotation),this.wireframeMesh.position.copy(this.mesh.position),this.scene.add(this.wireframeMesh),console.log("Wireframe created successfully")}catch(t){console.warn("Failed to create wireframe:",t)}}toggleWireframe(){this.wireframeMesh&&(this.wireframeMesh.visible=!this.wireframeMesh.visible)}setWireframeColor(t){this.wireframeColor=t,this.wireframeMesh&&this.wireframeMesh.material&&this.wireframeMesh.material.color.setHex(t)}setWireframeOpacity(t){this.wireframeOpacity=t,this.wireframeMesh&&this.wireframeMesh.material&&(this.wireframeMesh.material.opacity=t)}createConvexHull(){if(!this.combinedGeometry||!this.combinedGeometry.attributes.position)return this.createBoundingBox();try{const t=this.combinedGeometry.attributes.position.array,e=[],i=256,s=Math.max(1,Math.floor(t.length/3/i));for(let i=0;i<t.length;i+=3*s)e.push(new Ud(t[i]*this.scale.x,t[i+1]*this.scale.y,t[i+2]*this.scale.z));return new su({vertices:e})}catch(t){return console.warn("Failed to create convex hull, using bounding box:",t),this.createBoundingBox()}}createBoundingBox(){const t=(new gi).setFromObject(this.mesh).getSize(new pi);return new hu(new Ud(.5*t.x,.5*t.y,.5*t.z))}setMass(t){this.mass=t,this.body&&(this.body.mass=t,this.body.updateMassProperties())}setFriction(t){this.friction=t,this.body&&this.body.material&&(this.body.material.friction=t)}setRestitution(t){this.restitution=t,this.body&&this.body.material&&(this.body.material.restitution=t)}applyForce(t,e=null){if(!this.body)return;const i=new Ud(t.x,t.y,t.z),s=e?new Ud(e.x,e.y,e.z):this.body.position;this.body.applyForce(i,s)}applyImpulse(t,e=null){if(!this.body)return;const i=new Ud(t.x,t.y,t.z),s=e?new Ud(e.x,e.y,e.z):this.body.position;this.body.applyImpulse(i,s)}setPosition(t,e,i){this.position={x:t,y:e,z:i},this.body&&this.body.position.set(t,e,i),this.mesh&&this.mesh.position.set(t,e,i),this.wireframeMesh&&this.wireframeMesh.position.set(t,e,i)}setRotation(t,e,i){if(this.rotation={x:t,y:e,z:i},this.body){const s=new Ud(t,e,i),n=new Kd;n.setFromEuler(s.x,s.y,s.z),this.body.quaternion.copy(n)}this.mesh&&this.mesh.rotation.set(t,e,i),this.wireframeMesh&&this.wireframeMesh.rotation.set(t,e,i)}reset(t=this.position,e=this.rotation){if(this.body&&(this.body.position.set(t.x,t.y,t.z),this.body.angularVelocity.set(0,0,0),this.body.velocity.set(0,0,0),e)){const t=new Ud(e.x,e.y,e.z),i=new Kd;i.setFromEuler(t.x,t.y,t.z),this.body.quaternion.copy(i)}}cleanup(){this.body&&this.world&&(this.body.removeEventListener("collide"),this.world.listeners&&this.world.listeners.postStep&&this.world.removeEventListener("postStep")),this.body&&this.world&&(this.world.removeBody(this.body),this.body=null),this.mesh&&(this.mesh.traverse((t=>{t.isMesh&&(t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose()))})),this.scene.remove(this.mesh),this.mesh=null),this.wireframeMesh&&(this.wireframeMesh.geometry&&this.wireframeMesh.geometry.dispose(),this.wireframeMesh.material&&this.wireframeMesh.material.dispose(),this.scene.remove(this.wireframeMesh),this.wireframeMesh=null),this.combinedGeometry&&(this.combinedGeometry.dispose(),this.combinedGeometry=null),this.isLoaded=!1,this.isPhysicsReady=!1,this.scene=null,this.world=null,console.log("Roads are cleaned up")}generateId(){return"asset_"+Math.random().toString(36).substr(2,9)}update(){this.world&&this.world.addEventListener("postStep",(()=>{this.body&&this.mesh&&this.isLoaded&&this.isPhysicsReady&&(this.mass>0?(this.mesh.position.copy(this.body.position),this.mesh.quaternion.copy(this.body.quaternion),this.wireframeMesh&&(this.wireframeMesh.position.copy(this.body.position),this.wireframeMesh.quaternion.copy(this.body.quaternion))):(this.body.position.copy(this.mesh.position),this.body.quaternion.copy(this.mesh.quaternion),this.wireframeMesh&&(this.wireframeMesh.position.copy(this.mesh.position),this.wireframeMesh.quaternion.copy(this.mesh.quaternion))))}))}onCollision(t){this.body&&this.body.addEventListener("collide",(e=>{const{target:i,body:s,contact:n}=e;t({otherBody:s,contact:n,asset:this})}))}getVelocity(){return this.body?this.body.velocity:new Ud(0,0,0)}getAngularVelocity(){return this.body?this.body.angularVelocity:new Ud(0,0,0)}getPosition(){return this.body?this.body.position:new Ud(0,0,0)}getRotation(){return this.body?this.body.quaternion:new Kd}getDebugInfo(){return{isLoaded:this.isLoaded,isPhysicsReady:this.isPhysicsReady,isStatic:0===this.mass,hasWireframe:!!this.wireframeMesh,vertexCount:this.combinedGeometry?this.combinedGeometry.attributes.position.count:0,shapeType:"trimesh",mass:this.mass,position:this.getPosition(),velocity:this.mass>0?this.getVelocity():"N/A (static)",collisionGroup:this.collisionGroup,collisionMask:this.collisionMask}}makeStatic(){this.setMass(0),this.body&&(this.body.type=du.KINEMATIC,this.body.userData.isStatic=!0)}makeDynamic(t=1){this.setMass(t),this.body&&(this.body.type=du.DYNAMIC,this.body.userData.isStatic=!1)}onCollisionWithDynamic(t){this.body&&this.body.addEventListener("collide",(e=>{const{target:i,body:s,contact:n}=e;s.mass>0&&t({otherBody:s,contact:n,asset:this,staticObject:this,dynamicObject:s.userData?.asset||s})}))}}var fy=function(t){Gl.call(this,t),this.type=pt};fy.prototype=Object.assign(Object.create(Gl.prototype),{constructor:fy,parse:function(t){var e=function(t,e){switch(t){case 1:console.error("THREE.RGBELoader Read Error: "+(e||""));break;case 2:console.error("THREE.RGBELoader Write Error: "+(e||""));break;case 3:console.error("THREE.RGBELoader Bad File Format: "+(e||""));break;default:console.error("THREE.RGBELoader: Error: "+(e||""))}return-1},i=function(t,e,i){e=e||1024;for(var s=t.pos,n=-1,o=0,r="",a=String.fromCharCode.apply(null,new Uint16Array(t.subarray(s,s+128)));0>(n=a.indexOf("\n"))&&o<e&&s<t.byteLength;)r+=a,o+=a.length,s+=128,a+=String.fromCharCode.apply(null,new Uint16Array(t.subarray(s,s+128)));return-1<n&&(!1!==i&&(t.pos+=o+n+1),r+a.slice(0,n))},s=function(t,e,i,s){var n=t[e+3],o=Math.pow(2,n-128)/255;i[s+0]=Pd.toHalfFloat(t[e+0]*o),i[s+1]=Pd.toHalfFloat(t[e+1]*o),i[s+2]=Pd.toHalfFloat(t[e+2]*o)},n=new Uint8Array(t);n.pos=0;var o,r,a,h,l,c,d=function(t){var s,n,o=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,r=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,a=/^\s*FORMAT=(\S+)\s*$/,h=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,l={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};if(t.pos>=t.byteLength||!(s=i(t)))return e(1,"no header found");if(!(n=s.match(/^#\?(\S+)/)))return e(3,"bad initial token");for(l.valid|=1,l.programtype=n[1],l.string+=s+"\n";!1!==(s=i(t));)if(l.string+=s+"\n","#"!==s.charAt(0)){if((n=s.match(o))&&(l.gamma=parseFloat(n[1],10)),(n=s.match(r))&&(l.exposure=parseFloat(n[1],10)),(n=s.match(a))&&(l.valid|=2,l.format=n[1]),(n=s.match(h))&&(l.valid|=4,l.height=parseInt(n[1],10),l.width=parseInt(n[2],10)),2&l.valid&&4&l.valid)break}else l.comments+=s+"\n";return 2&l.valid?4&l.valid?l:e(3,"missing image size specifier"):e(3,"missing format specifier")}(n);if(-1!==d){var u=d.width,p=d.height,m=function(t,i,s){var n,o,r,a,h,l,c,d,u,p,m,f,g,y=i,v=s;if(y<8||y>32767||2!==t[0]||2!==t[1]||128&t[2])return new Uint8Array(t);if(y!==(t[2]<<8|t[3]))return e(3,"wrong scanline width");if(!(n=new Uint8Array(4*i*s)).length)return e(4,"unable to allocate buffer space");for(o=0,r=0,d=4*y,g=new Uint8Array(4),l=new Uint8Array(d);v>0&&r<t.byteLength;){if(r+4>t.byteLength)return e(1);if(g[0]=t[r++],g[1]=t[r++],g[2]=t[r++],g[3]=t[r++],2!=g[0]||2!=g[1]||(g[2]<<8|g[3])!=y)return e(3,"bad rgbe scanline format");for(c=0;c<d&&r<t.byteLength;){if((f=(a=t[r++])>128)&&(a-=128),0===a||c+a>d)return e(3,"bad scanline data");if(f)for(h=t[r++],u=0;u<a;u++)l[c++]=h;else l.set(t.subarray(r,r+a),c),c+=a,r+=a}for(p=y,u=0;u<p;u++)m=0,n[o]=l[u+m],m+=y,n[o+1]=l[u+m],m+=y,n[o+2]=l[u+m],m+=y,n[o+3]=l[u+m],o+=4;v--}return n}(n.subarray(n.pos),u,p);if(-1!==m){switch(this.type){case pt:var f=m,g=Pt,y=pt;break;case wt:for(var v=m.length/4*3,w=new Float32Array(v),x=0;x<v;x++)a=w,h=3*x,void 0,void 0,l=(o=m)[3+(r=4*x)],c=Math.pow(2,l-128)/255,a[h+0]=o[r+0]*c,a[h+1]=o[r+1]*c,a[h+2]=o[r+2]*c;f=w,g=Et,y=wt;break;case xt:v=m.length/4*3;var b=new Uint16Array(v);for(x=0;x<v;x++)s(m,4*x,b,3*x);f=b,g=Et,y=xt;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:u,height:p,data:f,header:d.string,gamma:d.gamma,exposure:d.exposure,format:g,type:y}}}return null},setDataType:function(t){return this.type=t,this},load:function(t,e,i,s){return Gl.prototype.load.call(this,t,(function(t,i){switch(t.type){case pt:t.encoding=Oe,t.minFilter=at,t.magFilter=at,t.generateMipmaps=!1,t.flipY=!0;break;case wt:case xt:t.encoding=Ie,t.minFilter=ct,t.magFilter=ct,t.generateMipmaps=!1,t.flipY=!0}e&&e(t,i)}),i,s)}});class gy extends Cn{constructor(t,e,i=1){super(new nl(2e3),new Os({fog:!1,side:d,color:8900331})),this.renderer=t,this.hdrPath=e,this.exposure=i,this.setupToneMapping(),this.loadHDRTexture()}setupToneMapping(){this.renderer.toneMapping=Z,this.renderer.toneMappingExposure=this.exposure,this.renderer.outputColorSpace=e.SRGBColorSpace}loadHDRTexture(){if(!this.hdrPath)return console.warn("No HDR path provided, using default gradient"),void this.createGradientTexture();(new fy).load(this.hdrPath,(t=>{t.mapping=tt,t.colorSpace=e.LinearSRGBColorSpace,t.anisotropy=this.renderer.capabilities.getMaxAnisotropy(),this.material.map=t,this.material.color.setHex(16777215),this.material.needsUpdate=!0,console.log("HDR texture loaded successfully")}),(t=>{console.log("HDR loading progress:",t.loaded/t.total*100+"%")}),(t=>{console.error("Error loading HDR texture:",t),console.log("Falling back to gradient texture"),this.createGradientTexture()}))}createGradientTexture(){let t=document.createElement("canvas");t.width=1,t.height=1024;let e=t.getContext("2d"),i=e.createLinearGradient(0,t.height,0,0);i.addColorStop(.5,"white"),i.addColorStop(.65,"#00bfff"),i.addColorStop(.9,"#007fff"),e.fillStyle=i,e.fillRect(0,0,t.width,t.height);let s=new lh(t);s.colorSpace="srgb",s.anisotropy=this.renderer.capabilities.getMaxAnisotropy(),this.material.map=s,this.material.color.setHex(16777215),this.material.needsUpdate=!0}updateHDRTexture(t){this.hdrPath=t,this.loadHDRTexture()}setExposure(t){this.exposure=t,this.renderer.toneMappingExposure=t}getExposure(){return this.exposure}}class yy{constructor(t,e,i,s,n,o){this.position=new pi(t,e,i),this.velocity=new pi(2*(Math.random()-.5),2*Math.random()+1,1*(Math.random()-.5)),this.age=0,this.lifetime=s,this.startScale=.3*Math.random()+.15,this.finalScale=this.startScale+.6*Math.random()+.4,this.sprite=new Ma(o.clone()),this.sprite.position.copy(this.position),this.sprite.scale.setScalar(this.startScale),n.add(this.sprite)}update(t){this.position.add(this.velocity.clone().multiplyScalar(.001*t)),this.age+=t;const e=this.age/this.lifetime;this.velocity.multiplyScalar(Math.pow(.95,.06*t));const i=this.startScale+e*(this.finalScale-this.startScale),s=e<.2?3.5*e:.875*(1-e);this.sprite.position.copy(this.position),this.sprite.scale.setScalar(i),this.sprite.material.opacity=Math.max(0,s)}isAlive(){return this.age<this.lifetime}destroy(t){t.remove(this.sprite),this.sprite.material.dispose()}}class vy{constructor(t,e=25){this.scene=t,this.maxPoints=e,this.points=[],this.mesh=null,this.isActive=!1,this.fadeStart=0,this.duration=800,this.width=.12,this.material=new Os({color:3355443,transparent:!0,opacity:.6,side:u,depthWrite:!1}),this.geometry=new tl(1,1),this.mesh=new Cn(this.geometry,this.material),this.scene.add(this.mesh),this.mesh.visible=!1}addPoint(t){this.isActive&&(this.points.push({position:t.clone(),time:Date.now()}),this.points.length>this.maxPoints&&this.points.shift(),this.updateGeometry())}updateGeometry(){const t=Date.now();if(this.points=this.points.filter((e=>t-e.time<this.duration)),this.points.length<2)return void(this.mesh.visible=!1);const e=new tc(this.points.map((t=>t.position))),i=new rl(e,this.points.length,this.width,6,!1);this.mesh.geometry.dispose(),this.mesh.geometry=i,this.mesh.visible=!0}start(){this.isActive=!0,this.material.opacity=.6}stop(){this.isActive=!1,this.fadeStart=Date.now()}update(){if(!this.isActive){const t=(Date.now()-this.fadeStart)/500;this.material.opacity=.6*Math.max(0,1-t),t>=1&&(this.points=[],this.mesh.visible=!1)}this.updateGeometry()}destroy(){this.mesh&&(this.scene.remove(this.mesh),this.mesh.geometry.dispose(),this.material.dispose())}setWidth(t){this.width=t}}class wy{constructor(t,e,i,s={x:0,y:0,z:0}){this.scene=t,this.world=e,this.vehicle=i,this.offset=s,this.particles=[],this.isActive=!1,this.lastEmission=0,this.emissionRate=60,this.particlesPerEmission=2,this.smokeMaterial=null,this.vehicleType=this.detectVehicleType(),this.smokeAnimationDuration=1200,this.trailAnimationDuration=600,this.animationCooldown=!1,this.wKeyPressed=!1,this.spaceKeyPressed=!1,this.leftWheelTrail=new vy(this.scene,20),this.rightWheelTrail=new vy(this.scene,20),this.eventListenersAdded=!1,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this)}detectVehicleType(){return this.vehicle?.truck&&this.vehicle?.trailer?"truck-trailer":this.vehicle?.car?"car":"unknown"}init(){this.createSmokeTexture(),this.setupControls(),this.update()}createSmokeTexture(){const t=document.createElement("canvas");t.width=32,t.height=32;const e=t.getContext("2d"),i=e.createRadialGradient(16,16,0,16,16,16);i.addColorStop(0,"rgba(70, 70, 70, 1)"),i.addColorStop(.4,"rgba(110, 110, 110, 0.7)"),i.addColorStop(.8,"rgba(180, 180, 180, 0.3)"),i.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=i,e.fillRect(0,0,32,32);const s=new lh(t);s.needsUpdate=!0,this.smokeMaterial=new la({map:s,transparent:!0,opacity:.6,color:new Ds(.5,.5,.5),blending:m,depthWrite:!1})}setupControls(){this.eventListenersAdded||(window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp),this.eventListenersAdded=!0)}handleKeyDown(t){const e=t.key.toLowerCase();"w"!==e&&"arrowup"!==e||this.wKeyPressed||this.animationCooldown||(this.startAnimation(),this.wKeyPressed=!0)," "!==e||this.spaceKeyPressed||this.animationCooldown||(this.startAnimation(),this.spaceKeyPressed=!0)}handleKeyUp(t){const e=t.key.toLowerCase();"w"!==e&&"arrowup"!==e||(this.wKeyPressed=!1,this.animationCooldown=!1)," "===e&&(this.spaceKeyPressed=!1,this.animationCooldown=!1)}startAnimation(){this.isActive=!0,setTimeout((()=>this.isActive=!1),this.smokeAnimationDuration),this.leftWheelTrail.start(),this.rightWheelTrail.start(),setTimeout((()=>{this.leftWheelTrail.stop(),this.rightWheelTrail.stop()}),this.trailAnimationDuration),this.animationCooldown=!0,setTimeout((()=>this.animationCooldown=!1),this.trailAnimationDuration)}getVehiclePosition(){if(!this.vehicle)return new pi;try{if("truck-trailer"===this.vehicleType&&this.vehicle.truck?.chassisBody){const t=this.vehicle.truck.chassisBody.position;return new pi(t.x,t.y,t.z)}if("car"===this.vehicleType&&this.vehicle.car?.chassisBody){const t=this.vehicle.car.chassisBody.position;return new pi(t.x,t.y,t.z)}if(this.vehicle.position)return this.vehicle.position.clone()}catch(t){console.warn("Error getting vehicle position:",t)}return new pi}getVehicleRotation(){if(!this.vehicle)return new ui;try{if("truck-trailer"===this.vehicleType&&this.vehicle.truck?.chassisBody){const t=this.vehicle.truck.chassisBody.quaternion;return new ui(t.x,t.y,t.z,t.w)}if("car"===this.vehicleType&&this.vehicle.car?.chassisBody){const t=this.vehicle.car.chassisBody.quaternion;return new ui(t.x,t.y,t.z,t.w)}if(this.vehicle.quaternion)return this.vehicle.quaternion.clone()}catch(t){console.warn("Error getting vehicle rotation:",t)}return new ui}getRearWheelPositions(){const t=this.getVehiclePosition(),e=this.getVehicleRotation(),i=new pi(-.65,0,-2),s=new pi(.65,0,-2);return i.applyQuaternion(e),s.applyQuaternion(e),{left:t.clone().add(i),right:t.clone().add(s)}}addSmoke(){const t=Date.now();if(!this.isActive||t-this.lastEmission<this.emissionRate)return;this.lastEmission=t;const e=this.getVehiclePosition(),i=this.getVehicleRotation(),s=new pi(this.offset.x,this.offset.y,this.offset.z);s.applyQuaternion(i);const n=e.clone().add(s);for(let t=0;t<this.particlesPerEmission;t++){const t=1e3+500*Math.random(),e=new yy(n.x+.2*(Math.random()-.5),n.y+.1*Math.random(),n.z+.2*(Math.random()-.5),t,this.scene,this.smokeMaterial),s=new pi(0,0,1);s.applyQuaternion(i),e.velocity.add(s.multiplyScalar(.6)),this.particles.push(e)}}update(){const t=()=>{if(this.addSmoke(),this.particles=this.particles.filter((t=>(t.update(16),!!t.isAlive()||(t.destroy(this.scene),!1)))),this.leftWheelTrail.isActive||this.rightWheelTrail.isActive){const t=this.getRearWheelPositions();if(this.leftWheelTrail.isActive){const e=t.left.clone();e.y=.08,this.leftWheelTrail.addPoint(e)}if(this.rightWheelTrail.isActive){const e=t.right.clone();e.y=.08,this.rightWheelTrail.addPoint(e)}}this.leftWheelTrail.update(),this.rightWheelTrail.update()};if(this.world?.addEventListener)this.world.addEventListener("postStep",t);else{const e=()=>{t(),requestAnimationFrame(e)};e()}}start(){this.isActive=!0}stop(){this.isActive=!1}destroy(){this.eventListenersAdded&&(window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp),this.eventListenersAdded=!1),this.particles.forEach((t=>t.destroy(this.scene))),this.particles=[],this.smokeMaterial&&this.smokeMaterial.dispose(),this.leftWheelTrail.destroy(),this.rightWheelTrail.destroy()}setEmissionRate(t){this.emissionRate=t}setParticlesPerEmission(t){this.particlesPerEmission=t}setOffset(t){this.offset=t}setTrailWidth(t){this.leftWheelTrail.setWidth(t),this.rightWheelTrail.setWidth(t)}}class xy{constructor(t,e,i,s,n,o,r="fire",a=1){this.position=new pi(t,e,i),this.type=r,this.sizeMultiplier=a,this.velocity="fire"===r?new pi(4*(Math.random()-.5)*a,3*Math.random()+2,2*(Math.random()-.5)*a):"spark"===r?new pi(8*(Math.random()-.5)*a,4*Math.random()+1,6*(Math.random()-.5)*a):new pi(3*(Math.random()-.5)*a,2*Math.random()+1.5,2*(Math.random()-.5)*a),this.startVelocity=this.velocity.clone(),this.age=0,this.lifetime=s,"fire"===r?(this.startScale=(.6*Math.random()+.3)*a,this.finalScale=this.startScale+(.4*Math.random()+.2)*a):"spark"===r?(this.startScale=(.3*Math.random()+.1)*a,this.finalScale=.5*this.startScale):(this.startScale=(.5*Math.random()+.2)*a,this.finalScale=this.startScale+(.8*Math.random()+.4)*a),this.currentScale=this.startScale,this.sprite=new Ma(o.clone()),this.sprite.position.copy(this.position),this.sprite.scale.setScalar(this.currentScale),n.add(this.sprite)}update(t){this.position.add(this.velocity.clone().multiplyScalar(.001*t)),this.age+=t;const e=this.age/this.lifetime;if("fire"===this.type){const e=Math.pow(.92,.06*t);this.velocity.multiplyScalar(e),this.velocity.y+=.002*t}else if("spark"===this.type){this.velocity.y-=.008*t;const e=Math.pow(.98,.06*t);this.velocity.multiplyScalar(e)}else{const e=Math.pow(.95,.06*t);this.velocity.multiplyScalar(e)}let i;this.currentScale=this.startScale+e*(this.finalScale-this.startScale),"fire"===this.type?(i=e<.1?e/.1:(1-e)/.9,i=Math.max(0,.9*i)):i="spark"===this.type?Math.max(0,.8*(1-e)):e<.2?e/.2*.6:(1-e)/.8*.6,this.sprite.position.copy(this.position),this.sprite.scale.setScalar(this.currentScale),this.sprite.material.opacity=Math.max(0,i)}isAlive(){return this.age<this.lifetime}destroy(t){t.remove(this.sprite),this.sprite.material.dispose()}}class by{constructor(t,e,i,s,n={x:0,y:0,z:0}){this.scene=t,this.world=e,this.vehicle=i,this.car=s,this.offset=n,this.size=1,this.particles=[],this.isActive=!1,this.lastEmissionTime=0,this.emissionRate=10,this.particlesPerEmission=4,this.duration=500,this.wasDrifting=!1,this.activationStartTime=0,this.canActivate=!0,this.fireMaterial=null,this.sparkMaterial=null,this.smokeMaterial=null,this.vehicleType=this.detectVehicleType(),this.audioContext=null,this.nitroSound=null,this.nitroTimeout=null}detectVehicleType(){return this.vehicle&&this.vehicle.truck&&this.vehicle.trailer?"truck-trailer":this.vehicle&&this.vehicle.car?"car":"unknown"}init(){this.createFireTexture(),this.createSparkTexture(),this.createSmokeTexture(),this.update()}createFireTexture(){const t=document.createElement("canvas");t.width=64,t.height=64;const e=t.getContext("2d"),i=e.createRadialGradient(32,32,0,32,32,32);i.addColorStop(0,"rgba(255, 255, 255, 1)"),i.addColorStop(.2,"rgba(255, 255, 0, 0.9)"),i.addColorStop(.4,"rgba(255, 150, 0, 0.8)"),i.addColorStop(.6,"rgba(255, 50, 0, 0.6)"),i.addColorStop(.8,"rgba(150, 0, 0, 0.3)"),i.addColorStop(1,"rgba(0, 0, 0, 0)"),e.fillStyle=i,e.fillRect(0,0,64,64);const s=new lh(t);s.needsUpdate=!0,this.fireMaterial=new la({map:s,transparent:!0,opacity:.9,color:new Ds(1,.8,.6),blending:f,depthWrite:!1})}createSparkTexture(){const t=document.createElement("canvas");t.width=32,t.height=32;const e=t.getContext("2d"),i=e.createRadialGradient(16,16,0,16,16,16);i.addColorStop(0,"rgba(255, 255, 255, 1)"),i.addColorStop(.3,"rgba(255, 255, 0, 0.8)"),i.addColorStop(.6,"rgba(255, 100, 0, 0.4)"),i.addColorStop(1,"rgba(255, 0, 0, 0)"),e.fillStyle=i,e.fillRect(0,0,32,32);const s=new lh(t);s.needsUpdate=!0,this.sparkMaterial=new la({map:s,transparent:!0,opacity:.8,color:new Ds(1,.9,.7),blending:f,depthWrite:!1})}createSmokeTexture(){const t=document.createElement("canvas");t.width=64,t.height=64;const e=t.getContext("2d"),i=e.createRadialGradient(32,32,0,32,32,32);i.addColorStop(0,"rgba(50, 50, 50, 1)"),i.addColorStop(.3,"rgba(80, 80, 80, 0.8)"),i.addColorStop(.6,"rgba(120, 120, 120, 0.4)"),i.addColorStop(.8,"rgba(160, 160, 160, 0.2)"),i.addColorStop(1,"rgba(200, 200, 200, 0)"),e.fillStyle=i,e.fillRect(0,0,64,64);const s=new lh(t);s.needsUpdate=!0,this.smokeMaterial=new la({map:s,transparent:!0,opacity:.6,color:new Ds(.4,.4,.4),blending:m,depthWrite:!1})}activateNitro(){this.isActive||(this.isActive=!0,this.activationStartTime=Date.now(),this.lastEmissionTime=0,this.canActivate=!1,console.log("Nitro activated for 5 seconds!"),this.nitroTimeout&&clearTimeout(this.nitroTimeout),this.nitroTimeout=setTimeout((()=>{this.deactivateNitro()}),this.duration))}deactivateNitro(){this.isActive&&(this.isActive=!1,this.nitroTimeout&&(clearTimeout(this.nitroTimeout),this.nitroTimeout=null),this.canActivate=!0,console.log("Nitro deactivated!"))}checkDriftState(){if(this.car&&void 0!==this.car.isDrifting){const t=this.car.isDrifting;t&&!this.wasDrifting&&this.canActivate&&!this.isActive&&this.activateNitro(),this.wasDrifting=t}}getVehiclePosition(){if(!this.vehicle)return new pi(0,0,0);try{switch(this.vehicleType){case"truck-trailer":if(this.vehicle.truck&&this.vehicle.truck.chassisBody){const t=this.vehicle.truck.chassisBody.position;return new pi(t.x,t.y,t.z)}if(this.vehicle.truckChassis&&this.vehicle.truckChassis.position)return this.vehicle.truckChassis.position.clone();break;case"car":if(this.vehicle.car&&this.vehicle.car.chassisBody){const t=this.vehicle.car.chassisBody.position;return new pi(t.x,t.y,t.z)}if(this.vehicle.chassis&&this.vehicle.chassis.position)return this.vehicle.chassis.position.clone();break;default:if(this.vehicle.position)return this.vehicle.position.clone()}}catch(t){console.warn("Error getting vehicle position:",t)}return new pi(0,0,0)}getVehicleRotation(){if(!this.vehicle)return new ui;try{switch(this.vehicleType){case"truck-trailer":if(this.vehicle.truck&&this.vehicle.truck.chassisBody){const t=this.vehicle.truck.chassisBody.quaternion;return new ui(t.x,t.y,t.z,t.w)}if(this.vehicle.truckChassis&&this.vehicle.truckChassis.quaternion)return this.vehicle.truckChassis.quaternion.clone();break;case"car":if(this.vehicle.car&&this.vehicle.car.chassisBody){const t=this.vehicle.car.chassisBody.quaternion;return new ui(t.x,t.y,t.z,t.w)}if(this.vehicle.chassis&&this.vehicle.chassis.quaternion)return this.vehicle.chassis.quaternion.clone();break;default:if(this.vehicle.quaternion)return this.vehicle.quaternion.clone()}}catch(t){console.warn("Error getting vehicle rotation:",t)}return new ui}addNitroEffect(){if(!this.isActive)return;const t=Date.now();if(t-this.lastEmissionTime<this.emissionRate)return;this.lastEmissionTime=t;const e=this.getVehiclePosition(),i=this.getVehicleRotation();[{x:(this.offset.x-.5)*this.size,y:this.offset.y*this.size,z:this.offset.z*this.size},{x:(this.offset.x+.5)*this.size,y:this.offset.y*this.size,z:this.offset.z*this.size},{x:this.offset.x*this.size,y:(this.offset.y-.2)*this.size,z:this.offset.z*this.size}].forEach((t=>{const s=new pi(t.x,t.y,t.z);s.applyQuaternion(i);const n=new pi(e.x+s.x+.3*(Math.random()-.5)*this.size,e.y+s.y+.1*Math.random()*this.size,e.z+s.z+.3*(Math.random()-.5)*this.size);for(let t=0;t<this.particlesPerEmission;t++){const t=400+100*Math.random(),e=new xy(n.x+.2*(Math.random()-.5)*this.size,n.y+.05*Math.random()*this.size,n.z+.2*(Math.random()-.5)*this.size,t,this.scene,this.fireMaterial,"fire",this.size),s=new pi(0,0,1);s.applyQuaternion(i),e.velocity.add(s.multiplyScalar(2*this.size)),this.particles.push(e)}for(let t=0;t<Math.floor(.5*this.particlesPerEmission);t++){const t=300+50*Math.random(),e=new xy(n.x+.3*(Math.random()-.5)*this.size,n.y+.1*Math.random()*this.size,n.z+.3*(Math.random()-.5)*this.size,t,this.scene,this.sparkMaterial,"spark",this.size),s=new pi(0,0,1);s.applyQuaternion(i),e.velocity.add(s.multiplyScalar(1.5*this.size)),this.particles.push(e)}for(let t=0;t<Math.floor(.3*this.particlesPerEmission);t++){const t=600+150*Math.random(),e=new xy(n.x+.4*(Math.random()-.5)*this.size,n.y+.15*Math.random()*this.size,n.z+.4*(Math.random()-.5)*this.size,t,this.scene,this.smokeMaterial,"smoke",this.size),s=new pi(0,0,1);s.applyQuaternion(i),e.velocity.add(s.multiplyScalar(.8*this.size)),this.particles.push(e)}}))}update(){const t=()=>{this.checkDriftState(),this.isActive&&this.addNitroEffect(),this.particles=this.particles.filter((t=>(t.update(16),!!t.isAlive()||(t.destroy(this.scene),!1))))};if(this.world&&this.world.addEventListener)this.world.addEventListener("postStep",t);else{const e=()=>{t(),requestAnimationFrame(e)};e()}}setSize(t){this.size=Math.max(.1,t)}getSize(){return this.size}start(){this.activateNitro()}stop(){this.deactivateNitro()}isNitroActive(){return this.isActive}getRemainingTime(){if(!this.isActive)return 0;const t=Date.now()-this.activationStartTime;return Math.max(0,this.duration-t)}destroy(){this.particles.forEach((t=>t.destroy(this.scene))),this.particles=[],this.nitroTimeout&&clearTimeout(this.nitroTimeout),this.fireMaterial&&this.fireMaterial.dispose(),this.sparkMaterial&&this.sparkMaterial.dispose(),this.smokeMaterial&&this.smokeMaterial.dispose(),this.audioContext&&this.audioContext.close()}setDuration(t){this.duration=t}setEmissionRate(t){this.emissionRate=t}setParticlesPerEmission(t){this.particlesPerEmission=t}setOffset(t){this.offset=t}}class Sy{constructor(t,e,i,s=100,n=null,o={}){this.world=t,this.scene=e,this.car=i,this.renderer=n,this.maxHealth=s,this.currentHealth=s,this.isDestroyed=!1,this.healthBody=null,this.healthBox=null,this.collisionCooldown=500,this.lastCollisionTime=0,this.aiCarDamage=1,this.bombDamage=5,this.environmentDamage=0,this.aiSportsCarDamage=0,this.sounds={aiCarCollision:[],bombCollision:[]},this.soundUrls={aiCarCollision:["./sounds/car_hit_1.mp3","./sounds/car_hit_2.mp3","./sounds/car_hit_3.mp3","./sounds/car_hit_4.mp3","./sounds/car_hit_5.mp3"],bombCollision:["./sounds/bullet_hit_1.mp3","./sounds/bullet_hit_2.mp3","./sounds/bullet_hit_3.mp3","./sounds/bullet_hit_4.mp3","./sounds/bullet_hit_5.mp3"]},this.soundVolume=.5,this.soundsEnabled=!0,this.healthBarWidth=o.healthBarWidth||200,this.healthBarHeight=o.healthBarHeight||20,this.healthBarContainer=null,this.healthBarFill=null,this.damageFlashDuration=300,this.isDamageFlashing=!1,this.originalCameraFov=null,this.gameOverScreen=null,this.playAgainButton=null,this.onRestart=null,this.onHealthChange=null,this.onDeath=null,this.onDamage=null,this.debugWireframe=null,this.showDebugWireframe=!1}updateHealthBarDimensions(t,e){if(this.healthBarWidth=t,this.healthBarHeight=e,this.healthBarContainer&&(this.healthBarContainer.style.width=`${t}px`,this.healthBarContainer.style.height=`${e}px`),this.healthBarFill){this.healthBarFill.style.height=`${e}px`;const t=this.currentHealth/this.maxHealth*100;this.healthBarFill.style.width=`${t}%`}}getHealthBarDimensions(){return{width:this.healthBarWidth,height:this.healthBarHeight}}init(){this.createHealthCollisionBox(),this.createHealthBar(),this.setupCollisionDetection(),this.setupEventListeners(),this.loadSounds(),this.startUpdateLoop(),console.log("Health system initialized with",this.maxHealth,"HP")}loadSounds(){const t=new Hc,e=new Jc;this.soundUrls.aiCarCollision.forEach(((i,s)=>{const n=new Qc(e);t.load(i,(t=>{n.setBuffer(t),n.setVolume(this.soundVolume),this.sounds.aiCarCollision[s]=n,console.log(`AI car collision sound ${s+1} loaded`)}),(t=>{console.log(`Loading AI car collision sound ${s+1}...`,t.loaded/t.total*100+"%")}),(t=>{console.warn(`Failed to load AI car collision sound ${s+1}:`,t),this.sounds.aiCarCollision[s]=null}))})),this.soundUrls.bombCollision.forEach(((i,s)=>{const n=new Qc(e);t.load(i,(t=>{n.setBuffer(t),n.setVolume(this.soundVolume),this.sounds.bombCollision[s]=n,console.log(`Bomb collision sound ${s+1} loaded`)}),(t=>{console.log(`Loading bomb collision sound ${s+1}...`,t.loaded/t.total*100+"%")}),(t=>{console.warn(`Failed to load bomb collision sound ${s+1}:`,t),this.sounds.bombCollision[s]=null}))}))}playSound(t){if(!this.soundsEnabled)return;const e=this.sounds[t];if(!e||0===e.length)return void console.warn(`No sounds available for ${t}`);const i=e.filter((t=>t&&t.buffer));if(0===i.length)return void console.warn(`No loaded sounds available for ${t}`);const s=Math.floor(Math.random()*i.length),n=i[s];if(n&&n.buffer){n.isPlaying&&n.stop();try{n.play(),console.log(`Playing ${t} sound (variant ${s+1})`)}catch(e){console.warn(`Failed to play ${t} sound:`,e)}}}createHealthCollisionBox(){const t=new hu(new Ud(1.5,.8,3.8));this.healthBody=new du({mass:0,isTrigger:!0,type:du.KINEMATIC}),this.healthBody.addShape(t),this.healthBody.userData={type:"healthCollision",health:this,belongsTo:"player"},this.world.addBody(this.healthBody),this.showDebugWireframe&&this.createDebugWireframe(),console.log("Health collision box created")}createDebugWireframe(){const t=new gh(3,1.6,7.6),e=new Os({color:65280,wireframe:!0,transparent:!0,opacity:.3});this.debugWireframe=new Cn(t,e),this.scene.add(this.debugWireframe)}createHealthBar(){this.healthBarContainer=document.createElement("div"),this.healthBarContainer.style.position="fixed",this.healthBarContainer.style.top="20px",this.healthBarContainer.style.left="20px",this.healthBarContainer.style.width=this.healthBarWidth+"px",this.healthBarContainer.style.height=this.healthBarHeight+"px",this.healthBarContainer.style.backgroundColor="rgba(0, 0, 0, 0.7)",this.healthBarContainer.style.border="2px solid #ffffff",this.healthBarContainer.style.borderRadius="10px",this.healthBarContainer.style.overflow="hidden",this.healthBarContainer.style.zIndex="1000",this.healthBarContainer.style.fontFamily="Arial, sans-serif",this.healthBarContainer.style.fontSize="12px",this.healthBarContainer.style.color="#ffffff",this.healthBarContainer.style.textAlign="center",this.healthBarContainer.style.lineHeight=this.healthBarHeight+"px",this.healthBarFill=document.createElement("div"),this.healthBarFill.style.position="absolute",this.healthBarFill.style.top="0",this.healthBarFill.style.left="0",this.healthBarFill.style.width="100%",this.healthBarFill.style.height="100%",this.healthBarFill.style.backgroundColor=this.getHealthColor(),this.healthBarFill.style.transition="all 0.3s ease",this.healthBarFill.style.borderRadius="8px",this.healthText=document.createElement("div"),this.healthText.style.position="relative",this.healthText.style.zIndex="1001",this.healthText.style.textShadow="1px 1px 2px rgba(0,0,0,0.8)",this.healthText.style.fontWeight="bold",this.healthText.textContent=`${this.currentHealth}/${this.maxHealth}`,this.healthBarContainer.appendChild(this.healthBarFill),this.healthBarContainer.appendChild(this.healthText),document.body.appendChild(this.healthBarContainer),console.log("Health bar UI created")}getHealthColor(){const t=this.currentHealth/this.maxHealth;return t>.6?"#00ff00":t>.3?"#ffff00":"#ff0000"}setupCollisionDetection(){this.world.addEventListener("beginContact",(t=>{this.handleCollision(t)}))}handleCollision(t){let e,i;if(t.contact)e=t.contact.bi,i=t.contact.bj;else if(t.bodyA&&t.bodyB)e=t.bodyA,i=t.bodyB;else{if(!t.bi||!t.bj)return void console.warn("Unknown collision event structure:",t);e=t.bi,i=t.bj}let s=null,n=null;if("healthCollision"===e?.userData?.type&&e?.userData?.health===this?(s=e,n=i):"healthCollision"===i?.userData?.type&&i?.userData?.health===this&&(s=i,n=e),!s||!n)return;const o=Date.now();if(o-this.lastCollisionTime<this.collisionCooldown)return;let r=0,a="unknown",h=null;"aiCar"===n.userData?.type?(r=this.aiCarDamage,a="aiCar",h="aiCarCollision",console.log("Collision with AI car detected!")):n.userData?.type?.startsWith("aicar")?(r=this.aiSportsCarDamage,a="aiSportsCar",h="aiCarCollision",console.log("Collision with AI Sports Car detected!")):"bomb"===n.userData?.type?(r=this.bombDamage,a="bomb",h="bombCollision",console.log("Collision with Bomb detected!")):"car"===n.userData?.type&&n.userData?.car!==this.car?(r=this.aiCarDamage,a="playerCar",h="aiCarCollision",console.log("Collision with another player car detected!")):(r=this.environmentDamage,a="environment",console.log("Collision with environment detected!")),h&&(this.playSound(h),console.log(`Playing sound: ${h} for collision type: ${a}`)),r>0&&this.takeDamage(r,a),this.lastCollisionTime=o}takeDamage(t,e="unknown"){if(this.currentHealth<=0)return;const i=this.currentHealth;this.currentHealth=Math.max(0,this.currentHealth-t),console.log(`Took ${t} damage from ${e}. Health: ${this.currentHealth}/${this.maxHealth}`),this.updateHealthBar(),this.showDamageEffect(t),this.onDamage&&this.onDamage(t,e,this.currentHealth,i),this.onHealthChange&&this.onHealthChange(this.currentHealth,i),this.currentHealth<=0&&this.handleDeath()}handleDeath(){console.log("Player car destroyed!"),this.isDestroyed=!0,console.log(this.isDestroyed),this.stopGameAndShowRestart(),this.onDeath&&this.onDeath()}stopGameAndShowRestart(){this.renderer&&this.renderer.domElement&&(this.renderer.domElement.style.display="none"),this.healthBarContainer&&(this.healthBarContainer.style.display="none")}restartGame(){console.log("Restarting game..."),this.isDestroyed=!1,this.onRestart&&this.onRestart(),this.currentHealth=this.maxHealth,this.updateHealthBar(),this.renderer&&this.renderer.domElement&&(this.renderer.domElement.style.display="block"),this.healthBarContainer&&(this.healthBarContainer.style.display="block"),this.gameOverScreen&&this.gameOverScreen.parentNode&&(this.gameOverScreen.parentNode.removeChild(this.gameOverScreen),this.gameOverScreen=null,this.playAgainButton=null),console.log("Game restarted successfully")}updateHealthBar(){if(!this.healthBarFill||!this.healthText)return;const t=this.currentHealth/this.maxHealth*100;this.healthBarFill.style.width=t+"%",this.healthBarFill.style.backgroundColor=this.getHealthColor(),this.healthText.textContent=`${Math.ceil(this.currentHealth)}/${this.maxHealth}`,this.healthBarContainer.style.animation=t<20?"healthPulse 1s infinite":"none"}showDamageEffect(t){if(this.isDamageFlashing)return;this.isDamageFlashing=!0;const e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(255, 0, 0, 0.3)",e.style.pointerEvents="none",e.style.zIndex="9999",e.style.animation=`damageFlash ${this.damageFlashDuration}ms ease-out`,document.body.appendChild(e),this.showDamageNumber(t),setTimeout((()=>{e.parentNode&&e.parentNode.removeChild(e),this.isDamageFlashing=!1}),this.damageFlashDuration)}showDamageNumber(t){const e=document.createElement("div");e.textContent=`-${Math.ceil(t)}`,e.style.position="fixed",e.style.left="50%",e.style.top="50%",e.style.transform="translate(-50%, -50%)",e.style.color="#ff0000",e.style.fontSize="24px",e.style.fontWeight="bold",e.style.textShadow="2px 2px 4px rgba(0,0,0,0.8)",e.style.pointerEvents="none",e.style.zIndex="10000",e.style.animation="damageNumber 1s ease-out forwards",document.body.appendChild(e),setTimeout((()=>{e.parentNode&&e.parentNode.removeChild(e)}),1e3)}setupEventListeners(){const t=document.createElement("style");t.textContent="\n      @keyframes healthPulse {\n        0%, 100% { opacity: 1; }\n        50% { opacity: 0.7; }\n      }\n      \n      @keyframes damageFlash {\n        0% { opacity: 1; }\n        100% { opacity: 0; }\n      }\n      \n      @keyframes damageNumber {\n        0% { \n          opacity: 1; \n          transform: translate(-50%, -50%) scale(1); \n        }\n        100% { \n          opacity: 0; \n          transform: translate(-50%, -200%) scale(1.5); \n        }\n      }\n      \n      @keyframes gameOverPulse {\n        0%, 100% { \n          opacity: 1; \n          transform: scale(1); \n        }\n        50% { \n          opacity: 0.8; \n          transform: scale(1.05); \n        }\n      }\n    ",document.head.appendChild(t)}startUpdateLoop(){const t=()=>{this.updateHealthCollisionBox(),requestAnimationFrame(t)};t()}updateHealthCollisionBox(){this.healthBody&&this.car?.car?.chassisBody&&(this.healthBody.position.copy(this.car.car.chassisBody.position),this.healthBody.quaternion.copy(this.car.car.chassisBody.quaternion),this.debugWireframe&&(this.debugWireframe.position.copy(this.car.car.chassisBody.position),this.debugWireframe.quaternion.copy(this.car.car.chassisBody.quaternion)))}heal(t){const e=this.currentHealth;this.currentHealth=Math.min(this.maxHealth,this.currentHealth+t),console.log(`Healed ${t} HP. Health: ${this.currentHealth}/${this.maxHealth}`),this.updateHealthBar(),this.onHealthChange&&this.onHealthChange(this.currentHealth,e)}fullHeal(){this.heal(this.maxHealth-this.currentHealth)}getHealthPercent(){return this.currentHealth/this.maxHealth*100}isDead(){return this.currentHealth<=0}getCurrentHealth(){return this.currentHealth}getMaxHealth(){return this.maxHealth}getIsDestroyed(){return this.isDestroyed}setIsDestroyed(t){this.isDestroyed=t}setSoundVolume(t){this.soundVolume=Math.max(0,Math.min(1,t)),Object.values(this.sounds).forEach((t=>{Array.isArray(t)&&t.forEach((t=>{t&&t.setVolume&&t.setVolume(this.soundVolume)}))}))}enableSounds(){this.soundsEnabled=!0,console.log("Sounds enabled")}disableSounds(){this.soundsEnabled=!1,console.log("Sounds disabled")}toggleSounds(){this.soundsEnabled=!this.soundsEnabled,console.log("Sounds",this.soundsEnabled?"enabled":"disabled")}setOnHealthChange(t){this.onHealthChange=t}setOnDeath(t){this.onDeath=t}setOnDamage(t){this.onDamage=t}setOnRestart(t){this.onRestart=t}toggleDebugWireframe(){this.showDebugWireframe=!this.showDebugWireframe,this.showDebugWireframe&&!this.debugWireframe?this.createDebugWireframe():!this.showDebugWireframe&&this.debugWireframe&&(this.scene.remove(this.debugWireframe),this.debugWireframe.geometry.dispose(),this.debugWireframe.material.dispose(),this.debugWireframe=null)}cleanup(){Object.values(this.sounds).forEach((t=>{t&&(t.isPlaying&&t.stop(),t.disconnect&&t.disconnect())})),this.healthBody&&this.world.removeBody(this.healthBody),this.healthBarContainer&&this.healthBarContainer.parentNode&&this.healthBarContainer.parentNode.removeChild(this.healthBarContainer),this.gameOverScreen&&this.gameOverScreen.parentNode&&this.gameOverScreen.parentNode.removeChild(this.gameOverScreen),this.debugWireframe&&(this.scene.remove(this.debugWireframe),this.debugWireframe.geometry.dispose(),this.debugWireframe.material.dispose()),console.log("Health system cleaned up")}}class My{constructor(t,e,i,s=[],n={},o=[]){this.world=t,this.scene=e,this.playerCar=i,this.aiCars=s,this.completionOrder=[],this.playerProgress={currentCheckpointIndex:0,cycleCompletions:0,lapCompleted:!1,lapTime:0,totalTime:0},this.aiProgress=this.aiCars.map(((t,e)=>({carIndex:e,currentCheckpointIndex:0,cycleCompletions:0,lapCompleted:!1,lapTime:0,totalTime:0}))),this.raceWinner=null,this.raceFinished=!1,this.currentLap=0,this.totalLaps=0,this.lapCompleted=!1,this.checkpointSequence=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","R","S","T"],this.currentCheckpointIndex=0,this.cycleCompletions=0,this.requiredCycles=2,this.checkpointConfigs=[{id:"A",position:{x:-10,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint A",color:16711680,...n.A},{id:"B",position:{x:0,y:0,z:10},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint B",color:65280,...n.B},{id:"C",position:{x:10,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint C",color:255,...n.C},{id:"D",position:{x:20,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint D",color:255,...n.D},{id:"E",position:{x:20,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint E",color:255,...n.E},{id:"F",position:{x:20,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint F",color:255,...n.F},{id:"G",position:{x:20,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint G",color:255,...n.G},{id:"H",position:{x:20,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint H",color:255,...n.H},{id:"I",position:{x:20,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint I",color:255,...n.I},{id:"J",position:{x:20,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint J",color:255,...n.J},{id:"K",position:{x:20,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint K",color:255,...n.K},{id:"L",position:{x:20,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint L",color:255,...n.L},{id:"M",position:{x:20,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint M",color:255,...n.M},{id:"N",position:{x:20,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint N",color:255,...n.N},{id:"O",position:{x:20,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint O",color:255,...n.O},{id:"P",position:{x:20,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint P",color:255,...n.P},{id:"Q",position:{x:20,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint Q",color:255,...n.Q},{id:"R",position:{x:20,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint R",color:255,...n.R},{id:"S",position:{x:20,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint S",color:255,...n.S},{id:"T",position:{x:20,y:0,z:0},rotation:{x:0,y:0,z:0},size:{x:2,y:2,z:2},name:"Checkpoint T",color:255,...n.T}],this.referenceBoxConfigs=o.map(((t,e)=>({id:`reference_${e}`,position:t.position||{x:20,y:0,z:0},rotation:t.rotation||{x:0,y:0,z:0},size:t.size||{x:2,y:2,z:2},name:t.name||`Reference Box ${e+1}`,visible:void 0!==t.visible&&t.visible,color:t.color||16776960,...t}))),this.checkpoints=[],this.referenceBoxes=[],this.allBoxes=[],this.visitHistory=[],this.invalidVisits=0,this.lapCounter=null,this.progressIndicator=null,this.statusDisplay=null,this.detailsDisplay=null,this.sequenceDisplay=null,this.onLapComplete=null,this.onBoxOverlap=null,this.onProgressUpdate=null,this.onInvalidVisit=null,this.showDebugInfo=!1}init(){this.createCheckpoints(),this.createReferenceBoxes(),this.createLapUI(),this.createRaceUI(),this.setupCollisionDetection(),this.startUpdateLoop(),console.log(`Lap system initialized with cyclic checkpoints: ${this.checkpointSequence.join(" → ")}`),console.log(`Each lap requires ${this.requiredCycles} complete cycles`)}createCheckpoints(){this.checkpointConfigs.forEach(((t,e)=>{const i=new Ty(this.world,this.scene,this.playerCar,this.aiCars,t.id,t.position,t.rotation,t.size,!0,t.color);i.init(),i.setName(t.name),this.checkpoints.push(i),this.allBoxes.push(i),console.log(`Checkpoint ${t.id} created at position:`,t.position)}))}createReferenceBoxes(){this.referenceBoxConfigs.forEach(((t,e)=>{const i=new Ty(this.world,this.scene,this.playerCar,this.aiCars,t.id,t.position,t.rotation,t.size,t.visible,t.color);i.init(),i.setName(t.name),this.referenceBoxes.push(i),this.allBoxes.push(i),console.log(`Reference box ${e+1} created at position:`,t.position,`(visible: ${t.visible})`)}))}createLapUI(){this.statusDisplay=document.createElement("div"),this.statusDisplay.style.position="fixed",this.statusDisplay.style.top="10px",this.statusDisplay.style.right="10px",this.statusDisplay.style.backgroundColor="rgba(0, 0, 0, 0.8)",this.statusDisplay.style.color="#ffffff",this.statusDisplay.style.padding="8px 12px",this.statusDisplay.style.borderRadius="5px",this.statusDisplay.style.fontFamily="Arial, sans-serif",this.statusDisplay.style.fontSize="12px",this.statusDisplay.style.border="2px solid #0088ff",this.statusDisplay.style.zIndex="10000",this.statusDisplay.style.maxWidth="250px",this.statusDisplay.style.wordWrap="break-word",document.body.appendChild(this.statusDisplay),this.updateUI()}setupCollisionDetection(){this.world.addEventListener("beginContact",(t=>{this.handleCollisionEnter(t)})),this.world.addEventListener("endContact",(t=>{this.handleCollisionExit(t)}))}handleCollisionEnter(t){const{bodyA:e,bodyB:i}=this.getCollisionBodies(t);if(!e||!i)return;const{boxBody:s,otherBody:n}=this.identifyBodies(e,i);if(!s||!n)return;const o=this.isValidCar(n);if(o.isValid){const t=s.userData?.boxId,e=this.findBoxById(t);if(e){const i=o.carType,s=`${i}Inside`;e[s]||(e[s]=!0,this.handleBoxVisit(t,e,i))}}}handleCollisionExit(t){const{bodyA:e,bodyB:i}=this.getCollisionBodies(t);if(!e||!i)return;const{boxBody:s,otherBody:n}=this.identifyBodies(e,i);if(!s||!n)return;const o=this.isValidCar(n);if(o.isValid){const t=s.userData?.boxId,e=this.findBoxById(t);if(e){const t=`${o.carType}Inside`;e[t]&&(e[t]=!1)}}}isValidCar(t){if(this.playerCar&&(t===this.playerCar.body||"player"===t.userData?.belongsTo))return{isValid:!0,carType:"player"};for(let e=0;e<this.aiCars.length;e++){const i=this.aiCars[e];if(i&&(t===i.body||t.userData?.car===`aiCar${e}`||t.userData?.type===`aicar${e}`))return{isValid:!0,carType:`aicar${e}`}}return{isValid:!1,carType:null}}handleBoxVisit(t,e,i){this.checkpointSequence.includes(t)?this.handleCheckpointVisit(t,e,i):this.handleReferenceBoxVisit(t,e,i)}handleCheckpointVisit(t,e,i){if(this.raceFinished)return;let s;if("player"===i)s=this.playerProgress;else if(i.startsWith("aicar")){const t=parseInt(i.replace("aicar",""));s=this.aiProgress[t]}s&&(t===this.checkpointSequence[s.currentCheckpointIndex]?(s.currentCheckpointIndex=(s.currentCheckpointIndex+1)%this.checkpointSequence.length,0===s.currentCheckpointIndex&&(s.cycleCompletions++,s.cycleCompletions>=this.requiredCycles&&t===this.checkpointSequence[this.checkpointSequence.length-1]&&!s.lapCompleted&&(s.lapCompleted=!0,s.lapTime=Date.now()-(this.lapStartTime||Date.now()),this.completionOrder||(this.completionOrder=[]),this.completionOrder.push({carType:i,completionTime:Date.now(),lapTime:s.lapTime}),console.log(`${i.toUpperCase()} COMPLETED THE LAP! (Position: ${this.completionOrder.length})`),"player"===i&&(this.raceFinished=!0,this.raceWinner="player",console.log("PLAYER WINS THE RACE! Race is now finished.")),this.showLapCompletion(i))),e.setValidVisit(!0)):e.setValidVisit(!1),this.updateUI())}handleReferenceBoxVisit(t,e){this.visitHistory.push({id:t,timestamp:Date.now(),valid:!0,type:"reference"}),e.setValidVisit(!0),this.onBoxOverlap&&this.onBoxOverlap(t,e,1,1)}updateCheckpointStates(){this.checkpoints.forEach(((t,e)=>{const i=t.getId(),s=e===this.currentCheckpointIndex,n=this.hasCompletedCheckpointInCurrentCycle(i);t.setAsNext(s),t.setCompleted(n)}))}hasCompletedCheckpointInCurrentCycle(t){const e=3*this.cycleCompletions;return this.visitHistory.slice(e).filter((e=>e.valid&&e.id===t)).length>0}completeLap(){if(!this.lapCompleted){if(this.lapCompleted=!0,this.currentLap++,this.totalLaps++,this.lapStartTime){const t=Date.now()-this.lapStartTime;this.lapTimes=this.lapTimes||[],this.lapTimes.push(t),console.log(`Lap ${this.currentLap} completed in ${this.formatTime(t)}!`)}else console.log(`Lap ${this.currentLap} completed!`);console.log(`Cycles completed: ${this.cycleCompletions}/${this.requiredCycles}`),console.log(`Invalid visits: ${this.invalidVisits}`),this.isRaceComplete()?this.completeRace():(this.showLapCompletionEffect(),this.onLapComplete&&this.onLapComplete(this.currentLap,this.getProgress()),setTimeout((()=>{this.resetLap()}),2e3))}}completeRace(){if(console.log(`RACE COMPLETE! Finished ${this.currentLap} laps!`),this.lapTimes&&this.lapTimes.length>0){const t=this.getTotalTime(),e=this.lapTimes.reduce(((t,e)=>t+e),0)/this.lapTimes.length,i=Math.min(...this.lapTimes);console.log(`Total time: ${this.formatTime(t)}`),console.log(`Average lap time: ${this.formatTime(e)}`),console.log(`Best lap time: ${this.formatTime(i)}`)}this.showRaceCompletionEffect()}showRaceCompletionEffect(){if(this.allBoxes.forEach((t=>{t.showCompletionEffect&&t.showCompletionEffect()})),this.statusDisplay&&(this.statusDisplay.textContent=`RACE COMPLETE! ${this.currentLap} LAPS FINISHED!`,this.statusDisplay.style.color="#ffd700",this.statusDisplay.style.borderColor="#ffd700",this.statusDisplay.style.fontSize="14px",this.statusDisplay.style.fontWeight="bold"),this.detailsDisplay){let t="FINAL RESULTS:\n";if(t+=`Laps: ${this.currentLap}/${this.targetLaps||this.currentLap}\n`,t+=`Invalid Visits: ${this.invalidVisits}\n`,this.lapTimes&&this.lapTimes.length>0){const e=this.getTotalTime(),i=this.lapTimes.reduce(((t,e)=>t+e),0)/this.lapTimes.length,s=Math.min(...this.lapTimes);t+=`Total: ${this.formatTime(e)}\n`,t+=`Average: ${this.formatTime(i)}\n`,t+=`Best: ${this.formatTime(s)}`}this.detailsDisplay.textContent=t,this.detailsDisplay.style.color="#ffd700",this.detailsDisplay.style.borderColor="#ffd700"}}resetLap(){this.lapCompleted=!1,this.currentCheckpointIndex=0,this.cycleCompletions=0,this.visitHistory=[],this.invalidVisits=0,this.allBoxes.forEach((t=>{t.reset()})),this.updateCheckpointStates(),this.isRaceComplete()||(this.lapStartTime=Date.now(),console.log("Lap reset - ready for next lap")),this.updateUI()}showLapCompletionEffect(){this.allBoxes.forEach((t=>{t.showCompletionEffect&&t.showCompletionEffect()})),this.statusDisplay&&(this.statusDisplay.textContent=`LAP ${this.currentLap} COMPLETE!`,this.statusDisplay.style.color="#ffd700",this.statusDisplay.style.borderColor="#ffd700",setTimeout((()=>{this.statusDisplay.style.color="#ffffff",this.statusDisplay.style.borderColor="#0088ff"}),2e3))}completeLap(t){this.raceFinished||(this.raceWinner||(this.raceWinner=t,this.raceFinished=!0,console.log(`${t.toUpperCase()} WINS THE RACE!`)),this.updateUI())}showLapCompletion(t){const e=this.completionOrder.length,i="player"===t,s=this.getPlayerRanking();this.allBoxes.forEach((t=>{t.showCompletionEffect&&t.showCompletionEffect()})),this.raceStatusDisplay&&(this.raceStatusDisplay.innerHTML=i?`\n        <div style="font-size: 18px; font-weight: bold; color: #ffd700;">\n           LAPS COMPLETED!\n        </div>\n        <div style="font-size: 12px; margin-top: 4px;">\n          ${this.completionOrder.length} cars finished\n        </div>\n      `:`\n        <div style="font-size: 16px; font-weight: bold; color: #ff8800;">\n          ${t.toUpperCase()} COMPLETED LAP!\n        </div>\n        <div style="font-size: 14px; margin-top: 8px;">\n          Position: ${e}/${this.getTotalCars()}\n        </div>\n        <div style="font-size: 12px; margin-top: 4px;">\n          Player Ranking: ${s}/${this.getTotalCars()}\n        </div>\n      `,this.raceStatusDisplay.style.borderColor=i?"#ffd700":"#ff8800"),this.statusDisplay&&this.updateRankingDisplay()}getPlayerRanking(){return this.playerProgress.lapCompleted?this.completionOrder.findIndex((t=>"player"===t.carType))+1:this.completionOrder.length+1}getTotalCars(){return 1+this.aiCars.length}updateRankingDisplay(){if(!this.statusDisplay)return;let t="CURRENT RANKING:\n";this.completionOrder.forEach(((e,i)=>{const s=i+1,n="player"===e.carType?"PLAYER":e.carType.toUpperCase(),o=this.formatTime(e.lapTime);t+=`${s}. ${n} ✓ (${o})`,"player"===e.carType&&(t+=" "),t+="\n"})),["player",...this.aiCars.map(((t,e)=>`aicar${e}`))].filter((t=>!this.completionOrder.some((e=>e.carType===t)))).forEach((e=>{const i=this.completionOrder.length+1,s="player"===e?"PLAYER":e.toUpperCase();let n;if("player"===e)n=this.playerProgress;else{const t=parseInt(e.replace("aicar",""));n=this.aiProgress[t]}const o=n.cycleCompletions,r=this.checkpointSequence[n.currentCheckpointIndex];t+=`${i}. ${s}: ${o}/${this.requiredCycles} cycles → ${r}`,"player"===e&&(t+=""),t+="\n"})),this.statusDisplay.innerHTML=t.replace(/\n/g,"<br>"),this.statusDisplay.style.color="#ffffff",this.statusDisplay.style.borderColor="#0088ff"}showPlayerLapCompletion(){const t=[{type:"PLAYER",progress:this.playerProgress},...this.aiProgress.map(((t,e)=>({type:`AI${e+1}`,progress:t})))];t.sort(((t,e)=>t.progress.cycleCompletions!==e.progress.cycleCompletions?e.progress.cycleCompletions-t.progress.cycleCompletions:e.progress.currentCheckpointIndex-t.progress.currentCheckpointIndex));const e=t.findIndex((t=>"PLAYER"===t.type))+1;if(this.allBoxes.forEach((t=>{t.showCompletionEffect&&t.showCompletionEffect()})),this.raceStatusDisplay&&(this.raceStatusDisplay.innerHTML=`\n      <div style="font-size: 18px; font-weight: bold; color: #ffd700;">\n       PLAYER COMPLETED LAP!\n      </div>\n      <div style="font-size: 14px; margin-top: 8px;">\n        Player Ranking: ${e}/${t.length}\n      </div>\n    `,this.raceStatusDisplay.style.borderColor="#ffd700"),this.statusDisplay){let e="FINAL RANKING:\n";t.forEach(((t,i)=>{const s=i+1,n=t.progress.cycleCompletions,o=this.checkpointSequence[t.progress.currentCheckpointIndex],r="PLAYER"===t.type;e+=`${s}. ${t.type}: ${n}/${this.requiredCycles} cycles → ${o}`,r&&(e+=""),e+="\n"})),this.statusDisplay.innerHTML=e.replace(/\n/g,"<br>"),this.statusDisplay.style.color="#ffd700",this.statusDisplay.style.borderColor="#ffd700"}console.log(`Player finished in position ${e} out of ${t.length}`)}showRaceWinner(){this.allBoxes.forEach((t=>{t.showCompletionEffect&&t.showCompletionEffect()}))}createRaceUI(){this.raceStatusDisplay=document.createElement("div"),this.raceStatusDisplay.style.position="fixed",this.raceStatusDisplay.style.top="20px",this.raceStatusDisplay.style.left="20px",this.raceStatusDisplay.style.backgroundColor="rgba(0, 0, 0, 0.8)",this.raceStatusDisplay.style.color="#ffffff",this.raceStatusDisplay.style.padding="12px 16px",this.raceStatusDisplay.style.borderRadius="5px",this.raceStatusDisplay.style.fontFamily="Arial, sans-serif",this.raceStatusDisplay.style.fontSize="16px",this.raceStatusDisplay.style.border="2px solid #00ff00",this.raceStatusDisplay.style.zIndex="10000",this.raceStatusDisplay.style.textAlign="center",this.raceStatusDisplay.style.minWidth="200px",document.body.appendChild(this.raceStatusDisplay)}updateUI(){if(this.getPlayerRanking(),this.raceStatusDisplay&&!this.raceFinished){const t=this.playerProgress.cycleCompletions;this.checkpointSequence[this.playerProgress.currentCheckpointIndex];let e=`<div>Laps: ${t}/${this.requiredCycles}</div>`;this.completionOrder&&this.completionOrder.length>0&&(e+=`<div style="font-size: 12px; margin-top: 2px;">${this.completionOrder.length} cars finished</div>`),this.raceStatusDisplay.innerHTML=e}if(this.sequenceDisplay){let t='<div style="font-weight: bold;">NEXT CHECKPOINT</div>';t+=`<div style="font-size: 18px; color: #ffff00;">${this.checkpointSequence[this.playerProgress.currentCheckpointIndex]}</div>`,t+=`<div style="font-size: 12px;">(${this.playerProgress.currentCheckpointIndex+1}/${this.checkpointSequence.length})</div>`,this.sequenceDisplay.innerHTML=t}this.statusDisplay&&this.updateRankingDisplay()}getCollisionBodies(t){let e,i;if(t.contact)e=t.contact.bi,i=t.contact.bj;else if(t.bodyA&&t.bodyB)e=t.bodyA,i=t.bodyB;else{if(!t.bi||!t.bj)return{bodyA:null,bodyB:null};e=t.bi,i=t.bj}return{bodyA:e,bodyB:i}}identifyBodies(t,e){let i=null,s=null;return"lapBox"===t?.userData?.type?(i=t,s=e):"lapBox"===e?.userData?.type&&(i=e,s=t),{boxBody:i,otherBody:s}}findBoxById(t){return this.allBoxes.find((e=>e.getId()===t))}startUpdateLoop(){const t=()=>{this.allBoxes.forEach((t=>{t.update&&t.update()})),requestAnimationFrame(t)};t()}getCurrentLap(){return this.currentLap}getTotalLaps(){return this.totalLaps}getProgress(){return{currentCheckpointIndex:this.currentCheckpointIndex,nextCheckpoint:this.checkpointSequence[this.currentCheckpointIndex],cycleCompletions:this.cycleCompletions,requiredCycles:this.requiredCycles,progressPercent:this.cycleCompletions/this.requiredCycles*100,visitHistory:[...this.visitHistory],invalidVisits:this.invalidVisits,checkpointSequence:[...this.checkpointSequence]}}getVisitHistory(){return[...this.visitHistory]}getInvalidVisits(){return this.invalidVisits}setRequiredCycles(t){this.requiredCycles=t,console.log(`Required cycles per lap set to: ${t}`),this.updateUI()}getRequiredCycles(){return this.requiredCycles}setTargetLaps(t){this.targetLaps=t,console.log(`Target laps set to: ${t}`),this.updateUI()}getTargetLaps(){return this.targetLaps||0}isRaceComplete(){return this.targetLaps&&this.currentLap>=this.targetLaps}getStatistics(){return{currentLap:this.currentLap,totalLaps:this.totalLaps,targetLaps:this.targetLaps||0,cycleCompletions:this.cycleCompletions,requiredCycles:this.requiredCycles,progressPercent:this.cycleCompletions/this.requiredCycles*100,visitHistory:[...this.visitHistory],invalidVisits:this.invalidVisits,checkpointSequence:[...this.checkpointSequence],currentCheckpointIndex:this.currentCheckpointIndex,nextCheckpoint:this.checkpointSequence[this.currentCheckpointIndex],raceComplete:this.isRaceComplete(),lapComplete:this.cycleCompletions>=this.requiredCycles}}startTimer(){this.startTime=Date.now(),this.lapStartTime=Date.now(),this.lapTimes=[]}getLapTime(){return this.lapStartTime?Date.now()-this.lapStartTime:0}getTotalTime(){return this.startTime?Date.now()-this.startTime:0}formatTime(t){const e=Math.floor(t/6e4),i=Math.floor(t%6e4/1e3),s=Math.floor(t%1e3/10);return`${e}:${i.toString().padStart(2,"0")}.${s.toString().padStart(2,"0")}`}getCompletionStats(){return{completionOrder:[...this.completionOrder],playerRanking:this.getPlayerRanking(),totalCars:this.getTotalCars(),completedCars:this.completionOrder.length,remainingCars:this.getTotalCars()-this.completionOrder.length,raceFinished:this.raceFinished,raceWinner:this.raceWinner}}cleanup(){this.lapCounter&&(document.body.removeChild(this.lapCounter),this.lapCounter=null),this.progressIndicator&&(document.body.removeChild(this.progressIndicator),this.progressIndicator=null),this.statusDisplay&&(document.body.removeChild(this.statusDisplay),this.statusDisplay=null),this.detailsDisplay&&(document.body.removeChild(this.detailsDisplay),this.detailsDisplay=null),this.sequenceDisplay&&(document.body.removeChild(this.sequenceDisplay),this.sequenceDisplay=null),this.raceStatusDisplay&&(document.body.removeChild(this.raceStatusDisplay),this.raceStatusDisplay=null),this.allBoxes.forEach((t=>{t.cleanup&&t.cleanup()})),this.checkpoints=[],this.referenceBoxes=[],this.allBoxes=[],this.visitHistory=[]}reset(){this.currentLap=0,this.totalLaps=0,this.lapCompleted=!1,this.currentCheckpointIndex=0,this.cycleCompletions=0,this.visitHistory=[],this.invalidVisits=0,this.lapTimes=[],this.startTime=null,this.lapStartTime=null,this.allBoxes.forEach((t=>{t.reset()})),this.updateCheckpointStates(),this.updateUI(),console.log("Lap system reset")}setDebugMode(t){this.showDebugInfo=t,console.log("Debug mode "+(t?"enabled":"disabled"))}getDebugInfo(){return{currentLap:this.currentLap,totalLaps:this.totalLaps,lapCompleted:this.lapCompleted,currentCheckpointIndex:this.currentCheckpointIndex,cycleCompletions:this.cycleCompletions,requiredCycles:this.requiredCycles,visitHistory:this.visitHistory,invalidVisits:this.invalidVisits,checkpointSequence:this.checkpointSequence,nextCheckpoint:this.checkpointSequence[this.currentCheckpointIndex],allBoxes:this.allBoxes.map((t=>({id:t.getId(),name:t.getName(),isPlayerInside:t.isPlayerInside,position:t.getPosition()})))}}}class Ty{constructor(t,e,i,s=[],n,o,r,a,h=!1,l=65280){this.world=t,this.scene=e,this.playerCar=i,this.aiCars=s,this.id=n,this.position=o,this.rotation=r,this.size=a,this.visible=h,this.color=l,this.name=`${n}`,this.playerInside=!1,this.aiInside=!1,this.isNext=!1,this.isCompleted=!1,this.lastValidVisit=!1,this.mesh=null,this.body=null,this.originalColor=l,this.material=null,this.pulseIntensity=0,this.pulseSpeed=.05,this.flashTimer=0,this.isFlashing=!1,this.rotationSpeed=.01,this.bobSpeed=.02,this.bobAmplitude=.1,this.time=0,this.originalY=o.y,this.playerInside=!1,this.aiInside=this.aiCars.map((()=>!1))}init(){this.createMesh(),this.createPhysicsBody(),console.log(`CheckpointBox ${this.id} initialized at position:`,this.position)}createMesh(){this.mesh=null,this.material=null,this.wireframe=null,this.createTextLabel(),console.log(`CheckpointBox ${this.id} created (label only) at position:`,this.position)}createTextLabel(){const t=document.createElement("canvas"),e=t.getContext("2d");t.width=2048,t.height=1024,e.clearRect(0,0,t.width,t.height),e.fillStyle="white",e.font="bold 1000px Arial",e.textAlign="center",e.textBaseline="middle",e.fillText(this.name,t.width/2,t.height/2);const i=new lh(t);i.needsUpdate=!0,i.minFilter=ct,i.magFilter=ct;const s=new la({map:i,transparent:!0,opacity:this.visible?1:.8,depthTest:!1,depthWrite:!1});this.textLabel=new Ma(s),this.textLabel.position.set(this.position.x,this.position.y+this.size.y/2+1,this.position.z),this.textLabel.scale.set(8,4,1),this.scene.add(this.textLabel)}createPhysicsBody(){const t=new hu(new Ud(this.size.x/2,this.size.y/2,this.size.z/2));this.body=new du({mass:0,shape:t,position:new Ud(this.position.x,this.position.y,this.position.z),isTrigger:!0}),this.body.userData={type:"lapBox",boxId:this.id,belongsTo:"lapSystem"},this.world.addBody(this.body)}update(){if(this.time+=.016,this.textLabel){const t=Math.sin(this.time*this.bobSpeed)*this.bobAmplitude;if(this.textLabel.position.y=this.originalY+this.size.y/2+1+t,this.textLabel.rotation.y+=this.rotationSpeed,this.isNext&&(this.pulseIntensity=.5*(Math.sin(.1*this.time)+1),this.textLabel.material.opacity=.7+.3*this.pulseIntensity),this.isFlashing&&this.flashTimer>0){this.flashTimer--;const t=this.flashTimer%10<5?1:.3;this.textLabel.material.opacity=t,this.flashTimer<=0&&(this.isFlashing=!1,this.textLabel.material.opacity=this.visible?1:.7)}}}updateAnimations(){if(!this.mesh)return;this.labelMesh.rotation.y+=this.rotationSpeed;const t=Math.sin(this.time*this.bobSpeed)*this.bobAmplitude;this.mesh.position.y=this.originalY+t,this.wireframe&&(this.wireframe.position.y=this.originalY+t),this.labelMesh&&(this.labelMesh.position.y=this.originalY+this.size.y/2+.5+t),this.body&&this.body.position.set(this.mesh.position.x,this.mesh.position.y,this.mesh.position.z)}updateVisualEffects(){if(this.material){if(this.isNext&&this.labelMesh&&(this.pulseIntensity=.3*Math.sin(this.time*this.pulseSpeed)+.7,this.labelMesh.material.opacity=this.visible?this.pulseIntensity:0),this.isFlashing){this.flashTimer+=.1;const t=.5*Math.sin(10*this.flashTimer)+.5;this.labelMesh&&(this.labelMesh.material.opacity=this.visible?t:0),this.flashTimer>4*Math.PI&&(this.isFlashing=!1,this.flashTimer=0,this.labelMesh&&(this.labelMesh.material.opacity=this.visible?1:0))}(this.playerInside||this.aiInside)&&this.labelMesh&&this.isFlashing}}forceShowAllBoxes(){this.allBoxes.forEach((t=>{t.labelMesh&&t.labelMesh.material&&(t.labelMesh.material.opacity=1,t.labelMesh.material.visible=!0)})),console.log(`Forced visibility for ${this.allBoxes.length} box labels`)}setAsNext(t){this.isNext=t,this.textLabel&&(t?(this.textLabel.material.color.setHex(16776960),this.textLabel.scale.set(1.2,1.2,1.2)):(this.textLabel.material.color.setHex(16777215),this.textLabel.scale.set(1,1,1)))}setCompleted(t){this.isCompleted=t,this.textLabel&&(t?(this.textLabel.material.color.setHex(65280),this.textLabel.material.opacity=.6):(this.textLabel.material.color.setHex(16777215),this.textLabel.material.opacity=this.visible?1:.7))}setValidVisit(t){this.lastValidVisit=t,this.textLabel&&(t?this.textLabel.material.color.setHex(65280):this.textLabel.material.color.setHex(16711680),setTimeout((()=>{this.textLabel&&this.textLabel.material.color.setHex(16777215)}),1e3)),console.log(`${this.id} visit: ${t?"valid":"invalid"}`)}showCompletionEffect(){this.textLabel&&(this.isFlashing=!0,this.flashTimer=60,this.textLabel.material.color.setHex(16766720)),console.log(`${this.id} completion effect triggered`)}reset(){this.playerInside=!1,this.aiInside=this.aiCars.map((()=>!1)),this.isNext=!1,this.isCompleted=!1,this.lastValidVisit=!1,this.isFlashing=!1,this.flashTimer=0,this.pulseIntensity=0,this.time=0,this.textLabel&&(this.textLabel.material.color.setHex(16777215),this.textLabel.material.opacity=this.visible?1:.7,this.textLabel.scale.set(1,1,1),this.textLabel.rotation.y=0,this.textLabel.position.y=this.originalY+this.size.y/2+1)}getId(){return this.id}getName(){return this.name}getPosition(){return{...this.position}}getSize(){return{...this.size}}setName(t){this.name=t}setVisible(t){this.visible=t,this.labelMesh&&(this.labelMesh.material.opacity=t?1:0)}setColor(t){this.originalColor=t,this.color=t,this.material&&this.material.color.setHex(t),this.wireframe&&this.wireframe.material.color.setHex(t)}cleanup(){this.textLabel&&(this.scene.remove(this.textLabel),this.textLabel=null),this.body&&(this.world.removeBody(this.body),this.body=null),console.log(`CheckpointBox ${this.id} cleaned up`)}}class _y{constructor(t,e={}){this.car=t,this.options={maxSpeed:e.maxSpeed||280,unit:e.unit||"km/h",size:e.size||150,position:e.position||{x:20,y:20},updateInterval:e.updateInterval||16,showNeedle:!1!==e.showNeedle,showDigital:!1!==e.showDigital,showBackground:!1!==e.showBackground,color:e.color||"#999999",backgroundColor:e.backgroundColor||"rgba(0, 0, 0, 0.8)",redZoneColor:e.redZoneColor||"#ff0000",orangeZoneColor:e.orangeZoneColor||"#ffa500",greenZoneColor:e.greenZoneColor||"#2bd71b",whiteZoneColor:e.whiteZoneColor||"#ffffff",...e},this.currentSpeed=0,this.maxReachedSpeed=0,this.averageSpeed=0,this.speedHistory=[],this.maxHistoryLength=100,this.previousPosition=null,this.previousTime=Date.now(),this.speedometerContainer=null,this.speedometerCanvas=null,this.digitalDisplay=null,this.ctx=null,this.targetNeedleAngle=0,this.currentNeedleAngle=0,this.needleSmoothing=.1,this.updateLoop=null,this.isRunning=!1,this.wasCarLoaded=!1,this.speedometerVisible=!1,this.onSpeedChange=null,this.onMaxSpeedReached=null,this.lastUpdateTime=Date.now(),this.frameCount=0,this.fps=120}init(){this.createSpeedometerUI(),this.startUpdateLoop(),this.isRunning=!0,this.setVisible(!1),console.log("Speedometer initialized (hidden until car loads)")}checkCarLoadedState(){const t=this.car&&!0===this.car.isLoaded;return t&&!this.wasCarLoaded?(this.setVisible(!0),this.speedometerVisible=!0,console.log("Car loaded - Speedometer now visible")):!t&&this.wasCarLoaded&&(this.setVisible(!1),this.speedometerVisible=!1,console.log("Car unloaded - Speedometer hidden")),this.wasCarLoaded=t,t}createSpeedometerUI(){this.speedometerContainer=document.createElement("div"),this.speedometerContainer.style.position="fixed",this.speedometerContainer.style.left=this.options.position.x+"px",this.speedometerContainer.style.top=this.options.position.y+"px",this.speedometerContainer.style.width=this.options.size+"px",this.speedometerContainer.style.height=this.options.size+"px",this.speedometerContainer.style.zIndex="10000",this.speedometerContainer.style.pointerEvents="none",this.speedometerContainer.style.fontFamily="Arial, sans-serif",(this.options.showBackground||this.options.showNeedle)&&(this.speedometerCanvas=document.createElement("canvas"),this.speedometerCanvas.width=this.options.size,this.speedometerCanvas.height=this.options.size,this.speedometerCanvas.style.position="absolute",this.speedometerCanvas.style.top="-30px",this.speedometerCanvas.style.left="0",this.ctx=this.speedometerCanvas.getContext("2d"),this.speedometerContainer.appendChild(this.speedometerCanvas)),this.options.showDigital&&(this.digitalDisplay=document.createElement("div"),this.digitalDisplay.style.position="absolute",this.digitalDisplay.style.bottom="90px",this.digitalDisplay.style.left="50%",this.digitalDisplay.style.transform="translateX(-50%)",this.digitalDisplay.style.color=this.options.color,this.digitalDisplay.style.fontSize="18px",this.digitalDisplay.style.fontWeight="bold",this.digitalDisplay.style.textAlign="center",this.digitalDisplay.style.padding="5px 10px",this.digitalDisplay.style.minWidth="80px",this.digitalDisplay.textContent=`0 ${this.options.unit}`,this.speedometerContainer.appendChild(this.digitalDisplay)),this.infoDisplay=document.createElement("div"),this.infoDisplay.style.position="absolute",this.infoDisplay.style.top=this.options.size-65+"px",this.infoDisplay.style.left=this.options.size-1490+"px",this.infoDisplay.style.color=this.options.color,this.infoDisplay.style.fontSize="12px",this.infoDisplay.style.fontWeight="bold",this.infoDisplay.style.textAlign="left",this.infoDisplay.style.textShadow=`0 0 3px ${this.options.color}`,this.infoDisplay.style.backgroundColor=this.options.backgroundColor,this.infoDisplay.style.padding="5px",this.infoDisplay.style.borderRadius="3px",this.infoDisplay.style.border=`1px solid ${this.options.color}`,this.infoDisplay.style.minWidth=this.options.size+"px",this.infoDisplay.style.boxSizing="border-box",this.speedometerContainer.appendChild(this.infoDisplay),document.body.appendChild(this.speedometerContainer)}calculateSpeed(){if(!this.car||!this.car.chassisBody||!this.car.isLoaded)return 0;const t=Date.now(),e=this.car.chassisBody.position;if(!this.previousPosition)return this.previousPosition=e.clone(),this.previousTime=t,0;const i=e.distanceTo(this.previousPosition),s=(t-this.previousTime)/1e3;if(0===s)return this.currentSpeed;const n=i/s;let o;return o="mph"===this.options.unit?2.237*n:3.6*n,this.previousPosition=e.clone(),this.previousTime=t,Math.max(0,o)}updateSpeed(){if(!this.checkCarLoadedState())return this.currentSpeed=0,this.targetNeedleAngle=-135,void(this.currentNeedleAngle=-135);const t=this.calculateSpeed();this.currentSpeed=this.currentSpeed+.1*(t-this.currentSpeed),this.currentSpeed>this.maxReachedSpeed&&(this.maxReachedSpeed=this.currentSpeed,this.onMaxSpeedReached&&this.onMaxSpeedReached(this.maxReachedSpeed)),this.speedHistory.push(this.currentSpeed),this.speedHistory.length>this.maxHistoryLength&&this.speedHistory.shift(),this.averageSpeed=this.speedHistory.reduce(((t,e)=>t+e),0)/this.speedHistory.length;const e=Math.min(this.currentSpeed/this.options.maxSpeed,1);this.targetNeedleAngle=270*e-135,this.currentNeedleAngle=this.currentNeedleAngle+(this.targetNeedleAngle-this.currentNeedleAngle)*this.needleSmoothing,this.speedometerVisible&&this.updateSpeedometerUI(),this.onSpeedChange&&this.onSpeedChange(this.currentSpeed,this.maxReachedSpeed,this.averageSpeed)}updateSpeedometerUI(){this.ctx&&this.drawSpeedometer(),this.digitalDisplay&&(this.digitalDisplay.textContent=`${Math.round(this.currentSpeed)} ${this.options.unit}`),this.infoDisplay&&(this.infoDisplay.innerHTML=`\n        <div>Max: ${Math.round(this.maxReachedSpeed)} ${this.options.unit}</div>\n        <div>Avg: ${Math.round(this.averageSpeed)} ${this.options.unit}</div>\n        <div>FPS: ${this.fps}</div>\n      `)}drawSpeedometer(){if(!this.ctx)return;const t=this.options.size/2,e=this.options.size/2,i=this.options.size/2-20;this.ctx.clearRect(0,0,this.options.size,this.options.size),this.options.showBackground&&this.drawBackground(t,e,i),this.drawSpeedMarkings(t,e,i),this.options.showNeedle&&this.drawNeedle(t,e,i),this.drawCenterCircle(t,e)}drawBackground(t,e,i){this.ctx.beginPath(),this.ctx.arc(t,e,i,0,2*Math.PI),this.ctx.fillStyle=this.options.backgroundColor,this.ctx.fill(),this.ctx.strokeStyle=this.options.color,this.ctx.lineWidth=3,this.ctx.stroke();const s=this.ctx.createRadialGradient(t,e,0,t,e,i);s.addColorStop(0,"rgba(0, 0, 0, 0.3)"),s.addColorStop(1,"rgba(0, 0, 0, 0.8)"),this.ctx.fillStyle=s,this.ctx.fill()}drawSpeedMarkings(t,e,i){this.ctx.strokeStyle=this.options.color,this.ctx.font="12px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const s=-135*Math.PI/180,n=135*Math.PI/180-s,o=Math.floor(this.options.maxSpeed/20)+1,r=Math.max(0,o-3),a=Math.max(0,o-7),h=Math.max(0,o-12);Math.max(0,o-18);for(let l=0;l<o;l++){const o=20*l,c=s+o/this.options.maxSpeed*n,d=t+Math.cos(c)*(i-15),u=e+Math.sin(c)*(i-15),p=t+Math.cos(c)*(i-5),m=e+Math.sin(c)*(i-5);this.ctx.beginPath(),this.ctx.moveTo(d,u),this.ctx.lineTo(p,m),this.ctx.lineWidth=2,this.ctx.stroke();const f=t+Math.cos(c)*(i-25),g=e+Math.sin(c)*(i-25);this.ctx.fillStyle=l>=r?this.options.redZoneColor:l>=a?this.options.orangeZoneColor:l>=h?this.options.greenZoneColor:this.options.whiteZoneColor,this.ctx.fillText(o.toString(),f,g)}const l=Math.floor(this.options.maxSpeed/2)+1;for(let o=0;o<l;o++){const r=2*o;if(r%20!=0){const o=s+r/this.options.maxSpeed*n,a=t+Math.cos(o)*(i-10),h=e+Math.sin(o)*(i-10),l=t+Math.cos(o)*(i-5),c=e+Math.sin(o)*(i-5);this.ctx.beginPath(),this.ctx.moveTo(a,h),this.ctx.lineTo(l,c),this.ctx.lineWidth=1,this.ctx.stroke()}}}drawNeedle(t,e,i){const s=this.currentNeedleAngle*Math.PI/180,n=i-20,o=t+Math.cos(s)*n,r=e+Math.sin(s)*n,a=t-40*Math.cos(s),h=e-40*Math.sin(s),l=Math.cos(s+Math.PI/2),c=Math.sin(s+Math.PI/2),d=a+6*l*.5,u=h+6*c*.5,p=a-6*l*.5,m=h-6*c*.5;this.ctx.beginPath(),this.ctx.moveTo(d,u),this.ctx.lineTo(p,m),this.ctx.lineTo(o,r),this.ctx.closePath(),this.ctx.fillStyle="#ff0000",this.ctx.fill()}drawCenterCircle(t,e){this.ctx.beginPath(),this.ctx.arc(t,e,8,0,2*Math.PI),this.ctx.fillStyle=this.options.color,this.ctx.fill(),this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=2,this.ctx.stroke()}startUpdateLoop(){this.updateLoop||(this.updateLoop=setInterval((()=>{this.isRunning&&(this.updateSpeed(),this.updateFPS())}),this.options.updateInterval))}stopUpdateLoop(){this.updateLoop&&(clearInterval(this.updateLoop),this.updateLoop=null)}updateFPS(){const t=Date.now();this.frameCount++,t-this.lastUpdateTime>=1e3&&(this.fps=Math.round(this.frameCount/((t-this.lastUpdateTime)/1e3)),this.frameCount=0,this.lastUpdateTime=t)}start(){this.isRunning=!0,console.log("Speedometer started")}stop(){this.isRunning=!1,console.log("Speedometer stopped")}pause(){this.isRunning=!1,console.log("Speedometer paused")}resume(){this.isRunning=!0,console.log("Speedometer resumed")}reset(){this.currentSpeed=0,this.maxReachedSpeed=0,this.averageSpeed=0,this.speedHistory=[],this.currentNeedleAngle=-135,this.targetNeedleAngle=-135,this.previousPosition=null,this.previousTime=Date.now(),this.updateSpeedometerUI(),console.log("Speedometer reset")}getCurrentSpeed(){return this.currentSpeed}getMaxSpeed(){return this.maxReachedSpeed}getAverageSpeed(){return this.averageSpeed}getSpeedHistory(){return[...this.speedHistory]}setPosition(t,e){this.options.position={x:t,y:e},this.speedometerContainer&&(this.speedometerContainer.style.left=t+"px",this.speedometerContainer.style.top=e+"px")}setMaxSpeed(t){this.options.maxSpeed=t,this.updateSpeedometerUI()}setUnit(t){this.options.unit=t,this.updateSpeedometerUI()}setVisible(t){this.speedometerContainer&&(this.speedometerContainer.style.display=t?"block":"none")}setColor(t){this.options.color=t,this.digitalDisplay&&(this.digitalDisplay.style.color=t,this.digitalDisplay.style.textShadow=`0 0 5px ${t}`,this.digitalDisplay.style.borderColor=t),this.infoDisplay&&(this.infoDisplay.style.color=t,this.infoDisplay.style.textShadow=`0 0 3px ${t}`,this.infoDisplay.style.borderColor=t),this.updateSpeedometerUI()}setRedZoneColor(t){this.options.redZoneColor=t,this.updateSpeedometerUI()}setOrangeZoneColor(t){this.options.orangeZoneColor=t,this.updateSpeedometerUI()}setGreenZoneColor(t){this.options.greenZoneColor=t,this.updateSpeedometerUI()}setOnSpeedChange(t){this.onSpeedChange=t}setOnMaxSpeedReached(t){this.onMaxSpeedReached=t}toggleDigital(){this.options.showDigital=!this.options.showDigital,this.digitalDisplay&&(this.digitalDisplay.style.display=this.options.showDigital?"block":"none")}toggleNeedle(){this.options.showNeedle=!this.options.showNeedle,this.updateSpeedometerUI()}toggleBackground(){this.options.showBackground=!this.options.showBackground,this.updateSpeedometerUI()}isCarLoaded(){return this.car&&!0===this.car.isLoaded}cleanup(){this.stopUpdateLoop(),this.isRunning=!1,this.speedometerContainer&&this.speedometerContainer.parentNode&&this.speedometerContainer.parentNode.removeChild(this.speedometerContainer),this.car=null,this.speedometerContainer=null,this.speedometerCanvas=null,this.digitalDisplay=null,this.infoDisplay=null,this.ctx=null,console.log("Speedometer cleaned up")}}class Ey{followTarget=new us;pivot;constructor(t,e,i,s={x:0,y:1,z:0},n=null,o){this.scene=t,this.world=e,this.loadingManager=o,this.startPosition=new Ud(s.x,s.y,s.z),this.car={},this.chassis={},this.wheels=[],this.chassisDimension={x:2.7,y:1,z:7},this.chassisModelPos={x:0,y:0,z:0},this.wheelScale={frontWheel:1.1,hindWheel:1.1},this.mass=500,this.pivot=i,this.maxForce=1800,this.speedMultiplier=1.5,this.brakeLight=null,this.originalBrakeLightMaterial=null,this.isBraking=!1,this.isReversing=!1,this.mixer=null,this.boostAnimation=null,this.isBoostAnimationPlaying=!1,this.animationClock=new qc,this.isDrifting=!1,this.normalFriction=2,this.driftFriction=.05,this.driftSteerMultiplier=1,this.flipCheckInterval=100,this.flipThreshold=Math.PI/3,this.timeUpsideDown=0,this.flipResetDelay=2e3,this.lastFlipCheck=0,this.isFlipped=!1,this.currentFlipType="upright",this.health=n,this.wasDestroyed=!1,this.controlsDisabled=!1,this.loader=new hy(5,"Loading Car Models..."),this.isLoaded=!1,this.loader.setOnComplete((()=>{this.isLoaded=!0,console.log("Car models loaded successfully!")}))}setupAnimations(t){if(t.animations&&t.animations.length>0){this.mixer=new md(this.chassis);const e=t.animations.find((t=>t.name.includes("Boost")));e?(this.boostAnimation=this.mixer.clipAction(e),this.boostAnimation.setLoop(_e),this.boostAnimation.clampWhenFinished=!1,console.log("Boost animation found and setup:",e.name)):console.warn("Boost animation not found. Available animations:",t.animations.map((t=>t.name)))}else console.warn("No animations found in the GLTF model")}playBoostAnimation(){this.boostAnimation&&!this.isBoostAnimationPlaying&&(this.boostAnimation.reset(),this.boostAnimation.play(),this.isBoostAnimationPlaying=!0,console.log("Boost animation started"))}stopBoostAnimation(){this.boostAnimation&&this.isBoostAnimationPlaying&&(this.boostAnimation.stop(),this.isBoostAnimationPlaying=!1,console.log("Boost animation stopped"))}updateAnimations(){if(this.mixer){const t=this.animationClock.getDelta();this.mixer.update(t)}}createChassisWireframe(){const t=new gh(this.chassisDimension.x,this.chassisDimension.y,this.chassisDimension.z),e=new Os({color:16711680,wireframe:!0,transparent:!0,opacity:.8});this.chassisWireframe=new Cn(t,e),this.chassisWireframe.visible=!1,this.scene.add(this.chassisWireframe),console.log("Chassis wireframe created with dimensions:",this.chassisDimension)}createChassisWireframeEdges(){const t=new gh(this.chassisDimension.x,this.chassisDimension.y,this.chassisDimension.z),e=new bh(t),i=new Va({color:65280,linewidth:2});this.chassisWireframe=new Ja(e,i),this.scene.add(this.chassisWireframe),console.log("Chassis wireframe edges created with dimensions:",this.chassisDimension)}startDrift(){this.isDrifting||(this.isDrifting=!0,this.car.wheelInfos&&this.car.wheelInfos.length>=4&&(this.car.wheelInfos[0].frictionSlip=this.driftFriction,this.car.wheelInfos[1].frictionSlip=this.driftFriction,this.car.wheelInfos[2].frictionSlip=this.normalFriction,this.car.wheelInfos[3].frictionSlip=this.normalFriction),console.log("Drift mode activated!"))}stopDrift(){if(this.isDrifting){if(this.isDrifting=!1,this.car.wheelInfos&&this.car.wheelInfos.length>=4)for(let t=0;t<4;t++)this.car.wheelInfos[t].frictionSlip=this.normalFriction;console.log("Drift mode deactivated.")}}checkIfFlipped(){if(!this.car.chassisBody)return!1;const t=new Ud(0,1,0);return this.car.chassisBody.quaternion.vmult(t,t),t.y<.3}checkFlipByRotation(){if(!this.car.chassisBody)return!1;const t=new Yi,e=new ui(this.car.chassisBody.quaternion.x,this.car.chassisBody.quaternion.y,this.car.chassisBody.quaternion.z,this.car.chassisBody.quaternion.w);t.setFromQuaternion(e);const i=Math.abs(t.z),s=Math.abs(t.x),n=Math.min(i,Math.PI-i),o=Math.min(s,Math.PI-s),r=Math.PI/3;return n>r||o>r}checkFlipByGroundContact(){if(!this.car.chassisBody)return!1;const t=new Ud(0,1,0);this.car.chassisBody.quaternion.vmult(t,t);const e=t.y>.3;if(this.car.wheelInfos&&4===this.car.wheelInfos.length){let t=0;const i=this.car.chassisBody.position.y;for(let e=0;e<4;e++)this.car.wheelInfos[e]&&this.car.wheelInfos[e].worldTransform&&this.car.wheelInfos[e].worldTransform.position.y>i+.5&&t++;return!(e&&t<3)}return!e}getFlipType(){if(!this.car.chassisBody)return"none";const t=new Yi,e=new ui(this.car.chassisBody.quaternion.x,this.car.chassisBody.quaternion.y,this.car.chassisBody.quaternion.z,this.car.chassisBody.quaternion.w);t.setFromQuaternion(e);const i=t.z,s=t.x,n=new Ud(0,1,0);return this.car.chassisBody.quaternion.vmult(n,n),n.y<-.5?"upside_down":Math.abs(i)>Math.PI/3?i>0?"right_side":"left_side":Math.abs(s)>Math.PI/3?s>0?"nose_down":"nose_up":n.y<.3?"tilted":"upright"}handleFlipDetection(t){const e=performance.now();if(e-this.lastFlipCheck<this.flipCheckInterval)return;this.lastFlipCheck=e;const i=this.checkFlipByGroundContact(),s=this.getFlipType();if(i)if(this.isFlipped){if(this.timeUpsideDown+=this.flipCheckInterval,this.timeUpsideDown%1e3==0){const t=(this.flipResetDelay-this.timeUpsideDown)/1e3;console.log(`Auto-reset in ${t} seconds... (${s})`)}this.timeUpsideDown>=this.flipResetDelay&&(console.log(`Car has been ${s} for too long. Auto-resetting...`),this.autoReset(s))}else this.isFlipped=!0,this.timeUpsideDown=0,console.log(`Car flipped! Type: ${s}. Starting countdown...`);else this.isFlipped&&(this.isFlipped=!1,this.timeUpsideDown=0,console.log("Car recovered from flip."))}autoReset(t="unknown"){const e=this.car.chassisBody.position;let i=3;"upside_down"===t?i=4:"left_side"!==t&&"right_side"!==t||(i=3.5),this.car.chassisBody.position.set(e.x,e.y+i,e.z);const s=this.car.chassisBody.quaternion,n=new Yi,o=new ui(s.x,s.y,s.z,s.w);n.setFromQuaternion(o);const r=new Ud(0,n.y,0),a=new Kd;a.setFromEuler(r.x,r.y,r.z),this.car.chassisBody.quaternion.copy(a),this.car.chassisBody.angularVelocity.set(0,0,0),this.car.chassisBody.velocity.set(0,0,0),this.isFlipped=!1,this.timeUpsideDown=0,console.log(`Car auto-reset completed. Was: ${t}, now upright at:`,e)}setupFrontLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup front light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.frontLights=[],this.originalFrontLightMaterials=new Map,this.frontLightObjects=[],this.frontLightFlares=[],this.isFrontLightOn=!1,this.chassis.traverse((e=>{if("Object_1"===e.name){this.frontLights.push(e),this.frontLightObjects.push(e),e.material&&this.originalFrontLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16777215,transparent:!0,opacity:.9,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16777130,transparent:!0,opacity:.7,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1.5,1.5,1.5),n.visible=!1;const o=new Ma(s);o.scale.set(1.5,1.5,1.5),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.8);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.frontLightFlares.push([n,o]),console.log(`Front light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.frontLights.length&&console.warn("Front lights not found in chassis model - check object names")}toggleFrontLight(){this.isFrontLightOn?this.deactivateFrontLight():this.activateFrontLight()}activateFrontLight(){if(this.frontLights&&!this.isFrontLightOn){this.isFrontLightOn=!0;const t=new cl({color:16777215,emissive:new Ds(1,1,.9).multiplyScalar(.6),emissiveIntensity:15});this.frontLights.forEach((e=>{e.material=t})),this.frontLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Front lights activated (with lens flare)")}}deactivateFrontLight(){this.frontLights&&this.isFrontLightOn&&(this.isFrontLightOn=!1,this.frontLights.forEach((t=>{const e=this.originalFrontLightMaterials.get(t);e&&(t.material=e)})),this.frontLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Front lights deactivated (original state)"))}updateFrontLightFlarePositions(){this.frontLights&&this.frontLightFlares&&this.frontLights.forEach(((t,e)=>{if(this.frontLightFlares[e]){const[i,s]=this.frontLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(-.85,-.4,3.1),o=new pi(.85,-.4,3.1);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(.5),r=n.clone().multiplyScalar(.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustFrontFlarePosition(t,e,i,s,n){if(this.frontLightFlares&&this.frontLightFlares[t]){const o=this.frontLightFlares[t];if(o[e]){const r=o[e],a=this.frontLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Front Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothFrontFlares(t,e,i){this.adjustFrontFlarePosition(t,0,e.x,e.y,e.z),this.adjustFrontFlarePosition(t,1,i.x,i.y,i.z)}handleFrontLightToggle(t){"l"!==t.key&&"L"!==t.key||this.toggleFrontLight()}setupFrontLightKeyListener(){document.addEventListener("keydown",(t=>{this.handleFrontLightToggle(t)})),console.log("Front light key listener setup - Press 'L' to toggle front lights")}setupBrakeLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup brake light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.brakeLights=[],this.originalBrakeLightMaterials=new Map,this.brakeLightObjects=[],this.brakeLightFlares=[],this.chassis.traverse((e=>{if("Object_3"===e.name){this.brakeLights.push(e),this.brakeLightObjects.push(e),e.material&&this.originalBrakeLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16711680,transparent:!0,opacity:.8,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16711680,transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1,1,1),n.visible=!1;const o=new Ma(s);o.scale.set(1,1,1),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.3);n.position.copy(r).add(a);const h=new pi(0,0,.3);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.brakeLightFlares.push([n,o]),console.log(`Brake light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.brakeLights.length&&console.warn("Brake lights (Object_29 / Object_33) not found in chassis model")}activateBrakeLight(){if(this.brakeLights&&!this.isBraking){this.isBraking=!0;const t=new cl({color:16711680,emissive:new Ds(1,0,0).multiplyScalar(.5),emissiveIntensity:10});this.brakeLights.forEach((e=>{e.material=t})),this.brakeLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Brake lights activated (with lens flare)")}}deactivateBrakeLight(){this.brakeLights&&this.isBraking&&(this.isBraking=!1,this.brakeLights.forEach((t=>{const e=this.originalBrakeLightMaterials.get(t);e&&(t.material=e)})),this.brakeLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Brake lights deactivated (original state)"))}updateBrakeLightFlarePositions(){this.brakeLights&&this.brakeLightFlares&&this.brakeLights.forEach(((t,e)=>{if(this.brakeLightFlares[e]){const[i,s]=this.brakeLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(.9,-.1,-3.2),o=new pi(-.9,-.1,-3.2);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(-.3),r=n.clone().multiplyScalar(-.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustBrakeFlarePosition(t,e,i,s,n){if(this.brakeLightFlares&&this.brakeLightFlares[t]){const o=this.brakeLightFlares[t];if(o[e]){const r=o[e],a=this.brakeLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Brake Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothBrakeFlares(t,e,i){this.adjustBrakeFlarePosition(t,0,e.x,e.y,e.z),this.adjustBrakeFlarePosition(t,1,i.x,i.y,i.z)}setupReverseLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup reverse light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.reverseLights=[],this.originalReverseLightMaterials=new Map,this.reverseLightObjects=[],this.reverseLightFlares=[],this.chassis.traverse((e=>{if("Object_2"===e.name){this.reverseLights.push(e),this.reverseLightObjects.push(e),e.material&&this.originalReverseLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16777215,transparent:!0,opacity:.8,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16777215,transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1,1,1),n.visible=!1;const o=new Ma(s);o.scale.set(1,1,1),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.3);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.reverseLightFlares.push([n,o]),console.log(`Reverse light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.reverseLights.length&&console.warn("Reverse lights not found in chassis model")}activateReverseLight(){if(this.reverseLights&&!this.isReversing){this.isReversing=!0;const t=new cl({color:16711680,emissive:new Ds(1,0,0).multiplyScalar(.5),emissiveIntensity:50});this.reverseLights.forEach((e=>{e.material=t})),this.reverseLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Reverse lights activated (with lens flare)")}}deactivateReverseLight(){this.reverseLights&&this.isReversing&&(this.isReversing=!1,this.reverseLights.forEach((t=>{const e=this.originalReverseLightMaterials.get(t);e&&(t.material=e)})),this.reverseLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Reverse lights deactivated (original state)"))}updateReverseLightFlarePositions(){this.reverseLights&&this.reverseLightFlares&&this.reverseLights.forEach(((t,e)=>{if(this.reverseLightFlares[e]){const[i,s]=this.reverseLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(.65,-.2,-3.2),o=new pi(-.65,-.2,-3.2);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(-.3),r=n.clone().multiplyScalar(-.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustFlarePosition(t,e,i,s,n){if(this.reverseLightFlares&&this.reverseLightFlares[t]){const o=this.reverseLightFlares[t];if(o[e]){const r=o[e],a=this.reverseLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothFlares(t,e,i){this.adjustFlarePosition(t,0,e.x,e.y,e.z),this.adjustFlarePosition(t,1,i.x,i.y,i.z)}init(t=null){this.health=t,this.loader.show(),this.loadModels(),this.setChassis(),this.setWheels(),this.controls(),this.update(),this.createChassisWireframe()}loadModels(){const t=new Zg(this.loadingManager),e=new Kg(this.loadingManager);e.setDecoderConfig({type:"js"}),e.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/"),t.setDRACOLoader(e),t.load("./car/bmw_m4.glb",(t=>{this.chassis=t.scene,this.chassis.traverse((function(t){t.isMesh&&(t.castShadow=!0,t.recieveShadow=!0)})),this.chassis.scale.set(1,1,1),this.scene.add(this.chassis),this.setupBrakeLight(),this.setupReverseLight(),this.setupFrontLight(),this.setupFrontLightKeyListener(),this.setupAnimations(t),this.loader.updateProgress(1,"Chassis")}),(t=>{console.log("Chassis loading progress:",t.loaded/t.total*100+"%")}),(t=>{console.error("Error loading chassis:",t),this.loader.setTitle("Error loading chassis model"),this.loader.setDetails("Please check the model file path")})),this.wheels=[];for(let e=0;e<4;e++)t.load("./car/bmw_m4_wheel.glb",(t=>{const i=t.scene;this.wheels[e]=i,1===e||3===e?this.wheels[e].scale.set(-1.4*this.wheelScale.frontWheel,1.4*this.wheelScale.frontWheel,-1.4*this.wheelScale.frontWheel):this.wheels[e].scale.set(1.4*this.wheelScale.frontWheel,1.4*this.wheelScale.frontWheel,1.4*this.wheelScale.frontWheel),this.scene.add(this.wheels[e]),this.loader.updateProgress(1,`Wheel ${e+1}`)}),(t=>{console.log(`Wheel ${e} loading progress:`,t.loaded/t.total*100+"%")}),(t=>{console.error(`Error loading wheel ${e}:`,t),this.loader.setTitle(`Error loading wheel ${e+1}`),this.loader.setDetails("Please check the wheel model file path")}))}setChassis(){const t=new hu(new Ud(.5*this.chassisDimension.x,.5*this.chassisDimension.y,.5*this.chassisDimension.z)),e=new Op({friction:.3,restitution:.1}),i=new du({mass:this.mass,material:e,type:du.DYNAMIC,collisionFilterGroup:1,collisionFilterMask:1});i.linearDamping=.1,i.angularDamping=.1,i.addShape(t),i.position.set(this.startPosition.x,this.startPosition.y,this.startPosition.z);const s=new Ud(0,-Math.PI/2,0),n=new Kd;n.setFromEuler(s.x,s.y,s.z),i.quaternion.copy(n),this.world.addBody(i),this.car=new Up({chassisBody:i,indexRightAxis:0,indexUpAxis:1,indexForwardAxis:2}),i.userData={type:"car",car:this},this.car.addToWorld(this.world),this.chassisBody=i}setWheels(){this.car.wheelInfos=[];const t=[new Ud(1.15,-.5,-1.9),new Ud(-1.15,-.5,-1.9),new Ud(1.15,-.5,2.2),new Ud(-1.15,-.5,2.2)];for(let e=0;e<4;e++)this.car.addWheel({radius:.45,directionLocal:new Ud(0,-1,0),suspensionStiffness:30,suspensionRestLength:.3,frictionSlip:2.5,dampingRelaxation:2.3,dampingCompression:4.3,maxSuspensionForce:1e5,rollInfluence:.01,axleLocal:new Ud(-1,0,0),chassisConnectionPointLocal:t[e],maxSuspensionTravel:.3,customSlidingRotationalSpeed:30,useCustomSlidingRotationalSpeed:!0})}ensureGroundExists(){if(!this.groundBody){const t=new mm;this.groundBody=new du({mass:0,material:new Op({friction:.4,restitution:.3})}),this.groundBody.addShape(t),this.groundBody.quaternion.setFromAxisAngle(new Ud(1,0,0),-Math.PI/2),this.groundBody.collisionFilterGroup=2,this.groundBody.collisionFilterMask=-1,this.world.addBody(this.groundBody)}}setHealthSystem(t){this.health=t,console.log("Health system attached to car")}controls(){const t=.5,e=[];this.previousPosition=null,this.previousTime=null,this.currentSpeed=0,this.maxReachedSpeed=0,this.speedHistory=[],this.maxHistoryLength=10,this.averageSpeed=0,this.options={unit:"mph",maxSpeed:180},this.needleSmoothing=.1,this.currentNeedleAngle=-135,this.targetNeedleAngle=-135,this.accelerationPhase=0,this.isInGearShift=!1,this.gearShiftTimer=0,this.gearShiftDuration=150,this.lastGearShiftTime=0,this.accelerationStartTime=0,this.wasAcceleratingPreviously=!1,this.accelerationPhases=[{maxForce:2800,duration:600},{maxForce:2600,duration:1200},{maxForce:2400,duration:1800},{maxForce:2200,duration:2400},{maxForce:2e3,duration:1/0}],this.sounds={drifting:null,gearShift:null,brake:null,backfire:null},this.activeSounds=new Set,this.soundStates={drifting:!1,brake:!1},this.backfireSystem={lastBackfireTime:0,backfireChance:.3,backfireCooldown:2e3,highSpeedBackfireChance:.6,highSpeedThreshold:60,gearShiftBackfireChance:.4,engineOffBackfireChance:.7,lastEngineState:!1,wasAcceleratingRecently:!1,recentAccelerationTime:0},this.fadeOutTimer=null,this.fadeOutDuration=300,this.fadeInDuration=150,this.speedThreshold=2,this.lastSoundChangeTime=0,this.soundChangeDelay=50,this.isMoving=!1,this.wasMoving=!1,this.isDriftingNow=!1,this.wasDriftingPreviously=!1,this.driftStartTime=0,this.driftMinDuration=100,this.lastDriftEndTime=0,this.driftCooldown=200,this.speedThresholds={deceleration:{min:0,max:50}},this.initSounds=()=>{this.sounds.drifting=new Audio("./sounds/fer_drift.wav"),this.sounds.gearShift=new Audio("./sounds/fer_gear.mp3"),this.sounds.brake=new Audio("./sounds/fer_brake.mp3"),this.sounds.backfire=new Audio("./sounds/backfire.mp3"),this.sounds.drifting.loop=!0,this.sounds.brake.loop=!1,this.sounds.backfire.loop=!1,this.sounds.drifting.volume=.6,this.sounds.gearShift.volume=.3,this.sounds.brake.volume=1,this.sounds.backfire.volume=.8,Object.keys(this.sounds).forEach((t=>{this.sounds[t]&&this.sounds[t].addEventListener("error",(e=>{console.warn(`Failed to load ${t} sound:`,e)}))}))},this.initSounds(),this.calculateSpeed=()=>{if(!this.car||!this.car.chassisBody)return 0;const t=Date.now(),e=this.car.chassisBody.position;if(!this.previousPosition)return this.previousPosition=e.clone(),this.previousTime=t,0;const i=e.distanceTo(this.previousPosition),s=(t-this.previousTime)/1e3;if(0===s)return this.currentSpeed;const n=i/s;let o;return o="mph"===this.options.unit?2.237*n:3.6*n,this.previousPosition=e.clone(),this.previousTime=t,Math.max(0,o)},this.updateSpeed=()=>{const t=this.calculateSpeed();this.currentSpeed=this.currentSpeed+.1*(t-this.currentSpeed),this.currentSpeed>this.maxReachedSpeed&&(this.maxReachedSpeed=this.currentSpeed,this.onMaxSpeedReached&&this.onMaxSpeedReached(this.maxReachedSpeed)),this.speedHistory.push(this.currentSpeed),this.speedHistory.length>this.maxHistoryLength&&this.speedHistory.shift(),this.averageSpeed=this.speedHistory.reduce(((t,e)=>t+e),0)/this.speedHistory.length;const e=Math.min(this.currentSpeed/this.options.maxSpeed,1);this.targetNeedleAngle=270*e-135,this.currentNeedleAngle=this.currentNeedleAngle+(this.targetNeedleAngle-this.currentNeedleAngle)*this.needleSmoothing,this.updateSpeedometerUI&&this.updateSpeedometerUI(),this.onSpeedChange&&this.onSpeedChange(this.currentSpeed,this.maxReachedSpeed,this.averageSpeed)},this.startSound=(t,e=null,i=!1)=>{if(!this.sounds[t]||!i&&this.soundStates[t])return;const s=this.sounds[t],n=e||this.getOriginalVolume(t);s.fadeInterval&&clearInterval(s.fadeInterval),s.volume=0,s.currentTime=0;const o=s.play();o&&o.catch((e=>console.log(`${t} audio play failed:`,e))),this.soundStates[t]=!0,this.activeSounds.add(t);const r=n/(this.fadeInDuration/20);s.fadeInterval=setInterval((()=>{s.volume=Math.min(n,s.volume+r),s.volume>=n&&(clearInterval(s.fadeInterval),s.fadeInterval=null)}),20)},this.stopSound=(t,e=null,i=!1)=>{if(!this.sounds[t]||!i&&!this.soundStates[t])return void(e&&e());const s=this.sounds[t];if(s.fadeInterval&&clearInterval(s.fadeInterval),s.paused||0===s.volume)return this.soundStates[t]=!1,this.activeSounds.delete(t),void(e&&e());const n=s.volume/(this.fadeOutDuration/20);s.fadeInterval=setInterval((()=>{s.volume=Math.max(0,s.volume-n),s.volume<=0&&(clearInterval(s.fadeInterval),s.fadeInterval=null,s.pause(),s.currentTime=0,s.volume=this.getOriginalVolume(t),this.soundStates[t]=!1,this.activeSounds.delete(t),e&&e())}),20)},this.playGearShiftSound=()=>{if(this.sounds.gearShift){const t=new Audio("./sounds/fer_gear.mp3");t.volume=.3,t.currentTime=0,t.play().catch((t=>console.log("Gear shift sound failed:",t))),this.tryPlayBackfire("gearshift")}},this.tryPlayBackfire=(t="random")=>{const e=Date.now();if(e-this.backfireSystem.lastBackfireTime<this.backfireSystem.backfireCooldown)return;let i=0;switch(t){case"gearshift":i=this.backfireSystem.gearShiftBackfireChance;break;case"engineoff":i=this.backfireSystem.engineOffBackfireChance;break;case"deceleration":i=this.currentSpeed>this.backfireSystem.highSpeedThreshold?this.backfireSystem.highSpeedBackfireChance:this.backfireSystem.backfireChance;break;default:i=this.backfireSystem.backfireChance}Math.random()<i&&(this.playBackfireSound(),this.backfireSystem.lastBackfireTime=e,console.log(`BACKFIRE triggered by: ${t}`))},this.playBackfireSound=()=>{if(this.sounds.backfire){const t=new Audio("./sounds/backfire.mp3");t.volume=.8,t.currentTime=0,t.play().catch((t=>console.log("Backfire sound failed:",t)))}},this.getOriginalVolume=t=>({drifting:.6,gearShift:.3,brake:1,backfire:.8}[t]||.5),this.stopAllSounds=(t=!1)=>{Object.keys(this.sounds).forEach((e=>{if(this.sounds[e]){const i=this.sounds[e];i.fadeInterval&&clearInterval(i.fadeInterval),t?(i.pause(),i.currentTime=0,i.volume=this.getOriginalVolume(e),this.soundStates[e]=!1):this.stopSound(e,null,!0)}})),this.activeSounds.clear()},this.isCarSpeedLow=()=>this.currentSpeed<5,this.updateSound=()=>{const t=Date.now(),i=this.currentSpeed;this.isMoving=i>this.speedThreshold;const s=e.includes("w")||e.includes("arrowup"),n=e.includes("s")||e.includes("arrowdown"),o=e.includes(" "),r=e.includes("a")||e.includes("arrowleft"),a=e.includes("d")||e.includes("arrowright"),h=s||n;if(this.backfireSystem.lastEngineState&&!h&&this.isMoving&&this.tryPlayBackfire("engineoff"),s)this.backfireSystem.wasAcceleratingRecently=!0,this.backfireSystem.recentAccelerationTime=t;else if(this.backfireSystem.wasAcceleratingRecently){const e=t-this.backfireSystem.recentAccelerationTime;e<1e3&&this.isMoving&&i>20?(this.tryPlayBackfire("deceleration"),this.backfireSystem.wasAcceleratingRecently=!1):e>2e3&&(this.backfireSystem.wasAcceleratingRecently=!1)}this.backfireSystem.lastEngineState=h;const l=o&&(r||a)&&s&&this.isMoving,c=o&&!r&&!a&&this.isMoving&&!s;l&&!this.isDriftingNow?t-this.lastDriftEndTime>this.driftCooldown&&(this.isDriftingNow=!0,this.driftStartTime=t,this.stopSound("brake",null,!0),this.startSound("drifting",null,!0),console.log("DRIFT START")):!l&&this.isDriftingNow&&t-this.driftStartTime>this.driftMinDuration&&(this.isDriftingNow=!1,this.lastDriftEndTime=t,this.stopSound("drifting",null,!0),console.log("DRIFT STOP")),!c||this.isDriftingNow||this.soundStates.brake?c&&!this.isDriftingNow||!this.soundStates.brake||(this.stopSound("brake"),console.log("BRAKE STOP")):(this.startSound("brake"),console.log("BRAKE START")),this.soundStates.drifting&&(!o||!this.isMoving||i<3)&&(this.stopSound("drifting",null,!0),this.isDriftingNow=!1,console.log("DRIFT FORCE STOP - Safety check")),this.wasDriftingPreviously=this.isDriftingNow,this.wasMoving=this.isMoving},this.updateAcceleration=()=>{const t=Date.now(),i=e.includes("w")||e.includes("arrowup");if(i&&!this.wasAcceleratingPreviously&&(this.accelerationPhase=0,this.accelerationStartTime=t,this.isInGearShift=!1,this.gearShiftTimer=0),i){const e=t-this.accelerationStartTime;if(!this.isInGearShift&&this.accelerationPhase<4){const t=this.accelerationPhases[this.accelerationPhase];(this.accelerationPhase>0&&e>=t.duration||0===this.accelerationPhase&&e>=100)&&this.startGearShift()}this.isInGearShift&&t-this.lastGearShiftTime>=this.gearShiftDuration&&this.completeGearShift(),this.wasAcceleratingPreviously=!0}else this.accelerationPhase=0,this.isInGearShift=!1,this.wasAcceleratingPreviously=!1},this.startGearShift=()=>{this.isInGearShift=!0,this.lastGearShiftTime=Date.now(),this.playGearShiftSound()},this.completeGearShift=()=>{this.isInGearShift=!1,this.accelerationPhase=Math.min(this.accelerationPhase+1,4),this.accelerationStartTime=Date.now()},this.getCurrentMaxForce=()=>this.isInGearShift?.3*this.accelerationPhases[this.accelerationPhase].maxForce:this.accelerationPhases[this.accelerationPhase].maxForce,window.addEventListener("keydown",(t=>{this.isLoaded&&(e.includes(t.key.toLowerCase())||e.push(t.key.toLowerCase()),i())})),window.addEventListener("keyup",(t=>{this.isLoaded&&(e.splice(e.indexOf(t.key.toLowerCase()),1),i())}));const i=()=>{if(this.controlsDisabled)return;this.updateSpeed(),this.updateAcceleration(),e.includes("f")&&(this.toggleWireframe(),e.splice(e.indexOf("f"),1));const i=e.includes("w")||e.includes("arrowup"),r=e.includes(" "),a=e.includes("a")||e.includes("arrowleft"),h=e.includes("d")||e.includes("arrowright"),l=r&&(a||h)&&i&&this.isMoving;if(l&&!this.isDrifting?this.startDrift():!l&&this.isDrifting&&this.stopDrift(),!r||l){r?l&&this.activateBrakeLight():this.deactivateBrakeLight(),this.car.setBrake(0,0),this.car.setBrake(0,1),this.car.setBrake(0,2),this.car.setBrake(0,3);const i=this.isDrifting?this.driftSteerMultiplier:1;if(a?(this.car.setSteeringValue(t*i,2),this.car.setSteeringValue(t*i,3)):h?(this.car.setSteeringValue(t*-i,2),this.car.setSteeringValue(t*-i,3)):o(),e.includes("w")||e.includes("arrowup")){const t=this.getCurrentMaxForce();this.car.applyEngineForce(-1*t,0),this.car.applyEngineForce(-1*t,1),this.car.applyEngineForce(-1*t,2),this.car.applyEngineForce(-1*t,3)}else e.includes("s")||e.includes("arrowdown")?(l||this.activateReverseLight(),this.car.applyEngineForce(1*this.maxForce,0),this.car.applyEngineForce(1*this.maxForce,1),this.car.applyEngineForce(1*this.maxForce,2),this.car.applyEngineForce(1*this.maxForce,3)):(this.car.applyEngineForce(0,0),this.car.applyEngineForce(0,1),this.car.applyEngineForce(0,2),this.car.applyEngineForce(0,3),this.deactivateReverseLight(),l||n())}else this.activateBrakeLight(),s();this.updateSound()},s=()=>{this.car.setBrake(45,0),this.car.setBrake(45,1),this.car.setBrake(45,2),this.car.setBrake(45,3)},n=()=>{this.car.setBrake(25,0),this.car.setBrake(25,1),this.car.setBrake(25,2),this.car.setBrake(25,3)},o=()=>{this.car.setSteeringValue(0,2),this.car.setSteeringValue(0,3)};this.cleanup=()=>{Object.keys(this.sounds).forEach((t=>{if(this.sounds[t]){const e=this.sounds[t];e.fadeInterval&&clearInterval(e.fadeInterval),e.pause(),e.currentTime=0,e.volume=this.getOriginalVolume(t)}})),this.activeSounds.clear(),Object.keys(this.soundStates).forEach((t=>{this.soundStates[t]=!1})),this.isDriftingNow=!1,this.wasDriftingPreviously=!1,this.driftStartTime=0,this.lastDriftEndTime=0,this.fadeOutTimer&&clearTimeout(this.fadeOutTimer),console.log("CLEANUP COMPLETE - All sounds stopped")}}checkHealthStatus(){if(!this.health)return;const t=this.health.isDestroyed;t&&!this.wasDestroyed?(console.log("Car destroyed! Stopping all sounds and disabling controls."),this.onCarDestroyed()):!t&&this.wasDestroyed&&(console.log("Car repaired! Re-enabling controls."),this.onCarRepaired()),this.wasDestroyed=t}onCarDestroyed(){this.stopAllSounds(),this.controlsDisabled=!0,this.car&&this.car.chassisBody&&(this.car.setBrake(0,0),this.car.setBrake(100,1),this.car.setBrake(500,2),this.car.setBrake(0,3),this.car.applyEngineForce(0,0),this.car.applyEngineForce(0,1),this.car.applyEngineForce(0,2),this.car.applyEngineForce(0,3),this.car.setSteeringValue(0,2),this.car.setSteeringValue(0,3)),this.stopDrift(),this.activateBrakeLight()}onCarRepaired(){this.controlsDisabled=!1,this.car&&(this.car.setBrake(0,0),this.car.setBrake(0,1),this.car.setBrake(0,2),this.car.setBrake(0,3)),this.playSound("idle")}update(){this.world.addEventListener("postStep",(()=>{if(this.updateAnimations(),this.handleFlipDetection(),this.checkHealthStatus(),this.updateReverseLightFlarePositions(),this.updateBrakeLightFlarePositions(),this.updateFrontLightFlarePositions(),this.car.wheelInfos&&this.chassis.position&&this.wheels[0]?.position){this.chassis.position.set(this.car.chassisBody.position.x+this.chassisModelPos.x,this.car.chassisBody.position.y+this.chassisModelPos.y,this.car.chassisBody.position.z+this.chassisModelPos.z),this.chassis.quaternion.copy(this.car.chassisBody.quaternion),this.chassisWireframe&&(this.chassisWireframe.position.copy(this.car.chassisBody.position),this.chassisWireframe.quaternion.copy(this.car.chassisBody.quaternion));for(let t=0;t<4;t++)this.car.wheelInfos[t]&&(this.car.updateWheelTransform(t),this.wheels[t].position.copy(this.car.wheelInfos[t].worldTransform.position),this.wheels[t].quaternion.copy(this.car.wheelInfos[t].worldTransform.quaternion))}}))}toggleWireframe(t=null){this.chassisWireframe&&(this.chassisWireframe.visible=null!==t?t:!this.chassisWireframe.visible,console.log("Chassis wireframe visibility:",this.chassisWireframe.visible))}removeWireframe(){this.chassisWireframe&&(this.scene.remove(this.chassisWireframe),this.chassisWireframe.geometry.dispose(),this.chassisWireframe.material.dispose(),this.chassisWireframe=null,console.log("Chassis wireframe removed"))}forceFlipReset(){console.log("Manual flip reset triggered"),this.autoReset()}getFlipStatus(){return{isFlipped:this.isFlipped,timeUpsideDown:this.timeUpsideDown,resetProgress:this.timeUpsideDown/this.flipResetDelay}}cleanup(){console.log("Starting car cleanup..."),this.stopAllSounds(),this.sounds&&(Object.values(this.sounds).forEach((t=>{t&&(t.pause(),t.currentTime=0,t.src="",t.removeEventListener("ended",t.onended))})),this.sounds={}),this.mixer&&(this.mixer.stopAllAction(),this.mixer.uncacheRoot(this.mixer.getRoot()),this.mixer=null),this.boostAnimation=null,this.car&&this.car.chassisBody&&(this.car.removeFromWorld(this.world),this.world.removeBody(this.car.chassisBody)),this.chassis&&(this.chassis.traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose())})),this.scene.remove(this.chassis),this.chassis=null),this.wheels&&this.wheels.length>0&&(this.wheels.forEach((t=>{t&&(t.traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose())})),this.scene.remove(t))})),this.wheels=[]),this.removeWireframe(),this.brakeLight=null,this.originalBrakeLightMaterial&&(this.originalBrakeLightMaterial.dispose(),this.originalBrakeLightMaterial=null),this.followTarget&&(this.scene.remove(this.followTarget),this.followTarget=null),this.isDrifting=!1,this.isBraking=!1,this.isFlipped=!1,this.controlsDisabled=!1,this.wasDestroyed=!1,this.timeUpsideDown=0,this.lastFlipCheck=0,this.car=null,this.scene=null,this.world=null,this.health=null,this.pivot=null,console.log("Car cleanup completed")}}class Ly{followTarget=new us;pivot;constructor(t,e,i,s={x:0,y:1,z:0},n=null,o){this.scene=t,this.world=e,this.loadingManager=o,this.startPosition=new Ud(s.x,s.y,s.z),this.car={},this.chassis={},this.wheels=[],this.chassisDimension={x:2.7,y:1,z:7},this.chassisModelPos={x:0,y:0,z:0},this.wheelScale={frontWheel:1.1,hindWheel:1.1},this.mass=500,this.pivot=i,this.maxForce=1800,this.speedMultiplier=1.5,this.brakeLight=null,this.originalBrakeLightMaterial=null,this.isBraking=!1,this.isReversing=!1,this.mixer=null,this.boostAnimation=null,this.isBoostAnimationPlaying=!1,this.animationClock=new qc,this.isDrifting=!1,this.normalFriction=2,this.driftFriction=.05,this.driftSteerMultiplier=1,this.flipCheckInterval=100,this.flipThreshold=Math.PI/3,this.timeUpsideDown=0,this.flipResetDelay=2e3,this.lastFlipCheck=0,this.isFlipped=!1,this.currentFlipType="upright",this.health=n,this.wasDestroyed=!1,this.controlsDisabled=!1,this.loader=new hy(5,"Loading Car Models..."),this.isLoaded=!1,this.loader.setOnComplete((()=>{this.isLoaded=!0,console.log("Car models loaded successfully!")}))}setupAnimations(t){if(t.animations&&t.animations.length>0){this.mixer=new md(this.chassis);const e=t.animations.find((t=>t.name.includes("Boost")));e?(this.boostAnimation=this.mixer.clipAction(e),this.boostAnimation.setLoop(_e),this.boostAnimation.clampWhenFinished=!1,console.log("Boost animation found and setup:",e.name)):console.warn("Boost animation not found. Available animations:",t.animations.map((t=>t.name)))}else console.warn("No animations found in the GLTF model")}playBoostAnimation(){this.boostAnimation&&!this.isBoostAnimationPlaying&&(this.boostAnimation.reset(),this.boostAnimation.play(),this.isBoostAnimationPlaying=!0,console.log("Boost animation started"))}stopBoostAnimation(){this.boostAnimation&&this.isBoostAnimationPlaying&&(this.boostAnimation.stop(),this.isBoostAnimationPlaying=!1,console.log("Boost animation stopped"))}updateAnimations(){if(this.mixer){const t=this.animationClock.getDelta();this.mixer.update(t)}}createChassisWireframe(){const t=new gh(this.chassisDimension.x,this.chassisDimension.y,this.chassisDimension.z),e=new Os({color:16711680,wireframe:!0,transparent:!0,opacity:.8});this.chassisWireframe=new Cn(t,e),this.chassisWireframe.visible=!1,this.scene.add(this.chassisWireframe),console.log("Chassis wireframe created with dimensions:",this.chassisDimension)}createChassisWireframeEdges(){const t=new gh(this.chassisDimension.x,this.chassisDimension.y,this.chassisDimension.z),e=new bh(t),i=new Va({color:65280,linewidth:2});this.chassisWireframe=new Ja(e,i),this.scene.add(this.chassisWireframe),console.log("Chassis wireframe edges created with dimensions:",this.chassisDimension)}startDrift(){this.isDrifting||(this.isDrifting=!0,this.car.wheelInfos&&this.car.wheelInfos.length>=4&&(this.car.wheelInfos[0].frictionSlip=this.driftFriction,this.car.wheelInfos[1].frictionSlip=this.driftFriction,this.car.wheelInfos[2].frictionSlip=this.normalFriction,this.car.wheelInfos[3].frictionSlip=this.normalFriction),console.log("Drift mode activated!"))}stopDrift(){if(this.isDrifting){if(this.isDrifting=!1,this.car.wheelInfos&&this.car.wheelInfos.length>=4)for(let t=0;t<4;t++)this.car.wheelInfos[t].frictionSlip=this.normalFriction;console.log("Drift mode deactivated.")}}checkIfFlipped(){if(!this.car.chassisBody)return!1;const t=new Ud(0,1,0);return this.car.chassisBody.quaternion.vmult(t,t),t.y<.3}checkFlipByRotation(){if(!this.car.chassisBody)return!1;const t=new Yi,e=new ui(this.car.chassisBody.quaternion.x,this.car.chassisBody.quaternion.y,this.car.chassisBody.quaternion.z,this.car.chassisBody.quaternion.w);t.setFromQuaternion(e);const i=Math.abs(t.z),s=Math.abs(t.x),n=Math.min(i,Math.PI-i),o=Math.min(s,Math.PI-s),r=Math.PI/3;return n>r||o>r}checkFlipByGroundContact(){if(!this.car.chassisBody)return!1;const t=new Ud(0,1,0);this.car.chassisBody.quaternion.vmult(t,t);const e=t.y>.3;if(this.car.wheelInfos&&4===this.car.wheelInfos.length){let t=0;const i=this.car.chassisBody.position.y;for(let e=0;e<4;e++)this.car.wheelInfos[e]&&this.car.wheelInfos[e].worldTransform&&this.car.wheelInfos[e].worldTransform.position.y>i+.5&&t++;return!(e&&t<3)}return!e}getFlipType(){if(!this.car.chassisBody)return"none";const t=new Yi,e=new ui(this.car.chassisBody.quaternion.x,this.car.chassisBody.quaternion.y,this.car.chassisBody.quaternion.z,this.car.chassisBody.quaternion.w);t.setFromQuaternion(e);const i=t.z,s=t.x,n=new Ud(0,1,0);return this.car.chassisBody.quaternion.vmult(n,n),n.y<-.5?"upside_down":Math.abs(i)>Math.PI/3?i>0?"right_side":"left_side":Math.abs(s)>Math.PI/3?s>0?"nose_down":"nose_up":n.y<.3?"tilted":"upright"}handleFlipDetection(t){const e=performance.now();if(e-this.lastFlipCheck<this.flipCheckInterval)return;this.lastFlipCheck=e;const i=this.checkFlipByGroundContact(),s=this.getFlipType();if(i)if(this.isFlipped){if(this.timeUpsideDown+=this.flipCheckInterval,this.timeUpsideDown%1e3==0){const t=(this.flipResetDelay-this.timeUpsideDown)/1e3;console.log(`Auto-reset in ${t} seconds... (${s})`)}this.timeUpsideDown>=this.flipResetDelay&&(console.log(`Car has been ${s} for too long. Auto-resetting...`),this.autoReset(s))}else this.isFlipped=!0,this.timeUpsideDown=0,console.log(`Car flipped! Type: ${s}. Starting countdown...`);else this.isFlipped&&(this.isFlipped=!1,this.timeUpsideDown=0,console.log("Car recovered from flip."))}autoReset(t="unknown"){const e=this.car.chassisBody.position;let i=3;"upside_down"===t?i=4:"left_side"!==t&&"right_side"!==t||(i=3.5),this.car.chassisBody.position.set(e.x,e.y+i,e.z);const s=this.car.chassisBody.quaternion,n=new Yi,o=new ui(s.x,s.y,s.z,s.w);n.setFromQuaternion(o);const r=new Ud(0,n.y,0),a=new Kd;a.setFromEuler(r.x,r.y,r.z),this.car.chassisBody.quaternion.copy(a),this.car.chassisBody.angularVelocity.set(0,0,0),this.car.chassisBody.velocity.set(0,0,0),this.isFlipped=!1,this.timeUpsideDown=0,console.log(`Car auto-reset completed. Was: ${t}, now upright at:`,e)}setupFrontLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup front light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.frontLights=[],this.originalFrontLightMaterials=new Map,this.frontLightObjects=[],this.frontLightFlares=[],this.isFrontLightOn=!1,this.chassis.traverse((e=>{if("Object_275"===e.name||"Object_268"===e.name){this.frontLights.push(e),this.frontLightObjects.push(e),e.material&&this.originalFrontLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16777215,transparent:!0,opacity:.9,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16777130,transparent:!0,opacity:.7,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1.5,1.5,1.5),n.visible=!1;const o=new Ma(s);o.scale.set(1.5,1.5,1.5),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.5);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.frontLightFlares.push([n,o]),console.log(`Front light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.frontLights.length&&console.warn("Front lights not found in chassis model - check object names")}toggleFrontLight(){this.isFrontLightOn?this.deactivateFrontLight():this.activateFrontLight()}activateFrontLight(){if(this.frontLights&&!this.isFrontLightOn){this.isFrontLightOn=!0;const t=new cl({color:16777215,emissive:new Ds(1,1,.9).multiplyScalar(.6),emissiveIntensity:15});this.frontLights.forEach((e=>{e.material=t})),this.frontLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Front lights activated (with lens flare)")}}deactivateFrontLight(){this.frontLights&&this.isFrontLightOn&&(this.isFrontLightOn=!1,this.frontLights.forEach((t=>{const e=this.originalFrontLightMaterials.get(t);e&&(t.material=e)})),this.frontLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Front lights deactivated (original state)"))}updateFrontLightFlarePositions(){this.frontLights&&this.frontLightFlares&&this.frontLights.forEach(((t,e)=>{if(this.frontLightFlares[e]){const[i,s]=this.frontLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(-1,-.35,3),o=new pi(1,-.35,3);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(.5),r=n.clone().multiplyScalar(.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustFrontFlarePosition(t,e,i,s,n){if(this.frontLightFlares&&this.frontLightFlares[t]){const o=this.frontLightFlares[t];if(o[e]){const r=o[e],a=this.frontLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Front Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothFrontFlares(t,e,i){this.adjustFrontFlarePosition(t,0,e.x,e.y,e.z),this.adjustFrontFlarePosition(t,1,i.x,i.y,i.z)}handleFrontLightToggle(t){"l"!==t.key&&"L"!==t.key||this.toggleFrontLight()}setupFrontLightKeyListener(){document.addEventListener("keydown",(t=>{this.handleFrontLightToggle(t)})),console.log("Front light key listener setup - Press 'L' to toggle front lights")}setupBrakeLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup brake light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.brakeLights=[],this.originalBrakeLightMaterials=new Map,this.brakeLightObjects=[],this.brakeLightFlares=[],this.chassis.traverse((e=>{if("Object_390"===e.name||"Object_381"===e.name){this.brakeLights.push(e),this.brakeLightObjects.push(e),e.material&&this.originalBrakeLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16711680,transparent:!0,opacity:.8,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16711680,transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1.5,1,1),n.visible=!1;const o=new Ma(s);o.scale.set(1.5,1,1),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.3);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.brakeLightFlares.push([n,o]),console.log(`Brake light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.brakeLights.length&&console.warn("Brake lights (Object_29 / Object_33) not found in chassis model")}activateBrakeLight(){if(this.brakeLights&&!this.isBraking){this.isBraking=!0;const t=new cl({color:16711680,emissive:new Ds(1,0,0).multiplyScalar(.5),emissiveIntensity:10});this.brakeLights.forEach((e=>{e.material=t})),this.brakeLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Brake lights activated (with lens flare)")}}deactivateBrakeLight(){this.brakeLights&&this.isBraking&&(this.isBraking=!1,this.brakeLights.forEach((t=>{const e=this.originalBrakeLightMaterials.get(t);e&&(t.material=e)})),this.brakeLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Brake lights deactivated (original state)"))}updateBrakeLightFlarePositions(){this.brakeLights&&this.brakeLightFlares&&this.brakeLights.forEach(((t,e)=>{if(this.brakeLightFlares[e]){const[i,s]=this.brakeLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(.9,.1,-3.2),o=new pi(-.9,.1,-3.2);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(-.3),r=n.clone().multiplyScalar(-.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustBrakeFlarePosition(t,e,i,s,n){if(this.brakeLightFlares&&this.brakeLightFlares[t]){const o=this.brakeLightFlares[t];if(o[e]){const r=o[e],a=this.brakeLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Brake Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothBrakeFlares(t,e,i){this.adjustBrakeFlarePosition(t,0,e.x,e.y,e.z),this.adjustBrakeFlarePosition(t,1,i.x,i.y,i.z)}setupReverseLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup reverse light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.reverseLights=[],this.originalReverseLightMaterials=new Map,this.reverseLightObjects=[],this.reverseLightFlares=[],this.chassis.traverse((e=>{if("Object_394"===e.name||"Object_385"===e.name){this.reverseLights.push(e),this.reverseLightObjects.push(e),e.material&&this.originalReverseLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16777215,transparent:!0,opacity:.8,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16777215,transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1,1,1),n.visible=!1;const o=new Ma(s);o.scale.set(1,1,1),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.3);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.reverseLightFlares.push([n,o]),console.log(`Reverse light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.reverseLights.length&&console.warn("Reverse lights not found in chassis model")}activateReverseLight(){if(this.reverseLights&&!this.isReversing){this.isReversing=!0;const t=new cl({color:16777215,emissive:new Ds(1,1,1).multiplyScalar(.5),emissiveIntensity:50});this.reverseLights.forEach((e=>{e.material=t})),this.reverseLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Reverse lights activated (with lens flare)")}}deactivateReverseLight(){this.reverseLights&&this.isReversing&&(this.isReversing=!1,this.reverseLights.forEach((t=>{const e=this.originalReverseLightMaterials.get(t);e&&(t.material=e)})),this.reverseLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Reverse lights deactivated (original state)"))}updateReverseLightFlarePositions(){this.reverseLights&&this.reverseLightFlares&&this.reverseLights.forEach(((t,e)=>{if(this.reverseLightFlares[e]){const[i,s]=this.reverseLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(1.15,0,-2.9),o=new pi(-1.15,0,-2.9);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(-.3),r=n.clone().multiplyScalar(-.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustFlarePosition(t,e,i,s,n){if(this.reverseLightFlares&&this.reverseLightFlares[t]){const o=this.reverseLightFlares[t];if(o[e]){const r=o[e],a=this.reverseLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothFlares(t,e,i){this.adjustFlarePosition(t,0,e.x,e.y,e.z),this.adjustFlarePosition(t,1,i.x,i.y,i.z)}init(t=null){this.health=t,this.loader.show(),this.loadModels(),this.setChassis(),this.setWheels(),this.controls(),this.update(),this.createChassisWireframe()}loadModels(){const t=new Zg(this.loadingManager),e=new Kg(this.loadingManager);e.setDecoderConfig({type:"js"}),e.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/"),t.setDRACOLoader(e),t.load("./car/Lamborghini_Hu.glb",(t=>{this.chassis=t.scene,this.chassis.traverse((function(t){t.isMesh&&(t.castShadow=!0,t.recieveShadow=!0)})),this.chassis.scale.set(1,1,1),this.scene.add(this.chassis),this.setupBrakeLight(),this.setupReverseLight(),this.setupFrontLight(),this.setupFrontLightKeyListener(),this.setupAnimations(t),this.loader.updateProgress(1,"Chassis")}),(t=>{console.log("Chassis loading progress:",t.loaded/t.total*100+"%")}),(t=>{console.error("Error loading chassis:",t),this.loader.setTitle("Error loading chassis model"),this.loader.setDetails("Please check the model file path")})),this.wheels=[];for(let e=0;e<4;e++)t.load("./car/Lamborghini_Wheel.glb",(t=>{const i=t.scene;this.wheels[e]=i,1===e||3===e?this.wheels[e].scale.set(-1.5*this.wheelScale.frontWheel,1.5*this.wheelScale.frontWheel,-1.5*this.wheelScale.frontWheel):this.wheels[e].scale.set(1.5*this.wheelScale.frontWheel,1.5*this.wheelScale.frontWheel,1.5*this.wheelScale.frontWheel),this.scene.add(this.wheels[e]),this.loader.updateProgress(1,`Wheel ${e+1}`)}),(t=>{console.log(`Wheel ${e} loading progress:`,t.loaded/t.total*100+"%")}),(t=>{console.error(`Error loading wheel ${e}:`,t),this.loader.setTitle(`Error loading wheel ${e+1}`),this.loader.setDetails("Please check the wheel model file path")}))}setChassis(){const t=new hu(new Ud(.5*this.chassisDimension.x,.5*this.chassisDimension.y,.5*this.chassisDimension.z)),e=new Op({friction:.3,restitution:.1}),i=new du({mass:this.mass,material:e,type:du.DYNAMIC,collisionFilterGroup:1,collisionFilterMask:1});i.linearDamping=.1,i.angularDamping=.1,i.addShape(t),i.position.set(this.startPosition.x,this.startPosition.y,this.startPosition.z);const s=new Ud(0,-Math.PI/2,0),n=new Kd;n.setFromEuler(s.x,s.y,s.z),i.quaternion.copy(n),this.world.addBody(i),this.car=new Up({chassisBody:i,indexRightAxis:0,indexUpAxis:1,indexForwardAxis:2}),i.userData={type:"car",car:this},this.car.addToWorld(this.world),this.chassisBody=i}setWheels(){this.car.wheelInfos=[];const t=[new Ud(1.35,-.5,-2.15),new Ud(-1.35,-.5,-2.15),new Ud(1.32,-.5,1.8),new Ud(-1.32,-.5,1.8)];for(let e=0;e<4;e++)this.car.addWheel({radius:.5,directionLocal:new Ud(0,-1,0),suspensionStiffness:80,suspensionRestLength:.15,frictionSlip:2.5,dampingRelaxation:2.3,dampingCompression:4.3,maxSuspensionForce:1e5,rollInfluence:.01,axleLocal:new Ud(-1,0,0),chassisConnectionPointLocal:t[e],maxSuspensionTravel:.1,customSlidingRotationalSpeed:30,useCustomSlidingRotationalSpeed:!0})}ensureGroundExists(){if(!this.groundBody){const t=new mm;this.groundBody=new du({mass:0,material:new Op({friction:.4,restitution:.3})}),this.groundBody.addShape(t),this.groundBody.quaternion.setFromAxisAngle(new Ud(1,0,0),-Math.PI/2),this.groundBody.collisionFilterGroup=2,this.groundBody.collisionFilterMask=-1,this.world.addBody(this.groundBody)}}setHealthSystem(t){this.health=t,console.log("Health system attached to car")}controls(){const t=.5,e=[];this.previousPosition=null,this.previousTime=null,this.currentSpeed=0,this.maxReachedSpeed=0,this.speedHistory=[],this.maxHistoryLength=10,this.averageSpeed=0,this.options={unit:"mph",maxSpeed:180},this.needleSmoothing=.1,this.currentNeedleAngle=-135,this.targetNeedleAngle=-135,this.accelerationPhase=0,this.isInGearShift=!1,this.gearShiftTimer=0,this.gearShiftDuration=150,this.lastGearShiftTime=0,this.accelerationStartTime=0,this.wasAcceleratingPreviously=!1,this.accelerationPhases=[{maxForce:2800,duration:600},{maxForce:2600,duration:1200},{maxForce:2400,duration:1800},{maxForce:2200,duration:2400},{maxForce:2e3,duration:1/0}],this.sounds={drifting:null,gearShift:null,brake:null,backfire:null},this.activeSounds=new Set,this.soundStates={drifting:!1,brake:!1},this.backfireSystem={lastBackfireTime:0,backfireChance:.3,backfireCooldown:2e3,highSpeedBackfireChance:.6,highSpeedThreshold:60,gearShiftBackfireChance:.4,engineOffBackfireChance:.7,lastEngineState:!1,wasAcceleratingRecently:!1,recentAccelerationTime:0},this.fadeOutTimer=null,this.fadeOutDuration=300,this.fadeInDuration=150,this.speedThreshold=2,this.lastSoundChangeTime=0,this.soundChangeDelay=50,this.isMoving=!1,this.wasMoving=!1,this.isDriftingNow=!1,this.wasDriftingPreviously=!1,this.driftStartTime=0,this.driftMinDuration=100,this.lastDriftEndTime=0,this.driftCooldown=200,this.speedThresholds={deceleration:{min:0,max:50}},this.initSounds=()=>{this.sounds.drifting=new Audio("./sounds/fer_drift.wav"),this.sounds.gearShift=new Audio("./sounds/fer_gear.mp3"),this.sounds.brake=new Audio("./sounds/fer_brake.mp3"),this.sounds.backfire=new Audio("./sounds/backfire.mp3"),this.sounds.drifting.loop=!0,this.sounds.brake.loop=!1,this.sounds.backfire.loop=!1,this.sounds.drifting.volume=.6,this.sounds.gearShift.volume=.3,this.sounds.brake.volume=1,this.sounds.backfire.volume=.8,Object.keys(this.sounds).forEach((t=>{this.sounds[t]&&this.sounds[t].addEventListener("error",(e=>{console.warn(`Failed to load ${t} sound:`,e)}))}))},this.initSounds(),this.calculateSpeed=()=>{if(!this.car||!this.car.chassisBody)return 0;const t=Date.now(),e=this.car.chassisBody.position;if(!this.previousPosition)return this.previousPosition=e.clone(),this.previousTime=t,0;const i=e.distanceTo(this.previousPosition),s=(t-this.previousTime)/1e3;if(0===s)return this.currentSpeed;const n=i/s;let o;return o="mph"===this.options.unit?2.237*n:3.6*n,this.previousPosition=e.clone(),this.previousTime=t,Math.max(0,o)},this.updateSpeed=()=>{const t=this.calculateSpeed();this.currentSpeed=this.currentSpeed+.1*(t-this.currentSpeed),this.currentSpeed>this.maxReachedSpeed&&(this.maxReachedSpeed=this.currentSpeed,this.onMaxSpeedReached&&this.onMaxSpeedReached(this.maxReachedSpeed)),this.speedHistory.push(this.currentSpeed),this.speedHistory.length>this.maxHistoryLength&&this.speedHistory.shift(),this.averageSpeed=this.speedHistory.reduce(((t,e)=>t+e),0)/this.speedHistory.length;const e=Math.min(this.currentSpeed/this.options.maxSpeed,1);this.targetNeedleAngle=270*e-135,this.currentNeedleAngle=this.currentNeedleAngle+(this.targetNeedleAngle-this.currentNeedleAngle)*this.needleSmoothing,this.updateSpeedometerUI&&this.updateSpeedometerUI(),this.onSpeedChange&&this.onSpeedChange(this.currentSpeed,this.maxReachedSpeed,this.averageSpeed)},this.startSound=(t,e=null,i=!1)=>{if(!this.sounds[t]||!i&&this.soundStates[t])return;const s=this.sounds[t],n=e||this.getOriginalVolume(t);s.fadeInterval&&clearInterval(s.fadeInterval),s.volume=0,s.currentTime=0;const o=s.play();o&&o.catch((e=>console.log(`${t} audio play failed:`,e))),this.soundStates[t]=!0,this.activeSounds.add(t);const r=n/(this.fadeInDuration/20);s.fadeInterval=setInterval((()=>{s.volume=Math.min(n,s.volume+r),s.volume>=n&&(clearInterval(s.fadeInterval),s.fadeInterval=null)}),20)},this.stopSound=(t,e=null,i=!1)=>{if(!this.sounds[t]||!i&&!this.soundStates[t])return void(e&&e());const s=this.sounds[t];if(s.fadeInterval&&clearInterval(s.fadeInterval),s.paused||0===s.volume)return this.soundStates[t]=!1,this.activeSounds.delete(t),void(e&&e());const n=s.volume/(this.fadeOutDuration/20);s.fadeInterval=setInterval((()=>{s.volume=Math.max(0,s.volume-n),s.volume<=0&&(clearInterval(s.fadeInterval),s.fadeInterval=null,s.pause(),s.currentTime=0,s.volume=this.getOriginalVolume(t),this.soundStates[t]=!1,this.activeSounds.delete(t),e&&e())}),20)},this.playGearShiftSound=()=>{if(this.sounds.gearShift){const t=new Audio("./sounds/fer_gear.mp3");t.volume=.3,t.currentTime=0,t.play().catch((t=>console.log("Gear shift sound failed:",t))),this.tryPlayBackfire("gearshift")}},this.tryPlayBackfire=(t="random")=>{const e=Date.now();if(e-this.backfireSystem.lastBackfireTime<this.backfireSystem.backfireCooldown)return;let i=0;switch(t){case"gearshift":i=this.backfireSystem.gearShiftBackfireChance;break;case"engineoff":i=this.backfireSystem.engineOffBackfireChance;break;case"deceleration":i=this.currentSpeed>this.backfireSystem.highSpeedThreshold?this.backfireSystem.highSpeedBackfireChance:this.backfireSystem.backfireChance;break;default:i=this.backfireSystem.backfireChance}Math.random()<i&&(this.playBackfireSound(),this.backfireSystem.lastBackfireTime=e,console.log(`BACKFIRE triggered by: ${t}`))},this.playBackfireSound=()=>{if(this.sounds.backfire){const t=new Audio("./sounds/backfire.mp3");t.volume=.8,t.currentTime=0,t.play().catch((t=>console.log("Backfire sound failed:",t)))}},this.getOriginalVolume=t=>({drifting:.6,gearShift:.3,brake:1,backfire:.8}[t]||.5),this.stopAllSounds=(t=!1)=>{Object.keys(this.sounds).forEach((e=>{if(this.sounds[e]){const i=this.sounds[e];i.fadeInterval&&clearInterval(i.fadeInterval),t?(i.pause(),i.currentTime=0,i.volume=this.getOriginalVolume(e),this.soundStates[e]=!1):this.stopSound(e,null,!0)}})),this.activeSounds.clear()},this.isCarSpeedLow=()=>this.currentSpeed<5,this.updateSound=()=>{const t=Date.now(),i=this.currentSpeed;this.isMoving=i>this.speedThreshold;const s=e.includes("w")||e.includes("arrowup"),n=e.includes("s")||e.includes("arrowdown"),o=e.includes(" "),r=e.includes("a")||e.includes("arrowleft"),a=e.includes("d")||e.includes("arrowright"),h=s||n;if(this.backfireSystem.lastEngineState&&!h&&this.isMoving&&this.tryPlayBackfire("engineoff"),s)this.backfireSystem.wasAcceleratingRecently=!0,this.backfireSystem.recentAccelerationTime=t;else if(this.backfireSystem.wasAcceleratingRecently){const e=t-this.backfireSystem.recentAccelerationTime;e<1e3&&this.isMoving&&i>20?(this.tryPlayBackfire("deceleration"),this.backfireSystem.wasAcceleratingRecently=!1):e>2e3&&(this.backfireSystem.wasAcceleratingRecently=!1)}this.backfireSystem.lastEngineState=h;const l=o&&(r||a)&&s&&this.isMoving,c=o&&!r&&!a&&this.isMoving&&!s;l&&!this.isDriftingNow?t-this.lastDriftEndTime>this.driftCooldown&&(this.isDriftingNow=!0,this.driftStartTime=t,this.stopSound("brake",null,!0),this.startSound("drifting",null,!0),console.log("DRIFT START")):!l&&this.isDriftingNow&&t-this.driftStartTime>this.driftMinDuration&&(this.isDriftingNow=!1,this.lastDriftEndTime=t,this.stopSound("drifting",null,!0),console.log("DRIFT STOP")),!c||this.isDriftingNow||this.soundStates.brake?c&&!this.isDriftingNow||!this.soundStates.brake||(this.stopSound("brake"),console.log("BRAKE STOP")):(this.startSound("brake"),console.log("BRAKE START")),this.soundStates.drifting&&(!o||!this.isMoving||i<3)&&(this.stopSound("drifting",null,!0),this.isDriftingNow=!1,console.log("DRIFT FORCE STOP - Safety check")),this.wasDriftingPreviously=this.isDriftingNow,this.wasMoving=this.isMoving},this.updateAcceleration=()=>{const t=Date.now(),i=e.includes("w")||e.includes("arrowup");if(i&&!this.wasAcceleratingPreviously&&(this.accelerationPhase=0,this.accelerationStartTime=t,this.isInGearShift=!1,this.gearShiftTimer=0),i){const e=t-this.accelerationStartTime;if(!this.isInGearShift&&this.accelerationPhase<4){const t=this.accelerationPhases[this.accelerationPhase];(this.accelerationPhase>0&&e>=t.duration||0===this.accelerationPhase&&e>=100)&&this.startGearShift()}this.isInGearShift&&t-this.lastGearShiftTime>=this.gearShiftDuration&&this.completeGearShift(),this.wasAcceleratingPreviously=!0}else this.accelerationPhase=0,this.isInGearShift=!1,this.wasAcceleratingPreviously=!1},this.startGearShift=()=>{this.isInGearShift=!0,this.lastGearShiftTime=Date.now(),this.playGearShiftSound()},this.completeGearShift=()=>{this.isInGearShift=!1,this.accelerationPhase=Math.min(this.accelerationPhase+1,4),this.accelerationStartTime=Date.now()},this.getCurrentMaxForce=()=>this.isInGearShift?.3*this.accelerationPhases[this.accelerationPhase].maxForce:this.accelerationPhases[this.accelerationPhase].maxForce,window.addEventListener("keydown",(t=>{this.isLoaded&&(e.includes(t.key.toLowerCase())||e.push(t.key.toLowerCase()),i())})),window.addEventListener("keyup",(t=>{this.isLoaded&&(e.splice(e.indexOf(t.key.toLowerCase()),1),i())}));const i=()=>{if(this.controlsDisabled)return;this.updateSpeed(),this.updateAcceleration(),e.includes("f")&&(this.toggleWireframe(),e.splice(e.indexOf("f"),1));const i=e.includes("w")||e.includes("arrowup"),r=e.includes(" "),a=e.includes("a")||e.includes("arrowleft"),h=e.includes("d")||e.includes("arrowright"),l=r&&(a||h)&&i&&this.isMoving;if(l&&!this.isDrifting?this.startDrift():!l&&this.isDrifting&&this.stopDrift(),!r||l){r?l&&this.activateBrakeLight():this.deactivateBrakeLight(),this.car.setBrake(0,0),this.car.setBrake(0,1),this.car.setBrake(0,2),this.car.setBrake(0,3);const i=this.isDrifting?this.driftSteerMultiplier:1;if(a?(this.car.setSteeringValue(t*i,2),this.car.setSteeringValue(t*i,3)):h?(this.car.setSteeringValue(t*-i,2),this.car.setSteeringValue(t*-i,3)):o(),e.includes("w")||e.includes("arrowup")){const t=this.getCurrentMaxForce();this.car.applyEngineForce(-1*t,0),this.car.applyEngineForce(-1*t,1),this.car.applyEngineForce(-1*t,2),this.car.applyEngineForce(-1*t,3)}else e.includes("s")||e.includes("arrowdown")?(l||this.activateReverseLight(),this.car.applyEngineForce(1*this.maxForce,0),this.car.applyEngineForce(1*this.maxForce,1),this.car.applyEngineForce(1*this.maxForce,2),this.car.applyEngineForce(1*this.maxForce,3)):(this.car.applyEngineForce(0,0),this.car.applyEngineForce(0,1),this.car.applyEngineForce(0,2),this.car.applyEngineForce(0,3),this.deactivateReverseLight(),l||n())}else this.activateBrakeLight(),s();this.updateSound()},s=()=>{this.car.setBrake(45,0),this.car.setBrake(45,1),this.car.setBrake(45,2),this.car.setBrake(45,3)},n=()=>{this.car.setBrake(25,0),this.car.setBrake(25,1),this.car.setBrake(25,2),this.car.setBrake(25,3)},o=()=>{this.car.setSteeringValue(0,2),this.car.setSteeringValue(0,3)};this.cleanup=()=>{Object.keys(this.sounds).forEach((t=>{if(this.sounds[t]){const e=this.sounds[t];e.fadeInterval&&clearInterval(e.fadeInterval),e.pause(),e.currentTime=0,e.volume=this.getOriginalVolume(t)}})),this.activeSounds.clear(),Object.keys(this.soundStates).forEach((t=>{this.soundStates[t]=!1})),this.isDriftingNow=!1,this.wasDriftingPreviously=!1,this.driftStartTime=0,this.lastDriftEndTime=0,this.fadeOutTimer&&clearTimeout(this.fadeOutTimer),console.log("CLEANUP COMPLETE - All sounds stopped")}}checkHealthStatus(){if(!this.health)return;const t=this.health.isDestroyed;t&&!this.wasDestroyed?(console.log("Car destroyed! Stopping all sounds and disabling controls."),this.onCarDestroyed()):!t&&this.wasDestroyed&&(console.log("Car repaired! Re-enabling controls."),this.onCarRepaired()),this.wasDestroyed=t}onCarDestroyed(){this.stopAllSounds(),this.controlsDisabled=!0,this.car&&this.car.chassisBody&&(this.car.setBrake(0,0),this.car.setBrake(100,1),this.car.setBrake(500,2),this.car.setBrake(0,3),this.car.applyEngineForce(0,0),this.car.applyEngineForce(0,1),this.car.applyEngineForce(0,2),this.car.applyEngineForce(0,3),this.car.setSteeringValue(0,2),this.car.setSteeringValue(0,3)),this.stopDrift(),this.activateBrakeLight()}onCarRepaired(){this.controlsDisabled=!1,this.car&&(this.car.setBrake(0,0),this.car.setBrake(0,1),this.car.setBrake(0,2),this.car.setBrake(0,3)),this.playSound("idle")}update(){this.world.addEventListener("postStep",(()=>{if(this.updateAnimations(),this.handleFlipDetection(),this.checkHealthStatus(),this.updateReverseLightFlarePositions(),this.updateBrakeLightFlarePositions(),this.updateFrontLightFlarePositions(),this.car.wheelInfos&&this.chassis.position&&this.wheels[0]?.position){this.chassis.position.set(this.car.chassisBody.position.x+this.chassisModelPos.x,this.car.chassisBody.position.y+this.chassisModelPos.y,this.car.chassisBody.position.z+this.chassisModelPos.z),this.chassis.quaternion.copy(this.car.chassisBody.quaternion),this.chassisWireframe&&(this.chassisWireframe.position.copy(this.car.chassisBody.position),this.chassisWireframe.quaternion.copy(this.car.chassisBody.quaternion));for(let t=0;t<4;t++)this.car.wheelInfos[t]&&(this.car.updateWheelTransform(t),this.wheels[t].position.copy(this.car.wheelInfos[t].worldTransform.position),this.wheels[t].quaternion.copy(this.car.wheelInfos[t].worldTransform.quaternion))}}))}toggleWireframe(t=null){this.chassisWireframe&&(this.chassisWireframe.visible=null!==t?t:!this.chassisWireframe.visible,console.log("Chassis wireframe visibility:",this.chassisWireframe.visible))}removeWireframe(){this.chassisWireframe&&(this.scene.remove(this.chassisWireframe),this.chassisWireframe.geometry.dispose(),this.chassisWireframe.material.dispose(),this.chassisWireframe=null,console.log("Chassis wireframe removed"))}forceFlipReset(){console.log("Manual flip reset triggered"),this.autoReset()}getFlipStatus(){return{isFlipped:this.isFlipped,timeUpsideDown:this.timeUpsideDown,resetProgress:this.timeUpsideDown/this.flipResetDelay}}cleanup(){console.log("Starting car cleanup..."),this.stopAllSounds(),this.sounds&&(Object.values(this.sounds).forEach((t=>{t&&(t.pause(),t.currentTime=0,t.src="",t.removeEventListener("ended",t.onended))})),this.sounds={}),this.mixer&&(this.mixer.stopAllAction(),this.mixer.uncacheRoot(this.mixer.getRoot()),this.mixer=null),this.boostAnimation=null,this.car&&this.car.chassisBody&&(this.car.removeFromWorld(this.world),this.world.removeBody(this.car.chassisBody)),this.chassis&&(this.chassis.traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose())})),this.scene.remove(this.chassis),this.chassis=null),this.wheels&&this.wheels.length>0&&(this.wheels.forEach((t=>{t&&(t.traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose())})),this.scene.remove(t))})),this.wheels=[]),this.removeWireframe(),this.brakeLight=null,this.originalBrakeLightMaterial&&(this.originalBrakeLightMaterial.dispose(),this.originalBrakeLightMaterial=null),this.followTarget&&(this.scene.remove(this.followTarget),this.followTarget=null),this.isDrifting=!1,this.isBraking=!1,this.isFlipped=!1,this.controlsDisabled=!1,this.wasDestroyed=!1,this.timeUpsideDown=0,this.lastFlipCheck=0,this.car=null,this.scene=null,this.world=null,this.health=null,this.pivot=null,console.log("Car cleanup completed")}}class Cy{followTarget=new us;pivot;constructor(t,e,i,s={x:0,y:1,z:0},n=null,o){this.scene=t,this.world=e,this.loadingManager=o,this.startPosition=new Ud(s.x,s.y,s.z),this.car={},this.chassis={},this.wheels=[],this.chassisDimension={x:2.7,y:1,z:7},this.chassisModelPos={x:0,y:0,z:0},this.wheelScale={frontWheel:1.1,hindWheel:1.1},this.mass=500,this.pivot=i,this.maxForce=1800,this.speedMultiplier=1.5,this.brakeLight=null,this.originalBrakeLightMaterial=null,this.isBraking=!1,this.isReversing=!1,this.mixer=null,this.boostAnimation=null,this.isBoostAnimationPlaying=!1,this.animationClock=new qc,this.isDrifting=!1,this.normalFriction=2,this.driftFriction=.05,this.driftSteerMultiplier=1,this.flipCheckInterval=100,this.flipThreshold=Math.PI/3,this.timeUpsideDown=0,this.flipResetDelay=2e3,this.lastFlipCheck=0,this.isFlipped=!1,this.currentFlipType="upright",this.health=n,this.wasDestroyed=!1,this.controlsDisabled=!1,this.loader=new hy(5,"Loading Car Models..."),this.isLoaded=!1,this.loader.setOnComplete((()=>{this.isLoaded=!0,console.log("Car models loaded successfully!")}))}setupAnimations(t){if(t.animations&&t.animations.length>0){this.mixer=new md(this.chassis);const e=t.animations.find((t=>t.name.includes("Boost")));e?(this.boostAnimation=this.mixer.clipAction(e),this.boostAnimation.setLoop(_e),this.boostAnimation.clampWhenFinished=!1,console.log("Boost animation found and setup:",e.name)):console.warn("Boost animation not found. Available animations:",t.animations.map((t=>t.name)))}else console.warn("No animations found in the GLTF model")}playBoostAnimation(){this.boostAnimation&&!this.isBoostAnimationPlaying&&(this.boostAnimation.reset(),this.boostAnimation.play(),this.isBoostAnimationPlaying=!0,console.log("Boost animation started"))}stopBoostAnimation(){this.boostAnimation&&this.isBoostAnimationPlaying&&(this.boostAnimation.stop(),this.isBoostAnimationPlaying=!1,console.log("Boost animation stopped"))}updateAnimations(){if(this.mixer){const t=this.animationClock.getDelta();this.mixer.update(t)}}createChassisWireframe(){const t=new gh(this.chassisDimension.x,this.chassisDimension.y,this.chassisDimension.z),e=new Os({color:16711680,wireframe:!0,transparent:!0,opacity:.8});this.chassisWireframe=new Cn(t,e),this.chassisWireframe.visible=!1,this.scene.add(this.chassisWireframe),console.log("Chassis wireframe created with dimensions:",this.chassisDimension)}createChassisWireframeEdges(){const t=new gh(this.chassisDimension.x,this.chassisDimension.y,this.chassisDimension.z),e=new bh(t),i=new Va({color:65280,linewidth:2});this.chassisWireframe=new Ja(e,i),this.scene.add(this.chassisWireframe),console.log("Chassis wireframe edges created with dimensions:",this.chassisDimension)}startDrift(){this.isDrifting||(this.isDrifting=!0,this.car.wheelInfos&&this.car.wheelInfos.length>=4&&(this.car.wheelInfos[0].frictionSlip=this.driftFriction,this.car.wheelInfos[1].frictionSlip=this.driftFriction,this.car.wheelInfos[2].frictionSlip=this.normalFriction,this.car.wheelInfos[3].frictionSlip=this.normalFriction),console.log("Drift mode activated!"))}stopDrift(){if(this.isDrifting){if(this.isDrifting=!1,this.car.wheelInfos&&this.car.wheelInfos.length>=4)for(let t=0;t<4;t++)this.car.wheelInfos[t].frictionSlip=this.normalFriction;console.log("Drift mode deactivated.")}}checkIfFlipped(){if(!this.car.chassisBody)return!1;const t=new Ud(0,1,0);return this.car.chassisBody.quaternion.vmult(t,t),t.y<.3}checkFlipByRotation(){if(!this.car.chassisBody)return!1;const t=new Yi,e=new ui(this.car.chassisBody.quaternion.x,this.car.chassisBody.quaternion.y,this.car.chassisBody.quaternion.z,this.car.chassisBody.quaternion.w);t.setFromQuaternion(e);const i=Math.abs(t.z),s=Math.abs(t.x),n=Math.min(i,Math.PI-i),o=Math.min(s,Math.PI-s),r=Math.PI/3;return n>r||o>r}checkFlipByGroundContact(){if(!this.car.chassisBody)return!1;const t=new Ud(0,1,0);this.car.chassisBody.quaternion.vmult(t,t);const e=t.y>.3;if(this.car.wheelInfos&&4===this.car.wheelInfos.length){let t=0;const i=this.car.chassisBody.position.y;for(let e=0;e<4;e++)this.car.wheelInfos[e]&&this.car.wheelInfos[e].worldTransform&&this.car.wheelInfos[e].worldTransform.position.y>i+.5&&t++;return!(e&&t<3)}return!e}getFlipType(){if(!this.car.chassisBody)return"none";const t=new Yi,e=new ui(this.car.chassisBody.quaternion.x,this.car.chassisBody.quaternion.y,this.car.chassisBody.quaternion.z,this.car.chassisBody.quaternion.w);t.setFromQuaternion(e);const i=t.z,s=t.x,n=new Ud(0,1,0);return this.car.chassisBody.quaternion.vmult(n,n),n.y<-.5?"upside_down":Math.abs(i)>Math.PI/3?i>0?"right_side":"left_side":Math.abs(s)>Math.PI/3?s>0?"nose_down":"nose_up":n.y<.3?"tilted":"upright"}handleFlipDetection(t){const e=performance.now();if(e-this.lastFlipCheck<this.flipCheckInterval)return;this.lastFlipCheck=e;const i=this.checkFlipByGroundContact(),s=this.getFlipType();if(i)if(this.isFlipped){if(this.timeUpsideDown+=this.flipCheckInterval,this.timeUpsideDown%1e3==0){const t=(this.flipResetDelay-this.timeUpsideDown)/1e3;console.log(`Auto-reset in ${t} seconds... (${s})`)}this.timeUpsideDown>=this.flipResetDelay&&(console.log(`Car has been ${s} for too long. Auto-resetting...`),this.autoReset(s))}else this.isFlipped=!0,this.timeUpsideDown=0,console.log(`Car flipped! Type: ${s}. Starting countdown...`);else this.isFlipped&&(this.isFlipped=!1,this.timeUpsideDown=0,console.log("Car recovered from flip."))}autoReset(t="unknown"){const e=this.car.chassisBody.position;let i=3;"upside_down"===t?i=4:"left_side"!==t&&"right_side"!==t||(i=3.5),this.car.chassisBody.position.set(e.x,e.y+i,e.z);const s=this.car.chassisBody.quaternion,n=new Yi,o=new ui(s.x,s.y,s.z,s.w);n.setFromQuaternion(o);const r=new Ud(0,n.y,0),a=new Kd;a.setFromEuler(r.x,r.y,r.z),this.car.chassisBody.quaternion.copy(a),this.car.chassisBody.angularVelocity.set(0,0,0),this.car.chassisBody.velocity.set(0,0,0),this.isFlipped=!1,this.timeUpsideDown=0,console.log(`Car auto-reset completed. Was: ${t}, now upright at:`,e)}setupFrontLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup front light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.frontLights=[],this.originalFrontLightMaterials=new Map,this.frontLightObjects=[],this.frontLightFlares=[],this.isFrontLightOn=!1,this.chassis.traverse((e=>{if("Object_1"===e.name){this.frontLights.push(e),this.frontLightObjects.push(e),e.material&&this.originalFrontLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16777215,transparent:!0,opacity:.9,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16777130,transparent:!0,opacity:.7,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1.5,1.5,1.5),n.visible=!1;const o=new Ma(s);o.scale.set(1.5,1.5,1.5),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.5);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.frontLightFlares.push([n,o]),console.log(`Front light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.frontLights.length&&console.warn("Front lights not found in chassis model - check object names")}toggleFrontLight(){this.isFrontLightOn?this.deactivateFrontLight():this.activateFrontLight()}activateFrontLight(){if(this.frontLights&&!this.isFrontLightOn){this.isFrontLightOn=!0;const t=new cl({color:16777215,emissive:new Ds(1,1,.9).multiplyScalar(.6),emissiveIntensity:15});this.frontLights.forEach((e=>{e.material=t})),this.frontLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Front lights activated (with lens flare)")}}deactivateFrontLight(){this.frontLights&&this.isFrontLightOn&&(this.isFrontLightOn=!1,this.frontLights.forEach((t=>{const e=this.originalFrontLightMaterials.get(t);e&&(t.material=e)})),this.frontLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Front lights deactivated (original state)"))}updateFrontLightFlarePositions(){this.frontLights&&this.frontLightFlares&&this.frontLights.forEach(((t,e)=>{if(this.frontLightFlares[e]){const[i,s]=this.frontLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(-1,-.2,2.8),o=new pi(1,-.2,2.8);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(.5),r=n.clone().multiplyScalar(.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustFrontFlarePosition(t,e,i,s,n){if(this.frontLightFlares&&this.frontLightFlares[t]){const o=this.frontLightFlares[t];if(o[e]){const r=o[e],a=this.frontLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Front Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothFrontFlares(t,e,i){this.adjustFrontFlarePosition(t,0,e.x,e.y,e.z),this.adjustFrontFlarePosition(t,1,i.x,i.y,i.z)}handleFrontLightToggle(t){"l"!==t.key&&"L"!==t.key||this.toggleFrontLight()}setupFrontLightKeyListener(){document.addEventListener("keydown",(t=>{this.handleFrontLightToggle(t)})),console.log("Front light key listener setup - Press 'L' to toggle front lights")}setupBrakeLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup brake light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.brakeLights=[],this.originalBrakeLightMaterials=new Map,this.brakeLightObjects=[],this.brakeLightFlares=[],this.chassis.traverse((e=>{if("Object_2"===e.name){this.brakeLights.push(e),this.brakeLightObjects.push(e),e.material&&this.originalBrakeLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16711680,transparent:!0,opacity:.8,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16711680,transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1,1,1),n.visible=!1;const o=new Ma(s);o.scale.set(1,1,1),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.3);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.brakeLightFlares.push([n,o]),console.log(`Brake light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.brakeLights.length&&console.warn("Brake lights (Object_29 / Object_33) not found in chassis model")}activateBrakeLight(){if(this.brakeLights&&!this.isBraking){this.isBraking=!0;const t=new cl({color:16711680,emissive:new Ds(1,0,0).multiplyScalar(.5),emissiveIntensity:10});this.brakeLights.forEach((e=>{e.material=t})),this.brakeLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Brake lights activated (with lens flare)")}}deactivateBrakeLight(){this.brakeLights&&this.isBraking&&(this.isBraking=!1,this.brakeLights.forEach((t=>{const e=this.originalBrakeLightMaterials.get(t);e&&(t.material=e)})),this.brakeLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Brake lights deactivated (original state)"))}updateBrakeLightFlarePositions(){this.brakeLights&&this.brakeLightFlares&&this.brakeLights.forEach(((t,e)=>{if(this.brakeLightFlares[e]){const[i,s]=this.brakeLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(.8,0,-3.2),o=new pi(-.8,0,-3.2);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(-.3),r=n.clone().multiplyScalar(-.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustBrakeFlarePosition(t,e,i,s,n){if(this.brakeLightFlares&&this.brakeLightFlares[t]){const o=this.brakeLightFlares[t];if(o[e]){const r=o[e],a=this.brakeLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Brake Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothBrakeFlares(t,e,i){this.adjustBrakeFlarePosition(t,0,e.x,e.y,e.z),this.adjustBrakeFlarePosition(t,1,i.x,i.y,i.z)}setupReverseLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup reverse light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.reverseLights=[],this.originalReverseLightMaterials=new Map,this.reverseLightObjects=[],this.reverseLightFlares=[],this.chassis.traverse((e=>{if("Object_3"===e.name){this.reverseLights.push(e),this.reverseLightObjects.push(e),e.material&&this.originalReverseLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16777215,transparent:!0,opacity:.8,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16777215,transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1,1,1),n.visible=!1;const o=new Ma(s);o.scale.set(1,1,1),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.3);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.reverseLightFlares.push([n,o]),console.log(`Reverse light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.reverseLights.length&&console.warn("Reverse lights not found in chassis model")}activateReverseLight(){if(this.reverseLights&&!this.isReversing){this.isReversing=!0;const t=new cl({color:16777215,emissive:new Ds(1,1,1).multiplyScalar(.5),emissiveIntensity:50});this.reverseLights.forEach((e=>{e.material=t})),this.reverseLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Reverse lights activated (with lens flare)")}}deactivateReverseLight(){this.reverseLights&&this.isReversing&&(this.isReversing=!1,this.reverseLights.forEach((t=>{const e=this.originalReverseLightMaterials.get(t);e&&(t.material=e)})),this.reverseLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Reverse lights deactivated (original state)"))}updateReverseLightFlarePositions(){this.reverseLights&&this.reverseLightFlares&&this.reverseLights.forEach(((t,e)=>{if(this.reverseLightFlares[e]){const[i,s]=this.reverseLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(.8,0,-3.2),o=new pi(-.8,0,-3.2);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(-.3),r=n.clone().multiplyScalar(-.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustFlarePosition(t,e,i,s,n){if(this.reverseLightFlares&&this.reverseLightFlares[t]){const o=this.reverseLightFlares[t];if(o[e]){const r=o[e],a=this.reverseLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothFlares(t,e,i){this.adjustFlarePosition(t,0,e.x,e.y,e.z),this.adjustFlarePosition(t,1,i.x,i.y,i.z)}init(t=null){this.health=t,this.loader.show(),this.loadModels(),this.setChassis(),this.setWheels(),this.controls(),this.update(),this.createChassisWireframe()}loadModels(){const t=new Zg(this.loadingManager),e=new Kg(this.loadingManager);e.setDecoderConfig({type:"js"}),e.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/"),t.setDRACOLoader(e),t.load("./car/Chevrolet_Corvette.glb",(t=>{this.chassis=t.scene,this.chassis.traverse((function(t){t.isMesh&&(t.castShadow=!0,t.recieveShadow=!0)})),this.chassis.scale.set(1,1,1),this.scene.add(this.chassis),this.setupBrakeLight(),this.setupReverseLight(),this.setupFrontLight(),this.setupFrontLightKeyListener(),this.setupAnimations(t),this.loader.updateProgress(1,"Chassis")}),(t=>{console.log("Chassis loading progress:",t.loaded/t.total*100+"%")}),(t=>{console.error("Error loading chassis:",t),this.loader.setTitle("Error loading chassis model"),this.loader.setDetails("Please check the model file path")})),this.wheels=[];for(let e=0;e<4;e++)t.load("./car/Chevrolet_Corvette_Wheel.glb",(t=>{const i=t.scene;this.wheels[e]=i,1===e||3===e?this.wheels[e].scale.set(-1.5*this.wheelScale.frontWheel,1.5*this.wheelScale.frontWheel,-1.5*this.wheelScale.frontWheel):this.wheels[e].scale.set(1.5*this.wheelScale.frontWheel,1.5*this.wheelScale.frontWheel,1.5*this.wheelScale.frontWheel),this.scene.add(this.wheels[e]),this.loader.updateProgress(1,`Wheel ${e+1}`)}),(t=>{console.log(`Wheel ${e} loading progress:`,t.loaded/t.total*100+"%")}),(t=>{console.error(`Error loading wheel ${e}:`,t),this.loader.setTitle(`Error loading wheel ${e+1}`),this.loader.setDetails("Please check the wheel model file path")}))}setChassis(){const t=new hu(new Ud(.5*this.chassisDimension.x,.5*this.chassisDimension.y,.5*this.chassisDimension.z)),e=new Op({friction:.3,restitution:.1}),i=new du({mass:this.mass,material:e,type:du.DYNAMIC,collisionFilterGroup:1,collisionFilterMask:1});i.linearDamping=.1,i.angularDamping=.1,i.addShape(t),i.position.set(this.startPosition.x,this.startPosition.y,this.startPosition.z);const s=new Ud(0,-Math.PI/2,0),n=new Kd;n.setFromEuler(s.x,s.y,s.z),i.quaternion.copy(n),this.world.addBody(i),this.car=new Up({chassisBody:i,indexRightAxis:0,indexUpAxis:1,indexForwardAxis:2}),i.userData={type:"car",car:this},this.car.addToWorld(this.world),this.chassisBody=i}setWheels(){this.car.wheelInfos=[];const t=[new Ud(1.27,-.5,-2.08),new Ud(-1.27,-.5,-2.08),new Ud(1.25,-.5,2.05),new Ud(-1.25,-.5,2.05)];for(let e=0;e<4;e++)this.car.addWheel({radius:.5,directionLocal:new Ud(0,-1,0),suspensionStiffness:30,suspensionRestLength:.3,frictionSlip:2.5,dampingRelaxation:2.3,dampingCompression:4.3,maxSuspensionForce:1e5,rollInfluence:.01,axleLocal:new Ud(-1,0,0),chassisConnectionPointLocal:t[e],maxSuspensionTravel:.3,customSlidingRotationalSpeed:30,useCustomSlidingRotationalSpeed:!0})}ensureGroundExists(){if(!this.groundBody){const t=new mm;this.groundBody=new du({mass:0,material:new Op({friction:.4,restitution:.3})}),this.groundBody.addShape(t),this.groundBody.quaternion.setFromAxisAngle(new Ud(1,0,0),-Math.PI/2),this.groundBody.collisionFilterGroup=2,this.groundBody.collisionFilterMask=-1,this.world.addBody(this.groundBody)}}setHealthSystem(t){this.health=t,console.log("Health system attached to car")}controls(){const t=.5,e=[];this.previousPosition=null,this.previousTime=null,this.currentSpeed=0,this.maxReachedSpeed=0,this.speedHistory=[],this.maxHistoryLength=10,this.averageSpeed=0,this.options={unit:"mph",maxSpeed:180},this.needleSmoothing=.1,this.currentNeedleAngle=-135,this.targetNeedleAngle=-135,this.accelerationPhase=0,this.isInGearShift=!1,this.gearShiftTimer=0,this.gearShiftDuration=150,this.lastGearShiftTime=0,this.accelerationStartTime=0,this.wasAcceleratingPreviously=!1,this.accelerationPhases=[{maxForce:2800,duration:600},{maxForce:2600,duration:1200},{maxForce:2400,duration:1800},{maxForce:2200,duration:2400},{maxForce:2e3,duration:1/0}],this.sounds={drifting:null,gearShift:null,brake:null,backfire:null},this.activeSounds=new Set,this.soundStates={drifting:!1,brake:!1},this.backfireSystem={lastBackfireTime:0,backfireChance:.3,backfireCooldown:2e3,highSpeedBackfireChance:.6,highSpeedThreshold:60,gearShiftBackfireChance:.4,engineOffBackfireChance:.7,lastEngineState:!1,wasAcceleratingRecently:!1,recentAccelerationTime:0},this.fadeOutTimer=null,this.fadeOutDuration=300,this.fadeInDuration=150,this.speedThreshold=2,this.lastSoundChangeTime=0,this.soundChangeDelay=50,this.isMoving=!1,this.wasMoving=!1,this.isDriftingNow=!1,this.wasDriftingPreviously=!1,this.driftStartTime=0,this.driftMinDuration=100,this.lastDriftEndTime=0,this.driftCooldown=200,this.speedThresholds={deceleration:{min:0,max:50}},this.initSounds=()=>{this.sounds.drifting=new Audio("./sounds/fer_drift.wav"),this.sounds.gearShift=new Audio("./sounds/fer_gear.mp3"),this.sounds.brake=new Audio("./sounds/fer_brake.mp3"),this.sounds.backfire=new Audio("./sounds/backfire.mp3"),this.sounds.drifting.loop=!0,this.sounds.brake.loop=!1,this.sounds.backfire.loop=!1,this.sounds.drifting.volume=.6,this.sounds.gearShift.volume=.3,this.sounds.brake.volume=1,this.sounds.backfire.volume=.8,Object.keys(this.sounds).forEach((t=>{this.sounds[t]&&this.sounds[t].addEventListener("error",(e=>{console.warn(`Failed to load ${t} sound:`,e)}))}))},this.initSounds(),this.calculateSpeed=()=>{if(!this.car||!this.car.chassisBody)return 0;const t=Date.now(),e=this.car.chassisBody.position;if(!this.previousPosition)return this.previousPosition=e.clone(),this.previousTime=t,0;const i=e.distanceTo(this.previousPosition),s=(t-this.previousTime)/1e3;if(0===s)return this.currentSpeed;const n=i/s;let o;return o="mph"===this.options.unit?2.237*n:3.6*n,this.previousPosition=e.clone(),this.previousTime=t,Math.max(0,o)},this.updateSpeed=()=>{const t=this.calculateSpeed();this.currentSpeed=this.currentSpeed+.1*(t-this.currentSpeed),this.currentSpeed>this.maxReachedSpeed&&(this.maxReachedSpeed=this.currentSpeed,this.onMaxSpeedReached&&this.onMaxSpeedReached(this.maxReachedSpeed)),this.speedHistory.push(this.currentSpeed),this.speedHistory.length>this.maxHistoryLength&&this.speedHistory.shift(),this.averageSpeed=this.speedHistory.reduce(((t,e)=>t+e),0)/this.speedHistory.length;const e=Math.min(this.currentSpeed/this.options.maxSpeed,1);this.targetNeedleAngle=270*e-135,this.currentNeedleAngle=this.currentNeedleAngle+(this.targetNeedleAngle-this.currentNeedleAngle)*this.needleSmoothing,this.updateSpeedometerUI&&this.updateSpeedometerUI(),this.onSpeedChange&&this.onSpeedChange(this.currentSpeed,this.maxReachedSpeed,this.averageSpeed)},this.startSound=(t,e=null,i=!1)=>{if(!this.sounds[t]||!i&&this.soundStates[t])return;const s=this.sounds[t],n=e||this.getOriginalVolume(t);s.fadeInterval&&clearInterval(s.fadeInterval),s.volume=0,s.currentTime=0;const o=s.play();o&&o.catch((e=>console.log(`${t} audio play failed:`,e))),this.soundStates[t]=!0,this.activeSounds.add(t);const r=n/(this.fadeInDuration/20);s.fadeInterval=setInterval((()=>{s.volume=Math.min(n,s.volume+r),s.volume>=n&&(clearInterval(s.fadeInterval),s.fadeInterval=null)}),20)},this.stopSound=(t,e=null,i=!1)=>{if(!this.sounds[t]||!i&&!this.soundStates[t])return void(e&&e());const s=this.sounds[t];if(s.fadeInterval&&clearInterval(s.fadeInterval),s.paused||0===s.volume)return this.soundStates[t]=!1,this.activeSounds.delete(t),void(e&&e());const n=s.volume/(this.fadeOutDuration/20);s.fadeInterval=setInterval((()=>{s.volume=Math.max(0,s.volume-n),s.volume<=0&&(clearInterval(s.fadeInterval),s.fadeInterval=null,s.pause(),s.currentTime=0,s.volume=this.getOriginalVolume(t),this.soundStates[t]=!1,this.activeSounds.delete(t),e&&e())}),20)},this.playGearShiftSound=()=>{if(this.sounds.gearShift){const t=new Audio("./sounds/fer_gear.mp3");t.volume=.3,t.currentTime=0,t.play().catch((t=>console.log("Gear shift sound failed:",t))),this.tryPlayBackfire("gearshift")}},this.tryPlayBackfire=(t="random")=>{const e=Date.now();if(e-this.backfireSystem.lastBackfireTime<this.backfireSystem.backfireCooldown)return;let i=0;switch(t){case"gearshift":i=this.backfireSystem.gearShiftBackfireChance;break;case"engineoff":i=this.backfireSystem.engineOffBackfireChance;break;case"deceleration":i=this.currentSpeed>this.backfireSystem.highSpeedThreshold?this.backfireSystem.highSpeedBackfireChance:this.backfireSystem.backfireChance;break;default:i=this.backfireSystem.backfireChance}Math.random()<i&&(this.playBackfireSound(),this.backfireSystem.lastBackfireTime=e,console.log(`BACKFIRE triggered by: ${t}`))},this.playBackfireSound=()=>{if(this.sounds.backfire){const t=new Audio("./sounds/backfire.mp3");t.volume=.8,t.currentTime=0,t.play().catch((t=>console.log("Backfire sound failed:",t)))}},this.getOriginalVolume=t=>({drifting:.6,gearShift:.3,brake:1,backfire:.8}[t]||.5),this.stopAllSounds=(t=!1)=>{Object.keys(this.sounds).forEach((e=>{if(this.sounds[e]){const i=this.sounds[e];i.fadeInterval&&clearInterval(i.fadeInterval),t?(i.pause(),i.currentTime=0,i.volume=this.getOriginalVolume(e),this.soundStates[e]=!1):this.stopSound(e,null,!0)}})),this.activeSounds.clear()},this.isCarSpeedLow=()=>this.currentSpeed<5,this.updateSound=()=>{const t=Date.now(),i=this.currentSpeed;this.isMoving=i>this.speedThreshold;const s=e.includes("w")||e.includes("arrowup"),n=e.includes("s")||e.includes("arrowdown"),o=e.includes(" "),r=e.includes("a")||e.includes("arrowleft"),a=e.includes("d")||e.includes("arrowright"),h=s||n;if(this.backfireSystem.lastEngineState&&!h&&this.isMoving&&this.tryPlayBackfire("engineoff"),s)this.backfireSystem.wasAcceleratingRecently=!0,this.backfireSystem.recentAccelerationTime=t;else if(this.backfireSystem.wasAcceleratingRecently){const e=t-this.backfireSystem.recentAccelerationTime;e<1e3&&this.isMoving&&i>20?(this.tryPlayBackfire("deceleration"),this.backfireSystem.wasAcceleratingRecently=!1):e>2e3&&(this.backfireSystem.wasAcceleratingRecently=!1)}this.backfireSystem.lastEngineState=h;const l=o&&(r||a)&&s&&this.isMoving,c=o&&!r&&!a&&this.isMoving&&!s;l&&!this.isDriftingNow?t-this.lastDriftEndTime>this.driftCooldown&&(this.isDriftingNow=!0,this.driftStartTime=t,this.stopSound("brake",null,!0),this.startSound("drifting",null,!0),console.log("DRIFT START")):!l&&this.isDriftingNow&&t-this.driftStartTime>this.driftMinDuration&&(this.isDriftingNow=!1,this.lastDriftEndTime=t,this.stopSound("drifting",null,!0),console.log("DRIFT STOP")),!c||this.isDriftingNow||this.soundStates.brake?c&&!this.isDriftingNow||!this.soundStates.brake||(this.stopSound("brake"),console.log("BRAKE STOP")):(this.startSound("brake"),console.log("BRAKE START")),this.soundStates.drifting&&(!o||!this.isMoving||i<3)&&(this.stopSound("drifting",null,!0),this.isDriftingNow=!1,console.log("DRIFT FORCE STOP - Safety check")),this.wasDriftingPreviously=this.isDriftingNow,this.wasMoving=this.isMoving},this.updateAcceleration=()=>{const t=Date.now(),i=e.includes("w")||e.includes("arrowup");if(i&&!this.wasAcceleratingPreviously&&(this.accelerationPhase=0,this.accelerationStartTime=t,this.isInGearShift=!1,this.gearShiftTimer=0),i){const e=t-this.accelerationStartTime;if(!this.isInGearShift&&this.accelerationPhase<4){const t=this.accelerationPhases[this.accelerationPhase];(this.accelerationPhase>0&&e>=t.duration||0===this.accelerationPhase&&e>=100)&&this.startGearShift()}this.isInGearShift&&t-this.lastGearShiftTime>=this.gearShiftDuration&&this.completeGearShift(),this.wasAcceleratingPreviously=!0}else this.accelerationPhase=0,this.isInGearShift=!1,this.wasAcceleratingPreviously=!1},this.startGearShift=()=>{this.isInGearShift=!0,this.lastGearShiftTime=Date.now(),this.playGearShiftSound()},this.completeGearShift=()=>{this.isInGearShift=!1,this.accelerationPhase=Math.min(this.accelerationPhase+1,4),this.accelerationStartTime=Date.now()},this.getCurrentMaxForce=()=>this.isInGearShift?.3*this.accelerationPhases[this.accelerationPhase].maxForce:this.accelerationPhases[this.accelerationPhase].maxForce,window.addEventListener("keydown",(t=>{this.isLoaded&&(e.includes(t.key.toLowerCase())||e.push(t.key.toLowerCase()),i())})),window.addEventListener("keyup",(t=>{this.isLoaded&&(e.splice(e.indexOf(t.key.toLowerCase()),1),i())}));const i=()=>{if(this.controlsDisabled)return;this.updateSpeed(),this.updateAcceleration(),e.includes("f")&&(this.toggleWireframe(),e.splice(e.indexOf("f"),1));const i=e.includes("w")||e.includes("arrowup"),r=e.includes(" "),a=e.includes("a")||e.includes("arrowleft"),h=e.includes("d")||e.includes("arrowright"),l=r&&(a||h)&&i&&this.isMoving;if(l&&!this.isDrifting?this.startDrift():!l&&this.isDrifting&&this.stopDrift(),!r||l){r?l&&this.activateBrakeLight():this.deactivateBrakeLight(),this.car.setBrake(0,0),this.car.setBrake(0,1),this.car.setBrake(0,2),this.car.setBrake(0,3);const i=this.isDrifting?this.driftSteerMultiplier:1;if(a?(this.car.setSteeringValue(t*i,2),this.car.setSteeringValue(t*i,3)):h?(this.car.setSteeringValue(t*-i,2),this.car.setSteeringValue(t*-i,3)):o(),e.includes("w")||e.includes("arrowup")){const t=this.getCurrentMaxForce();this.car.applyEngineForce(-1*t,0),this.car.applyEngineForce(-1*t,1),this.car.applyEngineForce(-1*t,2),this.car.applyEngineForce(-1*t,3)}else e.includes("s")||e.includes("arrowdown")?(l||this.activateReverseLight(),this.car.applyEngineForce(1*this.maxForce,0),this.car.applyEngineForce(1*this.maxForce,1),this.car.applyEngineForce(1*this.maxForce,2),this.car.applyEngineForce(1*this.maxForce,3)):(this.car.applyEngineForce(0,0),this.car.applyEngineForce(0,1),this.car.applyEngineForce(0,2),this.car.applyEngineForce(0,3),this.deactivateReverseLight(),l||n())}else this.activateBrakeLight(),s();this.updateSound()},s=()=>{this.car.setBrake(45,0),this.car.setBrake(45,1),this.car.setBrake(45,2),this.car.setBrake(45,3)},n=()=>{this.car.setBrake(25,0),this.car.setBrake(25,1),this.car.setBrake(25,2),this.car.setBrake(25,3)},o=()=>{this.car.setSteeringValue(0,2),this.car.setSteeringValue(0,3)};this.cleanup=()=>{Object.keys(this.sounds).forEach((t=>{if(this.sounds[t]){const e=this.sounds[t];e.fadeInterval&&clearInterval(e.fadeInterval),e.pause(),e.currentTime=0,e.volume=this.getOriginalVolume(t)}})),this.activeSounds.clear(),Object.keys(this.soundStates).forEach((t=>{this.soundStates[t]=!1})),this.isDriftingNow=!1,this.wasDriftingPreviously=!1,this.driftStartTime=0,this.lastDriftEndTime=0,this.fadeOutTimer&&clearTimeout(this.fadeOutTimer),console.log("CLEANUP COMPLETE - All sounds stopped")}}checkHealthStatus(){if(!this.health)return;const t=this.health.isDestroyed;t&&!this.wasDestroyed?(console.log("Car destroyed! Stopping all sounds and disabling controls."),this.onCarDestroyed()):!t&&this.wasDestroyed&&(console.log("Car repaired! Re-enabling controls."),this.onCarRepaired()),this.wasDestroyed=t}onCarDestroyed(){this.stopAllSounds(),this.controlsDisabled=!0,this.car&&this.car.chassisBody&&(this.car.setBrake(0,0),this.car.setBrake(100,1),this.car.setBrake(500,2),this.car.setBrake(0,3),this.car.applyEngineForce(0,0),this.car.applyEngineForce(0,1),this.car.applyEngineForce(0,2),this.car.applyEngineForce(0,3),this.car.setSteeringValue(0,2),this.car.setSteeringValue(0,3)),this.stopDrift(),this.activateBrakeLight()}onCarRepaired(){this.controlsDisabled=!1,this.car&&(this.car.setBrake(0,0),this.car.setBrake(0,1),this.car.setBrake(0,2),this.car.setBrake(0,3)),this.playSound("idle")}update(){this.world.addEventListener("postStep",(()=>{if(this.updateAnimations(),this.handleFlipDetection(),this.checkHealthStatus(),this.updateReverseLightFlarePositions(),this.updateBrakeLightFlarePositions(),this.updateFrontLightFlarePositions(),this.car.wheelInfos&&this.chassis.position&&this.wheels[0]?.position){this.chassis.position.set(this.car.chassisBody.position.x+this.chassisModelPos.x,this.car.chassisBody.position.y+this.chassisModelPos.y,this.car.chassisBody.position.z+this.chassisModelPos.z),this.chassis.quaternion.copy(this.car.chassisBody.quaternion),this.chassisWireframe&&(this.chassisWireframe.position.copy(this.car.chassisBody.position),this.chassisWireframe.quaternion.copy(this.car.chassisBody.quaternion));for(let t=0;t<4;t++)this.car.wheelInfos[t]&&(this.car.updateWheelTransform(t),this.wheels[t].position.copy(this.car.wheelInfos[t].worldTransform.position),this.wheels[t].quaternion.copy(this.car.wheelInfos[t].worldTransform.quaternion))}}))}toggleWireframe(t=null){this.chassisWireframe&&(this.chassisWireframe.visible=null!==t?t:!this.chassisWireframe.visible,console.log("Chassis wireframe visibility:",this.chassisWireframe.visible))}removeWireframe(){this.chassisWireframe&&(this.scene.remove(this.chassisWireframe),this.chassisWireframe.geometry.dispose(),this.chassisWireframe.material.dispose(),this.chassisWireframe=null,console.log("Chassis wireframe removed"))}forceFlipReset(){console.log("Manual flip reset triggered"),this.autoReset()}getFlipStatus(){return{isFlipped:this.isFlipped,timeUpsideDown:this.timeUpsideDown,resetProgress:this.timeUpsideDown/this.flipResetDelay}}cleanup(){console.log("Starting car cleanup..."),this.stopAllSounds(),this.sounds&&(Object.values(this.sounds).forEach((t=>{t&&(t.pause(),t.currentTime=0,t.src="",t.removeEventListener("ended",t.onended))})),this.sounds={}),this.mixer&&(this.mixer.stopAllAction(),this.mixer.uncacheRoot(this.mixer.getRoot()),this.mixer=null),this.boostAnimation=null,this.car&&this.car.chassisBody&&(this.car.removeFromWorld(this.world),this.world.removeBody(this.car.chassisBody)),this.chassis&&(this.chassis.traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose())})),this.scene.remove(this.chassis),this.chassis=null),this.wheels&&this.wheels.length>0&&(this.wheels.forEach((t=>{t&&(t.traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose())})),this.scene.remove(t))})),this.wheels=[]),this.removeWireframe(),this.brakeLight=null,this.originalBrakeLightMaterial&&(this.originalBrakeLightMaterial.dispose(),this.originalBrakeLightMaterial=null),this.followTarget&&(this.scene.remove(this.followTarget),this.followTarget=null),this.isDrifting=!1,this.isBraking=!1,this.isFlipped=!1,this.controlsDisabled=!1,this.wasDestroyed=!1,this.timeUpsideDown=0,this.lastFlipCheck=0,this.car=null,this.scene=null,this.world=null,this.health=null,this.pivot=null,console.log("Car cleanup completed")}}class Ay{followTarget=new us;pivot;constructor(t,e,i,s={x:0,y:1,z:0},n=null,o){this.scene=t,this.world=e,this.loadingManager=o,this.startPosition=new Ud(s.x,s.y,s.z),this.car={},this.chassis={},this.wheels=[],this.chassisDimension={x:2.7,y:1,z:7},this.chassisModelPos={x:0,y:0,z:0},this.wheelScale={frontWheel:1.1,hindWheel:1.1},this.mass=500,this.pivot=i,this.maxForce=1800,this.speedMultiplier=1.5,this.brakeLight=null,this.originalBrakeLightMaterial=null,this.isBraking=!1,this.isReversing=!1,this.mixer=null,this.boostAnimation=null,this.isBoostAnimationPlaying=!1,this.animationClock=new qc,this.isDrifting=!1,this.normalFriction=2,this.driftFriction=.05,this.driftSteerMultiplier=1,this.flipCheckInterval=100,this.flipThreshold=Math.PI/3,this.timeUpsideDown=0,this.flipResetDelay=2e3,this.lastFlipCheck=0,this.isFlipped=!1,this.currentFlipType="upright",this.health=n,this.wasDestroyed=!1,this.controlsDisabled=!1,this.loader=new hy(5,"Loading Car Models..."),this.isLoaded=!1,this.loader.setOnComplete((()=>{this.isLoaded=!0,console.log("Car models loaded successfully!")}))}setupAnimations(t){if(t.animations&&t.animations.length>0){this.mixer=new md(this.chassis);const e=t.animations.find((t=>t.name.includes("Boost")));e?(this.boostAnimation=this.mixer.clipAction(e),this.boostAnimation.setLoop(_e),this.boostAnimation.clampWhenFinished=!1,console.log("Boost animation found and setup:",e.name)):console.warn("Boost animation not found. Available animations:",t.animations.map((t=>t.name)))}else console.warn("No animations found in the GLTF model")}playBoostAnimation(){this.boostAnimation&&!this.isBoostAnimationPlaying&&(this.boostAnimation.reset(),this.boostAnimation.play(),this.isBoostAnimationPlaying=!0,console.log("Boost animation started"))}stopBoostAnimation(){this.boostAnimation&&this.isBoostAnimationPlaying&&(this.boostAnimation.stop(),this.isBoostAnimationPlaying=!1,console.log("Boost animation stopped"))}updateAnimations(){if(this.mixer){const t=this.animationClock.getDelta();this.mixer.update(t)}}createChassisWireframe(){const t=new gh(this.chassisDimension.x,this.chassisDimension.y,this.chassisDimension.z),e=new Os({color:16711680,wireframe:!0,transparent:!0,opacity:.8});this.chassisWireframe=new Cn(t,e),this.chassisWireframe.visible=!1,this.scene.add(this.chassisWireframe),console.log("Chassis wireframe created with dimensions:",this.chassisDimension)}createChassisWireframeEdges(){const t=new gh(this.chassisDimension.x,this.chassisDimension.y,this.chassisDimension.z),e=new bh(t),i=new Va({color:65280,linewidth:2});this.chassisWireframe=new Ja(e,i),this.scene.add(this.chassisWireframe),console.log("Chassis wireframe edges created with dimensions:",this.chassisDimension)}startDrift(){this.isDrifting||(this.isDrifting=!0,this.car.wheelInfos&&this.car.wheelInfos.length>=4&&(this.car.wheelInfos[0].frictionSlip=this.driftFriction,this.car.wheelInfos[1].frictionSlip=this.driftFriction,this.car.wheelInfos[2].frictionSlip=this.normalFriction,this.car.wheelInfos[3].frictionSlip=this.normalFriction),console.log("Drift mode activated!"))}stopDrift(){if(this.isDrifting){if(this.isDrifting=!1,this.car.wheelInfos&&this.car.wheelInfos.length>=4)for(let t=0;t<4;t++)this.car.wheelInfos[t].frictionSlip=this.normalFriction;console.log("Drift mode deactivated.")}}checkIfFlipped(){if(!this.car.chassisBody)return!1;const t=new Ud(0,1,0);return this.car.chassisBody.quaternion.vmult(t,t),t.y<.3}checkFlipByRotation(){if(!this.car.chassisBody)return!1;const t=new Yi,e=new ui(this.car.chassisBody.quaternion.x,this.car.chassisBody.quaternion.y,this.car.chassisBody.quaternion.z,this.car.chassisBody.quaternion.w);t.setFromQuaternion(e);const i=Math.abs(t.z),s=Math.abs(t.x),n=Math.min(i,Math.PI-i),o=Math.min(s,Math.PI-s),r=Math.PI/3;return n>r||o>r}checkFlipByGroundContact(){if(!this.car.chassisBody)return!1;const t=new Ud(0,1,0);this.car.chassisBody.quaternion.vmult(t,t);const e=t.y>.3;if(this.car.wheelInfos&&4===this.car.wheelInfos.length){let t=0;const i=this.car.chassisBody.position.y;for(let e=0;e<4;e++)this.car.wheelInfos[e]&&this.car.wheelInfos[e].worldTransform&&this.car.wheelInfos[e].worldTransform.position.y>i+.5&&t++;return!(e&&t<3)}return!e}getFlipType(){if(!this.car.chassisBody)return"none";const t=new Yi,e=new ui(this.car.chassisBody.quaternion.x,this.car.chassisBody.quaternion.y,this.car.chassisBody.quaternion.z,this.car.chassisBody.quaternion.w);t.setFromQuaternion(e);const i=t.z,s=t.x,n=new Ud(0,1,0);return this.car.chassisBody.quaternion.vmult(n,n),n.y<-.5?"upside_down":Math.abs(i)>Math.PI/3?i>0?"right_side":"left_side":Math.abs(s)>Math.PI/3?s>0?"nose_down":"nose_up":n.y<.3?"tilted":"upright"}handleFlipDetection(t){const e=performance.now();if(e-this.lastFlipCheck<this.flipCheckInterval)return;this.lastFlipCheck=e;const i=this.checkFlipByGroundContact(),s=this.getFlipType();if(i)if(this.isFlipped){if(this.timeUpsideDown+=this.flipCheckInterval,this.timeUpsideDown%1e3==0){const t=(this.flipResetDelay-this.timeUpsideDown)/1e3;console.log(`Auto-reset in ${t} seconds... (${s})`)}this.timeUpsideDown>=this.flipResetDelay&&(console.log(`Car has been ${s} for too long. Auto-resetting...`),this.autoReset(s))}else this.isFlipped=!0,this.timeUpsideDown=0,console.log(`Car flipped! Type: ${s}. Starting countdown...`);else this.isFlipped&&(this.isFlipped=!1,this.timeUpsideDown=0,console.log("Car recovered from flip."))}autoReset(t="unknown"){const e=this.car.chassisBody.position;let i=3;"upside_down"===t?i=4:"left_side"!==t&&"right_side"!==t||(i=3.5),this.car.chassisBody.position.set(e.x,e.y+i,e.z);const s=this.car.chassisBody.quaternion,n=new Yi,o=new ui(s.x,s.y,s.z,s.w);n.setFromQuaternion(o);const r=new Ud(0,n.y,0),a=new Kd;a.setFromEuler(r.x,r.y,r.z),this.car.chassisBody.quaternion.copy(a),this.car.chassisBody.angularVelocity.set(0,0,0),this.car.chassisBody.velocity.set(0,0,0),this.isFlipped=!1,this.timeUpsideDown=0,console.log(`Car auto-reset completed. Was: ${t}, now upright at:`,e)}setupFrontLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup front light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.frontLights=[],this.originalFrontLightMaterials=new Map,this.frontLightObjects=[],this.frontLightFlares=[],this.isFrontLightOn=!1,this.chassis.traverse((e=>{if("Object_87"===e.name){this.frontLights.push(e),this.frontLightObjects.push(e),e.material&&this.originalFrontLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16777215,transparent:!0,opacity:.9,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16777130,transparent:!0,opacity:.7,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1.5,1.5,1.5),n.visible=!1;const o=new Ma(s);o.scale.set(1.5,1.5,1.5),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.5);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.frontLightFlares.push([n,o]),console.log(`Front light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.frontLights.length&&console.warn("Front lights not found in chassis model - check object names")}toggleFrontLight(){this.isFrontLightOn?this.deactivateFrontLight():this.activateFrontLight()}activateFrontLight(){if(this.frontLights&&!this.isFrontLightOn){this.isFrontLightOn=!0;const t=new cl({color:16777215,emissive:new Ds(1,1,.9).multiplyScalar(.6),emissiveIntensity:15});this.frontLights.forEach((e=>{e.material=t})),this.frontLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Front lights activated (with lens flare)")}}deactivateFrontLight(){this.frontLights&&this.isFrontLightOn&&(this.isFrontLightOn=!1,this.frontLights.forEach((t=>{const e=this.originalFrontLightMaterials.get(t);e&&(t.material=e)})),this.frontLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Front lights deactivated (original state)"))}updateFrontLightFlarePositions(){this.frontLights&&this.frontLightFlares&&this.frontLights.forEach(((t,e)=>{if(this.frontLightFlares[e]){const[i,s]=this.frontLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(-1,-.35,3),o=new pi(1,-.35,3);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(.5),r=n.clone().multiplyScalar(.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustFrontFlarePosition(t,e,i,s,n){if(this.frontLightFlares&&this.frontLightFlares[t]){const o=this.frontLightFlares[t];if(o[e]){const r=o[e],a=this.frontLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Front Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothFrontFlares(t,e,i){this.adjustFrontFlarePosition(t,0,e.x,e.y,e.z),this.adjustFrontFlarePosition(t,1,i.x,i.y,i.z)}handleFrontLightToggle(t){"l"!==t.key&&"L"!==t.key||this.toggleFrontLight()}setupFrontLightKeyListener(){document.addEventListener("keydown",(t=>{this.handleFrontLightToggle(t)})),console.log("Front light key listener setup - Press 'L' to toggle front lights")}setupBrakeLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup brake light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.brakeLights=[],this.originalBrakeLightMaterials=new Map,this.brakeLightObjects=[],this.brakeLightFlares=[],this.chassis.traverse((e=>{if("Object_96"===e.name){this.brakeLights.push(e),this.brakeLightObjects.push(e),e.material&&this.originalBrakeLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16711680,transparent:!0,opacity:.8,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16711680,transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(3,1,1),n.visible=!1;const o=new Ma(s);o.scale.set(3,1,1),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.3);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.brakeLightFlares.push([n,o]),console.log(`Brake light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.brakeLights.length&&console.warn("Brake lights (Object_29 / Object_33) not found in chassis model")}activateBrakeLight(){if(this.brakeLights&&!this.isBraking){this.isBraking=!0;const t=new cl({color:16711680,emissive:new Ds(1,0,0).multiplyScalar(.5),emissiveIntensity:10});this.brakeLights.forEach((e=>{e.material=t})),this.brakeLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Brake lights activated (with lens flare)")}}deactivateBrakeLight(){this.brakeLights&&this.isBraking&&(this.isBraking=!1,this.brakeLights.forEach((t=>{const e=this.originalBrakeLightMaterials.get(t);e&&(t.material=e)})),this.brakeLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Brake lights deactivated (original state)"))}updateBrakeLightFlarePositions(){this.brakeLights&&this.brakeLightFlares&&this.brakeLights.forEach(((t,e)=>{if(this.brakeLightFlares[e]){const[i,s]=this.brakeLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(.8,0,-3.4),o=new pi(-.8,0,-3.4);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(-.3),r=n.clone().multiplyScalar(-.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustBrakeFlarePosition(t,e,i,s,n){if(this.brakeLightFlares&&this.brakeLightFlares[t]){const o=this.brakeLightFlares[t];if(o[e]){const r=o[e],a=this.brakeLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Brake Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothBrakeFlares(t,e,i){this.adjustBrakeFlarePosition(t,0,e.x,e.y,e.z),this.adjustBrakeFlarePosition(t,1,i.x,i.y,i.z)}setupReverseLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup reverse light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.reverseLights=[],this.originalReverseLightMaterials=new Map,this.reverseLightObjects=[],this.reverseLightFlares=[],this.chassis.traverse((e=>{if("Object_96"===e.name){this.reverseLights.push(e),this.reverseLightObjects.push(e),e.material&&this.originalReverseLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16777215,transparent:!0,opacity:.8,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16777215,transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1,1,1),n.visible=!1;const o=new Ma(s);o.scale.set(1,1,1),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.3);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.reverseLightFlares.push([n,o]),console.log(`Reverse light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position]),console.log("Light object position:",e.position)}})),0===this.reverseLights.length&&console.warn("Reverse lights not found in chassis model")}activateReverseLight(){if(this.reverseLights&&!this.isReversing){this.isReversing=!0;const t=new cl({color:16711680,emissive:new Ds(1,0,0).multiplyScalar(.5),emissiveIntensity:50});this.reverseLights.forEach((e=>{e.material=t})),this.reverseLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Reverse lights activated (with lens flare)")}}deactivateReverseLight(){this.reverseLights&&this.isReversing&&(this.isReversing=!1,this.reverseLights.forEach((t=>{const e=this.originalReverseLightMaterials.get(t);e&&(t.material=e)})),this.reverseLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Reverse lights deactivated (original state)"))}updateReverseLightFlarePositions(){this.reverseLights&&this.reverseLightFlares&&this.reverseLights.forEach(((t,e)=>{if(this.reverseLightFlares[e]){const[i,s]=this.reverseLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(1.2,0,-3.2),o=new pi(-1.2,0,-3.2);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(-.3),r=n.clone().multiplyScalar(-.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustFlarePosition(t,e,i,s,n){if(this.reverseLightFlares&&this.reverseLightFlares[t]){const o=this.reverseLightFlares[t];if(o[e]){const r=o[e],a=this.reverseLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}console.log(`Light ${t}, Flare ${e} adjusted to position:`,r.position)}}}adjustBothFlares(t,e,i){this.adjustFlarePosition(t,0,e.x,e.y,e.z),this.adjustFlarePosition(t,1,i.x,i.y,i.z)}init(t=null){this.health=t,this.loader.show(),this.loadModels(),this.setChassis(),this.setWheels(),this.controls(),this.update(),this.createChassisWireframe()}loadModels(){const t=new Zg(this.loadingManager),e=new Kg(this.loadingManager);e.setDecoderConfig({type:"js"}),e.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/"),t.setDRACOLoader(e),t.load("./car/Lamborghini_Cen.glb",(t=>{this.chassis=t.scene,this.chassis.traverse((function(t){t.isMesh&&(t.castShadow=!0,t.recieveShadow=!0)})),this.chassis.scale.set(1,1,1),this.scene.add(this.chassis),this.setupBrakeLight(),this.setupReverseLight(),this.setupFrontLight(),this.setupFrontLightKeyListener(),this.setupAnimations(t),this.loader.updateProgress(1,"Chassis")}),(t=>{console.log("Chassis loading progress:",t.loaded/t.total*100+"%")}),(t=>{console.error("Error loading chassis:",t),this.loader.setTitle("Error loading chassis model"),this.loader.setDetails("Please check the model file path")})),this.wheels=[];for(let e=0;e<4;e++)t.load("./car/Lamborghini_Cen_Wheel.glb",(t=>{const i=t.scene;this.wheels[e]=i,1===e||3===e?this.wheels[e].scale.set(-1.5*this.wheelScale.frontWheel,1.5*this.wheelScale.frontWheel,-1.5*this.wheelScale.frontWheel):this.wheels[e].scale.set(1.5*this.wheelScale.frontWheel,1.5*this.wheelScale.frontWheel,1.5*this.wheelScale.frontWheel),this.scene.add(this.wheels[e]),this.loader.updateProgress(1,`Wheel ${e+1}`)}),(t=>{console.log(`Wheel ${e} loading progress:`,t.loaded/t.total*100+"%")}),(t=>{console.error(`Error loading wheel ${e}:`,t),this.loader.setTitle(`Error loading wheel ${e+1}`),this.loader.setDetails("Please check the wheel model file path")}))}setChassis(){const t=new hu(new Ud(.5*this.chassisDimension.x,.5*this.chassisDimension.y,.5*this.chassisDimension.z)),e=new Op({friction:.3,restitution:.1}),i=new du({mass:this.mass,material:e,type:du.DYNAMIC,collisionFilterGroup:1,collisionFilterMask:1});i.linearDamping=.1,i.angularDamping=.1,i.addShape(t),i.position.set(this.startPosition.x,this.startPosition.y,this.startPosition.z);const s=new Ud(0,-Math.PI/2,0),n=new Kd;n.setFromEuler(s.x,s.y,s.z),i.quaternion.copy(n),this.world.addBody(i),this.car=new Up({chassisBody:i,indexRightAxis:0,indexUpAxis:1,indexForwardAxis:2}),i.userData={type:"car",car:this},this.car.addToWorld(this.world),this.chassisBody=i}setWheels(){this.car.wheelInfos=[];const t=[new Ud(1.45,-.5,-2.12),new Ud(-1.45,-.5,-2.12),new Ud(1.32,-.5,1.8),new Ud(-1.32,-.5,1.8)];for(let e=0;e<4;e++)this.car.addWheel({radius:.5,directionLocal:new Ud(0,-1,0),suspensionStiffness:80,suspensionRestLength:.15,frictionSlip:2.5,dampingRelaxation:2.3,dampingCompression:4.3,maxSuspensionForce:1e5,rollInfluence:.01,axleLocal:new Ud(-1,0,0),chassisConnectionPointLocal:t[e],maxSuspensionTravel:.1,customSlidingRotationalSpeed:30,useCustomSlidingRotationalSpeed:!0})}ensureGroundExists(){if(!this.groundBody){const t=new mm;this.groundBody=new du({mass:0,material:new Op({friction:.4,restitution:.3})}),this.groundBody.addShape(t),this.groundBody.quaternion.setFromAxisAngle(new Ud(1,0,0),-Math.PI/2),this.groundBody.collisionFilterGroup=2,this.groundBody.collisionFilterMask=-1,this.world.addBody(this.groundBody)}}setHealthSystem(t){this.health=t,console.log("Health system attached to car")}controls(){const t=.5,e=[];this.previousPosition=null,this.previousTime=null,this.currentSpeed=0,this.maxReachedSpeed=0,this.speedHistory=[],this.maxHistoryLength=10,this.averageSpeed=0,this.options={unit:"mph",maxSpeed:180},this.needleSmoothing=.1,this.currentNeedleAngle=-135,this.targetNeedleAngle=-135,this.accelerationPhase=0,this.isInGearShift=!1,this.gearShiftTimer=0,this.gearShiftDuration=150,this.lastGearShiftTime=0,this.accelerationStartTime=0,this.wasAcceleratingPreviously=!1,this.accelerationPhases=[{maxForce:2800,duration:600},{maxForce:2600,duration:1200},{maxForce:2400,duration:1800},{maxForce:2200,duration:2400},{maxForce:2e3,duration:1/0}],this.sounds={drifting:null,gearShift:null,brake:null,backfire:null},this.activeSounds=new Set,this.soundStates={drifting:!1,brake:!1},this.backfireSystem={lastBackfireTime:0,backfireChance:.3,backfireCooldown:2e3,highSpeedBackfireChance:.6,highSpeedThreshold:60,gearShiftBackfireChance:.4,engineOffBackfireChance:.7,lastEngineState:!1,wasAcceleratingRecently:!1,recentAccelerationTime:0},this.fadeOutTimer=null,this.fadeOutDuration=300,this.fadeInDuration=150,this.speedThreshold=2,this.lastSoundChangeTime=0,this.soundChangeDelay=50,this.isMoving=!1,this.wasMoving=!1,this.isDriftingNow=!1,this.wasDriftingPreviously=!1,this.driftStartTime=0,this.driftMinDuration=100,this.lastDriftEndTime=0,this.driftCooldown=200,this.speedThresholds={deceleration:{min:0,max:50}},this.initSounds=()=>{this.sounds.drifting=new Audio("./sounds/fer_drift.wav"),this.sounds.gearShift=new Audio("./sounds/fer_gear.mp3"),this.sounds.brake=new Audio("./sounds/fer_brake.mp3"),this.sounds.backfire=new Audio("./sounds/backfire.mp3"),this.sounds.drifting.loop=!0,this.sounds.brake.loop=!1,this.sounds.backfire.loop=!1,this.sounds.drifting.volume=.6,this.sounds.gearShift.volume=.3,this.sounds.brake.volume=1,this.sounds.backfire.volume=.8,Object.keys(this.sounds).forEach((t=>{this.sounds[t]&&this.sounds[t].addEventListener("error",(e=>{console.warn(`Failed to load ${t} sound:`,e)}))}))},this.initSounds(),this.calculateSpeed=()=>{if(!this.car||!this.car.chassisBody)return 0;const t=Date.now(),e=this.car.chassisBody.position;if(!this.previousPosition)return this.previousPosition=e.clone(),this.previousTime=t,0;const i=e.distanceTo(this.previousPosition),s=(t-this.previousTime)/1e3;if(0===s)return this.currentSpeed;const n=i/s;let o;return o="mph"===this.options.unit?2.237*n:3.6*n,this.previousPosition=e.clone(),this.previousTime=t,Math.max(0,o)},this.updateSpeed=()=>{const t=this.calculateSpeed();this.currentSpeed=this.currentSpeed+.1*(t-this.currentSpeed),this.currentSpeed>this.maxReachedSpeed&&(this.maxReachedSpeed=this.currentSpeed,this.onMaxSpeedReached&&this.onMaxSpeedReached(this.maxReachedSpeed)),this.speedHistory.push(this.currentSpeed),this.speedHistory.length>this.maxHistoryLength&&this.speedHistory.shift(),this.averageSpeed=this.speedHistory.reduce(((t,e)=>t+e),0)/this.speedHistory.length;const e=Math.min(this.currentSpeed/this.options.maxSpeed,1);this.targetNeedleAngle=270*e-135,this.currentNeedleAngle=this.currentNeedleAngle+(this.targetNeedleAngle-this.currentNeedleAngle)*this.needleSmoothing,this.updateSpeedometerUI&&this.updateSpeedometerUI(),this.onSpeedChange&&this.onSpeedChange(this.currentSpeed,this.maxReachedSpeed,this.averageSpeed)},this.startSound=(t,e=null,i=!1)=>{if(!this.sounds[t]||!i&&this.soundStates[t])return;const s=this.sounds[t],n=e||this.getOriginalVolume(t);s.fadeInterval&&clearInterval(s.fadeInterval),s.volume=0,s.currentTime=0;const o=s.play();o&&o.catch((e=>console.log(`${t} audio play failed:`,e))),this.soundStates[t]=!0,this.activeSounds.add(t);const r=n/(this.fadeInDuration/20);s.fadeInterval=setInterval((()=>{s.volume=Math.min(n,s.volume+r),s.volume>=n&&(clearInterval(s.fadeInterval),s.fadeInterval=null)}),20)},this.stopSound=(t,e=null,i=!1)=>{if(!this.sounds[t]||!i&&!this.soundStates[t])return void(e&&e());const s=this.sounds[t];if(s.fadeInterval&&clearInterval(s.fadeInterval),s.paused||0===s.volume)return this.soundStates[t]=!1,this.activeSounds.delete(t),void(e&&e());const n=s.volume/(this.fadeOutDuration/20);s.fadeInterval=setInterval((()=>{s.volume=Math.max(0,s.volume-n),s.volume<=0&&(clearInterval(s.fadeInterval),s.fadeInterval=null,s.pause(),s.currentTime=0,s.volume=this.getOriginalVolume(t),this.soundStates[t]=!1,this.activeSounds.delete(t),e&&e())}),20)},this.playGearShiftSound=()=>{if(this.sounds.gearShift){const t=new Audio("./sounds/fer_gear.mp3");t.volume=.3,t.currentTime=0,t.play().catch((t=>console.log("Gear shift sound failed:",t))),this.tryPlayBackfire("gearshift")}},this.tryPlayBackfire=(t="random")=>{const e=Date.now();if(e-this.backfireSystem.lastBackfireTime<this.backfireSystem.backfireCooldown)return;let i=0;switch(t){case"gearshift":i=this.backfireSystem.gearShiftBackfireChance;break;case"engineoff":i=this.backfireSystem.engineOffBackfireChance;break;case"deceleration":i=this.currentSpeed>this.backfireSystem.highSpeedThreshold?this.backfireSystem.highSpeedBackfireChance:this.backfireSystem.backfireChance;break;default:i=this.backfireSystem.backfireChance}Math.random()<i&&(this.playBackfireSound(),this.backfireSystem.lastBackfireTime=e,console.log(`BACKFIRE triggered by: ${t}`))},this.playBackfireSound=()=>{if(this.sounds.backfire){const t=new Audio("./sounds/backfire.mp3");t.volume=.8,t.currentTime=0,t.play().catch((t=>console.log("Backfire sound failed:",t)))}},this.getOriginalVolume=t=>({drifting:.6,gearShift:.3,brake:1,backfire:.8}[t]||.5),this.stopAllSounds=(t=!1)=>{Object.keys(this.sounds).forEach((e=>{if(this.sounds[e]){const i=this.sounds[e];i.fadeInterval&&clearInterval(i.fadeInterval),t?(i.pause(),i.currentTime=0,i.volume=this.getOriginalVolume(e),this.soundStates[e]=!1):this.stopSound(e,null,!0)}})),this.activeSounds.clear()},this.isCarSpeedLow=()=>this.currentSpeed<5,this.updateSound=()=>{const t=Date.now(),i=this.currentSpeed;this.isMoving=i>this.speedThreshold;const s=e.includes("w")||e.includes("arrowup"),n=e.includes("s")||e.includes("arrowdown"),o=e.includes(" "),r=e.includes("a")||e.includes("arrowleft"),a=e.includes("d")||e.includes("arrowright"),h=s||n;if(this.backfireSystem.lastEngineState&&!h&&this.isMoving&&this.tryPlayBackfire("engineoff"),s)this.backfireSystem.wasAcceleratingRecently=!0,this.backfireSystem.recentAccelerationTime=t;else if(this.backfireSystem.wasAcceleratingRecently){const e=t-this.backfireSystem.recentAccelerationTime;e<1e3&&this.isMoving&&i>20?(this.tryPlayBackfire("deceleration"),this.backfireSystem.wasAcceleratingRecently=!1):e>2e3&&(this.backfireSystem.wasAcceleratingRecently=!1)}this.backfireSystem.lastEngineState=h;const l=o&&(r||a)&&s&&this.isMoving,c=o&&!r&&!a&&this.isMoving&&!s;l&&!this.isDriftingNow?t-this.lastDriftEndTime>this.driftCooldown&&(this.isDriftingNow=!0,this.driftStartTime=t,this.stopSound("brake",null,!0),this.startSound("drifting",null,!0),console.log("DRIFT START")):!l&&this.isDriftingNow&&t-this.driftStartTime>this.driftMinDuration&&(this.isDriftingNow=!1,this.lastDriftEndTime=t,this.stopSound("drifting",null,!0),console.log("DRIFT STOP")),!c||this.isDriftingNow||this.soundStates.brake?c&&!this.isDriftingNow||!this.soundStates.brake||(this.stopSound("brake"),console.log("BRAKE STOP")):(this.startSound("brake"),console.log("BRAKE START")),this.soundStates.drifting&&(!o||!this.isMoving||i<3)&&(this.stopSound("drifting",null,!0),this.isDriftingNow=!1,console.log("DRIFT FORCE STOP - Safety check")),this.wasDriftingPreviously=this.isDriftingNow,this.wasMoving=this.isMoving},this.updateAcceleration=()=>{const t=Date.now(),i=e.includes("w")||e.includes("arrowup");if(i&&!this.wasAcceleratingPreviously&&(this.accelerationPhase=0,this.accelerationStartTime=t,this.isInGearShift=!1,this.gearShiftTimer=0),i){const e=t-this.accelerationStartTime;if(!this.isInGearShift&&this.accelerationPhase<4){const t=this.accelerationPhases[this.accelerationPhase];(this.accelerationPhase>0&&e>=t.duration||0===this.accelerationPhase&&e>=100)&&this.startGearShift()}this.isInGearShift&&t-this.lastGearShiftTime>=this.gearShiftDuration&&this.completeGearShift(),this.wasAcceleratingPreviously=!0}else this.accelerationPhase=0,this.isInGearShift=!1,this.wasAcceleratingPreviously=!1},this.startGearShift=()=>{this.isInGearShift=!0,this.lastGearShiftTime=Date.now(),this.playGearShiftSound()},this.completeGearShift=()=>{this.isInGearShift=!1,this.accelerationPhase=Math.min(this.accelerationPhase+1,4),this.accelerationStartTime=Date.now()},this.getCurrentMaxForce=()=>this.isInGearShift?.3*this.accelerationPhases[this.accelerationPhase].maxForce:this.accelerationPhases[this.accelerationPhase].maxForce,window.addEventListener("keydown",(t=>{this.isLoaded&&(e.includes(t.key.toLowerCase())||e.push(t.key.toLowerCase()),i())})),window.addEventListener("keyup",(t=>{this.isLoaded&&(e.splice(e.indexOf(t.key.toLowerCase()),1),i())}));const i=()=>{if(this.controlsDisabled)return;this.updateSpeed(),this.updateAcceleration(),e.includes("f")&&(this.toggleWireframe(),e.splice(e.indexOf("f"),1));const i=e.includes("w")||e.includes("arrowup"),r=e.includes(" "),a=e.includes("a")||e.includes("arrowleft"),h=e.includes("d")||e.includes("arrowright"),l=r&&(a||h)&&i&&this.isMoving;if(l&&!this.isDrifting?this.startDrift():!l&&this.isDrifting&&this.stopDrift(),!r||l){r?l&&this.activateBrakeLight():this.deactivateBrakeLight(),this.car.setBrake(0,0),this.car.setBrake(0,1),this.car.setBrake(0,2),this.car.setBrake(0,3);const i=this.isDrifting?this.driftSteerMultiplier:1;if(a?(this.car.setSteeringValue(t*i,2),this.car.setSteeringValue(t*i,3)):h?(this.car.setSteeringValue(t*-i,2),this.car.setSteeringValue(t*-i,3)):o(),e.includes("w")||e.includes("arrowup")){const t=this.getCurrentMaxForce();this.car.applyEngineForce(-1*t,0),this.car.applyEngineForce(-1*t,1),this.car.applyEngineForce(-1*t,2),this.car.applyEngineForce(-1*t,3)}else e.includes("s")||e.includes("arrowdown")?(l||this.activateReverseLight(),this.car.applyEngineForce(1*this.maxForce,0),this.car.applyEngineForce(1*this.maxForce,1),this.car.applyEngineForce(1*this.maxForce,2),this.car.applyEngineForce(1*this.maxForce,3)):(this.car.applyEngineForce(0,0),this.car.applyEngineForce(0,1),this.car.applyEngineForce(0,2),this.car.applyEngineForce(0,3),this.deactivateReverseLight(),l||n())}else this.activateBrakeLight(),s();this.updateSound()},s=()=>{this.car.setBrake(45,0),this.car.setBrake(45,1),this.car.setBrake(45,2),this.car.setBrake(45,3)},n=()=>{this.car.setBrake(25,0),this.car.setBrake(25,1),this.car.setBrake(25,2),this.car.setBrake(25,3)},o=()=>{this.car.setSteeringValue(0,2),this.car.setSteeringValue(0,3)};this.cleanup=()=>{Object.keys(this.sounds).forEach((t=>{if(this.sounds[t]){const e=this.sounds[t];e.fadeInterval&&clearInterval(e.fadeInterval),e.pause(),e.currentTime=0,e.volume=this.getOriginalVolume(t)}})),this.activeSounds.clear(),Object.keys(this.soundStates).forEach((t=>{this.soundStates[t]=!1})),this.isDriftingNow=!1,this.wasDriftingPreviously=!1,this.driftStartTime=0,this.lastDriftEndTime=0,this.fadeOutTimer&&clearTimeout(this.fadeOutTimer),console.log("CLEANUP COMPLETE - All sounds stopped")}}checkHealthStatus(){if(!this.health)return;const t=this.health.isDestroyed;t&&!this.wasDestroyed?(console.log("Car destroyed! Stopping all sounds and disabling controls."),this.onCarDestroyed()):!t&&this.wasDestroyed&&(console.log("Car repaired! Re-enabling controls."),this.onCarRepaired()),this.wasDestroyed=t}onCarDestroyed(){this.stopAllSounds(),this.controlsDisabled=!0,this.car&&this.car.chassisBody&&(this.car.setBrake(0,0),this.car.setBrake(100,1),this.car.setBrake(500,2),this.car.setBrake(0,3),this.car.applyEngineForce(0,0),this.car.applyEngineForce(0,1),this.car.applyEngineForce(0,2),this.car.applyEngineForce(0,3),this.car.setSteeringValue(0,2),this.car.setSteeringValue(0,3)),this.stopDrift(),this.activateBrakeLight()}onCarRepaired(){this.controlsDisabled=!1,this.car&&(this.car.setBrake(0,0),this.car.setBrake(0,1),this.car.setBrake(0,2),this.car.setBrake(0,3)),this.playSound("idle")}update(){this.world.addEventListener("postStep",(()=>{if(this.updateAnimations(),this.handleFlipDetection(),this.checkHealthStatus(),this.updateReverseLightFlarePositions(),this.updateBrakeLightFlarePositions(),this.updateFrontLightFlarePositions(),this.car.wheelInfos&&this.chassis.position&&this.wheels[0]?.position){this.chassis.position.set(this.car.chassisBody.position.x+this.chassisModelPos.x,this.car.chassisBody.position.y+this.chassisModelPos.y,this.car.chassisBody.position.z+this.chassisModelPos.z),this.chassis.quaternion.copy(this.car.chassisBody.quaternion),this.chassisWireframe&&(this.chassisWireframe.position.copy(this.car.chassisBody.position),this.chassisWireframe.quaternion.copy(this.car.chassisBody.quaternion));for(let t=0;t<4;t++)this.car.wheelInfos[t]&&(this.car.updateWheelTransform(t),this.wheels[t].position.copy(this.car.wheelInfos[t].worldTransform.position),this.wheels[t].quaternion.copy(this.car.wheelInfos[t].worldTransform.quaternion))}}))}toggleWireframe(t=null){this.chassisWireframe&&(this.chassisWireframe.visible=null!==t?t:!this.chassisWireframe.visible,console.log("Chassis wireframe visibility:",this.chassisWireframe.visible))}removeWireframe(){this.chassisWireframe&&(this.scene.remove(this.chassisWireframe),this.chassisWireframe.geometry.dispose(),this.chassisWireframe.material.dispose(),this.chassisWireframe=null,console.log("Chassis wireframe removed"))}forceFlipReset(){console.log("Manual flip reset triggered"),this.autoReset()}getFlipStatus(){return{isFlipped:this.isFlipped,timeUpsideDown:this.timeUpsideDown,resetProgress:this.timeUpsideDown/this.flipResetDelay}}cleanup(){console.log("Starting car cleanup..."),this.stopAllSounds(),this.sounds&&(Object.values(this.sounds).forEach((t=>{t&&(t.pause(),t.currentTime=0,t.src="",t.removeEventListener("ended",t.onended))})),this.sounds={}),this.mixer&&(this.mixer.stopAllAction(),this.mixer.uncacheRoot(this.mixer.getRoot()),this.mixer=null),this.boostAnimation=null,this.car&&this.car.chassisBody&&(this.car.removeFromWorld(this.world),this.world.removeBody(this.car.chassisBody)),this.chassis&&(this.chassis.traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose())})),this.scene.remove(this.chassis),this.chassis=null),this.wheels&&this.wheels.length>0&&(this.wheels.forEach((t=>{t&&(t.traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose())})),this.scene.remove(t))})),this.wheels=[]),this.removeWireframe(),this.brakeLight=null,this.originalBrakeLightMaterial&&(this.originalBrakeLightMaterial.dispose(),this.originalBrakeLightMaterial=null),this.followTarget&&(this.scene.remove(this.followTarget),this.followTarget=null),this.isDrifting=!1,this.isBraking=!1,this.isFlipped=!1,this.controlsDisabled=!1,this.wasDestroyed=!1,this.timeUpsideDown=0,this.lastFlipCheck=0,this.car=null,this.scene=null,this.world=null,this.health=null,this.pivot=null,console.log("Car cleanup completed")}}class Py{constructor(t={}){this.container=t.container||document.body,this.position={right:"50px",bottom:"600px"},this.size="50px",this.colors=t.colors||{primary:"#FFDF00",secondary:"#FFD700",tertiary:"#B8860B",quaternary:"#DAA520"},this.animationDuration=t.animationDuration||"3s",this.loader=null,this.textElement=null,this.isVisible=!1,this.textSet=t.textSet||["For Drifting Press W, A or D and SPACE ..","Press L for Front Light ..","Follow the A,B,C,D.... marks for completing the race , cheating will not work ..","AI Police car can damage your car & reduce your health ..","Try to get out of the AI Helicopter shooting Range ..","Heads up! This was built by just one developer, so there might be a few bugs here and there. Appreciate your support and feedback!","Press F to toggle wireframe of your car ..."],this.textStyles=t.textStyles||{fontSize:"16px",color:"#ffffff",fontFamily:"Arial, sans-serif",fontWeight:"normal"},this.showText=!1!==t.showText}getRandomText(){const t=Math.floor(Math.random()*this.textSet.length);return this.textSet[t]}createElement(){const t=document.createElement("div");t.className="custom-loader";const e=document.createElement("section");return e.className="custom-loader-item",t.appendChild(e),t}createTextElement(){const t=document.createElement("div");return t.className="custom-loader-text",t.textContent=this.getRandomText(),t}injectStyles(){if(document.getElementById("loading-component-styles"))return;const t=document.createElement("style");t.id="loading-component-styles",t.textContent=`\n      .custom-loader {\n        height: ${this.size};\n        aspect-ratio: 1;\n        box-sizing: border-box;\n        position: fixed;\n        right: ${this.position.right};\n        top: ${this.position.bottom};\n        transform: rotate(45deg);\n        display: grid;\n        place-content: center;\n        mask: conic-gradient(#000 0 10%), conic-gradient(#000 0 0) content-box exclude;\n        overflow: hidden;\n        z-index: 9999;\n      }\n      \n      .custom-loader:before {\n        content: "";\n        position: absolute;\n        inset: 0;\n        transform: scale(1.5);\n        background: linear-gradient(\n          0,\n          transparent 0%,\n          transparent 10%,\n          transparent 40%,\n          ${this.colors.quaternary} 50%,\n          ${this.colors.primary} 60%,\n          ${this.colors.tertiary} 60%\n        );\n        filter: blur(8px);\n        animation: custom-loader-spin ${this.animationDuration} linear infinite;\n      }\n      \n      @keyframes custom-loader-spin {\n        to {\n          rotate: 1turn;\n        }\n      }\n      \n      .custom-loader-item {\n        background: linear-gradient(45deg, \n          ${this.colors.primary}, \n          ${this.colors.secondary}, \n          ${this.colors.tertiary}, \n          ${this.colors.quaternary}, \n          ${this.colors.tertiary}\n        );\n        height: 5px;\n        width: 5px;\n        border: 5px solid #000;\n        box-shadow: inset -8px -8px 0 black, inset 8px 8px 0 black;\n        aspect-ratio: 1;\n        z-index: 2;\n        filter: unset;\n        position: relative;\n      }\n\n      .custom-loader-text {\n        position: fixed;\n        bottom: 50px;\n        left: 50%;\n        transform: translateX(-50%);\n        z-index: 9999;\n        font-size: ${this.textStyles.fontSize};\n        color: ${this.textStyles.color};\n        font-family: ${this.textStyles.fontFamily};\n        font-weight: ${this.textStyles.fontWeight};\n        text-align: center;\n        white-space: nowrap;\n        animation: custom-loader-text-fade 2s ease-in-out infinite alternate;\n      }\n\n      @keyframes custom-loader-text-fade {\n        0% { opacity: 0.6; }\n        100% { opacity: 1; }\n      }\n    `,document.head.appendChild(t)}show(){this.isVisible||(this.injectStyles(),this.loader=this.createElement(),this.container.appendChild(this.loader),this.showText&&(this.textElement=this.createTextElement(),this.container.appendChild(this.textElement)),this.isVisible=!0)}hide(){this.isVisible&&(this.loader&&(this.loader.remove(),this.loader=null),this.textElement&&(this.textElement.remove(),this.textElement=null),this.isVisible=!1)}toggle(){this.isVisible?this.hide():this.show()}setPosition(t){this.position={...this.position,...t},this.isVisible&&this.loader&&(this.loader.style.right=this.position.right,this.loader.style.top=this.position.top)}setColors(t){this.colors={...this.colors,...t},this.isVisible&&(this.hide(),this.show())}setTextSet(t){this.textSet=t,this.isVisible&&this.textElement&&(this.textElement.textContent=this.getRandomText())}setTextStyles(t){this.textStyles={...this.textStyles,...t},this.isVisible&&(this.hide(),this.show())}updateText(){this.isVisible&&this.textElement&&(this.textElement.textContent=this.getRandomText())}showFor(t){this.show(),setTimeout((()=>{this.hide()}),t)}destroy(){this.hide();const t=document.getElementById("loading-component-styles");t&&t.remove()}static create(t={}){const e=new Py(t);return e.show(),e}}class ky{constructor(t,e,i,s={x:10,y:4,z:10},n={x:0,y:0,z:0},o){this.scene=t,this.world=e,this.loadingManager=o,this.targetCar=i,this.startPosition=s,this.startRotation=n,this.car={},this.chassis={},this.wheels=[],this.chassisDimension={x:2.4,y:1,z:7},this.chassisModelPos={x:0,y:0,z:0},this.wheelScale={frontWheel:1.1,hindWheel:1.1},this.mass=400,this.brakeLight=null,this.originalBrakeLightMaterial=null,this.isBraking=!1,this.initialBrakeLightState=!0,this.isActivated=!1,this.activationTime=0,this.activationDelay=500,this.hitDetected=!1,this.activationMinForce=50,this.maxSpeed=1200,this.maxSteerVal=.6,this.followDistance=5,this.attackDistance=15,this.updateInterval=100,this.lastUpdate=0,this.targetPosition=new pi,this.currentSteer=0,this.currentThrottle=0,this.isAttacking=!1,this.steerDeadZone=.08,this.steerSmoothFactor=.15,this.targetSteer=0,this.straightThreshold=.02,this.alignmentBonus=.95,this.isRecovering=!1,this.recoveryStartTime=0,this.recoveryDuration=2e3,this.stuckThreshold=2,this.stuckCheckInterval=500,this.lastStuckCheck=0,this.stuckCounter=0,this.maxStuckChecks=3,this.lastPosition=new pi,this.positionHistory=[],this.maxHistoryLength=5,this.collisionForce=0,this.minCollisionForce=500,this.recoveryPhase="reverse",this.reverseTime=1e3,this.turnTime=800,this.recoveryDirection=1,this.flipCheckInterval=200,this.lastFlipCheck=0,this.flipThreshold=.3,this.flipTimeThreshold=1e3,this.flipStartTime=0,this.isFlipped=!1,this.flipResetCooldown=2e3,this.lastFlipReset=0,this.debugMode=!0,this.modelsLoaded=!1,this.policeLightsSetup=!1,this.speedActivationEnabled=!0,this.speedActivationThreshold=180,this.speedCheckInterval=100,this.lastSpeedCheck=0,this.previousPosition=null,this.previousTime=0,this.currentSpeed=0,this.speedUnit="kmh",this.audio1=null,this.audio2=null,this.audioLoaded=!1,this.minDistance=5,this.maxDistance=50,this.baseVolume=1,this.currentVolume=0,this.audioStartTime=.3,this.audioEndOffset=.3,this.loader=new hy(5,"Loading Car Models..."),this.isLoaded=!1,this.loader.setOnComplete((()=>{this.isLoaded=!0,console.log("Car models loaded successfully!")}))}setActivated(t){const e=this.isActivated;this.isActivated=t,t&&!e?(this.deactivateBrakeLight(),console.log("AI Car activated - brake lights turned off")):!t&&e&&(this.activateBrakeLight(),console.log("AI Car deactivated - brake lights turned on"))}update(t){this.isActivated?this.isBraking&&this.initialBrakeLightState&&(this.deactivateBrakeLight(),this.initialBrakeLightState=!1):this.isBraking||this.activateBrakeLight(),this.updateBrakeLightFlarePositions(),this.updatePoliceLight(),this.updatePoliceLightPositions()}setupPoliceLight(){if(!this.chassis||!this.chassis.traverse)return void console.warn("Chassis not loaded yet, cannot setup police lights");if(this.policeLightsSetup)return void console.log("Police lights already set up");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.policeLights=[],this.policeLightFlares=[],this.policeAnimation={isActive:!1,startTime:0,speed:5,pattern:"alternating",flickerInterval:1e4,lastFlickerTime:0,isFlickering:!1,flickerDuration:5e3},[{x:-.5,y:.5,z:-.5,isRed:!1},{x:.5,y:.5,z:-.5,isRed:!0},{x:-.3,y:.5,z:-.2,isRed:!1},{x:.3,y:.5,z:-.2,isRed:!0}].forEach(((e,i)=>{const s=e.isRed,n=s?16711680:255,o=[],r=new la({map:t,color:n,transparent:!0,opacity:.9,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),a=new la({map:t,color:n,transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),h=new la({map:t,color:n,transparent:!0,opacity:.3,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),l=new Ma(r);l.scale.set(.8,.8,1),l.visible=!1;const c=new Ma(a);c.scale.set(1.2,1.2,1),c.visible=!1;const d=new Ma(h);d.scale.set(2,2,1),d.visible=!1,l.position.set(e.x,e.y,e.z),c.position.set(e.x,e.y,e.z),d.position.set(e.x,e.y,e.z),this.chassis.add(l),this.chassis.add(c),this.chassis.add(d),o.push(l,c,d),this.policeLightFlares.push(o),this.policeLights.push({position:e,isRed:s,flares:o,intensity:0}),console.log(`Police light ${i} (${s?"RED":"BLUE"}) created at position:`,e)})),this.policeLightsSetup=!0,console.log(`Police lights setup complete with ${this.policeLights.length} lights`)}activatePoliceLight(){this.policeLights&&!this.policeAnimation.isActive&&(this.policeAnimation.isActive=!0,this.policeAnimation.startTime=Date.now(),this.policeAnimation.lastFlickerTime=Date.now())}deactivatePoliceLight(){this.policeLights&&this.policeAnimation.isActive&&(this.policeAnimation.isActive=!1,this.policeAnimation.isFlickering=!1,this.policeLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})))}updatePoliceLight(){if(!this.policeAnimation.isActive||!this.policeLights)return;const t=Date.now(),e=(t-this.policeAnimation.startTime)/1e3*this.policeAnimation.speed;t-this.policeAnimation.lastFlickerTime>=this.policeAnimation.flickerInterval&&!this.policeAnimation.isFlickering&&(this.policeAnimation.isFlickering=!0,this.policeAnimation.flickerStartTime=t);let i=1;if(this.policeAnimation.isFlickering){const e=t-this.policeAnimation.flickerStartTime;if(e<this.policeAnimation.flickerDuration){const t=20;i=Math.sin(e*t)>0?1:.1}else this.policeAnimation.isFlickering=!1,this.policeAnimation.lastFlickerTime=t,i=1}this.policeLights.forEach(((t,s)=>{let n=0;switch(this.policeAnimation.pattern){case"alternating":n=t.isRed?Math.max(0,Math.sin(e)):Math.max(0,Math.sin(e+Math.PI));break;case"together":n=Math.max(0,Math.sin(2*e));break;case"strobe":const i=3*e;n=t.isRed?Math.sin(i)>.5?1:0:Math.sin(i+Math.PI)>.5?1:0}n*=i,t.flares.forEach(((t,e)=>{const i=n>.1;if(t.visible=i,i){const i=[.9,.6,.3][e]||.3;t.material.opacity=i*n;const s=1+.3*n,o=[.8,1.2,2][e]||1;t.scale.set(o*s,o*s,1)}})),t.intensity=n}))}updatePoliceLightPositions(){this.policeLights&&this.policeLights.forEach(((t,e)=>{}))}setPoliceAnimationPattern(t){["alternating","together","strobe"].includes(t)&&(this.policeAnimation.pattern=t)}setPoliceAnimationSpeed(t){this.policeAnimation.speed=Math.max(.1,t)}setPoliceFlickerInterval(t){this.policeAnimation.flickerInterval=1e3*t}triggerPoliceFlicker(){this.policeAnimation.isActive&&!this.policeAnimation.isFlickering&&(this.policeAnimation.isFlickering=!0,this.policeAnimation.flickerStartTime=Date.now())}adjustPoliceLightPosition(t,e,i,s){if(this.policeLights&&this.policeLights[t]){const n=this.policeLights[t],o={x:n.position.x+e,y:n.position.y+i,z:n.position.z+s};n.position=o,n.flares.forEach((t=>{t.position.set(o.x,o.y,o.z)}))}}addPoliceLight(t,e,i,s=!0){if(!this.chassis)return;const n=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png"),o=s?16711680:255,r=[];for(let s=0;s<3;s++){const a=[.8,1.2,2][s],h=new Ma(new la({map:n,color:o,transparent:!0,opacity:[.9,.6,.3][s],depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}));h.scale.set(a,a,1),h.position.set(t,e,i),h.visible=!1,this.chassis.add(h),r.push(h)}this.policeLightFlares.push(r),this.policeLights.push({position:{x:t,y:e,z:i},isRed:s,flares:r,intensity:0})}setupBrakeLight(){if(!this.chassis)return void console.warn("Chassis not loaded yet, cannot setup brake light");const t=(new jl).load("https://threejs.org/examples/textures/lensflare/lensflare0.png");this.brakeLights=[],this.originalBrakeLightMaterials=new Map,this.brakeLightObjects=[],this.brakeLightFlares=[],this.chassis.traverse((e=>{if("Object_12"===e.name){this.brakeLights.push(e),this.brakeLightObjects.push(e),e.material&&this.originalBrakeLightMaterials.set(e,e.material.clone());const i=new la({map:t,color:16711680,transparent:!0,opacity:.8,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),s=new la({map:t,color:16711680,transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,blending:f,alphaTest:.01}),n=new Ma(i);n.scale.set(1.2,1.2,1.2),n.visible=!1;const o=new Ma(s);o.scale.set(1.2,1.2,1.2),o.visible=!1;const r=e.position.clone(),a=new pi(0,0,.3);n.position.copy(r).add(a);const h=new pi(0,0,.8);o.position.copy(r).add(h),this.chassis.add(n),this.chassis.add(o),this.brakeLightFlares.push([n,o]),console.log(`Brake light (${e.name}) setup with TWO lens flares at positions:`,[n.position,o.position])}})),0===this.brakeLights.length?console.warn("Brake lights not found in chassis model"):(this.activateBrakeLight(),console.log("Brake lights activated on startup (car is inactive)"))}activateBrakeLight(){if(this.brakeLights&&!this.isBraking){this.isBraking=!0;const t=new cl({color:16711680,emissive:new Ds(1,0,0).multiplyScalar(.5),emissiveIntensity:10});this.brakeLights.forEach((e=>{e.material=t})),this.brakeLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!0}))})),console.log("Brake lights activated (with lens flare)")}}deactivateBrakeLight(){this.brakeLights&&this.isBraking&&(this.isBraking=!1,this.brakeLights.forEach((t=>{const e=this.originalBrakeLightMaterials.get(t);e&&(t.material=e)})),this.brakeLightFlares.forEach((t=>{t.forEach((t=>{t.visible=!1}))})),console.log("Brake lights deactivated (original state)"))}updateBrakeLightFlarePositions(){this.brakeLights&&this.brakeLightFlares&&this.brakeLights.forEach(((t,e)=>{if(this.brakeLightFlares[e]){const[i,s]=this.brakeLightFlares[e];if(i.parent===this.chassis){const e=t.position.clone(),n=new pi(.8,-.3,-3.2),o=new pi(-.8,-.3,-3.2);i.position.copy(e).add(n),s.position.copy(e).add(o)}else if(i.parent===this.scene){const e=new pi;t.getWorldPosition(e);const n=new pi(0,0,1);this.chassis.getWorldDirection(n);const o=n.clone().multiplyScalar(-.3),r=n.clone().multiplyScalar(-.8);i.position.copy(e).add(o),s.position.copy(e).add(r)}}}))}adjustBrakeFlarePosition(t,e,i,s,n){if(this.brakeLightFlares&&this.brakeLightFlares[t]){const o=this.brakeLightFlares[t];if(o[e]){const r=o[e],a=this.brakeLights[t];if(r.parent===this.chassis){const t=a.position.clone();r.position.copy(t).add(new pi(i,s,n))}else{const t=new pi;a.getWorldPosition(t),r.position.copy(t).add(new pi(i,s,n))}}}}adjustBothBrakeFlares(t,e,i){this.adjustBrakeFlarePosition(t,0,e.x,e.y,e.z),this.adjustBrakeFlarePosition(t,1,i.x,i.y,i.z)}init(){this.loader.show(),this.loadModels(),this.loadAudio(),this.setChassis(),this.setWheels(),this.setupCollisionDetection(),this.setupActivationSystem(),this.update()}loadModels(){const t=new Zg(this.loadingManager),e=new Kg(this.loadingManager);e.setDecoderConfig({type:"js"}),e.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/"),t.setDRACOLoader(e),t.load("./car/Police_Mustang_P.glb",(t=>{this.chassis=t.scene,this.chassis.traverse((t=>{t.isMesh&&(t.castShadow=!0)})),this.chassis.scale.set(1,1,1),this.scene.add(this.chassis),this.modelsLoaded=!0,console.log("Chassis loaded, setting up police lights..."),this.setupPoliceLight(),this.setupBrakeLight(),this.loader.updateProgress(1,"Chassis")}),(t=>{console.log("Chassis loading progress:",t.loaded/t.total*100+"%")}),(t=>{console.error("Error loading chassis:",t),this.loader.setTitle("Error loading chassis model"),this.loader.setDetails("Please check the model file path")})),this.wheels=[];for(let e=0;e<4;e++)t.load("./car/Police_Mustang_Wheel.glb",(t=>{const i=t.scene;this.wheels[e]=i,1===e||3===e?this.wheels[e].scale.set(-1.4*this.wheelScale.frontWheel,1.4*this.wheelScale.frontWheel,-1.4*this.wheelScale.frontWheel):this.wheels[e].scale.set(1.4*this.wheelScale.frontWheel,1.4*this.wheelScale.frontWheel,1.4*this.wheelScale.frontWheel),this.scene.add(this.wheels[e]),this.loader.updateProgress(1,`Wheel ${e+1}`)}),(t=>{console.log(`Wheel ${e} loading progress:`,t.loaded/t.total*100+"%")}),(t=>{console.error(`Error loading wheel ${e}:`,t),this.loader.setTitle(`Error loading wheel ${e+1}`),this.loader.setDetails("Please check the wheel model file path")}))}loadAudio(){console.log("🔊 Loading AI car engine audio..."),this.audio1=new Audio("./sounds/police_siren.mp3"),this.audio2=new Audio("./sounds/policecar_sound.mp3"),this.audio1.loop=!1,this.audio1.volume=0,this.audio1.preload="auto",this.audio2.loop=!1,this.audio2.volume=0,this.audio2.preload="auto",this.audio1.addEventListener("loadedmetadata",(()=>{this.audioLoaded=!0,this.setupAudioLoop()})),this.audio2.addEventListener("loadedmetadata",(()=>{this.audioLoaded=!0,this.setupAudioLoop()})),this.audio1.addEventListener("canplaythrough",(()=>{})),this.audio2.addEventListener("canplaythrough",(()=>{})),this.audio1.addEventListener("error",(t=>{console.error("Audio error details:",{code:this.audio1.error?.code,message:this.audio1.error?.message})})),this.audio2.addEventListener("error",(t=>{})),this.audio1.addEventListener("ended",(()=>{this.isActivated&&this.audioLoaded&&(this.audio1.currentTime=this.audioStartTime,this.audio1.play().catch((t=>console.warn("Audio restart failed:",t))))})),this.audio2.addEventListener("ended",(()=>{this.isActivated&&this.audioLoaded&&(this.audio2.currentTime=this.audioStartTime,this.audio2.play().catch((t=>console.warn("Audio restart failed:",t))))}))}setupAudioLoop(){if(!this.audioLoaded)return;if(!this.audio1||!this.audio2)return void console.warn("Audio elements not available for loop setup");const t=this.audio1.duration,e=this.audio2.duration,i=t-this.audioEndOffset,s=e-this.audioEndOffset;this.audio1.addEventListener("timeupdate",(()=>{this.audio1&&null!==this.audio1.currentTime&&this.audio1.currentTime>=i&&this.isActivated&&(this.audio1.currentTime=this.audioStartTime)})),this.audio2.addEventListener("timeupdate",(()=>{this.audio2&&null!==this.audio2.currentTime&&this.audio2.currentTime>=s&&this.isActivated&&(this.audio2.currentTime=this.audioStartTime)}))}updateAudio(){if(!this.audioLoaded||!this.audio1||!this.audio2)return;const t=this.getDistanceToPlayer(),e=this.calculateVolumeFromDistance(t);this.isActivated?this.startAudio(e):this.stopAudio(),this.smoothVolumeTransition(e)}getDistanceToPlayer(){if(!(this.targetCar&&this.targetCar.car&&this.targetCar.car.chassisBody&&this.car&&this.car.chassisBody))return this.maxDistance;const t=this.car.chassisBody.position,e=this.targetCar.car.chassisBody.position;return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)+Math.pow(e.z-t.z,2))}calculateVolumeFromDistance(t){if(t<=this.minDistance)return this.baseVolume;if(t>=this.maxDistance)return 0;{const e=(t-this.minDistance)/(this.maxDistance-this.minDistance),i=Math.pow(1-e,2);return this.baseVolume*i}}startAudio(t){if(!this.audio1||!this.audio2||!1===this.audio1.paused||!1===this.audio2.paused)return;this.audio1.currentTime=this.audioStartTime,this.audio1.volume=Math.min(t,.1),this.audio2.currentTime=this.audioStartTime,this.audio2.volume=Math.min(t,.1);const e=this.audio1.play(),i=this.audio2.play();void 0!==e&&e.then((()=>{console.log("AI Car audio started successfully")})).catch((t=>{console.warn("Audio play failed (this is normal if user hasn't interacted):",t.name),this.audioPlayIntent=!0})),void 0!==i&&i.then((()=>{console.log("AI Car audio started successfully")})).catch((t=>{console.warn("Audio play failed (this is normal if user hasn't interacted):",t.name),this.audioPlayIntent=!0}))}stopAudio(){if(!this.audio1||!this.audio2||this.audio1.paused||this.audio2.paused)return;const t=setInterval((()=>{this.audio1.volume>.05&&this.audio2.volume>.05?(this.audio1.volume=Math.max(0,this.audio1.volume-.05),this.audio2.volume=Math.max(0,this.audio2.volume-.05)):(this.audio1.volume=0,this.audio1.pause(),this.audio1.currentTime=this.audioStartTime,clearInterval(t),this.audio2.volume=0,this.audio2.pause(),this.audio2.currentTime=this.audioStartTime,clearInterval(t))}),50)}smoothVolumeTransition(t){if(!this.audio1||this.audio1.paused||!this.audio2||this.audio2.paused)return;const e=this.audio1.volume,i=this.audio2.volume,s=t-e,n=t-i;if(Math.abs(s)>.01){const t=.1*s,i=Math.max(0,Math.min(1,e+t));this.audio1.volume=i,this.currentVolume=i,this.debugMode&&Date.now()%1e3<50&&this.getDistanceToPlayer()}if(Math.abs(n)>.01){const t=.1*n,e=Math.max(0,Math.min(1,i+t));this.audio2.volume=e,this.currentVolume=e,this.debugMode&&Date.now()%1e3<50&&this.getDistanceToPlayer()}}handleUserInteraction(){this.audioPlayIntent&&this.audioLoaded&&this.isActivated&&(this.startAudio(this.calculateVolumeFromDistance(this.getDistanceToPlayer())),this.audioPlayIntent=!1)}setChassis(){const t=new hu(new Ud(.5*this.chassisDimension.x,.5*this.chassisDimension.y,.5*this.chassisDimension.z)),e=new du({mass:this.mass,material:new Op({friction:.3})});e.linearDamping=.1,e.angularDamping=.1,e.addShape(t),e.position.set(this.startPosition.x,this.startPosition.y,this.startPosition.z),e.quaternion.setFromAxisAngle(new Ud(0,1,0),this.startRotation.y),e.userData={type:"aiCar",car:this},this.car=new Up({chassisBody:e,indexRightAxis:0,indexUpAxis:1,indexForwardAxis:2}),this.car.addToWorld(this.world)}setWheels(){this.car.wheelInfos=[];const t=[new Ud(1.2,-.5,-1.93),new Ud(-1.2,-.5,-1.93),new Ud(1.2,-.5,1.93),new Ud(-1.2,-.5,1.93)];for(let e=0;e<4;e++)this.car.addWheel({radius:.45,directionLocal:new Ud(0,-1,0),suspensionStiffness:55,suspensionRestLength:.5,frictionSlip:35,dampingRelaxation:2.3,dampingCompression:4.3,maxSuspensionForce:1e4,rollInfluence:.01,axleLocal:new Ud(-1,0,0),chassisConnectionPointLocal:t[e],maxSuspensionTravel:1,customSlidingRotationalSpeed:30});this.car.wheelInfos.forEach(function(t,e){const i=new pm(t.radius,t.radius,t.radius/2,20),s=new du({mass:1,material:new Op({friction:.8})});s.linearDamping=.4,s.angularDamping=.4;const n=(new Kd).setFromEuler(-Math.PI/2,0,0);s.addShape(i,new Ud,n)}.bind(this))}setupActivationSystem(){this.activationInterval=setInterval((()=>{this.checkActivation()}),50)}checkActivation(){const t=Date.now();!this.speedActivationEnabled||this.isActivated||this.hitDetected||this.checkSpeedActivation(),this.debugMode&&this.hitDetected&&!this.isActivated&&(this.activationDelay,this.activationTime),this.hitDetected&&!this.isActivated&&t-this.activationTime>this.activationDelay&&this.activateAI(),this.isActivated&&t-this.lastUpdate>this.updateInterval&&(this.lastUpdate=t,this.makeAIDecision())}calculatePlayerSpeed(){if(!this.targetCar||!this.targetCar.car||!this.targetCar.car.chassisBody)return 0;const t=Date.now(),e=this.targetCar.car.chassisBody.position;if(!this.previousPosition)return this.previousPosition=e.clone(),this.previousTime=t,0;const i=e.distanceTo(this.previousPosition),s=(t-this.previousTime)/1e3;if(0===s)return this.currentSpeed;const n=i/s;let o;return o="mph"===this.speedUnit?2.237*n:3.6*n,this.previousPosition=e.clone(),this.previousTime=t,this.currentSpeed=Math.max(0,o),this.currentSpeed}checkSpeedActivation(){const t=Date.now();if(t-this.lastSpeedCheck<this.speedCheckInterval)return;this.lastSpeedCheck=t;const e=this.calculatePlayerSpeed();e>=this.speedActivationThreshold&&(console.log(`AI Car activated by speed! Player reached ${e.toFixed(1)} ${this.speedUnit}`),this.hitDetected=!0,this.activationTime=t,this.debugMode)}setSpeedActivation(t,e=180,i="kmh"){this.speedActivationEnabled=t,this.speedActivationThreshold=e,this.speedUnit=i}activateAI(){if(console.log("AI Car activated! Starting pursuit..."),this.isActivated=!0,this.deactivateBrakeLight(),this.policeLightsSetup&&this.activatePoliceLight(),this.audioLoaded){const t=this.getDistanceToPlayer(),e=this.calculateVolumeFromDistance(t);this.startAudio(e)}}setupCollisionDetection(){this.car.chassisBody.addEventListener("beginContact",(t=>{const e=t.body;let i=0;if(t.contact){const t=new Ud;this.car.chassisBody.velocity.vsub(e.velocity,t),i=10*t.length()}else i=5*(this.car.chassisBody.velocity.length()+(e.velocity?e.velocity.length():0));if(this.collisionForce=i,this.debugMode,this.targetCar&&this.targetCar.car&&e===this.targetCar.car.chassisBody)return this.debugMode,void(!this.isActivated&&!this.hitDetected&&i>this.activationMinForce&&(this.hitDetected=!0,this.activationTime=Date.now(),this.debugMode));this.isActivated&&i>this.minCollisionForce&&!this.isRecovering&&this.startCollisionRecovery()})),this.car.chassisBody.addEventListener("collide",(t=>{t.contact;const e=t.target===this.car.chassisBody?t.body:t.target;if(!this.hitDetected&&this.targetCar&&this.targetCar.car&&e===this.targetCar.car.chassisBody){const t=this.car.chassisBody.velocity.length()+(e.velocity?e.velocity.length():0);this.debugMode,t>3&&!this.isActivated&&(this.hitDetected=!0,this.activationTime=Date.now())}}))}checkFlipStatus(){if(!this.isActivated)return;const t=Date.now();if(t-this.lastFlipCheck<this.flipCheckInterval||t-this.lastFlipReset<this.flipResetCooldown)return;if(this.lastFlipCheck=t,!this.car.chassisBody)return;const e=new pi(0,1,0),i=new ui(this.car.chassisBody.quaternion.x,this.car.chassisBody.quaternion.y,this.car.chassisBody.quaternion.z,this.car.chassisBody.quaternion.w);e.applyQuaternion(i);const s=e.y<this.flipThreshold;if(s&&!this.isFlipped)this.isFlipped=!0,this.flipStartTime=t,console.log("AI Car flip detected, starting timer...");else if(!s&&this.isFlipped)this.isFlipped=!1,this.flipStartTime=0,console.log("AI Car righted itself");else if(s&&this.isFlipped){const e=t-this.flipStartTime;e>this.flipTimeThreshold&&(console.log(`AI Car has been flipped for ${e}ms, auto-resetting...`),this.resetFromFlip())}}resetFromFlip(){console.log("Auto-resetting AI car from flip");const t=this.car.chassisBody.position,e={x:t.x,y:t.y+3,z:t.z};this.reset(e),this.lastFlipReset=Date.now(),this.isFlipped=!1,this.flipStartTime=0,this.isRecovering=!1,this.recoveryPhase="reverse",this.collisionForce=0,this.stuckCounter=0,this.positionHistory=[]}startCollisionRecovery(){this.isRecovering||(console.log("Starting collision recovery sequence"),this.isRecovering=!0,this.recoveryStartTime=Date.now(),this.recoveryPhase="reverse",this.recoveryDirection=Math.random()<.5?-1:1,this.stuckCounter=0)}checkIfStuck(){if(!this.isActivated)return;const t=Date.now();if(t-this.lastStuckCheck<this.stuckCheckInterval)return;this.lastStuckCheck=t;const e=this.car.chassisBody.position,i=this.car.chassisBody.velocity.length();if(this.targetCar&&this.targetCar.car&&this.targetCar.car.chassisBody){const t=this.targetCar.car.chassisBody.position;if(Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.z-e.z,2))<this.attackDistance)return void(this.stuckCounter=0)}if(this.positionHistory.push({position:new pi(e.x,e.y,e.z),time:t}),this.positionHistory.length>this.maxHistoryLength&&this.positionHistory.shift(),i<this.stuckThreshold&&this.currentThrottle>0){if(this.stuckCounter++,this.positionHistory.length>=3){const t=this.positionHistory[0].position;e.distanceTo(t)<2&&this.stuckCounter>=this.maxStuckChecks&&(console.log("AI Car appears to be stuck (not near player), starting recovery"),this.startCollisionRecovery())}}else this.stuckCounter=Math.max(0,this.stuckCounter-1)}executeRecoveryBehavior(){const t=Date.now(),e=t-this.recoveryStartTime;switch(this.recoveryPhase){case"reverse":this.currentThrottle=.6*-this.maxSpeed,this.currentSteer=this.recoveryDirection*this.maxSteerVal*.3,e>this.reverseTime&&(this.recoveryPhase="turn",this.recoveryStartTime=t);break;case"turn":this.currentThrottle=0,this.currentSteer=this.recoveryDirection*this.maxSteerVal,e>this.turnTime&&(this.recoveryPhase="forward",this.recoveryStartTime=t);break;case"forward":this.currentThrottle=.4*this.maxSpeed,this.currentSteer=0,e>500&&this.finishRecovery()}}finishRecovery(){console.log("Collision recovery completed"),this.isRecovering=!1,this.recoveryPhase="reverse",this.collisionForce=0,this.stuckCounter=0,this.positionHistory=[],this.currentSteer=0,this.currentThrottle=0,this.targetSteer=0}makeAIDecision(){if(!this.isActivated)return;if(this.checkFlipStatus(),this.isFlipped)return this.currentSteer=0,this.currentThrottle=0,void this.applyAIControls();if(this.checkIfStuck(),this.isRecovering)return this.executeRecoveryBehavior(),void this.applyAIControls();if(!this.targetCar||!this.targetCar.car||!this.targetCar.car.chassisBody)return;const t=this.car.chassisBody.position,e=this.targetCar.car.chassisBody.position,i=Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.z-t.z,2));this.isAttacking=i<this.attackDistance;const s=e.x-t.x,n=e.z-t.z,o=this.car.chassisBody.quaternion,r=new pi(0,0,1);r.applyQuaternion(new ui(o.x,o.y,o.z,o.w));const a=new pi(s,0,n).normalize(),h=r.dot(a);if(h>this.alignmentBonus)this.targetSteer=0;else{const t=r.cross(a),e=Math.atan2(t.y,h);if(Math.abs(e)>this.steerDeadZone){let t=1;Math.abs(e)<.3&&(t=.5),this.targetSteer=ei.clamp(e*t,-this.maxSteerVal,this.maxSteerVal)}else this.targetSteer=0}const l=h>.8?2*this.steerSmoothFactor:this.steerSmoothFactor;if(this.currentSteer=ei.lerp(this.currentSteer,this.targetSteer,l),Math.abs(this.currentSteer)<this.straightThreshold&&(this.currentSteer=0),this.isAttacking){const t=Math.abs(this.currentSteer)/this.maxSteerVal;this.currentThrottle=this.maxSpeed*(1-.3*t)}else if(i<this.followDistance)this.currentThrottle=.3*this.maxSpeed;else{const t=Math.abs(this.currentSteer)/this.maxSteerVal;this.currentThrottle=this.maxSpeed*(.7-.2*t)}if(this.isAttacking&&Math.abs(this.currentSteer)>.1&&this.targetCar.car.chassisBody.velocity){const t=this.targetCar.car.chassisBody.velocity,s=i/30;this.targetPosition.set(e.x+t.x*s,e.y,e.z+t.z*s)}else this.targetPosition.set(e.x,e.y,e.z);this.applyAIControls()}applyAIControls(){if(!this.isActivated)return this.car.setSteeringValue(0,2),this.car.setSteeringValue(0,3),this.car.applyEngineForce(0,0),this.car.applyEngineForce(0,1),this.car.applyEngineForce(0,2),void this.car.applyEngineForce(0,3);this.car.setSteeringValue(this.currentSteer,2),this.car.setSteeringValue(this.currentSteer,3);const t=this.currentThrottle*(this.isAttacking&&!this.isRecovering?1.2:1);if(this.car.applyEngineForce(-t,0),this.car.applyEngineForce(-t,1),this.car.applyEngineForce(-t,2),this.car.applyEngineForce(-t,3),this.isAttacking&&!this.isRecovering&&Math.random()<.05){const t=(Math.random()-.5)*this.maxSteerVal*.2,e=ei.clamp(this.currentSteer+t,-this.maxSteerVal,this.maxSteerVal);this.car.setSteeringValue(e,2),this.car.setSteeringValue(e,3)}}reset(t=this.startPosition){this.car.chassisBody.position.set(t.x,t.y,t.z),this.car.chassisBody.angularVelocity.set(0,0,0),this.car.chassisBody.velocity.set(0,0,0),this.car.chassisBody.quaternion.set(0,0,0,1),this.currentSteer=0,this.currentThrottle=0,this.targetSteer=0,this.isRecovering=!1,this.recoveryPhase="reverse",this.collisionForce=0,this.stuckCounter=0,this.positionHistory=[],this.isFlipped=!1,this.flipStartTime=0,this.isActivated||this.setInactiveAppearance()}setInactiveAppearance(){this.deactivatePoliceLight(),this.activateBrakeLight(),this.chassis&&this.chassis.traverse((t=>{t.isMesh&&(t.material=this.inactiveMaterial.clone())})),this.wheels.forEach((t=>{t&&t.traverse((t=>{t.isMesh&&(t.material=this.inactiveMaterial.clone())}))}))}update(){this.world.addEventListener("postStep",(()=>{if(this.isActivated&&this.policeLightsSetup&&this.updatePoliceLight(),this.updateBrakeLightFlarePositions(),this.updateAudio(),this.car.wheelInfos&&this.chassis.position&&this.wheels[0]?.position){this.chassis.position.set(this.car.chassisBody.position.x+this.chassisModelPos.x,this.car.chassisBody.position.y+this.chassisModelPos.y,this.car.chassisBody.position.z+this.chassisModelPos.z),this.chassis.quaternion.copy(this.car.chassisBody.quaternion);for(let t=0;t<4;t++)this.car.wheelInfos[t]&&(this.car.updateWheelTransform(t),this.wheels[t].position.copy(this.car.wheelInfos[t].worldTransform.position),this.wheels[t].quaternion.copy(this.car.wheelInfos[t].worldTransform.quaternion))}}))}getDistanceToTarget(){if(!this.targetCar||!this.targetCar.car||!this.targetCar.car.chassisBody)return 1/0;const t=this.car.chassisBody.position,e=this.targetCar.car.chassisBody.position;return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.z-t.z,2))}getRecoveryStatus(){return{isActivated:this.isActivated,hitDetected:this.hitDetected,isRecovering:this.isRecovering,recoveryPhase:this.recoveryPhase,stuckCounter:this.stuckCounter,collisionForce:this.collisionForce,isFlipped:this.isFlipped,flipDuration:this.isFlipped?Date.now()-this.flipStartTime:0}}forceActivate(){this.isActivated||(this.hitDetected=!0,this.activationTime=Date.now()-this.activationDelay,this.activateAI())}forceDeactivate(){this.isActivated=!1,this.hitDetected=!1,this.setInactiveAppearance(),this.currentSteer=0,this.currentThrottle=0,this.applyAIControls()}forceFlipReset(){this.resetFromFlip()}isAIActivated(){return this.isActivated}playSound(){if(!this.audioLoaded||!this.isActivated)return!1;const t=this.getDistanceToPlayer();if(t>this.maxDistance)return this.pauseSound(),!1;const e=Math.max(0,(this.maxDistance-t)/(this.maxDistance-this.minDistance));this.currentVolume=Math.min(this.baseVolume*e,this.baseVolume);try{if(this.audio1&&this.audio2){this.audio1.currentTime=this.audioStartTime,this.audio2.currentTime=this.audioStartTime,this.audio1.volume=this.currentVolume,this.audio2.volume=this.currentVolume;const t=this.audio1.play();return this.audio2.pause(),void 0!==t&&t.then((()=>{console.log("AI Car audio playing")})).catch((t=>{console.warn("Audio play failed:",t)})),this.audioPlayIntent=!0,!0}}catch(t){return console.warn("Error playing AI Car audio:",t),!1}return!1}pauseSound(){try{return this.audio1&&!this.audio1.paused&&(this.audio1.pause(),console.log("AI Car audio1 paused")),this.audio2&&!this.audio2.paused&&(this.audio2.pause(),console.log("AI Car audio2 paused")),this.audioPlayIntent=!1,this.currentVolume=0,!0}catch(t){return console.warn("Error pausing AI Car audio:",t),!1}}stopSound(){try{return this.audio1&&(this.audio1.pause(),this.audio1.currentTime=this.audioStartTime),this.audio2&&(this.audio2.pause(),this.audio2.currentTime=this.audioStartTime),this.audioPlayIntent=!1,this.currentVolume=0,console.log("AI Car audio stopped"),!0}catch(t){return console.warn("Error stopping AI Car audio:",t),!1}}updateVolume(){if(!this.audioLoaded)return;const t=this.getDistanceToPlayer();if(t>this.maxDistance)return void this.pauseSound();const e=Math.max(0,(this.maxDistance-t)/(this.maxDistance-this.minDistance));this.currentVolume=Math.min(this.baseVolume*e,this.baseVolume),this.audio1&&(this.audio1.volume=this.currentVolume),this.audio2&&(this.audio2.volume=this.currentVolume)}cleanup(){console.log("Cleaning up AI Car..."),this.audio1&&(this.audio1.pause(),this.audio1.src="",this.audio1=null),this.audio2&&(this.audio2.pause(),this.audio2.src="",this.audio2=null),this.audioLoaded=!1,this.audioPlayIntent=!1,this.currentVolume=0,this.activationInterval&&(clearInterval(this.activationInterval),this.activationInterval=null),this.lastSpeedCheck=0,this.previousPosition=null,this.previousTime=0,this.currentSpeed=0,this.car&&this.car.chassisBody&&this.world&&this.car.removeFromWorld(this.world),this.chassis&&this.scene&&(this.scene.remove(this.chassis),this.chassis.traverse((t=>{t.isMesh&&(t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose()))}))),this.wheels&&this.scene&&this.wheels.forEach((t=>{t&&(this.scene.remove(t),t.traverse((t=>{t.isMesh&&(t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose()))})))})),this.scene=null,this.world=null,this.targetCar=null,this.car=null,this.chassis=null,this.wheels=[],this.positionHistory=[],this.targetPosition=null,this.lastPosition=null,this.isActivated=!1,this.hitDetected=!1,this.isRecovering=!1,this.isFlipped=!1,this.isAttacking=!1,this.activationInterval=null,console.log("AI Inactive Car cleanup completed")}setAudioConfiguration(t={}){this.minDistance=t.minDistance||5,this.maxDistance=t.maxDistance||50,this.baseVolume=t.baseVolume||1,this.audioStartTime=t.startTime||.3,this.audioEndOffset=t.endOffset||.3,console.log(`🔧 Audio config updated: Min=${this.minDistance}, Max=${this.maxDistance}, Volume=${this.baseVolume}`)}getAudioStatus(){return{audioLoaded:this.audioLoaded,isPlaying:this.audio1&&!this.audio1.paused&&this.audio2&&this.audio2.paused,currentVolume:this.currentVolume,distance:this.getDistanceToPlayer(),isActivated:this.isActivated}}dispose(){this.cleanup()}}class By{constructor(t,e,i,s={x:0,y:20,z:0}){this.scene=t,this.world=e,this.targetCar=i,this.startPosition=s,this.helicopterBody=null,this.helicopterMesh=null,this.mixer=null,this.clock=new qc,this.mass=500,this.followHeight=12,this.followDistance=8,this.maxForce=8e3,this.targetPosition=new pi,this.currentVelocity=new pi,this.maxSpeed=15,this.minReturnHeight=8,this.targetQuaternion=new ui,this.currentQuaternion=new ui,this.rotationSpeed=.01,this.lastVelocity=new pi,this.velocitySmoothing=.1,this.lastShotTime=0,this.shotInterval=250,this.boxSize=.8,this.shotBoxes=[],this.maxBoxes=1,this.shotSpeed=150,this.shootingDistance=10,this.mainRotor=null,this.tailRotor=null,this.rotorSpeed=0,this.isActive=!0,this.isInitialized=!1,this.activeTime=15e3,this.breakTime=1e4,this.activationStartTime=0,this.breakStartTime=0,this.currentState="active",this.returnSpeed=.02,this.isReturning=!1,this.audio=null,this.audioLoaded=!1,this.minDistance=5,this.maxDistance=50,this.baseVolume=1,this.currentVolume=0,this.audioStartTime=.3,this.audioEndOffset=.3,this.debugCounter=0}init(){console.log("🚁 Initializing AI Helicopter"),this.loadModel(),this.loadAudio(),this.initAudio(),this.createPhysicsBody(),this.startMovementLoop(),this.update(),this.activationStartTime=Date.now(),console.log(`🚁 Helicopter activated for ${this.activeTime/1e3} seconds`)}loadModel(){const t=new Zg,e=new Kg;e.setDecoderConfig({type:"js"}),e.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/"),t.setDRACOLoader(e),t.load("./car/heli.glb",(t=>{this.helicopterMesh=t.scene,this.mixer=new md(this.helicopterMesh);let e=!1;t.animations.forEach((t=>{if(console.log("Found animation clip:",t.name),"Rotor"===t.name||t.name.toLowerCase().includes("rotor")){const i=this.mixer.clipAction(t);i.timeScale=8,i.play(),i.setLoop(_e),e=!0,console.log("🎞️ Playing 'Rotor' animation at 2x speed:",t.name)}})),e||console.warn("⚠️ No 'Rotor' animation found. Available animations:",t.animations.map((t=>t.name))),this.helicopterMesh.traverse((t=>{t.isMesh&&("Object_7"===t.name?(t.castShadow=!0,t.receiveShadow=!1,console.log("☀️ 'Object_7' will cast shadow.")):(t.castShadow=!1,t.receiveShadow=!1));const e=t.name.toLowerCase();(e.includes("rotor")||e.includes("blade")||e.includes("prop"))&&(t.position.y>.5||e.includes("main")?(this.mainRotor=t,console.log("Found main rotor:",t.name)):e.includes("tail")&&(this.tailRotor=t,console.log("Found tail rotor:",t.name)))})),this.helicopterMesh.scale.set(5,5,5),this.helicopterMesh.position.copy(this.startPosition),this.scene.add(this.helicopterMesh),this.isInitialized=!0,console.log("✅ Helicopter model loaded")}),void 0,(t=>{console.error("❌ Error loading helicopter model:",t)}))}loadAudio(){console.log("🔊 Loading helicopter audio..."),this.audio=new Audio("./sounds/helicopter_sound.mp3"),this.audio.loop=!1,this.audio.volume=0,this.audio.preload="auto",this.audio.addEventListener("loadedmetadata",(()=>{console.log(`🔊 Audio loaded. Duration: ${this.audio.duration.toFixed(2)}s`),this.audioLoaded=!0,this.setupAudioLoop()})),this.audio.addEventListener("error",(t=>{}))}setupAudioLoop(){if(!this.audioLoaded)return;const t=this.audio.duration-this.audioEndOffset;this.audio.addEventListener("timeupdate",(()=>{this.audio.currentTime>=t&&(this.audio.currentTime=this.audioStartTime)})),this.audio.currentTime=this.audioStartTime}initAudio(){this.audio3=new Audio("./sounds/fire.mp3"),this.audio3.loop=!0,this.audio3.volume=1,this.audio3.onerror=()=>{console.warn("Could not load audio.mp3")},this.audio3.preload="auto"}createPhysicsBody(){const t=new hu(new Ud(1.5,.8,3));this.helicopterBody=new du({mass:this.mass,material:new Op({friction:.2,restitution:.1})}),this.helicopterBody.addShape(t),this.helicopterBody.position.set(this.startPosition.x,this.startPosition.y,this.startPosition.z),this.helicopterBody.linearDamping=.3,this.helicopterBody.angularDamping=.7,this.world.addBody(this.helicopterBody),console.log("✅ Helicopter physics body created")}startMovementLoop(){const t=()=>{this.isActive&&(this.updateActiveTimeState(),"active"===this.currentState?(this.updateMovement(),this.updateRotation(),this.updateRotors(),this.updateAnimations(),this.checkShootBox()):"returning"===this.currentState?(this.updateReturnToStart(),this.updateRotors(),this.updateAnimations()):"break"===this.currentState&&(this.updateBreakTime(),this.updateRotors(),this.updateAnimations())),requestAnimationFrame(t)};t(),console.log("✅ Movement loop started")}updateActiveTimeState(){const t=Date.now();if("active"===this.currentState)t-this.activationStartTime>=this.activeTime&&(this.currentState="returning",this.isReturning=!0,console.log("🚁 Active time expired, returning to start position"));else if("returning"===this.currentState){if(this.helicopterBody){const e=Math.max(this.startPosition.y,this.minReturnHeight),i=Math.sqrt(Math.pow(this.helicopterBody.position.x-this.startPosition.x,2)+Math.pow(this.helicopterBody.position.z-this.startPosition.z,2)),s=Math.abs(this.helicopterBody.position.y-e);Math.sqrt(i*i+s*s)<2.5&&(this.currentState="break",this.breakStartTime=t,this.isReturning=!1,console.log(`🚁 Reached start position at safe height (${e.toFixed(1)}m), starting break for ${this.breakTime/1e3} seconds`))}}else"break"===this.currentState&&t-this.breakStartTime>=this.breakTime&&(this.currentState="active",this.activationStartTime=t,console.log(`🚁 Break time over, helicopter reactivated for ${this.activeTime/1e3} seconds`));"active"===this.currentState&&this.updateAudio()}updateReturnToStart(){if(!this.helicopterBody)return;const t=this.helicopterBody.position,e=Math.max(this.startPosition.y,this.minReturnHeight),i=this.startPosition.x,s=e,n=this.startPosition.z,o=Math.sqrt(Math.pow(i-t.x,2)+Math.pow(n-t.z,2)),r=Math.abs(s-t.y);if(this.helicopterBody.force.set(0,0,0),o>.5){const e=Math.min(350*o,.7*this.maxForce),s=(i-t.x)/o*e,r=(n-t.z)/o*e;this.helicopterBody.force.x=s,this.helicopterBody.force.z=r}const a=9.82*this.mass;let h=a;if(r>.5){let e=250*(s-t.y);if(t.y<this.minReturnHeight){const i=400*(this.minReturnHeight-t.y);e=Math.max(e,i),console.log(`🚁 Emergency lift applied: ${i.toFixed(1)}N (height: ${t.y.toFixed(1)}m)`)}h+=e}t.y<this.minReturnHeight-1&&(h=Math.max(h,1.5*a)),h=Math.max(.3*a,Math.min(2.5*a,h)),this.helicopterBody.force.y=h;const l=this.helicopterBody.angularVelocity,c=new Ud(100*-l.x,50*-l.y,100*-l.z);this.helicopterBody.torque.set(c.x,c.y,c.z);const d=this.helicopterBody.velocity.length();if(d>10){const t=10/d;this.helicopterBody.velocity.scale(t)}this.updateRotationDuringReturn(),this.updateAudio(),this.debugCounter}updateRotationDuringReturn(){if(!this.helicopterBody||!this.helicopterMesh)return;const t=this.helicopterBody.velocity,e=new pi(t.x,t.y,t.z);if(this.lastVelocity.lerp(e,this.velocitySmoothing),this.lastVelocity.length()>1){const t=this.lastVelocity.clone().normalize(),e=new Hi,i=new pi(0,1,0),s=new pi(0,0,0),n=t.clone();e.lookAt(s,n,i),this.targetQuaternion.setFromRotationMatrix(e),this.currentQuaternion.copy(this.helicopterMesh.quaternion),this.currentQuaternion.slerp(this.targetQuaternion,1.5*this.rotationSpeed),this.helicopterMesh.quaternion.copy(this.currentQuaternion);const o=this.getTurnRate();if(Math.abs(o)>.1){const e=Math.max(-.3,Math.min(.3,.5*o)),i=new ui;i.setFromAxisAngle(t,e),this.helicopterMesh.quaternion.multiplyQuaternions(this.helicopterMesh.quaternion,i)}}}updateBreakTime(){if(!this.helicopterBody)return;const t=this.helicopterBody.position,e=Math.max(this.startPosition.y,this.minReturnHeight),i=this.startPosition.x,s=e,n=this.startPosition.z;this.helicopterBody.force.set(0,0,0),this.helicopterBody.force.x=250*(i-t.x),this.helicopterBody.force.z=250*(n-t.z);const o=9.82*this.mass;let r=250*(s-t.y)+o;if(t.y<this.minReturnHeight){const e=500*(this.minReturnHeight-t.y);r=Math.max(r,o+e)}this.helicopterBody.force.y=r;const a=this.helicopterBody.angularVelocity,h=new Ud(200*-a.x,200*-a.y,200*-a.z);this.helicopterBody.torque.set(h.x,h.y,h.z);const l=this.helicopterBody.velocity.length();if(l>3){const t=3/l;this.helicopterBody.velocity.scale(t)}this.updateAudio()}setMinReturnHeight(t){this.minReturnHeight=Math.max(3,t),console.log(`🚁 Minimum return height set to: ${this.minReturnHeight}m`)}updateAnimations(){if(this.mixer){const t=this.clock.getDelta();this.mixer.update(t)}}updateAudio(){if(!(this.audioLoaded&&this.audio&&this.helicopterBody&&this.targetCar?.car?.chassisBody))return;const t=this.helicopterBody.position,e=this.targetCar.car.chassisBody.position,i=Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)+Math.pow(e.z-t.z,2));let s=1;i>this.minDistance&&(s=i>=this.maxDistance?0:1-(i-this.minDistance)/(this.maxDistance-this.minDistance)),this.currentVolume=s*this.baseVolume,this.audio.volume=this.currentVolume,"active"===this.currentState||"returning"===this.currentState?this.audio.paused&&this.currentVolume>0&&(this.audio.currentTime=this.audioStartTime,this.audio.play().catch((t=>console.warn("Audio play failed:",t)))):"break"===this.currentState&&(this.audio.paused||this.audio.pause())}updateRotation(){if(!this.helicopterBody||!this.helicopterMesh)return;const t=this.helicopterBody.velocity,e=new pi(t.x,t.y,t.z);if(this.lastVelocity.lerp(e,this.velocitySmoothing),this.lastVelocity.length()>2){const t=this.lastVelocity.clone().normalize(),e=new Hi,i=new pi(0,1,0),s=new pi(0,0,0),n=t.clone();e.lookAt(s,n,i),this.targetQuaternion.setFromRotationMatrix(e),this.currentQuaternion.copy(this.helicopterMesh.quaternion),this.currentQuaternion.slerp(this.targetQuaternion,this.rotationSpeed),this.helicopterMesh.quaternion.copy(this.currentQuaternion);const o=this.getTurnRate();if(Math.abs(o)>.1){const e=Math.max(-.3,Math.min(.3,.5*o)),i=new ui;i.setFromAxisAngle(t,e),this.helicopterMesh.quaternion.multiplyQuaternions(this.helicopterMesh.quaternion,i)}}}getTurnRate(){return this.helicopterBody?(this.helicopterBody.velocity,this.helicopterBody.angularVelocity.y):0}updateMovement(){if(!this.helicopterBody||!this.targetCar?.car?.chassisBody)return;const t=this.targetCar.car.chassisBody.position,e=this.targetCar.car.chassisBody.velocity,i=this.helicopterBody.position,s=Math.sqrt(e.x*e.x+e.z*e.z),n=Math.max(.2,Math.min(1,.05*s)),o=this.targetCar.car.chassisBody.quaternion,r=new Ud(0,0,1);o.vmult(r,r),this.targetPosition.set(t.x+r.x*this.followDistance+e.x*n,t.y+this.followHeight,t.z+r.z*this.followDistance+e.z*n);const a=Math.sqrt(Math.pow(this.targetPosition.x-i.x,2)+Math.pow(this.targetPosition.z-i.z,2)),h=Math.abs(this.targetPosition.y-i.y);if(Math.sqrt(a*a+h*h),this.helicopterBody.force.set(0,0,0),a>2){const t=Math.min(400*a,this.maxForce),e=(this.targetPosition.x-i.x)/a*t,s=(this.targetPosition.z-i.z)/a*t;this.helicopterBody.force.x=e,this.helicopterBody.force.z=s}const l=9.82*this.mass;let c=l;h>1&&(c+=200*(this.targetPosition.y-i.y)),c=Math.max(.5*l,Math.min(2*l,c)),this.helicopterBody.force.y=c;const d=this.helicopterBody.angularVelocity,u=new Ud(100*-d.x,50*-d.y,100*-d.z);this.helicopterBody.torque.set(u.x,u.y,u.z);const p=this.helicopterBody.velocity.length();if(p>this.maxSpeed){const t=this.maxSpeed/p;this.helicopterBody.velocity.scale(t)}}updateRotors(){if(!this.helicopterBody)return;const t=this.helicopterBody.velocity.length();this.rotorSpeed=Math.min(30+2*t,60),this.mainRotor&&(this.mainRotor.rotation.y+=.02*this.rotorSpeed),this.tailRotor&&(this.tailRotor.rotation.x+=.025*this.rotorSpeed)}checkShootBox(){if(!this.helicopterBody||!this.targetCar?.car?.chassisBody||"active"!==this.currentState)return void this.stopShootingSound();const t=this.helicopterBody.position,e=this.targetCar.car.chassisBody.position;if(Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)+Math.pow(e.z-t.z,2))<this.shootingDistance){const t=Date.now();t-this.lastShotTime>this.shotInterval&&(this.shootBoxAtCar(),this.lastShotTime=t)}else this.stopShootingSound()}shootBoxAtCar(){if(!this.helicopterBody||!this.targetCar?.car?.chassisBody)return;this.audio3&&this.audio3.paused&&this.audio3.play().catch((t=>{console.warn("Audio play failed:",t)}));const t=Date.now();this.cleanupOldBoxes();const e=this.helicopterBody.position,i=this.targetCar.car.chassisBody.position,s=new pi(i.x-e.x,i.y-e.y,i.z-e.z);s.length(),s.normalize();const n=new pi(e.x,e.y-2,e.z),o=new Cn(new gh(.05*this.boxSize,1.5*this.boxSize,.05*this.boxSize),new ul({color:16729344,emissive:16747520,shininess:80,specular:16766720}));o.position.copy(n),o.castShadow=!0,o.receiveShadow=!0;const r=new hu(new Ud(.5*this.boxSize,.5*this.boxSize,.5*this.boxSize)),a=new du({mass:15,material:new Op({friction:.9,restitution:.2})});a.addShape(r),a.position.set(n.x,n.y,n.z),a.userData={type:"bomb",car:this};const h=new Ud(s.x*this.shotSpeed,s.y*this.shotSpeed,s.z*this.shotSpeed);a.velocity.copy(h),this.scene.add(o),this.world.addBody(a),this.shotBoxes.push({mesh:o,body:a,createdTime:t})}stopShootingSound(){this.audio3&&!this.audio3.paused&&(this.audio3.pause(),this.audio3.currentTime=0)}cleanupOldBoxes(){const t=Date.now();this.shotBoxes=this.shotBoxes.filter((e=>!(t-e.createdTime>100||this.shotBoxes.length>this.maxBoxes)||(this.scene.remove(e.mesh),this.world.removeBody(e.body),e.mesh.geometry.dispose(),e.mesh.material.dispose(),!1)))}update(){this.world.addEventListener("postStep",(()=>{this.helicopterMesh&&this.helicopterBody&&this.helicopterMesh.position.copy(this.helicopterBody.position),this.shotBoxes.forEach((t=>{t.mesh&&t.body&&(t.mesh.position.copy(t.body.position),t.mesh.quaternion.copy(t.body.quaternion))}))}))}setFollowDistance(t){this.followDistance=Math.max(3,t),console.log(`🚁 Follow distance set to: ${this.followDistance}`)}setFollowHeight(t){this.followHeight=Math.max(8,t),console.log(`🚁 Follow height set to: ${this.followHeight}`)}setShotInterval(t){this.shotInterval=Math.max(500,t),console.log(`🚁 Shot interval set to: ${this.shotInterval}ms`)}setShotSpeed(t){this.shotSpeed=Math.max(5,Math.min(50,t)),console.log(`🚁 Shot speed set to: ${this.shotSpeed}`)}setRotationSpeed(t){this.rotationSpeed=Math.max(.01,Math.min(.2,t)),console.log(`🚁 Rotation speed set to: ${this.rotationSpeed}`)}setShootingDistance(t){this.shootingDistance=Math.max(1,t),console.log(`🚁 Shooting distance set to: ${this.shootingDistance}`)}setActiveTime(t){this.activeTime=Math.max(5e3,t),console.log(`🚁 Active time set to: ${this.activeTime/1e3} seconds`)}setBreakTime(t){this.breakTime=Math.max(2e3,t),console.log(`🚁 Break time set to: ${this.breakTime/1e3} seconds`)}forceReturn(){this.currentState="returning",this.isReturning=!0,console.log("🚁 Forced return to start position")}forceActivate(){this.currentState="active",this.activationStartTime=Date.now(),console.log("🚁 Forced activation")}setActive(t){this.isActive=t,console.log("🚁 Helicopter "+(t?"activated":"deactivated"))}reset(t=this.startPosition){const e=Math.max(t.y,this.minReturnHeight),i={x:t.x,y:e,z:t.z};this.helicopterBody&&(this.helicopterBody.position.set(i.x,i.y,i.z),this.helicopterBody.velocity.set(0,0,0),this.helicopterBody.angularVelocity.set(0,0,0)),this.lastVelocity.set(0,0,0),this.currentQuaternion.set(0,0,0,1),this.targetQuaternion.set(0,0,0,1),this.currentState="active",this.activationStartTime=Date.now(),this.breakStartTime=0,this.isReturning=!1,this.shotBoxes.forEach((t=>{this.scene.remove(t.mesh),this.world.removeBody(t.body),t.mesh.geometry.dispose(),t.mesh.material.dispose()})),this.shotBoxes=[],this.lastShotTime=0,console.log(`🚁 Helicopter reset to safe position: (${i.x}, ${i.y}, ${i.z})`)}destroy(){this.isActive=!1,this.helicopterMesh&&this.scene.remove(this.helicopterMesh),this.helicopterBody&&this.world.removeBody(this.helicopterBody),this.shotBoxes.forEach((t=>{this.scene.remove(t.mesh),this.world.removeBody(t.body),t.mesh.geometry.dispose(),t.mesh.material.dispose()})),console.log("🚁 Helicopter destroyed")}setAudioVolume(t){this.baseVolume=Math.max(0,Math.min(1,t)),console.log(`🔊 Base volume set to: ${(100*this.baseVolume).toFixed(0)}%`)}setAudioDistances(t,e){this.minDistance=Math.max(1,t),this.maxDistance=Math.max(this.minDistance+1,e),console.log(`🔊 Audio distances set - Min: ${this.minDistance}m, Max: ${this.maxDistance}m`)}setAudioLoop(t,e){this.audioStartTime=Math.max(0,t),this.audioEndOffset=Math.max(0,e),console.log(`🔊 Audio loop set - Start: ${this.audioStartTime}s, End offset: ${this.audioEndOffset}s`),this.audioLoaded&&this.setupAudioLoop()}getStatus(){const t=Date.now();let e=0;return"active"===this.currentState?e=Math.max(0,this.activeTime-(t-this.activationStartTime)):"break"===this.currentState&&(e=Math.max(0,this.breakTime-(t-this.breakStartTime))),{isActive:this.isActive,isInitialized:this.isInitialized,currentState:this.currentState,timeRemaining:Math.round(e/1e3),shotBoxes:this.shotBoxes.length,rotorSpeed:this.rotorSpeed,shotSpeed:this.shotSpeed,rotationSpeed:this.rotationSpeed,shootingDistance:this.shootingDistance,activeTime:this.activeTime/1e3,breakTime:this.breakTime/1e3,minReturnHeight:this.minReturnHeight,position:this.helicopterBody?{x:this.helicopterBody.position.x,y:this.helicopterBody.position.y,z:this.helicopterBody.position.z}:null,audio:{loaded:this.audioLoaded,playing:!!this.audio&&!this.audio.paused,currentVolume:Math.round(100*this.currentVolume),baseVolume:Math.round(100*this.baseVolume),minDistance:this.minDistance,maxDistance:this.maxDistance}}}getTimeRemaining(){const t=Date.now();return"active"===this.currentState?Math.max(0,this.activeTime-(t-this.activationStartTime)):"break"===this.currentState?Math.max(0,this.breakTime-(t-this.breakStartTime)):0}getStateInfo(){return{state:this.currentState,timeRemaining:Math.round(this.getTimeRemaining()/1e3),isReturning:this.isReturning,distanceToStart:this.helicopterBody?Math.sqrt(Math.pow(this.helicopterBody.position.x-this.startPosition.x,2)+Math.pow(this.helicopterBody.position.y-this.startPosition.y,2)+Math.pow(this.helicopterBody.position.z-this.startPosition.z,2)).toFixed(1):0}}pauseSound(){this.audio3&&(this.audio3.pause(),this.audio3TimeUpdateHandler&&this.audio3.removeEventListener("timeupdate",this.audio3TimeUpdateHandler),this.audio3LoadedMetadataHandler&&this.audio3.removeEventListener("loadedmetadata",this.audio3LoadedMetadataHandler),this.audio3ErrorHandler&&this.audio3.removeEventListener("error",this.audio3ErrorHandler),this.audio3.src="",this.audio3=null),this.audioTimeUpdateHandler=null,this.audioLoadedMetadataHandler=null,this.audioErrorHandler=null,this.audio3TimeUpdateHandler=null,this.audio3LoadedMetadataHandler=null,this.audio3ErrorHandler=null,this.audioLoaded=!1}playSound(){this.pauseSound(),this.audio3=new Audio("./sounds/fire.mp3"),this.audio3ErrorHandler=t=>{console.error("Error playing fire sound:",t),this.onAudioError(t)},this.audio3.addEventListener("timeupdate",this.audio3TimeUpdateHandler),this.audio3.addEventListener("loadedmetadata",this.audio3LoadedMetadataHandler),this.audio3.addEventListener("error",this.audio3ErrorHandler),this.audio3.play().catch((t=>{console.error("Error playing fire sound:",t),this.onAudioError(t)}))}cleanup(){console.log("🧹 Starting helicopter cleanup..."),this.audio&&(this.audio.pause(),this.audioTimeUpdateHandler&&this.audio.removeEventListener("timeupdate",this.audioTimeUpdateHandler),this.audioLoadedMetadataHandler&&this.audio.removeEventListener("loadedmetadata",this.audioLoadedMetadataHandler),this.audioErrorHandler&&this.audio.removeEventListener("error",this.audioErrorHandler),this.audio.src="",this.audio=null),this.audio3&&(this.audio3.pause(),this.audio3TimeUpdateHandler&&this.audio3.removeEventListener("timeupdate",this.audio3TimeUpdateHandler),this.audio3LoadedMetadataHandler&&this.audio3.removeEventListener("loadedmetadata",this.audio3LoadedMetadataHandler),this.audio3ErrorHandler&&this.audio3.removeEventListener("error",this.audio3ErrorHandler),this.audio3.src="",this.audio3=null),this.audioTimeUpdateHandler=null,this.audioLoadedMetadataHandler=null,this.audioErrorHandler=null,this.audio3TimeUpdateHandler=null,this.audio3LoadedMetadataHandler=null,this.audio3ErrorHandler=null,this.audioLoaded=!1,this.isActive=!1,this.isInitialized=!1,this.shotBoxes&&Array.isArray(this.shotBoxes)&&(this.shotBoxes.forEach((t=>{t.mesh&&(this.scene&&this.scene.remove(t.mesh),t.mesh.geometry&&t.mesh.geometry.dispose(),t.mesh.material&&(Array.isArray(t.mesh.material)?t.mesh.material.forEach((t=>{t&&"function"==typeof t.dispose&&t.dispose()})):"function"==typeof t.mesh.material.dispose&&t.mesh.material.dispose())),t.body&&this.world&&this.world.removeBody(t.body)})),this.shotBoxes=[]),this.mixer&&(this.mixer.stopAllAction(),this.mixer.getRoot&&this.mixer.uncacheRoot(this.mixer.getRoot()),this.mixer=null),this.helicopterMesh&&(this.helicopterMesh.traverse((t=>{t.isMesh&&(t.geometry&&"function"==typeof t.geometry.dispose&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>{t&&"function"==typeof t.dispose&&t.dispose()})):"function"==typeof t.material.dispose&&t.material.dispose()))})),this.scene&&this.scene.remove(this.helicopterMesh),this.helicopterMesh=null),this.helicopterBody&&this.world&&(this.world.removeBody(this.helicopterBody),this.helicopterBody=null),this.mainRotor=null,this.tailRotor=null,this.lastShotTime=0,this.activationStartTime=0,this.breakStartTime=0,this.currentState="active",this.isReturning=!1,this.debugCounter=0,this.targetPosition&&"function"==typeof this.targetPosition.set&&this.targetPosition.set(0,0,0),this.currentVelocity&&"function"==typeof this.currentVelocity.set&&this.currentVelocity.set(0,0,0),this.lastVelocity&&"function"==typeof this.lastVelocity.set&&this.lastVelocity.set(0,0,0),this.currentQuaternion&&"function"==typeof this.currentQuaternion.set&&this.currentQuaternion.set(0,0,0,1),this.targetQuaternion&&"function"==typeof this.targetQuaternion.set&&this.targetQuaternion.set(0,0,0,1),this.scene=null,this.world=null,this.targetCar=null,console.log("✅ Helicopter cleanup completed successfully")}}function Ry(){const t=document.createElement("div");t.id="countdown-overlay",t.style.cssText="\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100vw;\n    height: 100vh;\n    background: transparent;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 1000;\n    font-family: Arial, sans-serif;\n    color: white;\n    font-size: 120px;\n    font-weight: bold;\n    text-shadow: \n      -2px -2px 0 #000,\n      2px -2px 0 #000,\n      -2px 2px 0 #000,\n      2px 2px 0 #000,\n      0 0 10px rgba(0,0,0,0.8);\n    pointer-events: none;\n    transition: transform 0.3s ease-out;\n  ",document.body.appendChild(t);let e=10;const i=["10","9","8","7","6","5","4","3","2","1","GO!"];!function s(){e>=0&&(t.textContent=i[10-e],t.style.transform="scale(1.2)",t.style.opacity="1",setTimeout((()=>{t.style.transform="scale(1)"}),100),0===e?setTimeout((()=>{t.remove()}),500):(e--,setTimeout(s,1e3)))}()}class Dy{constructor(t,e,i,s={}){this.scene=t,this.world=e,this.car=i,this.options={width:s.width||1e3,height:s.height||1e3,depth:s.depth||1e3,position:s.position||{x:0,y:0,z:0},showVisualBoundary:!1!==s.showVisualBoundary,boundaryColor:s.boundaryColor||16711680,boundaryOpacity:s.boundaryOpacity||.3,wallThickness:s.wallThickness||10,wallHeight:s.wallHeight||50,forceStrength:s.forceStrength||500,damping:s.damping||.5,enableWarning:!1!==s.enableWarning,warningDistance:s.warningDistance||100,enableAutoReset:!1!==s.enableAutoReset,resetPosition:s.resetPosition||{x:0,y:5,z:0},resetDistance:s.resetDistance||50},this.boundaryWalls=[],this.warningZones=[],this.visualBoundary=null,this.warningUI=null,this.isWarningActive=!1,this.lastForceTime=0,this.limits={minX:this.options.position.x-this.options.width/2,maxX:this.options.position.x+this.options.width/2,minZ:this.options.position.z-this.options.depth/2,maxZ:this.options.position.z+this.options.depth/2,minY:this.options.position.y-this.options.height/2,maxY:this.options.position.y+this.options.height/2}}init(){this.createPhysicsWalls(),this.options.showVisualBoundary&&this.createVisualBoundary(),this.options.enableWarning&&this.createWarningSystem(),this.startBoundaryCheck(),console.log("Game Boundary System initialized with limits:",this.limits)}createPhysicsWalls(){const{position:t,width:e,depth:i,wallThickness:s,wallHeight:n}=this.options;[[t.x,t.y+n/2,t.z+i/2+s/2,0,e+s,n,s],[t.x,t.y+n/2,t.z-i/2-s/2,0,e+s,n,s],[t.x+e/2+s/2,t.y+n/2,t.z,Math.PI/2,i,n,s],[t.x-e/2-s/2,t.y+n/2,t.z,Math.PI/2,i,n,s]].forEach(((t,e)=>{const[i,s,n,o,r,a,h]=t,l=new hu(new Ud(r/2,a/2,h/2)),c=new du({mass:0,material:new Op({friction:.8,restitution:0,frictionEquationStiffness:1e8,frictionEquationRelaxation:3,contactEquationStiffness:1e8,contactEquationRelaxation:3})});if(c.addShape(l),c.position.set(i,s,n),c.quaternion.setFromAxisAngle(new Ud(0,1,0),o),this.world.addBody(c),this.boundaryWalls.push(c),this.options.showVisualBoundary){const t=new Cn(new gh(r,a,h),new Os({color:this.options.boundaryColor,transparent:!0,opacity:.1,wireframe:!0}));t.position.set(i,s,n),t.rotation.y=o,this.scene.add(t)}}))}createVisualBoundary(){const{position:t,width:e,depth:i,boundaryColor:s,boundaryOpacity:n}=this.options,o=new gh(e,20,i),r=new Os({color:s,transparent:!0,opacity:n,wireframe:!0});this.visualBoundary=new Cn(o,r),this.visualBoundary.position.set(t.x,t.y+10,t.z),this.scene.add(this.visualBoundary)}createWarningSystem(){this.warningUI=document.createElement("div"),this.warningUI.id="boundaryWarning",this.warningUI.style.position="fixed",this.warningUI.style.top="50%",this.warningUI.style.left="50%",this.warningUI.style.transform="translate(-50%, -50%)",this.warningUI.style.color="red",this.warningUI.style.fontSize="36px",this.warningUI.style.fontWeight="bold",this.warningUI.style.textShadow="2px 2px 4px rgba(0,0,0,0.5)",this.warningUI.style.zIndex="1000",this.warningUI.style.display="none",this.warningUI.style.pointerEvents="none",this.warningUI.innerHTML="⚠️ BOUNDARY WARNING ⚠️<br>TURN BACK!",document.body.appendChild(this.warningUI)}startBoundaryCheck(){this.boundaryCheckInterval=setInterval((()=>{this.checkBoundary()}),16)}checkBoundary(){if(!this.car||!this.getCarPosition())return;const t=this.getCarPosition(),e=this.getDistanceToNearestBoundary(t);this.options.enableWarning&&e<this.options.warningDistance?this.showWarning():this.hideWarning(),e<30&&this.applyGentleBoundaryCorrection(t),this.options.enableAutoReset&&e<-this.options.resetDistance&&this.resetCarPosition()}getCarPosition(){return this.car.car&&this.car.car.chassisBody?this.car.car.chassisBody.position:this.car.truck&&this.car.truck.chassisBody?this.car.truck.chassisBody.position:this.car.chassisBody?this.car.chassisBody.position:this.car.position?this.car.position:null}getDistanceToNearestBoundary(t){const e=[this.limits.maxX-t.x,t.x-this.limits.minX,this.limits.maxZ-t.z,t.z-this.limits.minZ];return Math.min(...e)}applyGentleBoundaryCorrection(t){const e=this.getCarBody();if(!e)return;const i=Date.now();if(i-this.lastForceTime<100)return;this.lastForceTime=i;const{forceStrength:s,damping:n}=this.options;this.options.position.x,this.options.position.z;let o=0,r=0;const a=25;if(t.x<this.limits.minX+a?o=s*(this.limits.minX+a-t.x)/a:t.x>this.limits.maxX-a&&(o=-s*(t.x-(this.limits.maxX-a))/a),t.z<this.limits.minZ+a?r=s*(this.limits.minZ+a-t.z)/a:t.z>this.limits.maxZ-a&&(r=-s*(t.z-(this.limits.maxZ-a))/a),0!==o||0!==r){const t=new Ud(o,0,r);e.applyForce(t,e.position),Math.abs(o)>0&&(e.velocity.x*=n),Math.abs(r)>0&&(e.velocity.z*=n),e.velocity.y>2&&(e.velocity.y=2),e.angularVelocity.x*=.8,e.angularVelocity.z*=.8}}applyBoundaryForce(t){const e=new Ud(0,0,0),{forceStrength:i}=this.options;this.options.position.x,this.options.position.z,t.x<this.limits.minX+30?e.x=i:t.x>this.limits.maxX-30&&(e.x=-i),t.z<this.limits.minZ+30?e.z=i:t.z>this.limits.maxZ-30&&(e.z=-i);const s=this.getCarBody();!s||0===e.x&&0===e.z||(s.applyImpulse(e,s.position),s.velocity.x*=this.options.damping,s.velocity.z*=this.options.damping)}getCarBody(){return this.car.car&&this.car.car.chassisBody?this.car.car.chassisBody:this.car.truck&&this.car.truck.chassisBody?this.car.truck.chassisBody:this.car.chassisBody?this.car.chassisBody:null}showWarning(){if(!this.isWarningActive&&this.warningUI&&(this.isWarningActive=!0,this.warningUI.style.display="block",this.warningUI.style.animation="pulse 0.5s infinite alternate",!document.getElementById("boundaryWarningStyle"))){const t=document.createElement("style");t.id="boundaryWarningStyle",t.textContent="\n          @keyframes pulse {\n            0% { opacity: 1; }\n            100% { opacity: 0.5; }\n          }\n        ",document.head.appendChild(t)}}hideWarning(){this.isWarningActive&&this.warningUI&&(this.isWarningActive=!1,this.warningUI.style.display="none",this.warningUI.style.animation="")}resetCarPosition(){const t=this.getCarBody();t&&(console.log("Resetting car position due to boundary violation"),t.velocity.set(0,0,0),t.angularVelocity.set(0,0,0),t.position.set(this.options.resetPosition.x,this.options.resetPosition.y,this.options.resetPosition.z),t.quaternion.set(0,0,0,1),t.force.set(0,0,0),t.torque.set(0,0,0),this.car.reset&&this.car.reset(this.options.resetPosition))}isPositionInBounds(t){return t.x>=this.limits.minX&&t.x<=this.limits.maxX&&t.z>=this.limits.minZ&&t.z<=this.limits.maxZ}getSafePosition(t){return{x:Math.max(this.limits.minX,Math.min(this.limits.maxX,t.x)),y:t.y,z:Math.max(this.limits.minZ,Math.min(this.limits.maxZ,t.z))}}updateBoundary(t){this.cleanup(),this.options={...this.options,...t},this.limits={minX:this.options.position.x-this.options.width/2,maxX:this.options.position.x+this.options.width/2,minZ:this.options.position.z-this.options.depth/2,maxZ:this.options.position.z+this.options.depth/2,minY:this.options.position.y-this.options.height/2,maxY:this.options.position.y+this.options.height/2},this.init()}cleanup(){this.boundaryWalls.forEach((t=>{this.world.removeBody(t)})),this.boundaryWalls=[],this.visualBoundary&&(this.scene.remove(this.visualBoundary),this.visualBoundary=null),this.warningUI&&this.warningUI.parentNode&&(this.warningUI.parentNode.removeChild(this.warningUI),this.warningUI=null),this.boundaryCheckInterval&&(clearInterval(this.boundaryCheckInterval),this.boundaryCheckInterval=null);const t=document.getElementById("boundaryWarningStyle");t&&t.remove()}getBoundaryStatus(){const t=this.getCarPosition();return t?{position:t,isInBounds:this.isPositionInBounds(t),distanceToNearestBoundary:this.getDistanceToNearestBoundary(t),isWarningActive:this.isWarningActive,limits:this.limits}:null}}class Iy{constructor(t,e={}){this.car=t,this.options={unit:e.unit||"kmh",maxSpeed:e.maxSpeed||200,minPitch:e.minPitch||0,maxPitch:e.maxPitch||200,audioFile:e.audioFile||null,autoPlay:e.autoPlay||!1,pitchSmoothness:e.pitchSmoothness||.08,volumeSmoothness:e.volumeSmoothness||.12,transitionTime:e.transitionTime||.15,speedSmoothness:e.speedSmoothness||.15,speedSampleSize:e.speedSampleSize||3,throttleBoost:e.throttleBoost||.3,brakeReduction:e.brakeReduction||.2,idleVolume:e.idleVolume||.15,throttleVolume:e.throttleVolume||.4,minPitchChange:e.minPitchChange||.5,minVolumeChange:e.minVolumeChange||.02,...e},this.previousPosition=null,this.previousTime=null,this.currentSpeed=0,this.targetSpeed=0,this.speedHistory=[],this.audioContext=null,this.audioBuffer=null,this.source=null,this.gainNode=null,this.isPlaying=!1,this.isInitialized=!1,this.targetPitch=0,this.currentPitch=0,this.previousTargetPitch=0,this.targetVolume=.7,this.currentVolume=.7,this.previousTargetVolume=.7,this.lastUpdateTime=0,this.keys={w:!1,s:!1},this.keyChangeTime={w:0,s:0},this.initKeyboardListeners(),this.options.audioFile&&this.initAudio()}initKeyboardListeners(){this.onKeyDown=t=>{const e=t.key.toLowerCase(),i=performance.now();"w"!==e&&"arrowup"!==e||this.keys.w?"s"!==e&&"arrowdown"!==e||this.keys.s||(this.keys.s=!0,this.keyChangeTime.s=i):(this.keys.w=!0,this.keyChangeTime.w=i)},this.onKeyUp=t=>{const e=t.key.toLowerCase(),i=performance.now();"w"!==e&&"arrowup"!==e||!this.keys.w?"s"!==e&&"arrowdown"!==e||!this.keys.s||(this.keys.s=!1,this.keyChangeTime.s=i):(this.keys.w=!1,this.keyChangeTime.w=i)},window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp)}removeKeyboardListeners(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)}async initAudio(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),"suspended"===this.audioContext.state&&await this.audioContext.resume(),this.options.audioFile&&await this.loadAudioFile(this.options.audioFile),this.isInitialized=!0,this.options.autoPlay&&this.audioBuffer&&this.startEngine()}catch(t){throw console.error("Error initializing audio:",t),t}}async loadAudioFile(t){try{let e;if(t instanceof File)e=await t.arrayBuffer();else{if("string"!=typeof t)throw new Error("Invalid audio file format");{const i=await fetch(t);e=await i.arrayBuffer()}}return this.audioBuffer=await this.audioContext.decodeAudioData(e),!0}catch(t){throw console.error("Error loading audio file:",t),t}}calculateSpeed(){if(!this.car||!this.car.chassisBody)return 0;const t=Date.now(),e=this.car.chassisBody.position;if(!this.previousPosition)return this.previousPosition=e.clone(),this.previousTime=t,0;const i=e.distanceTo(this.previousPosition),s=(t-this.previousTime)/1e3;if(0===s)return this.currentSpeed;const n=i/s;let o;o="mph"===this.options.unit?2.237*n:3.6*n,o=Math.max(0,o),this.speedHistory.push(o),this.speedHistory.length>this.options.speedSampleSize&&this.speedHistory.shift();const r=this.speedHistory.reduce(((t,e)=>t+e),0)/this.speedHistory.length;return this.targetSpeed=r,this.currentSpeed=this.lerp(this.currentSpeed,this.targetSpeed,this.options.speedSmoothness),this.previousPosition=e.clone(),this.previousTime=t,this.currentSpeed}calculatePitchFromSpeed(t=null){const e=null!==t?t:this.calculateSpeed(),i=performance.now();let s=this.options.minPitch+10;this.keys.w&&i-this.keyChangeTime.w>50?s=Math.min(this.options.maxPitch,Math.max(this.options.minPitch,e/this.options.maxSpeed*100))+100*this.options.throttleBoost:this.keys.s&&i-this.keyChangeTime.s>50&&(s=Math.max(this.options.minPitch,s-100*this.options.brakeReduction));const n=Math.min(this.options.maxPitch,Math.max(this.options.minPitch,s));return Math.abs(n-this.previousTargetPitch)>=this.options.minPitchChange?(this.previousTargetPitch=n,n):this.previousTargetPitch}pitchToPlaybackRate(t){return 1+t/100}async startEngine(){if(this.isInitialized||await this.initAudio(),!this.audioBuffer||this.isPlaying)return!1;try{this.source=this.audioContext.createBufferSource(),this.gainNode=this.audioContext.createGain(),this.source.buffer=this.audioBuffer,this.source.loop=!0,this.source.loopStart=.1,this.source.loopEnd=this.audioBuffer.duration;const t=this.calculatePitchFromSpeed();return this.currentPitch=t,this.targetPitch=t,this.previousTargetPitch=t,this.source.playbackRate.value=this.pitchToPlaybackRate(t),this.currentVolume=.7,this.targetVolume=.7,this.previousTargetVolume=.7,this.gainNode.gain.value=this.currentVolume,this.source.connect(this.gainNode),this.gainNode.connect(this.audioContext.destination),this.source.start(0),this.isPlaying=!0,!0}catch(t){return console.error("Error starting engine sound:",t),!1}}stopEngine(){this.source&&this.isPlaying&&(this.source.stop(),this.isPlaying=!1,this.source=null,this.gainNode=null)}lerp(t,e,i,s=!0){return s&&(i=this.easeInOutQuad(i)),t+(e-t)*i}easeInOutQuad(t){return t<.5?2*t*t:(4-2*t)*t-1}update(){if(!this.isPlaying||!this.source)return;const t=performance.now(),e=this.lastUpdateTime?Math.min((t-this.lastUpdateTime)/1e3,.1):0;this.lastUpdateTime=t;const i=this.calculateSpeed(),s=this.calculatePitchFromSpeed(i);if(Math.abs(s-this.targetPitch)>=this.options.minPitchChange&&(this.targetPitch=s),Math.abs(this.targetPitch-this.currentPitch)>.2){const t=1-Math.pow(1-this.options.pitchSmoothness,60*e);this.currentPitch=this.lerp(this.currentPitch,this.targetPitch,t,!1)}else this.currentPitch=this.targetPitch;const n=performance.now();let o;o=this.keys.w&&n-this.keyChangeTime.w>75?this.options.throttleVolume:this.keys.s&&n-this.keyChangeTime.s>75?1.2*this.options.idleVolume:this.options.idleVolume;const r=Math.min(1,o);if(Math.abs(r-this.targetVolume)>=this.options.minVolumeChange&&(this.targetVolume=r),Math.abs(this.targetVolume-this.currentVolume)>.01){const t=1-Math.pow(1-this.options.volumeSmoothness,60*e);this.currentVolume=this.lerp(this.currentVolume,this.targetVolume,t)}else this.currentVolume=this.targetVolume;const a=this.audioContext.currentTime,h=this.options.transitionTime;if(this.source.playbackRate){const t=this.pitchToPlaybackRate(this.currentPitch);this.source.playbackRate.cancelScheduledValues(a),this.source.playbackRate.exponentialRampToValueAtTime(Math.max(.01,t),a+h)}this.gainNode&&(this.gainNode.gain.cancelScheduledValues(a),this.gainNode.gain.exponentialRampToValueAtTime(Math.max(.001,this.currentVolume),a+h))}setVolume(t,e=!1){const i=Math.max(0,Math.min(1,t));e?(this.currentVolume=i,this.targetVolume=i,this.previousTargetVolume=i,this.gainNode&&(this.gainNode.gain.value=i)):this.targetVolume=i}setPitchSmoothness(t){this.options.pitchSmoothness=Math.max(.001,Math.min(1,t))}setVolumeSmoothness(t){this.options.volumeSmoothness=Math.max(.001,Math.min(1,t))}setSpeedSmoothness(t){this.options.speedSmoothness=Math.max(.001,Math.min(1,t))}setMinPitchChange(t){this.options.minPitchChange=Math.max(.1,t)}setMinVolumeChange(t){this.options.minVolumeChange=Math.max(.001,t)}setTransitionTime(t){this.options.transitionTime=Math.max(.01,t)}getSpeed(){return this.currentSpeed}isThrottlePressed(){return this.keys.w}isBrakePressed(){return this.keys.s}getKeyStates(){return{...this.keys}}setThrottleBoost(t){this.options.throttleBoost=Math.max(0,Math.min(1,t))}setBrakeReduction(t){this.options.brakeReduction=Math.max(0,Math.min(1,t))}getCurrentPitch(){return this.currentPitch}getTargetPitch(){return this.targetPitch}getCurrentVolume(){return this.currentVolume}setMaxSpeed(t){this.options.maxSpeed=t}setSpeedUnit(t){"kmh"!==t&&"mph"!==t||(this.options.unit=t)}isEngineRunning(){return this.isPlaying}cleanup(){this.stopEngine(),this.removeKeyboardListeners(),this.audioContext&&this.audioContext.close(),this.car=null,this.audioContext=null,this.audioBuffer=null}pause(){if(!this.isPlaying||!this.source)return console.warn("Cannot pause: engine is not currently running"),!1;try{return this.pausedState={currentPitch:this.currentPitch,targetPitch:this.targetPitch,previousTargetPitch:this.previousTargetPitch,currentVolume:this.currentVolume,targetVolume:this.targetVolume,previousTargetVolume:this.previousTargetVolume,currentSpeed:this.currentSpeed,targetSpeed:this.targetSpeed,speedHistory:[...this.speedHistory],keys:{...this.keys},keyChangeTime:{...this.keyChangeTime}},this.source.stop(),this.isPlaying=!1,this.source=null,this.gainNode=null,console.log("Engine sound paused successfully"),!0}catch(t){return console.error("Error pausing engine sound:",t),!1}}async resume(){if(this.isPlaying)return console.warn("Cannot resume: engine is already running"),!1;if(!this.pausedState)return console.warn("Cannot resume: no paused state found. Use startEngine() instead."),!1;if(this.isInitialized||await this.initAudio(),!this.audioBuffer)return console.error("Cannot resume: no audio buffer loaded"),!1;try{return this.currentPitch=this.pausedState.currentPitch,this.targetPitch=this.pausedState.targetPitch,this.previousTargetPitch=this.pausedState.previousTargetPitch,this.currentVolume=this.pausedState.currentVolume,this.targetVolume=this.pausedState.targetVolume,this.previousTargetVolume=this.pausedState.previousTargetVolume,this.currentSpeed=this.pausedState.currentSpeed,this.targetSpeed=this.pausedState.targetSpeed,this.speedHistory=[...this.pausedState.speedHistory],this.keys={...this.pausedState.keys},this.keyChangeTime={...this.pausedState.keyChangeTime},this.source=this.audioContext.createBufferSource(),this.gainNode=this.audioContext.createGain(),this.source.buffer=this.audioBuffer,this.source.loop=!0,this.source.loopStart=.1,this.source.loopEnd=this.audioBuffer.duration,this.source.playbackRate.value=this.pitchToPlaybackRate(this.currentPitch),this.gainNode.gain.value=this.currentVolume,this.source.connect(this.gainNode),this.gainNode.connect(this.audioContext.destination),this.source.start(0),this.isPlaying=!0,this.pausedState=null,console.log("Engine sound resumed successfully"),!0}catch(t){return console.error("Error resuming engine sound:",t),!1}}cleanup(){console.log("Cleaning up Sound instance...");try{if(this.stopEngine(),this.removeKeyboardListeners(),this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null),this.source){try{this.source.disconnect()}catch(t){}this.source=null}if(this.gainNode){try{this.gainNode.disconnect()}catch(t){}this.gainNode=null}this.audioContext&&"closed"!==this.audioContext.state&&this.audioContext.close().then((()=>{console.log("Audio context closed successfully")})).catch((t=>{console.error("Error closing audio context:",t)})),this.car=null,this.audioContext=null,this.audioBuffer=null,this.pausedState=null,this.isPlaying=!1,this.isInitialized=!1,this.previousPosition=null,this.previousTime=null,this.currentSpeed=0,this.targetSpeed=0,this.speedHistory=[],this.currentPitch=0,this.targetPitch=0,this.previousTargetPitch=0,this.currentVolume=.7,this.targetVolume=.7,this.previousTargetVolume=.7,this.lastUpdateTime=0,this.keys={w:!1,s:!1},this.keyChangeTime={w:0,s:0},this.onKeyDown=null,this.onKeyUp=null,console.log("Sound instance cleaned up successfully")}catch(t){console.error("Error during cleanup:",t)}}isPaused(){return!this.isPlaying&&null!==this.pausedState&&void 0!==this.pausedState}async togglePlayPause(){return this.isPlaying?this.pause():this.isPaused()?await this.resume():await this.startEngine()}getEngineState(){return this.isPlaying?"playing":this.isPaused()?"paused":"stopped"}forceStop(){return this.stopEngine(),this.pausedState=null,this.currentSpeed=0,this.targetSpeed=0,this.speedHistory=[],this.currentPitch=0,this.targetPitch=0,this.previousTargetPitch=0,this.currentVolume=.7,this.targetVolume=.7,this.previousTargetVolume=.7,this.keys={w:!1,s:!1},this.keyChangeTime={w:0,s:0},!0}}class Fy{constructor(t){this.health=t,this.startTime=Date.now(),this.currentTime=0,this.totalTime=0,this.isRunning=!0,this.timerElement=null,this.createTimerUI(),this.startTimer()}createTimerUI(){this.timerElement=document.createElement("div"),this.timerElement.style.cssText="\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            font-family: 'Courier New', monospace;\n            font-size: 18px;\n            font-weight: bold;\n            color: #ffffff;\n            background-color: rgba(0, 0, 0, 0.7);\n            padding: 10px 15px;\n            border-radius: 5px;\n            z-index: 1000;\n            border: 2px solid #00ff00;\n            text-shadow: 0 0 5px #00ff00;\n            min-width: 120px;\n            text-align: center;\n        ",document.body.appendChild(this.timerElement)}formatTime(t){const e=Math.floor(t/1e3),i=Math.floor(e/60),s=e%60,n=Math.floor(t%1e3/10);return`${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}.${n.toString().padStart(2,"0")}`}startTimer(){this.timerInterval=setInterval((()=>{this.health&&!0===this.health.isDestroyed?this.stopTimer():this.isRunning&&(this.currentTime=Date.now()-this.startTime,this.updateDisplay())}),10)}updateDisplay(){this.timerElement&&(this.timerElement.textContent=`Time: ${this.formatTime(this.currentTime)}`)}stopTimer(){this.isRunning&&(this.isRunning=!1,this.totalTime=this.currentTime,this.timerInterval&&clearInterval(this.timerInterval),this.timerElement&&(this.timerElement.style.color="#ff4444",this.timerElement.style.borderColor="#ff4444",this.timerElement.style.textShadow="0 0 5px #ff4444",this.timerElement.textContent=`Final Time: ${this.formatTime(this.totalTime)}`),console.log(`Timer stopped. Total time: ${this.formatTime(this.totalTime)}`))}getTotalTime(){return this.isRunning?this.currentTime:this.totalTime}getTotalTimeFormatted(){const t=this.getTotalTime();return this.formatTime(t)}pause(){this.isRunning&&(this.isRunning=!1,this.pauseTime=Date.now(),console.log("Timer paused at:",this.formatTime(this.currentTime)))}resume(){this.isRunning||this.health?.isDestroyed||(this.startTime+=Date.now()-this.pauseTime,this.isRunning=!0,console.log("Timer resumed"))}getGameResult(){return{isDestroyed:this.health?.isDestroyed||!1,survivalTime:this.getTotalTime(),survivalTimeFormatted:this.getTotalTimeFormatted(),isRunning:this.isRunning}}reset(){this.stopTimer(),this.startTime=Date.now(),this.currentTime=0,this.totalTime=0,this.isRunning=!0,this.timerElement&&(this.timerElement.style.color="#ffffff",this.timerElement.style.borderColor="#00ff00",this.timerElement.style.textShadow="0 0 5px #00ff00"),this.startTimer()}cleanup(){this.stopTimer(),this.timerElement&&this.timerElement.parentNode&&this.timerElement.parentNode.removeChild(this.timerElement)}}class zy{constructor(t={}){this.mapWidth=t.mapWidth||1600,this.mapHeight=t.mapHeight||800,this.minimapWidth=t.minimapWidth||200,this.minimapHeight=t.minimapHeight||100,this.scale=this.minimapWidth/this.mapWidth,this.container=null,this.canvas=null,this.ctx=null,this.cars=new Map,this.aiCars=new Map,this.backgroundColor=t.backgroundColor||"transparent",this.borderColor=t.borderColor||"#333",this.carColor=t.carColor||"#00ff00",this.aiCarColor=t.aiCarColor||"#ff0000",this.carSize=t.carSize||3,this.backgroundImage=null,this.useBackgroundImage=!1,this.init()}loadBackgroundImage(t){return new Promise(((e,i)=>{const s=new Image;s.onload=()=>{this.backgroundImage=s,this.useBackgroundImage=!0,console.log("Minimap background image loaded successfully"),e(s)},s.onerror=t=>{console.error("Failed to load minimap background image:",t),this.useBackgroundImage=!1,i(t)},s.src=t}))}removeBackgroundImage(){this.backgroundImage=null,this.useBackgroundImage=!1}init(){this.createMinimapElement(),this.setupCanvas()}createMinimapElement(){this.container=document.createElement("div"),this.container.style.position="fixed",this.container.style.bottom="80px",this.container.style.left="20px",this.container.style.width=`${this.minimapWidth}px`,this.container.style.height=`${this.minimapHeight}px`,this.container.style.backgroundColor="transparent",this.container.style.borderRadius="50%",this.container.style.overflow="hidden",this.container.style.zIndex="1000",this.canvas=document.createElement("canvas"),this.canvas.width=this.minimapWidth,this.canvas.height=this.minimapHeight,this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.backgroundColor="transparent",this.container.appendChild(this.canvas),document.body.appendChild(this.container),this.ctx=this.canvas.getContext("2d")}setupCanvas(){this.ctx.imageSmoothingEnabled=!1}registerCar(t,e="car"){const i=t.chassisBody?.id||Math.random().toString(36);"aiCar"===e?this.aiCars.set(i,t):this.cars.set(i,t)}unregisterCar(t,e="car"){const i=t.chassisBody?.id||t.id;"aiCar"===e?this.aiCars.delete(i):this.cars.delete(i)}isAiCarType(t){return!(!t||"string"!=typeof t)&&("aiCar"===t||"aicar"===t||t.startsWith("aicar")||t.toLowerCase().includes("ai"))}scanForCars(t){t&&t.bodies?(this.cars.clear(),this.aiCars.clear(),t.bodies.forEach((t=>{t.userData&&("car"===t.userData.type?this.cars.set(t.id,t.userData.car):(this.isAiCarType(t.userData.type)||"aiCar"===t.userData.belongsTo)&&this.aiCars.set(t.id,t.userData.car))}))):console.warn("Minimap: No world or bodies found")}worldToMinimap(t,e){return{x:(t+this.mapWidth/2)/this.mapWidth*this.minimapWidth,y:(e+this.mapHeight/2)/this.mapHeight*this.minimapHeight}}drawCar(t,e,i,s=this.carSize){this.ctx.save(),this.ctx.fillStyle=i,this.ctx.beginPath(),this.ctx.arc(t,e,s,0,2*Math.PI),this.ctx.fill(),this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=1,this.ctx.stroke(),this.ctx.restore()}drawCarWithDirection(t,e,i,s,n=this.carSize){this.ctx.save(),this.drawCar(t,e,s,n),this.ctx.restore()}clear(){this.ctx.clearRect(0,0,this.minimapWidth,this.minimapHeight),this.useBackgroundImage&&this.backgroundImage?this.ctx.drawImage(this.backgroundImage,0,0,this.minimapWidth,this.minimapHeight):"transparent"!==this.backgroundColor&&(this.ctx.fillStyle=this.backgroundColor,this.ctx.fillRect(0,0,this.minimapWidth,this.minimapHeight))}getChassisBody(t){return t.chassisBody?t.chassisBody:t.car&&t.car.chassisBody?t.car.chassisBody:null}update(){this.clear(),0===this.cars.size+this.aiCars.size&&(this.ctx.fillStyle="#888",this.ctx.font="12px Arial",this.ctx.fillText("No cars found",5,15)),this.cars.forEach(((t,e)=>{const i=this.getChassisBody(t);if(i&&i.position){const t=this.worldToMinimap(i.position.x,i.position.z);if(t.x>=-this.carSize&&t.x<=this.minimapWidth+this.carSize&&t.y>=-this.carSize&&t.y<=this.minimapHeight+this.carSize){const e=i.quaternion?this.getYRotationFromQuaternion(i.quaternion)+Math.PI/2:Math.PI/2;this.drawCarWithDirection(t.x,t.y,e,this.carColor)}else console.log(`Car ${e} outside minimap bounds:`,t)}else console.warn(`Car ${e} missing chassisBody or position`)})),this.aiCars.forEach(((t,e)=>{const i=this.getChassisBody(t);if(i&&i.position){const t=this.worldToMinimap(i.position.x,i.position.z);if(t.x>=-this.carSize&&t.x<=this.minimapWidth+this.carSize&&t.y>=-this.carSize&&t.y<=this.minimapHeight+this.carSize){const e=i.quaternion?this.getYRotationFromQuaternion(i.quaternion)+Math.PI/2:Math.PI/2;this.drawCarWithDirection(t.x,t.y,e,this.aiCarColor)}else console.log(`AI car ${e} outside minimap bounds:`,t)}else console.warn(`AI car ${e} missing chassisBody or position:`,t),t&&console.log("AI car structure keys:",Object.keys(t))})),this.ctx.fillStyle="#fff",this.ctx.font="10px Arial",this.ctx.fillText(`Cars: ${this.cars.size}`,5,this.minimapHeight-15),this.ctx.fillText(`AI: ${this.aiCars.size}`,5,this.minimapHeight-5)}getYRotationFromQuaternion(t){const{x:e,y:i,z:s,w:n}=t;return Math.atan2(2*(n*i+e*s),1-2*(i*i+s*s))}show(){this.container&&(this.container.style.display="block")}hide(){this.container&&(this.container.style.display="none")}setPosition(t,e,i,s){this.container&&(this.container.style.top=void 0!==t?`${t}px`:"auto",this.container.style.right=void 0!==e?`${e}px`:"auto",this.container.style.bottom=void 0!==i?`${i}px`:"auto",this.container.style.left=void 0!==s?`${s}px`:"auto")}setColors(t,e,i){t&&(this.carColor=t),e&&(this.aiCarColor=e),i&&(this.backgroundColor=i,this.container.style.backgroundColor=i)}cleanup(){this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container),this.cars.clear(),this.aiCars.clear(),console.log("Minimap cleaned up successfully.")}}function Oy(){return"true"===localStorage.getItem("antialias")}function Ny(t){localStorage.setItem("antialias",t)}let Wy=[],Hy=null;function Uy(){return"true"===localStorage.getItem("debug")}function Vy(){Wy.forEach((t=>{t&&"function"==typeof t.cleanup&&t.cleanup()})),Wy=[],Hy&&(cancelAnimationFrame(Hy),Hy=null)}function Gy(){pv(),Vy();let t=document.querySelector("canvas.webgl");t||(t=document.createElement("canvas"),t.className="webgl",document.body.appendChild(t)),t.addEventListener("click",(()=>{t.requestPointerLock(),hideCursor()})),document.addEventListener("pointerlockchange",(()=>{document.pointerLockElement===t||showCursor()}));const e=new oa,i=new Dg({gravity:new Ud(0,-9.82,0)});i.broadphase=new mp(i);const s=new Cn(new tl(1890,725),new pl({color:2763306}));s.rotation.x=.5*-Math.PI,s.receiveShadow=!0,e.add(s);const n=new mm,o=new du({mass:0});o.addShape(n),o.quaternion.setFromEuler(-Math.PI/2,0,0),i.addBody(o);let r=new Tc(16777215,1.75*Math.PI);r.position.set(1,1,-1),e.add(r,new _c(16777215,.25*Math.PI));const a=new my(e,i,{x:30,y:0,z:0},{modelPath:"./assets/bumpers.glb",mass:0,friction:.8,restitution:.1,showWireframe:Uy(),wireframeColor:65280});a.init();const h=new my(e,i,{x:0,y:.05,z:0},{modelPath:"./map2/ground.glb",mass:0,friction:.8,restitution:.1,showWireframe:Uy(),wireframeColor:65280,scale:{x:1,y:1,z:1}});let l,c,d,u,p,m,f,g;h.init(),new my(e,i,{x:0,y:.05,z:0},{modelPath:"./map2/asset1.glb",mass:0,friction:.8,restitution:.1,showWireframe:Uy(),wireframeColor:65280,scale:{x:1,y:1,z:1}}).init();let y={x:-500,y:1,z:0};switch(iv){case 1:console.log("Creating Ferrari"),l=new ly(e,i,null,y),Wy.push(l),d=new by(e,i,l,l,{x:2,y:-3.5,z:-18}),d.setSize(.2),u=new by(e,i,l,l,{x:-2,y:-3.5,z:-18}),u.setSize(.2),d.init(),u.init(),m=new wy(e,i,l,{x:.7,y:-1,z:-3.5}),m.setTrailWidth(.4),m.init(),f=new wy(e,i,l,{x:-.7,y:-1,z:-3.5}),f.setTrailWidth(.3),f.init(),g=new Iy(l,{unit:"kmh",maxSpeed:200,audioFile:"./sounds/ferrari_sound.mp3",autoPlay:!0});break;case 2:console.log("Creating Toyota Supra"),l=new cy(e,i,null,y),Wy.push(l),c=new by(e,i,l,l,{x:4,y:-4,z:-18}),c.setSize(.2),c.init(),p=new wy(e,i,l,{x:.7,y:-1.5,z:-2.5}),p.setTrailWidth(.3),p.init(),g=new Iy(l,{unit:"kmh",maxSpeed:200,audioFile:"./sounds/tsupra_sound.mp3",autoPlay:!0});break;case 3:console.log("Creating BMW"),l=new Ey(e,i,null,y),Wy.push(l),c=new by(e,i,l,l,{x:-6.5,y:-5,z:-1.5}),c.setSize(.2),c.init(),p=new wy(e,i,l,{x:-1.35,y:-1.2,z:-.5}),p.setTrailWidth(.3),p.init(),g=new Iy(l,{unit:"kmh",maxSpeed:200,audioFile:"./sounds/bmw_sound.mp3",autoPlay:!0});break;case 4:console.log("Creating Lamborghini Hurracan"),l=new Ly(e,i,null,y),Wy.push(l),d=new by(e,i,l,l,{x:2,y:-2,z:-18}),d.setSize(.2),u=new by(e,i,l,l,{x:-2,y:-2,z:-18}),u.setSize(.2),d.init(),u.init(),m=new wy(e,i,l,{x:.6,y:-.8,z:-3.3}),m.setTrailWidth(.3),m.init(),f=new wy(e,i,l,{x:-.6,y:-.8,z:-3.3}),f.setTrailWidth(.3),f.init(),g=new Iy(l,{unit:"kmh",maxSpeed:200,audioFile:"./sounds/lamborghini_sound.mp3",autoPlay:!0});break;case 5:console.log("Creating Chevrolet_Corvette"),l=new Cy(e,i,null,y),Wy.push(l),d=new by(e,i,l,l,{x:1,y:-4,z:-18}),d.setSize(.2),u=new by(e,i,l,l,{x:-1,y:-4,z:-18}),u.setSize(.2),d.init(),u.init(),m=new wy(e,i,l,{x:.3,y:-1.5,z:-2.5}),m.setTrailWidth(.3),m.init(),f=new wy(e,i,l,{x:-.3,y:-1.5,z:-2.5}),f.setTrailWidth(.3),f.init(),g=new Iy(l,{unit:"kmh",maxSpeed:200,audioFile:"./sounds/corvette_sound.mp3",autoPlay:!0});break;case 6:console.log("Creating Lamborghini Centenario"),l=new Ay(e,i,null,y),Wy.push(l),d=new by(e,i,l,l,{x:1,y:-4,z:-18}),d.setSize(.2),u=new by(e,i,l,l,{x:-1,y:-4,z:-18}),u.setSize(.2),d.init(),u.init(),m=new wy(e,i,l,{x:.2,y:-1.5,z:-2.5}),m.setTrailWidth(.3),m.init(),f=new wy(e,i,l,{x:-.2,y:-1.5,z:-2.5}),f.setTrailWidth(.3),f.init(),g=new Iy(l,{unit:"kmh",maxSpeed:200,audioFile:"./sounds/lamborghini_sound.mp3",autoPlay:!0});break;default:console.log("Creating default Ferrari"),l=new ly(e,i,null,y),Wy.push(l)}l.init();const v=new Sy(i,e,l,100,{healthBarWidth:500,healthBarHeight:20});let w;v.init(),setTimeout((()=>{w=new Fy(v),Wy.push(w)}),4e3),l.setHealthSystem(v);const x=new _y(l,{maxSpeed:280,unit:"km/h",size:300,position:{x:1200,y:400},color:"#999999"});x.init(),Wy.push(l,v,a,x,c,d,u,p,m,f,t,h,g);const b=new Dy(e,i,l,{width:1600,depth:800,height:50,position:{x:0,y:0,z:0},showVisualBoundary:Uy(),boundaryColor:16711680,boundaryOpacity:.2,wallThickness:15,wallHeight:40,forceStrength:10,damping:1,enableWarning:!0,warningDistance:80,enableAutoReset:!0,resetPosition:{x:452,y:5,z:180},resetDistance:60});b.init(),Wy.push(b);const S=new ky(e,i,l,{x:-600,y:4,z:60},{x:0,y:Math.PI/2,z:0});S.init();const M=new ky(e,i,l,{x:-600,y:4,z:-60},{x:0,y:Math.PI/2,z:0});M.init();const T=new ky(e,i,l,{x:-600,y:4,z:120},{x:0,y:Math.PI/2,z:0});T.init();const _=new ky(e,i,l,{x:-600,y:4,z:-120},{x:0,y:Math.PI/2,z:0});_.init();const E=new ky(e,i,l,{x:-600,y:4,z:180},{x:0,y:Math.PI/2,z:0});E.init();const L=new ky(e,i,l,{x:-600,y:4,z:-180},{x:0,y:Math.PI/2,z:0});L.init();const C=new ky(e,i,l,{x:-600,y:4,z:240},{x:0,y:Math.PI/2,z:0});C.init();const A=new ky(e,i,l,{x:-600,y:4,z:-240},{x:0,y:Math.PI/2,z:0});A.init();const P=new ky(e,i,l,{x:-600,y:4,z:300},{x:0,y:Math.PI/2,z:0});P.init();const k=new ky(e,i,l,{x:-600,y:4,z:-300},{x:0,y:Math.PI/2,z:0});k.init();const B=new ky(e,i,l,{x:-600,y:4,z:0},{x:0,y:Math.PI/2,z:0});B.init(),Wy.push(S,M,T,_,E,L,C,A,P,k,B);let R=[S,M,T,_,E,L,C,A,P,k,B];const D=new By(e,i,l,{x:-540,y:150,z:203},"./sound/helicopter_sound.mp3");D.init(),D.setFollowDistance(15),D.setFollowHeight(35),D.setRotationSpeed(1e-5),D.setShootingDistance(50),D.setActiveTime(6e4),D.setBreakTime(8e3),Wy.push(D);const I=new dy(e,i,{x:-580,y:1.5,z:-5},{modelPath:"./assets/block1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:Math.PI/2,z:0},showWireframe:Uy()}),F=new dy(e,i,{x:-580,y:1.5,z:5},{modelPath:"./assets/block1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:Math.PI/2,z:0},showWireframe:Uy()}),z=new dy(e,i,{x:-580,y:1.5,z:10},{modelPath:"./assets/block1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:Math.PI/2,z:0},showWireframe:Uy()}),O=new dy(e,i,{x:-580,y:1.5,z:-10},{modelPath:"./assets/block1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:Math.PI/2,z:0},showWireframe:Uy()}),N=new dy(e,i,{x:-570,y:1.5,z:0},{modelPath:"./assets/cone1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:0,z:0},showWireframe:Uy()}),W=new dy(e,i,{x:-570,y:1.5,z:-7},{modelPath:"./assets/cone2.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:0,z:0},showWireframe:Uy()}),H=new dy(e,i,{x:-570,y:1.5,z:7},{modelPath:"./assets/cone1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:0,z:0},showWireframe:Uy()});I.init(),F.init(),z.init(),O.init(),N.init(),W.init(),H.init(),Wy.push(I,F,z,O,N,W,H);const U=new zy({mapWidth:2400,mapHeight:1200,minimapWidth:200,minimapHeight:200,backgroundColor:"rgba(0, 0, 0, 0.5)"});Wy.push(U);const V=new Py,G={width:window.innerWidth,height:window.innerHeight},j=new Nn(75,G.width/G.height,.1,1e4);j.position.set(0,2,-6);const q=new Od(j,t);q.enableDamping=!0,q.minPolarAngle=Math.PI/4,q.maxPolarAngle=Math.PI/2,q.enablePan=!1,q.target.set(0,1.5,0);const $=new sa({canvas:t,antialias:Oy(),alpha:!0,powerPreference:"high-performance"});$.setSize(G.width,G.height),$.setPixelRatio(Math.min(window.devicePixelRatio,2)),$.shadowMap.enabled=!0;const X=new gy($,"./mud_road_puresky_4k.hdr",2);e.add(X),X.setExposure(1.5);const Y=()=>{G.width=window.innerWidth,G.height=window.innerHeight,j.aspect=G.width/G.height,j.updateProjectionMatrix(),$.setSize(G.width,G.height),$.setPixelRatio(Math.min(window.devicePixelRatio,2))};window.addEventListener("resize",Y);const Z=1/60;let K,J=!0,Q=!1,tt=null;function et(t=!1){if(document.getElementById("gameOverScreen"))return;const e=document.createElement("div");e.id="gameOverScreen",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.color="white",e.style.fontSize="48px",e.style.fontFamily="Arial, sans-serif",e.style.zIndex="1000";const i=t?"GAME PAUSED":"GAME OVER",s=t?"Press ESC to resume or use the buttons below":"Your car has been destroyed!";e.innerHTML=`\n    <div style="text-align: center; background-color: rgba(0, 0, 0, 0.8); padding: 40px; border-radius: 10px;">\n      <h1>${i}</h1>\n      ${t?"":(()=>{const t=Math.floor(w.totalTime/1e3),e=Math.floor(t/60),i=t%60;return`<p>You Survived ${e>0?`${e}m ${i}s`:`${i}s`}</p>`})()}\n\n      <p style="font-size: 24px;">${s}</p>\n\n      ${t?'\n        <button id="resumeButton" style="\n          padding: 10px 20px;\n          font-size: 24px;\n          background-color: rgba(110, 199, 114, 0.3);\n          color: white;\n          border: 2px solid rgba(255, 255, 255, 0.3);\n          border-radius: 10px;\n          cursor: pointer;\n          transition: all 0.3s;\n          backdrop-filter: blur(10px);\n          text-shadow: 2px 2px 4px rgba(0,0,0,0.8);\n        ">Resume Game</button>\n        <br>\n\n        <button id="restartButton" style="\n          padding: 10px 20px;\n          font-size: 24px;\n          background-color: rgba(0, 0, 0, 0.3);\n          color: white;\n          border: 2px solid rgba(255, 255, 255, 0.3);\n          border-radius: 10px;\n          cursor: pointer;\n          transition: all 0.3s;\n          backdrop-filter: blur(10px);\n          text-shadow: 2px 2px 4px rgba(0,0,0,0.8);\n        ">Restart Game</button>\n        <br>\n      ':""}\n\n      <button id="returnToMenu" style="\n          padding: 10px 20px;\n          font-size: 24px;\n          background-color: rgba(184, 95, 95, 0.3);\n          color: white;\n          border: 2px solid rgba(255, 255, 255, 0.3);\n          border-radius: 10px;\n          cursor: pointer;\n          transition: all 0.3s;\n          backdrop-filter: blur(10px);\n          text-shadow: 2px 2px 4px rgba(0,0,0,0.8);\n      ">Main Menu</button>\n    </div>\n  `,document.body.appendChild(e),t&&(document.getElementById("resumeButton").addEventListener("click",(()=>{e.remove(),l.controlsDisabled=!1,Q=!1})),document.getElementById("restartButton").addEventListener("click",(()=>{v.isDestroyed=!0,e&&e.parentNode&&e.remove(),Vy(),V.showFor(5e3),setTimeout((()=>{Gy()}),5e3)}))),document.getElementById("returnToMenu").addEventListener("click",(()=>{v.isDestroyed=!0,e.remove(),pv(),window.removeEventListener("resize",Y),Vy(),V.showFor(5e3),setTimeout((()=>{dv()}),5e3)}))}l.controlsDisabled=!0,setTimeout((()=>{l.controlsDisabled=!1}),1e4),Ry();const it=()=>{if(Hy=requestAnimationFrame(it),g.update(),U.scanForCars(i),U.update(),v.isDestroyed&&J&&(tt||(tt=Date.now(),t.style.display="block"),Date.now()-tt>=5e3&&(et(!1),Vy(),J=!1)),!J||Q)return e.traverse((t=>{t instanceof La&&t.update(j)})),void $.render(e,j);const s=performance.now()/1e3;if(K){const t=s-K;i.step(Z,t)}else i.step(Z);if(K=s,l.car&&l.car.chassisBody){const t=l.car.chassisBody.position;q.target.set(t.x,t.y+2,t.z),q.minDistance=8,q.maxDistance=10,q.update()}e.traverse((t=>{t instanceof La&&t.update(j)})),$.render(e,j)},st=e=>{if("Escape"===e.key)if(e.preventDefault(),Q){const t=document.getElementById("gameOverScreen");t&&t.remove(),l.controlsDisabled=!1,R.forEach((t=>t.playSound())),g.resume(),w.resume(),Q=!1}else l.controlsDisabled=!0,g.pause(),w.pause(),D.reset(),R.forEach((t=>t.pauseSound())),Q=!0,et(!0);if("t"===e.key.toLowerCase()){l&&l.reset&&l.reset({x:30*Math.random()-15,y:4,z:30*Math.random()-15}),aiCar3&&aiCar3.reset&&aiCar3.reset({x:30*Math.random()-15,y:4,z:30*Math.random()-15}),aiCar4&&aiCar4.reset&&aiCar4.reset({x:30*Math.random()-15,y:4,z:30*Math.random()-15}),v&&v.reset&&v.reset(),J=!0,Q=!1,tt=null,t.style.display="block",l&&(l.stopCar&&l.stopCar(),l.stopSound&&l.stopSound());const e=document.getElementById("gameOverScreen");e&&e.remove()}};window.addEventListener("keydown",st),Wy.push({cleanup:()=>{Hy&&cancelAnimationFrame(Hy),window.removeEventListener("keydown",st),window.removeEventListener("resize",Y),e&&(e.traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose())})),e.clear()),$&&($.clear(),$.dispose()),q&&q.dispose(),console.log("Game Cleaned-Up Successfully")}}),it()}let jy=[],qy=null;function $y(){jy.forEach((t=>{t&&"function"==typeof t.cleanup&&t.cleanup()})),jy=[],qy&&(cancelAnimationFrame(qy),qy=null)}let Xy=null,Yy=null,Zy=!0,Ky=null;function Jy(t){if(Ky=t,!Zy)return;Qy();const e=new Audio(t);Xy=e,e.addEventListener("loadedmetadata",(()=>{const t=e.duration-.1;e.currentTime=.1,e.play().catch((t=>console.warn("Audio play failed:",t))),Yy=setInterval((()=>{e.currentTime>=t&&(e.currentTime=.1,e.play().catch((t=>console.warn("Audio loop play failed:",t))))}),50)})),e.addEventListener("error",(t=>{console.error("Audio loading failed:",t),Qy()})),e.addEventListener("ended",(()=>{e.currentTime=.1,e.play().catch((t=>console.warn("Audio ended play failed:",t)))}))}function Qy(){Xy&&(Xy.pause(),Xy.currentTime=0,Xy=null),Yy&&(clearInterval(Yy),Yy=null)}function tv(){const t=new Py,e=document.createElement("div");e.id="showMap",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgb(0, 0, 0)",e.style.background="\n    linear-gradient(90deg, \n      rgba(0, 0, 0, 1) 0%, \n      rgba(0, 0, 0, 0.8) 5%, \n      rgba(0, 0, 0, 0.3) 15%, \n      rgba(0, 0, 0, 0.3) 85%, \n      rgba(0, 0, 0, 0.8) 95%, \n      rgba(0, 0, 0, 1) 100%\n    ),\n    url('./image/menu.png')\n  ",e.style.backgroundSize="80%",e.style.backgroundPosition="center center",e.style.backgroundRepeat="no-repeat",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.zIndex="1000",e.style.fontFamily="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",e.innerHTML='\n    <div style="display: flex; gap: 50px; align-items: center;">\n      \x3c!-- Button Section --\x3e\n      <div style="display: flex; flex-direction: column; gap: 20px;">\n        <button id="map1" style="\n         padding: 20px 40px;\n          font-size: 24px;\n          background-color: rgba(0, 0, 0, 0.3);\n          color: white;\n          border: 2px solid rgba(255, 255, 255, 0.3);\n          border-radius: 10px;\n          cursor: pointer;\n          transition: all 0.3s;\n          backdrop-filter: blur(10px);\n          text-shadow: 2px 2px 4px rgba(0,0,0,0.8);\n        " \n        onmouseover="this.style.backgroundColor=\'rgba(0, 0, 0, 0.3)\'; this.style.transform=\'scale(1.05)\'"\n        onmouseout="this.style.backgroundColor=\'rgba(0, 0, 0, 0.3)\'; this.style.transform=\'scale(1)\'">\n          Map-1\n        </button>\n        \n        <button id="map2" style="\n         padding: 20px 40px;\n          font-size: 24px;\n          background-color: rgba(0, 0, 0, 0.3);\n          color: white;\n          border: 2px solid rgba(255, 255, 255, 0.3);\n          border-radius: 10px;\n          cursor: pointer;\n          transition: all 0.3s;\n          backdrop-filter: blur(10px);\n          text-shadow: 2px 2px 4px rgba(0,0,0,0.8);\n        "\n        onmouseover="this.style.backgroundColor=\'rgba(0, 0, 0, 0.3)\'; this.style.transform=\'scale(1.05)\'"\n        onmouseout="this.style.backgroundColor=\'rgba(0, 0, 0, 0.3)\'; this.style.transform=\'scale(1)\'">\n          Map-2\n        </button>\n        \n        <button disabled id="dev" style="\n          padding: 20px 40px;\n          font-size: 24px;\n          background-color: #ff00007f;\n          color: white;\n          border: none;\n          border-radius: 10px;\n          cursor: not-allowed;\n          transition: background-color 0.3s;\n          box-shadow: 0 4px 8px rgba(0,0,0,0.3);\n        ">\n          Dev ⚒\n        </button>\n        \n        <button id="back" style="\n         padding: 20px 40px;\n          font-size: 24px;\n          background-color: rgba(0, 0, 0, 0.3);\n          color: white;\n          border: 2px solid rgba(255, 255, 255, 0.3);\n          border-radius: 10px;\n          cursor: pointer;\n          transition: all 0.3s;\n          backdrop-filter: blur(10px);\n          text-shadow: 2px 2px 4px rgba(0,0,0,0.8);\n        "\n        onmouseover="this.style.backgroundColor=\'rgba(0, 0, 0, 0.3)\'; this.style.transform=\'scale(1.05)\'"\n        onmouseout="this.style.backgroundColor=\'rgba(0, 0, 0, 0.3)\'; this.style.transform=\'scale(1)\'">\n          Back\n        </button>\n      </div>\n      \n      \x3c!-- Image Preview Section --\x3e\n      <div id="imagePreview" style="\n        width: 800px;\n        height: 600px;\n        border: 3px solid rgba(255, 255, 255, 0.3);\n        border-radius: 15px;\n        background-color: rgba(255, 255, 255, 0.1);\n        backdrop-filter: blur(10px);\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        color: white;\n        font-size: 18px;\n        text-align: center;\n        box-shadow: 0 8px 16px rgba(0,0,0,0.4);\n        transition: all 0.3s ease;\n        background-size: cover;\n        background-position: center;\n        background-repeat: no-repeat;\n      ">\n        <div id="previewText" style="\n          background-color: rgba(0, 0, 0, 0.7);\n          padding: 20px;\n          border-radius: 10px;\n          backdrop-filter: blur(5px);\n        ">\n          Select a Map to Start!\n        </div>\n      </div>\n    </div>\n  ',document.body.appendChild(e);const i=document.getElementById("map1"),s=document.getElementById("map2"),n=document.getElementById("imagePreview"),o=document.getElementById("previewText");i.addEventListener("mouseenter",(()=>{n.style.backgroundImage="url('./image/map_preview_1.png')",o.style.display="none",n.style.borderColor="rgba(255, 255, 255, 0.3)",n.style.transform="scale(1.02)"})),i.addEventListener("mouseleave",(()=>{n.style.backgroundImage="",o.style.display="block",n.style.borderColor="rgba(255, 255, 255, 0.3)",n.style.transform="scale(1)"})),s.addEventListener("mouseenter",(()=>{n.style.backgroundImage="url('./image/map_preview_2.png')",o.style.display="none",n.style.borderColor="rgba(255, 255, 255, 0.3)",n.style.transform="scale(1.02)"})),s.addEventListener("mouseleave",(()=>{n.style.backgroundImage="",o.style.display="block",n.style.borderColor="rgba(255, 255, 255, 0.3)",n.style.transform="scale(1)"})),document.getElementById("map1").addEventListener("click",(()=>{e.remove(),Qy(),t.showFor(5e3),setTimeout((()=>{cv()}),5e3)})),document.getElementById("map2").addEventListener("click",(()=>{e.remove(),Qy(),t.showFor(5e3),setTimeout((()=>{Gy()}),5e3)})),document.getElementById("dev").addEventListener("click",(()=>{e.remove(),t.showFor(5e3),setTimeout((()=>{!function(){pv(),$y();let t=document.querySelector("canvas.webgl");t||(t=document.createElement("canvas"),t.className="webgl",document.body.appendChild(t));const e=new oa,i=new Dg({gravity:new Ud(0,-9.82,0)});i.broadphase=new mp(i);const s=new Cn(new tl(1890,725),new pl({color:2763306}));s.rotation.x=.5*-Math.PI,s.receiveShadow=!0,e.add(s);const n=new mm,o=new du({mass:0});o.addShape(n),o.quaternion.setFromEuler(-Math.PI/2,0,0),i.addBody(o);let r=new Tc(16777215,1.75*Math.PI);r.position.set(1,1,-1),e.add(r,new _c(16777215,.25*Math.PI));let a=!1;const h=new my(e,i,{x:30,y:0,z:0},{modelPath:"./assets/bumpers.glb",mass:0,friction:.8,restitution:.1,showWireframe:a,wireframeColor:65280});h.init(),new my(e,i,{x:-133,y:7.5,z:178},{modelPath:"./assets/trianglebox.glb",mass:0,friction:.8,restitution:.1,showWireframe:a,wireframeColor:65280,rotation:{x:0,y:Math.PI/2,z:0}}).init(),new my(e,i,{x:0,y:.05,z:0},{modelPath:"./map1/ground.glb",mass:0,friction:.8,restitution:.1,showWireframe:a,wireframeColor:65280,scale:{x:1,y:1,z:1}}).init(),new my(e,i,{x:0,y:-8,z:0},{modelPath:"./map1/background1.glb",mass:0,friction:.8,restitution:.1,showWireframe:a,wireframeColor:65280,scale:{x:1,y:1,z:1},rotation:{x:0,y:Math.PI,z:0}}).init();const l=[];for(let t=1;t<=15;t++){const s=new my(e,i,{x:0,y:.1,z:0},{modelPath:`./map1/road${t}.glb`,mass:0,friction:.8,restitution:.1,rotation:{x:0,y:0,z:0},showWireframe:!1,scale:{x:1,y:1,z:1}});s.init(),l.push(s)}const[c,d,u,p,m,f,g,y,v,w,x,b,S,M,T]=l;let _,E,L,C;switch(iv){case 1:console.log("Creating Ferrari"),_=new ly(e,i,null,{x:452,y:1,z:180}),E=new by(e,i,_,_,{x:4,y:-4,z:-18}),E.setSize(.2);break;case 2:console.log("Creating Toyota Supra"),_=new cy(e,i,null,{x:452,y:1,z:180}),E=new by(e,i,_,_,{x:4,y:-4,z:-18}),E.setSize(.2),E.init();break;case 3:console.log("Creating BMW"),_=new Ey(e,i,null,{x:452,y:1,z:180}),E=new by(e,i,_,_,{x:4,y:-4,z:-18}),E.setSize(.2);break;case 4:console.log("Creating Lamborghini Hurracan"),_=new Ly(e,i,null,{x:452,y:1,z:180}),L=new by(e,i,_,_,{x:2,y:-2,z:-18}),L.setSize(.2),C=new by(e,i,_,_,{x:-2,y:-2,z:-18}),C.setSize(.2),L.init(),C.init();break;case 5:console.log("Creating Chevrolet_Corvette"),_=new Cy(e,i,null,{x:452,y:1,z:180}),L=new by(e,i,_,_,{x:1,y:-4,z:-18}),L.setSize(.2),C=new by(e,i,_,_,{x:-1,y:-4,z:-18}),C.setSize(.2),L.init(),C.init();break;case 6:console.log("Creating Lamborghini Centenario"),_=new Ay(e,i,null,{x:452,y:1,z:180}),L=new by(e,i,_,_,{x:1,y:-4,z:-18}),L.setSize(.2),C=new by(e,i,_,_,{x:-1,y:-4,z:-18}),C.setSize(.2),L.init(),C.init();break;default:console.log("Creating default Ferrari"),_=new ly(e,i,null,{x:452,y:1,z:180}),E=new by(e,i,_,_,{x:4,y:-4,z:-18}),E.setSize(.2)}_.init();const A=new wy(e,i,_,{x:.7,y:-1.5,z:-2.5});A.setTrailWidth(.3),A.init();const P=new Sy(i,e,_,100);P.init(),_.setHealthSystem(P);const k=new _y(_,{maxSpeed:280,unit:"km/h",size:300,position:{x:1200,y:400},color:"#999999"});k.init(),jy.push(_,P,h,k,E,A,t),jy.push(c,d,u,p,m,f,g,y,v,w,x,b,S,M,T);const B=new By(e,i,_,{x:-540,y:150,z:203});B.init(),B.setFollowDistance(15),B.setFollowHeight(20),B.setRotationSpeed(1e-5),B.setShootingDistance(50),B.setActiveTime(6e4),B.setBreakTime(8e3),console.log(B.getStateInfo()),jy.push(B);const R=new dy(e,i,{x:-6,y:1.5,z:22},{modelPath:"./car/assets/block1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:Math.PI,z:0},showWireframe:!0}),D=new dy(e,i,{x:-2,y:1.5,z:22},{modelPath:"./car/assets/block1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:Math.PI,z:0},showWireframe:!0}),I=new dy(e,i,{x:2,y:1.5,z:22},{modelPath:"./car/assets/block1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:Math.PI,z:0},showWireframe:!0}),F=new dy(e,i,{x:6,y:1.5,z:22},{modelPath:"./car/assets/block1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:Math.PI,z:0},showWireframe:!0}),z=new dy(e,i,{x:0,y:1.5,z:20},{modelPath:"./car/assets/cone1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:0,z:0},showWireframe:!0}),O=new dy(e,i,{x:6,y:1.5,z:20},{modelPath:"./car/assets/cone2.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:0,z:0},showWireframe:!0}),N=new dy(e,i,{x:-6,y:1.5,z:20},{modelPath:"./car/assets/cone1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:0,z:0},showWireframe:!0});R.init(),D.init(),I.init(),F.init(),z.init(),O.init(),N.init(),jy.push(R,D,I,F,z,O,N);const W=new py(e,i),H=new pi(500.87,1,167.065),U=new pi(600,1,167.065),V=new pi(445.676,1,184.068),G=[new pi(451.87,1,167.065),new pi(351.345,1,172.96),new pi(1.57239,1,172.96),new pi(-501.558,1,172.96),new pi(-576.438,1,176.729),new pi(-619.345,1,142.481),new pi(-634.234,1,111.938),new pi(-631.562,1,68.5428),new pi(-604.71,1,37.746),new pi(-553.933,1,21.4567),new pi(-491.109,1,43.3721),new pi(-362.539,1,84.2808),new pi(-292.552,1,105.929),new pi(-222.317,1,125.252),new pi(-168.99,1,125.252),new pi(-48.4554,1,125.252),new pi(202.841,1,125.252),new pi(257.076,1,124.372),new pi(300.395,1,103.472),new pi(321.295,1,68.1328),new pi(318.635,1,29.3733),new pi(292.035,1,-7.1063),new pi(257.076,1,-22.3061),new pi(216.167,1,-22.3061),new pi(158.456,1,-22.3061),new pi(112.297,1,-22.3061),new pi(70.4979,1,-53.0858),new pi(56.058,1,-91.8453),new pi(65.9379,1,-138.965),new pi(116.857,1,-170.504),new pi(186.986,1,-170.504),new pi(326.514,1,-170.504),new pi(409.062,1,-170.504),new pi(493.813,1,-170.504),new pi(536.752,1,-148.085),new pi(551.339,1,-122.235),new pi(554.992,1,-93.7453),new pi(546.956,1,-61.6027),new pi(535.998,1,-22.155),new pi(525.353,1,19.8734),new pi(530.672,1,55.593),new pi(544.552,1,79.6999),new pi(566.772,1,91.3125),new pi(566.772,1,91.3125),new pi(566.772,1,91.3125),new pi(590.879,1,99.3481),new pi(615.031,1,101.952),new pi(635.171,1,123.992),new pi(633.651,1,154.772),new pi(601.732,1,172.252),new pi(1.57239,1,172.96),new pi(-501.558,1,172.96),new pi(-576.438,1,176.729),new pi(-619.345,1,142.481),new pi(-634.234,1,111.938),new pi(-631.562,1,68.5428),new pi(-604.71,1,37.746),new pi(-553.933,1,21.4567),new pi(-491.109,1,43.3721),new pi(-362.539,1,84.2808),new pi(-292.552,1,105.929),new pi(-222.317,1,125.252),new pi(-168.99,1,125.252),new pi(-48.4554,1,125.252),new pi(202.841,1,125.252),new pi(257.076,1,124.372),new pi(300.395,1,103.472),new pi(321.295,1,68.1328),new pi(318.635,1,29.3733),new pi(292.035,1,-7.1063),new pi(257.076,1,-22.3061),new pi(216.167,1,-22.3061),new pi(158.456,1,-22.3061),new pi(112.297,1,-22.3061),new pi(70.4979,1,-53.0858),new pi(56.058,1,-91.8453),new pi(65.9379,1,-138.965),new pi(116.857,1,-170.504),new pi(186.986,1,-170.504),new pi(326.514,1,-170.504),new pi(409.062,1,-170.504),new pi(493.813,1,-170.504),new pi(536.752,1,-148.085),new pi(551.339,1,-122.235),new pi(554.992,1,-93.7453),new pi(546.956,1,-61.6027),new pi(535.998,1,-22.155),new pi(525.353,1,19.8734),new pi(530.672,1,55.593),new pi(544.552,1,79.6999),new pi(566.772,1,91.3125),new pi(566.772,1,91.3125),new pi(566.772,1,91.3125),new pi(590.879,1,99.3481),new pi(615.031,1,101.952),new pi(635.171,1,123.992),new pi(633.651,1,154.772),new pi(601.732,1,172.252),new pi(1.57239,1,172.96),new pi(-501.558,1,172.96),new pi(-576.438,1,176.729),new pi(-619.345,1,142.481),new pi(-634.234,1,111.938),new pi(-631.562,1,68.5428),new pi(-604.71,1,37.746),new pi(-553.933,1,21.4567),new pi(-491.109,1,43.3721),new pi(-362.539,1,84.2808),new pi(-292.552,1,105.929),new pi(-222.317,1,125.252),new pi(-168.99,1,125.252),new pi(-48.4554,1,125.252),new pi(202.841,1,125.252),new pi(257.076,1,124.372),new pi(300.395,1,103.472),new pi(321.295,1,68.1328),new pi(318.635,1,29.3733),new pi(292.035,1,-7.1063),new pi(257.076,1,-22.3061),new pi(216.167,1,-22.3061),new pi(158.456,1,-22.3061),new pi(112.297,1,-22.3061),new pi(70.4979,1,-53.0858),new pi(56.058,1,-91.8453),new pi(65.9379,1,-138.965),new pi(116.857,1,-170.504),new pi(186.986,1,-170.504),new pi(326.514,1,-170.504),new pi(409.062,1,-170.504),new pi(493.813,1,-170.504),new pi(536.752,1,-148.085),new pi(551.339,1,-122.235),new pi(554.992,1,-93.7453),new pi(546.956,1,-61.6027),new pi(535.998,1,-22.155),new pi(525.353,1,19.8734),new pi(530.672,1,55.593),new pi(544.552,1,79.6999),new pi(566.772,1,91.3125),new pi(566.772,1,91.3125),new pi(566.772,1,91.3125),new pi(590.879,1,99.3481),new pi(615.031,1,101.952),new pi(635.171,1,123.992),new pi(633.651,1,154.772),new pi(601.732,1,172.252)],j=W.createCurvedPath(H,V,G,100),q=W.createAICar(j,H,V);q.carId="r_1",q.setRotation(0,-Math.PI/2,0);const $=W.createAICar(j,U,V);$.carId="r_2",$.setRotation(0,-Math.PI/2,0);const X=W.visualizePath(j,65280);jy.push(W,q,$,X,j);const Y=new My(i,e,_,[q,$]);Y.checkpointConfigs=[{id:"A",...Y.checkpointConfigs[0],position:{x:451.87,y:2,z:167.065},size:{x:50,y:50,z:50},name:"Start/Finish",color:16711680},{id:"B",...Y.checkpointConfigs[1],position:{x:1.57239,y:1,z:172.96},size:{x:50,y:50,z:50},name:"Turn Point 1",color:65280,visible:!0},{id:"C",...Y.checkpointConfigs[2],position:{x:-576.438,y:1,z:176.729},size:{x:50,y:50,z:50},name:"Turn Point 2",color:255,visible:!0},{id:"C",...Y.checkpointConfigs[3],position:{x:-619.345,y:1,z:142.481},size:{x:50,y:15,z:50},name:"Turn Point 2",color:255,visible:!0}],Y.setRequiredCycles(2),Y.setTargetLaps(1),Y.init(),Y.startTimer(),Y.onLapComplete=(t,e)=>{console.log(`Lap ${t} completed!`,e)},Y.onInvalidVisit=(t,e,i)=>{console.log(`Invalid visit: hit ${t}, expected ${e}`)},Y.onProgressUpdate=(t,e,i)=>{console.log(`Progress: ${t}/${e} cycles`)},jy.push(Y);const Z={width:window.innerWidth,height:window.innerHeight},K=new Nn(75,Z.width/Z.height,.1,1e4);K.position.set(0,2,-6);const J=new Od(K,t);J.enableDamping=!0,J.minPolarAngle=Math.PI/4,J.maxPolarAngle=Math.PI/2,J.enablePan=!1,J.target.set(0,1.5,0);const Q=new sa({canvas:t,antialias:!0});Q.setSize(Z.width,Z.height),Q.setPixelRatio(Math.min(window.devicePixelRatio,2)),Q.shadowMap.enabled=!0;const tt=new gy(Q,"./rustig_koppie_puresky_4k.hdr",2);e.add(tt),tt.setExposure(1.5);const et=()=>{Z.width=window.innerWidth,Z.height=window.innerHeight,K.aspect=Z.width/Z.height,K.updateProjectionMatrix(),Q.setSize(Z.width,Z.height),Q.setPixelRatio(Math.min(window.devicePixelRatio,2))};window.addEventListener("resize",et);const it=1/60;let st,nt=!0,ot=!1,rt=null;function at(t=!1){if(document.getElementById("gameOverScreen"))return;const e=document.createElement("div");e.id="gameOverScreen",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.color="white",e.style.fontSize="48px",e.style.fontFamily="Arial, sans-serif",e.style.zIndex="1000";const i=t?"GAME PAUSED":"GAME OVER",s=t?"Press ESC to resume or use the buttons below":"Your car has been destroyed!";e.innerHTML=`\n      <div style="text-align: center; background-color: rgba(0, 0, 0, 0.8); padding: 40px; border-radius: 10px;">\n        <h1>${i}</h1>\n        <p style="font-size: 24px;">${s}</p>\n        ${t?'\n          <button id="resumeButton" style="\n            padding: 10px 20px;\n            font-size: 20px;\n            background-color: #4CAF50;\n            color: white;\n            border: none;\n            border-radius: 5px;\n            cursor: pointer;\n            margin-top: 20px;\n          ">Resume Game</button>\n          <br>\n        ':""}\n        <button id="restartButton" style="\n          padding: 10px 20px;\n          font-size: 20px;\n          background-color: #ff4444;\n          color: white;\n          border: none;\n          border-radius: 5px;\n          cursor: pointer;\n          margin-top: 20px;\n        ">Restart Game</button>\n        <br>\n        <button id="returnToMenu" style="\n          padding: 10px 20px;\n          font-size: 20px;\n          background-color: #ff4444;\n          color: white;\n          border: none;\n          border-radius: 5px;\n          cursor: pointer;\n          margin-top: 10px;\n        ">Main Menu</button>\n      </div>\n    `,document.body.appendChild(e),t&&document.getElementById("resumeButton").addEventListener("click",(()=>{e.remove(),_.controlsDisabled=!1,ot=!1})),document.getElementById("restartButton").addEventListener("click",(()=>{P.isDestroyed=!0,e&&e.parentNode&&e.remove(),$y(),setTimeout((()=>{startGame()}),4e4)})),document.getElementById("returnToMenu").addEventListener("click",(()=>{P.isDestroyed=!0,e.remove(),pv(),window.removeEventListener("resize",et),$y(),setTimeout((()=>{dv()}),4e4)}))}_.controlsDisabled=!0,q.isControlDisabled=!0,$.isControlDisabled=!0,setTimeout((()=>{_.controlsDisabled=!1,q.isControlDisabled=!1,$.isControlDisabled=!1}),3e3),Ry();const ht=()=>{if(qy=requestAnimationFrame(ht),P.isDestroyed&&nt&&(rt||(rt=Date.now(),t.style.display="block"),Date.now()-rt>=1e4&&(at(!1),nt=!1)),Y.raceFinished&&nt&&(rt||(rt=Date.now(),t.style.display="block"),_.onCarDestroyed(),q.stopCar(),$.stopCar(),Date.now()-rt>=1e4&&(function(){if(document.getElementById("CheckpointReached"))return;const t=document.createElement("div");t.id="CheckpointReached",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.color="white",t.style.fontSize="48px",t.style.fontFamily="Arial, sans-serif",t.style.zIndex="1000",t.innerHTML='\n    <div style="text-align: center; background-color: rgba(0, 0, 0, 0.8); padding: 40px; border-radius: 10px;">\n      <h1>CheckPoint Reached</h1>\n      <button id="restartButton" style="\n        padding: 10px 20px;\n        font-size: 20px;\n        background-color: #ff4444;\n        color: white;\n        border: none;\n        border-radius: 5px;\n        cursor: pointer;\n        margin-top: 20px;\n        margin-right: 10px;\n      ">Restart Game</button>\n      <button id="returnToMenu" style="\n        padding: 10px 20px;\n        font-size: 20px;\n        background-color: #ff4444;\n        color: white;\n        border: none;\n        border-radius: 5px;\n        cursor: pointer;\n        margin-top: 20px;\n      ">Main Menu</button>\n    </div>\n  ',document.body.appendChild(t);const e=document.getElementById("restartButton");e&&e.addEventListener("click",(()=>{P.isDestroyed=!0,t.remove(),pv(),window.removeEventListener("resize",et),$y(),setTimeout((()=>{startGame()}),4e4)}));const i=document.getElementById("returnToMenu");i&&i.addEventListener("click",(()=>{P.isDestroyed=!0,t.remove(),pv(),window.removeEventListener("resize",et),$y(),setTimeout((()=>{dv()}),4e4)}))}(),nt=!1)),!nt||ot)return e.traverse((t=>{t instanceof La&&t.update(K)})),void Q.render(e,K);const s=performance.now()/1e3;if(st){const t=s-st;i.step(it,t)}else i.step(it);if(st=s,_.car&&_.car.chassisBody){const t=_.car.chassisBody.position;J.target.set(t.x,t.y+2,t.z),J.minDistance=8,J.maxDistance=10,J.update()}if(_.truck&&_.truck.chassisBody){const t=_.truck.chassisBody.position;J.target.set(t.x,t.y+5,t.z),J.minDistance=20,J.maxDistance=35,J.update()}e.traverse((t=>{t instanceof La&&t.update(K)})),Q.render(e,K)},lt=e=>{if("Escape"===e.key)if(e.preventDefault(),ot){const t=document.getElementById("gameOverScreen");t&&t.remove(),_.controlsDisabled=!1,ot=!1}else _.controlsDisabled=!0,ot=!0,at(!0);if("t"===e.key.toLowerCase()){_&&_.reset&&_.reset({x:30*Math.random()-15,y:4,z:30*Math.random()-15}),aiCar3&&aiCar3.reset&&aiCar3.reset({x:30*Math.random()-15,y:4,z:30*Math.random()-15}),aiCar4&&aiCar4.reset&&aiCar4.reset({x:30*Math.random()-15,y:4,z:30*Math.random()-15}),P&&P.reset&&P.reset(),nt=!0,ot=!1,rt=null,t.style.display="block",_&&(_.stopCar&&_.stopCar(),_.stopSound&&_.stopSound());const e=document.getElementById("gameOverScreen");e&&e.remove()}};window.addEventListener("keydown",lt),jy.push({cleanup:()=>{qy&&cancelAnimationFrame(qy),window.removeEventListener("keydown",lt),window.removeEventListener("resize",et),e&&(e.traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose())})),e.clear()),Q&&(Q.clear(),Q.dispose()),J&&J.dispose(),console.log("Game Cleaned-Up Successfully")}}),ht()}()}),5e3)})),document.getElementById("back").addEventListener("click",(()=>{e.remove(),nv()}))}const ev=JSON.parse('[{"id":1,"name":"Veloce Motors","model":"Phoenix Spider","video":"./videos/Ferrari04.mp4","specs":{"engine":"4.2L V8 Petrol","horsepower":"545 HP @ 8,800 rpm","torque":"385 lb-ft @ 5,800 rpm","acceleration":"3.1 seconds (0-60 mph)","topSpeed":"195 mph","weight":"3,120 lbs","transmission":"7-Speed Dual-Clutch Automatic","drivetrain":"RWD"},"description":"The Veloce Phoenix Spider features the world\'s first carbon-fiber retractable hardtop system. The roof transforms in just 12 seconds and can operate at speeds up to 30 mph for seamless open-air driving."},{"id":2,"name":"Apex Automotive","model":"Storm GT Turbo","video":"./videos/Toyota_Supra02.mp4","specs":{"engine":"3.2L Inline-6 Twin-Turbo","horsepower":"295 HP (official), ~340 HP (actual)","torque":"332 lb-ft","acceleration":"4.4 seconds (0-60 mph)","topSpeed":"158 mph (electronically limited)","weight":"3,380 lbs","transmission":"6-Speed Manual","drivetrain":"RWD"},"description":"The Storm GT Turbo became an icon of tuner culture with its bulletproof inline-6 engine capable of handling massive power increases. Its legendary reliability and modification potential made it a favorite among enthusiasts worldwide."},{"id":3,"name":"Precision Dynamics","model":"R5 Competition","video":"./videos/BMW05.mp4","specs":{"engine":"3.1L Inline-6 Twin-Turbo","horsepower":"485 HP","torque":"465 lb-ft","acceleration":"3.9 seconds (0-60 mph)","topSpeed":"175 mph","weight":"3,680 lbs","transmission":"8-Speed Automatic","drivetrain":"RWD"},"description":"Combining luxury craftsmanship with track-focused performance, the R5 Competition delivers precision engineering and aggressive styling for the ultimate driving experience."},{"id":4,"name":"Titan Supercars","model":"Vortex Evo","video":"./videos/Lamborghini01.mp4","specs":{"engine":"5.0L V10 Naturally Aspirated","horsepower":"612 HP","torque":"428 lb-ft","acceleration":"3.0 seconds (0-60 mph)","topSpeed":"198 mph","weight":"3,085 lbs","transmission":"7-Speed Dual-Clutch","drivetrain":"AWD"},"description":"The Titan Vortex Evo represents the evolution of supercar design, featuring advanced aerodynamics and cutting-edge performance technology that redefines what\'s possible on both road and track."},{"id":5,"name":"Thunder Motors","model":"Comet Z1","video":"./videos/Chevrolet_Corvette03.mp4","specs":{"engine":"6.0L V8 Naturally Aspirated","horsepower":"475 HP","torque":"455 lb-ft","acceleration":"3.2 seconds (0-60 mph)","topSpeed":"189 mph","weight":"3,290 lbs","transmission":"8-Speed Dual-Clutch","drivetrain":"RWD"},"description":"The revolutionary Comet Z1 marks Thunder Motors\' first mid-engine design, delivering exotic supercar performance and handling at an accessible price point that democratizes the supercar experience."},{"id":6,"name":"Titan Supercars","model":"Millennium X12-4","video":"./videos/Lamborghini_Centenario06.mp4","specs":{"engine":"6.3L V12 Naturally Aspirated","horsepower":"755 HP","torque":"495 lb-ft","acceleration":"2.9 seconds (0-60 mph)","topSpeed":"213 mph","weight":"2,985 lbs","transmission":"7-Speed Sequential","drivetrain":"AWD"},"description":"Created as a limited-edition masterpiece commemorating Titan\'s 25th anniversary, the Millennium X12-4 represents the pinnacle of automotive artistry with only 25 units ever produced."}]');let iv=null,sv=0;function nv(){const t=document.createElement("div");t.id="showMap",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgba(0, 0, 0, 0.8)",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.zIndex="1000",t.style.backgroundSize="80%",t.style.backgroundPosition="center center",t.style.backgroundRepeat="no-repeat",t.style.fontFamily="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",t.innerHTML='\n  <div style="position: relative; width: 100%; height: 100%;">\n    \x3c!-- Fullscreen Video --\x3e\n    <video id="carVideo" style="\n      width: 100%;\n      height: 100%;\n      object-fit: cover;\n      transition: opacity 0.3s ease-in-out;\n    " muted loop preload="metadata" autoplay>\n      <source id="videoSource" src="" type="video/mp4">\n      Your browser does not support the video tag.\n    </video>\n    \n    \x3c!-- Loading overlay --\x3e\n    <div id="videoLoader" style="\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background-color: rgba(0, 0, 0, 0.7);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      opacity: 0;\n      transition: opacity 0.3s ease-in-out;\n    ">\n      <div style="color: white; font-size: 24px;">Loading...</div>\n    </div>\n    \n    \x3c!-- Top UI Overlay --\x3e\n    <div style="\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      padding: 40px;\n      background: linear-gradient(180deg, rgba(0, 0, 0, 0.8) 0%, transparent 100%);\n      z-index: 10;\n    ">\n      <div style="display: flex; align-items: center; justify-content: space-between;">\n        <h2 style="color: white; font-size: 32px; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">Select Your Car</h2>\n        <div style="text-align: center;">\n          <h3 id="carTitle" style="color: white; font-size: 28px; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);"></h3>\n          <div id="carCounter" style="color: #ccc; font-size: 16px; margin-top: 5px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);"></div>\n        </div>\n      </div>\n    </div>\n    \n    \x3c!-- Left Navigation Button --\x3e\n    <button id="leftBtn" style="\n      position: absolute;\n      left: 30px;\n      top: 50%;\n      transform: translateY(-50%);\n      padding: 20px 25px;\n      font-size: 48px;\n      background-color: rgba(0, 0, 0, 0.3);\n      color: white;\n      border: 2px solid rgba(255, 255, 255, 0.3);\n      border-radius: 50%;\n      cursor: pointer;\n      transition: all 0.3s;\n      width: 80px;\n      height: 80px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      backdrop-filter: blur(10px);\n      z-index: 20;\n      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);\n    ">‹</button>\n    \n    \x3c!-- Right Side Car Details Panel --\x3e\n    <div id="carDetailsPanel" style="\n      position: absolute;\n      right: 0;\n      top: 0;\n      width: 400px;\n      height: 100%;\n      background: linear-gradient(270deg, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.7) 70%, transparent 100%);\n      padding: 40px 30px;\n      overflow-y: auto;\n      z-index: 15;\n      backdrop-filter: blur(15px);\n      border-left: 1px solid rgba(255, 255, 255, 0.1);\n    ">\n      <div style="color: white;">\n        <h2 id="detailCarName" style="font-size: 28px; margin: 0 0 10px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">Ferrari</h2>\n        <h3 id="detailCarModel" style="font-size: 20px; margin: 0 0 20px 0; color: #ccc; font-weight: 300; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">F8 Tributo</h3>\n        \n        <div id="detailDescription" style="\n          font-size: 16px;\n          line-height: 1.6;\n          margin-bottom: 30px;\n          color: #e0e0e0;\n          text-shadow: 1px 1px 2px rgba(0,0,0,0.8);\n          border-left: 3px solid #000000ff;\n          padding-left: 15px;\n        ">\n          The Ferrari F8 Tributo is a masterpiece of Italian engineering, delivering exceptional performance with its twin-turbocharged V8 engine.\n        </div>\n        \n        <div style="margin-top: 30px;">\n          <h4 style="font-size: 20px; margin: 0 0 20px 0; color: #ffffffff; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">Specifications</h4>\n          <div id="detailSpecs" style="display: flex; flex-direction: column; gap: 12px;">\n            \x3c!-- Specs will be populated dynamically --\x3e\n          </div>\n        </div>\n      </div>\n    </div>\n    \x3c!-- Right Navigation Button --\x3e\n    <button id="rightBtn" style="\n      position: absolute;\n      right: 420px;\n      top: 50%;\n      transform: translateY(-50%);\n      padding: 20px 25px;\n      font-size: 48px;\n      background-color: rgba(0, 0, 0, 0.3);\n      color: white;\n      border: 2px solid rgba(255, 255, 255, 0.3);\n      border-radius: 50%;\n      cursor: pointer;\n      transition: all 0.3s;\n      width: 80px;\n      height: 80px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      backdrop-filter: blur(10px);\n      z-index: 20;\n      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);\n    ">›</button>\n    \n    \x3c!-- Bottom UI Overlay --\x3e\n    <div style="\n      position: absolute;\n      bottom: 0;\n      left: 0;\n      width: 100%;\n      padding: 40px;\n      background: linear-gradient(0deg, rgba(0, 0, 0, 0.8) 0%, transparent 100%);\n      z-index: 10;\n    ">\n      <div style="display: flex; gap: 20px; justify-content: center; align-items: center;">\n        <button id="back" style="\n          padding: 20px 40px;\n          font-size: 24px;\n          background-color: rgba(0, 0, 0, 0.3);\n          color: white;\n          border: 2px solid rgba(255, 255, 255, 0.3);\n          border-radius: 10px;\n          cursor: pointer;\n          transition: all 0.3s;\n          backdrop-filter: blur(10px);\n          text-shadow: 2px 2px 4px rgba(0,0,0,0.8);\n        ">Back</button>\n        \n        <div id="videoStatus" style="color: white; font-size: 16px; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);"></div>\n        \n        <button id="next" style="\n          padding: 20px 40px;\n          font-size: 24px;\n          background-color: rgba(0, 0, 0, 0.3);\n          color: white;\n          border: 2px solid rgba(255, 255, 255, 0.3);\n          border-radius: 10px;\n          cursor: pointer;\n          transition: all 0.3s;\n          backdrop-filter: blur(10px);\n          text-shadow: 2px 2px 4px rgba(0,0,0,0.8);\n        ">Next</button>\n      </div>\n    </div>\n  </div>\n  ',document.body.appendChild(t);const e=document.getElementById("carVideo"),i=document.getElementById("videoSource"),s=document.getElementById("carTitle"),n=document.getElementById("carCounter"),o=document.getElementById("videoStatus"),r=document.getElementById("videoLoader"),a=document.getElementById("next"),h=document.getElementById("leftBtn"),l=document.getElementById("rightBtn");function c(){r.style.opacity="0",e.style.opacity="1"}function d(){if(!ev||0===ev.length)return void console.error("No car data available");(sv<0||sv>=ev.length)&&(console.error("Invalid car index:",sv),sv=0);const t=ev[sv];var a;t?(iv=t.id,s&&(s.textContent=t.name||"Unknown Car"),n&&(n.textContent=`${sv+1} / ${ev.length}`),function(t){if(!t)return void console.error("No car data provided to updateCarDetails");const e={detailCarName:t.name||"Unknown",detailCarModel:t.model||"Unknown",detailDescription:t.description||"No description available"};for(const[t,i]of Object.entries(e)){const e=document.getElementById(t);e&&(e.textContent=i)}const i=document.getElementById("detailSpecs");if(i){if(i.innerHTML="",!t.specs||"object"!=typeof t.specs){console.warn("No specs found for car:",t.name);const e=document.createElement("div");return e.textContent="No specifications available",e.style.cssText="\n            color: #ccc;\n            font-size: 14px;\n            text-align: center;\n            padding: 20px 0;\n            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);\n        ",void i.appendChild(e)}Object.entries(t.specs).forEach((([t,e])=>{const s=document.createElement("div");s.style.cssText="\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 8px 0;\n        border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n      ";const n=document.createElement("span");n.textContent=t.charAt(0).toUpperCase()+t.slice(1).replace(/([A-Z])/g," $1"),n.style.cssText="\n        color: #ccc;\n        font-size: 14px;\n        flex: 1;\n        text-shadow: 1px 1px 2px rgba(0,0,0,0.8);\n      ";const o=document.createElement("span");o.textContent=e||"N/A",o.style.cssText="\n        color: white;\n        font-size: 14px;\n        font-weight: 500;\n        text-align: right;\n        text-shadow: 1px 1px 2px rgba(0,0,0,0.8);\n      ",s.appendChild(n),s.appendChild(o),i&&i.parentNode&&i.appendChild(s)}))}}(t),h&&(h.style.opacity=0===sv?"0.3":"0.7",h.style.pointerEvents=0===sv?"none":"auto"),l&&(l.style.opacity=sv===ev.length-1?"0.3":"0.7",l.style.pointerEvents=sv===ev.length-1?"none":"auto"),t.video?(a=t.video,t.name,r.style.opacity="1",e.style.opacity="0.3",o.textContent="",e.pause(),i.src="",e.load(),i.src=a,a.endsWith(".mkv")?i.type="video/x-matroska":a.endsWith(".mp4")?i.type="video/mp4":a.endsWith(".webm")&&(i.type="video/webm"),e.load(),e.addEventListener("loadstart",(()=>{o.textContent=""})),e.addEventListener("canplay",(()=>{c(),o.textContent="",e.play().catch((t=>{console.log("Video autoplay failed:",t),o.textContent="",c()}))})),e.addEventListener("error",(t=>{console.error("Video error:",t),o.textContent="",c()})),e.addEventListener("loadeddata",(()=>{o.textContent=""}))):console.warn("No video found for car:",t.name)):console.error("No car found at index:",sv)}h.addEventListener("click",(()=>{sv>0&&(sv--,d())})),l.addEventListener("click",(()=>{sv<ev.length-1&&(sv++,d())})),[h,l].forEach((t=>{t.addEventListener("mouseenter",(t=>{"none"!==t.target.style.pointerEvents&&(t.target.style.transform="translateY(-50%) scale(1.1)",t.target.style.backgroundColor="rgba(0, 0, 0, 0.6)",t.target.style.borderColor="rgba(255, 255, 255, 0.6)")})),t.addEventListener("mouseleave",(t=>{t.target.style.transform="translateY(-50%) scale(1)",t.target.style.backgroundColor="rgba(0, 0, 0, 0.3)",t.target.style.borderColor="rgba(255, 255, 255, 0.3)"}))})),document.getElementById("back").addEventListener("mouseenter",(t=>{t.target.style.backgroundColor="rgba(0, 0, 0, 0.6)",t.target.style.borderColor="rgba(255, 255, 255, 0.6)"})),document.getElementById("back").addEventListener("mouseleave",(t=>{t.target.style.backgroundColor="rgba(0, 0, 0, 0.3)",t.target.style.borderColor="rgba(255, 255, 255, 0.3)"})),document.getElementById("next").addEventListener("mouseenter",(t=>{t.target.style.backgroundColor="rgba(0, 0, 0, 0.6)",t.target.style.borderColor="rgba(255, 255, 255, 0.6)"})),document.getElementById("next").addEventListener("mouseleave",(t=>{t.target.style.backgroundColor="rgba(0, 0, 0, 0.3)",t.target.style.borderColor="rgba(255, 255, 255, 0.3)"})),document.addEventListener("keydown",(t=>{"ArrowLeft"===t.key&&sv>0?(sv--,d()):"ArrowRight"===t.key&&sv<ev.length-1&&(sv++,d())})),document.getElementById("back").addEventListener("click",(()=>{e.pause(),t.remove(),dv()})),a.addEventListener("click",(()=>{iv&&(e.pause(),t.remove(),tv())})),d()}let ov=[],rv=null;function av(){return"true"===localStorage.getItem("debug")}function hv(t){localStorage.setItem("debug",t)}function lv(){ov.forEach((t=>{t&&"function"==typeof t.cleanup&&t.cleanup()})),ov=[],rv&&(cancelAnimationFrame(rv),rv=null)}function cv(){pv(),lv();let t=document.querySelector("canvas.webgl");t||(t=document.createElement("canvas"),t.className="webgl",document.body.appendChild(t)),t.addEventListener("click",(()=>{t.requestPointerLock(),hideCursor()})),document.addEventListener("pointerlockchange",(()=>{document.pointerLockElement===t||showCursor()}));const e=new oa,i=new Dg({gravity:new Ud(0,-9.82,0)});i.broadphase=new mp(i);const s=new Cn(new tl(1890,725),new pl({color:2763306}));s.rotation.x=.5*-Math.PI,s.receiveShadow=!0,e.add(s);const n=new mm,o=new du({mass:0});o.addShape(n),o.quaternion.setFromEuler(-Math.PI/2,0,0),i.addBody(o);let r=new Tc(16777215,1.75*Math.PI);r.position.set(1,1,-1),e.add(r,new _c(16777215,.25*Math.PI));const a=new my(e,i,{x:0,y:.1,z:0},{modelPath:"./assets/bumpers.glb",mass:0,friction:.8,restitution:.1,showWireframe:av(),wireframeColor:65280});a.init(),new my(e,i,{x:0,y:.1,z:0},{modelPath:"./assets/trianglebox.glb",mass:0,friction:.8,restitution:.1,showWireframe:av(),wireframeColor:65280,rotation:{x:0,y:0,z:0}}).init(),new my(e,i,{x:0,y:.05,z:0},{modelPath:"./map1/ground.glb",mass:0,friction:.8,restitution:.1,showWireframe:av(),wireframeColor:65280,scale:{x:1,y:1,z:1}}).init(),new my(e,i,{x:0,y:-8,z:0},{modelPath:"./map1/background1.glb",mass:0,friction:.8,restitution:.1,showWireframe:av(),wireframeColor:65280,scale:{x:1,y:1,z:1},rotation:{x:0,y:Math.PI,z:0}}).init();const h=[];for(let t=1;t<=15;t++){const s=new my(e,i,{x:0,y:.1,z:0},{modelPath:`./map1/road${t}.glb`,mass:0,friction:.8,restitution:.1,rotation:{x:0,y:0,z:0},showWireframe:av(),scale:{x:1,y:1,z:1}});s.init(),h.push(s)}const[l,c,d,u,p,m,f,g,y,v,w,x,b,S,M]=h;let T,_,E,L,C,A,P,k,B={x:559.859,y:1,z:177.14};switch(iv){case 1:console.log("Creating Ferrari"),T=new ly(e,i,null,B),ov.push(T),E=new by(e,i,T,T,{x:2,y:-3.5,z:-18}),E.setSize(.2),L=new by(e,i,T,T,{x:-2,y:-3.5,z:-18}),L.setSize(.2),E.init(),L.init(),A=new wy(e,i,T,{x:.7,y:-1.5,z:-2.5}),A.setTrailWidth(.4),A.init(),P=new wy(e,i,T,{x:-.7,y:-1.5,z:-2.5}),P.setTrailWidth(.3),P.init(),k=new Iy(T,{unit:"kmh",maxSpeed:200,audioFile:"./sounds/ferrari_sound.mp3",autoPlay:!0});break;case 2:console.log("Creating Toyota Supra"),T=new cy(e,i,null,B),ov.push(T),_=new by(e,i,T,T,{x:4,y:-4,z:-18}),_.setSize(.2),_.init(),C=new wy(e,i,T,{x:.7,y:-1.5,z:-2.5}),C.setTrailWidth(.3),C.init(),k=new Iy(T,{unit:"kmh",maxSpeed:200,audioFile:"./sounds/tsupra_sound.mp3",autoPlay:!0});break;case 3:console.log("Creating BMW"),T=new Ey(e,i,null,B),ov.push(T),_=new by(e,i,T,T,{x:-6.5,y:-5,z:-1.5}),_.setSize(.2),_.init(),C=new wy(e,i,T,{x:-1.35,y:-1.2,z:-.5}),C.setTrailWidth(.3),C.init(),k=new Iy(T,{unit:"kmh",maxSpeed:200,audioFile:"./sounds/bmw_sound.mp3",autoPlay:!0});break;case 4:console.log("Creating Lamborghini Hurracan"),T=new Ly(e,i,null,B),ov.push(T),E=new by(e,i,T,T,{x:2,y:-2,z:-18}),E.setSize(.2),L=new by(e,i,T,T,{x:-2,y:-2,z:-18}),L.setSize(.2),E.init(),L.init(),A=new wy(e,i,T,{x:.6,y:-.8,z:-3.3}),A.setTrailWidth(.3),A.init(),P=new wy(e,i,T,{x:-.6,y:-.8,z:-3.3}),P.setTrailWidth(.3),P.init(),k=new Iy(T,{unit:"kmh",maxSpeed:200,audioFile:"./sounds/lamborghini_sound.mp3",autoPlay:!0});break;case 5:console.log("Creating Chevrolet_Corvette"),T=new Cy(e,i,null,B),ov.push(T),E=new by(e,i,T,T,{x:1,y:-4,z:-18}),E.setSize(.2),L=new by(e,i,T,T,{x:-1,y:-4,z:-18}),L.setSize(.2),E.init(),L.init(),A=new wy(e,i,T,{x:.3,y:-1.5,z:-2.5}),A.setTrailWidth(.3),A.init(),P=new wy(e,i,T,{x:-.3,y:-1.5,z:-2.5}),P.setTrailWidth(.3),P.init(),k=new Iy(T,{unit:"kmh",maxSpeed:200,audioFile:"./sounds/corvette_sound.mp3",autoPlay:!0});break;case 6:console.log("Creating Lamborghini Centenario"),T=new Ay(e,i,null,B),ov.push(T),E=new by(e,i,T,T,{x:1,y:-4,z:-18}),E.setSize(.2),L=new by(e,i,T,T,{x:-1,y:-4,z:-18}),L.setSize(.2),E.init(),L.init(),A=new wy(e,i,T,{x:.2,y:-1.5,z:-2.5}),A.setTrailWidth(.3),A.init(),P=new wy(e,i,T,{x:-.2,y:-1.5,z:-2.5}),P.setTrailWidth(.3),P.init(),k=new Iy(T,{unit:"kmh",maxSpeed:200,audioFile:"./sounds/lamborghini_sound.mp3",autoPlay:!0});break;default:console.log("Creating default Ferrari"),T=new ly(e,i,null,B),ov.push(T)}T.init();const R=new Sy(i,e,T,100,{healthBarHeight:0,healthBarWidth:0});R.init(),R.updateHealthBarDimensions(0,0),T.setHealthSystem(R);const D=new _y(T,{maxSpeed:280,unit:"km/h",size:300,position:{x:1200,y:400},color:"#999999"});D.init(),ov.push(T,R,a,D,_,E,L,C,A,P,t,k),ov.push(l,c,d,u,p,m,f,g,y,v,w,x,b,S,M),new Dy(e,i,T,{width:1800,depth:700,height:100,position:{x:0,y:0,z:0},showVisualBoundary:av(),boundaryColor:16711680,boundaryOpacity:.2,wallThickness:15,wallHeight:40,forceStrength:10,damping:1,enableWarning:!1,warningDistance:80,enableAutoReset:!0,resetPosition:{x:452,y:5,z:180},resetDistance:60}).init();const I=new dy(e,i,{x:53,y:1.5,z:-95.5733},{modelPath:"./assets/block1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:0,z:0},showWireframe:av()}),F=new dy(e,i,{x:48,y:1.5,z:-95.5733},{modelPath:"./assets/block1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:0,z:0},showWireframe:av()}),z=new dy(e,i,{x:58,y:1.5,z:-95.5733},{modelPath:"./assets/block1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:0,z:0},showWireframe:av()}),O=new dy(e,i,{x:63,y:1.5,z:-95.5733},{modelPath:"./assets/block1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:0,z:0},showWireframe:av()}),N=new dy(e,i,{x:55,y:1.5,z:-93},{modelPath:"./assets/cone1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:0,z:0},showWireframe:av()}),W=new dy(e,i,{x:61,y:1.5,z:-93},{modelPath:"./assets/cone2.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:0,z:0},showWireframe:av()}),H=new dy(e,i,{x:49,y:1.5,z:-93},{modelPath:"./assets/cone1.glb",mass:10,shapeType:"box",scale:{x:2,y:2,z:2},rotation:{x:0,y:0,z:0},showWireframe:av()});I.init(),F.init(),z.init(),O.init(),N.init(),W.init(),H.init(),ov.push(I,F,z,O,N,W,H);const U=new py(e,i),V=new pi(534.998,1,177.14),G=new pi(546.172,1,167.084),j=new pi(445.676,1,184.068),q=[new pi(451.87,1,167.065),new pi(351.345,1,172.96),new pi(1.57239,1,172.96),new pi(-501.558,1,172.96),new pi(-576.438,1,176.729),new pi(-619.345,1,142.481),new pi(-634.234,1,111.938),new pi(-631.562,1,68.5428),new pi(-604.71,1,37.746),new pi(-553.933,1,21.4567),new pi(-491.109,1,43.3721),new pi(-362.539,1,84.2808),new pi(-292.552,1,105.929),new pi(-222.317,1,125.252),new pi(-168.99,1,125.252),new pi(-48.4554,1,125.252),new pi(202.841,1,125.252),new pi(257.076,1,124.372),new pi(300.395,1,103.472),new pi(321.295,1,68.1328),new pi(318.635,1,29.3733),new pi(292.035,1,-7.1063),new pi(257.076,1,-22.3061),new pi(216.167,1,-22.3061),new pi(158.456,1,-22.3061),new pi(112.297,1,-22.3061),new pi(70.4979,1,-53.0858),new pi(56.058,1,-91.8453),new pi(65.9379,1,-138.965),new pi(116.857,1,-170.504),new pi(186.986,1,-170.504),new pi(326.514,1,-170.504),new pi(409.062,1,-170.504),new pi(493.813,1,-170.504),new pi(536.752,1,-148.085),new pi(551.339,1,-122.235),new pi(554.992,1,-93.7453),new pi(546.956,1,-61.6027),new pi(535.998,1,-22.155),new pi(525.353,1,19.8734),new pi(530.672,1,55.593),new pi(544.552,1,79.6999),new pi(566.772,1,91.3125),new pi(566.772,1,91.3125),new pi(566.772,1,91.3125),new pi(590.879,1,99.3481),new pi(615.031,1,101.952),new pi(635.171,1,123.992),new pi(633.651,1,154.772),new pi(601.732,1,172.252),new pi(1.57239,1,172.96),new pi(-501.558,1,172.96),new pi(-576.438,1,176.729),new pi(-619.345,1,142.481),new pi(-634.234,1,111.938),new pi(-631.562,1,68.5428),new pi(-604.71,1,37.746),new pi(-553.933,1,21.4567),new pi(-491.109,1,43.3721),new pi(-362.539,1,84.2808),new pi(-292.552,1,105.929),new pi(-222.317,1,125.252),new pi(-168.99,1,125.252),new pi(-48.4554,1,125.252),new pi(202.841,1,125.252),new pi(257.076,1,124.372),new pi(300.395,1,103.472),new pi(321.295,1,68.1328),new pi(318.635,1,29.3733),new pi(292.035,1,-7.1063),new pi(257.076,1,-22.3061),new pi(216.167,1,-22.3061),new pi(158.456,1,-22.3061),new pi(112.297,1,-22.3061),new pi(70.4979,1,-53.0858),new pi(56.058,1,-91.8453),new pi(65.9379,1,-138.965),new pi(116.857,1,-170.504),new pi(186.986,1,-170.504),new pi(326.514,1,-170.504),new pi(409.062,1,-170.504),new pi(493.813,1,-170.504),new pi(536.752,1,-148.085),new pi(551.339,1,-122.235),new pi(554.992,1,-93.7453),new pi(546.956,1,-61.6027),new pi(535.998,1,-22.155),new pi(525.353,1,19.8734),new pi(530.672,1,55.593),new pi(544.552,1,79.6999),new pi(566.772,1,91.3125),new pi(566.772,1,91.3125),new pi(566.772,1,91.3125),new pi(590.879,1,99.3481),new pi(615.031,1,101.952),new pi(635.171,1,123.992),new pi(633.651,1,154.772),new pi(601.732,1,172.252),new pi(1.57239,1,172.96),new pi(-501.558,1,172.96),new pi(-576.438,1,176.729),new pi(-619.345,1,142.481),new pi(-634.234,1,111.938),new pi(-631.562,1,68.5428),new pi(-604.71,1,37.746),new pi(-553.933,1,21.4567),new pi(-491.109,1,43.3721),new pi(-362.539,1,84.2808),new pi(-292.552,1,105.929),new pi(-222.317,1,125.252),new pi(-168.99,1,125.252),new pi(-48.4554,1,125.252),new pi(202.841,1,125.252),new pi(257.076,1,124.372),new pi(300.395,1,103.472),new pi(321.295,1,68.1328),new pi(318.635,1,29.3733),new pi(292.035,1,-7.1063),new pi(257.076,1,-22.3061),new pi(216.167,1,-22.3061),new pi(158.456,1,-22.3061),new pi(112.297,1,-22.3061),new pi(70.4979,1,-53.0858),new pi(56.058,1,-91.8453),new pi(65.9379,1,-138.965),new pi(116.857,1,-170.504),new pi(186.986,1,-170.504),new pi(326.514,1,-170.504),new pi(409.062,1,-170.504),new pi(493.813,1,-170.504),new pi(536.752,1,-148.085),new pi(551.339,1,-122.235),new pi(554.992,1,-93.7453),new pi(546.956,1,-61.6027),new pi(535.998,1,-22.155),new pi(525.353,1,19.8734),new pi(530.672,1,55.593),new pi(544.552,1,79.6999),new pi(566.772,1,91.3125),new pi(566.772,1,91.3125),new pi(566.772,1,91.3125),new pi(590.879,1,99.3481),new pi(615.031,1,101.952),new pi(635.171,1,123.992),new pi(633.651,1,154.772),new pi(601.732,1,172.252)],$=U.createCurvedPath(V,j,q,100),X=U.createAICar($,V,j);X.carId="r_1",X.setRotation(0,-Math.PI/2,0),X.setPlayerCar(T);const Y=new wy(e,i,X,{x:.7,y:-1.5,z:-2.5});Y.setTrailWidth(.3),Y.init();const Z=U.createAICar($,G,j);Z.carId="r_2",Z.setRotation(0,-Math.PI/2,0),Z.setPlayerCar(T);const K=new wy(e,i,Z,{x:.7,y:-1.5,z:-2.5});let J;K.setTrailWidth(.3),K.init(),av()&&(J=U.visualizePath($,65280)),ov.push(U,X,Z,J,$);let Q=!1,tt={x:30,y:20,z:30};const et=new My(i,e,T,[X,Z]),it={position:{x:450,y:2,z:173.422},size:tt,name:" Start / Finish ",visible:Q},st={position:{x:365.611,y:2,z:173.77},size:tt,name:" B ",visible:Q},nt={position:{x:-102.872,y:2,z:173.77},size:tt,name:" C ",visible:Q},ot={position:{x:-570.66,y:2,z:173.77},size:tt,name:" D ",visible:Q},rt={position:{x:-634.954,y:2,z:100.439},size:tt,name:" E ",color:255,visible:Q},at={position:{x:-550.502,y:2,z:25.0228},size:tt,name:" F ",color:255,visible:Q},ht={position:{x:-221.035,y:2,z:126.157},size:tt,name:" G ",color:255,visible:Q},lt={position:{x:247.1,y:2,z:126.157},size:tt,name:" H ",color:255,visible:Q},ct={position:{x:320.779,y:2,z:55.6063},size:tt,name:" I ",color:255,visible:Q},dt={position:{x:246.753,y:2,z:-21.895},size:tt,name:" J ",color:255,visible:Q},ut={position:{x:129.98,y:2,z:-21.895},size:tt,name:" K ",color:255,visible:Q},pt={position:{x:55.2587,y:1,z:-95.5733},size:tt,name:" L ",color:255,visible:Q},mt={position:{x:129.98,y:2,z:-171.684},size:tt,name:" M ",color:255,visible:Q},ft={position:{x:480.299,y:2,z:-171.684},size:tt,name:" N ",color:255,visible:Q},gt={position:{x:555.02,y:2,z:-93.1405},size:tt,name:" O ",color:255,visible:Q},yt={position:{x:525.827,y:2,z:18.7671},size:tt,name:" P ",color:255,visible:Q},vt={position:{x:580.391,y:2,z:96.6159},size:tt,name:" Q ",color:255,visible:Q},wt={position:{x:637.039,y:2,z:139.711},size:tt,name:" R ",color:255,visible:Q},xt={position:{x:599.158,y:2,z:173.422},size:tt,name:" S ",color:255,visible:Q},bt={position:{x:460,y:2,z:173.422},size:tt,name:"",color:255,visible:Q};et.checkpointConfigs=[{id:"A",...et.checkpointConfigs[0],...it},{id:"B",...et.checkpointConfigs[1],...st},{id:"C",...et.checkpointConfigs[2],...nt},{id:"D",...et.checkpointConfigs[3],...ot},{id:"E",...et.checkpointConfigs[4],...rt},{id:"F",...et.checkpointConfigs[5],...at},{id:"G",...et.checkpointConfigs[6],...ht},{id:"H",...et.checkpointConfigs[7],...lt},{id:"I",...et.checkpointConfigs[8],...ct},{id:"J",...et.checkpointConfigs[9],...dt},{id:"K",...et.checkpointConfigs[10],...ut},{id:"L",...et.checkpointConfigs[11],...pt},{id:"M",...et.checkpointConfigs[12],...mt},{id:"N",...et.checkpointConfigs[13],...ft},{id:"O",...et.checkpointConfigs[14],...gt},{id:"P",...et.checkpointConfigs[15],...yt},{id:"Q",...et.checkpointConfigs[16],...vt},{id:"R",...et.checkpointConfigs[17],...wt},{id:"S",...et.checkpointConfigs[18],...xt},{id:"T",...et.checkpointConfigs[19],...bt}],et.setRequiredCycles(3),et.setTargetLaps(1),et.init(),et.startTimer(),et.onLapComplete=(t,e)=>{console.log(`Lap ${t} completed!`,e)},et.onInvalidVisit=(t,e,i)=>{console.log(`Invalid visit: hit ${t}, expected ${e}`)},et.onProgressUpdate=(t,e,i)=>{console.log(`Progress: ${t}/${e} cycles`)},ov.push(et);const St=new zy({mapWidth:1500,mapHeight:850,minimapWidth:300,minimapHeight:300});St.loadBackgroundImage("./image/map_1.png"),ov.push(St);const Mt=new Py,Tt={width:window.innerWidth,height:window.innerHeight},_t=new Nn(75,Tt.width/Tt.height,.1,1e4);_t.position.set(0,2,-6);const Et=new Od(_t,t);Et.enableDamping=!0,Et.minPolarAngle=Math.PI/4,Et.maxPolarAngle=Math.PI/2,Et.enablePan=!1,Et.target.set(0,1.5,0);const Lt=new sa({canvas:t,antialias:Oy(),alpha:!0,powerPreference:"high-performance"});Lt.setSize(Tt.width,Tt.height),Lt.setPixelRatio(Math.min(window.devicePixelRatio,2)),Lt.shadowMap.enabled=!0;const Ct=new gy(Lt,"./rustig_koppie_puresky_4k.hdr",2);e.add(Ct),Ct.setExposure(1.5);const At=()=>{Tt.width=window.innerWidth,Tt.height=window.innerHeight,_t.aspect=Tt.width/Tt.height,_t.updateProjectionMatrix(),Lt.setSize(Tt.width,Tt.height),Lt.setPixelRatio(Math.min(window.devicePixelRatio,2))};window.addEventListener("resize",At);const Pt=1/60;let kt,Bt=!0,Rt=!1,Dt=null;function It(t=!1){if(document.getElementById("gameOverScreen"))return;const e=document.createElement("div");e.id="gameOverScreen",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.color="white",e.style.fontSize="48px",e.style.fontFamily="Arial, sans-serif",e.style.zIndex="1000";const i=t?"GAME PAUSED":"GAME OVER",s=t?"Press ESC to resume or use the buttons below":"Your car has been destroyed!";e.innerHTML=`\n    <div style="text-align: center; background-color: rgba(0, 0, 0, 0.8); padding: 40px; border-radius: 10px;">\n      <h1>${i}</h1>\n      <p style="font-size: 24px;">${s}</p>\n      ${t?'\n        <button id="resumeButton" style="\n          padding: 10px 20px;\n          font-size: 24px;\n          background-color: rgba(110, 199, 114, 0.3);\n          color: white;\n          border: 2px solid rgba(255, 255, 255, 0.3);\n          border-radius: 10px;\n          cursor: pointer;\n          transition: all 0.3s;\n          backdrop-filter: blur(10px);\n          text-shadow: 2px 2px 4px rgba(0,0,0,0.8);\n        ">Resume Game</button>\n        <br>\n        <button id="restartButton" style="\n          padding: 10px 20px;\n          font-size: 24px;\n          background-color: rgba(0, 0, 0, 0.3);\n          color: white;\n          border: 2px solid rgba(255, 255, 255, 0.3);\n          border-radius: 10px;\n          cursor: pointer;\n          transition: all 0.3s;\n          backdrop-filter: blur(10px);\n          text-shadow: 2px 2px 4px rgba(0,0,0,0.8);\n        ">Restart Game</button>\n        <br>\n      ':""}\n      <button id="returnToMenu" style="\n          padding: 10px 20px;\n          font-size: 24px;\n          background-color: rgba(184, 95, 95, 0.3);\n          color: white;\n          border: 2px solid rgba(255, 255, 255, 0.3);\n          border-radius: 10px;\n          cursor: pointer;\n          transition: all 0.3s;\n          backdrop-filter: blur(10px);\n          text-shadow: 2px 2px 4px rgba(0,0,0,0.8);\n      ">Main Menu</button>\n    </div>\n  `,document.body.appendChild(e),t&&(document.getElementById("resumeButton").addEventListener("click",(()=>{e.remove(),T.controlsDisabled=!1,Rt=!1})),document.getElementById("restartButton").addEventListener("click",(()=>{R.isDestroyed=!0,e&&e.parentNode&&e.remove(),lv(),Mt.showFor(5e3),setTimeout((()=>{cv()}),5e3)}))),document.getElementById("returnToMenu").addEventListener("click",(()=>{R.isDestroyed=!0,e.remove(),pv(),window.removeEventListener("resize",At),lv(),Mt.showFor(5e3),setTimeout((()=>{dv()}),5e3)}))}T.controlsDisabled=!0,X.isControlDisabled=!0,Z.isControlDisabled=!0,setTimeout((()=>{T.controlsDisabled=!1,X.isControlDisabled=!1,Z.isControlDisabled=!1}),1e4),Ry();const Ft=()=>{if(rv=requestAnimationFrame(Ft),k.update(),St.scanForCars(i),St.update(),R.isDestroyed&&Bt&&(Dt||(Dt=Date.now(),t.style.display="block"),Date.now()-Dt>=1e4&&(It(!1),Bt=!1)),et.raceFinished&&Bt&&(Dt||(Dt=Date.now(),t.style.display="block"),T.onCarDestroyed(),X.stopCar(),Z.stopCar(),Date.now()-Dt>=5e3&&(function(){if(document.getElementById("CheckpointReached"))return;const t=document.createElement("div");t.id="CheckpointReached",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.color="white",t.style.fontSize="48px",t.style.fontFamily="Arial, sans-serif",t.style.zIndex="1000",t.innerHTML=`\n    <div style="text-align: center; background-color: rgba(0, 0, 0, 0.8); padding: 40px; border-radius: 10px;">\n      <h1>Game Over!</h1>\n      <div>${function(){const t=et.getPlayerRanking();return t===et.getTotalCars()?"<p>Better Luck Next Time :)</p>":1===t?"<p>Congratulations!! You are first :)</p>\n    <h3>Press Esc to get back your cursor ..</h3>":`<p>Your rank is ${t}</p>`}()}</div>\n      <button id="returnToMenu" style="\n          padding: 10px 20px;\n          font-size: 24px;\n          background-color: rgba(184, 95, 95, 0.3);\n          color: white;\n          border: 2px solid rgba(255, 255, 255, 0.3);\n          border-radius: 10px;\n          cursor: pointer;\n          transition: all 0.3s;\n          backdrop-filter: blur(10px);\n          text-shadow: 2px 2px 4px rgba(0,0,0,0.8);\n      ">Main Menu</button>\n    </div>\n  `,document.body.appendChild(t);const e=document.getElementById("returnToMenu");e&&e.addEventListener("click",(()=>{R.isDestroyed=!0,t.remove(),pv(),window.removeEventListener("resize",At),lv(),Mt.showFor(5e3),setTimeout((()=>{dv()}),5e3)}))}(),Bt=!1)),!Bt||Rt)return e.traverse((t=>{t instanceof La&&t.update(_t)})),void Lt.render(e,_t);const s=performance.now()/1e3;if(kt){const t=s-kt;i.step(Pt,t)}else i.step(Pt);if(kt=s,T.car&&T.car.chassisBody){const t=T.car.chassisBody.position;Et.target.set(t.x,t.y+2,t.z),Et.minDistance=8,Et.maxDistance=10,Et.update()}e.traverse((t=>{t instanceof La&&t.update(_t)})),Lt.render(e,_t)},zt=e=>{if("Escape"===e.key)if(e.preventDefault(),Rt){const t=document.getElementById("gameOverScreen");t&&t.remove(),T.controlsDisabled=!1,Rt=!1}else T.controlsDisabled=!0,Rt=!0,It(!0);if("t"===e.key.toLowerCase()){T&&T.reset&&T.reset({x:30*Math.random()-15,y:4,z:30*Math.random()-15}),aiCar3&&aiCar3.reset&&aiCar3.reset({x:30*Math.random()-15,y:4,z:30*Math.random()-15}),aiCar4&&aiCar4.reset&&aiCar4.reset({x:30*Math.random()-15,y:4,z:30*Math.random()-15}),R&&R.reset&&R.reset(),Bt=!0,Rt=!1,Dt=null,t.style.display="block",T&&(T.stopCar&&T.stopCar(),T.stopSound&&T.stopSound());const e=document.getElementById("gameOverScreen");e&&e.remove()}};window.addEventListener("keydown",zt),ov.push({cleanup:()=>{rv&&cancelAnimationFrame(rv),window.removeEventListener("keydown",zt),window.removeEventListener("resize",At),e&&(e.traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((t=>t.dispose())):t.material.dispose())})),e.clear()),Lt&&(Lt.clear(),Lt.dispose()),Et&&Et.dispose(),console.log("Game Cleaned-Up Successfully")}}),Ft()}function dv(){if(pv(),lv(),Jy("./sounds/bg_music.mp3"),document.getElementById("playOverlay"))return;const t=document.createElement("div");t.id="playOverlay",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgb(0, 0, 0)",t.style.background="\n    linear-gradient(90deg, \n      rgba(0, 0, 0, 1) 0%, \n      rgba(0, 0, 0, 0.8) 5%, \n      rgba(0, 0, 0, 0.3) 15%, \n      rgba(0, 0, 0, 0.3) 85%, \n      rgba(0, 0, 0, 0.8) 95%, \n      rgba(0, 0, 0, 1) 100%\n    ),\n    url('./image/menu.png')\n  ",t.style.backgroundSize="80%",t.style.backgroundPosition="center center",t.style.backgroundRepeat="no-repeat",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.zIndex="1000",t.style.fontFamily="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",t.innerHTML='\n                <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">\n                    <div style="position: relative; margin-bottom: 40px;">\n                \n                        <h1 style="position: relative; top: -20px; left: -150px; margin: 0; font-size: 40px; letter-spacing: 10px; font-family: \'Bad Script\', cursive; color: #fff; text-shadow: 0 0 20px #fff, 0 0 30px #fff, 0 0 40px #228DFF, 0 0 70px #228DFF, 0 0 80px #228DFF, 0 0 100px #228DFF, 0 0 150px #228DFF;">\n                            <span style="animation: neon1 linear infinite 2s;">Cold </span><span style="animation: blink linear infinite 2s;">Pursuit</span>\n                        </h1>\n                    </div>\n                    <div style="display: flex; flex-direction: column; position: relative; left: -200px; top: -70px; ">\n                    <button id="goToMap" class="neon-button play-btn" style="\n                        padding: 5px 10px;\n                        font-size: 24px;\n                        border: none;\n                        cursor: pointer;\n                        transition: all 0.3s ease;\n                        position: relative;\n                        overflow: hidden;\n                        font-family: \'Bad Script\', cursive;\n                        letter-spacing: 2px;\n                        text-transform: uppercase;\n                        background: transparent;\n                        color: #4CAF50;\n                        text-shadow: 0 0 10px #4CAF50, 0 0 20px #4CAF50, 0 0 30px #4CAF50;\n                    ">\n                        <span style="animation: neon1 linear infinite 2.5s;">P</span><span style="animation: blink linear infinite 3s;">L</span><span>A</span><span>Y</span>\n                    </button>\n\n                    <button id="goToOptions" class="neon-button options-btn" style="\n                        padding: 5px 10px;\n                        font-size: 24px;\n                        border: none;\n                        cursor: pointer;\n                        transition: all 0.3s ease; \n                        position: relative;\n                        overflow: hidden;\n                        font-family: \'Bad Script\', cursive;\n                        letter-spacing: 2px;\n                        text-transform: uppercase;\n                        background: transparent;\n                        color: #2196F3;\n                        text-shadow: 0 0 10px #2196F3, 0 0 20px #2196F3, 0 0 30px #2196F3;\n                    ">\n                        <span style="animation: neon1 linear infinite 2.2s;">O</span><span>P</span><span style="animation: blink linear infinite 2.8s;">T</span><span>I</span><span>O</span><span>N</span><span>S</span>\n                    </button>\n\n                    <button id="exit" class="neon-button exit-btn" style="\n                        padding: 5px 10px;\n                        font-size: 24px;\n                        border: none;\n                        cursor: pointer;\n                        transition: all 0.3s ease;\n                        position: relative;\n                        overflow: hidden;\n                        font-family: \'Bad Script\', cursive;\n                        letter-spacing: 2px;\n                        text-transform: uppercase;\n                        background: transparent;\n                        color: #f44336;\n                        text-shadow: 0 0 10px #f44336, 0 0 20px #f44336, 0 0 30px #f44336;\n                  \n                    ">\n                        <span style="animation: blink linear infinite 2.3s;">E</span><span style="animation: neon1 linear infinite 2.7s;">X</span><span>I</span><span>T</span>\n                    </button>\n                    </div>\n\n                          <div style="width: 100%; bottom: 60px; left: 650px; text-align: center; position: fixed;">\n                          <p style="font-style: italic; color: #999999ff;">Follow me on :</p>\n                          </div>\n                   \n                      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />\n                        <footer style="\n                          width: 100%;\n                          padding: 20px 0;\n                          background-color: #12121201;\n                          color: white;\n                          text-align: center;\n                          position: fixed;\n                          bottom: 0;\n                          left: 650px;\n                        ">\n                          <ul style="\n                            list-style: none;\n                            padding: 0;\n                            margin: 0;\n                            display: flex;\n                            justify-content: center;\n                            gap: 30px;\n                            font-size: 18px;\n                          ">\n                            <li>\n                              <a href="https://github.com/Aditya02git" target="_blank" style="text-decoration: none; color: #ffffff;">\n                                <i class="fab fa-github"></i> GitHub\n                              </a>\n                            </li>\n                            <li>\n                              <a href="https://www.linkedin.com/in/aditya-mondal-aa9658288/" target="_blank" style="text-decoration: none; color: #0077B5;">\n                                <i class="fab fa-linkedin"></i> LinkedIn\n                              </a>\n                            </li>\n                          </ul>\n                        </footer>\n                      </div>\n                  ',document.body.appendChild(t),document.getElementById("goToMap").addEventListener("click",(()=>{t.remove(),nv()})),document.getElementById("goToOptions").addEventListener("click",(()=>{!function(){const t=document.createElement("div");t.id="showOption",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgb(0, 0, 0)",t.style.background="\n    linear-gradient(90deg, \n      rgba(0, 0, 0, 1) 0%, \n      rgba(0, 0, 0, 0.8) 5%, \n      rgba(0, 0, 0, 0.3) 15%, \n      rgba(0, 0, 0, 0.3) 85%, \n      rgba(0, 0, 0, 0.8) 95%, \n      rgba(0, 0, 0, 1) 100%\n    ),\n    url('./image/menu.png')\n  ",t.style.backgroundSize="80%",t.style.backgroundPosition="center center",t.style.backgroundRepeat="no-repeat",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.zIndex="1000",t.style.fontFamily="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";const e=av(),i=Oy();t.innerHTML=`\n    <div style="\n      background-color: rgba(0, 0, 0, 0.35);\n      width: 1000px;\n      height: 500px;\n      padding: 40px 60px;\n      border-radius: 16px;\n      text-align: center;\n      color: white;\n      box-shadow: 0 8px 30px rgba(0,0,0,0.4);\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      border: 2px solid rgba(255, 255, 255, 0.5);\n    ">\n      <h2 style="font-size: 28px; margin-bottom: 40px;">Options</h2>\n      \n      <div style="display: flex; flex-direction: row; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 30px;">\n        <p style="font-size: 20px; margin: 0;">Game Mode</p>\n        <div style="display: flex; flex-direction: row; gap: 30px;">\n          <label style="\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            font-size: 20px;\n            cursor: pointer;\n          ">\n            <input type="radio" name="gameMode" value="normal" id="normalRadio" ${e?"":"checked"} style="width: 20px; height: 20px; accent-color: #00bcd4;">\n            Normal Mode\n          </label>\n\n          <label style="\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            font-size: 20px;\n            cursor: pointer;\n          ">\n            <input type="radio" name="gameMode" value="debug" id="debugRadio" ${e?"checked":""} style="width: 20px; height: 20px; accent-color: #ff9800;">\n            Debug Mode\n          </label>\n        </div>\n      </div>\n      \n      <div style="display: flex; flex-direction: row; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 30px;">\n        <p style="font-size: 20px; margin: 0;">Music</p>\n        <button id="music" style="\n          padding: 12px 24px;\n          margin: 0;\n          font-size: 18px;\n          font-family: 'Poppins', sans-serif;\n          font-weight: 600;\n          font-style: normal;\n          color: white;\n          background-color: rgba(255, 255, 255, 0.1);\n          cursor: pointer;\n          transition: all 0.3s ease;\n          text-shadow: 1px 1px 3px rgba(0,0,0,0.6);\n          border: 2px solid rgba(255, 255, 255, 0.3);\n          border-radius: 8px;\n        ">\n          Toggle Music\n        </button>\n      </div>\n\n      <div style="display: flex; flex-direction: row; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 40px;">\n        <p style="font-size: 20px; margin: 0;">Antialias</p>\n        <div style="display: flex; flex-direction: row; gap: 30px;">\n          <label style="\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            font-size: 20px;\n            cursor: pointer;\n          ">\n            <input type="radio" name="antialias" value="on" id="onRadio" ${i?"checked":""} style="width: 20px; height: 20px; accent-color: #00bcd4;">\n            On\n          </label>\n\n          <label style="\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            font-size: 20px;\n            cursor: pointer;\n          ">\n            <input type="radio" name="antialias" value="off" id="offRadio" ${i?"":"checked"} style="width: 20px; height: 20px; accent-color: #ff9800;">\n            Off\n          </label>\n        </div>\n      </div>\n      \n      <div style="display: flex; justify-content: center; width: 100%;">\n        <button id="back" style="\n          padding: 20px 40px;\n          font-size: 24px;\n          background-color: rgba(0, 0, 0, 0.3);\n          color: white;\n          border: 2px solid rgba(255, 255, 255, 0.3);\n          border-radius: 10px;\n          cursor: pointer;\n          transition: all 0.3s;\n          backdrop-filter: blur(10px);\n          text-shadow: 2px 2px 4px rgba(0,0,0,0.8);\n        ">Back</button>\n      </div>\n    </div>\n  `,document.body.appendChild(t);const s=document.getElementById("back"),n=document.getElementById("normalRadio"),o=document.getElementById("debugRadio"),r=document.getElementById("onRadio"),a=document.getElementById("offRadio"),h=document.getElementById("music");s.addEventListener("mouseover",(()=>{s.style.backgroundColor="rgba(58, 58, 58, 0.8)",s.style.borderColor="rgba(255, 255, 255, 0.5)"})),s.addEventListener("mouseout",(()=>{s.style.backgroundColor="rgba(0, 0, 0, 0.3)",s.style.borderColor="rgba(255, 255, 255, 0.3)"})),h.addEventListener("mouseover",(()=>{h.style.backgroundColor="rgba(255, 255, 255, 0.2)"})),h.addEventListener("mouseout",(()=>{h.style.backgroundColor="rgba(255, 255, 255, 0.1)"})),n.addEventListener("change",(()=>{n.checked&&hv(!1)})),o.addEventListener("change",(()=>{o.checked&&hv(!0)})),r.addEventListener("change",(()=>{r.checked&&Ny(!0)})),a.addEventListener("change",(()=>{a.checked&&Ny(!1)})),h.addEventListener("click",(()=>{Zy=!Zy,Zy?(Ky&&Jy(Ky),console.log("Music enabled")):(Qy(),console.log("Music disabled"))})),s.addEventListener("click",(()=>{t.remove(),dv()}))}()})),document.getElementById("exit").addEventListener("click",(()=>{t.remove(),window.close()}))}let uv=null;function pv(){uv&&(cancelAnimationFrame(uv),uv=null)}dv(),function(t){const e=new Audio("./sounds/click.mp3");document.addEventListener("click",(t=>{0===t.button&&e.cloneNode().play().catch((t=>{console.warn("Autoplay blocked or error playing sound:",t)}))}))}()})();
//# sourceMappingURL=bundle.5e4172f285d3102b7a19.js.map